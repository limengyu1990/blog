<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/blog/img/favicon.ico">

    <title>
        
        Plutus-Pioneer-lesson-05 - undefined
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/blog/css/aircloud.css">
    <link rel="stylesheet" href="/blog/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> 所有的善恶都是我，良心一路走来依旧清澈鲜活... </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar">
            <img src="/blog/img/photo.png" />
        </div>
        <div class="name">
            <i>不负如来不负卿</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/blog/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/blog/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/blog/archive">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/blog/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#类型"><span class="toc-text">类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Values"><span class="toc-text">Values</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#类型使用示例"><span class="toc-text">类型使用示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Native-Token"><span class="toc-text">Native Token</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#铸造策略"><span class="toc-text">铸造策略</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#简单的铸造策略"><span class="toc-text">简单的铸造策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#更实用的铸造策略"><span class="toc-text">更实用的铸造策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NFT"><span class="toc-text">NFT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Multi-NFT"><span class="toc-text">Multi NFT</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#作业"><span class="toc-text">作业</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#作业1"><span class="toc-text">作业1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#作业2"><span class="toc-text">作业2</span></a></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>
        <div class="index-about-mobile">
            <i> 所有的善恶都是我，良心一路走来依旧清澈鲜活... </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        Plutus-Pioneer-lesson-05
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2021-05-06 20:00:00</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/blog/tags/#Haskell" title="Haskell">Haskell</a>
        <span>/</span>
        
        <a class="tag" href="/blog/tags/#Plutus" title="Plutus">Plutus</a>
        <span>/</span>
        
        <a class="tag" href="/blog/tags/#DApps" title="DApps">DApps</a>
        <span>/</span>
        
        <a class="tag" href="/blog/tags/#智能合约" title="智能合约">智能合约</a>
        <span>/</span>
        
        <a class="tag" href="/blog/tags/#Cardano" title="Cardano">Cardano</a>
        <span>/</span>
        
        <a class="tag" href="/blog/tags/#Pioneer" title="Pioneer">Pioneer</a>
        <span>/</span>
        
        <a class="tag" href="/blog/tags/#Contract" title="Contract">Contract</a>
        <span>/</span>
        
        <a class="tag" href="/blog/tags/#NFTs" title="NFTs">NFTs</a>
        <span>/</span>
        
        <a class="tag" href="/blog/tags/#Native Token" title="Native Token">Native Token</a>
        <span>/</span>
        
        <a class="tag" href="/blog/tags/#Minting &amp; Burning" title="Minting &amp; Burning">Minting &amp; Burning</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <blockquote>
<p>本节主要介绍本机令牌制作</p>
</blockquote>
<h3 id="类型"><a href="#类型" class="headerlink" title="类型"></a>类型</h3><h4 id="Values"><a href="#Values" class="headerlink" title="Values"></a>Values</h4><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">-- &lt;货币符号，&lt;token名称，金额&gt;&gt;</span></span><br><span class="line"><span class="class"><span class="keyword">newtype</span> <span class="type">Value</span> = <span class="type">Value</span> &#123;<span class="title">getValue</span> :: <span class="type">PlutusTx</span>.<span class="type">AssocMap</span>.<span class="type">Map</span></span></span><br><span class="line"><span class="class">      <span class="type">CurrencySymbol</span> (<span class="type">PlutusTx</span>.<span class="type">AssocMap</span>.<span class="type">Map</span> <span class="type">TokenName</span> <span class="type">Integer</span>)</span></span><br><span class="line"><span class="class">   &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">newtype</span> <span class="type">TokenName</span></span></span><br><span class="line">  = <span class="type">TokenName</span> &#123;unTokenName :: <span class="type">ByteString</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">newtype</span> <span class="type">CurrencySymbol</span></span></span><br><span class="line">  = <span class="type">CurrencySymbol</span> &#123;unCurrencySymbol :: <span class="type">ByteString</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">newtype</span> <span class="type">AssetClass</span></span></span><br><span class="line">  = <span class="type">AssetClass</span> &#123;unAssetClass :: (<span class="type">CurrencySymbol</span>, <span class="type">TokenName</span>)&#125;</span><br></pre></td></tr></table></figure>
<h4 id="类型使用示例"><a href="#类型使用示例" class="headerlink" title="类型使用示例"></a>类型使用示例</h4><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- λ &gt; import Plutus.V1.Ledger.Value</span></span><br><span class="line"><span class="comment">-- λ &gt; import Plutus.V1.Ledger.Ada</span></span><br><span class="line"><span class="comment">-- λ &gt; :set -XOverloadedStrings</span></span><br><span class="line"><span class="comment">-- λ &gt; </span></span><br><span class="line"><span class="comment">-- λ &gt; :t adaSymbol</span></span><br><span class="line"><span class="comment">-- adaSymbol :: CurrencySymbol</span></span><br><span class="line"><span class="comment">-- λ &gt; </span></span><br><span class="line"><span class="comment">-- λ &gt; :t adaToken</span></span><br><span class="line"><span class="comment">-- adaToken :: TokenName</span></span><br><span class="line"><span class="comment">-- λ &gt; </span></span><br><span class="line"><span class="comment">-- λ &gt; :t lovelaceValueOf</span></span><br><span class="line"><span class="comment">-- lovelaceValueOf :: Integer -&gt; Value</span></span><br><span class="line"><span class="comment">-- λ &gt; </span></span><br><span class="line"><span class="comment">-- λ &gt; lovelaceValueOf 123</span></span><br><span class="line"><span class="comment">-- Value (Map [(,Map [("",123)])])</span></span><br><span class="line"><span class="comment">-- λ &gt; </span></span><br><span class="line"><span class="comment">-- λ &gt; lovelaceValueOf 123 &lt;&gt; lovelaceValueOf 10</span></span><br><span class="line"><span class="comment">-- Value (Map [(,Map [("",133)])])</span></span><br><span class="line"><span class="comment">-- λ &gt; </span></span><br><span class="line"><span class="comment">-- λ &gt; :t singleton</span></span><br><span class="line"><span class="comment">-- singleton :: CurrencySymbol -&gt; TokenName -&gt; Integer -&gt; Value</span></span><br><span class="line"><span class="comment">-- λ &gt; </span></span><br><span class="line"><span class="comment">-- λ &gt; singleton "a8ff" "ABC" 7</span></span><br><span class="line"><span class="comment">-- Value (Map [(a8ff,Map [("ABC",7)])])</span></span><br><span class="line"><span class="comment">-- λ &gt; </span></span><br><span class="line"><span class="comment">-- λ &gt; let v = singleton "a8ff" "ABC" 7 &lt;&gt; lovelaceValueOf 42 &lt;&gt; singleton "a8ff" "XYZ" 100</span></span><br><span class="line"><span class="comment">-- Value (Map [(,Map [("",42)]),(a8ff,Map [("ABC",7),("XYZ",100)])])</span></span><br><span class="line"><span class="comment">-- λ &gt; </span></span><br><span class="line"><span class="comment">-- λ &gt; :t valueOf</span></span><br><span class="line"><span class="comment">-- valueOf :: Value -&gt; CurrencySymbol -&gt; TokenName -&gt; Integer</span></span><br><span class="line"><span class="comment">-- λ &gt; </span></span><br><span class="line"><span class="comment">-- λ &gt; valueOf v "a8ff" "XYZ"</span></span><br><span class="line"><span class="comment">-- 100</span></span><br><span class="line"><span class="comment">-- λ &gt; </span></span><br><span class="line"><span class="comment">-- λ &gt; :t flattenValue</span></span><br><span class="line"><span class="comment">-- flattenValue :: Value -&gt; [(CurrencySymbol, TokenName, Integer)]</span></span><br><span class="line"><span class="comment">-- λ &gt; </span></span><br><span class="line"><span class="comment">-- λ &gt; flattenValue v</span></span><br><span class="line"><span class="comment">-- [(a8ff,"ABC",7),(a8ff,"XYZ",100),(,"",42)]</span></span><br><span class="line"><span class="comment">-- λ &gt; </span></span><br><span class="line"><span class="comment">-- λ &gt; -- 当前验证程序脚本的CurrencySymbol</span></span><br><span class="line"><span class="comment">-- λ &gt; :t ownCurrencySymbol</span></span><br><span class="line"><span class="comment">-- ownCurrencySymbol :: ScriptContext -&gt; CurrencySymbol</span></span><br></pre></td></tr></table></figure>
<h4 id="Native-Token"><a href="#Native-Token" class="headerlink" title="Native Token"></a>Native Token</h4><p>本机代币是一项新功能，可以在<code>Cardano</code>上进行多资产交易。用户可以使用ada和本机无限数量的用户定义(自定义)代币进行交易。</p>
<p>本机支持为开发人员提供了明显的优势: 例如，无需创建智能合约来处理自定义代币，因为分类账可以处理所有与代币相关的功能，因此这消除了一层增加的复杂性和潜在的人工错误。</p>
<h3 id="铸造策略"><a href="#铸造策略" class="headerlink" title="铸造策略"></a>铸造策略</h3><p>铸造策略是一组规则，用于管理该策略范围内的资产的铸造和燃烧。铸造策略的重点是指定铸造(或烧掉)<code>token</code>的条件。<br>例如，规则可以指定谁通过铸造和烧掉来控制资产供应。<br>铸造策略由要创建新资产的用户定义。例如，用户可能希望只允许自己铸造某种特定种类的<code>token</code>,这将在策略中指定。<br>在处理交易时，节点会通过运行代码或检查相关签名来检查对铸造策略的遵守情况。交易必须遵守交易试图铸造的所有资产的所有铸造策略。</p>
<h4 id="简单的铸造策略"><a href="#简单的铸造策略" class="headerlink" title="简单的铸造策略"></a>简单的铸造策略</h4><p>铸造策略涉及到的一些类型:<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">ScriptContext</span> = <span class="type">ScriptContext</span> &#123;</span></span><br><span class="line"><span class="class">    <span class="title">scriptContextTxInfo</span> :: <span class="type">TxInfo</span>, </span></span><br><span class="line"><span class="class">    <span class="comment">-- 脚本用途</span></span></span><br><span class="line"><span class="class">    <span class="title">scriptContextPurpose</span> :: <span class="type">ScriptPurpose</span> </span></span><br><span class="line"><span class="class">  &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 当前正在运行的脚本的用途</span></span><br><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">ScriptPurpose</span></span></span><br><span class="line">    = <span class="type">Minting</span> <span class="type">CurrencySymbol</span>  <span class="comment">-- ^ 铸造</span></span><br><span class="line">    | <span class="type">Spending</span> <span class="type">TxOutRef</span></span><br><span class="line">    | <span class="type">Rewarding</span> <span class="type">StakingCredential</span></span><br><span class="line">    | <span class="type">Certifying</span> <span class="type">DCert</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">TxInfo</span> = <span class="type">TxInfo</span></span></span><br><span class="line">    &#123; txInfoInputs      :: [<span class="type">TxInInfo</span>] <span class="comment">-- ^ Transaction inputs</span></span><br><span class="line">    , txInfoOutputs     :: [<span class="type">TxOut</span>] <span class="comment">-- ^ Transaction outputs</span></span><br><span class="line">    <span class="comment">-- 这笔交易支付的费用</span></span><br><span class="line">    , txInfoFee         :: <span class="type">Value</span> <span class="comment">-- ^ The fee paid by this transaction.</span></span><br><span class="line">    <span class="comment">-- 此交易铸造的值</span></span><br><span class="line">    , txInfoForge       :: <span class="type">Value</span> <span class="comment">-- ^ The 'Value' forged by this transaction.</span></span><br><span class="line">    , txInfoDCert       :: [<span class="type">DCert</span>] <span class="comment">-- ^ Digests of certificates included in this transaction</span></span><br><span class="line">    , txInfoWdrl        :: [(<span class="type">StakingCredential</span>, <span class="type">Integer</span>)] <span class="comment">-- ^ Withdrawals</span></span><br><span class="line">    <span class="comment">--- 交易的有效范围</span></span><br><span class="line">    , txInfoValidRange  :: <span class="type">SlotRange</span> <span class="comment">-- ^ The valid range for the transaction.</span></span><br><span class="line">    <span class="comment">-- 随着交易提供的签名，证明了他们都签署了tx</span></span><br><span class="line">    , txInfoSignatories :: [<span class="type">PubKeyHash</span>] <span class="comment">-- ^ Signatures provided with the transaction, attested that they all signed the tx</span></span><br><span class="line">    , txInfoData        :: [(<span class="type">DatumHash</span>, <span class="type">Datum</span>)]</span><br><span class="line">    , txInfoId          :: <span class="type">TxId</span></span><br><span class="line">    <span class="comment">-- ^ Hash of the pending transaction (excluding witnesses)</span></span><br><span class="line">    &#125; <span class="keyword">deriving</span> (<span class="type">Generic</span>)</span><br></pre></td></tr></table></figure></p>
<p>打开<code>~/haskell/plutus-pioneer-program/code/week05/src/Week05/Free.hs</code>文件,<br>该文件实现了一个简单策略(忽略参数)，总是返回<code>true</code>，允许任何钱包执行铸造和烧掉操作:<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">-- 与mkValidator相似，但是只接收一个ScriptContext参数</span></span><br><span class="line"><span class="meta">&#123;-# INLINABLE mkPolicy #-&#125;</span></span><br><span class="line"><span class="title">mkPolicy</span> :: <span class="type">ScriptContext</span> -&gt; <span class="type">Bool</span></span><br><span class="line"><span class="title">mkPolicy</span> _ = <span class="type">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 验证脚本</span></span><br><span class="line"><span class="comment">-- validator :: Validator</span></span><br><span class="line"><span class="comment">-- validator = mkValidatorScript $$(PlutusTx.compile [|| mkValidator ||])</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 实际策略，和验证脚本类似，也是使用PlutusTx.compile</span></span><br><span class="line"><span class="title">policy</span> :: <span class="type">Scripts</span>.<span class="type">MonetaryPolicy</span></span><br><span class="line"><span class="title">policy</span> = mkMonetaryPolicyScript $$(<span class="type">PlutusTx</span>.compile [|| <span class="type">Scripts</span>.wrapMonetaryPolicy mkPolicy ||])</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 获取当前货币符号(输出示例: e01824b4319351c40b5ec727fff328a82076b1474a6bad6c8e8a2cd835cc6aaf)</span></span><br><span class="line"><span class="comment">-- scriptCurrencySymbol :: MonetaryPolicy -&gt; CurrencySymbol</span></span><br><span class="line"><span class="title">curSymbol</span> :: <span class="type">CurrencySymbol</span></span><br><span class="line"><span class="title">curSymbol</span> = scriptCurrencySymbol policy</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 该链下代码允许任意钱包可以铸造或者烧掉相应数量的token</span></span><br><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">MintParams</span> = <span class="type">MintParams</span></span></span><br><span class="line">    &#123; mpTokenName :: !<span class="type">TokenName</span> <span class="comment">-- ^ token名称</span></span><br><span class="line">    , mpAmount    :: !<span class="type">Integer</span>   <span class="comment">-- ^ token数量，为正时标识铸造，为负时标识烧掉</span></span><br><span class="line">    &#125; <span class="keyword">deriving</span> (<span class="type">Generic</span>, <span class="type">ToJSON</span>, <span class="type">FromJSON</span>, <span class="type">ToSchema</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 定义schema</span></span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="type">FreeSchema</span> =</span></span><br><span class="line">    <span class="type">BlockchainActions</span></span><br><span class="line">        .\/ <span class="type">Endpoint</span> <span class="string">"mint"</span> <span class="type">MintParams</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Contract monad:</span></span><br><span class="line"><span class="comment">--  * 第一个参数标识使用writer monad特性的状态类型(这里使用w标识没有使用它)</span></span><br><span class="line"><span class="comment">--  * 第二个参数是使用的schema(即FreeSchema)，可以进行一些常用的区块链操作，以及可以访问到mint端点</span></span><br><span class="line"><span class="comment">--  * 第三个参数是错误消息的类型</span></span><br><span class="line"><span class="comment">--  * 第四个参数标识合约的return类型，这里使用单元类型</span></span><br><span class="line"><span class="title">mint</span> :: <span class="type">MintParams</span> -&gt; <span class="type">Contract</span> w <span class="type">FreeSchema</span> <span class="type">Text</span> ()</span><br><span class="line"><span class="title">mint</span> mp = <span class="keyword">do</span></span><br><span class="line">    <span class="comment">-- 创建Value(货币符号/token名称/数量)</span></span><br><span class="line">    <span class="keyword">let</span> val     = <span class="type">Value</span>.singleton curSymbol (mpTokenName mp) (mpAmount mp)</span><br><span class="line">        <span class="comment">-- 使用货币策略脚本查找值</span></span><br><span class="line">        lookups = <span class="type">Constraints</span>.monetaryPolicy policy</span><br><span class="line">        <span class="comment">-- 以声明方式定义要构造的交易应该具备的某些条件，</span></span><br><span class="line">        <span class="comment">-- 然后Plutus库会自动构建一个满足所有这些条件的交易(如果可能的话)</span></span><br><span class="line">        <span class="comment">-- mustForgeValue标识该交易必须铸造该值(`val`)</span></span><br><span class="line">        tx      = <span class="type">Constraints</span>.mustForgeValue val</span><br><span class="line">    <span class="comment">-- 构建满足约束的交易，然后将其提交到网络</span></span><br><span class="line">    ledgerTx &lt;- submitTxConstraintsWith @<span class="type">Void</span> lookups tx</span><br><span class="line">    <span class="comment">-- 等待确认</span></span><br><span class="line">    void $ awaitTxConfirmed $ txId ledgerTx</span><br><span class="line">    <span class="type">Contract</span>.logInfo @<span class="type">String</span> $ printf <span class="string">"forged %s"</span> (show val)</span><br><span class="line"></span><br><span class="line"><span class="title">endpoints</span> :: <span class="type">Contract</span> () <span class="type">FreeSchema</span> <span class="type">Text</span> ()</span><br><span class="line"><span class="title">endpoints</span> = mint' &gt;&gt; endpoints</span><br><span class="line">  <span class="keyword">where</span></span><br><span class="line">    mint' = endpoint @<span class="string">"mint"</span> &gt;&gt;= mint</span><br><span class="line"></span><br><span class="line"><span class="title">mkSchemaDefinitions</span> ''<span class="type">FreeSchema</span></span><br><span class="line"></span><br><span class="line"><span class="title">mkKnownCurrencies</span> []</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 测试代码</span></span><br><span class="line"><span class="title">test</span> :: <span class="type">IO</span> ()</span><br><span class="line"><span class="title">test</span> = runEmulatorTraceIO $ <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">let</span> tn = <span class="string">"ABC"</span></span><br><span class="line">    h1 &lt;- activateContractWallet (<span class="type">Wallet</span> <span class="number">1</span>) endpoints</span><br><span class="line">    h2 &lt;- activateContractWallet (<span class="type">Wallet</span> <span class="number">2</span>) endpoints</span><br><span class="line">    callEndpoint @<span class="string">"mint"</span> h1 $ <span class="type">MintParams</span></span><br><span class="line">        &#123; mpTokenName = tn</span><br><span class="line">        , mpAmount    = <span class="number">555</span></span><br><span class="line">        &#125;</span><br><span class="line">    callEndpoint @<span class="string">"mint"</span> h2 $ <span class="type">MintParams</span></span><br><span class="line">        &#123; mpTokenName = tn</span><br><span class="line">        , mpAmount    = <span class="number">444</span></span><br><span class="line">        &#125;</span><br><span class="line">    void $ <span class="type">Emulator</span>.waitNSlots <span class="number">1</span></span><br><span class="line">    callEndpoint @<span class="string">"mint"</span> h1 $ <span class="type">MintParams</span></span><br><span class="line">        &#123; mpTokenName = tn</span><br><span class="line">        , mpAmount    = <span class="number">-222</span></span><br><span class="line">        &#125;</span><br><span class="line">    void $ <span class="type">Emulator</span>.waitNSlots <span class="number">1</span></span><br></pre></td></tr></table></figure></p>
<p>然后我们打开游乐场尝试一下:</p>
<p><img src="01.png" alt=""><br>如上图所示，我们创建了两个钱包，每个钱包各有1000初始金额, 然后设置如下序列:</p>
<ul>
<li>钱包1铸造<code>555</code>个<code>ABC</code>代币</li>
<li>钱包2铸造<code>444</code>个<code>ABC</code>代币</li>
<li>钱包1烧掉(<code>burn</code>)<code>222</code>个<code>ABC</code>代币</li>
</ul>
<p><img src="02.png" alt=""></p>
<p>在<code>Genesis slot</code>的输出中可以看到钱包1和钱包2分别得到了<code>1000</code>初始金额：</p>
<p><img src="03.png" alt=""></p>
<p>在<code>Slot 1, Tx 0</code>阶段，钱包2执行了铸造操作，可以看到输出中除了10<code>Ada</code>的交易费和990<code>Ada</code>的余额外,还有444个新铸造的<code>ABC</code>:</p>
<p><img src="04.png" alt=""></p>
<p>在<code>Slot 1, Tx 1</code>阶段，钱包1也执行了铸造操作，可以看到输出中除了10<code>Ada</code>的交易费和990<code>Ada</code>的余额外,还有555个新铸造的<code>ABC</code>:</p>
<p><img src="05.png" alt=""></p>
<p>在<code>Slot 2, Tx 0</code>阶段，钱包1执行了烧掉操作，为了烧掉这<code>222</code>个<code>token</code>，必须将它们用作<code>input</code>(输入), 唯一可用的输入就是我们上一步铸造的<code>555</code>个，因此可以看到下图左侧的输入有两个: 一个990<code>Ada</code>的输入用于支付交易费用(10<code>Ada</code>), 另一个555<code>ABC</code>用于执行烧掉操作。最终可以看到输出中除了10<code>Ada</code>的交易费外，还有980<code>Ada</code>和333<code>ABC</code>(在这种情况下，算法将会自动合并输出到一个交易中):</p>
<p><img src="06.png" alt=""></p>
<p>钱包1和钱包2的最终余额如下:</p>
<p><img src="07.png" alt=""></p>
<p>该示例策略不是一个非常有用的货币策略，因为拥有代币的意义在于它代表某种价值。所以，如果任何人在任何时候都可以使用新的代币，那么这个代币就没有什么意义了，下一节我们将看到更实用的铸造策略.</p>
<h4 id="更实用的铸造策略"><a href="#更实用的铸造策略" class="headerlink" title="更实用的铸造策略"></a>更实用的铸造策略</h4><p>可能最简单的实用铸币策略是: 货币的铸造和烧掉仅限于由特定公钥散列签名的交易。这类似于现实世界中的央行，例如美元欧元等法币并不是每个人都可以铸造，只能由中央银行铸造，因此从某种意义上讲，这就像是一个中央银行政策，只有某些人可以铸造新的货币或者铸造已存在的货币。</p>
<p>这意味着我们的实用铸造策略需要一个有权利执行铸造和烧掉操作的参数(公钥哈希<code>PubKeyHash</code>)。</p>
<p>打开<code>~/haskell/plutus-pioneer-program/code/week05/src/Week05/Signed.hs</code>文件，该文件与上节示例相比，增加了<code>PubKeyHash</code>参数:</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">-- scriptContextTxInfo ctx 从上下文中获取交易信息</span></span><br><span class="line"><span class="comment">-- txSignedBy 检查交易是否由给定的公钥签名</span></span><br><span class="line"><span class="meta">&#123;-# INLINABLE mkPolicy #-&#125;</span></span><br><span class="line"><span class="title">mkPolicy</span> :: <span class="type">PubKeyHash</span> -&gt; <span class="type">ScriptContext</span> -&gt; <span class="type">Bool</span></span><br><span class="line"><span class="title">mkPolicy</span> pkh ctx = txSignedBy (scriptContextTxInfo ctx) pkh</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用applyCode应用参数pkh</span></span><br><span class="line"><span class="title">policy</span> :: <span class="type">PubKeyHash</span> -&gt; <span class="type">Scripts</span>.<span class="type">MonetaryPolicy</span></span><br><span class="line"><span class="title">policy</span> pkh = mkMonetaryPolicyScript $</span><br><span class="line">    $$(<span class="type">PlutusTx</span>.compile [|| <span class="type">Scripts</span>.wrapMonetaryPolicy . mkPolicy ||])</span><br><span class="line">    `<span class="type">PlutusTx</span>.applyCode`</span><br><span class="line">    <span class="type">PlutusTx</span>.liftCode pkh</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 获取当前货币符号</span></span><br><span class="line"><span class="title">curSymbol</span> :: <span class="type">PubKeyHash</span> -&gt; <span class="type">CurrencySymbol</span></span><br><span class="line"><span class="title">curSymbol</span> = scriptCurrencySymbol . policy</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 铸造参数</span></span><br><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">MintParams</span> = <span class="type">MintParams</span></span></span><br><span class="line">    &#123; mpTokenName :: !<span class="type">TokenName</span></span><br><span class="line">    , mpAmount    :: !<span class="type">Integer</span></span><br><span class="line">    &#125; <span class="keyword">deriving</span> (<span class="type">Generic</span>, <span class="type">ToJSON</span>, <span class="type">FromJSON</span>, <span class="type">ToSchema</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="type">SignedSchema</span> =</span></span><br><span class="line">    <span class="type">BlockchainActions</span></span><br><span class="line">        .\/ <span class="type">Endpoint</span> <span class="string">"mint"</span> <span class="type">MintParams</span></span><br><span class="line"></span><br><span class="line"><span class="title">mint</span> :: <span class="type">MintParams</span> -&gt; <span class="type">Contract</span> w <span class="type">SignedSchema</span> <span class="type">Text</span> ()</span><br><span class="line"><span class="title">mint</span> mp = <span class="keyword">do</span></span><br><span class="line">    <span class="comment">-- ownPubKey 获取运行此合同的钱包的公钥</span></span><br><span class="line">    <span class="comment">-- 支付给此公钥的任何资金将被视为钱包的自有资金</span></span><br><span class="line">    <span class="comment">-- 例如，如果将公钥添加到Tx的requiredSignatures字段，则钱包可以使用该公钥的私钥对交易进行签名。</span></span><br><span class="line">    <span class="comment">-- 钱包和公钥之间存在1-n关系(尽管在mockchain中n=1)</span></span><br><span class="line">    pkh &lt;- pubKeyHash &lt;$&gt; <span class="type">Contract</span>.ownPubKey</span><br><span class="line">    <span class="comment">-- 创建Value(货币符号/token名称/数量)</span></span><br><span class="line">    <span class="keyword">let</span> val     = <span class="type">Value</span>.singleton (curSymbol pkh) (mpTokenName mp) (mpAmount mp)</span><br><span class="line">        <span class="comment">-- 使用货币策略脚本查找值</span></span><br><span class="line">        lookups = <span class="type">Constraints</span>.monetaryPolicy $ policy pkh</span><br><span class="line">        <span class="comment">-- 以声明方式定义要构造的交易应该具备的某些条件，</span></span><br><span class="line">        <span class="comment">-- 然后Plutus库会自动构建一个满足所有这些条件的交易(如果可能的话)</span></span><br><span class="line">        tx      = <span class="type">Constraints</span>.mustForgeValue val</span><br><span class="line">    <span class="comment">-- 构建满足约束的交易，然后将其提交到网络</span></span><br><span class="line">    ledgerTx &lt;- submitTxConstraintsWith @<span class="type">Void</span> lookups tx</span><br><span class="line">    <span class="comment">-- 等待确认</span></span><br><span class="line">    void $ awaitTxConfirmed $ txId ledgerTx</span><br><span class="line">    <span class="type">Contract</span>.logInfo @<span class="type">String</span> $ printf <span class="string">"forged %s"</span> (show val)</span><br><span class="line"></span><br><span class="line"><span class="title">endpoints</span> :: <span class="type">Contract</span> () <span class="type">SignedSchema</span> <span class="type">Text</span> ()</span><br><span class="line"><span class="title">endpoints</span> = mint' &gt;&gt; endpoints</span><br><span class="line">  <span class="keyword">where</span></span><br><span class="line">    mint' = endpoint @<span class="string">"mint"</span> &gt;&gt;= mint</span><br><span class="line"></span><br><span class="line"><span class="title">mkSchemaDefinitions</span> ''<span class="type">SignedSchema</span></span><br><span class="line"></span><br><span class="line"><span class="title">mkKnownCurrencies</span> []</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 测试</span></span><br><span class="line"><span class="title">test</span> :: <span class="type">IO</span> ()</span><br><span class="line"><span class="title">test</span> = runEmulatorTraceIO $ <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">let</span> tn = <span class="string">"ABC"</span></span><br><span class="line">    h1 &lt;- activateContractWallet (<span class="type">Wallet</span> <span class="number">1</span>) endpoints</span><br><span class="line">    h2 &lt;- activateContractWallet (<span class="type">Wallet</span> <span class="number">2</span>) endpoints</span><br><span class="line">    callEndpoint @<span class="string">"mint"</span> h1 $ <span class="type">MintParams</span></span><br><span class="line">        &#123; mpTokenName = tn</span><br><span class="line">        , mpAmount    = <span class="number">555</span></span><br><span class="line">        &#125;</span><br><span class="line">    callEndpoint @<span class="string">"mint"</span> h2 $ <span class="type">MintParams</span></span><br><span class="line">        &#123; mpTokenName = tn</span><br><span class="line">        , mpAmount    = <span class="number">444</span></span><br><span class="line">        &#125;</span><br><span class="line">    void $ <span class="type">Emulator</span>.waitNSlots <span class="number">1</span></span><br><span class="line">    callEndpoint @<span class="string">"mint"</span> h1 $ <span class="type">MintParams</span></span><br><span class="line">        &#123; mpTokenName = tn</span><br><span class="line">        , mpAmount    = <span class="number">-222</span></span><br><span class="line">        &#125;</span><br><span class="line">    void $ <span class="type">Emulator</span>.waitNSlots <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p><strong>执行测试:</strong></p>
<p><img src="08.png" alt=""></p>
<p>该示例与上一小节很相似，但在上一个示例中我们只有一个货币，每个钱包都可以进行铸造或烧掉。<br>本节示例的货币被公钥哈希参数化了，这意味着如果两个不同的钱包使用这个合同，那么他们最终会得到不同的货币。</p>
<p>钱包1(<strong>红色</strong>)和钱包2(<strong>蓝色</strong>)铸造后，得到了两种不同的资产类别，两种不同的代币。虽然代币名称是相同的<code>ABC</code>，但是它们是完全不同的货币。所以现在钱包1只能铸造或烧掉这个(尾号<code>960323521</code>)，而钱包2只能铸造或烧掉另一个(尾号<code>983f101ba</code>)。<br><strong>绿色</strong>是最终余额信息.</p>
<h4 id="NFT"><a href="#NFT" class="headerlink" title="NFT"></a>NFT</h4><p>设置一个<code>deadline</code>(期限)，只允许在期限过去之前铸造一个<code>NFT</code>，然后让最后期限过去，然后保证在期限之后，不会再铸造新的代币。<br>但是为了确定在期限前只铸造了一个代币，我们需要一个类似<code>blockchain Explorer</code>(区块链浏览器)的东西，必须在区块链上检查这些代币中只有一个是在期限之前铸造的。因此，从这个意义上说，现在<code>cardano</code>上的的<code>NFT</code>不是真的<code>NFT</code>,从此意义上货币符号通过它自身保证了它们是<code>NFT</code>.</p>
<p>现在使用<code>Plutus</code>可以铸造出真正的<code>NFT</code>, 如果知道对应于货币符号的策略脚本，就可以确定只有一个这样的硬币存在，而不必解析。</p>
<p>区块链历史上的每一笔交易都是唯一的，都有一个唯一的ID。这也意味着区块链中的每一个<code>UTXO</code>都有一个不同的<code>ID</code>(交易ID和索引的不同组合)。我们可以利用这个事实来创建真正的<code>NFT</code>.</p>
<p>想法是将一个特定的<code>UTXO</code>命名为我们铸造策略的参数。然后在策略中检查执行铸造的交易是否使用这个特定的<code>UTXO</code>,一旦在这个交易中使用了该<code>UTXO</code>，它就不可能再存在了。所以不可能有另一个交易使用相同的<code>UTXO</code>, 这就保证了在这样的铸造策略下，只能有一个交易使用这个<code>UTXO</code>.</p>
<p><strong>用到的类型 :</strong><br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 交易信息</span></span><br><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">TxInfo</span> = <span class="type">TxInfo</span> &#123;</span></span><br><span class="line"><span class="class">    <span class="comment">-- 交易输入</span></span></span><br><span class="line"><span class="class">    <span class="title">txInfoInputs</span> :: [<span class="type">TxInInfo</span>],</span></span><br><span class="line"><span class="class">    <span class="title">txInfoInputsFees</span> :: [<span class="type">TxInInfo</span>],</span></span><br><span class="line"><span class="class">    <span class="comment">-- 交易输出</span></span></span><br><span class="line"><span class="class">    <span class="title">txInfoOutputs</span> :: [<span class="type">TxOut</span>],</span></span><br><span class="line"><span class="class">    <span class="title">txInfoFee</span> :: <span class="type">Value</span>,</span></span><br><span class="line"><span class="class">    <span class="comment">-- 交易铸造的Value</span></span></span><br><span class="line"><span class="class">    <span class="title">txInfoForge</span> :: <span class="type">Value</span>,</span></span><br><span class="line"><span class="class">    <span class="title">txInfoDCert</span> :: [<span class="type">Plutus</span>.<span class="type">V1</span>.<span class="type">Ledger</span>.<span class="type">DCert</span>.<span class="type">DCert</span>],</span></span><br><span class="line"><span class="class">    <span class="title">txInfoWdrl</span> :: [(<span class="type">Plutus</span>.<span class="type">V1</span>.<span class="type">Ledger</span>.<span class="type">Credential</span>.<span class="type">StakingCredential</span>, <span class="type">Integer</span>)],</span></span><br><span class="line"><span class="class">    <span class="title">txInfoValidRange</span> :: <span class="type">SlotRange</span>,</span></span><br><span class="line"><span class="class">    <span class="title">txInfoSignatories</span> :: [<span class="type">PubKeyHash</span>],</span></span><br><span class="line"><span class="class">    <span class="title">txInfoData</span> :: [(<span class="type">DatumHash</span>, <span class="type">Datum</span>)],</span></span><br><span class="line"><span class="class">    <span class="title">txInfoId</span> :: <span class="type">TxId</span></span></span><br><span class="line"><span class="class">  &#125;</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">TxInInfo</span> = <span class="type">TxInInfo</span> &#123;</span></span><br><span class="line"><span class="class">    <span class="comment">-- 引用了交易输出, 即utxo标识符</span></span></span><br><span class="line"><span class="class">    <span class="title">txInInfoOutRef</span> :: <span class="type">TxOutRef</span>, </span></span><br><span class="line"><span class="class">    <span class="title">txInInfoResolved</span> :: <span class="type">TxOut</span></span></span><br><span class="line"><span class="class">  &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">TxOutRef</span> = <span class="type">TxOutRef</span> &#123;</span></span><br><span class="line"><span class="class">    <span class="title">txOutRefId</span> :: <span class="type">TxId</span>, </span></span><br><span class="line"><span class="class">    <span class="title">txOutRefIdx</span> :: <span class="type">Integer</span></span></span><br><span class="line"><span class="class">  &#125;</span></span><br></pre></td></tr></table></figure></p>
<p>打开<code>~/haskell/plutus-pioneer-program/code/week05/src/Week05/NFT.hs</code>文件</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#123;-# INLINABLE mkPolicy #-&#125;</span></span><br><span class="line"><span class="title">mkPolicy</span> :: <span class="type">TxOutRef</span> -&gt; <span class="type">TokenName</span> -&gt; <span class="type">ScriptContext</span> -&gt; <span class="type">Bool</span></span><br><span class="line"><span class="title">mkPolicy</span> oref tn ctx = traceIfFalse <span class="string">"UTxO not consumed"</span>   hasUTxO           &amp;&amp;</span><br><span class="line">                       traceIfFalse <span class="string">"wrong amount minted"</span> checkMintedAmount</span><br><span class="line">  <span class="keyword">where</span></span><br><span class="line">    <span class="comment">-- 获取交易信息</span></span><br><span class="line">    info :: <span class="type">TxInfo</span></span><br><span class="line">    info = scriptContextTxInfo ctx</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 检查进行铸造的交易是否包含特定的UTXO作为input(输入)</span></span><br><span class="line">    hasUTxO :: <span class="type">Bool</span></span><br><span class="line">    hasUTxO = any (\i -&gt; txInInfoOutRef i == oref) $ txInfoInputs info</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 当前验证脚本的货币符号</span></span><br><span class="line">    <span class="comment">-- ownCurrencySymbol :: ScriptContext -&gt; CurrencySymbol</span></span><br><span class="line">    <span class="comment">-- ownCurrencySymbol ScriptContext&#123;scriptContextPurpose=Minting cs&#125; = cs</span></span><br><span class="line">    <span class="comment">-- ownCurrencySymbol _ </span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- flattenValue :: Value -&gt; [(CurrencySymbol, TokenName, Integer)]</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 校验铸造的货币符号/token名称/数量</span></span><br><span class="line">    <span class="comment">-- 货币符号由已编译脚本的哈希值获得</span></span><br><span class="line">    checkMintedAmount :: <span class="type">Bool</span></span><br><span class="line">    checkMintedAmount = <span class="keyword">case</span> flattenValue (txInfoForge info) <span class="keyword">of</span></span><br><span class="line">        [(cs, tn', amt)] -&gt; cs  == ownCurrencySymbol ctx &amp;&amp; tn' == tn &amp;&amp; amt == <span class="number">1</span></span><br><span class="line">        _                -&gt; <span class="type">False</span></span><br><span class="line"></span><br><span class="line"><span class="title">policy</span> :: <span class="type">TxOutRef</span> -&gt; <span class="type">TokenName</span> -&gt; <span class="type">Scripts</span>.<span class="type">MonetaryPolicy</span></span><br><span class="line"><span class="title">policy</span> oref tn = mkMonetaryPolicyScript $</span><br><span class="line">    $$(<span class="type">PlutusTx</span>.compile [|| \oref' tn' -&gt; <span class="type">Scripts</span>.wrapMonetaryPolicy $ mkPolicy oref' tn' ||])</span><br><span class="line">    `<span class="type">PlutusTx</span>.applyCode`</span><br><span class="line">    <span class="type">PlutusTx</span>.liftCode oref</span><br><span class="line">    `<span class="type">PlutusTx</span>.applyCode`</span><br><span class="line">    <span class="type">PlutusTx</span>.liftCode tn</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 获取当前货币符号</span></span><br><span class="line"><span class="comment">-- scriptCurrencySymbol :: MonetaryPolicy -&gt; CurrencySymbol</span></span><br><span class="line"><span class="title">curSymbol</span> :: <span class="type">TxOutRef</span> -&gt; <span class="type">TokenName</span> -&gt; <span class="type">CurrencySymbol</span></span><br><span class="line"><span class="title">curSymbol</span> oref tn = scriptCurrencySymbol $ policy oref tn</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="type">NFTSchema</span> =</span></span><br><span class="line">    <span class="type">BlockchainActions</span></span><br><span class="line">        .\/ <span class="type">Endpoint</span> <span class="string">"mint"</span> <span class="type">TokenName</span></span><br><span class="line"></span><br><span class="line"><span class="title">mint</span> :: <span class="type">TokenName</span> -&gt; <span class="type">Contract</span> w <span class="type">NFTSchema</span> <span class="type">Text</span> ()</span><br><span class="line"><span class="title">mint</span> tn = <span class="keyword">do</span></span><br><span class="line">    <span class="comment">-- ownPubKey 获取运行此合同的钱包的公钥</span></span><br><span class="line">    pk    &lt;- <span class="type">Contract</span>.ownPubKey</span><br><span class="line">    <span class="comment">-- pubKeyAddress :: PubKey -&gt; Address</span></span><br><span class="line">    <span class="comment">-- utxoAt在某个地址上获取unspent(未使用)的交易输出</span></span><br><span class="line">    utxos &lt;- utxoAt (pubKeyAddress pk)</span><br><span class="line">    <span class="comment">-- type UtxoMap = Map TxOutRef TxOutTx</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">Map</span>.keys utxos <span class="keyword">of</span></span><br><span class="line">        []       -&gt; <span class="type">Contract</span>.logError @<span class="type">String</span> <span class="string">"no utxo found"</span></span><br><span class="line">        oref : _ -&gt; <span class="keyword">do</span></span><br><span class="line">            <span class="keyword">let</span> val     = <span class="type">Value</span>.singleton (curSymbol oref tn) tn <span class="number">1</span></span><br><span class="line">                lookups = <span class="type">Constraints</span>.monetaryPolicy (policy oref tn) &lt;&gt; <span class="type">Constraints</span>.unspentOutputs utxos</span><br><span class="line">                <span class="comment">-- 以声明方式定义要构造的交易应该具备的某些条件，</span></span><br><span class="line">                <span class="comment">-- 然后Plutus库会自动构建一个满足所有这些条件的交易(如果可能的话)</span></span><br><span class="line">                <span class="comment">-- mustSpendPubKeyOutput :: TxOutRef -&gt; TxConstraints i o</span></span><br><span class="line">                tx      = <span class="type">Constraints</span>.mustForgeValue val &lt;&gt; <span class="type">Constraints</span>.mustSpendPubKeyOutput oref</span><br><span class="line">            <span class="comment">-- 构建满足约束的交易，然后将其提交到网络</span></span><br><span class="line">            ledgerTx &lt;- submitTxConstraintsWith @<span class="type">Void</span> lookups tx</span><br><span class="line">            void $ awaitTxConfirmed $ txId ledgerTx</span><br><span class="line">            <span class="type">Contract</span>.logInfo @<span class="type">String</span> $ printf <span class="string">"forged %s"</span> (show val)</span><br><span class="line"></span><br><span class="line"><span class="title">endpoints</span> :: <span class="type">Contract</span> () <span class="type">NFTSchema</span> <span class="type">Text</span> ()</span><br><span class="line"><span class="title">endpoints</span> = mint' &gt;&gt; endpoints</span><br><span class="line">  <span class="keyword">where</span></span><br><span class="line">    mint' = endpoint @<span class="string">"mint"</span> &gt;&gt;= mint</span><br><span class="line"></span><br><span class="line"><span class="title">mkSchemaDefinitions</span> ''<span class="type">NFTSchema</span></span><br><span class="line"></span><br><span class="line"><span class="title">mkKnownCurrencies</span> []</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 测试</span></span><br><span class="line"><span class="title">test</span> :: <span class="type">IO</span> ()</span><br><span class="line"><span class="title">test</span> = runEmulatorTraceIO $ <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">let</span> tn = <span class="string">"ABC"</span></span><br><span class="line">    h1 &lt;- activateContractWallet (<span class="type">Wallet</span> <span class="number">1</span>) endpoints</span><br><span class="line">    h2 &lt;- activateContractWallet (<span class="type">Wallet</span> <span class="number">2</span>) endpoints</span><br><span class="line">    callEndpoint @<span class="string">"mint"</span> h1 tn</span><br><span class="line">    callEndpoint @<span class="string">"mint"</span> h2 tn</span><br><span class="line">    void $ <span class="type">Emulator</span>.waitNSlots <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p><strong>执行测试</strong>，我们铸造出来了真正的<code>NFT</code>:</p>
<p><img src="09.png" alt=""></p>
<h4 id="Multi-NFT"><a href="#Multi-NFT" class="headerlink" title="Multi NFT"></a>Multi NFT</h4><p>使用同一个货币符号铸造多个<code>tokenName</code>不同的<code>NFTs</code>:<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#123;-# INLINABLE mkPolicy #-&#125;</span></span><br><span class="line"><span class="title">mkPolicy</span> :: <span class="type">TxOutRef</span> -&gt; [<span class="type">TokenName</span>] -&gt; <span class="type">ScriptContext</span> -&gt; <span class="type">Bool</span></span><br><span class="line"><span class="title">mkPolicy</span> oref tns ctx = traceIfFalse <span class="string">"UTxO not consumed"</span>   hasUTxO           &amp;&amp;</span><br><span class="line">                        traceIfFalse <span class="string">"wrong amount minted"</span> checkMintedAmount</span><br><span class="line">  <span class="keyword">where</span></span><br><span class="line">    info :: <span class="type">TxInfo</span></span><br><span class="line">    info = scriptContextTxInfo ctx</span><br><span class="line"></span><br><span class="line">    hasUTxO :: <span class="type">Bool</span></span><br><span class="line">    hasUTxO = elem oref $ txInInfoOutRef &lt;$&gt; txInfoInputs info</span><br><span class="line"></span><br><span class="line">    checkMintedAmount :: <span class="type">Bool</span></span><br><span class="line">    checkMintedAmount = txInfoForge info == multipleNFTs (ownCurrencySymbol ctx) tns </span><br><span class="line"></span><br><span class="line"><span class="comment">-- newtype Value = Value &#123;getValue :: PlutusTx.AssocMap.Map</span></span><br><span class="line"><span class="comment">--       CurrencySymbol (PlutusTx.AssocMap.Map TokenName Integer)</span></span><br><span class="line"><span class="comment">--  &#125;</span></span><br><span class="line"><span class="comment">-- λ &gt; :t foldMap</span></span><br><span class="line"><span class="comment">-- foldMap :: (Foldable t, Monoid m) =&gt; (a -&gt; m) -&gt; t a -&gt; m</span></span><br><span class="line"><span class="comment">-- λ &gt; foldMap (++ "$") ["a", "b", "c"]</span></span><br><span class="line"><span class="comment">-- "a$b$c$"</span></span><br><span class="line"><span class="title">multipleNFTs</span> :: <span class="type">CurrencySymbol</span> -&gt; [<span class="type">TokenName</span>] -&gt; <span class="type">Value</span></span><br><span class="line"><span class="title">multipleNFTs</span> c = foldMap $ flip (singleton c) <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="title">policy</span> :: <span class="type">TxOutRef</span> -&gt; [<span class="type">TokenName</span>] -&gt; <span class="type">Scripts</span>.<span class="type">MonetaryPolicy</span></span><br><span class="line"><span class="title">policy</span> oref tns = mkMonetaryPolicyScript $</span><br><span class="line">    $$(<span class="type">PlutusTx</span>.compile [|| \oref' tns' -&gt; <span class="type">Scripts</span>.wrapMonetaryPolicy $ mkPolicy oref' tns' ||])</span><br><span class="line">    `<span class="type">PlutusTx</span>.applyCode`</span><br><span class="line">    <span class="type">PlutusTx</span>.liftCode oref</span><br><span class="line">    `<span class="type">PlutusTx</span>.applyCode`</span><br><span class="line">    <span class="type">PlutusTx</span>.liftCode tns</span><br><span class="line"></span><br><span class="line"><span class="title">curSymbol</span> :: <span class="type">TxOutRef</span> -&gt; [<span class="type">TokenName</span>] -&gt; <span class="type">CurrencySymbol</span></span><br><span class="line"><span class="title">curSymbol</span> oref tns = scriptCurrencySymbol $ policy oref tns</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="type">NFTSchema</span> =</span></span><br><span class="line">    <span class="type">BlockchainActions</span></span><br><span class="line">        .\/ <span class="type">Endpoint</span> <span class="string">"mint"</span> [<span class="type">TokenName</span>]</span><br><span class="line"></span><br><span class="line"><span class="title">mint</span> :: [<span class="type">TokenName</span>] -&gt; <span class="type">Contract</span> w <span class="type">NFTSchema</span> <span class="type">Text</span> ()</span><br><span class="line"><span class="title">mint</span> tns = <span class="keyword">do</span></span><br><span class="line">    pk    &lt;- <span class="type">Contract</span>.ownPubKey</span><br><span class="line">    utxos &lt;- utxoAt (pubKeyAddress pk)</span><br><span class="line">    <span class="keyword">let</span> utxoKeys  = <span class="type">Map</span>.keys utxos</span><br><span class="line">    when (null utxoKeys) $ <span class="type">Contract</span>.throwError @<span class="type">Text</span> <span class="string">"no utxo found"</span></span><br><span class="line">    <span class="keyword">let</span> oref:_    = utxoKeys</span><br><span class="line">        <span class="comment">-- </span></span><br><span class="line">        val       = multipleNFTs (curSymbol oref tns) tns</span><br><span class="line">        lookups   = <span class="type">Constraints</span>.monetaryPolicy (policy oref tns) &lt;&gt; <span class="type">Constraints</span>.unspentOutputs utxos</span><br><span class="line">        tx        = <span class="type">Constraints</span>.mustForgeValue val &lt;&gt; <span class="type">Constraints</span>.mustSpendPubKeyOutput oref</span><br><span class="line">    ledgerTx &lt;- submitTxConstraintsWith @<span class="type">Void</span> lookups tx</span><br><span class="line">    void $ awaitTxConfirmed $ txId ledgerTx</span><br><span class="line">    <span class="type">Contract</span>.logInfo @<span class="type">String</span> $ printf <span class="string">"forged %s"</span> (show val)</span><br><span class="line"></span><br><span class="line"><span class="title">endpoints</span> :: <span class="type">Contract</span> () <span class="type">NFTSchema</span> <span class="type">Text</span> ()</span><br><span class="line"><span class="title">endpoints</span> = mint' &gt;&gt; endpoints</span><br><span class="line">  <span class="keyword">where</span></span><br><span class="line">    mint' = endpoint @<span class="string">"mint"</span> &gt;&gt;= mint</span><br><span class="line"></span><br><span class="line"><span class="title">mkSchemaDefinitions</span> ''<span class="type">NFTSchema</span></span><br><span class="line"></span><br><span class="line"><span class="title">mkKnownCurrencies</span> []</span><br><span class="line"></span><br><span class="line"><span class="title">test</span> :: <span class="type">IO</span> ()</span><br><span class="line"><span class="title">test</span> = runEmulatorTraceIO $ <span class="keyword">do</span></span><br><span class="line">    h1 &lt;- activateContractWallet (<span class="type">Wallet</span> <span class="number">1</span>) endpoints</span><br><span class="line">    h2 &lt;- activateContractWallet (<span class="type">Wallet</span> <span class="number">2</span>) endpoints</span><br><span class="line">    callEndpoint @<span class="string">"mint"</span> h1 [<span class="string">"BTC"</span>, <span class="string">"ETH"</span>, <span class="string">"ADA"</span>]</span><br><span class="line">    callEndpoint @<span class="string">"mint"</span> h2 [<span class="string">"BAT"</span>, <span class="string">"VET"</span>, <span class="string">"DOT"</span>]</span><br><span class="line">    void $ <span class="type">Emulator</span>.waitNSlots <span class="number">1</span></span><br></pre></td></tr></table></figure></p>
<h3 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h3><h4 id="作业1"><a href="#作业1" class="headerlink" title="作业1"></a>作业1</h4><blockquote>
<p>如果指定的<code>PubKeyHash</code>的所有者已对交易进行签名并且未超过指定的截止日期，则此策略应仅允许铸造(或烧掉)代币.</p>
</blockquote>
<p>打开<code>~/haskell/plutus-pioneer-program/code/week05/src/Week05/Homework1.hs</code>文件:</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#123;-# LANGUAGE RecordWildCards #-&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&#123;-# INLINABLE mkPolicy #-&#125;</span></span><br><span class="line"><span class="comment">-- This policy should only allow minting (or burning) of tokens if the owner of the specified PubKeyHash</span></span><br><span class="line"><span class="comment">-- has signed the transaction and if the specified deadline has not passed.</span></span><br><span class="line"><span class="title">mkPolicy</span> :: <span class="type">PubKeyHash</span> -&gt; <span class="type">Slot</span> -&gt; <span class="type">ScriptContext</span> -&gt; <span class="type">Bool</span></span><br><span class="line"><span class="comment">-- mkPolicy pkh deadline ctx = True -- FIX ME!</span></span><br><span class="line"><span class="title">mkPolicy</span> pkh deadline <span class="type">ScriptContext</span>&#123;..&#125; =</span><br><span class="line">    traceIfFalse <span class="string">"Missing Signature"</span> (txSignedBy scriptContextTxInfo pkh)</span><br><span class="line">    &amp;&amp; traceIfFalse <span class="string">"Deadline Expired"</span> (to deadline `contains` txInfoValidRange scriptContextTxInfo)</span><br><span class="line"></span><br><span class="line"><span class="title">policy</span> :: <span class="type">PubKeyHash</span> -&gt; <span class="type">Slot</span> -&gt; <span class="type">Scripts</span>.<span class="type">MonetaryPolicy</span></span><br><span class="line"><span class="comment">-- policy pkh deadline = undefined -- IMPLEMENT ME!</span></span><br><span class="line"><span class="title">policy</span> pkh deadline = mkMonetaryPolicyScript $</span><br><span class="line">    $$(<span class="type">PlutusTx</span>.compile [|| \pkh' deadline' -&gt; <span class="type">Scripts</span>.wrapMonetaryPolicy $ mkPolicy pkh' deadline' ||])</span><br><span class="line">    `<span class="type">PlutusTx</span>.applyCode`</span><br><span class="line">    <span class="type">PlutusTx</span>.liftCode pkh</span><br><span class="line">    `<span class="type">PlutusTx</span>.applyCode`</span><br><span class="line">    <span class="type">PlutusTx</span>.liftCode deadline</span><br><span class="line"></span><br><span class="line"><span class="title">curSymbol</span> :: <span class="type">PubKeyHash</span> -&gt; <span class="type">Slot</span> -&gt; <span class="type">CurrencySymbol</span></span><br><span class="line"><span class="comment">-- curSymbol pkh deadline = undefined -- IMPLEMENT ME!</span></span><br><span class="line"><span class="title">curSymbol</span> = (scriptCurrencySymbol .) . policy</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">MintParams</span> = <span class="type">MintParams</span></span></span><br><span class="line">    &#123; mpTokenName :: !<span class="type">TokenName</span> <span class="comment">-- ^ token名称</span></span><br><span class="line">    , mpDeadline  :: !<span class="type">Slot</span>      <span class="comment">-- ^ 截止时间</span></span><br><span class="line">    , mpAmount    :: !<span class="type">Integer</span>   <span class="comment">-- ^ 数量</span></span><br><span class="line">    &#125; <span class="keyword">deriving</span> (<span class="type">Generic</span>, <span class="type">ToJSON</span>, <span class="type">FromJSON</span>, <span class="type">ToSchema</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="type">SignedSchema</span> =</span></span><br><span class="line">    <span class="type">BlockchainActions</span></span><br><span class="line">        .\/ <span class="type">Endpoint</span> <span class="string">"mint"</span> <span class="type">MintParams</span></span><br><span class="line"></span><br><span class="line"><span class="title">mint</span> :: <span class="type">MintParams</span> -&gt; <span class="type">Contract</span> w <span class="type">SignedSchema</span> <span class="type">Text</span> ()</span><br><span class="line"><span class="title">mint</span> mp = <span class="keyword">do</span></span><br><span class="line">    <span class="comment">-- ownPubKey 获取运行此合同的钱包的公钥</span></span><br><span class="line">    pkh &lt;- pubKeyHash &lt;$&gt; <span class="type">Contract</span>.ownPubKey</span><br><span class="line">    <span class="comment">-- 当前slot number</span></span><br><span class="line">    now &lt;- <span class="type">Contract</span>.currentSlot</span><br><span class="line">    <span class="keyword">let</span> deadline = mpDeadline mp</span><br><span class="line">    <span class="keyword">if</span> now &gt; deadline</span><br><span class="line">        <span class="comment">-- 截止时间已经过去了</span></span><br><span class="line">        <span class="keyword">then</span> <span class="type">Contract</span>.logError @<span class="type">String</span> <span class="string">"deadline passed"</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">do</span></span><br><span class="line">            <span class="keyword">let</span> val     = <span class="type">Value</span>.singleton (curSymbol pkh deadline) (mpTokenName mp) (mpAmount mp)</span><br><span class="line">                lookups = <span class="type">Constraints</span>.monetaryPolicy $ policy pkh deadline</span><br><span class="line">                <span class="comment">-- to :: a -&gt; Interval a 获取所有小于deadline的值</span></span><br><span class="line">                <span class="comment">-- mustValidateIn r要求交易的slot范围包含在`r`中</span></span><br><span class="line">                tx      = <span class="type">Constraints</span>.mustForgeValue val &lt;&gt; <span class="type">Constraints</span>.mustValidateIn (to deadline)</span><br><span class="line">            ledgerTx &lt;- submitTxConstraintsWith @<span class="type">Void</span> lookups tx</span><br><span class="line">            void $ awaitTxConfirmed $ txId ledgerTx</span><br><span class="line">            <span class="type">Contract</span>.logInfo @<span class="type">String</span> $ printf <span class="string">"forged %s"</span> (show val)</span><br><span class="line"></span><br><span class="line"><span class="title">endpoints</span> :: <span class="type">Contract</span> () <span class="type">SignedSchema</span> <span class="type">Text</span> ()</span><br><span class="line"><span class="title">endpoints</span> = mint' &gt;&gt; endpoints</span><br><span class="line">  <span class="keyword">where</span></span><br><span class="line">    mint' = endpoint @<span class="string">"mint"</span> &gt;&gt;= mint</span><br><span class="line"></span><br><span class="line"><span class="title">mkSchemaDefinitions</span> ''<span class="type">SignedSchema</span></span><br><span class="line"></span><br><span class="line"><span class="title">mkKnownCurrencies</span> []</span><br><span class="line"></span><br><span class="line"><span class="title">test</span> :: <span class="type">IO</span> ()</span><br><span class="line"><span class="title">test</span> = runEmulatorTraceIO $ <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">let</span> tn       = <span class="string">"ABC"</span></span><br><span class="line">        deadline = <span class="number">10</span></span><br><span class="line">    h &lt;- activateContractWallet (<span class="type">Wallet</span> <span class="number">1</span>) endpoints</span><br><span class="line">    callEndpoint @<span class="string">"mint"</span> h $ <span class="type">MintParams</span></span><br><span class="line">        &#123; mpTokenName = tn</span><br><span class="line">        , mpDeadline  = deadline</span><br><span class="line">        , mpAmount    = <span class="number">555</span></span><br><span class="line">        &#125;</span><br><span class="line">    void $ <span class="type">Emulator</span>.waitNSlots <span class="number">15</span></span><br><span class="line">    callEndpoint @<span class="string">"mint"</span> h $ <span class="type">MintParams</span></span><br><span class="line">        &#123; mpTokenName = tn</span><br><span class="line">        , mpDeadline  = deadline</span><br><span class="line">        , mpAmount    = <span class="number">555</span></span><br><span class="line">        &#125;</span><br><span class="line">    void $ <span class="type">Emulator</span>.waitNSlots <span class="number">1</span></span><br></pre></td></tr></table></figure>
<h4 id="作业2"><a href="#作业2" class="headerlink" title="作业2"></a>作业2</h4><blockquote>
<p><code>NFT</code>的铸造策略，其中铸造交易必须使用给定的<code>UTxO</code>作为输入，并且<code>TokenName</code>将是空的<code>ByteString</code></p>
</blockquote>
<p><strong>空</strong><code>ByteString</code>:</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- λ &gt; import PlutusTx.Builtins</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- λ &gt; :t emptyByteString</span></span><br><span class="line"><span class="comment">-- emptyByteString :: ByteString</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- λ &gt; emptyByteString</span></span><br><span class="line"><span class="comment">-- ""</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- emptyByteString :: ByteString</span></span><br><span class="line"><span class="comment">-- emptyByteString = BS.empty</span></span><br><span class="line"></span><br><span class="line"><span class="title">adaToken</span> :: <span class="type">TokenName</span></span><br><span class="line"><span class="title">adaToken</span> = <span class="type">TH</span>.tokenName emptyByteString</span><br></pre></td></tr></table></figure>
<p>打开<code>~/haskell/plutus-pioneer-program/code/week05/src/Week05/Homework2.hs</code>文件:</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&#123;-# LANGUAGE RecordWildCards #-&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 导入emptyByteString</span></span><br><span class="line"><span class="keyword">import</span> PlutusTx.Builtins</span><br><span class="line"></span><br><span class="line"><span class="meta">&#123;-# INLINABLE mkPolicy #-&#125;</span></span><br><span class="line"><span class="comment">-- Minting policy for an NFT, where the minting transaction must consume the given UTxO as input</span></span><br><span class="line"><span class="comment">-- and where the TokenName will be the empty ByteString.</span></span><br><span class="line"><span class="title">mkPolicy</span> :: <span class="type">TxOutRef</span> -&gt; <span class="type">ScriptContext</span> -&gt; <span class="type">Bool</span></span><br><span class="line"><span class="comment">-- mkPolicy oref ctx = True -- FIX ME!</span></span><br><span class="line"><span class="title">mkPolicy</span> oref sc@<span class="type">ScriptContext</span>&#123;scriptContextTxInfo=<span class="type">TxInfo</span>&#123;..&#125;&#125; =</span><br><span class="line">    traceIfFalse <span class="string">"wrong amount minted"</span> (txInfoForge == singleton (ownCurrencySymbol sc) emptyTokenName <span class="number">1</span>)</span><br><span class="line">    <span class="comment">-- txInInfoOutRef 获取到utxo</span></span><br><span class="line">    &amp;&amp; traceIfFalse <span class="string">"UTxO not consumed"</span> (oref `elem` fmap txInInfoOutRef txInfoInputs)</span><br><span class="line"></span><br><span class="line"><span class="title">policy</span> :: <span class="type">TxOutRef</span> -&gt; <span class="type">Scripts</span>.<span class="type">MonetaryPolicy</span></span><br><span class="line"><span class="comment">-- policy oref = undefined -- IMPLEMENT ME!</span></span><br><span class="line"><span class="title">policy</span> oref = mkMonetaryPolicyScript $</span><br><span class="line">    $$(<span class="type">PlutusTx</span>.compile [|| <span class="type">Scripts</span>.wrapMonetaryPolicy . mkPolicy ||])</span><br><span class="line">    `<span class="type">PlutusTx</span>.applyCode`</span><br><span class="line">    <span class="type">PlutusTx</span>.liftCode oref</span><br><span class="line"></span><br><span class="line"><span class="title">curSymbol</span> :: <span class="type">TxOutRef</span> -&gt; <span class="type">CurrencySymbol</span></span><br><span class="line"><span class="comment">-- curSymbol = undefined -- IMPLEMENT ME!</span></span><br><span class="line"><span class="title">curSymbol</span> = scriptCurrencySymbol . policy</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="type">NFTSchema</span> =</span></span><br><span class="line">    <span class="type">BlockchainActions</span></span><br><span class="line">        .\/ <span class="type">Endpoint</span> <span class="string">"mint"</span> ()</span><br><span class="line"></span><br><span class="line"><span class="title">mint</span> :: <span class="type">Contract</span> w <span class="type">NFTSchema</span> <span class="type">Text</span> ()</span><br><span class="line"><span class="comment">-- mint = undefined -- IMPLEMENT ME!</span></span><br><span class="line"><span class="title">mint</span> = <span class="keyword">do</span></span><br><span class="line">    pk &lt;- <span class="type">Contract</span>.ownPubKey</span><br><span class="line">    <span class="comment">-- 获取所有utxos</span></span><br><span class="line">    utxos &lt;- utxoAt (pubKeyAddress pk)</span><br><span class="line">    <span class="keyword">case</span> <span class="type">Map</span>.keys utxos <span class="keyword">of</span></span><br><span class="line">        []       -&gt;  <span class="type">Contract</span>.logError @<span class="type">String</span> <span class="string">"no utxo found"</span></span><br><span class="line">        uniq : _ -&gt; <span class="keyword">do</span></span><br><span class="line">            <span class="keyword">let</span> val = singleton (curSymbol uniq) emptyTokenName <span class="number">1</span></span><br><span class="line">                <span class="comment">-- 使用货币策略脚本查找值</span></span><br><span class="line">                lookups :: <span class="type">ScriptLookups</span> <span class="type">Void</span></span><br><span class="line">                lookups = <span class="type">Constraints</span>.monetaryPolicy (policy uniq) &lt;&gt; <span class="type">Constraints</span>.unspentOutputs utxos</span><br><span class="line">                <span class="comment">-- 约束</span></span><br><span class="line">                constraints = mustForgeValue val &lt;&gt; mustSpendPubKeyOutput uniq</span><br><span class="line">            <span class="comment">-- 构建满足约束的交易，然后将其提交到网络</span></span><br><span class="line">            tx &lt;- submitTxConstraintsWith lookups constraints</span><br><span class="line">            awaitTxConfirmed $ txId tx</span><br><span class="line">            logInfo . (<span class="string">"Forged "</span> ++) $ show uniq</span><br><span class="line"></span><br><span class="line"><span class="title">endpoints</span> :: <span class="type">Contract</span> () <span class="type">NFTSchema</span> <span class="type">Text</span> ()</span><br><span class="line"><span class="title">endpoints</span> = mint' &gt;&gt; endpoints</span><br><span class="line">  <span class="keyword">where</span></span><br><span class="line">    mint' = endpoint @<span class="string">"mint"</span> &gt;&gt; mint</span><br><span class="line"></span><br><span class="line"><span class="title">mkSchemaDefinitions</span> ''<span class="type">NFTSchema</span></span><br><span class="line"></span><br><span class="line"><span class="title">mkKnownCurrencies</span> []</span><br><span class="line"></span><br><span class="line"><span class="title">test</span> :: <span class="type">IO</span> ()</span><br><span class="line"><span class="title">test</span> = runEmulatorTraceIO $ <span class="keyword">do</span></span><br><span class="line">    h1 &lt;- activateContractWallet (<span class="type">Wallet</span> <span class="number">1</span>) endpoints</span><br><span class="line">    h2 &lt;- activateContractWallet (<span class="type">Wallet</span> <span class="number">2</span>) endpoints</span><br><span class="line">    callEndpoint @<span class="string">"mint"</span> h1 ()</span><br><span class="line">    callEndpoint @<span class="string">"mint"</span> h2 ()</span><br><span class="line">    void $ <span class="type">Emulator</span>.waitNSlots <span class="number">1</span></span><br></pre></td></tr></table></figure>
        
            <div class="donate-container">
    <div class="donate-button">
        <button id="donate-button">赞赏</button>
    </div>
    <div class="donate-img-container hide" id="donate-img-container">
        <img id="donate-img" src="" data-src="/blog/img/pay.png">
        <p> thank you </p>
    </div>
</div>
        
        <div id="comment-container">
        </div>
    </div>
</div>
    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <span>/</span>
        
        <span><a href="https://medium.com/netflix-techblog">Netflix</a></span>
        <span>/</span>
        
        <span><a href="https://engineering.linkedin.com/blog">Linkedin</a></span>
        <span>/</span>
        
        <span><a href="https://blogs.dropbox.com/tech/">Dropbox</a></span>
        <span>/</span>
        
        <span><a href="https://code.fb.com/">Facebook</a></span>
        <span>/</span>
        
        <span><a href="https://www.fpcomplete.com/blog">FPComplete</a></span>
        <span>/</span>
        
        <span><a href="https://blog.janestreet.com/">JaneStreet</a></span>
        <span>/</span>
        
        <span><a href="https://github.com/limengyu1990/">Github</a></span>
        <span>/</span>
        
        <span><a href="https://serokell.io/blog">serokell</a></span>
        <span>/</span>
        
        <span><a href="https://iohk.io/en/blog">IOHK</a></span>
        <span>/</span>
        
    </p>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/blog/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/blog/js/index.js"></script>

<!--create by tea9-->

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
    <script>
        var gitalk = new Gitalk({
          clientID: '7cfc73dd62b57f07ed83',
          clientSecret: 'dd03b7e54aadf0d81e4c9c93e23a41272bcfcfa1',
          repo: 'blog',
          owner: 'limengyu1990',
          admin: 'limengyu1990',
          id: location.pathname,      // Ensure uniqueness and length less than 50
          distractionFreeMode: false  // Facebook-like distraction free mode
        })
        gitalk.render('comment-container')
    </script>

<!--end-->


</html>
