<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/blog/img/favicon.ico">

    <title>
        
        Plutus-Pioneer-lesson-04 - undefined
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/blog/css/aircloud.css">
    <link rel="stylesheet" href="/blog/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> 所有的善恶都是我，良心一路走来依旧清澈鲜活... </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar">
            <img src="/blog/img/photo.png" />
        </div>
        <div class="name">
            <i>不负如来不负卿</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/blog/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/blog/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/blog/archive">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/blog/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#发现规律"><span class="toc-text">发现规律</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Maybe"><span class="toc-text">Maybe</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Either"><span class="toc-text">Either</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Writer"><span class="toc-text">Writer</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#引出Monad"><span class="toc-text">引出Monad</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Plutus中的一些Monads"><span class="toc-text">Plutus中的一些Monads</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#EmulatorTrace-Monad"><span class="toc-text">EmulatorTrace Monad</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Contract-Monad"><span class="toc-text">Contract Monad</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#作业"><span class="toc-text">作业</span></a></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>
        <div class="index-about-mobile">
            <i> 所有的善恶都是我，良心一路走来依旧清澈鲜活... </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        Plutus-Pioneer-lesson-04
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2021-04-27 13:52:43</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/blog/tags/#Haskell" title="Haskell">Haskell</a>
        <span>/</span>
        
        <a class="tag" href="/blog/tags/#Plutus" title="Plutus">Plutus</a>
        <span>/</span>
        
        <a class="tag" href="/blog/tags/#DApps" title="DApps">DApps</a>
        <span>/</span>
        
        <a class="tag" href="/blog/tags/#智能合约" title="智能合约">智能合约</a>
        <span>/</span>
        
        <a class="tag" href="/blog/tags/#Cardano" title="Cardano">Cardano</a>
        <span>/</span>
        
        <a class="tag" href="/blog/tags/#Pioneer" title="Pioneer">Pioneer</a>
        <span>/</span>
        
        <a class="tag" href="/blog/tags/#Monad" title="Monad">Monad</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <blockquote>
<p>本节课内容主要讲解Monads，并在最后介绍了EmulatorTrace Monad和Contract Monad.</p>
</blockquote>
<h3 id="发现规律"><a href="#发现规律" class="headerlink" title="发现规律"></a>发现规律</h3><h4 id="Maybe"><a href="#Maybe" class="headerlink" title="Maybe"></a>Maybe</h4><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">Maybe</span> a = <span class="type">Nothing</span> | <span class="type">Just</span> a</span></span><br></pre></td></tr></table></figure>
<p><code>Maybe</code>可以在成功时返回<code>Just</code>，失败时返回<code>Nothing</code>.</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> Text.Read (<span class="title">readMaybe</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 从字符串中读取指定类型的数据，如果没有读取到则返回Nothing</span></span><br><span class="line"><span class="title">readMaybe</span> :: <span class="type">Read</span> a =&gt; <span class="type">String</span> -&gt; <span class="type">Maybe</span> a</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 在repl中练习</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- λ &gt; readMaybe "12" :: Maybe Int</span></span><br><span class="line"><span class="comment">-- Just 12</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- λ &gt; readMaybe "\"hello world\"" :: Maybe String</span></span><br><span class="line"><span class="comment">-- Just "hello world"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- λ &gt; readMaybe "a" :: Maybe Char</span></span><br><span class="line"><span class="comment">-- Nothing</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- λ &gt; readMaybe "'a'" :: Maybe Char</span></span><br><span class="line"><span class="comment">-- Just 'a'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- foo函数接收三个字符串参数，并从中解析出数字，然后计算他们的和</span></span><br><span class="line"><span class="comment">-- 如果有一个没有解析出数字，就返回Nothing</span></span><br><span class="line"><span class="title">foo</span> :: <span class="type">String</span> -&gt; <span class="type">String</span> -&gt; <span class="type">String</span> -&gt; <span class="type">Maybe</span> <span class="type">Int</span></span><br><span class="line"><span class="title">foo</span> x y z = <span class="keyword">case</span> readMaybe x <span class="keyword">of</span></span><br><span class="line">    <span class="comment">-- 1.如果x解析结果为Nothing，则直接返回Nothing</span></span><br><span class="line">    <span class="type">Nothing</span> -&gt; <span class="type">Nothing</span></span><br><span class="line">    <span class="comment">-- 2.如果x解析结果不是Nothing的话，再去检查y是不是Nothing</span></span><br><span class="line">    <span class="type">Just</span> k  -&gt; <span class="keyword">case</span> readMaybe y <span class="keyword">of</span></span><br><span class="line">        <span class="type">Nothing</span> -&gt; <span class="type">Nothing</span></span><br><span class="line">        <span class="comment">-- 3.如果y解析结果不是Nothing的话，再去检查z是不是Nothing</span></span><br><span class="line">        <span class="type">Just</span> l  -&gt; <span class="keyword">case</span> readMaybe z <span class="keyword">of</span></span><br><span class="line">            <span class="type">Nothing</span> -&gt; <span class="type">Nothing</span></span><br><span class="line">            <span class="comment">-- 4.如果z解析结果不是Nothing的话，则累加xyz的结果并返回</span></span><br><span class="line">            <span class="type">Just</span> m  -&gt; <span class="type">Just</span> (k + l + m)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 注意: </span></span><br><span class="line"><span class="comment">-- 从foo函数1/2/3/4等步骤可以观察到:</span></span><br><span class="line"><span class="comment">--   每一步都是在检查当前Maybe(例如: readMaybe x)值是不是Nothing,</span></span><br><span class="line"><span class="comment">--   如果是Nothing就直接返回，不是Nothing则执行下一步操作流程.</span></span><br><span class="line"><span class="comment">-- </span></span><br><span class="line"><span class="comment">-- 因此我们可以把该操作流程抽象成一个通用函数bindMaybe: </span></span><br><span class="line"><span class="comment">--   接收一个参数a(上一步解析出来的结果)，返回下一个Maybe值b</span></span><br><span class="line"><span class="title">bindMaybe</span> :: <span class="type">Maybe</span> a -&gt; (a -&gt; <span class="type">Maybe</span> b) -&gt; <span class="type">Maybe</span> b</span><br><span class="line"><span class="title">bindMaybe</span> <span class="type">Nothing</span>  _ = <span class="type">Nothing</span></span><br><span class="line"><span class="title">bindMaybe</span> (<span class="type">Just</span> x) f = f x</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用我们的抽象函数bindMaybe来重写foo函数:</span></span><br><span class="line"><span class="title">foo'</span> :: <span class="type">String</span> -&gt; <span class="type">String</span> -&gt; <span class="type">String</span> -&gt; <span class="type">Maybe</span> <span class="type">Int</span></span><br><span class="line"><span class="title">foo'</span> x y z = readMaybe x `bindMaybe` \k -&gt;</span><br><span class="line">             readMaybe y `bindMaybe` \l -&gt;</span><br><span class="line">             readMaybe z `bindMaybe` \m -&gt;</span><br><span class="line">             <span class="type">Just</span> (k + l + m)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 再一次重写foo函数</span></span><br><span class="line"><span class="comment">-- 我们稍后再看threeInts函数</span></span><br><span class="line"><span class="title">foo''</span> :: <span class="type">String</span> -&gt; <span class="type">String</span> -&gt; <span class="type">String</span> -&gt; <span class="type">Maybe</span> <span class="type">Int</span></span><br><span class="line"><span class="title">foo''</span> x y z = threeInts (readMaybe x) (readMaybe y) (readMaybe z)</span><br></pre></td></tr></table></figure>
<h4 id="Either"><a href="#Either" class="headerlink" title="Either"></a>Either</h4><p>与<code>Maybe</code>类相比，<code>Either</code>类可以在失败时提供更多错误信息.<br><code>Either</code>类定义如下, 失败时返回<code>Left</code>, 成功时返回<code>Right</code>:<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">Either</span> a b = <span class="type">Left</span> a | <span class="type">Right</span> b</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 与readMaybe类似，成功时将返回Right, 失败时返回Left，并附带错误原因</span></span><br><span class="line"><span class="title">readEither</span> :: <span class="type">Read</span> a =&gt; <span class="type">String</span> -&gt; <span class="type">Either</span> <span class="type">String</span> a</span><br><span class="line"><span class="title">readEither</span> s = <span class="keyword">case</span> readMaybe s <span class="keyword">of</span></span><br><span class="line">    <span class="type">Nothing</span> -&gt; <span class="type">Left</span> $ <span class="string">"can't parse: "</span> ++ s</span><br><span class="line">    <span class="type">Just</span> a  -&gt; <span class="type">Right</span> a</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用readEither来从字符串中解析数字</span></span><br><span class="line"><span class="title">foo</span> :: <span class="type">String</span> -&gt; <span class="type">String</span> -&gt; <span class="type">String</span> -&gt; <span class="type">Either</span> <span class="type">String</span> <span class="type">Int</span></span><br><span class="line"><span class="title">foo</span> x y z = <span class="keyword">case</span> readEither x <span class="keyword">of</span></span><br><span class="line">    <span class="type">Left</span> err -&gt; <span class="type">Left</span> err</span><br><span class="line">    <span class="comment">-- 解析x成功，接着尝试解析y</span></span><br><span class="line">    <span class="type">Right</span> k  -&gt; <span class="keyword">case</span> readEither y <span class="keyword">of</span></span><br><span class="line">        <span class="type">Left</span> err -&gt; <span class="type">Left</span> err</span><br><span class="line">        <span class="comment">-- 解析y成功，接着尝试解析z</span></span><br><span class="line">        <span class="type">Right</span> l  -&gt; <span class="keyword">case</span> readEither z <span class="keyword">of</span></span><br><span class="line">            <span class="type">Left</span> err -&gt; <span class="type">Left</span> err</span><br><span class="line">            <span class="comment">-- 解析z成功，返回xyz的累加结果</span></span><br><span class="line">            <span class="type">Right</span> m  -&gt; <span class="type">Right</span> (k + l + m)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 与bindMaybe类似:</span></span><br><span class="line"><span class="comment">-- 先从Either String a中解析a，</span></span><br><span class="line"><span class="comment">-- 如果解析出来a，则调用函数: (a -&gt; Either String b)，否则返回Left</span></span><br><span class="line"><span class="title">bindEither</span> :: <span class="type">Either</span> <span class="type">String</span> a -&gt; (a -&gt; <span class="type">Either</span> <span class="type">String</span> b) -&gt; <span class="type">Either</span> <span class="type">String</span> b</span><br><span class="line"><span class="title">bindEither</span> (<span class="type">Left</span> err) _ = <span class="type">Left</span> err</span><br><span class="line"><span class="title">bindEither</span> (<span class="type">Right</span> x)  f = f x</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用bindEither重写foo函数</span></span><br><span class="line"><span class="title">foo'</span> :: <span class="type">String</span> -&gt; <span class="type">String</span> -&gt; <span class="type">String</span> -&gt; <span class="type">Either</span> <span class="type">String</span> <span class="type">Int</span></span><br><span class="line"><span class="title">foo'</span> x y z = readEither x `bindEither` \k -&gt;</span><br><span class="line">             readEither y `bindEither` \l -&gt;</span><br><span class="line">             readEither z `bindEither` \m -&gt;</span><br><span class="line">             <span class="type">Right</span> (k + l + m)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用threeInts重写foo函数</span></span><br><span class="line"><span class="title">foo''</span> :: <span class="type">String</span> -&gt; <span class="type">String</span> -&gt; <span class="type">String</span> -&gt; <span class="type">Either</span> <span class="type">String</span> <span class="type">Int</span></span><br><span class="line"><span class="title">foo''</span> x y z = threeInts (readEither x) (readEither y) (readEither z)</span><br></pre></td></tr></table></figure>
<h4 id="Writer"><a href="#Writer" class="headerlink" title="Writer"></a>Writer</h4><p><code>Writer</code> 可以让我们在做计算的同时收集一些日志，并汇集成一个log附加到结果上. </p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Control.Monad</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">Writer</span> a = <span class="type">Writer</span> a [<span class="type">String</span>]</span></span><br><span class="line">    <span class="keyword">deriving</span> <span class="type">Show</span></span><br><span class="line"></span><br><span class="line"><span class="title">number</span> :: <span class="type">Int</span> -&gt; <span class="type">Writer</span> <span class="type">Int</span></span><br><span class="line"><span class="title">number</span> n = <span class="type">Writer</span> n $ [<span class="string">"number: "</span> ++ show n]</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 可以忽略一些结果(使用单元类型`()`)，只记录日志</span></span><br><span class="line"><span class="title">tell</span> :: [<span class="type">String</span>] -&gt; <span class="type">Writer</span> ()</span><br><span class="line"><span class="title">tell</span> = <span class="type">Writer</span> ()</span><br><span class="line"></span><br><span class="line"><span class="title">foo</span> :: <span class="type">Writer</span> <span class="type">Int</span> -&gt; <span class="type">Writer</span> <span class="type">Int</span> -&gt; <span class="type">Writer</span> <span class="type">Int</span> -&gt; <span class="type">Writer</span> <span class="type">Int</span></span><br><span class="line"><span class="title">foo</span> (<span class="type">Writer</span> k xs) (<span class="type">Writer</span> l ys) (<span class="type">Writer</span> m zs) =</span><br><span class="line">  <span class="keyword">let</span></span><br><span class="line">    s = k + l + m</span><br><span class="line">    <span class="comment">-- 记录3个数字的总和</span></span><br><span class="line">    <span class="type">Writer</span> _ us = tell [<span class="string">"sum: "</span> ++ show s]</span><br><span class="line">  <span class="keyword">in</span></span><br><span class="line">    <span class="comment">-- 记录结果s和计算时的日志信息</span></span><br><span class="line">    <span class="type">Writer</span> s $ xs ++ ys ++ zs ++ us</span><br><span class="line"></span><br><span class="line"><span class="title">bindWriter</span> :: <span class="type">Writer</span> a -&gt; (a -&gt; <span class="type">Writer</span> b) -&gt; <span class="type">Writer</span> b</span><br><span class="line"><span class="title">bindWriter</span> (<span class="type">Writer</span> a xs) f =</span><br><span class="line">  <span class="keyword">let</span></span><br><span class="line">    <span class="comment">-- 从`Writer a`中取出结果`a`, </span></span><br><span class="line">    <span class="comment">-- 然后使用`a`调用函数(a -&gt; Writer b)取得下一个结果`b`</span></span><br><span class="line">    <span class="type">Writer</span> b ys = f a</span><br><span class="line">  <span class="keyword">in</span></span><br><span class="line">    <span class="comment">-- 记录最终结果b，并累加上次和下次的记录</span></span><br><span class="line">    <span class="type">Writer</span> b $ xs ++ ys</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用bindWriter重写foo函数</span></span><br><span class="line"><span class="title">foo'</span> :: <span class="type">Writer</span> <span class="type">Int</span> -&gt; <span class="type">Writer</span> <span class="type">Int</span> -&gt; <span class="type">Writer</span> <span class="type">Int</span> -&gt; <span class="type">Writer</span> <span class="type">Int</span></span><br><span class="line"><span class="title">foo'</span> x y z = x `bindWriter` \k -&gt;</span><br><span class="line">             y `bindWriter` \l -&gt;</span><br><span class="line">             z `bindWriter` \m -&gt;</span><br><span class="line">             <span class="keyword">let</span> s = k + l + m</span><br><span class="line">             <span class="keyword">in</span> tell [<span class="string">"sum: "</span> ++ show s] `bindWriter` \_ -&gt;</span><br><span class="line">                <span class="type">Writer</span> s []</span><br><span class="line"></span><br><span class="line"><span class="comment">-- -- 使用threeInts重写foo函数</span></span><br><span class="line"><span class="title">foo''</span> :: <span class="type">Writer</span> <span class="type">Int</span> -&gt; <span class="type">Writer</span> <span class="type">Int</span> -&gt; <span class="type">Writer</span> <span class="type">Int</span> -&gt; <span class="type">Writer</span> <span class="type">Int</span></span><br><span class="line"><span class="title">foo''</span> x y z = <span class="keyword">do</span></span><br><span class="line">    s &lt;- threeInts x y z</span><br><span class="line">    tell [<span class="string">"sum: "</span> ++ show s]</span><br><span class="line">    return s</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 将自定义的Writer实现为Functor/Applicative/Monad</span></span><br><span class="line"><span class="class"><span class="keyword">instance</span> <span class="type">Functor</span> <span class="type">Writer</span> <span class="keyword">where</span></span></span><br><span class="line">    <span class="comment">-- fmap :: Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b</span></span><br><span class="line">    <span class="comment">-- liftM :: Monad m =&gt; (a1 -&gt; r) -&gt; m a1 -&gt; m r</span></span><br><span class="line">    fmap = liftM</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">instance</span> <span class="type">Applicative</span> <span class="type">Writer</span> <span class="keyword">where</span></span></span><br><span class="line">    <span class="comment">-- pure :: Applicative f =&gt; a -&gt; f a</span></span><br><span class="line">    <span class="comment">-- return :: Monad m =&gt; a -&gt; m a</span></span><br><span class="line">    pure = return</span><br><span class="line">    <span class="comment">-- ap :: Monad m =&gt; m (a -&gt; b) -&gt; m a -&gt; m b</span></span><br><span class="line">    <span class="comment">-- (&lt;*&gt;) :: Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b</span></span><br><span class="line">    (&lt;*&gt;) = ap</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">instance</span> <span class="type">Monad</span> <span class="type">Writer</span> <span class="keyword">where</span></span></span><br><span class="line">    return a = <span class="type">Writer</span> a []</span><br><span class="line">    (&gt;&gt;=) = bindWriter</span><br></pre></td></tr></table></figure>
<h3 id="引出Monad"><a href="#引出Monad" class="headerlink" title="引出Monad"></a>引出Monad</h3><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">-- Monad类型类 定义</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="type">Applicative</span> m =&gt; <span class="type">Monad</span> m <span class="keyword">where</span></span></span><br><span class="line">  (&gt;&gt;=) :: m a -&gt; (a -&gt; m b) -&gt; m b</span><br><span class="line">  (&gt;&gt;) :: m a -&gt; m b -&gt; m b</span><br><span class="line">  return :: a -&gt; m a</span><br><span class="line">  <span class="meta">&#123;-# MINIMAL (&gt;&gt;=) #-&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- (&gt;&gt;=)      :: IO a            -&gt; (a -&gt; IO b)            -&gt; IO b</span></span><br><span class="line"><span class="comment">-- 上一小节我们定义的3个函数:</span></span><br><span class="line"><span class="comment">-- bindMaybe  :: Maybe a         -&gt; (a -&gt; Maybe b)         -&gt; Maybe b</span></span><br><span class="line"><span class="comment">-- bindEither :: Either String a -&gt; (a -&gt; Either String b) -&gt; Either String b</span></span><br><span class="line"><span class="comment">-- bindWriter :: Writer a        -&gt; (a -&gt; Writer b)        -&gt; Writer b</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- return              :: a -&gt; IO a</span></span><br><span class="line"><span class="comment">-- 上一小节我们使用的类型:</span></span><br><span class="line"><span class="comment">-- Just                :: a -&gt; Maybe a</span></span><br><span class="line"><span class="comment">-- Right               :: a -&gt; Either String a</span></span><br><span class="line"><span class="comment">-- (\a -&gt; Writer a []) :: a -&gt; Writer a</span></span><br></pre></td></tr></table></figure>
<p>可以观察到我们定义的三个函数<code>bindMaybe</code>/<code>bindEither</code>/<code>bindWriter</code>与<code>(&gt;&gt;=)</code>函数是非常相似的，都是从一个上下文中取出一个值<code>a</code>，然后应用一个函数，得到一个新值<code>b</code>，然后放进上下文中并返回.</p>
<p>而<code>Just</code>/<code>Right</code>/<code>(\a -&gt; Writer a [])</code>与<code>return</code>函数很相似，都是将一个值<code>a</code>放进到当前上下文中.</p>
<p>由于<code>Maybe</code>/<code>Either</code>/<code>Writer</code>都是<code>Monad</code>类型类的实例，因此我们可以使用<code>(&gt;&gt;=)</code>函数和<code>return</code>函数来代替我们的自定义函数。</p>
<p>我们可以定义一个通用函数<code>threeInts</code>，然后使用<code>Monad</code>来限定参数类型:</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">threeInts</span> :: <span class="type">Monad</span> m =&gt; m <span class="type">Int</span> -&gt; m <span class="type">Int</span> -&gt; m <span class="type">Int</span> -&gt; m <span class="type">Int</span></span><br><span class="line"><span class="title">threeInts</span> mx my mz =</span><br><span class="line">    mx &gt;&gt;= \k -&gt;</span><br><span class="line">    my &gt;&gt;= \l -&gt;</span><br><span class="line">    mz &gt;&gt;= \m -&gt;</span><br><span class="line">    <span class="keyword">let</span> s = k + l + m <span class="keyword">in</span> return s</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用do语句</span></span><br><span class="line"><span class="title">threeInts'</span> :: <span class="type">Monad</span> m =&gt; m <span class="type">Int</span> -&gt; m <span class="type">Int</span> -&gt; m <span class="type">Int</span> -&gt; m <span class="type">Int</span></span><br><span class="line"><span class="title">threeInts'</span> mx my mz = <span class="keyword">do</span></span><br><span class="line">    k &lt;- mx</span><br><span class="line">    l &lt;- my</span><br><span class="line">    m &lt;- mz</span><br><span class="line">    <span class="keyword">let</span> s = k + l + m</span><br><span class="line">    return s</span><br></pre></td></tr></table></figure>
<p>然后我们就可以使用<code>threeInts</code>函数重写<code>foo</code>函数了，具体实现参见上一小节的<code>foo&#39;&#39;</code>函数.</p>
<h3 id="Plutus中的一些Monads"><a href="#Plutus中的一些Monads" class="headerlink" title="Plutus中的一些Monads"></a>Plutus中的一些Monads</h3><h4 id="EmulatorTrace-Monad"><a href="#EmulatorTrace-Monad" class="headerlink" title="EmulatorTrace Monad"></a>EmulatorTrace Monad</h4><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Plutus.Trace.Emulator</span><br><span class="line"><span class="keyword">import</span> Plutus.Contract.Trace</span><br><span class="line"><span class="keyword">import</span> Plutus.V1.Ledger.Value</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 标识一个钱包</span></span><br><span class="line"><span class="class"><span class="keyword">newtype</span> <span class="type">Wallet</span> = <span class="type">Wallet</span> &#123;<span class="title">getWallet</span> :: <span class="type">Integer</span>&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- &lt;货币符号，&lt;token名称，金额&gt;&gt;</span></span><br><span class="line"><span class="class"><span class="keyword">newtype</span> <span class="type">Value</span> = <span class="type">Value</span> &#123;<span class="title">getValue</span> :: <span class="type">PlutusTx</span>.<span class="type">AssocMap</span>.<span class="type">Map</span></span></span><br><span class="line"><span class="class">      <span class="type">CurrencySymbol</span> (<span class="type">PlutusTx</span>.<span class="type">AssocMap</span>.<span class="type">Map</span> <span class="type">TokenName</span> <span class="type">Integer</span>)</span></span><br><span class="line"><span class="class">   &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 钱包及其值</span></span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="type">InitialDistribution</span> =</span></span><br><span class="line">    <span class="type">Map</span> <span class="type">Wallet</span> <span class="type">Value</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- λ &gt; defaultDist :: InitialDistribution</span></span><br><span class="line"><span class="comment">-- λ &gt; defaultDistFor :: [Wallet] -&gt; InitialDistribution</span></span><br><span class="line"><span class="comment">-- λ &gt; defaultDistFor [Wallet 1]</span></span><br><span class="line"><span class="comment">-- fromList [(Wallet 1,Value (Map [(,Map [("",100000000)])]))]</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="type">InitialChainState</span> =</span></span><br><span class="line">  <span class="type">Either</span> <span class="type">InitialDistribution</span> <span class="type">Ledger</span>.<span class="type">Blockchain</span>.<span class="type">Block</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 模拟器配置</span></span><br><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">EmulatorConfig</span> = <span class="type">EmulatorConfig</span> &#123;</span></span><br><span class="line"><span class="class">    <span class="title">_initialChainState</span> :: <span class="type">InitialChainState</span></span></span><br><span class="line"><span class="class">  &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 运行跟踪</span></span><br><span class="line"><span class="title">runEmulatorTrace</span> :: <span class="type">EmulatorConfig</span> </span><br><span class="line">    -&gt; <span class="type">EmulatorTrace</span> ()</span><br><span class="line">    -&gt; ([<span class="type">EmulatorEvent</span>], </span><br><span class="line">        <span class="type">Maybe</span> <span class="type">EmulatorErr</span>, </span><br><span class="line">        <span class="type">EmulatorState</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用默认配置运行跟踪</span></span><br><span class="line"><span class="title">runEmulatorTraceIO</span> :: <span class="type">EmulatorTrace</span> () -&gt; <span class="type">IO</span> ()</span><br><span class="line"></span><br><span class="line"><span class="comment">-- λ &gt; </span></span><br><span class="line"><span class="comment">-- λ &gt; -- 构建一个模拟器配置</span></span><br><span class="line"><span class="comment">-- λ &gt; :t EmulatorConfig $ Left defaultDist</span></span><br><span class="line"><span class="comment">-- EmulatorConfig $ Left defaultDist :: EmulatorConfig</span></span><br><span class="line"><span class="comment">-- λ &gt; </span></span><br><span class="line"><span class="comment">-- λ &gt; runEmulatorTrace (EmulatorConfig $ Left defaultDist) $ return ()</span></span><br><span class="line"><span class="comment">-- λ &gt; </span></span><br><span class="line"><span class="comment">-- λ &gt; runEmulatorTraceIO $ return ()</span></span><br><span class="line"><span class="comment">-- λ &gt;</span></span><br></pre></td></tr></table></figure>
<p>打开<code>~/haskell/plutus-pioneer-program/code/week04/src/Week04/Trace.hs</code>文件,<br>我们可以使用上面介绍的类型，来编写一些代码:</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">-- EmulatorTrace a</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 运行跟踪</span></span><br><span class="line"><span class="title">test</span> :: <span class="type">IO</span> ()</span><br><span class="line"><span class="title">test</span> = runEmulatorTraceIO myTrace</span><br><span class="line"></span><br><span class="line"><span class="title">myTrace</span> :: <span class="type">EmulatorTrace</span> ()</span><br><span class="line"><span class="title">myTrace</span> = <span class="keyword">do</span></span><br><span class="line">    <span class="comment">-- endpoints是我们上节课声明的游乐场端点(即: Contract合同)</span></span><br><span class="line">    h1 &lt;- activateContractWallet (<span class="type">Wallet</span> <span class="number">1</span>) endpoints</span><br><span class="line">    h2 &lt;- activateContractWallet (<span class="type">Wallet</span> <span class="number">2</span>) endpoints</span><br><span class="line">    <span class="comment">-- 使用钱包1调用give端点，并传递GiveParams参数</span></span><br><span class="line">    callEndpoint @<span class="string">"give"</span> h1 $ <span class="type">GiveParams</span></span><br><span class="line">        &#123; gpBeneficiary = pubKeyHash $ walletPubKey $ <span class="type">Wallet</span> <span class="number">2</span> <span class="comment">-- ^ 受益人的公钥哈希</span></span><br><span class="line">        , gpDeadline    = <span class="type">Slot</span> <span class="number">20</span>   <span class="comment">-- ^ 截止日期</span></span><br><span class="line">        , gpAmount      = <span class="number">1000</span>      <span class="comment">-- ^ 资金</span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">-- 等到slot 20</span></span><br><span class="line">    void $ waitUntilSlot <span class="number">20</span></span><br><span class="line">    <span class="comment">-- 钱包2调用grab端点，抓取资金</span></span><br><span class="line">    callEndpoint @<span class="string">"grab"</span> h2 ()</span><br><span class="line">    <span class="comment">-- 等待1个slot</span></span><br><span class="line">    <span class="comment">-- void $ waitNSlots 1</span></span><br><span class="line">    s &lt;- waitNSlots <span class="number">1</span></span><br><span class="line">    <span class="comment">-- 输出日志</span></span><br><span class="line">    <span class="type">Extras</span>.logInfo $ <span class="string">"reached slot "</span> ++ show s</span><br></pre></td></tr></table></figure>
<h4 id="Contract-Monad"><a href="#Contract-Monad" class="headerlink" title="Contract Monad"></a>Contract Monad</h4><p>打开<code>~/haskell/plutus-pioneer-program/code/week04/src/Week04/Contract.hs</code>文件:</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- w 类似writer monad，可以用来记录一些信息</span></span><br><span class="line"><span class="comment">-- s 合同schema, 可以获取区块链信息的能力</span></span><br><span class="line"><span class="comment">-- e 标识异常类型</span></span><br><span class="line"><span class="comment">-- a 标识计算结果</span></span><br><span class="line"><span class="comment">-- Contract w s e a</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 第1个合同示例(抛出异常)</span></span><br><span class="line"><span class="comment">-- myContract1 :: Contract () BlockchainActions Text ()</span></span><br><span class="line"><span class="comment">-- myContract1 = Contract.logInfo @String "Hello from the contract!"</span></span><br><span class="line"></span><br><span class="line"><span class="title">myContract1</span> :: <span class="type">Contract</span> () <span class="type">BlockchainActions</span> <span class="type">Text</span> ()</span><br><span class="line"><span class="title">myContract1</span> = <span class="keyword">do</span></span><br><span class="line">    <span class="comment">-- 抛出异常</span></span><br><span class="line">    void $ <span class="type">Contract</span>.throwError <span class="string">"BOOM!"</span></span><br><span class="line">    <span class="type">Contract</span>.logInfo @<span class="type">String</span> <span class="string">"Hello from the contract!"</span></span><br><span class="line"></span><br><span class="line"><span class="title">myTrace1</span> :: <span class="type">EmulatorTrace</span> ()</span><br><span class="line"><span class="title">myTrace1</span> = void $ activateContractWallet (<span class="type">Wallet</span> <span class="number">1</span>) myContract1</span><br><span class="line"></span><br><span class="line"><span class="title">test1</span> :: <span class="type">IO</span> ()</span><br><span class="line"><span class="title">test1</span> = runEmulatorTraceIO myTrace1</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 第2个合同示例(捕获合同错误)</span></span><br><span class="line"><span class="comment">-- logError :: ToJSON a =&gt; a -&gt; Contract w s e ()</span></span><br><span class="line"><span class="comment">-- handleError :: (e -&gt; Contract w s e' a) -&gt; Contract w s e a -&gt; Contract w s e' a</span></span><br><span class="line"><span class="title">myContract2</span> :: <span class="type">Contract</span> () <span class="type">BlockchainActions</span> <span class="type">Void</span> ()</span><br><span class="line"><span class="title">myContract2</span> = <span class="type">Contract</span>.handleError</span><br><span class="line">    (\err -&gt; <span class="type">Contract</span>.logError $ <span class="string">"Caught error: "</span> ++ unpack err)</span><br><span class="line">    myContract1</span><br><span class="line"></span><br><span class="line"><span class="title">myTrace2</span> :: <span class="type">EmulatorTrace</span> ()</span><br><span class="line"><span class="title">myTrace2</span> = void $ activateContractWallet (<span class="type">Wallet</span> <span class="number">1</span>) myContract2</span><br><span class="line"></span><br><span class="line"><span class="title">test2</span> :: <span class="type">IO</span> ()</span><br><span class="line"><span class="title">test2</span> = runEmulatorTraceIO myTrace2</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 第3个合同示例(获取端点信息)</span></span><br><span class="line"><span class="comment">-- 自定义端点</span></span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="type">MySchema</span> = <span class="type">BlockchainActions</span> .\/ <span class="type">Endpoint</span> "foo" <span class="type">Int</span></span></span><br><span class="line"></span><br><span class="line"><span class="title">myContract3</span> :: <span class="type">Contract</span> () <span class="type">MySchema</span> <span class="type">Text</span> ()</span><br><span class="line"><span class="title">myContract3</span> = <span class="keyword">do</span></span><br><span class="line">    <span class="comment">-- 获取端点信息</span></span><br><span class="line">    n &lt;- endpoint @<span class="string">"foo"</span></span><br><span class="line">    <span class="comment">-- 将会打印出获取到的参数值: 42</span></span><br><span class="line">    <span class="type">Contract</span>.logInfo n</span><br><span class="line"></span><br><span class="line"><span class="title">myTrace3</span> :: <span class="type">EmulatorTrace</span> ()</span><br><span class="line"><span class="title">myTrace3</span> = <span class="keyword">do</span></span><br><span class="line">    <span class="comment">-- 钱包1</span></span><br><span class="line">    h &lt;- activateContractWallet (<span class="type">Wallet</span> <span class="number">1</span>) myContract3</span><br><span class="line">    <span class="comment">-- 调用端点foo, 并传入参数42</span></span><br><span class="line">    callEndpoint @<span class="string">"foo"</span> h <span class="number">42</span></span><br><span class="line"></span><br><span class="line"><span class="title">test3</span> :: <span class="type">IO</span> ()</span><br><span class="line"><span class="title">test3</span> = runEmulatorTraceIO myTrace3</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 第4个合同示例(使用monoid来累加日志信息)</span></span><br><span class="line"><span class="comment">-- class Semigroup a =&gt; Monoid a where</span></span><br><span class="line"><span class="comment">--   mempty :: a</span></span><br><span class="line"><span class="comment">--   mappend :: a -&gt; a -&gt; a</span></span><br><span class="line"><span class="comment">--   mconcat :: [a] -&gt; a</span></span><br><span class="line"><span class="comment">--   &#123;-# MINIMAL mempty #-&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- λ &gt; mempty :: [Int]</span></span><br><span class="line"><span class="comment">-- []</span></span><br><span class="line"><span class="comment">-- λ &gt; mappend [1, 2, 3 :: Int] [4, 5, 6]</span></span><br><span class="line"><span class="comment">-- [1,2,3,4,5,6]</span></span><br><span class="line"></span><br><span class="line"><span class="title">myContract4</span> :: <span class="type">Contract</span> [<span class="type">Int</span>] <span class="type">BlockchainActions</span> <span class="type">Text</span> ()</span><br><span class="line"><span class="title">myContract4</span> = <span class="keyword">do</span></span><br><span class="line">    void $ <span class="type">Contract</span>.waitNSlots <span class="number">10</span></span><br><span class="line">    <span class="comment">-- 记录合同状态</span></span><br><span class="line">    tell [<span class="number">1</span>]</span><br><span class="line">    void $ <span class="type">Contract</span>.waitNSlots <span class="number">10</span></span><br><span class="line">    tell [<span class="number">2</span>]</span><br><span class="line">    void $ <span class="type">Contract</span>.waitNSlots <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="title">myTrace4</span> :: <span class="type">EmulatorTrace</span> ()</span><br><span class="line"><span class="title">myTrace4</span> = <span class="keyword">do</span></span><br><span class="line">    h &lt;- activateContractWallet (<span class="type">Wallet</span> <span class="number">1</span>) myContract4</span><br><span class="line"></span><br><span class="line">    void $ <span class="type">Emulator</span>.waitNSlots <span class="number">5</span></span><br><span class="line">    <span class="comment">-- 通过observableState获取合同状态</span></span><br><span class="line">    xs &lt;- observableState h</span><br><span class="line">    <span class="comment">-- 输出当前合同状态</span></span><br><span class="line">    <span class="type">Extras</span>.logInfo $ show xs <span class="comment">-- ^ []</span></span><br><span class="line"></span><br><span class="line">    void $ <span class="type">Emulator</span>.waitNSlots <span class="number">10</span></span><br><span class="line">    ys &lt;- observableState h</span><br><span class="line">    <span class="type">Extras</span>.logInfo $ show ys <span class="comment">-- ^ [1]</span></span><br><span class="line"></span><br><span class="line">    void $ <span class="type">Emulator</span>.waitNSlots <span class="number">10</span></span><br><span class="line">    zs &lt;- observableState h</span><br><span class="line">    <span class="type">Extras</span>.logInfo $ show zs <span class="comment">-- ^ [1, 2]</span></span><br><span class="line"></span><br><span class="line"><span class="title">test4</span> :: <span class="type">IO</span> ()</span><br><span class="line"><span class="title">test4</span> = runEmulatorTraceIO myTrace4</span><br></pre></td></tr></table></figure>
<h3 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h3><blockquote>
<p>Trace逻辑: 通过<code>Wallet 1</code>调用<code>pay</code>端点两次，每次都以<code>Wallet 2</code>作为收件人，但金额由这两个参数给定。在每个端点调用之后，应该有一个<code>slot</code>的延迟。</p>
</blockquote>
<p>打开<code>~/haskell/plutus-pioneer-program/code/week04/src/Week04/Homework.hs</code>文件:</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">PayParams</span> = <span class="type">PayParams</span></span></span><br><span class="line">    &#123; ppRecipient :: <span class="type">PubKeyHash</span></span><br><span class="line">    , ppLovelace  :: <span class="type">Integer</span></span><br><span class="line">    &#125; <span class="keyword">deriving</span> (<span class="type">Show</span>, <span class="type">Generic</span>, <span class="type">FromJSON</span>, <span class="type">ToJSON</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="type">PaySchema</span> = <span class="type">BlockchainActions</span> .\/ <span class="type">Endpoint</span> "pay" <span class="type">PayParams</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- mustPayToPubKey 使用公钥锁定值</span></span><br><span class="line"><span class="comment">-- lovelaceValueOf :: Integer -&gt; Value</span></span><br><span class="line"><span class="title">payContract</span> :: <span class="type">Contract</span> () <span class="type">PaySchema</span> <span class="type">Text</span> ()</span><br><span class="line"><span class="title">payContract</span> = forever $ <span class="keyword">do</span></span><br><span class="line">    pp &lt;- endpoint @<span class="string">"pay"</span></span><br><span class="line">    <span class="keyword">let</span> tx = mustPayToPubKey (ppRecipient pp) $ lovelaceValueOf $ ppLovelace pp</span><br><span class="line">    void $ submitTx tx</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 支持错误处理程序</span></span><br><span class="line"><span class="title">payContractHandle</span> :: <span class="type">Contract</span> () <span class="type">PaySchema</span> <span class="type">Text</span> ()</span><br><span class="line"><span class="title">payContractHandle</span> = forever $ <span class="keyword">do</span></span><br><span class="line">    pp &lt;- endpoint @<span class="string">"pay"</span></span><br><span class="line">    <span class="keyword">let</span> tx = mustPayToPubKey (ppRecipient pp) $ lovelaceValueOf $ ppLovelace pp</span><br><span class="line">        errorHandler = \t -&gt; <span class="type">Contract</span>.logInfo @<span class="type">Text</span> (<span class="string">"Error submiting the trasaction!: "</span> &lt;&gt; t)</span><br><span class="line">    <span class="comment">-- 注意，错误必须在合同内处理！否则，错误只检测一次.</span></span><br><span class="line">    errorHandler `handleError` void (submitTx tx)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- A trace that invokes the pay endpoint of payContract on Wallet 1 twice, each time with Wallet 2 as</span></span><br><span class="line"><span class="comment">-- recipient, but with amounts given by the two arguments. There should be a delay of one slot</span></span><br><span class="line"><span class="comment">-- after each endpoint call.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 修改payTrace，使其接受合同参数，以便使合同的两个版本都受支持(有和没有错误处理程序)</span></span><br><span class="line"><span class="title">payTrace</span> :: <span class="type">Contract</span> () <span class="type">PaySchema</span> <span class="type">Text</span> () -&gt; <span class="type">Integer</span> -&gt; <span class="type">Integer</span> -&gt; <span class="type">EmulatorTrace</span> ()</span><br><span class="line"><span class="title">payTrace</span> c x y = <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">let</span> w2 = <span class="type">Wallet</span> <span class="number">2</span></span><br><span class="line">        recipient = pubKeyHash $ walletPubKey w2</span><br><span class="line">        p1 = <span class="type">PayParams</span> recipient x</span><br><span class="line">        p2 = <span class="type">PayParams</span> recipient y</span><br><span class="line">    <span class="comment">-- 开启合同新实例</span></span><br><span class="line">    h1 &lt;- <span class="type">Wallet</span> <span class="number">1</span> `activateContractWallet` c</span><br><span class="line">    <span class="comment">-- 使用钱包1调用pay端点，并将钱包2作为参数传入</span></span><br><span class="line">    callEndpoint @<span class="string">"pay"</span> h1 p1</span><br><span class="line">    <span class="comment">-- 等待1个slot时间</span></span><br><span class="line">    void $ <span class="type">Emulator</span>.waitNSlots <span class="number">1</span></span><br><span class="line">     <span class="comment">-- 再次使用钱包1调用pay端点，并将钱包2作为参数传入</span></span><br><span class="line">    callEndpoint @<span class="string">"pay"</span> h1 p2</span><br><span class="line">    <span class="comment">-- 等待1个slot时间</span></span><br><span class="line">    void $ <span class="type">Emulator</span>.waitNSlots <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="title">payTest1</span> :: <span class="type">IO</span> ()</span><br><span class="line"><span class="title">payTest1</span> = runEmulatorTraceIO $ payTrace payContract <span class="number">1000000</span> <span class="number">2000000</span></span><br><span class="line"></span><br><span class="line"><span class="title">payTest2</span> :: <span class="type">IO</span> ()</span><br><span class="line"><span class="title">payTest2</span> = runEmulatorTraceIO $ payTrace payContractHandle <span class="number">1000000000</span> <span class="number">2000000</span></span><br></pre></td></tr></table></figure>
        
            <div class="donate-container">
    <div class="donate-button">
        <button id="donate-button">赞赏</button>
    </div>
    <div class="donate-img-container hide" id="donate-img-container">
        <img id="donate-img" src="" data-src="/blog/img/pay.png">
        <p> thank you </p>
    </div>
</div>
        
        <div id="comment-container">
        </div>
    </div>
</div>
    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <span>/</span>
        
        <span><a href="https://medium.com/netflix-techblog">Netflix</a></span>
        <span>/</span>
        
        <span><a href="https://engineering.linkedin.com/blog">Linkedin</a></span>
        <span>/</span>
        
        <span><a href="https://blogs.dropbox.com/tech/">Dropbox</a></span>
        <span>/</span>
        
        <span><a href="https://code.fb.com/">Facebook</a></span>
        <span>/</span>
        
        <span><a href="https://www.fpcomplete.com/blog">FPComplete</a></span>
        <span>/</span>
        
        <span><a href="https://blog.janestreet.com/">JaneStreet</a></span>
        <span>/</span>
        
        <span><a href="https://github.com/limengyu1990/">Github</a></span>
        <span>/</span>
        
        <span><a href="https://serokell.io/blog">serokell</a></span>
        <span>/</span>
        
        <span><a href="https://iohk.io/en/blog">IOHK</a></span>
        <span>/</span>
        
    </p>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/blog/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/blog/js/index.js"></script>

<!--create by tea9-->

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
    <script>
        var gitalk = new Gitalk({
          clientID: '7cfc73dd62b57f07ed83',
          clientSecret: 'dd03b7e54aadf0d81e4c9c93e23a41272bcfcfa1',
          repo: 'blog',
          owner: 'limengyu1990',
          admin: 'limengyu1990',
          id: location.pathname,      // Ensure uniqueness and length less than 50
          distractionFreeMode: false  // Facebook-like distraction free mode
        })
        gitalk.render('comment-container')
    </script>

<!--end-->


</html>
