<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/blog/img/favicon.ico">

    <title>
        
        Plutus-Pioneer-lesson-03 - undefined
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/blog/css/aircloud.css">
    <link rel="stylesheet" href="/blog/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> 所有的善恶都是我，良心一路走来依旧清澈鲜活... </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar">
            <img src="/blog/img/photo.png" />
        </div>
        <div class="name">
            <i>不负如来不负卿</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/blog/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/blog/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/blog/archive">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/blog/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备工作"><span class="toc-text">准备工作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#切换Plutus项目到特定commit-id"><span class="toc-text">切换Plutus项目到特定commit id</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Plutus一些变更"><span class="toc-text">Plutus一些变更</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#类型详情"><span class="toc-text">类型详情</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ScriptContext"><span class="toc-text">ScriptContext</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SlotRange"><span class="toc-text">SlotRange</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Interval间隔"><span class="toc-text">Interval间隔</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#构造-Interval"><span class="toc-text">构造 Interval</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#校验-Interval"><span class="toc-text">校验 Interval</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#测试-Interval"><span class="toc-text">测试 Interval</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#课程"><span class="toc-text">课程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Vesting源码解读"><span class="toc-text">Vesting源码解读</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Parameterized"><span class="toc-text">Parameterized</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#作业"><span class="toc-text">作业</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#作业1"><span class="toc-text">作业1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#作业2"><span class="toc-text">作业2</span></a></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>
        <div class="index-about-mobile">
            <i> 所有的善恶都是我，良心一路走来依旧清澈鲜活... </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        Plutus-Pioneer-lesson-03
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2021-04-20 13:52:41</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/blog/tags/#Haskell" title="Haskell">Haskell</a>
        <span>/</span>
        
        <a class="tag" href="/blog/tags/#Plutus" title="Plutus">Plutus</a>
        <span>/</span>
        
        <a class="tag" href="/blog/tags/#DApps" title="DApps">DApps</a>
        <span>/</span>
        
        <a class="tag" href="/blog/tags/#智能合约" title="智能合约">智能合约</a>
        <span>/</span>
        
        <a class="tag" href="/blog/tags/#Cardano" title="Cardano">Cardano</a>
        <span>/</span>
        
        <a class="tag" href="/blog/tags/#Pioneer" title="Pioneer">Pioneer</a>
        <span>/</span>
        
        <a class="tag" href="/blog/tags/#Datum" title="Datum">Datum</a>
        <span>/</span>
        
        <a class="tag" href="/blog/tags/#Validation Context" title="Validation Context">Validation Context</a>
        <span>/</span>
        
        <a class="tag" href="/blog/tags/#Parameterized Contracts" title="Parameterized Contracts">Parameterized Contracts</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><h3 id="切换Plutus项目到特定commit-id"><a href="#切换Plutus项目到特定commit-id" class="headerlink" title="切换Plutus项目到特定commit id"></a>切换Plutus项目到特定commit id</h3><p>前两节课使用的<code>commit id</code>是<code>3746610e53654a1167aeb4c6294c6096d16b0502</code>(<code>week02/cabal.project</code>).</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 查看commit id(3aa86304e9bfc425667051a8a94db73fcdc38878)</span><br><span class="line">head -30 ~/haskell/plutus-pioneer-program/code/week03/cabal.project</span><br><span class="line">output: 3aa86304e9bfc425667051a8a94db73fcdc38878</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 检出commit id</span><br><span class="line">cd ～/haskell/plutus</span><br><span class="line">git checkout 3aa86304e9bfc425667051a8a94db73fcdc38878</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 启动nix-shell</span><br><span class="line">nix-shell</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 进入到教程目录</span><br><span class="line">cd ~/haskell/plutus-pioneer-program/code/week03/</span><br></pre></td></tr></table></figure>
<h3 id="Plutus一些变更"><a href="#Plutus一些变更" class="headerlink" title="Plutus一些变更"></a>Plutus一些变更</h3><table>
<thead>
<tr>
<th>旧的类型</th>
<th>新的类型</th>
</tr>
</thead>
<tbody>
<tr>
<td>ValidatorCtx</td>
<td>ScriptContext</td>
</tr>
<tr>
<td>valCtxTxInfo</td>
<td>scriptContextTxInfo</td>
</tr>
<tr>
<td>txInInfoWitness</td>
<td>(txOutDatumHash . txInInfoResolved)</td>
</tr>
<tr>
<td>txInInfoValue</td>
<td>(txOutValue . txInInfoResolved)</td>
</tr>
<tr>
<td>TxOutInfo</td>
<td>TxOut</td>
</tr>
<tr>
<td>txOutType</td>
<td>txOutDatumHash</td>
</tr>
<tr>
<td>PayToPubKey</td>
<td>Nothing</td>
</tr>
<tr>
<td>PayToScript</td>
<td>Just</td>
</tr>
<tr>
<td>PubKeyAddress</td>
<td>pubKeyHashAddress</td>
</tr>
<tr>
<td>ScriptAddress</td>
<td>scriptHashAddress</td>
</tr>
</tbody>
</table>
<p>例如, <code>Week02/IsData.hs</code>文件的第37-39行:<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#123;-# INLINABLE mkValidator #-&#125;</span></span><br><span class="line"><span class="title">mkValidator</span> :: () </span><br><span class="line">                -&gt; <span class="type">MySillyRedeemer</span> </span><br><span class="line">                <span class="comment">-- 旧的 ValidatorCtx</span></span><br><span class="line">                -&gt; <span class="type">ValidatorCtx</span> </span><br><span class="line">                -&gt; <span class="type">Bool</span></span><br><span class="line"><span class="title">mkValidator</span> () (<span class="type">MySillyRedeemer</span> r) _ = </span><br><span class="line">        traceIfFalse <span class="string">"wrong redeemer"</span> $ r == <span class="number">42</span></span><br></pre></td></tr></table></figure></p>
<p>现在变更为了:<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#123;-# INLINABLE mkValidator #-&#125;</span></span><br><span class="line"><span class="title">mkValidator</span> :: () </span><br><span class="line">                -&gt; <span class="type">MySillyRedeemer</span></span><br><span class="line">                <span class="comment">-- 新的 ScriptContext</span></span><br><span class="line">                -&gt; <span class="type">ScriptContext</span> </span><br><span class="line">                -&gt; <span class="type">Bool</span></span><br><span class="line"><span class="title">mkValidator</span> () (<span class="type">MySillyRedeemer</span> r) _ = traceIfFalse <span class="string">"wrong redeemer"</span> $ r == <span class="number">42</span></span><br></pre></td></tr></table></figure></p>
<p>另外<code>Week02/IsData.hs</code>文件的第53-60行:<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">validator</span> :: <span class="type">Validator</span></span><br><span class="line"><span class="title">validator</span> = <span class="type">Scripts</span>.validatorScript inst</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 去掉</span></span><br><span class="line"><span class="title">valHash</span> :: <span class="type">Ledger</span>.<span class="type">ValidatorHash</span></span><br><span class="line"><span class="title">valHash</span> = <span class="type">Scripts</span>.validatorHash validator</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 去掉</span></span><br><span class="line"><span class="title">scrAddress</span> :: <span class="type">Ledger</span>.<span class="type">Address</span></span><br><span class="line"><span class="title">scrAddress</span> = <span class="type">ScriptAddress</span> valHash</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 增加</span></span><br><span class="line"><span class="title">scrAddress</span> :: <span class="type">Ledger</span>.<span class="type">Address</span></span><br><span class="line"><span class="comment">-- 注意: 小写的 scriptAddress</span></span><br><span class="line"><span class="title">scrAddress</span> = scriptAddress validator</span><br></pre></td></tr></table></figure></p>
<p>现在可以不用自己使用<code>valHash</code>创建脚本哈希，然后使用<code>scrAddress</code>生成脚本地址，只需要使用上面更改后的<code>scrAddress</code>函数代替即可.</p>
<h2 id="类型详情"><a href="#类型详情" class="headerlink" title="类型详情"></a>类型详情</h2><p>本小节将会查看源代码，来了解一些常用类型的使用.</p>
<h3 id="ScriptContext"><a href="#ScriptContext" class="headerlink" title="ScriptContext"></a><a href="https://github.com/input-output-hk/plutus/blob/master/plutus-ledger-api/src/Plutus/V1/Ledger/Contexts.hs" target="_blank" rel="noopener">ScriptContext</a></h3><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ScriptContext定义</span></span><br><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">ScriptContext</span> = <span class="type">ScriptContext</span>&#123;</span></span><br><span class="line"><span class="class">    <span class="title">scriptContextTxInfo</span> :: <span class="type">TxInfo</span>,</span></span><br><span class="line"><span class="class">    <span class="title">scriptContextPurpose</span> :: <span class="type">ScriptPurpose</span></span></span><br><span class="line"><span class="class">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- | 待处理交易的输入</span></span><br><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">TxInInfo</span> = <span class="type">TxInInfo</span></span></span><br><span class="line">    &#123; txInInfoOutRef   :: <span class="type">TxOutRef</span></span><br><span class="line">    , txInInfoResolved :: <span class="type">TxOut</span></span><br><span class="line">    &#125; <span class="keyword">deriving</span> (<span class="type">Generic</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- | 当前正在运行的脚本的目的</span></span><br><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">ScriptPurpose</span></span></span><br><span class="line">    = <span class="type">Minting</span> <span class="type">CurrencySymbol</span>        <span class="comment">-- ^ 铸造</span></span><br><span class="line">    | <span class="type">Spending</span> <span class="type">TxOutRef</span>             <span class="comment">-- ^ 花费</span></span><br><span class="line">    | <span class="type">Rewarding</span> <span class="type">StakingCredential</span>   <span class="comment">-- ^ 奖励</span></span><br><span class="line">    | <span class="type">Certifying</span> <span class="type">DCert</span>              <span class="comment">-- ^ 认证</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- | 待处理的交易。这是由验证程序脚本看到的视图，因此省略了一些详细信息。</span></span><br><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">TxInfo</span> = <span class="type">TxInfo</span></span></span><br><span class="line">    &#123; txInfoInputs      :: [<span class="type">TxInInfo</span>] <span class="comment">-- ^ 交易的输入信息</span></span><br><span class="line">    , txInfoInputsFees  :: [<span class="type">TxInInfo</span>] <span class="comment">-- ^ 指定支付费用的交易输入</span></span><br><span class="line">    , txInfoOutputs     :: [<span class="type">TxOut</span>] <span class="comment">-- ^ 交易的输出信息</span></span><br><span class="line">    , txInfoFee         :: <span class="type">Value</span> <span class="comment">-- ^ 这笔交易支付的费用</span></span><br><span class="line">    , txInfoForge       :: <span class="type">Value</span> <span class="comment">-- ^ 该交易铸造的'值'</span></span><br><span class="line">    , txInfoDCert       :: [<span class="type">DCert</span>] <span class="comment">-- ^ 此交易中包含的证书摘要</span></span><br><span class="line">    , txInfoWdrl        :: [(<span class="type">StakingCredential</span>, <span class="type">Integer</span>)] <span class="comment">-- ^ 提款</span></span><br><span class="line">    , txInfoValidRange  :: <span class="type">SlotRange</span> <span class="comment">-- ^ 交易的有效范围</span></span><br><span class="line">    , txInfoSignatories :: [<span class="type">PubKeyHash</span>] <span class="comment">-- ^ Signatures provided with the transaction, attested that they all signed the tx</span></span><br><span class="line">    , txInfoData        :: [(<span class="type">DatumHash</span>, <span class="type">Datum</span>)]</span><br><span class="line">    , txInfoId          :: <span class="type">TxId</span></span><br><span class="line">    <span class="comment">-- ^ 待处理交易的散列(不包括witnesses见证人)</span></span><br><span class="line">    &#125; <span class="keyword">deriving</span> (<span class="type">Generic</span>)</span><br></pre></td></tr></table></figure>
<p><code>txInfoSignatories</code>持有该合同交易中所有钱包的多个<code>PubKeyHashes</code>, 这对于检查每个人是否都是他们所说的人很重要。</p>
<p><code>txInfoValidRange</code>持有一个<code>SlotRange</code>，它定义了交易在什么时候有效，例如，你可能想要持有<code>ADA</code>直到某个特定的时间才可以<code>redeem</code>(赎回)，或者您可能希望使<code>redeeming</code>(赎回)的选项失效等.</p>
<h3 id="SlotRange"><a href="#SlotRange" class="headerlink" title="SlotRange"></a><a href="https://github.com/input-output-hk/plutus/blob/master/plutus-ledger-api/src/Plutus/V1/Ledger/Slot.hs" target="_blank" rel="noopener">SlotRange</a></h3><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- | slot范围</span></span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="type">SlotRange</span> = <span class="type">Interval</span> <span class="type">Slot</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- | Slot本质上是个数字</span></span><br><span class="line"><span class="comment">-- | 这是一个很好的时间代理，因为在Cardano区块链上，slot以恒定的速率走过</span></span><br><span class="line"><span class="class"><span class="keyword">newtype</span> <span class="type">Slot</span> = <span class="type">Slot</span> &#123; <span class="title">getSlot</span> :: <span class="type">Integer</span> &#125;</span></span><br></pre></td></tr></table></figure>
<p><code>SlotRange</code>实际上是<code>Interval Slot</code>的别名.</p>
<h3 id="Interval间隔"><a href="#Interval间隔" class="headerlink" title="Interval间隔"></a><a href="https://github.com/input-output-hk/plutus/blob/master/plutus-ledger-api/src/Plutus/V1/Ledger/Interval.hs" target="_blank" rel="noopener">Interval间隔</a></h3><p><code>Interval</code>就是一个<code>Slot</code>的范围，从<code>From</code>到<code>To</code>:<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">Interval</span> a = <span class="type">Interval</span> &#123; </span></span><br><span class="line"><span class="class">        <span class="title">ivFrom</span> :: <span class="type">LowerBound</span> <span class="title">a</span>, </span></span><br><span class="line"><span class="class">        <span class="title">ivTo</span> :: <span class="type">UpperBound</span> <span class="title">a</span> </span></span><br><span class="line"><span class="class">    &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- | 一个Neg(负无穷大)和Pos(正无穷大)的集合</span></span><br><span class="line"><span class="comment">-- | Finite(有限的)</span></span><br><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">Extended</span> a = <span class="type">NegInf</span> | <span class="type">Finite</span> a | <span class="type">PosInf</span></span></span><br></pre></td></tr></table></figure></p>
<p><code>Interval</code>在任意一边都可以是无界的，<code>From</code>不一定是一个特定的<code>slot</code>，它也可能是时间的开始(<code>NegInf</code>)，尽管实际上这不会超过我们的<code>Genesis slot</code>(创世)，因为这是我们的起始<code>slot</code>; <code>To</code>也是一样，也可以分别定义为时间的结束(<code>PosInf</code>）</p>
<h4 id="构造-Interval"><a href="#构造-Interval" class="headerlink" title="构造 Interval"></a>构造 Interval</h4><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- `interval a b` 包括所有大于或等于a且小于b的值.</span></span><br><span class="line"><span class="comment">-- 因此，它包括a，但不包括b</span></span><br><span class="line"><span class="title">interval</span> :: a -&gt; a -&gt; <span class="type">Interval</span> a</span><br><span class="line"><span class="title">interval</span> s s' = <span class="type">Interval</span> (lowerBound s) (upperBound s')</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 只有一个从a到a的slot</span></span><br><span class="line"><span class="title">singleton</span> :: a -&gt; <span class="type">Interval</span> a</span><br><span class="line"><span class="title">singleton</span> s = interval s s</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 包含所有大于或等于a的值，所以从a到无穷大</span></span><br><span class="line"><span class="title">from</span> :: a -&gt; <span class="type">Interval</span> a</span><br><span class="line"><span class="title">from</span> s = <span class="type">Interval</span> (lowerBound s) (<span class="type">UpperBound</span> <span class="type">PosInf</span> <span class="type">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 包括所有小于a的值 </span></span><br><span class="line"><span class="title">to</span> :: a -&gt; <span class="type">Interval</span> a</span><br><span class="line"><span class="title">to</span> s = <span class="type">Interval</span> (<span class="type">LowerBound</span> <span class="type">NegInf</span> <span class="type">True</span>) (upperBound s)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- | 这是一个覆盖每个slot的Interval</span></span><br><span class="line"><span class="title">always</span> :: <span class="type">Interval</span> a</span><br><span class="line"><span class="title">always</span> = <span class="type">Interval</span> (<span class="type">LowerBound</span> <span class="type">NegInf</span> <span class="type">True</span>) (<span class="type">UpperBound</span> <span class="type">PosInf</span> <span class="type">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- | 一个空的间隔</span></span><br><span class="line"><span class="title">never</span> :: <span class="type">Interval</span> a</span><br><span class="line"><span class="title">never</span> = <span class="type">Interval</span> (<span class="type">LowerBound</span> <span class="type">PosInf</span> <span class="type">True</span>) (<span class="type">UpperBound</span> <span class="type">NegInf</span> <span class="type">True</span>)</span><br></pre></td></tr></table></figure>
<h4 id="校验-Interval"><a href="#校验-Interval" class="headerlink" title="校验 Interval"></a>校验 Interval</h4><p>上一小节我们了解到了如何创建<code>Interval</code>, 这一小节我们来看看如何校验<code>Interval</code>:</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- | 检查值a是否是在一个间隔内</span></span><br><span class="line"><span class="title">member</span> :: <span class="type">Ord</span> a =&gt; a -&gt; <span class="type">Interval</span> a -&gt; <span class="type">Bool</span></span><br><span class="line"><span class="title">member</span> a i = i `contains` singleton a</span><br><span class="line"></span><br><span class="line"><span class="comment">-- | 检查两个间隔是否重叠，即是否有一个值是两个间隔的成员</span></span><br><span class="line"><span class="title">overlaps</span> :: <span class="type">Ord</span> a =&gt; <span class="type">Interval</span> a -&gt; <span class="type">Interval</span> a -&gt; <span class="type">Bool</span></span><br><span class="line"><span class="title">overlaps</span> l r = isEmpty (l `intersection` r)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- | `intersection a b`: 包含在a和b(如果存在)中的最大间隔</span></span><br><span class="line"><span class="title">intersection</span> :: <span class="type">Ord</span> a =&gt; <span class="type">Interval</span> a -&gt; <span class="type">Interval</span> a -&gt; <span class="type">Interval</span> a</span><br><span class="line"><span class="title">intersection</span> (<span class="type">Interval</span> l1 h1) (<span class="type">Interval</span> l2 h2) = <span class="type">Interval</span> (max l1 l2) (min h1 h2)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- | `hull a b`: 包含a和b的最小间隔</span></span><br><span class="line"><span class="title">hull</span> :: <span class="type">Ord</span> a =&gt; <span class="type">Interval</span> a -&gt; <span class="type">Interval</span> a -&gt; <span class="type">Interval</span> a</span><br><span class="line"><span class="title">hull</span> (<span class="type">Interval</span> l1 h1) (<span class="type">Interval</span> l2 h2) = <span class="type">Interval</span> (min l1 l2) (max h1 h2)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- | 如果间隔b完全包含在a中，则@a `contains` b@为true.</span></span><br><span class="line"><span class="comment">-- | 也就是说，如果对于每个条目s，</span></span><br><span class="line"><span class="comment">-- | 如果`member s b`(s在b间隔内)，则`member s a`(s也一定在a间隔内)</span></span><br><span class="line"><span class="title">contains</span> :: <span class="type">Ord</span> a =&gt; <span class="type">Interval</span> a -&gt; <span class="type">Interval</span> a -&gt; <span class="type">Bool</span></span><br><span class="line"><span class="title">contains</span> (<span class="type">Interval</span> l1 h1) (<span class="type">Interval</span> l2 h2) = l1 &lt;= l2 &amp;&amp; h2 &lt;= h1</span><br><span class="line"></span><br><span class="line"><span class="comment">-- | 检查一个间隔是否是空的</span></span><br><span class="line"><span class="title">isEmpty</span> :: <span class="type">Ord</span> a =&gt; <span class="type">Interval</span> a -&gt; <span class="type">Bool</span></span><br><span class="line"><span class="title">isEmpty</span> (<span class="type">Interval</span> (<span class="type">LowerBound</span> v1 in1) (<span class="type">UpperBound</span> v2 in2)) = <span class="keyword">case</span> v1 `compare` v2 <span class="keyword">of</span></span><br><span class="line">    <span class="type">LT</span> -&gt; <span class="type">True</span></span><br><span class="line">    <span class="type">GT</span> -&gt; <span class="type">False</span></span><br><span class="line">    <span class="type">EQ</span> -&gt; not (in1 &amp;&amp; in2)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- | 检查值是否早于间隔的开端</span></span><br><span class="line"><span class="title">before</span> :: <span class="type">Ord</span> a =&gt; a -&gt; <span class="type">Interval</span> a -&gt; <span class="type">Bool</span></span><br><span class="line"><span class="title">before</span> h (<span class="type">Interval</span> f _) = lowerBound h &lt; f</span><br><span class="line"></span><br><span class="line"><span class="comment">-- | 检查值是否晚于间隔的结尾</span></span><br><span class="line"><span class="title">after</span> :: <span class="type">Ord</span> a =&gt; a -&gt; <span class="type">Interval</span> a -&gt; <span class="type">Bool</span></span><br><span class="line"><span class="title">after</span> h (<span class="type">Interval</span> _ t) = upperBound h &gt; t</span><br></pre></td></tr></table></figure>
<h4 id="测试-Interval"><a href="#测试-Interval" class="headerlink" title="测试 Interval"></a>测试 Interval</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 进入到课程03目录</span><br><span class="line">cd ~/haskell/plutus-pioneer-program/code/week03</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 启动repl</span><br><span class="line">cabal repl</span><br></pre></td></tr></table></figure>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">λ &gt; <span class="comment">-- 导入模块</span></span><br><span class="line">λ &gt; <span class="keyword">import</span> Plutus.V1.Ledger.Interval</span><br><span class="line">λ &gt; </span><br><span class="line">λ &gt; <span class="comment">-- Interval &#123;ivFrom = LowerBound (Finite 0) True, ivTo = UpperBound (Finite 10) True&#125;</span></span><br><span class="line">λ &gt; a = interval <span class="number">0</span> (<span class="number">10</span> :: <span class="type">Integer</span>)</span><br><span class="line">λ &gt; </span><br><span class="line">λ &gt; b = interval <span class="number">1</span> (<span class="number">5</span> :: <span class="type">Integer</span>)</span><br><span class="line">λ &gt; c = interval <span class="number">0</span> (<span class="number">11</span> :: <span class="type">Integer</span>)</span><br><span class="line">λ &gt;</span><br><span class="line">λ &gt; a `contains` b</span><br><span class="line"><span class="type">True</span></span><br><span class="line">λ &gt; a `contains` c</span><br><span class="line"><span class="type">False</span></span><br><span class="line">λ &gt; </span><br><span class="line">λ &gt; <span class="number">0</span> `member` a</span><br><span class="line"><span class="type">True</span></span><br><span class="line">λ &gt; </span><br><span class="line">λ &gt; <span class="number">11</span> `member` a</span><br><span class="line"><span class="type">False</span></span><br><span class="line">λ &gt; </span><br><span class="line">λ &gt; <span class="comment">-- Interval &#123;ivFrom = LowerBound (Finite 3) True, ivTo = UpperBound (Finite 3) True&#125;</span></span><br><span class="line">λ &gt; a1 = singleton (<span class="number">3</span> :: <span class="type">Integer</span>)</span><br><span class="line">λ &gt;</span><br><span class="line">λ &gt; <span class="number">10</span> `member` (interval <span class="number">0</span> (<span class="number">10</span> :: <span class="type">Integer</span>))</span><br><span class="line"><span class="type">True</span></span><br><span class="line">λ &gt;</span><br><span class="line">λ &gt; <span class="number">10</span> `member` (interval <span class="number">10</span> (<span class="number">11</span> :: <span class="type">Integer</span>))</span><br><span class="line"><span class="type">True</span></span><br><span class="line">λ &gt;</span><br><span class="line">λ &gt; intersection (interval <span class="number">9</span> (<span class="number">10</span> :: <span class="type">Integer</span>)) (interval <span class="number">10</span> (<span class="number">11</span> :: <span class="type">Integer</span>))</span><br><span class="line"><span class="type">Interval</span> &#123;ivFrom = <span class="type">LowerBound</span> (<span class="type">Finite</span> <span class="number">10</span>) <span class="type">True</span>, ivTo = <span class="type">UpperBound</span> (<span class="type">Finite</span> <span class="number">10</span>) <span class="type">True</span>&#125;</span><br><span class="line">λ &gt;</span><br><span class="line">λ &gt; overlaps (interval <span class="number">0</span> (<span class="number">10</span> :: <span class="type">Integer</span>)) (interval <span class="number">10</span> (<span class="number">11</span> :: <span class="type">Integer</span>))</span><br><span class="line"><span class="type">False</span></span><br><span class="line">λ &gt; </span><br><span class="line">λ &gt; isEmpty $ intersection (interval <span class="number">9</span> (<span class="number">10</span> :: <span class="type">Integer</span>)) (interval <span class="number">8</span> (<span class="number">11</span> :: <span class="type">Integer</span>))</span><br><span class="line"><span class="type">True</span></span><br><span class="line">λ &gt; </span><br><span class="line">λ &gt; isEmpty $ intersection (interval <span class="number">9</span> (<span class="number">10</span> :: <span class="type">Integer</span>)) (interval <span class="number">10</span> (<span class="number">11</span> :: <span class="type">Integer</span>))</span><br><span class="line"><span class="type">False</span></span><br><span class="line">λ &gt; </span><br><span class="line">λ &gt; intersection (interval <span class="number">0</span> (<span class="number">10</span> :: <span class="type">Integer</span>)) (interval <span class="number">8</span> (<span class="number">12</span> :: <span class="type">Integer</span>))</span><br><span class="line"><span class="type">Interval</span> &#123;ivFrom = <span class="type">LowerBound</span> (<span class="type">Finite</span> <span class="number">8</span>) <span class="type">True</span>, ivTo = <span class="type">UpperBound</span> (<span class="type">Finite</span> <span class="number">10</span>) <span class="type">True</span>&#125;</span><br><span class="line">λ &gt; </span><br><span class="line">λ &gt; intersection (interval <span class="number">9</span> (<span class="number">10</span> :: <span class="type">Integer</span>)) (interval <span class="number">8</span> (<span class="number">12</span> :: <span class="type">Integer</span>))</span><br><span class="line"><span class="type">Interval</span> &#123;ivFrom = <span class="type">LowerBound</span> (<span class="type">Finite</span> <span class="number">9</span>) <span class="type">True</span>, ivTo = <span class="type">UpperBound</span> (<span class="type">Finite</span> <span class="number">10</span>) <span class="type">True</span>&#125;</span><br><span class="line">λ &gt; </span><br><span class="line">λ &gt; hull (interval <span class="number">0</span> (<span class="number">10</span> :: <span class="type">Integer</span>)) (interval <span class="number">8</span> (<span class="number">12</span> :: <span class="type">Integer</span>))</span><br><span class="line"><span class="type">Interval</span> &#123;ivFrom = <span class="type">LowerBound</span> (<span class="type">Finite</span> <span class="number">0</span>) <span class="type">True</span>, ivTo = <span class="type">UpperBound</span> (<span class="type">Finite</span> <span class="number">12</span>) <span class="type">True</span>&#125;</span><br><span class="line">λ &gt; </span><br><span class="line">λ &gt; hull (interval <span class="number">9</span> (<span class="number">10</span> :: <span class="type">Integer</span>)) (interval <span class="number">8</span> (<span class="number">12</span> :: <span class="type">Integer</span>))</span><br><span class="line"><span class="type">Interval</span> &#123;ivFrom = <span class="type">LowerBound</span> (<span class="type">Finite</span> <span class="number">8</span>) <span class="type">True</span>, ivTo = <span class="type">UpperBound</span> (<span class="type">Finite</span> <span class="number">12</span>) <span class="type">True</span>&#125;</span><br><span class="line">λ &gt; </span><br><span class="line">λ &gt; from (<span class="number">5</span> :: <span class="type">Integer</span>)</span><br><span class="line"><span class="type">Interval</span> &#123;ivFrom = <span class="type">LowerBound</span> (<span class="type">Finite</span> <span class="number">5</span>) <span class="type">True</span>, ivTo = <span class="type">UpperBound</span> <span class="type">PosInf</span> <span class="type">True</span>&#125;</span><br><span class="line">λ &gt; </span><br><span class="line">λ &gt; to (<span class="number">5</span> :: <span class="type">Integer</span>)</span><br><span class="line"><span class="type">Interval</span> &#123;ivFrom = <span class="type">LowerBound</span> <span class="type">NegInf</span> <span class="type">True</span>, ivTo = <span class="type">UpperBound</span> (<span class="type">Finite</span> <span class="number">5</span>) <span class="type">True</span>&#125;</span><br><span class="line">λ &gt; </span><br><span class="line">λ &gt; from $ <span class="number">1</span> + <span class="type">Slot</span> <span class="number">4</span></span><br><span class="line"><span class="type">Interval</span> &#123;ivFrom = <span class="type">LowerBound</span> (<span class="type">Finite</span> (<span class="type">Slot</span> &#123;getSlot = <span class="number">5</span>&#125;)) <span class="type">True</span>, ivTo = <span class="type">UpperBound</span> <span class="type">PosInf</span> <span class="type">True</span>&#125;</span><br><span class="line">λ &gt;</span><br></pre></td></tr></table></figure>
<h2 id="课程"><a href="#课程" class="headerlink" title="课程"></a>课程</h2><blockquote>
<p>课程合同的内容是: 允许钱包发送<code>ada</code>，然后该<code>ada</code>将被存储，只能在特定的时间(<code>slot</code>)之后并且只能由特定的钱包来抓取.<br>从第3周开始游乐场增加了10个<code>lovelaces</code>的交易费用.</p>
</blockquote>
<p>通过游乐场打开<br><code>plutus-pioneer-program/code/week03/Vesting.hs</code>文件.</p>
<p>我们设置初始余额为1000个<code>lovelaces</code>:</p>
<p><img src="Plutus-Pioneer-lesson-03/01.png" alt=""></p>
<p>然后设置以下<code>action</code>序列:</p>
<p><img src="Plutus-Pioneer-lesson-03/02.png" alt=""></p>
<p><code>getPubKeyHash</code>字段的值我们没有设置(钱包2的公钥哈希值)，我们可以通过两个方法获取到该值:</p>
<ul>
<li><p>将<code>getPubKeyHash</code>字段的值留空，然后执行’评估’操作，就可以在<code>genesis slot (0)</code>处，看到两个钱包的<code>pubkeyhash</code>:<br><img src="Plutus-Pioneer-lesson-03/03.png" alt=""></p>
</li>
<li><p>使用<code>repl</code>命令行</p>
</li>
</ul>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">λ &gt; <span class="comment">-- 导入模块</span></span><br><span class="line">λ &gt; <span class="keyword">import</span> Wallet.Emulator</span><br><span class="line">λ &gt; <span class="keyword">import</span> Ledger</span><br><span class="line">λ &gt;</span><br><span class="line">λ &gt; <span class="comment">-- 接收一个钱包参数，返回其公钥</span></span><br><span class="line">λ &gt; :t walletPubKey</span><br><span class="line">λ &gt; walletPubKey :: <span class="type">Wallet</span> -&gt; <span class="type">PubKey</span></span><br><span class="line">λ &gt;</span><br><span class="line">λ &gt; <span class="comment">-- 基于钱包公钥，生成hash</span></span><br><span class="line">λ &gt; :t pubKeyHash</span><br><span class="line">λ &gt; pubKeyHash :: <span class="type">PubKey</span> -&gt; <span class="type">PubKeyHash</span></span><br><span class="line">λ &gt; </span><br><span class="line">λ &gt; <span class="comment">-- 获取钱包2的公钥哈希值</span></span><br><span class="line">λ &gt; pubKeyHash $ walletPubKey $ <span class="type">Wallet</span> <span class="number">2</span></span><br><span class="line"><span class="number">39</span>f713d0a644253f04529421b9f51b9b08979d08295959c4f3990ee617f5139f</span><br><span class="line">λ &gt;</span><br></pre></td></tr></table></figure>
<p>得到钱包2的公钥哈希后，将它填入到<code>getPubKeyHash</code>字段，重新评估就可以了.</p>
<ul>
<li><code>genesis slot (slot 0)</code> 将会分别给两个钱包1000个初始<code>lovelaces</code> </li>
<li><code>Slot 1</code> 放置100个<code>lovelace</code>由钱包2抓取(指定的10个<code>slot</code>通过后)</li>
</ul>
<p>费用: 10个<code>lovelaces</code>.</p>
<p>目前钱包1剩下:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1000 - 费用 10 - vesting 100 = 890个lovelaces</span><br></pre></td></tr></table></figure></p>
<p>目前脚本有: 100个<code>lovelaces</code>:</p>
<p><img src="Plutus-Pioneer-lesson-03/04.png" alt=""></p>
<p>等待10个<code>slot</code>后，钱包2将会抓取到100个<code>lovelaces</code>:</p>
<p><img src="Plutus-Pioneer-lesson-03/05.png" alt=""></p>
<p>可以看到，抓取操作也支付了10个<code>lovelaces</code>费用，钱包2最终得到90个<code>lovelaces</code>.</p>
<h3 id="Vesting源码解读"><a href="#Vesting源码解读" class="headerlink" title="Vesting源码解读"></a>Vesting源码解读</h3><p>玩耍过该合同后，我们来看下它的源代码,<br>查看<code>~/haskell/plutus-pioneer-program/code/week03/Vesting.hs</code>文件:</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">-- Datum数据</span></span><br><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">VestingDatum</span> = <span class="type">VestingDatum</span></span></span><br><span class="line">    &#123; beneficiary :: <span class="type">PubKeyHash</span> <span class="comment">-- ^ 受益人的公钥hash，在我们例子中是: 钱包2</span></span><br><span class="line">    , deadline    :: <span class="type">Slot</span> <span class="comment">-- 截止时间，在我们例子中是: slot 10</span></span><br><span class="line">    &#125; <span class="keyword">deriving</span> <span class="type">Show</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 验证器</span></span><br><span class="line"><span class="title">mkValidator</span> :: <span class="type">VestingDatum</span> -&gt; () -&gt; <span class="type">ScriptContext</span> -&gt; <span class="type">Bool</span></span><br><span class="line"><span class="title">mkValidator</span> dat () ctx =</span><br><span class="line">    traceIfFalse <span class="string">"beneficiary's signature missing"</span> checkSig &amp;&amp;</span><br><span class="line">    traceIfFalse <span class="string">"deadline not reached"</span>            checkDeadline</span><br><span class="line"><span class="title">where</span></span><br><span class="line">    <span class="comment">-- 从上下文中获取交易信息</span></span><br><span class="line">    info :: <span class="type">TxInfo</span></span><br><span class="line">    info = scriptContextTxInfo ctx</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 检查受益人的签名是否在交易的公钥哈希列表中存在</span></span><br><span class="line">    checkSig :: <span class="type">Bool</span></span><br><span class="line">    checkSig = beneficiary dat `elem` txInfoSignatories info</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 检查截止时间(包含所有大于等于截止时间的值)</span></span><br><span class="line">    <span class="comment">-- 是否完全包含`txInfoValidRange`(交易的有效范围)</span></span><br><span class="line">    checkDeadline :: <span class="type">Bool</span></span><br><span class="line">    checkDeadline = from (deadline dat) `contains` txInfoValidRange info</span><br></pre></td></tr></table></figure>
<h3 id="Parameterized"><a href="#Parameterized" class="headerlink" title="Parameterized"></a>Parameterized</h3><p>查看<code>~/haskell/plutus-pioneer-program/code/week03/Parameterized.hs</code>文件, 该文件与上一小节的<code>Vesting.hs</code>文件基本上一样，唯一区别是我们不再使用<code>VestingDatum</code>类来持有我们的受益人和截止日期字段，而是使用一个额外的参数来调用我们的<code>validator</code>(验证器)，在本例中是使用<code>VestingParam</code>. 它包含与<code>VestingDatum</code>相同的数据，只是现在通过参数化它，得到了一个关键的区别.</p>
<p>如果没有参数化功能，这个智能合约就只有一个实例，现在，我们可以很容易地拥有同一个合约的多个实例，这些实例只是具有不同的参数(<code>VestingParam</code>).</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- VestingParam 定义</span></span><br><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">VestingParam</span> = <span class="type">VestingParam</span></span></span><br><span class="line">    &#123; beneficiary :: <span class="type">PubKeyHash</span></span><br><span class="line">    , deadline    :: <span class="type">Slot</span></span><br><span class="line">    &#125; <span class="keyword">deriving</span> <span class="type">Show</span></span><br><span class="line"></span><br><span class="line"><span class="type">PlutusTx</span>.unstableMakeIsData ''<span class="type">VestingParam</span></span><br><span class="line"><span class="comment">-- 使VestingParam实现lift</span></span><br><span class="line"><span class="type">PlutusTx</span>.makeLift ''<span class="type">VestingParam</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 新增了一个VestingParam参数</span></span><br><span class="line"><span class="title">mkValidator</span> :: <span class="type">VestingParam</span> -&gt; () -&gt; () -&gt; <span class="type">ScriptContext</span> -&gt; <span class="type">Bool</span></span><br><span class="line"><span class="title">mkValidator</span> = ... <span class="comment">-- 和之前的代码一致</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 样板代码</span></span><br><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">Vesting</span></span></span><br><span class="line"><span class="class"><span class="keyword">instance</span> <span class="type">Scripts</span>.<span class="type">ScriptType</span> <span class="type">Vesting</span> <span class="keyword">where</span></span></span><br><span class="line">    <span class="comment">-- 将Datum 设置为()单元类型</span></span><br><span class="line">    <span class="class"><span class="keyword">type</span> instance <span class="type">DatumType</span> <span class="type">Vesting</span> = ()</span></span><br><span class="line">    <span class="class"><span class="keyword">type</span> instance <span class="type">RedeemerType</span> <span class="type">Vesting</span> = ()</span></span><br><span class="line"></span><br><span class="line"><span class="title">inst</span> :: <span class="type">VestingParam</span> -&gt; <span class="type">Scripts</span>.<span class="type">ScriptInstance</span> <span class="type">Vesting</span></span><br><span class="line"><span class="title">inst</span> p = <span class="type">Scripts</span>.validator @<span class="type">Vesting</span></span><br><span class="line">    <span class="comment">-- 重要变化在这里</span></span><br><span class="line">    ($$(<span class="type">PlutusTx</span>.compile [|| mkValidator ||]) `<span class="type">PlutusTx</span>.applyCode` <span class="type">PlutusTx</span>.liftCode p)</span><br><span class="line">    $$(<span class="type">PlutusTx</span>.compile [|| wrap ||])</span><br><span class="line">  <span class="keyword">where</span></span><br><span class="line">    <span class="comment">-- 将Datum 设置为()单元类型</span></span><br><span class="line">    wrap = <span class="type">Scripts</span>.wrapValidator @() @()</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 接收了 VestingParam 参数</span></span><br><span class="line"><span class="title">validator</span> :: <span class="type">VestingParam</span> -&gt; <span class="type">Validator</span></span><br><span class="line"><span class="title">validator</span> = <span class="type">Scripts</span>.validatorScript . inst</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 接收了 VestingParam 参数</span></span><br><span class="line"><span class="title">scrAddress</span> :: <span class="type">VestingParam</span> -&gt; <span class="type">Ledger</span>.<span class="type">Address</span></span><br><span class="line"><span class="title">scrAddress</span> = scriptAddress . validator</span><br></pre></td></tr></table></figure>
<p><code>PlutusTx.compile</code>函数是一个以<code>Haskell</code>代码为参数的函数，您可以使用<code>quote</code>(引用)将其提供给它，如果没有<code>quote</code>，<code>GHC</code>将尝试处理/编译<code>mkValidator</code>而不是将<code>Haskell</code>代码原样传递给<code>compile</code>函数.</p>
<p>在<code>PlutusTx.compile [|| mkValidator ||]</code>中<code>mkValidator</code>将会被转换成<code>Plutus</code>代码，这是<code>Plutus</code>已编译的代码，然而<code>validator</code>是一个期待额外参数(<code>VestingParam</code>)的函数，但是<code>VestingParam</code>是<code>Haskell</code>代码，而我们已编译的函数是<code>Plutus</code>已编译代码，因此，我们使用<code>liftCode</code>来提升/转换/序列化，以便<code>Plutus</code>已编译代码可以理解/处理参数。</p>
<p>现在我们有了一个编译成<code>Plutus</code>代码的函数(<code>validator</code>)，然后使用<code>PlutusTx.liftCode</code>将<code>VestingParam</code>参数提升到它的<code>Plutus</code>表示形式，最后我们只需要使用<code>PlutusTx.applyCode</code>函数将这个参数应用到函数。</p>
<p>当编译器处理这个过程时，<code>splice</code>(拼接)的结果将是<code>Plutus</code>代码，但将其编码/表示/序列化为<code>Haskell</code>代码/数据，以供<code>validator</code>函数获取。</p>
<h2 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h2><h3 id="作业1"><a href="#作业1" class="headerlink" title="作业1"></a>作业1</h3><blockquote>
<p>这应该验证受益人1是否已经签署了交易并且当前<code>slot</code>是在截止日期之前或截止日期时，或者受益人2是否已经签署了交易并且截止日期已经过去。</p>
</blockquote>
<ul>
<li>受益人1 -&gt; 在这种情况下为钱包2，在截止日期过去之前，我们发送ada的钱包来赎回.</li>
<li>受益人2 -&gt; 在这种情况下为钱包1，发送ada的钱包，如果在截止日期之前没有取回，我们想取回我们的ada(否则将在本合同中永远丢失）</li>
</ul>
<p>打开<code>~/haskell/plutus-pioneer-program/code/week03/Homework1.hs</code>文件:</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">VestingDatum</span> = <span class="type">VestingDatum</span></span></span><br><span class="line">    &#123; beneficiary1 :: <span class="type">PubKeyHash</span> <span class="comment">-- ^ 受益人1</span></span><br><span class="line">    , beneficiary2 :: <span class="type">PubKeyHash</span> <span class="comment">-- ^ 受益人2</span></span><br><span class="line">    , deadline     :: <span class="type">Slot</span>       <span class="comment">-- ^ 截止日期</span></span><br><span class="line">    &#125; <span class="keyword">deriving</span> <span class="type">Show</span></span><br><span class="line"></span><br><span class="line"><span class="title">mkValidator</span> :: <span class="type">VestingDatum</span> -&gt; () -&gt; <span class="type">ScriptContext</span> -&gt; <span class="type">Bool</span></span><br><span class="line"><span class="comment">-- mkValidator _ _ _ = False -- FIX ME!</span></span><br><span class="line"><span class="title">mkValidator</span> dat () ctx</span><br><span class="line">    <span class="comment">-- to获取所有小于(截止日期)的值</span></span><br><span class="line">    <span class="comment">-- 我们希望能在(截止日期)前抓取到资金</span></span><br><span class="line">    | (beneficiary1 dat `elem` sigs) &amp;&amp; (to (deadline dat) `contains` range) = <span class="type">True</span></span><br><span class="line">    <span class="comment">-- from获取所有大于等于(1 + deadline dat)的值</span></span><br><span class="line">    <span class="comment">-- 截止日期已经过去</span></span><br><span class="line">    | (beneficiary2 dat `elem` sigs) &amp;&amp; (from (<span class="number">1</span> + deadline dat) `contains` range) = <span class="type">True</span></span><br><span class="line">    | otherwise = <span class="type">False</span></span><br><span class="line"><span class="title">where</span></span><br><span class="line">    <span class="comment">-- 获取交易信息</span></span><br><span class="line">    info :: <span class="type">TxInfo</span></span><br><span class="line">    info = scriptContextTxInfo ctx</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 获取签名信息</span></span><br><span class="line">    sigs :: [<span class="type">PubKeyHash</span>]</span><br><span class="line">    sigs = txInfoSignatories info</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 获取交易有效范围</span></span><br><span class="line">    range :: <span class="type">SlotRange</span></span><br><span class="line">    range = txInfoValidRange info</span><br></pre></td></tr></table></figure>
<h3 id="作业2"><a href="#作业2" class="headerlink" title="作业2"></a>作业2</h3><p>打开<code>~/shell/plutus-pioneer-program/code/week03/Homework2.hs</code>文件:</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 接收一个PubKeyHash参数和一个包含Slot的Datum参数</span></span><br><span class="line"><span class="title">mkValidator</span> :: <span class="type">PubKeyHash</span> -&gt; <span class="type">Slot</span> -&gt; () -&gt; <span class="type">ScriptContext</span> -&gt; <span class="type">Bool</span></span><br><span class="line"><span class="title">mkValidator</span> _ _ _ _ = <span class="type">False</span> <span class="comment">-- FIX ME!</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">Vesting</span></span></span><br><span class="line"><span class="class"><span class="keyword">instance</span> <span class="type">Scripts</span>.<span class="type">ScriptType</span> <span class="type">Vesting</span> <span class="keyword">where</span></span></span><br><span class="line">    <span class="comment">-- 设置Datum类型为Slot</span></span><br><span class="line">    <span class="class"><span class="keyword">type</span> instance <span class="type">DatumType</span> <span class="type">Vesting</span> = <span class="type">Slot</span></span></span><br><span class="line">    <span class="class"><span class="keyword">type</span> instance <span class="type">RedeemerType</span> <span class="type">Vesting</span> = ()</span></span><br><span class="line"></span><br><span class="line"><span class="title">inst</span> :: <span class="type">PubKeyHash</span> -&gt; <span class="type">Scripts</span>.<span class="type">ScriptInstance</span> <span class="type">Vesting</span></span><br><span class="line"><span class="title">inst</span> = undefined <span class="comment">-- IMPLEMENT ME!</span></span><br><span class="line"></span><br><span class="line"><span class="title">validator</span> :: <span class="type">PubKeyHash</span> -&gt; <span class="type">Validator</span></span><br><span class="line"><span class="title">validator</span> = undefined <span class="comment">-- IMPLEMENT ME!</span></span><br><span class="line"></span><br><span class="line"><span class="title">scrAddress</span> :: <span class="type">PubKeyHash</span> -&gt; <span class="type">Ledger</span>.<span class="type">Address</span></span><br><span class="line"><span class="title">scrAddress</span> = undefined <span class="comment">-- IMPLEMENT ME!</span></span><br></pre></td></tr></table></figure>
<p>我们必须用一个参数(<code>PubKeyHash</code>)和一个包含<code>Slot</code>的<code>Datum</code>参数来实现一个<code>validator</code>.</p>
<p>在<code>parameterized.hs</code>中，这两个值都位于<code>VestingParam</code>中，而现在它们都是单独的值，一个作为<code>parameter</code>，一个作为<code>Datum</code>.</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">mkValidator</span> :: <span class="type">PubKeyHash</span> -&gt; <span class="type">Slot</span> -&gt; () -&gt; <span class="type">ScriptContext</span> -&gt; <span class="type">Bool</span></span><br><span class="line"><span class="title">mkValidator</span> pkh s () ctx =</span><br><span class="line">    traceIfFalse <span class="string">"beneficiary's signature missing"</span> checkSig &amp;&amp;</span><br><span class="line">    traceIfFalse <span class="string">"deadline not reached"</span> checkDeadline</span><br><span class="line"><span class="title">where</span></span><br><span class="line">    info :: <span class="type">TxInfo</span></span><br><span class="line">    info = scriptContextTxInfo ctx</span><br><span class="line"></span><br><span class="line">    checkSig :: <span class="type">Bool</span></span><br><span class="line">    checkSig = pkh `elem` txInfoSignatories info</span><br><span class="line"></span><br><span class="line">    checkDeadline :: <span class="type">Bool</span></span><br><span class="line">    checkDeadline = from s `contains` txInfoValidRange info</span><br><span class="line"></span><br><span class="line"><span class="title">inst</span> :: <span class="type">PubKeyHash</span> -&gt; <span class="type">Scripts</span>.<span class="type">ScriptInstance</span> <span class="type">Vesting</span></span><br><span class="line"><span class="title">inst</span> p = <span class="type">Scripts</span>.validator @<span class="type">Vesting</span></span><br><span class="line">    ($$(<span class="type">PlutusTx</span>.compile [|| mkValidator ||]) `<span class="type">PlutusTx</span>.applyCode` <span class="type">PlutusTx</span>.liftCode p)</span><br><span class="line">    $$(<span class="type">PlutusTx</span>.compile [|| wrap ||])</span><br><span class="line"><span class="title">where</span></span><br><span class="line">    <span class="comment">-- 将 datum 设置为 @Slot</span></span><br><span class="line">    wrap = <span class="type">Scripts</span>.wrapValidator @<span class="type">Slot</span> @()</span><br><span class="line"></span><br><span class="line"><span class="title">validator</span> :: <span class="type">PubKeyHash</span> -&gt; <span class="type">Validator</span></span><br><span class="line"><span class="title">validator</span> = <span class="type">Scripts</span>.validatorScript . inst</span><br><span class="line"></span><br><span class="line"><span class="title">scrAddress</span> :: <span class="type">PubKeyHash</span> -&gt; <span class="type">Ledger</span>.<span class="type">Address</span></span><br><span class="line"><span class="title">scrAddress</span> = scriptAddress . validator</span><br></pre></td></tr></table></figure>

        
            <div class="donate-container">
    <div class="donate-button">
        <button id="donate-button">赞赏</button>
    </div>
    <div class="donate-img-container hide" id="donate-img-container">
        <img id="donate-img" src="" data-src="/blog/img/pay.png">
        <p> thank you </p>
    </div>
</div>
        
        <div id="comment-container">
        </div>
    </div>
</div>
    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <span>/</span>
        
        <span><a href="https://medium.com/netflix-techblog">Netflix</a></span>
        <span>/</span>
        
        <span><a href="https://engineering.linkedin.com/blog">Linkedin</a></span>
        <span>/</span>
        
        <span><a href="https://blogs.dropbox.com/tech/">Dropbox</a></span>
        <span>/</span>
        
        <span><a href="https://code.fb.com/">Facebook</a></span>
        <span>/</span>
        
        <span><a href="https://www.fpcomplete.com/blog">FPComplete</a></span>
        <span>/</span>
        
        <span><a href="https://blog.janestreet.com/">JaneStreet</a></span>
        <span>/</span>
        
        <span><a href="https://github.com/limengyu1990/">Github</a></span>
        <span>/</span>
        
        <span><a href="https://serokell.io/blog">serokell</a></span>
        <span>/</span>
        
        <span><a href="https://iohk.io/en/blog">IOHK</a></span>
        <span>/</span>
        
    </p>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/blog/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/blog/js/index.js"></script>

<!--create by tea9-->

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
    <script>
        var gitalk = new Gitalk({
          clientID: '7cfc73dd62b57f07ed83',
          clientSecret: 'dd03b7e54aadf0d81e4c9c93e23a41272bcfcfa1',
          repo: 'blog',
          owner: 'limengyu1990',
          admin: 'limengyu1990',
          id: location.pathname,      // Ensure uniqueness and length less than 50
          distractionFreeMode: false  // Facebook-like distraction free mode
        })
        gitalk.render('comment-container')
    </script>

<!--end-->


</html>
