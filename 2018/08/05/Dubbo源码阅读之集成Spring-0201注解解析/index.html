<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/blog/img/favicon.ico">

    <title>
        
        Dubbo源码阅读之集成Spring注解解析(0201) - undefined
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/blog/css/aircloud.css">
    <link rel="stylesheet" href="/blog/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> 所有的善恶都是我，良心一路走来依旧清澈鲜活... </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar">
            <img src="/blog/img/photo.png" />
        </div>
        <div class="name">
            <i>不负如来不负卿</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/blog/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/blog/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/blog/archive">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/blog/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#AnnotationBeanDefinitionParser解析类"><span class="toc-text">AnnotationBeanDefinitionParser解析类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ServiceAnnotationBeanPostProcessor类实现"><span class="toc-text">ServiceAnnotationBeanPostProcessor类实现</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#DubboClassPathBeanDefinitionScanner"><span class="toc-text">DubboClassPathBeanDefinitionScanner</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#AnnotationPropertyValuesAdapter"><span class="toc-text">AnnotationPropertyValuesAdapter</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ServiceBean类"><span class="toc-text">ServiceBean类</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#export方法"><span class="toc-text">export方法</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#doExportUrls方法"><span class="toc-text">doExportUrls方法</span></a></li></ol></li></ol></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>
        <div class="index-about-mobile">
            <i> 所有的善恶都是我，良心一路走来依旧清澈鲜活... </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        Dubbo源码阅读之集成Spring注解解析(0201)
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2018-08-05 09:29:48</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/blog/tags/#dubbo" title="dubbo">dubbo</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <blockquote>
<p>本小节介绍Annotation的解析</p>
</blockquote>
<h3 id="AnnotationBeanDefinitionParser解析类"><a href="#AnnotationBeanDefinitionParser解析类" class="headerlink" title="AnnotationBeanDefinitionParser解析类"></a>AnnotationBeanDefinitionParser解析类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">该类继承自AbstractSingleBeanDefinitionParser抽象类，该抽象类规范了注册bean的骨架(即模板方法)，我们只需要实现getBeanClass方法指定待注册的bean，以及实现doParse方法表明如何解析类。</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationBeanDefinitionParser</span> <span class="keyword">extends</span> <span class="title">AbstractSingleBeanDefinitionParser</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析：&lt;dubbo:annotation package=""/&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> element</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parserContext</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> builder</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doParse</span><span class="params">(Element element, ParserContext parserContext, BeanDefinitionBuilder builder)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取配置的package属性</span></span><br><span class="line">        String packageToScan = element.getAttribute(<span class="string">"package"</span>);</span><br><span class="line">        <span class="comment">//逗号分隔package</span></span><br><span class="line">        String[] packagesToScan = trimArrayElements(commaDelimitedListToStringArray(packageToScan));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//通过构造函数设置ServiceAnnotationBeanPostProcessor类的packagesToScan属性</span></span><br><span class="line">        builder.addConstructorArgValue(packagesToScan);</span><br><span class="line">        <span class="comment">//标识为基础设施类，防止该bean被代理</span></span><br><span class="line">        builder.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//注册@ReferenceAnnotationBeanPostProcessor</span></span><br><span class="line">        registerReferenceAnnotationBeanPostProcessor(parserContext.getRegistry());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">shouldGenerateIdAsFallback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注册ReferenceAnnotationBeanPostProcessor类</span></span><br><span class="line"><span class="comment">     * 该类用来处理<span class="doctag">@Reference</span></span></span><br><span class="line"><span class="comment">     * Registers &#123;<span class="doctag">@link</span> ReferenceAnnotationBeanPostProcessor&#125; into &#123;<span class="doctag">@link</span> BeanFactory&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> registry &#123;<span class="doctag">@link</span> BeanDefinitionRegistry&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerReferenceAnnotationBeanPostProcessor</span><span class="params">(BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Register @Reference Annotation Bean Processor</span></span><br><span class="line">        BeanRegistrar.registerInfrastructureBean(registry,</span><br><span class="line">                ReferenceAnnotationBeanPostProcessor.BEAN_NAME,</span><br><span class="line">                ReferenceAnnotationBeanPostProcessor.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; getBeanClass(Element element) &#123;</span><br><span class="line">        <span class="comment">//解析注册ServiceAnnotationBeanPostProcessor类</span></span><br><span class="line">        <span class="keyword">return</span> ServiceAnnotationBeanPostProcessor.class;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们将ServiceAnnotationBeanPostProcessor类和ReferenceAnnotationBeanPostProcessor类注册到了Bean工厂中了，接下来我们将用两小节(0201/0202)来介绍这两个类的实现，先来看ServiceAnnotationBeanPostProcessor类的实现(0201)，ReferenceAnnotationBeanPostProcessor类放到(0202)小节介绍</p>
<h4 id="ServiceAnnotationBeanPostProcessor类实现"><a href="#ServiceAnnotationBeanPostProcessor类实现" class="headerlink" title="ServiceAnnotationBeanPostProcessor类实现"></a>ServiceAnnotationBeanPostProcessor类实现</h4><p>接下来我们来分析下ServiceAnnotationBeanPostProcessor类,该类用来处理@Service注解，它实现了BeanDefinitionRegistryPostProcessor接口,实现它的postProcessBeanDefinitionRegistry方法允许我们实现自定义的注册bean定义的逻辑。同时也实现了几个以Aware为结尾的接口，例如BeanClassLoaderAware，实现了这些接口后，则ServiceAnnotationBeanPostProcessor类被实例化后将会获取相对应的资源。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceAnnotationBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanDefinitionRegistryPostProcessor</span>, <span class="title">EnvironmentAware</span>,</span></span><br><span class="line"><span class="class">        <span class="title">ResourceLoaderAware</span>, <span class="title">BeanClassLoaderAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//分隔符	</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SEPARATOR = <span class="string">":"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//扫描的包路径(上面的小节介绍过，注册该bean时，会扫描包路径)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; packagesToScan;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//实现EnvironmentAware接口，实例化后会自动注入</span></span><br><span class="line">    <span class="keyword">private</span> Environment environment;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ResourceLoader resourceLoader;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ClassLoader classLoader;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//构造方法，参数是需要扫描的包路径</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ServiceAnnotationBeanPostProcessor</span><span class="params">(String... packagesToScan)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(Arrays.asList(packagesToScan));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ServiceAnnotationBeanPostProcessor</span><span class="params">(Collection&lt;String&gt; packagesToScan)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(<span class="keyword">new</span> LinkedHashSet&lt;String&gt;(packagesToScan));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ServiceAnnotationBeanPostProcessor</span><span class="params">(Set&lt;String&gt; packagesToScan)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//保存包路径</span></span><br><span class="line">	<span class="keyword">this</span>.packagesToScan = packagesToScan;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanDefinitionRegistry</span><span class="params">(BeanDefinitionRegistry registry)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">	<span class="comment">//处理待扫描包里面的占位符(后面会分析该方法)</span></span><br><span class="line">        Set&lt;String&gt; resolvedPackagesToScan = resolvePackagesToScan(packagesToScan);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!CollectionUtils.isEmpty(resolvedPackagesToScan)) &#123;</span><br><span class="line">            <span class="comment">//扫描包，找到存在@Service注解的类，然后注册它(后面会分析该方法)</span></span><br><span class="line">	    registerServiceBeans(resolvedPackagesToScan, registry);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">                <span class="comment">//没有配置带扫描的包路径，将会忽略ServiceBean的注册</span></span><br><span class="line">                logger.warn(<span class="string">"packagesToScan is empty , ServiceBean registry will be ignored!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理带扫描包里面的占位符</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> packagesToScan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Set&lt;String&gt; <span class="title">resolvePackagesToScan</span><span class="params">(Set&lt;String&gt; packagesToScan)</span> </span>&#123;</span><br><span class="line">        Set&lt;String&gt; resolvedPackagesToScan = <span class="keyword">new</span> LinkedHashSet&lt;String&gt;(packagesToScan.size());</span><br><span class="line">        <span class="comment">//遍历带扫描的包</span></span><br><span class="line">        <span class="keyword">for</span> (String packageToScan : packagesToScan) &#123;</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.hasText(packageToScan)) &#123;</span><br><span class="line">                <span class="comment">//通过environment解决占位符</span></span><br><span class="line">                String resolvedPackageToScan = environment.resolvePlaceholders(packageToScan.trim());</span><br><span class="line">                resolvedPackagesToScan.add(resolvedPackageToScan);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> resolvedPackagesToScan;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注册存在<span class="doctag">@Service</span>注解的类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> packagesToScan 待扫描的基础包路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> registry       &#123;<span class="doctag">@link</span> BeanDefinitionRegistry&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerServiceBeans</span><span class="params">(Set&lt;String&gt; packagesToScan, BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//创建扫描器，用来扫描指定的包路径(后面会介绍该类)</span></span><br><span class="line">        DubboClassPathBeanDefinitionScanner scanner =</span><br><span class="line">                <span class="keyword">new</span> DubboClassPathBeanDefinitionScanner(registry, environment, resourceLoader);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//获取BeanNameGenerator实例用来生成bean name(后面会介绍该方法)</span></span><br><span class="line">        BeanNameGenerator beanNameGenerator = resolveBeanNameGenerator(registry);</span><br><span class="line">        </span><br><span class="line">	<span class="comment">//将BeanNameGenerator设置到扫描器</span></span><br><span class="line">        scanner.setBeanNameGenerator(beanNameGenerator);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//设置过滤器，只扫描存在@Service注解的</span></span><br><span class="line">        scanner.addIncludeFilter(<span class="keyword">new</span> AnnotationTypeFilter(Service.class));</span><br><span class="line"></span><br><span class="line">	<span class="comment">//遍历基础包</span></span><br><span class="line">        <span class="keyword">for</span> (String packageToScan : packagesToScan) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 首先注册@Service bean</span></span><br><span class="line">            scanner.scan(packageToScan);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 找到该包下所有存在@Service的BeanDefinition(不论是否是@ComponentScan扫描的)，</span></span><br><span class="line">	    <span class="comment">//然后为该bean生成beanName，并将该beanName和BeanDefinition包装成BeanDefinitionHolder（后面会分析该方法）</span></span><br><span class="line">            Set&lt;BeanDefinitionHolder&gt; beanDefinitionHolders =</span><br><span class="line">                    findServiceBeanDefinitionHolders(scanner, packageToScan, registry, beanNameGenerator);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!CollectionUtils.isEmpty(beanDefinitionHolders)) &#123;</span><br><span class="line">                </span><br><span class="line">		<span class="comment">//遍历beanDefinitionHolders</span></span><br><span class="line">                <span class="keyword">for</span> (BeanDefinitionHolder beanDefinitionHolder : beanDefinitionHolders) &#123;</span><br><span class="line">		    <span class="comment">//根据@Service注解 和 beanDefinition  注册ServiceBean类(后面会分析该方法)</span></span><br><span class="line">                    registerServiceBean(beanDefinitionHolder, registry, scanner);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">		    <span class="comment">//输出扫描出来的@Service bean的数量，以及扫描的包路径</span></span><br><span class="line">                    logger.info(beanDefinitionHolders.size() + <span class="string">" annotated Dubbo's @Service Components &#123; "</span> +</span><br><span class="line">                            beanDefinitionHolders +</span><br><span class="line">                            <span class="string">" &#125; were scanned under package["</span> + packageToScan + <span class="string">"]"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//没有扫描到</span></span><br><span class="line">                <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">                    logger.warn(<span class="string">"No Spring Bean annotating Dubbo's @Service was found under package["</span></span><br><span class="line">                            + packageToScan + <span class="string">"]"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取BeanNameGenerator</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 2.5.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> BeanNameGenerator <span class="title">resolveBeanNameGenerator</span><span class="params">(BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        BeanNameGenerator beanNameGenerator = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (registry <span class="keyword">instanceof</span> SingletonBeanRegistry) &#123;</span><br><span class="line">	    <span class="comment">//单例bean</span></span><br><span class="line">            SingletonBeanRegistry singletonBeanRegistry = SingletonBeanRegistry.class.cast(registry);</span><br><span class="line">	    <span class="comment">//获取beanName生成器</span></span><br><span class="line">            beanNameGenerator = (BeanNameGenerator) singletonBeanRegistry.getSingleton(CONFIGURATION_BEAN_NAME_GENERATOR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (beanNameGenerator == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line"></span><br><span class="line">                logger.info(<span class="string">"BeanNameGenerator bean can't be found in BeanFactory with name ["</span></span><br><span class="line">                        + CONFIGURATION_BEAN_NAME_GENERATOR + <span class="string">"]"</span>);</span><br><span class="line">                logger.info(<span class="string">"BeanNameGenerator will be a instance of "</span> +</span><br><span class="line">                        AnnotationBeanNameGenerator.class.getName() +</span><br><span class="line">                        <span class="string">" , it maybe a potential problem on bean name generation."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">	    <span class="comment">//使用AnnotationBeanNameGenerator</span></span><br><span class="line">            beanNameGenerator = <span class="keyword">new</span> AnnotationBeanNameGenerator();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> beanNameGenerator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 扫描包路径，通过过滤器找到存在<span class="doctag">@Service</span>注解的bean，然后为该bean生成beanName，</span></span><br><span class="line"><span class="comment">     * 然后将该beanName和beanDefinition封装成BeanDefinitionHolder对象，返回BeanDefinitionHolder列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Set&lt;BeanDefinitionHolder&gt; <span class="title">findServiceBeanDefinitionHolders</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            ClassPathBeanDefinitionScanner scanner, String packageToScan, BeanDefinitionRegistry registry,</span></span></span><br><span class="line"><span class="function"><span class="params">            BeanNameGenerator beanNameGenerator)</span> </span>&#123;</span><br><span class="line"> 	</span><br><span class="line">	<span class="comment">//扫描基础包，查询候选组件（通过过滤器过滤出来的，即存在@Service注解的bean）</span></span><br><span class="line">        Set&lt;BeanDefinition&gt; beanDefinitions = scanner.findCandidateComponents(packageToScan);</span><br><span class="line"></span><br><span class="line">        Set&lt;BeanDefinitionHolder&gt; beanDefinitionHolders = <span class="keyword">new</span> LinkedHashSet&lt;BeanDefinitionHolder&gt;(beanDefinitions.size());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (BeanDefinition beanDefinition : beanDefinitions) &#123;</span><br><span class="line">	    <span class="comment">//根据beanDefinition生成bean名称</span></span><br><span class="line">            String beanName = beanNameGenerator.generateBeanName(beanDefinition, registry);</span><br><span class="line">           </span><br><span class="line">	    <span class="comment">//根据beanName和beanDefinition创建BeanDefinitionHolder对象</span></span><br><span class="line">	    BeanDefinitionHolder beanDefinitionHolder = <span class="keyword">new</span> BeanDefinitionHolder(beanDefinition, beanName);</span><br><span class="line">           </span><br><span class="line">	    <span class="comment">//保存到列表	</span></span><br><span class="line">	    beanDefinitionHolders.add(beanDefinitionHolder);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> beanDefinitionHolders;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据<span class="doctag">@Service</span>注解 和 beanDefinition  注册ServiceBean类</span></span><br><span class="line"><span class="comment">     * Registers &#123;<span class="doctag">@link</span> ServiceBean&#125; from new annotated &#123;<span class="doctag">@link</span> Service&#125; &#123;<span class="doctag">@link</span> BeanDefinition&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerServiceBean</span><span class="params">(BeanDefinitionHolder beanDefinitionHolder, BeanDefinitionRegistry registry,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     DubboClassPathBeanDefinitionScanner scanner)</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//从beanDefinitionHolder中获取beanName，然后加载该类(后面会分析该方法)</span></span><br><span class="line">        Class&lt;?&gt; beanClass = resolveClass(beanDefinitionHolder);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//查询该bean的@Service注解(后面会分析该方法)</span></span><br><span class="line">        Service service = findAnnotation(beanClass, Service.class);</span><br><span class="line">		</span><br><span class="line">	<span class="comment">//获取interfaceClass接口(后面会分析该方法)</span></span><br><span class="line">        Class&lt;?&gt; interfaceClass = resolveServiceInterfaceClass(beanClass, service);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//获取bean的名称</span></span><br><span class="line">        String annotatedServiceBeanName = beanDefinitionHolder.getBeanName();</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//构建ServiceBean定义(后面会分析该方法)</span></span><br><span class="line">        AbstractBeanDefinition serviceBeanDefinition =</span><br><span class="line">                buildServiceBeanDefinition(service, interfaceClass, annotatedServiceBeanName);</span><br><span class="line">	</span><br><span class="line">        <span class="comment">//生成ServiceBean的beanName(后面会分析该方法)</span></span><br><span class="line">        String beanName = generateServiceBeanName(service, interfaceClass, annotatedServiceBeanName);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//检测重复的候选bean</span></span><br><span class="line">        <span class="keyword">if</span> (scanner.checkCandidate(beanName, serviceBeanDefinition)) &#123;</span><br><span class="line">	    <span class="comment">//注解ServiceBean</span></span><br><span class="line">            registry.registerBeanDefinition(beanName, serviceBeanDefinition);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">                logger.warn(<span class="string">"The BeanDefinition["</span> + serviceBeanDefinition +</span><br><span class="line">                        <span class="string">"] of ServiceBean has been registered with name : "</span> + beanName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	    <span class="comment">//发现重复的bean定义，@DubboComponentScan多次扫描到同一个包？</span></span><br><span class="line">            <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">                logger.warn(<span class="string">"The Duplicated BeanDefinition["</span> + serviceBeanDefinition +</span><br><span class="line">                        <span class="string">"] of ServiceBean[ bean name : "</span> + beanName +</span><br><span class="line">                        <span class="string">"] was be found , Did @DubboComponentScan scan to same package in many times?"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成ServiceBean的bean name</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> service  <span class="doctag">@Service</span>注解</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> interfaceClass 存在<span class="doctag">@Service</span>注解的类的接口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> annotatedServiceBeanName 存在<span class="doctag">@Service</span>注解的Bean name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> ServiceBean@interfaceClassName#annotatedServiceBeanName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 2.5.9</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">generateServiceBeanName</span><span class="params">(Service service, Class&lt;?&gt; interfaceClass, String annotatedServiceBeanName)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//添加"ServiceBean"</span></span><br><span class="line">        StringBuilder beanNameBuilder = <span class="keyword">new</span> StringBuilder(ServiceBean.class.getSimpleName());</span><br><span class="line"></span><br><span class="line">	<span class="comment">//添加分隔符":" 和 annotatedServiceBeanName </span></span><br><span class="line">        beanNameBuilder.append(SEPARATOR).append(annotatedServiceBeanName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取接口的全限定名</span></span><br><span class="line">        String interfaceClassName = interfaceClass.getName();</span><br><span class="line">  </span><br><span class="line">        <span class="comment">//添加分隔符":" 和 interfaceClassName</span></span><br><span class="line">        beanNameBuilder.append(SEPARATOR).append(interfaceClassName);</span><br><span class="line">       </span><br><span class="line">  	<span class="comment">//获取@Service注解的version属性</span></span><br><span class="line">        String version = service.version();</span><br><span class="line">	</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(version)) &#123;</span><br><span class="line">            <span class="comment">//添加分隔符":" 和 version</span></span><br><span class="line">	    beanNameBuilder.append(SEPARATOR).append(version);</span><br><span class="line">        &#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//获取Service的group属性</span></span><br><span class="line">        String group = service.group();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(group)) &#123;</span><br><span class="line">	    <span class="comment">//添加分隔符":" 和 group</span></span><br><span class="line">            beanNameBuilder.append(SEPARATOR).append(group);</span><br><span class="line">        &#125;</span><br><span class="line">	<span class="comment">//返回生成的bean名称</span></span><br><span class="line">        <span class="keyword">return</span> beanNameBuilder.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理<span class="doctag">@Service</span>注解里的interfaceClass()，该interfaceClass不可以为空，并且必须是接口类型</span></span><br><span class="line"><span class="comment">     * 1、获取<span class="doctag">@Service</span>注解中的interfaceClass()</span></span><br><span class="line"><span class="comment">     * 2、获取<span class="doctag">@Service</span>注解中的interfaceName()，并加载</span></span><br><span class="line"><span class="comment">     * 3、获取<span class="doctag">@Service</span>注解类的第1个接口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> annotatedServiceBeanClass 存在<span class="doctag">@Service</span>注解的类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> service <span class="doctag">@Service</span>注解</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt; resolveServiceInterfaceClass(Class&lt;?&gt; annotatedServiceBeanClass, Service service) &#123;</span><br><span class="line">        </span><br><span class="line">	<span class="comment">//interfaceClass默认为@Service注解的interfaceClass属性</span></span><br><span class="line">        Class&lt;?&gt; interfaceClass = service.interfaceClass();</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">void</span>.class.equals(interfaceClass)) &#123;</span><br><span class="line">	    <span class="comment">//@Service注解的interfaceClass属性为空</span></span><br><span class="line">            interfaceClass = <span class="keyword">null</span>;</span><br><span class="line">		</span><br><span class="line">	    <span class="comment">//获取@Service注解的interfaceName属性</span></span><br><span class="line">            String interfaceClassName = service.interfaceName();</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.hasText(interfaceClassName)) &#123;</span><br><span class="line">		<span class="comment">//判断是否存在interfaceClassName类</span></span><br><span class="line">                <span class="keyword">if</span> (ClassUtils.isPresent(interfaceClassName, classLoader)) &#123;</span><br><span class="line">		    <span class="comment">//加载interfaceClassName类，并赋值给interfaceClass</span></span><br><span class="line">                    interfaceClass = resolveClassName(interfaceClassName, classLoader);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (interfaceClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">	    <span class="comment">//获取该类的所有接口</span></span><br><span class="line">            Class&lt;?&gt;[] allInterfaces = annotatedServiceBeanClass.getInterfaces();</span><br><span class="line">            <span class="keyword">if</span> (allInterfaces.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="comment">//取第一个接口，赋值给interfaceClass</span></span><br><span class="line">                interfaceClass = allInterfaces[<span class="number">0</span>];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">	<span class="comment">//验证不为空，且interfaceClass为接口</span></span><br><span class="line">        Assert.notNull(interfaceClass,</span><br><span class="line">                <span class="string">"@Service interfaceClass() or interfaceName() or interface class must be present!"</span>);</span><br><span class="line"></span><br><span class="line">        Assert.isTrue(interfaceClass.isInterface(),</span><br><span class="line">                <span class="string">"The type that was annotated @Service is not an interface!"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> interfaceClass;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt; resolveClass(BeanDefinitionHolder beanDefinitionHolder) &#123;</span><br><span class="line">	<span class="comment">//获取bean定义</span></span><br><span class="line">        BeanDefinition beanDefinition = beanDefinitionHolder.getBeanDefinition();</span><br><span class="line">        <span class="keyword">return</span> resolveClass(beanDefinition);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加载类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt; resolveClass(BeanDefinition beanDefinition) &#123;</span><br><span class="line">	<span class="comment">//获取bean的类名</span></span><br><span class="line">        String beanClassName = beanDefinition.getBeanClassName();</span><br><span class="line"> 	<span class="comment">//加载该类	</span></span><br><span class="line">        <span class="keyword">return</span> resolveClassName(beanClassName, classLoader);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构建ServiceBean定义</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> service  <span class="doctag">@Service</span>注解</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> interfaceClass 接口类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> annotatedServiceBeanName 存在<span class="doctag">@Service</span>注解的类的bean name</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> AbstractBeanDefinition <span class="title">buildServiceBeanDefinition</span><span class="params">(Service service, Class&lt;?&gt; interfaceClass,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                              String annotatedServiceBeanName)</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//获取ServiceBean的BeanDefinition构造器</span></span><br><span class="line">        BeanDefinitionBuilder builder = rootBeanDefinition(ServiceBean.class);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//获取BeanDefinition</span></span><br><span class="line">        AbstractBeanDefinition beanDefinition = builder.getBeanDefinition();</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//获取ServiceBean的属性</span></span><br><span class="line">        MutablePropertyValues propertyValues = beanDefinition.getPropertyValues();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//忽略的属性名称,这些属性的值后面会设置，从@Service注解中获取</span></span><br><span class="line">        String[] ignoreAttributeNames = of(<span class="string">"provider"</span>, <span class="string">"monitor"</span>, <span class="string">"application"</span>, <span class="string">"module"</span>, <span class="string">"registry"</span>, <span class="string">"protocol"</span>, <span class="string">"interface"</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//添加属性值(后面会介绍该类)</span></span><br><span class="line">        propertyValues.addPropertyValues(<span class="keyword">new</span> AnnotationPropertyValuesAdapter(service, environment, ignoreAttributeNames));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//为ServiceBean添加ref属性，属性值为annotatedServiceBeanName(即存在@Service注解的bean name)(后面会分析该方法)	</span></span><br><span class="line">        addPropertyReference(builder, <span class="string">"ref"</span>, annotatedServiceBeanName);</span><br><span class="line">        <span class="comment">//为ServiceBean添加interface属性，属性值为interfaceClass接口的名称</span></span><br><span class="line">        builder.addPropertyValue(<span class="string">"interface"</span>, interfaceClass.getName());</span><br><span class="line"></span><br><span class="line">	<span class="comment">//获取@Service注解的provider属性(即com.alibaba.dubbo.config.ProviderConfig)</span></span><br><span class="line">        String providerConfigBeanName = service.provider();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(providerConfigBeanName)) &#123;</span><br><span class="line">	    <span class="comment">//为ServiceBean添加provider属性，属性值为providerConfigBeanName</span></span><br><span class="line">            addPropertyReference(builder, <span class="string">"provider"</span>, providerConfigBeanName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取@Service注解的monitor属性(即com.alibaba.dubbo.config.MonitorConfig)</span></span><br><span class="line">	String monitorConfigBeanName = service.monitor();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(monitorConfigBeanName)) &#123;</span><br><span class="line">	    <span class="comment">//为ServiceBean添加monitor属性，属性值为monitorConfigBeanName</span></span><br><span class="line">            addPropertyReference(builder, <span class="string">"monitor"</span>, monitorConfigBeanName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//获取@Service注解的application属性(即com.alibaba.dubbo.config.ApplicationConfig)</span></span><br><span class="line">        String applicationConfigBeanName = service.application();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(applicationConfigBeanName)) &#123;</span><br><span class="line">	    <span class="comment">//为ServiceBean添加application属性，属性值为applicationConfigBeanName</span></span><br><span class="line">            addPropertyReference(builder, <span class="string">"application"</span>, applicationConfigBeanName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//获取@Service注解的module属性(即com.alibaba.dubbo.config.ModuleConfig)</span></span><br><span class="line">	String moduleConfigBeanName = service.<span class="keyword">module</span>();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(moduleConfigBeanName)) &#123;</span><br><span class="line">	    <span class="comment">//为ServiceBean添加module属性，属性值为moduleConfigBeanName</span></span><br><span class="line">            addPropertyReference(builder, <span class="string">"module"</span>, moduleConfigBeanName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">//获取@Service注解的registry属性(即com.alibaba.dubbo.config.RegistryConfig)</span></span><br><span class="line">        String[] registryConfigBeanNames = service.registry();</span><br><span class="line">	<span class="comment">//遍历registryConfigBeanNames，处理占位符，然后包装成RuntimeBeanReference并返回(后面会分析该方法)</span></span><br><span class="line">        List&lt;RuntimeBeanReference&gt; registryRuntimeBeanReferences = toRuntimeBeanReferences(registryConfigBeanNames);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!registryRuntimeBeanReferences.isEmpty()) &#123;</span><br><span class="line">            <span class="comment">//为ServiceBean添加registries属性</span></span><br><span class="line">	    builder.addPropertyValue(<span class="string">"registries"</span>, registryRuntimeBeanReferences);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取@Service的protocol属性(即com.alibaba.dubbo.config.ProtocolConfig)</span></span><br><span class="line">	String[] protocolConfigBeanNames = service.protocol();</span><br><span class="line">	<span class="comment">//处理占位符</span></span><br><span class="line">        List&lt;RuntimeBeanReference&gt; protocolRuntimeBeanReferences = toRuntimeBeanReferences(protocolConfigBeanNames);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!protocolRuntimeBeanReferences.isEmpty()) &#123;</span><br><span class="line">            <span class="comment">//为ServiceBean添加protocols属性</span></span><br><span class="line">	    builder.addPropertyValue(<span class="string">"protocols"</span>, protocolRuntimeBeanReferences);</span><br><span class="line">        &#125;</span><br><span class="line">	<span class="comment">//返回@ServiceBean定义</span></span><br><span class="line">        <span class="keyword">return</span> builder.getBeanDefinition();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理占位符，并包装成包装成RuntimeBeanReference对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanNames</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ManagedList&lt;RuntimeBeanReference&gt; <span class="title">toRuntimeBeanReferences</span><span class="params">(String... beanNames)</span> </span>&#123;</span><br><span class="line">        ManagedList&lt;RuntimeBeanReference&gt; runtimeBeanReferences = <span class="keyword">new</span> ManagedList&lt;RuntimeBeanReference&gt;();</span><br><span class="line">        <span class="keyword">if</span> (!ObjectUtils.isEmpty(beanNames)) &#123;</span><br><span class="line">            <span class="comment">//遍历bean names</span></span><br><span class="line">            <span class="keyword">for</span> (String beanName : beanNames) &#123;</span><br><span class="line">		<span class="comment">//解决占位符</span></span><br><span class="line">                String resolvedBeanName = environment.resolvePlaceholders(beanName);</span><br><span class="line">		<span class="comment">//将beanName包装成RuntimeBeanReference对象</span></span><br><span class="line">                runtimeBeanReferences.add(<span class="keyword">new</span> RuntimeBeanReference(resolvedBeanName));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> runtimeBeanReferences;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 为ServiceBean添加propertyName属性，属性值为beanName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> builder ServiceBean定义构造器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> propertyName 属性名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanName 存在<span class="doctag">@Service</span>直接的bean name</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addPropertyReference</span><span class="params">(BeanDefinitionBuilder builder, String propertyName, String beanName)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//处理占位符</span></span><br><span class="line">	String resolvedBeanName = environment.resolvePlaceholders(beanName);</span><br><span class="line">        <span class="comment">//为ServiceBean添加propertyName属性，属性值为resolvedBeanName</span></span><br><span class="line">	builder.addPropertyReference(propertyName, resolvedBeanName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEnvironment</span><span class="params">(Environment environment)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.environment = environment;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setResourceLoader</span><span class="params">(ResourceLoader resourceLoader)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.resourceLoader = resourceLoader;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanClassLoader</span><span class="params">(ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.classLoader = classLoader;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们再看下用到的其他类</p>
<h5 id="DubboClassPathBeanDefinitionScanner"><a href="#DubboClassPathBeanDefinitionScanner" class="headerlink" title="DubboClassPathBeanDefinitionScanner"></a>DubboClassPathBeanDefinitionScanner</h5><p>该类继承自ClassPathBeanDefinitionScanner,它提供自动扫描功能,根据提供的基础包路径,扫描classpath下该基础包路径,找到符合条件的类并注册为Spring的一个Bean,<br>默认情况下,ClassPathBeanDefinitionScanner将会扫描所有用Spring指定了的注解标识的类,包括@Component、@Service、@Repository、@Controller,<br>也可以对扫描的机制进行配置,设置一些Filter,只有满足Filter的类才能被注册为Bean.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboClassPathBeanDefinitionScanner</span> <span class="keyword">extends</span> <span class="title">ClassPathBeanDefinitionScanner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DubboClassPathBeanDefinitionScanner</span><span class="params">(BeanDefinitionRegistry registry,</span></span></span><br><span class="line"><span class="function"><span class="params">                                               <span class="keyword">boolean</span> useDefaultFilters,</span></span></span><br><span class="line"><span class="function"><span class="params">                                               Environment environment,</span></span></span><br><span class="line"><span class="function"><span class="params">                                               ResourceLoader resourceLoader)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(registry, useDefaultFilters);</span><br><span class="line">        </span><br><span class="line">	setEnvironment(environment);</span><br><span class="line"></span><br><span class="line">        setResourceLoader(resourceLoader);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//会调用AnnotationConfigUtils类的registerAnnotationConfigProcessors方法</span></span><br><span class="line">        registerAnnotationConfigProcessors(registry);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DubboClassPathBeanDefinitionScanner</span><span class="params">(BeanDefinitionRegistry registry,</span></span></span><br><span class="line"><span class="function"><span class="params">                                               Environment environment,</span></span></span><br><span class="line"><span class="function"><span class="params">                                               ResourceLoader resourceLoader)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(registry, <span class="keyword">false</span>, environment, resourceLoader);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;BeanDefinitionHolder&gt; <span class="title">doScan</span><span class="params">(String... basePackages)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.doScan(basePackages);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkCandidate</span><span class="params">(String beanName, BeanDefinition beanDefinition)</span> <span class="keyword">throws</span> IllegalStateException </span>&#123;</span><br><span class="line">        <span class="comment">//检测beanName是否已经存在</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.checkCandidate(beanName, beanDefinition);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接下来我们看下AnnotationConfigUtils类的registerAnnotationConfigProcessors方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Set&lt;BeanDefinitionHolder&gt; <span class="title">registerAnnotationConfigProcessors</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">			BeanDefinitionRegistry registry, Object source)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//···省略···</span></span><br><span class="line">	Set&lt;BeanDefinitionHolder&gt; beanDefs = <span class="keyword">new</span> LinkedHashSet(<span class="number">4</span>);</span><br><span class="line">	RootBeanDefinition def;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//注册ConfigurationClassPostProcessor</span></span><br><span class="line">	<span class="keyword">if</span> (!registry.containsBeanDefinition(<span class="string">"org.springframework.context.annotation.internalConfigurationAnnotationProcessor"</span>)) &#123;</span><br><span class="line">	    <span class="comment">//1.在spring使用AnnotationConfigBeanDefinitionParser解析xml文件的时候  也就是配置annotation-config的时候</span></span><br><span class="line">            <span class="comment">//2.启动在AnnotationConfigApplicationContext容器的时候</span></span><br><span class="line">	    def = <span class="keyword">new</span> RootBeanDefinition(ConfigurationClassPostProcessor.class);</span><br><span class="line">	    def.setSource(source);</span><br><span class="line">	    beanDefs.add(registerPostProcessor(registry, def, <span class="string">"org.springframework.context.annotation.internalConfigurationAnnotationProcessor"</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//注册AutowiredAnnotationBeanPostProcessor </span></span><br><span class="line">	<span class="keyword">if</span> (!registry.containsBeanDefinition(<span class="string">"org.springframework.context.annotation.internalAutowiredAnnotationProcessor"</span>)) &#123;</span><br><span class="line">	    def = <span class="keyword">new</span> RootBeanDefinition(AutowiredAnnotationBeanPostProcessor.class);</span><br><span class="line">	    def.setSource(source);</span><br><span class="line">	    beanDefs.add(registerPostProcessor(registry, def, <span class="string">"org.springframework.context.annotation.internalAutowiredAnnotationProcessor"</span>));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//···省略···</span></span><br><span class="line">	<span class="keyword">return</span> beanDefs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="AnnotationPropertyValuesAdapter"><a href="#AnnotationPropertyValuesAdapter" class="headerlink" title="AnnotationPropertyValuesAdapter"></a>AnnotationPropertyValuesAdapter</h5><p>该类实现了Spring的PropertyValues接口，此接口是PropertyValue的集合管理类,用来储存键值对.MutablePropertyValues是其常用实现类<br>在该适配器内部就是用了MutablePropertyValues实现类来进行操作。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//我们在上文构建ServiceBean定义的时候会创建AnnotationPropertyValuesAdapter类，相关代码如下：</span></span><br><span class="line"><span class="comment">//String[] ignoreAttributeNames = of("provider", "monitor", "application", "module", "registry", "protocol", "interface");</span></span><br><span class="line"><span class="comment">//propertyValues.addPropertyValues(new AnnotationPropertyValuesAdapter(service, environment, ignoreAttributeNames));</span></span><br><span class="line"><span class="comment">//其中service参数是@Service注解，而environment参数类实现了PropertyResolver接口</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnnotationPropertyValuesAdapter</span> <span class="keyword">implements</span> <span class="title">PropertyValues</span> </span>&#123;</span><br><span class="line">     </span><br><span class="line">    <span class="comment">//传过来的注解</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Annotation annotation;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//属性解决器,规范了解析底层任意property资源的接口</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PropertyResolver propertyResolver;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//是否忽略默认值</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> ignoreDefaultValue;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//委托类,即MutablePropertyValues</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PropertyValues delegate;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AnnotationPropertyValuesAdapter</span><span class="params">(Annotation annotation, PropertyResolver propertyResolver, <span class="keyword">boolean</span> ignoreDefaultValue, String... ignoreAttributeNames)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.annotation = annotation;</span><br><span class="line">        <span class="keyword">this</span>.propertyResolver = propertyResolver;</span><br><span class="line">        <span class="keyword">this</span>.ignoreDefaultValue = ignoreDefaultValue;</span><br><span class="line">        <span class="comment">//生成MutablePropertyValues</span></span><br><span class="line">        <span class="keyword">this</span>.delegate = adapt(annotation, ignoreDefaultValue, ignoreAttributeNames);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AnnotationPropertyValuesAdapter</span><span class="params">(Annotation annotation, PropertyResolver propertyResolver, String... ignoreAttributeNames)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(annotation, propertyResolver, <span class="keyword">true</span>, ignoreAttributeNames);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> PropertyValues <span class="title">adapt</span><span class="params">(Annotation annotation, <span class="keyword">boolean</span> ignoreDefaultValue, String... ignoreAttributeNames)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//创建MutablePropertyValues类(后面会分析该方法getAttributes()</span></span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> MutablePropertyValues(getAttributes(annotation, propertyResolver, ignoreDefaultValue, ignoreAttributeNames));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Annotation <span class="title">getAnnotation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> annotation;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isIgnoreDefaultValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ignoreDefaultValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> PropertyValue[] getPropertyValues() &#123;</span><br><span class="line">	<span class="comment">//调用委托类的方法</span></span><br><span class="line">        <span class="keyword">return</span> delegate.getPropertyValues();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PropertyValue <span class="title">getPropertyValue</span><span class="params">(String propertyName)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//调用委托类的方法获取属性值</span></span><br><span class="line">        <span class="keyword">return</span> delegate.getPropertyValue(propertyName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PropertyValues <span class="title">changesSince</span><span class="params">(PropertyValues old)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> delegate.changesSince(old);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">contains</span><span class="params">(String propertyName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> delegate.contains(propertyName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> delegate.isEmpty();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>下面我们看下AnnotationUtils.getAttributes方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取注解的属性集合</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> annotation   注解</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> propertyResolver 属性解决器</span></span><br><span class="line"><span class="comment"> *    1、根据属性名称获取属性值（替换后的）</span></span><br><span class="line"><span class="comment"> *    2、替换$&#123;propertyName:defaultValue&#125;格式的占位符为实际值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ignoreDefaultValue 是否忽略默认值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ignoreAttributeNames 需要忽略的属性名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &lt;属性名，属性值&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, Object&gt; <span class="title">getAttributes</span><span class="params">(Annotation annotation,</span></span></span><br><span class="line"><span class="function"><span class="params">					    PropertyResolver propertyResolver,</span></span></span><br><span class="line"><span class="function"><span class="params">					    <span class="keyword">boolean</span> ignoreDefaultValue,</span></span></span><br><span class="line"><span class="function"><span class="params">					    String... ignoreAttributeNames)</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//需要忽略的属性名</span></span><br><span class="line">	Set&lt;String&gt; ignoreAttributeNamesSet = <span class="keyword">new</span> HashSet&lt;String&gt;(arrayToList(ignoreAttributeNames));</span><br><span class="line"></span><br><span class="line">	<span class="comment">//获取annotation注解的属性map(调用的Spring的AnnotationUtils.getAnnotationAttributes方法)</span></span><br><span class="line">	Map&lt;String, Object&gt; attributes = getAnnotationAttributes(annotation);</span><br><span class="line">	<span class="comment">//属性名,真实属性值</span></span><br><span class="line">	Map&lt;String, Object&gt; actualAttributes = <span class="keyword">new</span> LinkedHashMap&lt;String, Object&gt;();</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//是否需要处理占位符</span></span><br><span class="line">	<span class="keyword">boolean</span> requiredResolve = propertyResolver != <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; entry : attributes.entrySet()) &#123;</span><br><span class="line">	    <span class="comment">//属性名称</span></span><br><span class="line">	    String attributeName = entry.getKey();</span><br><span class="line">	    <span class="comment">//属性值</span></span><br><span class="line">	    Object attributeValue = entry.getValue();</span><br><span class="line"></span><br><span class="line">	    <span class="comment">//忽略默认属性值</span></span><br><span class="line">	    <span class="keyword">if</span> (ignoreDefaultValue &amp;&amp; nullSafeEquals(attributeValue, getDefaultValue(annotation, attributeName))) &#123;</span><br><span class="line">		<span class="comment">//属性值和默认值相等，则跳过该属性</span></span><br><span class="line">		<span class="keyword">continue</span>;</span><br><span class="line">	    &#125;</span><br><span class="line"></span><br><span class="line">	    <span class="comment">//忽略属性名</span></span><br><span class="line">	    <span class="keyword">if</span> (ignoreAttributeNamesSet.contains(attributeName)) &#123;</span><br><span class="line">		<span class="comment">//如果待忽略的属性名列表包含该属性名，则跳过该属性</span></span><br><span class="line">		<span class="keyword">continue</span>;</span><br><span class="line">	    &#125;</span><br><span class="line"></span><br><span class="line">	    <span class="comment">// 处理占位符,属性值为字符串类型</span></span><br><span class="line">	    <span class="keyword">if</span> (requiredResolve &amp;&amp; attributeValue <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">		<span class="comment">//获取真实属性值</span></span><br><span class="line">		String resolvedValue = propertyResolver.resolvePlaceholders(valueOf(attributeValue));</span><br><span class="line">		<span class="comment">//格式化真实属性值</span></span><br><span class="line">		attributeValue = trimAllWhitespace(resolvedValue);</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="comment">//保存属性名和真实属性值</span></span><br><span class="line">	    actualAttributes.put(attributeName, attributeValue);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> actualAttributes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="ServiceBean类"><a href="#ServiceBean类" class="headerlink" title="ServiceBean类"></a>ServiceBean类</h5><p>在上面的内容中，我们完成了ServiceBean类的注册，现在我们详细看看ServiceBean类.该类继承自ServiceConfig类，并且实现了众多Spring接口<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ServiceFactoryBean</span></span><br><span class="line"><span class="comment"> * InitializingBean接口在bean实例化完成后将会自动调用afterPropertiesSet方法</span></span><br><span class="line"><span class="comment"> * DisposableBean接口在bean销毁之前调用destroy方法</span></span><br><span class="line"><span class="comment"> * ApplicationContextAware接口在bean实例化完成后将会注入ApplicationContext属性</span></span><br><span class="line"><span class="comment"> * ApplicationListener接口Spring容器初始化完成后会回调onApplicationEvent方法</span></span><br><span class="line"><span class="comment"> * BeanNameAware接口注入bean名称</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@export</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceBean</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">ServiceConfig</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">InitializingBean</span>, <span class="title">DisposableBean</span>, <span class="title">ApplicationContextAware</span>, <span class="title">ApplicationListener</span>&lt;<span class="title">ContextRefreshedEvent</span>&gt;, <span class="title">BeanNameAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">213195494150089726L</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">transient</span> ApplicationContext SPRING_CONTEXT;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Service</span>注解</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">transient</span> Service service;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> String beanName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否支持ApplicationListener</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">boolean</span> supportedApplicationListener;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ServiceBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        <span class="keyword">this</span>.service = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ServiceBean</span><span class="params">(Service service)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(service);</span><br><span class="line">        <span class="keyword">this</span>.service = service;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取Spring ApplicationContext</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ApplicationContext <span class="title">getSpringContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SPRING_CONTEXT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//设置ApplicationContext</span></span><br><span class="line">        <span class="keyword">this</span>.applicationContext = applicationContext;</span><br><span class="line">        SpringExtensionFactory.addApplicationContext(applicationContext);</span><br><span class="line">        <span class="keyword">if</span> (applicationContext != <span class="keyword">null</span>) &#123;</span><br><span class="line">            SPRING_CONTEXT = applicationContext;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//backward compatibility to spring 2.0.1</span></span><br><span class="line">                <span class="comment">//从applicationContext中获取到addApplicationListener方法</span></span><br><span class="line">                Method method = applicationContext.getClass().getMethod(<span class="string">"addApplicationListener"</span>, <span class="keyword">new</span> Class&lt;?&gt;[]&#123;ApplicationListener.class&#125;);</span><br><span class="line">                <span class="comment">//调用applicationContext的addApplicationListener方法，将当前对象添加进去</span></span><br><span class="line">                method.invoke(applicationContext, <span class="keyword">new</span> Object[]&#123;<span class="keyword">this</span>&#125;);</span><br><span class="line">                <span class="comment">//设置支持ApplicationListener</span></span><br><span class="line">                supportedApplicationListener = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                <span class="keyword">if</span> (applicationContext <span class="keyword">instanceof</span> AbstractApplicationContext) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">// 向后兼容</span></span><br><span class="line">                        <span class="comment">// backward compatibility to spring 2.0.1</span></span><br><span class="line">                        Method method = AbstractApplicationContext.class.getDeclaredMethod(<span class="string">"addListener"</span>, <span class="keyword">new</span> Class&lt;?&gt;[]&#123;ApplicationListener.class&#125;);</span><br><span class="line">                        <span class="keyword">if</span> (!method.isAccessible()) &#123;</span><br><span class="line">                            method.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        method.invoke(applicationContext, <span class="keyword">new</span> Object[]&#123;<span class="keyword">this</span>&#125;);</span><br><span class="line">                        supportedApplicationListener = <span class="keyword">true</span>;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable t2) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.beanName = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Service <span class="title">getService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> service;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ContextRefreshedEvent event)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//没有配置delay，或者delay = -1</span></span><br><span class="line">        <span class="keyword">if</span> (isDelay() &amp;&amp; !isExported() &amp;&amp; !isUnexported()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">                logger.info(<span class="string">"The service ready on spring started. service: "</span> + getInterface());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//暴露服务(后面会分析该方法)</span></span><br><span class="line">            export();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 两种情况：</span></span><br><span class="line"><span class="comment">     * 1、设置了延迟暴露(delay != null &amp;&amp; delay != -1)，dubbo在Spring实例化bean的时候会对实现了InitializingBean的类进行回调，</span></span><br><span class="line"><span class="comment">     * 回调方法是afterPropertySet()，如果设置了延迟暴露，dubbo在这个方法中进行服务的发布。</span></span><br><span class="line"><span class="comment">     * 2、没有设置延迟或者延迟为-1，dubbo会在Spring实例化完bean之后，</span></span><br><span class="line"><span class="comment">     * 在刷新容器最后一步发布ContextRefreshEvent事件的时候，</span></span><br><span class="line"><span class="comment">     * 通知实现了ApplicationListener的类进行回调onApplicationEvent，dubbo会在这个方法中发布服务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isDelay</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取delay属性</span></span><br><span class="line">        Integer delay = getDelay();</span><br><span class="line">        <span class="comment">//获取服务提供者</span></span><br><span class="line">        ProviderConfig provider = getProvider();</span><br><span class="line">        <span class="keyword">if</span> (delay == <span class="keyword">null</span> &amp;&amp; provider != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//delay属性为空，则取服务提供者的delay属性</span></span><br><span class="line">            delay = provider.getDelay();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//(支持spring监听事件 &amp;&amp; 没有设置延迟或者延迟为-1) 则返回true</span></span><br><span class="line">        <span class="keyword">return</span> supportedApplicationListener &amp;&amp; (delay == <span class="keyword">null</span> || delay == -<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1、会判断ServiceBean的ProviderConfig、ApplicationConfig、ModuleConfig、List&lt;RegistryConfig&gt;、MonitorConfig、List&lt;ProtocolConfig&gt;属性是否为空，为空的话，从Spring容器中获取，然后进行赋值，其中还会检测是否存在重复的配置(default属性)</span></span><br><span class="line"><span class="comment">     * 2、接着会判断并设置path属性(使用beanName)</span></span><br><span class="line"><span class="comment">     * 3、根据delay属性判断是否需要暴露服务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"unchecked"</span>, <span class="string">"deprecation"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//没有配置Provider</span></span><br><span class="line">        <span class="keyword">if</span> (getProvider() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//从IOC容器中获取到所有的Provider</span></span><br><span class="line">            Map&lt;String, ProviderConfig&gt; providerConfigMap = applicationContext == <span class="keyword">null</span> ? <span class="keyword">null</span> : BeanFactoryUtils.beansOfTypeIncludingAncestors(applicationContext, ProviderConfig.class, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (providerConfigMap != <span class="keyword">null</span> &amp;&amp; providerConfigMap.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//从IOC容器中获取到所有的Protocol</span></span><br><span class="line">                Map&lt;String, ProtocolConfig&gt; protocolConfigMap = applicationContext == <span class="keyword">null</span> ? <span class="keyword">null</span> : BeanFactoryUtils.beansOfTypeIncludingAncestors(applicationContext, ProtocolConfig.class, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">                <span class="keyword">if</span> ((protocolConfigMap == <span class="keyword">null</span> || protocolConfigMap.size() == <span class="number">0</span>)</span><br><span class="line">                        &amp;&amp; providerConfigMap.size() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="comment">// backward compatibility</span></span><br><span class="line">                    <span class="comment">//如果没有配置Protocol，但是存在Provider的话，遍历Provider列表</span></span><br><span class="line">                    <span class="comment">//从Provider列表中找到isDefault属性为true的Provider，并保存起来</span></span><br><span class="line">                    List&lt;ProviderConfig&gt; providerConfigs = <span class="keyword">new</span> ArrayList&lt;ProviderConfig&gt;();</span><br><span class="line">                    <span class="keyword">for</span> (ProviderConfig config : providerConfigMap.values()) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (config.isDefault() != <span class="keyword">null</span> &amp;&amp; config.isDefault().booleanValue()) &#123;</span><br><span class="line">                            <span class="comment">//找到default为true的Provider</span></span><br><span class="line">                            providerConfigs.add(config);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!providerConfigs.isEmpty()) &#123;</span><br><span class="line">                        <span class="comment">//根据Provider构造Protocol(废弃方法)</span></span><br><span class="line">                        setProviders(providerConfigs);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ProviderConfig providerConfig = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="comment">//从provider列表中找到default属性为null或者为true的provider，如果找到多个则抛异常</span></span><br><span class="line">                    <span class="keyword">for</span> (ProviderConfig config : providerConfigMap.values()) &#123;</span><br><span class="line">                        <span class="comment">//没有配置isDefault属性或者isDefault = true</span></span><br><span class="line">                        <span class="comment">//检测是否存在重复的Provider配置</span></span><br><span class="line">                        <span class="keyword">if</span> (config.isDefault() == <span class="keyword">null</span> || config.isDefault().booleanValue()) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (providerConfig != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Duplicate provider configs: "</span> + providerConfig + <span class="string">" and "</span> + config);</span><br><span class="line">                            &#125;</span><br><span class="line">                            providerConfig = config;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (providerConfig != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">//设置Provider</span></span><br><span class="line">                        setProvider(providerConfig);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (getApplication() == <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; (getProvider() == <span class="keyword">null</span> || getProvider().getApplication() == <span class="keyword">null</span>)) &#123;</span><br><span class="line">            <span class="comment">//从IOC容器中找到所有的ApplicationConfig</span></span><br><span class="line">            Map&lt;String, ApplicationConfig&gt; applicationConfigMap = applicationContext == <span class="keyword">null</span> ? <span class="keyword">null</span> : BeanFactoryUtils.beansOfTypeIncludingAncestors(applicationContext, ApplicationConfig.class, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (applicationConfigMap != <span class="keyword">null</span> &amp;&amp; applicationConfigMap.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                ApplicationConfig applicationConfig = <span class="keyword">null</span>;</span><br><span class="line">                <span class="comment">//检测是否存在重复的Application配置(default属性为null或者为true)</span></span><br><span class="line">                <span class="keyword">for</span> (ApplicationConfig config : applicationConfigMap.values()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (config.isDefault() == <span class="keyword">null</span> || config.isDefault().booleanValue()) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (applicationConfig != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Duplicate application configs: "</span> + applicationConfig + <span class="string">" and "</span> + config);</span><br><span class="line">                        &#125;</span><br><span class="line">                        applicationConfig = config;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (applicationConfig != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    setApplication(applicationConfig);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (getModule() == <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; (getProvider() == <span class="keyword">null</span> || getProvider().getModule() == <span class="keyword">null</span>)) &#123;</span><br><span class="line">            <span class="comment">//从IOC容器中找到所有的ModuleConfig</span></span><br><span class="line">            Map&lt;String, ModuleConfig&gt; moduleConfigMap = applicationContext == <span class="keyword">null</span> ? <span class="keyword">null</span> : BeanFactoryUtils.beansOfTypeIncludingAncestors(applicationContext, ModuleConfig.class, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (moduleConfigMap != <span class="keyword">null</span> &amp;&amp; moduleConfigMap.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                ModuleConfig moduleConfig = <span class="keyword">null</span>;</span><br><span class="line">                <span class="comment">//检测是否存在重复的Module配置(default属性为null或者为true)</span></span><br><span class="line">                <span class="keyword">for</span> (ModuleConfig config : moduleConfigMap.values()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (config.isDefault() == <span class="keyword">null</span> || config.isDefault().booleanValue()) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (moduleConfig != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Duplicate module configs: "</span> + moduleConfig + <span class="string">" and "</span> + config);</span><br><span class="line">                        &#125;</span><br><span class="line">                        moduleConfig = config;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (moduleConfig != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    setModule(moduleConfig);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//register为空或者Provider中的register为空或者Application中的register为空</span></span><br><span class="line">        <span class="keyword">if</span> ((getRegistries() == <span class="keyword">null</span> || getRegistries().isEmpty())</span><br><span class="line">                &amp;&amp; (getProvider() == <span class="keyword">null</span> || getProvider().getRegistries() == <span class="keyword">null</span> || getProvider().getRegistries().isEmpty())</span><br><span class="line">                &amp;&amp; (getApplication() == <span class="keyword">null</span> || getApplication().getRegistries() == <span class="keyword">null</span> || getApplication().getRegistries().isEmpty())) &#123;</span><br><span class="line">            <span class="comment">//从IOC容器中获取RegistryConfig</span></span><br><span class="line">            Map&lt;String, RegistryConfig&gt; registryConfigMap = applicationContext == <span class="keyword">null</span> ? <span class="keyword">null</span> : BeanFactoryUtils.beansOfTypeIncludingAncestors(applicationContext, RegistryConfig.class, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (registryConfigMap != <span class="keyword">null</span> &amp;&amp; registryConfigMap.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                List&lt;RegistryConfig&gt; registryConfigs = <span class="keyword">new</span> ArrayList&lt;RegistryConfig&gt;();</span><br><span class="line">                <span class="comment">//遍历registry列表，从中找到default属性为null或者为true的registry，并保存起来</span></span><br><span class="line">                <span class="keyword">for</span> (RegistryConfig config : registryConfigMap.values()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (config.isDefault() == <span class="keyword">null</span> || config.isDefault().booleanValue()) &#123;</span><br><span class="line">                        registryConfigs.add(config);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (registryConfigs != <span class="keyword">null</span> &amp;&amp; !registryConfigs.isEmpty()) &#123;</span><br><span class="line">                    <span class="keyword">super</span>.setRegistries(registryConfigs);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (getMonitor() == <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; (getProvider() == <span class="keyword">null</span> || getProvider().getMonitor() == <span class="keyword">null</span>)</span><br><span class="line">                &amp;&amp; (getApplication() == <span class="keyword">null</span> || getApplication().getMonitor() == <span class="keyword">null</span>)) &#123;</span><br><span class="line">            Map&lt;String, MonitorConfig&gt; monitorConfigMap = applicationContext == <span class="keyword">null</span> ? <span class="keyword">null</span> : BeanFactoryUtils.beansOfTypeIncludingAncestors(applicationContext, MonitorConfig.class, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (monitorConfigMap != <span class="keyword">null</span> &amp;&amp; monitorConfigMap.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                MonitorConfig monitorConfig = <span class="keyword">null</span>;</span><br><span class="line">                <span class="comment">//检测是否存在重复的monitor配置(default属性为空或者为true)</span></span><br><span class="line">                <span class="keyword">for</span> (MonitorConfig config : monitorConfigMap.values()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (config.isDefault() == <span class="keyword">null</span> || config.isDefault().booleanValue()) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (monitorConfig != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Duplicate monitor configs: "</span> + monitorConfig + <span class="string">" and "</span> + config);</span><br><span class="line">                        &#125;</span><br><span class="line">                        monitorConfig = config;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (monitorConfig != <span class="keyword">null</span>) &#123;</span><br><span class="line">		    <span class="comment">//设置monitor</span></span><br><span class="line">                    setMonitor(monitorConfig);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((getProtocols() == <span class="keyword">null</span> || getProtocols().isEmpty())</span><br><span class="line">                &amp;&amp; (getProvider() == <span class="keyword">null</span> || getProvider().getProtocols() == <span class="keyword">null</span> || getProvider().getProtocols().isEmpty())) &#123;</span><br><span class="line">            <span class="comment">//从IOC容器中获取ProtocolConfig</span></span><br><span class="line">            Map&lt;String, ProtocolConfig&gt; protocolConfigMap = applicationContext == <span class="keyword">null</span> ? <span class="keyword">null</span> : BeanFactoryUtils.beansOfTypeIncludingAncestors(applicationContext, ProtocolConfig.class, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (protocolConfigMap != <span class="keyword">null</span> &amp;&amp; protocolConfigMap.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                List&lt;ProtocolConfig&gt; protocolConfigs = <span class="keyword">new</span> ArrayList&lt;ProtocolConfig&gt;();</span><br><span class="line">                <span class="comment">//遍历Protocol列表，从中找到default属性为空，或者为true的Protocol，并保存起来</span></span><br><span class="line">                <span class="keyword">for</span> (ProtocolConfig config : protocolConfigMap.values()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (config.isDefault() == <span class="keyword">null</span> || config.isDefault().booleanValue()) &#123;</span><br><span class="line">                        protocolConfigs.add(config);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (protocolConfigs != <span class="keyword">null</span> &amp;&amp; !protocolConfigs.isEmpty()) &#123;</span><br><span class="line">                    <span class="keyword">super</span>.setProtocols(protocolConfigs);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (getPath() == <span class="keyword">null</span> || getPath().length() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//path服务名称为空的话</span></span><br><span class="line">            <span class="keyword">if</span> (beanName != <span class="keyword">null</span> &amp;&amp; beanName.length() &gt; <span class="number">0</span></span><br><span class="line">                    &amp;&amp; getInterface() != <span class="keyword">null</span> &amp;&amp; getInterface().length() &gt; <span class="number">0</span></span><br><span class="line">                    &amp;&amp; beanName.startsWith(getInterface())) &#123;</span><br><span class="line">                <span class="comment">//使用beanName作为服务名称</span></span><br><span class="line">                setPath(beanName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!isDelay()) &#123;</span><br><span class="line">            <span class="comment">//配置了delay属性，暴露服务(后面会分析该方法)</span></span><br><span class="line">            export();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// This will only be called for singleton scope bean, and expected to be called by spring shutdown hook when BeanFactory/ApplicationContext destroys.</span></span><br><span class="line">        <span class="comment">// We will guarantee dubbo related resources being released with dubbo shutdown hook.</span></span><br><span class="line">        <span class="comment">//unexport();</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// merged from dubbox</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Class <span class="title">getServiceClass</span><span class="params">(T ref)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (AopUtils.isAopProxy(ref)) &#123;</span><br><span class="line">            <span class="comment">//从Aop代理类中获取到目标对象</span></span><br><span class="line">            <span class="keyword">return</span> AopUtils.getTargetClass(ref);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.getServiceClass(ref);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h6 id="export方法"><a href="#export方法" class="headerlink" title="export方法"></a>export方法</h6><p>export方法是定义在ServiceBean的父类ServiceConfig中的<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">export</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (provider != <span class="keyword">null</span>) &#123;</span><br><span class="line">	    <span class="keyword">if</span> (export == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="comment">//export属性为空的话，则获取provider中的export属性</span></span><br><span class="line">		export = provider.getExport();</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">if</span> (delay == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="comment">//delay属性为空的话，则获取provider中的delay属性</span></span><br><span class="line">		delay = provider.getDelay();</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (export != <span class="keyword">null</span> &amp;&amp; !export) &#123;</span><br><span class="line">	    <span class="comment">//如果不暴露服务，直接返回</span></span><br><span class="line">	    <span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (delay != <span class="keyword">null</span> &amp;&amp; delay &gt; <span class="number">0</span>) &#123;</span><br><span class="line">	    <span class="comment">//delay大于0的话，会启动线程，延迟暴露服务</span></span><br><span class="line">	    delayExportExecutor.schedule(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		    doExport();</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125;, delay, TimeUnit.MILLISECONDS);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	    <span class="comment">//直接暴露服务</span></span><br><span class="line">	    doExport();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到最终会调用doExport方法进行服务暴露<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">doExport</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (unexported) &#123;</span><br><span class="line">	    <span class="comment">//检测是否已经取消服务暴露</span></span><br><span class="line">	    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Already unexported!"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (exported) &#123;</span><br><span class="line">	    <span class="comment">//已经暴露过服务，直接返回</span></span><br><span class="line">	    <span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	exported = <span class="keyword">true</span>;</span><br><span class="line">	<span class="comment">//检查服务接口interface属性是否配置</span></span><br><span class="line">	<span class="keyword">if</span> (interfaceName == <span class="keyword">null</span> || interfaceName.length() == <span class="number">0</span>) &#123;</span><br><span class="line">	    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"&lt;dubbo:service interface=\"\" /&gt; interface not allow null!"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//检测ProviderConfig是否已配置，没有配置则进行配置(此方法在"Dubbo源码阅读之集成Spring(03)"中介绍过)</span></span><br><span class="line">	checkDefault();</span><br><span class="line">	<span class="keyword">if</span> (provider != <span class="keyword">null</span>) &#123;</span><br><span class="line">	    <span class="comment">//从provider中获取缺失的配置</span></span><br><span class="line">	    <span class="keyword">if</span> (application == <span class="keyword">null</span>) &#123;</span><br><span class="line">		application = provider.getApplication();</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">if</span> (<span class="keyword">module</span> == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">module</span> = provider.getModule();</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">if</span> (registries == <span class="keyword">null</span>) &#123;</span><br><span class="line">		registries = provider.getRegistries();</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">if</span> (monitor == <span class="keyword">null</span>) &#123;</span><br><span class="line">		monitor = provider.getMonitor();</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">if</span> (protocols == <span class="keyword">null</span>) &#123;</span><br><span class="line">		protocols = provider.getProtocols();</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">module</span> != <span class="keyword">null</span>) &#123;</span><br><span class="line">	    <span class="comment">//从module中获取注册中心和监控中心</span></span><br><span class="line">	    <span class="keyword">if</span> (registries == <span class="keyword">null</span>) &#123;</span><br><span class="line">		registries = <span class="keyword">module</span>.getRegistries();</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">if</span> (monitor == <span class="keyword">null</span>) &#123;</span><br><span class="line">		monitor = <span class="keyword">module</span>.getMonitor();</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (application != <span class="keyword">null</span>) &#123;</span><br><span class="line">	    <span class="comment">//从application中获取注册中心和监控中心</span></span><br><span class="line">	    <span class="keyword">if</span> (registries == <span class="keyword">null</span>) &#123;</span><br><span class="line">		registries = application.getRegistries();</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">if</span> (monitor == <span class="keyword">null</span>) &#123;</span><br><span class="line">		monitor = application.getMonitor();</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//获取服务接口类interfaceClass</span></span><br><span class="line">	<span class="keyword">if</span> (ref <span class="keyword">instanceof</span> GenericService) &#123;</span><br><span class="line">	    <span class="comment">//服务接口为GenericService类型</span></span><br><span class="line">	    interfaceClass = GenericService.class;</span><br><span class="line">	    <span class="keyword">if</span> (StringUtils.isEmpty(generic)) &#123;</span><br><span class="line">		<span class="comment">//generic属性为空的话，则设置为true</span></span><br><span class="line">		generic = Boolean.TRUE.toString();</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	    <span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">//加载interfaceName类</span></span><br><span class="line">		interfaceClass = Class.forName(interfaceName, <span class="keyword">true</span>, Thread.currentThread()</span><br><span class="line">			.getContextClassLoader());</span><br><span class="line">	    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e.getMessage(), e);</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="comment">//检测方法列表methods是否都在接口interfaceClass中存在</span></span><br><span class="line">	    checkInterfaceAndMethods(interfaceClass, methods);</span><br><span class="line">	    <span class="comment">//校验ref类(ref不可以为空，并且实现了interfaceClass接口)</span></span><br><span class="line">	    checkRef();</span><br><span class="line">	    <span class="comment">//将generic属性设置成false</span></span><br><span class="line">	    generic = Boolean.FALSE.toString();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//处理服务接口本地实现类</span></span><br><span class="line">	<span class="keyword">if</span> (local != <span class="keyword">null</span>) &#123;</span><br><span class="line">	    <span class="keyword">if</span> (<span class="string">"true"</span>.equals(local)) &#123;</span><br><span class="line">		<span class="comment">//默认情况下，实现类名称为：interfaceName + "Local"</span></span><br><span class="line">		local = interfaceName + <span class="string">"Local"</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	    Class&lt;?&gt; localClass;</span><br><span class="line">	    <span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">//加载实现类</span></span><br><span class="line">		localClass = ClassHelper.forNameWithThreadContextClassLoader(local);</span><br><span class="line">	    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;	</span><br><span class="line">		<span class="comment">//没有找到该实现类</span></span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e.getMessage(), e);</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="comment">//校验服务接口本地实现类是否实现了interfaceClass接口</span></span><br><span class="line">	    <span class="keyword">if</span> (!interfaceClass.isAssignableFrom(localClass)) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The local implementation class "</span> + localClass.getName() + <span class="string">" not implement interface "</span> + interfaceName);</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//处理服务接口本地存根实现类</span></span><br><span class="line">	<span class="keyword">if</span> (stub != <span class="keyword">null</span>) &#123;</span><br><span class="line">	    <span class="keyword">if</span> (<span class="string">"true"</span>.equals(stub)) &#123;</span><br><span class="line">		<span class="comment">//默认情况下，实现类名称为：interfaceName + "Stub"</span></span><br><span class="line">		stub = interfaceName + <span class="string">"Stub"</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	    Class&lt;?&gt; stubClass;</span><br><span class="line">	    <span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">//加载实现类</span></span><br><span class="line">		stubClass = ClassHelper.forNameWithThreadContextClassLoader(stub);</span><br><span class="line">	    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e.getMessage(), e);</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="comment">//校验该存根类是否实现了interfaceClass接口</span></span><br><span class="line">	    <span class="keyword">if</span> (!interfaceClass.isAssignableFrom(stubClass)) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The stub implementation class "</span> + stubClass.getName() + <span class="string">" not implement interface "</span> + interfaceName);</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//检测ApplicationConfig是否为空(会调用appendProperties方法添加属性，该方法在之前博文介绍过)</span></span><br><span class="line">	checkApplication();</span><br><span class="line">	<span class="comment">//检测注册中心list是否为空(从配置文件中获取dubbo.registry.address属性，然后创建RegistryConfig对象，添加属性，放入到list中)</span></span><br><span class="line">	checkRegistry();</span><br><span class="line">	<span class="comment">//检测协议protocols是否为空，如果为空且provider不为空，则先从provider对象中获取</span></span><br><span class="line">	<span class="comment">//然后遍历protocols，处理name(name为空，则设置为dubbo)并添加属性。</span></span><br><span class="line">	checkProtocol();</span><br><span class="line">	<span class="comment">//为ServiceBean对象添加属性</span></span><br><span class="line">	appendProperties(<span class="keyword">this</span>);</span><br><span class="line">	<span class="comment">//检测local/stub/mock配置是否正确</span></span><br><span class="line">	<span class="comment">//local/stub/mock(mock 可配置为"return ")应该为interfaceClass或者为interfaceClass子类</span></span><br><span class="line">	checkStubAndMock(interfaceClass);</span><br><span class="line">	<span class="comment">//服务名称path为空的话，则设置为interfaceName</span></span><br><span class="line">	<span class="keyword">if</span> (path == <span class="keyword">null</span> || path.length() == <span class="number">0</span>) &#123;</span><br><span class="line">	    path = interfaceName;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//暴露url(后面会分析该方法)</span></span><br><span class="line">	doExportUrls();</span><br><span class="line">	<span class="comment">//根据服务唯一名称、当前ServiceBean实例、ref 创建ProviderModel实例(后面会分析)</span></span><br><span class="line">	ProviderModel providerModel = <span class="keyword">new</span> ProviderModel(getUniqueServiceName(), <span class="keyword">this</span>, ref);</span><br><span class="line">	<span class="comment">//根据服务唯一名称，注册提供者服务，即放到类ApplicationModel中的变量名为providedServices的map中</span></span><br><span class="line">	ApplicationModel.initProviderModel(getUniqueServiceName(), providerModel);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h6 id="doExportUrls方法"><a href="#doExportUrls方法" class="headerlink" title="doExportUrls方法"></a>doExportUrls方法</h6><p>该方法内部会调用loadRegistries方法构造注册中心url地址，然后调用doExportUrlsFor1Protocol方法进行服务url的暴露。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 暴露url</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment">private void doExportUrls() &#123;</span></span><br><span class="line"><span class="comment">	//构造注册中心地址(后面会分析该方法)</span></span><br><span class="line"><span class="comment">	//例如：registry://224.5.6.7:1234/com.alibaba.dubbo.registry.RegistryService?application=demo-provider&amp;dubbo=2.0.0&amp;pid=6384&amp;qos.port=22222&amp;registry=multicast&amp;timestamp=1528347455956</span></span><br><span class="line"><span class="comment">	List&lt;URL&gt; registryURLs = loadRegistries(true);</span></span><br><span class="line"><span class="comment">	</span></span><br><span class="line"><span class="comment">	//例如：&lt;dubbo:protocol name="dubbo" port="20880" id="dubbo" /&gt;</span></span><br><span class="line"><span class="comment">	for (ProtocolConfig protocolConfig : protocols) &#123;</span></span><br><span class="line"><span class="comment">	    //暴露服务url	</span></span><br><span class="line"><span class="comment">	    doExportUrlsFor1Protocol(protocolConfig, registryURLs);</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 构造注册中心URL</span></span><br><span class="line"><span class="comment"> * 优先使用系统配置中的注册中心列表，如果没有配置，则使用RegistryConfig中配置的</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> provider 是否是提供者</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> List&lt;URL&gt; <span class="title">loadRegistries</span><span class="params">(<span class="keyword">boolean</span> provider)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//检测registries变量(即ArrayList&lt;RegistryConfig&gt;。&lt;dubbo:registry address="..." /&gt;）</span></span><br><span class="line">	checkRegistry();</span><br><span class="line">	List&lt;URL&gt; registryList = <span class="keyword">new</span> ArrayList&lt;URL&gt;();</span><br><span class="line">	<span class="comment">//遍历registries</span></span><br><span class="line">	<span class="keyword">if</span> (registries != <span class="keyword">null</span> &amp;&amp; !registries.isEmpty()) &#123;</span><br><span class="line">	    <span class="keyword">for</span> (RegistryConfig config : registries) &#123;</span><br><span class="line">		<span class="comment">//获取当前注册中心地址</span></span><br><span class="line">		String address = config.getAddress();</span><br><span class="line">		<span class="keyword">if</span> (address == <span class="keyword">null</span> || address.length() == <span class="number">0</span>) &#123;</span><br><span class="line">		    <span class="comment">//将address设置为*</span></span><br><span class="line">		    address = Constants.ANYHOST_VALUE;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//从系统属性中获取注册中心地址</span></span><br><span class="line">		String sysaddress = System.getProperty(<span class="string">"dubbo.registry.address"</span>);</span><br><span class="line">		<span class="keyword">if</span> (sysaddress != <span class="keyword">null</span> &amp;&amp; sysaddress.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		    <span class="comment">//如果系统注册中心地址不为空，则优先使用系统注册中心地址</span></span><br><span class="line">		    address = sysaddress;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (address != <span class="keyword">null</span> &amp;&amp; address.length() &gt; <span class="number">0</span></span><br><span class="line">			&amp;&amp; !RegistryConfig.NO_AVAILABLE.equalsIgnoreCase(address)) &#123;</span><br><span class="line">		    <span class="comment">//地址可用</span></span><br><span class="line"></span><br><span class="line">		    Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">		    <span class="comment">//附加参数，即找到application、config类中的属性，并添加到map中</span></span><br><span class="line">		    appendParameters(map, application);</span><br><span class="line">		    appendParameters(map, config);</span><br><span class="line">		    <span class="comment">//添加服务名称</span></span><br><span class="line">		    map.put(<span class="string">"path"</span>, RegistryService.class.getName());</span><br><span class="line">		    <span class="comment">//添加dubbo版本</span></span><br><span class="line">		    map.put(<span class="string">"dubbo"</span>, Version.getVersion());</span><br><span class="line">		    <span class="comment">//添加时间戳</span></span><br><span class="line">		    map.put(Constants.TIMESTAMP_KEY, String.valueOf(System.currentTimeMillis()));</span><br><span class="line">		    <span class="keyword">if</span> (ConfigUtils.getPid() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="comment">//添加pid</span></span><br><span class="line">			map.put(Constants.PID_KEY, String.valueOf(ConfigUtils.getPid()));</span><br><span class="line">		    &#125;</span><br><span class="line">		    <span class="comment">//添加protocol</span></span><br><span class="line">		    <span class="keyword">if</span> (!map.containsKey(<span class="string">"protocol"</span>)) &#123;</span><br><span class="line">			<span class="comment">//存在扩展名称为remote的RegistryFactory，则设置protocol属性为remote，否则设置为dubbo</span></span><br><span class="line">			<span class="keyword">if</span> (ExtensionLoader.getExtensionLoader(RegistryFactory.class).hasExtension(<span class="string">"remote"</span>)) &#123;</span><br><span class="line">			    map.put(<span class="string">"protocol"</span>, <span class="string">"remote"</span>);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			    map.put(<span class="string">"protocol"</span>, <span class="string">"dubbo"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		    &#125;</span><br><span class="line">		    <span class="comment">//根据当前注册中心地址和map生产url列表（后面会分析该方法）</span></span><br><span class="line">		    List&lt;URL&gt; urls = UrlUtils.parseURLs(address, map);</span><br><span class="line">		    <span class="keyword">for</span> (URL url : urls) &#123;</span><br><span class="line">			<span class="comment">//向url中添加registry参数，参数值为url的protocol属性(例如：registry=multicast)</span></span><br><span class="line">			url = url.addParameter(Constants.REGISTRY_KEY, url.getProtocol());</span><br><span class="line">			<span class="comment">//重新设置url的protocol属性值为“registry”(后面暴露服务时，将会使用该protocol属性值作为扩展名称，获取对应的Protocol实例，因此将会使用RegistryProtocol实例，下一节会详细分析)</span></span><br><span class="line">			url = url.setProtocol(Constants.REGISTRY_PROTOCOL);</span><br><span class="line">			<span class="keyword">if</span> ((provider &amp;&amp; url.getParameter(Constants.REGISTER_KEY, <span class="keyword">true</span>))</span><br><span class="line">				|| (!provider &amp;&amp; url.getParameter(Constants.SUBSCRIBE_KEY, <span class="keyword">true</span>))) &#123;</span><br><span class="line">			    <span class="comment">//提供者 &amp;&amp; url中的register参数值为true</span></span><br><span class="line">			    <span class="comment">//不是提供者 &amp;&amp; url中的subscribe参数值为true</span></span><br><span class="line">			    <span class="comment">//则将该url添加到registryList列表中</span></span><br><span class="line">			    registryList.add(url);</span><br><span class="line">			&#125;</span><br><span class="line">		    &#125;</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> registryList;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> address 注册中心地址列表("|"或者";"分隔)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> defaults map参数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;URL&gt; <span class="title">parseURLs</span><span class="params">(String address, Map&lt;String, String&gt; defaults)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (address == <span class="keyword">null</span> || address.length() == <span class="number">0</span>) &#123;</span><br><span class="line">	    <span class="comment">//注册中心地址为空，返回null</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//通过“|”或者“;”分隔注册中心地址</span></span><br><span class="line">        String[] addresses = Constants.REGISTRY_SPLIT_PATTERN.split(address);</span><br><span class="line">        <span class="keyword">if</span> (addresses == <span class="keyword">null</span> || addresses.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;URL&gt; registries = <span class="keyword">new</span> ArrayList&lt;URL&gt;();</span><br><span class="line">	<span class="comment">//遍历每一个注册中心地址</span></span><br><span class="line">        <span class="keyword">for</span> (String addr : addresses) &#123;</span><br><span class="line">            <span class="comment">//通过注册中心地址addr和map参数构造注册中心URL对象（后面会分析方法）</span></span><br><span class="line">            registries.add(parseURL(addr, defaults));</span><br><span class="line">        &#125;</span><br><span class="line">	<span class="comment">//返回注册中心地址url列表</span></span><br><span class="line">        <span class="keyword">return</span> registries;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 生成注册中心URL</span></span><br><span class="line"><span class="comment"> * 1、根据注册中心地址address生成url字符串(处理备用地址)</span></span><br><span class="line"><span class="comment"> * 2、从defaults集合中获取属性(protocol、username、password、port、path)默认值</span></span><br><span class="line"><span class="comment"> * 3、根据defaults新生成集合defaultParameters，并移除(protocol、username、password、port、path)属性</span></span><br><span class="line"><span class="comment"> * 4、根据url字符串生成URL对象，并获取该URL对象的属性值(protocol、username、password、port、path、parameters),</span></span><br><span class="line"><span class="comment"> *    其中parameters属性值是新生成的一个map。</span></span><br><span class="line"><span class="comment"> * 5、判断URL对象的这些属性值(protocol、username、password、port、path、parameters)是否为空，如果为空，则使用属性默认值，并标识发生了改变。</span></span><br><span class="line"><span class="comment"> * 6、如果发生了改变。则根据新的属性值重新生成一个URL对象并返回。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> address 注册中心地址(可能是多个，使用","分隔)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> defaults map参数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> URL <span class="title">parseURL</span><span class="params">(String address, Map&lt;String, String&gt; defaults)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (address == <span class="keyword">null</span> || address.length() == <span class="number">0</span>) &#123;</span><br><span class="line">	    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//该url最终会被解析成URL对象</span></span><br><span class="line">	String url;</span><br><span class="line">	<span class="keyword">if</span> (address.indexOf(<span class="string">"://"</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">	    <span class="comment">//该注册中心地址包含"://"</span></span><br><span class="line">	    url = address;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	    <span class="comment">//使用逗号","分隔address地址</span></span><br><span class="line">	    String[] addresses = Constants.COMMA_SPLIT_PATTERN.split(address);</span><br><span class="line">	    <span class="comment">//将addresses数组第1个元素赋值给url</span></span><br><span class="line">	    url = addresses[<span class="number">0</span>];</span><br><span class="line">	    <span class="keyword">if</span> (addresses.length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">		<span class="comment">//遍历addresses数组后面的元素(即查看是否存在备用的注册中心地址)</span></span><br><span class="line">		<span class="comment">//backup记录注册中心备用地址</span></span><br><span class="line">		StringBuilder backup = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; addresses.length; i++) &#123;</span><br><span class="line">		    <span class="keyword">if</span> (i &gt; <span class="number">1</span>) &#123;</span><br><span class="line">			backup.append(<span class="string">","</span>);</span><br><span class="line">		    &#125;</span><br><span class="line">		    backup.append(addresses[i]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//将注册中心备用地址添加到url的backup参数中</span></span><br><span class="line">		url += <span class="string">"?"</span> + Constants.BACKUP_KEY + <span class="string">"="</span> + backup.toString();</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//从defaults中获取protocol属性</span></span><br><span class="line">	String defaultProtocol = defaults == <span class="keyword">null</span> ? <span class="keyword">null</span> : defaults.get(<span class="string">"protocol"</span>);</span><br><span class="line">	<span class="keyword">if</span> (defaultProtocol == <span class="keyword">null</span> || defaultProtocol.length() == <span class="number">0</span>) &#123;</span><br><span class="line">	    <span class="comment">//如果protocol属性值为空，则设置为dubbo</span></span><br><span class="line">	    defaultProtocol = <span class="string">"dubbo"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//从defaults中获取username属性和password属性</span></span><br><span class="line">	String defaultUsername = defaults == <span class="keyword">null</span> ? <span class="keyword">null</span> : defaults.get(<span class="string">"username"</span>);</span><br><span class="line">	String defaultPassword = defaults == <span class="keyword">null</span> ? <span class="keyword">null</span> : defaults.get(<span class="string">"password"</span>);</span><br><span class="line">	<span class="comment">//从defaults中获取port属性</span></span><br><span class="line">	<span class="keyword">int</span> defaultPort = StringUtils.parseInteger(defaults == <span class="keyword">null</span> ? <span class="keyword">null</span> : defaults.get(<span class="string">"port"</span>));</span><br><span class="line">	<span class="comment">//从defaults中获取path属性</span></span><br><span class="line">	String defaultPath = defaults == <span class="keyword">null</span> ? <span class="keyword">null</span> : defaults.get(<span class="string">"path"</span>);</span><br><span class="line">	<span class="comment">//根据defaults新生成一个map集合defaultParameters</span></span><br><span class="line">	Map&lt;String, String&gt; defaultParameters = defaults == <span class="keyword">null</span> ? <span class="keyword">null</span> : <span class="keyword">new</span> HashMap&lt;String, String&gt;(defaults);</span><br><span class="line">	<span class="keyword">if</span> (defaultParameters != <span class="keyword">null</span>) &#123;</span><br><span class="line">	    <span class="comment">//移除defaultParameters集合中的以下属性</span></span><br><span class="line">	    defaultParameters.remove(<span class="string">"protocol"</span>);</span><br><span class="line">	    defaultParameters.remove(<span class="string">"username"</span>);</span><br><span class="line">	    defaultParameters.remove(<span class="string">"password"</span>);</span><br><span class="line">	    defaultParameters.remove(<span class="string">"host"</span>);</span><br><span class="line">	    defaultParameters.remove(<span class="string">"port"</span>);</span><br><span class="line">	    defaultParameters.remove(<span class="string">"path"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//根据url字符串生成URL对象</span></span><br><span class="line">	URL u = URL.valueOf(url);</span><br><span class="line">	<span class="comment">//如果新生成的URL中的某属性值为空，且该属性的默认值不为空，则意味着发生了改变，changed会被设置为true</span></span><br><span class="line">	<span class="keyword">boolean</span> changed = <span class="keyword">false</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//获取URL对象中的protocol、username、password、host、port、path属性</span></span><br><span class="line">	String protocol = u.getProtocol();</span><br><span class="line">	String username = u.getUsername();</span><br><span class="line">	String password = u.getPassword();</span><br><span class="line">	String host = u.getHost();</span><br><span class="line">	<span class="keyword">int</span> port = u.getPort();</span><br><span class="line">	String path = u.getPath();</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//获取URL对象的参数map</span></span><br><span class="line">	Map&lt;String, String&gt; parameters = <span class="keyword">new</span> HashMap&lt;String, String&gt;(u.getParameters());</span><br><span class="line">	<span class="keyword">if</span> ((protocol == <span class="keyword">null</span> || protocol.length() == <span class="number">0</span>) &amp;&amp; defaultProtocol != <span class="keyword">null</span> &amp;&amp; defaultProtocol.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">	    changed = <span class="keyword">true</span>;</span><br><span class="line">	    <span class="comment">//使用protocol默认值设置URL的protocol属性</span></span><br><span class="line">	    protocol = defaultProtocol;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> ((username == <span class="keyword">null</span> || username.length() == <span class="number">0</span>) &amp;&amp; defaultUsername != <span class="keyword">null</span> &amp;&amp; defaultUsername.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">	    changed = <span class="keyword">true</span>;</span><br><span class="line">	    <span class="comment">//使用username默认值设置URL的username属性</span></span><br><span class="line">	    username = defaultUsername;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> ((password == <span class="keyword">null</span> || password.length() == <span class="number">0</span>) &amp;&amp; defaultPassword != <span class="keyword">null</span> &amp;&amp; defaultPassword.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">	    changed = <span class="keyword">true</span>;</span><br><span class="line">	    <span class="comment">//使用password默认值设置URL的password属性</span></span><br><span class="line">	    password = defaultPassword;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/*if (u.isAnyHost() || u.isLocalHost()) &#123;</span></span><br><span class="line"><span class="comment">	    changed = true;</span></span><br><span class="line"><span class="comment">	    host = NetUtils.getLocalHost();</span></span><br><span class="line"><span class="comment">	&#125;*/</span></span><br><span class="line">	<span class="keyword">if</span> (port &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">	    <span class="comment">//URL的port属性值小于0，且默认的port值大于0，则使用defaultPort设置URL的port属性</span></span><br><span class="line">	    <span class="keyword">if</span> (defaultPort &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		changed = <span class="keyword">true</span>;</span><br><span class="line">		port = defaultPort;</span><br><span class="line">	    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">//默认port如果也小于0的话，则设置URL的port属性为9090</span></span><br><span class="line">		changed = <span class="keyword">true</span>;</span><br><span class="line">		port = <span class="number">9090</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (path == <span class="keyword">null</span> || path.length() == <span class="number">0</span>) &#123;</span><br><span class="line">	    <span class="comment">//使用默认服务名称设置URL的path属性</span></span><br><span class="line">	    <span class="keyword">if</span> (defaultPath != <span class="keyword">null</span> &amp;&amp; defaultPath.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		changed = <span class="keyword">true</span>;</span><br><span class="line">		path = defaultPath;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//遍历默认参数集合</span></span><br><span class="line">	<span class="keyword">if</span> (defaultParameters != <span class="keyword">null</span> &amp;&amp; defaultParameters.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">	    <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : defaultParameters.entrySet()) &#123;</span><br><span class="line">		<span class="comment">//默认参数key</span></span><br><span class="line">		String key = entry.getKey();</span><br><span class="line">		<span class="comment">//默认参数值defaultValue</span></span><br><span class="line">		String defaultValue = entry.getValue();</span><br><span class="line">		<span class="keyword">if</span> (defaultValue != <span class="keyword">null</span> &amp;&amp; defaultValue.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		    <span class="comment">//查看URL参数集合中该参数key对应的值</span></span><br><span class="line">		    String value = parameters.get(key);</span><br><span class="line">		    <span class="keyword">if</span> (value == <span class="keyword">null</span> || value.length() == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="comment">//如果URL中的参数值为空，则使用该参数key的默认值defaultValue</span></span><br><span class="line">			changed = <span class="keyword">true</span>;</span><br><span class="line">			parameters.put(key, defaultValue);</span><br><span class="line">		    &#125;</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (changed) &#123;</span><br><span class="line">	    <span class="comment">//当前URL的属性值发送改变了，则重新生成一个URL对象</span></span><br><span class="line">	    u = <span class="keyword">new</span> URL(protocol, username, password, host, port, path, parameters);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> u;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>加载注册中心URL地址的方法分析完了，我们再来看doExportUrlsFor1Protocol方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 暴露服务Url到各个注册中心</span></span><br><span class="line"><span class="comment"> * 1、map装配参数</span></span><br><span class="line"><span class="comment"> * 2、利用map中的参数构建URL，为暴露服务做准备</span></span><br><span class="line"><span class="comment"> * 3、根据范围选择是暴露本地服务，还是暴露远程服务</span></span><br><span class="line"><span class="comment"> * 4、根据代理工厂生成服务代理对象invoker</span></span><br><span class="line"><span class="comment"> * 5、根据配置的协议，暴露服务代理</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> protocolConfig 例如: &lt;dubbo:protocol name="dubbo" port="20880" id="dubbo" /&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> registryURLs 例如: registry://224.5.6.7:1234/com.alibaba.dubbo.registry.RegistryService?application=demo-provider&amp;dubbo=2.0.0&amp;pid=4328&amp;qos.port=22222&amp;registry=multicast&amp;timestamp=1528278313174</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doExportUrlsFor1Protocol</span><span class="params">(ProtocolConfig protocolConfig, List&lt;URL&gt; registryURLs)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//获取协议名称</span></span><br><span class="line">	String name = protocolConfig.getName();</span><br><span class="line">	<span class="keyword">if</span> (name == <span class="keyword">null</span> || name.length() == <span class="number">0</span>) &#123;</span><br><span class="line">	    name = <span class="string">"dubbo"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">	<span class="comment">//添加side参数，值为provider，标识服务提供端</span></span><br><span class="line">	map.put(Constants.SIDE_KEY, Constants.PROVIDER_SIDE);</span><br><span class="line">	<span class="comment">//添加dubbo版本</span></span><br><span class="line">	map.put(Constants.DUBBO_VERSION_KEY, Version.getVersion());</span><br><span class="line">	<span class="comment">//添加时间戳</span></span><br><span class="line">	map.put(Constants.TIMESTAMP_KEY, String.valueOf(System.currentTimeMillis()));</span><br><span class="line">	<span class="keyword">if</span> (ConfigUtils.getPid() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">	    <span class="comment">//添加pid</span></span><br><span class="line">	    map.put(Constants.PID_KEY, String.valueOf(ConfigUtils.getPid()));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//添加参数到map</span></span><br><span class="line">	appendParameters(map, application);</span><br><span class="line">	appendParameters(map, <span class="keyword">module</span>);</span><br><span class="line">	appendParameters(map, provider, Constants.DEFAULT_KEY);</span><br><span class="line">	appendParameters(map, protocolConfig);</span><br><span class="line">	<span class="comment">//当前ServiceConfig(ServiceBean)</span></span><br><span class="line">	appendParameters(map, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (methods != <span class="keyword">null</span> &amp;&amp; !methods.isEmpty()) &#123;</span><br><span class="line">	    <span class="comment">//遍历服务方法</span></span><br><span class="line">	    <span class="keyword">for</span> (MethodConfig method : methods) &#123;</span><br><span class="line">		<span class="comment">//将method的属性添加到map中</span></span><br><span class="line">		appendParameters(map, method, method.getName());</span><br><span class="line">		<span class="comment">//设置方法重试次数(retryKey是map的key)</span></span><br><span class="line">		String retryKey = method.getName() + <span class="string">".retry"</span>;</span><br><span class="line">		<span class="keyword">if</span> (map.containsKey(retryKey)) &#123;</span><br><span class="line">		    String retryValue = map.remove(retryKey);</span><br><span class="line">		    <span class="keyword">if</span> (<span class="string">"false"</span>.equals(retryValue)) &#123;</span><br><span class="line">		        <span class="comment">//retryValue值为false的话，说明不启用重试</span></span><br><span class="line">			map.put(method.getName() + <span class="string">".retries"</span>, <span class="string">"0"</span>);</span><br><span class="line">		    &#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//获取当前服务方法的参数</span></span><br><span class="line">		List&lt;ArgumentConfig&gt; arguments = method.getArguments();</span><br><span class="line">		<span class="keyword">if</span> (arguments != <span class="keyword">null</span> &amp;&amp; !arguments.isEmpty()) &#123;</span><br><span class="line">		    <span class="comment">//遍历当前服务方法的参数配置</span></span><br><span class="line">		    <span class="keyword">for</span> (ArgumentConfig argument : arguments) &#123;</span><br><span class="line">			<span class="keyword">if</span> (argument.getType() != <span class="keyword">null</span> &amp;&amp; argument.getType().length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			    <span class="comment">//遍历服务接口的方法列表</span></span><br><span class="line">			    Method[] methods = interfaceClass.getMethods();</span><br><span class="line">			    <span class="keyword">if</span> (methods != <span class="keyword">null</span> &amp;&amp; methods.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; methods.length; i++) &#123;</span><br><span class="line">				    <span class="comment">//方法名</span></span><br><span class="line">				    String methodName = methods[i].getName();</span><br><span class="line">				    <span class="keyword">if</span> (methodName.equals(method.getName())) &#123;</span><br><span class="line">					<span class="comment">//方法名称一样,获取方法参数类型数组</span></span><br><span class="line">					Class&lt;?&gt;[] argtypes = methods[i].getParameterTypes();</span><br><span class="line">					<span class="comment">// one callback in the method</span></span><br><span class="line">					<span class="keyword">if</span> (argument.getIndex() != -<span class="number">1</span>) &#123;</span><br><span class="line">					    <span class="comment">//校验参数的类型是否匹配</span></span><br><span class="line">					    <span class="keyword">if</span> (argtypes[argument.getIndex()].getName().equals(argument.getType())) &#123;</span><br><span class="line">						<span class="comment">//将方法的参数的属性添加到map，前缀为：方法名.参数索引</span></span><br><span class="line">						appendParameters(map, argument, method.getName() + <span class="string">"."</span> + argument.getIndex());</span><br><span class="line">					    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">						<span class="comment">//参数配置错误，索引和类型不匹配</span></span><br><span class="line">						<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"argument config error : the index attribute and type attribute not match :index :"</span> + argument.getIndex() + <span class="string">", type:"</span> + argument.getType());</span><br><span class="line">					    &#125;</span><br><span class="line">					&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					    <span class="comment">// multiple callbacks in the method</span></span><br><span class="line">					    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; argtypes.length; j++) &#123;</span><br><span class="line">						<span class="comment">//当前参数类型</span></span><br><span class="line">						Class&lt;?&gt; argclazz = argtypes[j];</span><br><span class="line">						<span class="comment">//参数类型名称匹配</span></span><br><span class="line">						<span class="keyword">if</span> (argclazz.getName().equals(argument.getType())) &#123;</span><br><span class="line">						    appendParameters(map, argument, method.getName() + <span class="string">"."</span> + j);</span><br><span class="line">						    <span class="keyword">if</span> (argument.getIndex() != -<span class="number">1</span> &amp;&amp; argument.getIndex() != j) &#123;</span><br><span class="line">							<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"argument config error : the index attribute and type attribute not match :index :"</span> + argument.getIndex() + <span class="string">", type:"</span> + argument.getType());</span><br><span class="line">						    &#125;</span><br><span class="line">						&#125;</span><br><span class="line">					    &#125;</span><br><span class="line">					&#125;</span><br><span class="line">				    &#125;</span><br><span class="line">				&#125;</span><br><span class="line">			    &#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (argument.getIndex() != -<span class="number">1</span>) &#123;</span><br><span class="line">			    appendParameters(map, argument, method.getName() + <span class="string">"."</span> + argument.getIndex());</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			    <span class="comment">//&lt;dubbo:argument index='0' .../&gt; or &lt;dubbo:argument type=xxx .../&gt;</span></span><br><span class="line">			    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"argument config must set index or type attribute.eg: &lt;dubbo:argument index='0' .../&gt; or &lt;dubbo:argument type=xxx .../&gt;"</span>);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		    &#125;</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125; <span class="comment">// end of methods for</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//(generic ！= null) &amp;&amp; (generic = “true” || "nativejava" || "bean") 返回 true</span></span><br><span class="line">	<span class="keyword">if</span> (ProtocolUtils.isGeneric(generic)) &#123;</span><br><span class="line">	    <span class="comment">//添加generic参数</span></span><br><span class="line">	    map.put(Constants.GENERIC_KEY, generic);</span><br><span class="line">	    <span class="comment">//添加methods参数，值为"*"</span></span><br><span class="line">	    map.put(Constants.METHODS_KEY, Constants.ANY_VALUE);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	    String revision = Version.getVersion(interfaceClass, version);</span><br><span class="line">	    <span class="keyword">if</span> (revision != <span class="keyword">null</span> &amp;&amp; revision.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">	        <span class="comment">//添加版本</span></span><br><span class="line">		map.put(<span class="string">"revision"</span>, revision);</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="comment">//生成interfaceClass类的包装类，获取方法名称</span></span><br><span class="line">	    String[] methods = Wrapper.getWrapper(interfaceClass).getMethodNames();</span><br><span class="line">	    <span class="keyword">if</span> (methods.length == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="comment">//服务接口中没有发现方法定义</span></span><br><span class="line">		logger.warn(<span class="string">"NO method found in service interface "</span> + interfaceClass.getName());</span><br><span class="line">		<span class="comment">//添加methods参数，值为"*"</span></span><br><span class="line">		map.put(Constants.METHODS_KEY, Constants.ANY_VALUE);</span><br><span class="line">	    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">//添加methods参数，值为逗号分隔的方法名称</span></span><br><span class="line">		map.put(Constants.METHODS_KEY, StringUtils.join(<span class="keyword">new</span> HashSet&lt;String&gt;(Arrays.asList(methods)), <span class="string">","</span>));</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!ConfigUtils.isEmpty(token)) &#123;</span><br><span class="line">	    <span class="comment">//token为true或者token为default，则isDefault方法返回true</span></span><br><span class="line">	    <span class="keyword">if</span> (ConfigUtils.isDefault(token)) &#123;</span><br><span class="line">		<span class="comment">//添加token参数，值为uuid</span></span><br><span class="line">		map.put(Constants.TOKEN_KEY, UUID.randomUUID().toString());</span><br><span class="line">	    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">//添加token参数</span></span><br><span class="line">		map.put(Constants.TOKEN_KEY, token);</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//判断协议名称是否为"injvm"</span></span><br><span class="line">	<span class="keyword">if</span> (Constants.LOCAL_PROTOCOL.equals(protocolConfig.getName())) &#123;</span><br><span class="line">	    <span class="comment">//本地协议，不注册</span></span><br><span class="line">	    protocolConfig.setRegister(<span class="keyword">false</span>);</span><br><span class="line">	    <span class="comment">//添加notify参数，值为false</span></span><br><span class="line">	    map.put(<span class="string">"notify"</span>, <span class="string">"false"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//暴露服务</span></span><br><span class="line">	<span class="comment">//获取上下文地址</span></span><br><span class="line">	String contextPath = protocolConfig.getContextpath();</span><br><span class="line">	<span class="keyword">if</span> ((contextPath == <span class="keyword">null</span> || contextPath.length() == <span class="number">0</span>) &amp;&amp; provider != <span class="keyword">null</span>) &#123;</span><br><span class="line">	    <span class="comment">//获取provider对象配置的上下文地址</span></span><br><span class="line">	    contextPath = provider.getContextpath();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//获取注册ip(后面会分析该方法)</span></span><br><span class="line">	String host = <span class="keyword">this</span>.findConfigedHosts(protocolConfig, registryURLs, map);</span><br><span class="line">	<span class="comment">//获取注册端口(后面会分析该方法)</span></span><br><span class="line">	Integer port = <span class="keyword">this</span>.findConfigedPorts(protocolConfig, name, map);</span><br><span class="line">	<span class="comment">//根据协议名称name、主机host、端口port、上下文、map参数构建URL对象(服务暴露的url地址)</span></span><br><span class="line">	<span class="comment">//例如url：dubbo://192.168.99.60:20880/com.alibaba.dubbo.demo.DemoService?anyhost=true&amp;application=demo-provider&amp;bind.ip=192.168.99.60&amp;bind.port=20880&amp;dubbo=2.0.0&amp;generic=false&amp;interface=com.alibaba.dubbo.demo.DemoService&amp;methods=sayHello&amp;pid=7184&amp;qos.port=22222&amp;side=provider&amp;timestamp=1528347825839</span></span><br><span class="line">	URL url = <span class="keyword">new</span> URL(name, host, port, (contextPath == <span class="keyword">null</span> || contextPath.length() == <span class="number">0</span> ? <span class="string">""</span> : contextPath + <span class="string">"/"</span>) + path, map);</span><br><span class="line">	<span class="comment">//查看ConfiguratorFactory(override/absent)是否存在url.getProtocol()扩展，存在的话，则配置该url对象</span></span><br><span class="line">	<span class="comment">//override会覆盖参数配置，absent只有参数不存在时才会添加(后面的章节会介绍该扩展)</span></span><br><span class="line">	<span class="keyword">if</span> (ExtensionLoader.getExtensionLoader(ConfiguratorFactory.class).hasExtension(url.getProtocol())) &#123;</span><br><span class="line">	    url = ExtensionLoader.getExtensionLoader(ConfiguratorFactory.class)</span><br><span class="line">		    .getExtension(url.getProtocol()).getConfigurator(url).configure(url);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//获取url的scope参数</span></span><br><span class="line">	String scope = url.getParameter(Constants.SCOPE_KEY);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//只有scope != none 时才会暴露服务，scope = null时会同时暴露本地服务和远程服务</span></span><br><span class="line">	<span class="keyword">if</span> (!Constants.SCOPE_NONE.toString().equalsIgnoreCase(scope)) &#123;</span><br><span class="line">	    <span class="comment">//scope != remote 暴露本地服务</span></span><br><span class="line">	    <span class="keyword">if</span> (!Constants.SCOPE_REMOTE.toString().equalsIgnoreCase(scope)) &#123;</span><br><span class="line">		<span class="comment">//本地暴露(后面小节会分析该方法)</span></span><br><span class="line">		exportLocal(url);</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">if</span> (!Constants.SCOPE_LOCAL.toString().equalsIgnoreCase(scope)) &#123;</span><br><span class="line">	         <span class="comment">//scope != local 暴露到远程</span></span><br><span class="line">		<span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">		    <span class="comment">//暴露dubbo服务interfaceClass到url</span></span><br><span class="line">		    logger.info(<span class="string">"Export dubbo service "</span> + interfaceClass.getName() + <span class="string">" to url "</span> + url);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (registryURLs != <span class="keyword">null</span> &amp;&amp; !registryURLs.isEmpty()) &#123;</span><br><span class="line">		    <span class="comment">//注册中心地址registryURLs不为空，则遍历注册中心地址，将服务暴露到各个注册中心</span></span><br><span class="line">		    <span class="keyword">for</span> (URL registryURL : registryURLs) &#123;</span><br><span class="line">			</span><br><span class="line">			<span class="comment">//添加dynamic参数到url中，参数值从当前注册中心的参数中获取</span></span><br><span class="line">			url = url.addParameterIfAbsent(Constants.DYNAMIC_KEY, registryURL.getParameter(Constants.DYNAMIC_KEY));</span><br><span class="line">			</span><br><span class="line">			<span class="comment">//构造监控url(后面会分析该方法)</span></span><br><span class="line">			URL monitorUrl = loadMonitor(registryURL);</span><br><span class="line">			<span class="keyword">if</span> (monitorUrl != <span class="keyword">null</span>) &#123;</span><br><span class="line">			    <span class="comment">//添加monitor参数(编码)到url中</span></span><br><span class="line">			    url = url.addParameterAndEncoded(Constants.MONITOR_KEY, monitorUrl.toFullString());</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">			    <span class="comment">//注册dubbo服务 interfaceClass的url 到注册中心registryURL上</span></span><br><span class="line">			    logger.info(<span class="string">"Register dubbo service "</span> + interfaceClass.getName() + <span class="string">" url "</span> + url + <span class="string">" to registry "</span> + registryURL);</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="comment">//registryURL地址上添加export参数，参数值为服务暴露的url(即interfaceClass的url)</span></span><br><span class="line">			<span class="comment">//根据ref、interfaceClass、registryURL创建服务代理对象Invoker(后面小节会分析该方法)</span></span><br><span class="line">			Invoker&lt;?&gt; invoker = proxyFactory.getInvoker(ref, (Class) interfaceClass, registryURL.addParameterAndEncoded(Constants.EXPORT_KEY, url.toFullString()));</span><br><span class="line">			</span><br><span class="line">			<span class="comment">//将invoker和当前对象this包装成DelegateProviderMetaDataInvoker对象(后面小节会分析该方法)</span></span><br><span class="line">			DelegateProviderMetaDataInvoker wrapperInvoker = <span class="keyword">new</span> DelegateProviderMetaDataInvoker(invoker, <span class="keyword">this</span>);</span><br><span class="line">			</span><br><span class="line">			<span class="comment">//在此处开始暴露服务</span></span><br><span class="line">			<span class="comment">//调用export方法暴露服务，得到exporter对象(后面小节会分析该方法)</span></span><br><span class="line">			Exporter&lt;?&gt; exporter = protocol.export(wrapperInvoker);</span><br><span class="line">			<span class="comment">//保存暴露的服务到本地变量exporters中</span></span><br><span class="line">			exporters.add(exporter);</span><br><span class="line">		    &#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		    <span class="comment">//注册中心地址registryURLs为空</span></span><br><span class="line">		    Invoker&lt;?&gt; invoker = proxyFactory.getInvoker(ref, (Class) interfaceClass, url);</span><br><span class="line">		    DelegateProviderMetaDataInvoker wrapperInvoker = <span class="keyword">new</span> DelegateProviderMetaDataInvoker(invoker, <span class="keyword">this</span>);</span><br><span class="line">		    Exporter&lt;?&gt; exporter = protocol.export(wrapperInvoker);</span><br><span class="line">		    exporters.add(exporter);</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//保存暴露的服务url</span></span><br><span class="line">	<span class="keyword">this</span>.urls.add(url);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们依次看下上面用到的方法: findConfigedHosts、findConfigedPorts、loadMonitor<br>exportLocal、getInvoker、export方法将在后面的章节(Dubbo源码阅读之服务暴露)进行详细介绍。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 为服务提供者 获取注册ip和绑定ip，可以单独配置</span></span><br><span class="line"><span class="comment"> * Register &amp; bind IP address for service provider, can be configured separately.</span></span><br><span class="line"><span class="comment"> * Configuration priority:</span></span><br><span class="line"><span class="comment"> * environment variables -&gt; java system properties -&gt; host property in config file -&gt;</span></span><br><span class="line"><span class="comment"> * /etc/hosts -&gt; default network address -&gt; first available network address</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> protocolConfig</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> registryURLs</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> map</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 注册ip</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">findConfigedHosts</span><span class="params">(ProtocolConfig protocolConfig, List&lt;URL&gt; registryURLs, Map&lt;String, String&gt; map)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">boolean</span> anyhost = <span class="keyword">false</span>;</span><br><span class="line">	<span class="comment">//从系统配置中获取获取绑定ip</span></span><br><span class="line">	String hostToBind = getValueFromConfig(protocolConfig, Constants.DUBBO_IP_TO_BIND);</span><br><span class="line">	<span class="keyword">if</span> (hostToBind != <span class="keyword">null</span> &amp;&amp; hostToBind.length() &gt; <span class="number">0</span> &amp;&amp; isInvalidLocalHost(hostToBind)) &#123;</span><br><span class="line">	    <span class="comment">//无效的ip</span></span><br><span class="line">	    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Specified invalid bind ip from property:"</span> + Constants.DUBBO_IP_TO_BIND + <span class="string">", value:"</span> + hostToBind);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (hostToBind == <span class="keyword">null</span> || hostToBind.length() == <span class="number">0</span>) &#123;</span><br><span class="line">	    <span class="comment">//从协议配置中获取服务ip地址</span></span><br><span class="line">	    hostToBind = protocolConfig.getHost();</span><br><span class="line">	    <span class="keyword">if</span> (provider != <span class="keyword">null</span> &amp;&amp; (hostToBind == <span class="keyword">null</span> || hostToBind.length() == <span class="number">0</span>)) &#123;</span><br><span class="line">		<span class="comment">//从服务提供者中获取服务ip地址</span></span><br><span class="line">		hostToBind = provider.getHost();</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">if</span> (isInvalidLocalHost(hostToBind)) &#123;</span><br><span class="line">		<span class="comment">//仍然是无效的地址，则设置anyhost=true</span></span><br><span class="line">		anyhost = <span class="keyword">true</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">		    <span class="comment">//获取本地地址</span></span><br><span class="line">		    hostToBind = InetAddress.getLocalHost().getHostAddress();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">		    logger.warn(e.getMessage(), e);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (isInvalidLocalHost(hostToBind)) &#123;</span><br><span class="line">		    <span class="comment">//仍然是无效的地址，遍历注册中心url列表</span></span><br><span class="line">		    <span class="keyword">if</span> (registryURLs != <span class="keyword">null</span> &amp;&amp; !registryURLs.isEmpty()) &#123;</span><br><span class="line">			<span class="keyword">for</span> (URL registryURL : registryURLs) &#123;</span><br><span class="line">			    <span class="keyword">if</span> (Constants.MULTICAST.equalsIgnoreCase(registryURL.getParameter(<span class="string">"registry"</span>))) &#123;</span><br><span class="line">				<span class="comment">// 跳过组播registry，因为我们不可以通过Socket连接到它</span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			    &#125;</span><br><span class="line">			    <span class="keyword">try</span> &#123;</span><br><span class="line">				Socket socket = <span class="keyword">new</span> Socket();</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">				    <span class="comment">//根据注册中心host和port构建SocketAddress</span></span><br><span class="line">				    SocketAddress addr = <span class="keyword">new</span> InetSocketAddress(registryURL.getHost(), registryURL.getPort());</span><br><span class="line">				    <span class="comment">//连接到该地址</span></span><br><span class="line">				    socket.connect(addr, <span class="number">1000</span>);</span><br><span class="line">				    <span class="comment">//连接成功的话，则获取到绑定地址，并跳出循环</span></span><br><span class="line">				    hostToBind = socket.getLocalAddress().getHostAddress();</span><br><span class="line">				    <span class="keyword">break</span>;</span><br><span class="line">				&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">				    <span class="keyword">try</span> &#123;</span><br><span class="line">					socket.close();</span><br><span class="line">				    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">				    &#125;</span><br><span class="line">				&#125;</span><br><span class="line">			    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">				logger.warn(e.getMessage(), e);</span><br><span class="line">			    &#125;</span><br><span class="line">			&#125;</span><br><span class="line">		    &#125;</span><br><span class="line">		    <span class="keyword">if</span> (isInvalidLocalHost(hostToBind)) &#123;</span><br><span class="line">			<span class="comment">//仍然为无效本地地址的话，则使用本地地址</span></span><br><span class="line">			hostToBind = getLocalHost();</span><br><span class="line">		    &#125;</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//添加bind.ip参数</span></span><br><span class="line">	map.put(Constants.BIND_IP_KEY, hostToBind);</span><br><span class="line">	<span class="comment">// 默认情况下，注册ip不用于绑定ip</span></span><br><span class="line">	<span class="comment">// 获取注册ip</span></span><br><span class="line">	String hostToRegistry = getValueFromConfig(protocolConfig, Constants.DUBBO_IP_TO_REGISTRY);</span><br><span class="line">	<span class="keyword">if</span> (hostToRegistry != <span class="keyword">null</span> &amp;&amp; hostToRegistry.length() &gt; <span class="number">0</span> &amp;&amp; isInvalidLocalHost(hostToRegistry)) &#123;</span><br><span class="line">	    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Specified invalid registry ip from property:"</span> + Constants.DUBBO_IP_TO_REGISTRY + <span class="string">", value:"</span> + hostToRegistry);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (hostToRegistry == <span class="keyword">null</span> || hostToRegistry.length() == <span class="number">0</span>) &#123;</span><br><span class="line">	    <span class="comment">//默认情况下，绑定ip用于注册ip</span></span><br><span class="line">	    hostToRegistry = hostToBind;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//添加anyhost参数</span></span><br><span class="line">	map.put(Constants.ANYHOST_KEY, String.valueOf(anyhost));</span><br><span class="line">	<span class="keyword">return</span> hostToRegistry;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 为服务提供者 获取注册端口和绑定端口</span></span><br><span class="line"><span class="comment"> * Register port and bind port for the provider, can be configured separately</span></span><br><span class="line"><span class="comment"> * Configuration priority:</span></span><br><span class="line"><span class="comment"> * environment variable -&gt; java system properties -&gt; port property in protocol config file</span></span><br><span class="line"><span class="comment"> * -&gt; protocol default port</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> protocolConfig</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> name</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 注册端口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Integer <span class="title">findConfigedPorts</span><span class="params">(ProtocolConfig protocolConfig, String name, Map&lt;String, String&gt; map)</span> </span>&#123;</span><br><span class="line">	Integer portToBind = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//从系统配置中获取绑定端口</span></span><br><span class="line">	String port = getValueFromConfig(protocolConfig, Constants.DUBBO_PORT_TO_BIND);</span><br><span class="line">	portToBind = parsePort(port);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (portToBind == <span class="keyword">null</span>) &#123;</span><br><span class="line">	    <span class="comment">//从协议配置中获取绑定端口</span></span><br><span class="line">	    portToBind = protocolConfig.getPort();</span><br><span class="line">	    <span class="keyword">if</span> (provider != <span class="keyword">null</span> &amp;&amp; (portToBind == <span class="keyword">null</span> || portToBind == <span class="number">0</span>)) &#123;</span><br><span class="line">		<span class="comment">//从服务提供者中获取绑定端口</span></span><br><span class="line">		portToBind = provider.getPort();</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="comment">//根据协议名称获取默认绑定端口</span></span><br><span class="line">	    <span class="keyword">final</span> <span class="keyword">int</span> defaultPort = ExtensionLoader.getExtensionLoader(Protocol.class).getExtension(name).getDefaultPort();</span><br><span class="line">	    <span class="keyword">if</span> (portToBind == <span class="keyword">null</span> || portToBind == <span class="number">0</span>) &#123;</span><br><span class="line">		portToBind = defaultPort;</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">if</span> (portToBind == <span class="keyword">null</span> || portToBind &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="comment">//获取随机端口</span></span><br><span class="line">		portToBind = getRandomPort(name);</span><br><span class="line">		<span class="keyword">if</span> (portToBind == <span class="keyword">null</span> || portToBind &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		    <span class="comment">//获取可用端口</span></span><br><span class="line">		    portToBind = getAvailablePort(defaultPort);</span><br><span class="line">		    <span class="comment">//设置随机端口(放入map缓存)</span></span><br><span class="line">		    putRandomPort(name, portToBind);</span><br><span class="line">		&#125;</span><br><span class="line">		logger.warn(<span class="string">"Use random available port("</span> + portToBind + <span class="string">") for protocol "</span> + name);</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//保存绑定端口，稍后用作url的key</span></span><br><span class="line">	map.put(Constants.BIND_PORT_KEY, String.valueOf(portToBind));</span><br><span class="line">	<span class="comment">// registry port, not used as bind port by default</span></span><br><span class="line">	String portToRegistryStr = getValueFromConfig(protocolConfig, Constants.DUBBO_PORT_TO_REGISTRY);</span><br><span class="line">	Integer portToRegistry = parsePort(portToRegistryStr);</span><br><span class="line">	<span class="keyword">if</span> (portToRegistry == <span class="keyword">null</span>) &#123;</span><br><span class="line">	    <span class="comment">//注册端口使用绑定端口</span></span><br><span class="line">	    portToRegistry = portToBind;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> portToRegistry;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 构造监控URL</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> registryURL 注册中心URL</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> URL <span class="title">loadMonitor</span><span class="params">(URL registryURL)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (monitor == <span class="keyword">null</span>) &#123;</span><br><span class="line">	    <span class="comment">//获取监控地址、监控协议配置</span></span><br><span class="line">	    String monitorAddress = ConfigUtils.getProperty(<span class="string">"dubbo.monitor.address"</span>);</span><br><span class="line">	    String monitorProtocol = ConfigUtils.getProperty(<span class="string">"dubbo.monitor.protocol"</span>);</span><br><span class="line">	    <span class="keyword">if</span> ((monitorAddress == <span class="keyword">null</span> || monitorAddress.length() == <span class="number">0</span>) &amp;&amp; (monitorProtocol == <span class="keyword">null</span> || monitorProtocol.length() == <span class="number">0</span>)) &#123;</span><br><span class="line">		<span class="comment">//如果监控地址和监控协议为空，则返回Null</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="comment">//构造监控配置对象(地址、协议)</span></span><br><span class="line">	    monitor = <span class="keyword">new</span> MonitorConfig();</span><br><span class="line">	    <span class="keyword">if</span> (monitorAddress != <span class="keyword">null</span> &amp;&amp; monitorAddress.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		monitor.setAddress(monitorAddress);</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">if</span> (monitorProtocol != <span class="keyword">null</span> &amp;&amp; monitorProtocol.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		monitor.setProtocol(monitorProtocol);</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//添加属性</span></span><br><span class="line">	appendProperties(monitor);</span><br><span class="line">	<span class="comment">//参数</span></span><br><span class="line">	Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">	<span class="comment">//添加interface参数</span></span><br><span class="line">	map.put(Constants.INTERFACE_KEY, MonitorService.class.getName());</span><br><span class="line">	<span class="comment">//添加dubbo版本</span></span><br><span class="line">	map.put(<span class="string">"dubbo"</span>, Version.getVersion());</span><br><span class="line">	<span class="comment">//添加时间戳</span></span><br><span class="line">	map.put(Constants.TIMESTAMP_KEY, String.valueOf(System.currentTimeMillis()));</span><br><span class="line">	<span class="keyword">if</span> (ConfigUtils.getPid() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">	    <span class="comment">//添加pid</span></span><br><span class="line">	    map.put(Constants.PID_KEY, String.valueOf(ConfigUtils.getPid()));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//添加monitor属性</span></span><br><span class="line">	appendParameters(map, monitor);</span><br><span class="line">	<span class="comment">//获取monitor地址，优先使用系统配置值</span></span><br><span class="line">	String address = monitor.getAddress();</span><br><span class="line">	String sysaddress = System.getProperty(<span class="string">"dubbo.monitor.address"</span>);</span><br><span class="line">	<span class="keyword">if</span> (sysaddress != <span class="keyword">null</span> &amp;&amp; sysaddress.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">	    address = sysaddress;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (ConfigUtils.isNotEmpty(address)) &#123;</span><br><span class="line">	    <span class="keyword">if</span> (!map.containsKey(Constants.PROTOCOL_KEY)) &#123;</span><br><span class="line">		<span class="comment">//协议地址不为空，且map中不包含protocol属性时，则设置protocol</span></span><br><span class="line">		<span class="keyword">if</span> (ExtensionLoader.getExtensionLoader(MonitorFactory.class).hasExtension(<span class="string">"logstat"</span>)) &#123;</span><br><span class="line">		    <span class="comment">//包含logstat扩展</span></span><br><span class="line">		    map.put(Constants.PROTOCOL_KEY, <span class="string">"logstat"</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		    <span class="comment">//添加protocol属性</span></span><br><span class="line">		    map.put(Constants.PROTOCOL_KEY, <span class="string">"dubbo"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="comment">//生成URL对象</span></span><br><span class="line">	    <span class="keyword">return</span> UrlUtils.parseURL(address, map);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (Constants.REGISTRY_PROTOCOL.equals(monitor.getProtocol()) &amp;&amp; registryURL != <span class="keyword">null</span>) &#123;</span><br><span class="line">	    <span class="comment">//监控address为空</span></span><br><span class="line">	    <span class="comment">//registryURL不为空，且monitor的协议为registry注册中心协议</span></span><br><span class="line">	    <span class="keyword">return</span> registryURL.setProtocol(<span class="string">"dubbo"</span>)</span><br><span class="line">		    <span class="comment">//添加protocol属性为registry</span></span><br><span class="line">		    .addParameter(Constants.PROTOCOL_KEY, <span class="string">"registry"</span>)</span><br><span class="line">		    <span class="comment">//添加refer属性，属性值为map参数</span></span><br><span class="line">		    .addParameterAndEncoded(Constants.REFER_KEY, StringUtils.toQueryString(map));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>由于本小节主要是讲ServiceAnnotationBeanPostProcessor类实现，关于服务暴露的内容将会放到下一小节介绍。</p>

        
            <div class="donate-container">
    <div class="donate-button">
        <button id="donate-button">赞赏</button>
    </div>
    <div class="donate-img-container hide" id="donate-img-container">
        <img id="donate-img" src="" data-src="/blog/img/pay.png">
        <p> thank you </p>
    </div>
</div>
        
        <div id="comment-container">
        </div>
    </div>
</div>
    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <span>/</span>
        
        <span><a href="https://medium.com/netflix-techblog">Netflix</a></span>
        <span>/</span>
        
        <span><a href="https://engineering.linkedin.com/blog">Linkedin</a></span>
        <span>/</span>
        
        <span><a href="https://blogs.dropbox.com/tech/">Dropbox</a></span>
        <span>/</span>
        
        <span><a href="https://code.fb.com/">Facebook</a></span>
        <span>/</span>
        
        <span><a href="https://www.fpcomplete.com/blog">FPComplete</a></span>
        <span>/</span>
        
        <span><a href="https://blog.janestreet.com/">JaneStreet</a></span>
        <span>/</span>
        
        <span><a href="https://github.com/limengyu1990/">Github</a></span>
        <span>/</span>
        
        <span><a href="https://serokell.io/blog">serokell</a></span>
        <span>/</span>
        
    </p>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/blog/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/blog/js/index.js"></script>
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<!--create by tea9-->

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
    <script>
        var gitalk = new Gitalk({
          clientID: '7cfc73dd62b57f07ed83',
          clientSecret: 'dd03b7e54aadf0d81e4c9c93e23a41272bcfcfa1',
          repo: 'blog',
          owner: 'limengyu1990',
          admin: 'limengyu1990',
          id: location.pathname,      // Ensure uniqueness and length less than 50
          distractionFreeMode: false  // Facebook-like distraction free mode
        })
        gitalk.render('comment-container')
    </script>

<!--end-->


</html>
