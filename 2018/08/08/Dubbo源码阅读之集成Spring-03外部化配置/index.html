<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/blog/img/favicon.ico">

    <title>
        
        Dubbo源码阅读之集成Spring外部化配置(03) - undefined
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/blog/css/aircloud.css">
    <link rel="stylesheet" href="/blog/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> 不会Haskell的Scala写不出好的JavaScript。 </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar">
            <img src="/blog/img/photo.png" />
        </div>
        <div class="name">
            <i>不负如来不负卿</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/blog/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/blog/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/blog/archive">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/blog/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#支持的注解"><span class="toc-text">支持的注解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#DubboComponentScan注解"><span class="toc-text">DubboComponentScan注解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#EnableDubboConfig注解"><span class="toc-text">EnableDubboConfig注解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#EnableDubboConfigBinding-EnableDubboConfigBindings注解"><span class="toc-text">@EnableDubboConfigBinding/@EnableDubboConfigBindings注解</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#EnableDubboConfigBinding注解"><span class="toc-text">@EnableDubboConfigBinding注解</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#EnableDubboConfigBindings注解"><span class="toc-text">@EnableDubboConfigBindings注解</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#EnableDubbo注解"><span class="toc-text">@EnableDubbo注解</span></a></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>
        <div class="index-about-mobile">
            <i> 不会Haskell的Scala写不出好的JavaScript。 </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        Dubbo源码阅读之集成Spring外部化配置(03)
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2018-08-08 14:24:15</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/blog/tags/#dubbo" title="dubbo">dubbo</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <blockquote>
<p>这一小节，我们来看下支持外部化配置的相关类，因为本系列文章主要关注源码，具体的映射规则就不在介绍了，可以参考: <a href="https://zhuanlan.zhihu.com/p/32557951" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/32557951</a></p>
</blockquote>
<h3 id="支持的注解"><a href="#支持的注解" class="headerlink" title="支持的注解"></a>支持的注解</h3><h4 id="DubboComponentScan注解"><a href="#DubboComponentScan注解" class="headerlink" title="DubboComponentScan注解"></a>DubboComponentScan注解</h4><p>@Import是Spring提供的注解，可以通过导入的方式将实例添加到BeanFactory中，不了解的童鞋可以去我的博客里面找一下，有单独的文章介绍。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import</span>(DubboComponentScanRegistrar.class)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> DubboComponentScan &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * basePackages() 别名，例如，可以使用 <span class="doctag">@DubboComponentScan</span>("org.my.pkg") 替代 <span class="doctag">@DubboComponentScan</span>(basePackages="org.my.pkg")</span></span><br><span class="line"><span class="comment">     * Alias for the &#123;<span class="doctag">@link</span> #basePackages()&#125; attribute. Allows for more concise annotation</span></span><br><span class="line"><span class="comment">     * declarations e.g.: &#123;<span class="doctag">@code</span> <span class="doctag">@DubboComponentScan</span>("org.my.pkg")&#125; instead of</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@code</span> <span class="doctag">@DubboComponentScan</span>(basePackages="org.my.pkg")&#125;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the base packages to scan</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String[] value() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 被标注<span class="doctag">@Service</span>注解的类所在基础包路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the base packages to scan</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String[] basePackages() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 类型安全，用来替代 basePackages()</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the base packages to scan</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Class&lt;?&gt;[] basePackageClasses() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后我们看下DubboComponentScanRegistrar类，该类负责注册ServiceAnnotationBeanPostProcessor和ReferenceAnnotationBeanPostProcessor到BeanFactory<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 实现了ImportBeanDefinitionRegistrar接口，允许我们注册特定的bean到Spring中</span></span><br><span class="line"><span class="comment"> * Dubbo &#123;<span class="doctag">@link</span> DubboComponentScan&#125; Bean Registrar</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> Service</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> DubboComponentScan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> ImportBeanDefinitionRegistrar</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> ServiceAnnotationBeanPostProcessor</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> ReferenceAnnotationBeanPostProcessor</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.5.7</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboComponentScanRegistrar</span> <span class="keyword">implements</span> <span class="title">ImportBeanDefinitionRegistrar</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取待扫描的基础包路径</span></span><br><span class="line">        Set&lt;String&gt; packagesToScan = getPackagesToScan(importingClassMetadata);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//注册ServiceAnnotationBeanPostProcessor</span></span><br><span class="line">        registerServiceAnnotationBeanPostProcessor(packagesToScan, registry);</span><br><span class="line">        <span class="comment">//注册ReferenceAnnotationBeanPostProcessor</span></span><br><span class="line">        registerReferenceAnnotationBeanPostProcessor(registry);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注册ServiceAnnotationBeanPostProcessor类</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> packagesToScan 待扫描的包路径，没有处理placeholders</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> registry       &#123;<span class="doctag">@link</span> BeanDefinitionRegistry&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 2.5.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerServiceAnnotationBeanPostProcessor</span><span class="params">(Set&lt;String&gt; packagesToScan,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                            BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        BeanDefinitionBuilder builder = rootBeanDefinition(ServiceAnnotationBeanPostProcessor.class);</span><br><span class="line">        builder.addConstructorArgValue(packagesToScan);</span><br><span class="line">        builder.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">        AbstractBeanDefinition beanDefinition = builder.getBeanDefinition();</span><br><span class="line">        <span class="comment">//生成beanName并执行注册</span></span><br><span class="line">        BeanDefinitionReaderUtils.registerWithGeneratedName(beanDefinition, registry);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注册ReferenceAnnotationBeanPostProcessor类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> registry &#123;<span class="doctag">@link</span> BeanDefinitionRegistry&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerReferenceAnnotationBeanPostProcessor</span><span class="params">(BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Register @Reference Annotation Bean Processor</span></span><br><span class="line">        BeanRegistrar.registerInfrastructureBean(registry,</span><br><span class="line">                ReferenceAnnotationBeanPostProcessor.BEAN_NAME,</span><br><span class="line">                ReferenceAnnotationBeanPostProcessor.class);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取待扫描的基础包路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> metadata</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Set&lt;String&gt; <span class="title">getPackagesToScan</span><span class="params">(AnnotationMetadata metadata)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取@DubboComponentScan注解属性</span></span><br><span class="line">        AnnotationAttributes attributes = AnnotationAttributes.fromMap(</span><br><span class="line">                metadata.getAnnotationAttributes(DubboComponentScan.class.getName())</span><br><span class="line">        );</span><br><span class="line">        String[] basePackages = attributes.getStringArray(<span class="string">"basePackages"</span>);</span><br><span class="line">        Class&lt;?&gt;[] basePackageClasses = attributes.getClassArray(<span class="string">"basePackageClasses"</span>);</span><br><span class="line">        String[] value = attributes.getStringArray(<span class="string">"value"</span>);</span><br><span class="line">        <span class="comment">//将basePackages、basePackageClasses、value属性指定的值合并起来</span></span><br><span class="line">        Set&lt;String&gt; packagesToScan = <span class="keyword">new</span> LinkedHashSet&lt;String&gt;(Arrays.asList(value));</span><br><span class="line">        packagesToScan.addAll(Arrays.asList(basePackages));</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;?&gt; basePackageClass : basePackageClasses) &#123;</span><br><span class="line">            <span class="comment">//通过basePackageClass获取包名</span></span><br><span class="line">            packagesToScan.add(ClassUtils.getPackageName(basePackageClass));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (packagesToScan.isEmpty()) &#123;</span><br><span class="line">            <span class="comment">//如果没有配置基础包路径的话，则取包名作为基础包路径</span></span><br><span class="line">            <span class="keyword">return</span> Collections.singleton(ClassUtils.getPackageName(metadata.getClassName()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> packagesToScan;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="EnableDubboConfig注解"><a href="#EnableDubboConfig注解" class="headerlink" title="EnableDubboConfig注解"></a>EnableDubboConfig注解</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(&#123;ElementType.TYPE&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import</span>(DubboConfigConfigurationSelector.class)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableDubboConfig &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 表明是否绑定到多个Spring-Bean,默认是false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">multiple</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 该类实现了ImportSelector接口，此接口是Spring中导入外部配置的核心接口，有兴趣的读者可以去了解下，这里就不多做介绍了。</span></span><br><span class="line"><span class="comment"> * Dubbo &#123;<span class="doctag">@link</span> AbstractConfig Config&#125; Registrar</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> EnableDubboConfig</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> DubboConfigConfiguration</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.5.8</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboConfigConfigurationSelector</span> <span class="keyword">implements</span> <span class="title">ImportSelector</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 要导入到Spring容器中的组件全类名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> importingClassMetadata</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;</span><br><span class="line"></span><br><span class="line">        AnnotationAttributes attributes = AnnotationAttributes.fromMap(</span><br><span class="line">                importingClassMetadata</span><br><span class="line">                        .getAnnotationAttributes(EnableDubboConfig.class.getName())</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">//是否绑定到多个Spring-Bean</span></span><br><span class="line">        <span class="keyword">boolean</span> multiple = attributes.getBoolean(<span class="string">"multiple"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (multiple) &#123;</span><br><span class="line">            <span class="comment">//返回多dubbo配置bean绑定</span></span><br><span class="line">            <span class="keyword">return</span> of(DubboConfigConfiguration.Multiple.class.getName());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> of(DubboConfigConfiguration.Single.class.getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; T[] of(T... values) &#123;</span><br><span class="line">        <span class="keyword">return</span> values;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> HIGHEST_PRECEDENCE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboConfigConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 单Dubbo配置Bean绑定</span></span><br><span class="line"><span class="comment">     * Single Dubbo &#123;<span class="doctag">@link</span> AbstractConfig Config&#125; Bean Binding</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@EnableDubboConfigBindings</span>(&#123;</span><br><span class="line">            <span class="meta">@EnableDubboConfigBinding</span>(prefix = <span class="string">"dubbo.application"</span>, type = ApplicationConfig.class),</span><br><span class="line">            <span class="meta">@EnableDubboConfigBinding</span>(prefix = <span class="string">"dubbo.module"</span>, type = ModuleConfig.class),</span><br><span class="line">            <span class="meta">@EnableDubboConfigBinding</span>(prefix = <span class="string">"dubbo.registry"</span>, type = RegistryConfig.class),</span><br><span class="line">            <span class="meta">@EnableDubboConfigBinding</span>(prefix = <span class="string">"dubbo.protocol"</span>, type = ProtocolConfig.class),</span><br><span class="line">            <span class="meta">@EnableDubboConfigBinding</span>(prefix = <span class="string">"dubbo.monitor"</span>, type = MonitorConfig.class),</span><br><span class="line">            <span class="meta">@EnableDubboConfigBinding</span>(prefix = <span class="string">"dubbo.provider"</span>, type = ProviderConfig.class),</span><br><span class="line">            <span class="meta">@EnableDubboConfigBinding</span>(prefix = <span class="string">"dubbo.consumer"</span>, type = ConsumerConfig.class)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Single</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 多Dubbo配置Bean绑定</span></span><br><span class="line"><span class="comment">     * Multiple Dubbo &#123;<span class="doctag">@link</span> AbstractConfig Config&#125; Bean Binding</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@EnableDubboConfigBindings</span>(&#123;</span><br><span class="line">            <span class="meta">@EnableDubboConfigBinding</span>(prefix = <span class="string">"dubbo.applications"</span>, type = ApplicationConfig.class, multiple = <span class="keyword">true</span>),</span><br><span class="line">            <span class="meta">@EnableDubboConfigBinding</span>(prefix = <span class="string">"dubbo.modules"</span>, type = ModuleConfig.class, multiple = <span class="keyword">true</span>),</span><br><span class="line">            <span class="meta">@EnableDubboConfigBinding</span>(prefix = <span class="string">"dubbo.registries"</span>, type = RegistryConfig.class, multiple = <span class="keyword">true</span>),</span><br><span class="line">            <span class="meta">@EnableDubboConfigBinding</span>(prefix = <span class="string">"dubbo.protocols"</span>, type = ProtocolConfig.class, multiple = <span class="keyword">true</span>),</span><br><span class="line">            <span class="meta">@EnableDubboConfigBinding</span>(prefix = <span class="string">"dubbo.monitors"</span>, type = MonitorConfig.class, multiple = <span class="keyword">true</span>),</span><br><span class="line">            <span class="meta">@EnableDubboConfigBinding</span>(prefix = <span class="string">"dubbo.providers"</span>, type = ProviderConfig.class, multiple = <span class="keyword">true</span>),</span><br><span class="line">            <span class="meta">@EnableDubboConfigBinding</span>(prefix = <span class="string">"dubbo.consumers"</span>, type = ConsumerConfig.class, multiple = <span class="keyword">true</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Multiple</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用方式:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将以下内容的外部化配置文件物理路径为：classpath:/META-INF/multiple-config.properties:</span></span><br><span class="line">#多Dubbo配置Bean绑定</span><br><span class="line">## dubbo.applications</span><br><span class="line">dubbo.applications.applicationBean.name = dubbo-demo-application</span><br><span class="line">dubbo.applications.applicationBean2.name = dubbo-demo-application2</span><br><span class="line">dubbo.applications.applicationBean3.name = dubbo-demo-application3</span><br><span class="line"></span><br><span class="line"><span class="comment">//新建配置类DubboMultipleConfiguration</span></span><br><span class="line"><span class="meta">@EnableDubboConfig</span>(multiple = <span class="keyword">true</span>)</span><br><span class="line"><span class="meta">@PropertySource</span>(<span class="string">"META-INF/multiple-config.properties"</span>)</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboMultipleConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//测试类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboConfigurationBootstrap</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="comment">//创建配置上下文</span></span><br><span class="line">		AnnotationConfigApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">		<span class="comment">//注册当前配置 Bean</span></span><br><span class="line">       		context.register(DubboMultipleConfiguration.class);</span><br><span class="line">       		context.refresh();</span><br><span class="line"></span><br><span class="line">		<span class="comment">//获取ApplicationConfig Bean："applicationBean"、"applicationBean2" 和 "applicationBean3"</span></span><br><span class="line">		ApplicationConfig applicationBean = context.getBean(<span class="string">"applicationBean"</span>, ApplicationConfig.class);</span><br><span class="line">		ApplicationConfig applicationBean2 = context.getBean(<span class="string">"applicationBean2"</span>, ApplicationConfig.class);</span><br><span class="line">		ApplicationConfig applicationBean3 = context.getBean(<span class="string">"applicationBean3"</span>, ApplicationConfig.class);</span><br><span class="line"></span><br><span class="line">		System.out.printf(<span class="string">"applicationBean.name = %s \n"</span>, applicationBean.getName());</span><br><span class="line">		System.out.printf(<span class="string">"applicationBean2.name = %s \n"</span>, applicationBean2.getName());</span><br><span class="line">		System.out.printf(<span class="string">"applicationBean3.name = %s \n"</span>, applicationBean3.getName());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="EnableDubboConfigBinding-EnableDubboConfigBindings注解"><a href="#EnableDubboConfigBinding-EnableDubboConfigBindings注解" class="headerlink" title="@EnableDubboConfigBinding/@EnableDubboConfigBindings注解"></a>@EnableDubboConfigBinding/@EnableDubboConfigBindings注解</h4><p>@EnableDubboConfig适合绝大多数外部化配置场景,然而无论是单Bean绑定,还是多Bean绑定,其外部化配置属性前缀是固化的,如dubbo.application以及dubbo.applications.<br>当应用需要自定义外部化配置属性前缀,@EnableDubboConfigBinding能提供更大的弹性，支持单个外部化配置属性前缀(prefix)与Dubbo配置Bean类型(AbstractConfig子类)绑定,如果需要多次绑定时,可使用@EnableDubboConfigBindings.<br>@EnableDubboConfigBinding在支持外部化配置属性与Dubbo配置类绑定时,与Dubbo过去的映射行为不同,被绑定的Dubbo配置类将会提升为Spring Bean,无需提前装配Dubbo配置类.同时,支持多Dubbo配置Bean装配.其Bean的绑定规则与@EnableDubboConfig一致.</p>
<h5 id="EnableDubboConfigBinding注解"><a href="#EnableDubboConfigBinding注解" class="headerlink" title="@EnableDubboConfigBinding注解"></a>@EnableDubboConfigBinding注解</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(&#123;ElementType.TYPE, ElementType.ANNOTATION_TYPE&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import</span>(DubboConfigBindingRegistrar.class)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableDubboConfigBinding &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 指定待绑定Dubbo配置类的外部化配置属性的前缀,比如dubbo.application为 ApplicationConfig的外部化配置属性的前缀.</span></span><br><span class="line"><span class="comment">     * prefix()支持占位符(Placeholder),</span></span><br><span class="line"><span class="comment">     * 并且其关联前缀值是否以"."作为结尾字符是可选的,即"dubbo.application"与"dubbo.application."效果相同</span></span><br><span class="line"><span class="comment">     * 例如："dubbo.application." 或 "dubbo.application"</span></span><br><span class="line"><span class="comment">     * The name prefix of the properties that are valid to bind to &#123;<span class="doctag">@link</span> AbstractConfig Dubbo Config&#125;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the name prefix of the properties to bind</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">prefix</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 绑定的Dubbo配置类型,即Dubbo配置类,所有AbstractConfig的子类都可以</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> The binding type of &#123;<span class="doctag">@link</span> AbstractConfig Dubbo Config&#125;.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> AbstractConfig</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> ApplicationConfig</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> ModuleConfig</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> RegistryConfig</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Class&lt;? extends AbstractConfig&gt; type();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否需要将prefix()作为多个type()类型的Spring Bean外部化配置属性,默认值为false</span></span><br><span class="line"><span class="comment">     * It indicates whether &#123;<span class="doctag">@link</span> #prefix()&#125; binding to multiple Spring Beans.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the default value is &lt;code&gt;false&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">multiple</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 实现了ImportBeanDefinitionRegistrar接口，允许我们注册特定的bean到Spring中</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> AbstractConfig Dubbo Config&#125; binding Bean registrar</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> EnableDubboConfigBinding</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> DubboConfigBindingBeanPostProcessor</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.5.8</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboConfigBindingRegistrar</span> <span class="keyword">implements</span> <span class="title">ImportBeanDefinitionRegistrar</span>, <span class="title">EnvironmentAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Log log = LogFactory.getLog(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ConfigurableEnvironment environment;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取@EnableDubboConfigBinding注解</span></span><br><span class="line">        AnnotationAttributes attributes = AnnotationAttributes.fromMap(</span><br><span class="line">                importingClassMetadata.getAnnotationAttributes(EnableDubboConfigBinding.class.getName()));</span><br><span class="line">        <span class="comment">//处理@EnableDubboConfigBinding注解属性并注册bean</span></span><br><span class="line">        registerBeanDefinitions(attributes, registry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 读取<span class="doctag">@EnableDubboConfigBinding</span>注解属性值，然后注册bean</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> attributes</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> registry</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationAttributes attributes, BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取@EnableDubboConfigBinding注解的prefix属性，并处理占位符</span></span><br><span class="line">        String prefix = environment.resolvePlaceholders(attributes.getString(<span class="string">"prefix"</span>));</span><br><span class="line">        <span class="comment">//获取@EnableDubboConfigBinding注解的type属性</span></span><br><span class="line">        Class&lt;? extends AbstractConfig&gt; configClass = attributes.getClass(<span class="string">"type"</span>);</span><br><span class="line">        <span class="comment">//获取@EnableDubboConfigBinding注解的multiple属性</span></span><br><span class="line">        <span class="keyword">boolean</span> multiple = attributes.getBoolean(<span class="string">"multiple"</span>);</span><br><span class="line">        <span class="comment">//注册Dubbo配置bean</span></span><br><span class="line">        registerDubboConfigBeans(prefix, configClass, multiple, registry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注册bean</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> prefix 属性前缀</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> configClass 待配置的config类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> multiple</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> registry</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerDubboConfigBeans</span><span class="params">(String prefix,</span></span></span><br><span class="line"><span class="function"><span class="params">                                          Class&lt;? extends AbstractConfig&gt; configClass,</span></span></span><br><span class="line"><span class="function"><span class="params">                                          <span class="keyword">boolean</span> multiple,</span></span></span><br><span class="line"><span class="function"><span class="params">                                          BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@Configuration</span></span></span><br><span class="line"><span class="comment">           <span class="doctag">@PropertySource</span>(value = "classpath:resources.properties", ignoreResourceNotFound = false)</span></span><br><span class="line"><span class="comment">           public class AppConfig &#123; &#125;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">//根据prefix从配置文件中找到相关的属性值</span></span><br><span class="line">        <span class="comment">//多bean绑定：</span></span><br><span class="line">        <span class="comment">//prefix:</span></span><br><span class="line">        <span class="comment">//  applications.prefix = dubbo.apps.</span></span><br><span class="line">        <span class="comment">//properties:</span></span><br><span class="line">        <span class="comment">//  applicationBean.name = dubbo-demo-application</span></span><br><span class="line">        <span class="comment">//  applicationBean2.name = dubbo-demo-application2</span></span><br><span class="line">        <span class="comment">//单bean绑定：prefix = dubbo.module.</span></span><br><span class="line">        <span class="comment">//  dubbo.module.id = moduleBean  =&gt;  id = moduleBean</span></span><br><span class="line">        <span class="comment">//  dubbo.module.name = dubbo-demo-module =&gt; name = dubbo-demo-module</span></span><br><span class="line">        Map&lt;String, String&gt; properties = getSubProperties(environment.getPropertySources(), prefix);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果没有配置属性的话，则直接返回</span></span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(properties)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">"There is no property for binding to dubbo config class ["</span> + configClass.getName()</span><br><span class="line">                        + <span class="string">"] within prefix ["</span> + prefix + <span class="string">"]"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取bean名称列表(即外部配置文件中配置的)</span></span><br><span class="line">        Set&lt;String&gt; beanNames = multiple ? resolveMultipleBeanNames(properties) :</span><br><span class="line">                Collections.singleton(resolveSingleBeanName(properties, configClass, registry));</span><br><span class="line">        <span class="comment">//遍历bean名称列表</span></span><br><span class="line">        <span class="keyword">for</span> (String beanName : beanNames) &#123;</span><br><span class="line">            <span class="comment">//最终注册bean的地方</span></span><br><span class="line">            registerDubboConfigBean(beanName, configClass, registry);</span><br><span class="line">            <span class="comment">//注册DubboConfigBindingBeanPostProcessor类</span></span><br><span class="line">            registerDubboConfigBindingBeanPostProcessor(prefix, beanName, multiple, registry);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用beanName注册bean：configClass</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> configClass 配置类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> registry</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerDubboConfigBean</span><span class="params">(String beanName, Class&lt;? extends AbstractConfig&gt; configClass,</span></span></span><br><span class="line"><span class="function"><span class="params">                                         BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        BeanDefinitionBuilder builder = rootBeanDefinition(configClass);</span><br><span class="line">        AbstractBeanDefinition beanDefinition = builder.getBeanDefinition();</span><br><span class="line">        <span class="comment">//使用beanName注册bean：configClass</span></span><br><span class="line">        registry.registerBeanDefinition(beanName, beanDefinition);</span><br><span class="line">        <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">            log.info(<span class="string">"The dubbo config bean definition [name : "</span> + beanName + <span class="string">", class : "</span> + configClass.getName() +</span><br><span class="line">                    <span class="string">"] has been registered."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注册DubboConfigBindingBeanPostProcessor类</span></span><br><span class="line"><span class="comment">     * 用来处理dubbo config bean</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> prefix  属性前缀</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanName 已注册的config配置类的beanName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> multiple </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> registry</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerDubboConfigBindingBeanPostProcessor</span><span class="params">(String prefix, String beanName, <span class="keyword">boolean</span> multiple,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                             BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; processorClass = DubboConfigBindingBeanPostProcessor.class;</span><br><span class="line">        </span><br><span class="line">        BeanDefinitionBuilder builder = rootBeanDefinition(processorClass);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//如果是multiple的话，则最终前缀：prefix+"."+beanName</span></span><br><span class="line">        <span class="comment">//否则的话，最终前缀：prefix</span></span><br><span class="line">        String actualPrefix = multiple ? normalizePrefix(prefix) + beanName : prefix;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//通过构造函数注入属性：prefix、beanName</span></span><br><span class="line">        builder.addConstructorArgValue(actualPrefix).addConstructorArgValue(beanName);</span><br><span class="line">        <span class="comment">//获取beanDefinition</span></span><br><span class="line">        AbstractBeanDefinition beanDefinition = builder.getBeanDefinition();</span><br><span class="line">        <span class="comment">//设置不可代理</span></span><br><span class="line">        beanDefinition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">        <span class="comment">//注册DubboConfigBindingBeanPostProcessor</span></span><br><span class="line">        registerWithGeneratedName(beanDefinition, registry);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">            log.info(<span class="string">"The BeanPostProcessor bean definition ["</span> + processorClass.getName()</span><br><span class="line">                    + <span class="string">"] for dubbo config bean [name : "</span> + beanName + <span class="string">"] has been registered."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEnvironment</span><span class="params">(Environment environment)</span> </span>&#123;</span><br><span class="line">        Assert.isInstanceOf(ConfigurableEnvironment.class, environment);</span><br><span class="line">        <span class="keyword">this</span>.environment = (ConfigurableEnvironment) environment;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理多个bean名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> properties 如：</span></span><br><span class="line"><span class="comment">     *          applicationBean.name = dubbo-demo-application</span></span><br><span class="line"><span class="comment">     *          applicationBean2.name = dubbo-demo-application2</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> applicationBean、applicationBean2</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Set&lt;String&gt; <span class="title">resolveMultipleBeanNames</span><span class="params">(Map&lt;String, String&gt; properties)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//保存已解决的beanNames</span></span><br><span class="line">        Set&lt;String&gt; beanNames = <span class="keyword">new</span> LinkedHashSet&lt;String&gt;();</span><br><span class="line">        <span class="comment">//遍历所有的属性名：applicationBean.name、applicationBean2.name</span></span><br><span class="line">        <span class="keyword">for</span> (String propertyName : properties.keySet()) &#123;</span><br><span class="line">            <span class="comment">//获取"."符号在属性名中第一次出现的位置</span></span><br><span class="line">            <span class="comment">//即判断是否存在"."</span></span><br><span class="line">            <span class="keyword">int</span> index = propertyName.indexOf(<span class="string">"."</span>);</span><br><span class="line">            <span class="keyword">if</span> (index &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//获取bean名称：applicationBean、applicationBean2</span></span><br><span class="line">                String beanName = propertyName.substring(<span class="number">0</span>, index);</span><br><span class="line">                <span class="comment">//保存bean名称</span></span><br><span class="line">                beanNames.add(beanName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> beanNames;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理单个bean名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> properties 如：</span></span><br><span class="line"><span class="comment">     *      dubbo.module.id = moduleBean  =&gt;  id = moduleBean</span></span><br><span class="line"><span class="comment">     *      dubbo.module.name = dubbo-demo-module =&gt; name = dubbo-demo-module</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> configClass dubbo配置类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> registry</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">resolveSingleBeanName</span><span class="params">(Map&lt;String, String&gt; properties,</span></span></span><br><span class="line"><span class="function"><span class="params">                                         Class&lt;? extends AbstractConfig&gt; configClass,</span></span></span><br><span class="line"><span class="function"><span class="params">                                         BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取id属性作为bean的名称</span></span><br><span class="line">        String beanName = properties.get(<span class="string">"id"</span>);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasText(beanName)) &#123;</span><br><span class="line">            <span class="comment">//id属性为空的话</span></span><br><span class="line">            BeanDefinitionBuilder builder = rootBeanDefinition(configClass);</span><br><span class="line">            <span class="comment">//则使用工具类生成bean名称</span></span><br><span class="line">            beanName = BeanDefinitionReaderUtils.generateBeanName(</span><br><span class="line">                    builder.getRawBeanDefinition(), registry</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> beanName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，为每个注册的Config-bean都注册了一个DubboConfigBindingBeanPostProcessor类，现在我们看下DubboConfigBindingBeanPostProcessor类，该类实现了BeanPostProcessor接口,<br>实现该接口，可以在bean实例化前后，增加一些自己的逻辑处理，同时也实现了InitializingBean接口.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Dubbo Config Binding &#123;<span class="doctag">@link</span> BeanPostProcessor&#125;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> EnableDubboConfigBinding</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> DubboConfigBindingRegistrar</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.5.8</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboConfigBindingBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanPostProcessor</span>, <span class="title">ApplicationContextAware</span>, <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置属性的前缀</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String prefix;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 绑定的Config配置类的beanName</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String beanName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DubboConfigBinder dubboConfigBinder;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否忽略未知字段</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> ignoreUnknownFields = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否忽略无效字段</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> ignoreInvalidFields = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> prefix   配置属性的前缀</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanName 绑定的Config配置类的beanName</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DubboConfigBindingBeanPostProcessor</span><span class="params">(String prefix, String beanName)</span> </span>&#123;</span><br><span class="line">        Assert.notNull(prefix, <span class="string">"The prefix of Configuration Properties must not be null"</span>);</span><br><span class="line">        Assert.notNull(beanName, <span class="string">"The name of bean must not be null"</span>);</span><br><span class="line">        <span class="keyword">this</span>.prefix = prefix;</span><br><span class="line">        <span class="keyword">this</span>.beanName = beanName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="comment">//如果当前实例化的bean的beanName和该处理器保存的beanName相同的话,说明是该实例化bean对应的处理器</span></span><br><span class="line">        <span class="comment">//这个在之前介绍DubboConfigBindingRegistrar类时有介绍</span></span><br><span class="line">        <span class="keyword">if</span> (beanName.equals(<span class="keyword">this</span>.beanName) &amp;&amp; bean <span class="keyword">instanceof</span> AbstractConfig) &#123;</span><br><span class="line">            AbstractConfig dubboConfig = (AbstractConfig) bean;</span><br><span class="line">            <span class="comment">//通过prefix绑定beanName的属性</span></span><br><span class="line">            dubboConfigBinder.bind(prefix, dubboConfig);</span><br><span class="line">            <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">                log.info(<span class="string">"The properties of bean [name : "</span> + beanName + <span class="string">"] have been binding by prefix of "</span> +</span><br><span class="line">                        <span class="string">"configuration properties : "</span> + prefix);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (dubboConfigBinder == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//先从BeanFactory中获取DubboConfigBinder实例</span></span><br><span class="line">                dubboConfigBinder = applicationContext.getBean(DubboConfigBinder.class);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (BeansException ignored) &#123;</span><br><span class="line">                <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                    log.debug(<span class="string">"DubboConfigBinder Bean can't be found in ApplicationContext."</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//使用默认实现</span></span><br><span class="line">                dubboConfigBinder = createDubboConfigBinder(applicationContext.getEnvironment());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//设置是否忽略未知字段、无效字段</span></span><br><span class="line">        dubboConfigBinder.setIgnoreUnknownFields(ignoreUnknownFields);</span><br><span class="line">        dubboConfigBinder.setIgnoreInvalidFields(ignoreInvalidFields);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建DubboConfigBinder实例(默认实现)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> environment</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@link</span> DefaultDubboConfigBinder&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> DubboConfigBinder <span class="title">createDubboConfigBinder</span><span class="params">(Environment environment)</span> </span>&#123;</span><br><span class="line">        DefaultDubboConfigBinder defaultDubboConfigBinder = <span class="keyword">new</span> DefaultDubboConfigBinder();</span><br><span class="line">        defaultDubboConfigBinder.setEnvironment(environment);</span><br><span class="line">        <span class="keyword">return</span> defaultDubboConfigBinder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.applicationContext = applicationContext;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后我们看下使用到的DubboConfigBinder接口<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DubboConfigBinder</span> <span class="keyword">extends</span> <span class="title">EnvironmentAware</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置是否忽略未知字段，即是否忽略在目标对象中没有相应字段的绑定参数。默认值是“true”</span></span><br><span class="line"><span class="comment">     * 设置为false，可以强制所有的绑定的参数在目标对象中必须有一个相应的字段</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Set whether to ignore unknown fields, that is, whether to ignore bind</span></span><br><span class="line"><span class="comment">     * parameters that do not have corresponding fields in the target object.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;Default is "true". Turn this off to enforce that all bind parameters</span></span><br><span class="line"><span class="comment">     * must have a matching field in the target object.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #bind</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setIgnoreUnknownFields</span><span class="params">(<span class="keyword">boolean</span> ignoreUnknownFields)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否忽略无效字段，即是否忽略在目标对象中存在相应字段，但是不可访问的绑定参数</span></span><br><span class="line"><span class="comment">     * 默认为“false”</span></span><br><span class="line"><span class="comment">     * Set whether to ignore invalid fields, that is, whether to ignore bind</span></span><br><span class="line"><span class="comment">     * parameters that have corresponding fields in the target object which are</span></span><br><span class="line"><span class="comment">     * not accessible (for example because of null values in the nested path).</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;Default is "false".</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #bind</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setIgnoreInvalidFields</span><span class="params">(<span class="keyword">boolean</span> ignoreInvalidFields)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 以指定的前缀绑定相关属性到Dubbo配置对象中</span></span><br><span class="line"><span class="comment">     * Bind the properties to Dubbo Config Object under specified prefix.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> prefix 属性前缀</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dubboConfig dubboConfig配置类实例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    &lt;C extends AbstractConfig&gt; <span class="function"><span class="keyword">void</span> <span class="title">bind</span><span class="params">(String prefix, C dubboConfig)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//抽象类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractDubboConfigBinder</span> <span class="keyword">implements</span> <span class="title">DubboConfigBinder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 属性配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Iterable&lt;PropertySource&lt;?&gt;&gt; propertySources;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> ignoreUnknownFields = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> ignoreInvalidFields = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取多个PropertySource</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> Iterable&lt;PropertySource&lt;?&gt;&gt; getPropertySources() &#123;</span><br><span class="line">        <span class="keyword">return</span> propertySources;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isIgnoreUnknownFields</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ignoreUnknownFields;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIgnoreUnknownFields</span><span class="params">(<span class="keyword">boolean</span> ignoreUnknownFields)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.ignoreUnknownFields = ignoreUnknownFields;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isIgnoreInvalidFields</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ignoreInvalidFields;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIgnoreInvalidFields</span><span class="params">(<span class="keyword">boolean</span> ignoreInvalidFields)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.ignoreInvalidFields = ignoreInvalidFields;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setEnvironment</span><span class="params">(Environment environment)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (environment <span class="keyword">instanceof</span> ConfigurableEnvironment) &#123;</span><br><span class="line">            <span class="comment">//从environment中获取propertySources</span></span><br><span class="line">            <span class="keyword">this</span>.propertySources = ((ConfigurableEnvironment) environment).getPropertySources();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 默认实现 基于Spring的DataBinder</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultDubboConfigBinder</span> <span class="keyword">extends</span> <span class="title">AbstractDubboConfigBinder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;C extends AbstractConfig&gt; <span class="function"><span class="keyword">void</span> <span class="title">bind</span><span class="params">(String prefix, C dubboConfig)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//创建DataBinder实例，绑定dubboConfig配置类</span></span><br><span class="line">        DataBinder dataBinder = <span class="keyword">new</span> DataBinder(dubboConfig);</span><br><span class="line">        <span class="comment">// Set ignored*</span></span><br><span class="line">        <span class="comment">//设置是否忽略无效字段、未知字段</span></span><br><span class="line">        dataBinder.setIgnoreInvalidFields(isIgnoreInvalidFields());</span><br><span class="line">        dataBinder.setIgnoreUnknownFields(isIgnoreUnknownFields());</span><br><span class="line">        <span class="comment">//从PropertySources中获取指定前缀的属性</span></span><br><span class="line">        Map&lt;String, String&gt; properties = getSubProperties(getPropertySources(), prefix);</span><br><span class="line">        <span class="comment">//将Map转换成MutablePropertyValues对象</span></span><br><span class="line">        MutablePropertyValues propertyValues = <span class="keyword">new</span> MutablePropertyValues(properties);</span><br><span class="line">        <span class="comment">// 进行绑定</span></span><br><span class="line">        dataBinder.bind(propertyValues);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后看下工具类PropertySourcesUtils中的getSubProperties方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据属性前缀，获取所有相关的属性和属性值</span></span><br><span class="line"><span class="comment"> * Get Sub &#123;<span class="doctag">@link</span> Properties&#125;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> propertySources &#123;<span class="doctag">@link</span> PropertySource&#125; Iterable</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> prefix          the prefix of property name</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> Map&lt;String,String&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> Properties</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, String&gt; <span class="title">getSubProperties</span><span class="params">(Iterable&lt;PropertySource&lt;?&gt;&gt; propertySources, String prefix)</span> </span>&#123;</span><br><span class="line">	Map&lt;String, String&gt; subProperties = <span class="keyword">new</span> LinkedHashMap&lt;String, String&gt;();</span><br><span class="line">	<span class="comment">//规范化前缀,即前缀结尾处补上"."符号</span></span><br><span class="line">	String normalizedPrefix = normalizePrefix(prefix);</span><br><span class="line">	<span class="comment">//遍历每一个PropertySource</span></span><br><span class="line">	<span class="keyword">for</span> (PropertySource&lt;?&gt; source : propertySources) &#123;</span><br><span class="line">	    <span class="keyword">if</span> (source <span class="keyword">instanceof</span> EnumerablePropertySource) &#123;</span><br><span class="line">		<span class="comment">//遍历属性名称列表，找到以normalizedPrefix开头的属性名称</span></span><br><span class="line">		<span class="comment">//applications.prefix = dubbo.apps.</span></span><br><span class="line">		<span class="comment">//dubbo.apps.applicationBean.name = dubbo-demo-application</span></span><br><span class="line">		<span class="comment">//dubbo.apps.applicationBean2.name = dubbo-demo-application2</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (String name : ((EnumerablePropertySource&lt;?&gt;) source).getPropertyNames()) &#123;</span><br><span class="line">		    <span class="keyword">if</span> (name.startsWith(normalizedPrefix)) &#123;</span><br><span class="line">			<span class="comment">//截取子名称，如：subName = applicationBean.name/applicationBean2.name</span></span><br><span class="line">			String subName = name.substring(normalizedPrefix.length());</span><br><span class="line">			<span class="comment">//更加属性名称name获取属性值value</span></span><br><span class="line">			Object value = source.getProperty(name);</span><br><span class="line">			<span class="comment">//保存applicationBean.name = dubbo-demo-application</span></span><br><span class="line">			<span class="comment">//保存applicationBean2.name = dubbo-demo-application2</span></span><br><span class="line">			subProperties.put(subName, String.valueOf(value));</span><br><span class="line">		    &#125;</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> subProperties;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="EnableDubboConfigBindings注解"><a href="#EnableDubboConfigBindings注解" class="headerlink" title="@EnableDubboConfigBindings注解"></a>@EnableDubboConfigBindings注解</h5><p>该注解支持配置多个@EnableDubboConfigBinding注解<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(&#123;ElementType.TYPE&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import</span>(DubboConfigBindingsRegistrar.class)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableDubboConfigBindings &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The value of &#123;<span class="doctag">@link</span> EnableDubboConfigBindings&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> non-null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    EnableDubboConfigBinding[] value();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboConfigBindingsRegistrar</span> <span class="keyword">implements</span> <span class="title">ImportBeanDefinitionRegistrar</span>, <span class="title">EnvironmentAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ConfigurableEnvironment environment;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取@EnableDubboConfigBindings注解的属性值</span></span><br><span class="line">        AnnotationAttributes attributes = AnnotationAttributes.fromMap(</span><br><span class="line">                importingClassMetadata.getAnnotationAttributes(EnableDubboConfigBindings.class.getName()));</span><br><span class="line"></span><br><span class="line">        AnnotationAttributes[] annotationAttributes = attributes.getAnnotationArray(<span class="string">"value"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//构造DubboConfigBindingRegistrar对象</span></span><br><span class="line">        DubboConfigBindingRegistrar registrar = <span class="keyword">new</span> DubboConfigBindingRegistrar();</span><br><span class="line">        registrar.setEnvironment(environment);</span><br><span class="line">        <span class="comment">//遍历@EnableDubboConfigBinding列表,处理每一个@EnableDubboConfigBinding注解</span></span><br><span class="line">        <span class="keyword">for</span> (AnnotationAttributes element : annotationAttributes) &#123;</span><br><span class="line">            <span class="comment">//注册DubboConfigBindingRegistrar类</span></span><br><span class="line">            registrar.registerBeanDefinitions(element, registry);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEnvironment</span><span class="params">(Environment environment)</span> </span>&#123;</span><br><span class="line">        Assert.isInstanceOf(ConfigurableEnvironment.class, environment);</span><br><span class="line">        <span class="keyword">this</span>.environment = (ConfigurableEnvironment) environment;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>简单看下使用:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将以下内容的外部化配置文件物理路径为：classpath:/META-INF/bindings.properties</span></span><br><span class="line"># classpath:/META-INF/bindings.properties</span><br><span class="line">## 占位符值 : ApplicationConfig 外部配置属性前缀</span><br><span class="line">applications.prefix = dubbo.apps.</span><br><span class="line"></span><br><span class="line">## 多 ApplicationConfig Bean 绑定</span><br><span class="line">dubbo.apps.applicationBean.name = dubbo-demo-application</span><br><span class="line">dubbo.apps.applicationBean2.name = dubbo-demo-application2</span><br><span class="line">dubbo.apps.applicationBean3.name = dubbo-demo-application3</span><br><span class="line"></span><br><span class="line">## 单 ModuleConfig Bean 绑定</span><br><span class="line">dubbo.<span class="keyword">module</span>.id = moduleBean</span><br><span class="line">dubbo.<span class="keyword">module</span>.name = dubbo-demo-<span class="keyword">module</span></span><br><span class="line"></span><br><span class="line">## 单 RegistryConfig Bean 绑定</span><br><span class="line">dubbo.registry.address = zookeeper:<span class="comment">//192.168.99.100:32770</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 新建一个DubboConfiguration类作为Dubbo配置Bean，添加<span class="doctag">@EnableDubboConfigBinding</span>注解进行绑定</span></span><br><span class="line"><span class="comment"> * 然后配置<span class="doctag">@PropertySource</span>注解指定外部配置文件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@EnableDubboConfigBindings</span>(&#123;</span><br><span class="line"><span class="meta">@EnableDubboConfigBinding</span>(prefix = <span class="string">"$&#123;applications.prefix&#125;"</span>,</span><br><span class="line">               type = ApplicationConfig.class, multiple = <span class="keyword">true</span>), <span class="comment">//多ApplicationConfig Bean绑定</span></span><br><span class="line"><span class="meta">@EnableDubboConfigBinding</span>(prefix = <span class="string">"dubbo.module"</span>, <span class="comment">//不带"."后缀</span></span><br><span class="line">               type = ModuleConfig.class), <span class="comment">//单ModuleConfig Bean绑定</span></span><br><span class="line"><span class="meta">@EnableDubboConfigBinding</span>(prefix = <span class="string">"dubbo.registry."</span>, <span class="comment">//带"."后缀</span></span><br><span class="line">               type = RegistryConfig.class) <span class="comment">//单RegistryConfig Bean绑定</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="meta">@PropertySource</span>(<span class="string">"META-INF/bindings.properties"</span>)</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//新建测试类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboConfigurationBootstrap</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="comment">//创建配置上下文</span></span><br><span class="line">		AnnotationConfigApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">		<span class="comment">//注册当前配置 Bean</span></span><br><span class="line">		context.register(DubboConfiguration.class);</span><br><span class="line">		context.refresh();</span><br><span class="line"></span><br><span class="line">		<span class="comment">//获取ApplicationConfig Bean："applicationBean"、"applicationBean2" 和 "applicationBean3"</span></span><br><span class="line">		ApplicationConfig applicationBean = context.getBean(<span class="string">"applicationBean"</span>, ApplicationConfig.class);</span><br><span class="line">		ApplicationConfig applicationBean2 = context.getBean(<span class="string">"applicationBean2"</span>, ApplicationConfig.class);</span><br><span class="line">		ApplicationConfig applicationBean3 = context.getBean(<span class="string">"applicationBean3"</span>, ApplicationConfig.class);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//applicationBean.name = dubbo-demo-application </span></span><br><span class="line">		<span class="comment">//applicationBean2.name = dubbo-demo-application2 </span></span><br><span class="line">		capplicationBean3.name = dubbo-demo-application3 </span><br><span class="line">		System.out.printf(<span class="string">"applicationBean.name = %s \n"</span>, applicationBean.getName());</span><br><span class="line">		System.out.printf(<span class="string">"applicationBean2.name = %s \n"</span>, applicationBean2.getName());</span><br><span class="line">		System.out.printf(<span class="string">"applicationBean3.name = %s \n"</span>, applicationBean3.getName());</span><br><span class="line"></span><br><span class="line">		<span class="comment">//获取ModuleConfig Bean："moduleBean"</span></span><br><span class="line">		ModuleConfig moduleBean = context.getBean(<span class="string">"moduleBean"</span>, ModuleConfig.class);</span><br><span class="line">		<span class="comment">//moduleBean.name = dubbo-demo-module </span></span><br><span class="line">		System.out.printf(<span class="string">"moduleBean.name = %s \n"</span>, moduleBean.getName()); </span><br><span class="line"></span><br><span class="line">		<span class="comment">//获取RegistryConfig Bean</span></span><br><span class="line">		RegistryConfig registry = context.getBean(RegistryConfig.class);</span><br><span class="line">		<span class="comment">//registry.address = zookeeper://192.168.99.100:32770 </span></span><br><span class="line">		System.out.printf(<span class="string">"registry.address = %s \n"</span>, registry.getAddress());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="EnableDubbo注解"><a href="#EnableDubbo注解" class="headerlink" title="@EnableDubbo注解"></a>@EnableDubbo注解</h4><p>该注解等同于组合使用@DubboComponentScan和@EnableDubboConfig，上文已经介绍过，这里就不多介绍了。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 启用Dubbo组件作为SpringBean</span></span><br><span class="line"><span class="comment"> * 等同于组合使用<span class="doctag">@DubboComponentScan</span>和<span class="doctag">@EnableDubboConfig</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.TYPE&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@EnableDubboConfig</span></span><br><span class="line"><span class="meta">@DubboComponentScan</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableDubbo &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 扫描<span class="doctag">@Service</span>基础包路径</span></span><br><span class="line"><span class="comment">     * Base packages to scan for annotated <span class="doctag">@Service</span> classes.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * Use &#123;<span class="doctag">@link</span> #scanBasePackageClasses()&#125; for a type-safe alternative to String-based</span></span><br><span class="line"><span class="comment">     * package names.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the base packages to scan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> DubboComponentScan#basePackages()</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@AliasFor</span>(annotation = DubboComponentScan.class, attribute = <span class="string">"basePackages"</span>)</span><br><span class="line">    String[] scanBasePackages() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Type-safe alternative to &#123;<span class="doctag">@link</span> #scanBasePackages()&#125; for specifying the packages to</span></span><br><span class="line"><span class="comment">     * scan for annotated <span class="doctag">@Service</span> classes. The package of each class specified will be</span></span><br><span class="line"><span class="comment">     * scanned.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> classes from the base packages to scan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> DubboComponentScan#basePackageClasses</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@AliasFor</span>(annotation = DubboComponentScan.class, attribute = <span class="string">"basePackageClasses"</span>)</span><br><span class="line">    Class&lt;?&gt;[] scanBasePackageClasses() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * It indicates whether &#123;<span class="doctag">@link</span> AbstractConfig&#125; binding to multiple Spring Beans.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the default value is &lt;code&gt;false&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> EnableDubboConfig#multiple()</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@AliasFor</span>(annotation = EnableDubboConfig.class, attribute = <span class="string">"multiple"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">multipleConfig</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

        
            <div class="donate-container">
    <div class="donate-button">
        <button id="donate-button">赞赏</button>
    </div>
    <div class="donate-img-container hide" id="donate-img-container">
        <img id="donate-img" src="" data-src="/blog/img/pay.png">
        <p> 感谢鼓励 </p>
    </div>
</div>
        
        <div id="comment-container">
        </div>
    </div>
</div>
    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <span>/</span>
        
        <span><a href="https://medium.com/netflix-techblog">Netflix</a></span>
        <span>/</span>
        
        <span><a href="https://engineering.linkedin.com/blog">Linkedin</a></span>
        <span>/</span>
        
        <span><a href="https://blogs.dropbox.com/tech/">Dropbox</a></span>
        <span>/</span>
        
        <span><a href="https://code.fb.com/">Facebook</a></span>
        <span>/</span>
        
        <span><a href="https://www.fpcomplete.com/blog">FPComplete</a></span>
        <span>/</span>
        
        <span><a href="https://blog.janestreet.com/">JaneStreet</a></span>
        <span>/</span>
        
        <span><a href="https://github.com/limengyu1990/">Github</a></span>
        <span>/</span>
        
        <span><a href="https://serokell.io/blog">serokell</a></span>
        <span>/</span>
        
    </p>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/blog/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/blog/js/index.js"></script>
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script src="/blog/js/gitment.js"></script>
<script>
    var gitment = new Gitment({
        id: 'Dubbo源码阅读之集成Spring外部化配置(03)',
        owner: 'limengyu1990',
        repo: 'hexo-blog',
        oauth: {
            client_id: '7cfc73dd62b57f07ed83',
            client_secret: 'dd03b7e54aadf0d81e4c9c93e23a41272bcfcfa1',
        },
    })
    gitment.render('comment-container')
</script>

</html>
