<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/blog/img/favicon.ico">

    <title>
        
        Dubbo源码阅读之服务引用 - undefined
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/blog/css/aircloud.css">
    <link rel="stylesheet" href="/blog/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> 所有的善恶都是我，良心一路走来依旧清澈鲜活... </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar">
            <img src="/blog/img/photo.png" />
        </div>
        <div class="name">
            <i>不负如来不负卿</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/blog/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/blog/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/blog/archive">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/blog/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#createProxy创建代理"><span class="toc-text">createProxy创建代理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#更新Configurator"><span class="toc-text">更新Configurator</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#更新Router"><span class="toc-text">更新Router</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#更新Invoker"><span class="toc-text">更新Invoker</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#toInvokers方法"><span class="toc-text">toInvokers方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#toMethodInvokers方法"><span class="toc-text">toMethodInvokers方法</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#route方法"><span class="toc-text">route方法</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#toMergeMethodInvokerMap方法"><span class="toc-text">toMergeMethodInvokerMap方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#销毁无用的invoker"><span class="toc-text">销毁无用的invoker</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#重新引用invoker"><span class="toc-text">重新引用invoker</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#registerConsumer注册消费者"><span class="toc-text">registerConsumer注册消费者</span></a></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>
        <div class="index-about-mobile">
            <i> 所有的善恶都是我，良心一路走来依旧清澈鲜活... </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        Dubbo源码阅读之服务引用
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2018-08-23 21:16:24</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/blog/tags/#dubbo" title="dubbo">dubbo</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <blockquote>
<p>本小节讲解上小节遗留的ref = createProxy(map)方法，不了解的可以先看下上篇文章《Dubbo源码阅读之集成Spring-0202注解解析》</p>
</blockquote>
<p>该方法定义在ReferenceConfig类中，在调用init方法进行初始化时，会调用createProxy方法来生成代理对象。</p>
<h3 id="createProxy创建代理"><a href="#createProxy创建代理" class="headerlink" title="createProxy创建代理"></a>createProxy创建代理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建代理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> T <span class="title">createProxy</span><span class="params">(Map&lt;String, String&gt; map)</span> </span>&#123;</span><br><span class="line">	URL tmpUrl = <span class="keyword">new</span> URL(<span class="string">"temp"</span>, <span class="string">"localhost"</span>, <span class="number">0</span>, map);</span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> isJvmRefer;</span><br><span class="line">	<span class="comment">//是否引用本地服务，新版使用： scope=local来判断</span></span><br><span class="line">	<span class="keyword">if</span> (isInjvm() == <span class="keyword">null</span>) &#123;</span><br><span class="line">	    <span class="keyword">if</span> (url != <span class="keyword">null</span> &amp;&amp; url.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="comment">//如果配置中指定了url属性，则不使用本地引用</span></span><br><span class="line">		isJvmRefer = <span class="keyword">false</span>;</span><br><span class="line">	    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (InjvmProtocol.getInjvmProtocol().isInjvmRefer(tmpUrl)) &#123;</span><br><span class="line">		<span class="comment">//默认情况下，如果有本地服务，则引用本地服务</span></span><br><span class="line">		isJvmRefer = <span class="keyword">true</span>;</span><br><span class="line">	    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		isJvmRefer = <span class="keyword">false</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	    isJvmRefer = isInjvm().booleanValue();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (isJvmRefer) &#123;</span><br><span class="line">	    <span class="comment">//构建本地协议</span></span><br><span class="line">	    URL url = <span class="keyword">new</span> URL(Constants.LOCAL_PROTOCOL, NetUtils.LOCALHOST, <span class="number">0</span>, interfaceClass.getName()).addParameters(map);</span><br><span class="line">	    <span class="comment">//引用本地服务(后面会分析该方法)</span></span><br><span class="line">	    invoker = refprotocol.refer(interfaceClass, url);</span><br><span class="line">	    <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">		logger.info(<span class="string">"Using injvm service "</span> + interfaceClass.getName());</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	    <span class="keyword">if</span> (url != <span class="keyword">null</span> &amp;&amp; url.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="comment">//用户指定了URL属性，可以是p2p地址或者注册中心的地址，多个地址使用";"分隔</span></span><br><span class="line">		String[] us = Constants.SEMICOLON_SPLIT_PATTERN.split(url);</span><br><span class="line">		<span class="keyword">if</span> (us != <span class="keyword">null</span> &amp;&amp; us.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		    <span class="keyword">for</span> (String u : us) &#123;</span><br><span class="line">			URL url = URL.valueOf(u);</span><br><span class="line">			<span class="keyword">if</span> (url.getPath() == <span class="keyword">null</span> || url.getPath().length() == <span class="number">0</span>) &#123;</span><br><span class="line">			    <span class="comment">//path为空时，使用服务接口名称作为path</span></span><br><span class="line">			    url = url.setPath(interfaceName);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (Constants.REGISTRY_PROTOCOL.equals(url.getProtocol())) &#123;</span><br><span class="line">			    <span class="comment">//注册中心协议，添加引用标识refer参数</span></span><br><span class="line">			    urls.add(url.addParameterAndEncoded(Constants.REFER_KEY, StringUtils.toQueryString(map)));</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			    <span class="comment">//p2p地址(后面会分析该方法)</span></span><br><span class="line">			    urls.add(ClusterUtils.mergeUrl(url, map));</span><br><span class="line">			&#125;</span><br><span class="line">		    &#125;</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">//从注册中心配置中组装URL(后面会分析该方法)</span></span><br><span class="line">		List&lt;URL&gt; us = loadRegistries(<span class="keyword">false</span>);</span><br><span class="line">		<span class="keyword">if</span> (us != <span class="keyword">null</span> &amp;&amp; !us.isEmpty()) &#123;</span><br><span class="line">		    <span class="comment">//遍历注册中心us(后面会分析该方法)</span></span><br><span class="line">		    <span class="keyword">for</span> (URL u : us) &#123;</span><br><span class="line">			<span class="comment">//加载监控url(后面会分析该方法)</span></span><br><span class="line">			URL monitorUrl = loadMonitor(u);</span><br><span class="line">			<span class="keyword">if</span> (monitorUrl != <span class="keyword">null</span>) &#123;</span><br><span class="line">			    <span class="comment">//添加monitor参数</span></span><br><span class="line">			    map.put(Constants.MONITOR_KEY, URL.encode(monitorUrl.toFullString()));</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">//添加refer参数</span></span><br><span class="line">			urls.add(u.addParameterAndEncoded(Constants.REFER_KEY, StringUtils.toQueryString(map)));</span><br><span class="line">		    &#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (urls == <span class="keyword">null</span> || urls.isEmpty()) &#123;</span><br><span class="line">		    <span class="comment">//在消费者端，没有配置注册中心，因此无法引用相应服务接口</span></span><br><span class="line">		    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No such any registry to reference "</span> + interfaceName + <span class="string">" on the consumer "</span> + NetUtils.getLocalHost() + <span class="string">" use dubbo version "</span> + Version.getVersion() + <span class="string">", please config &lt;dubbo:registry address=\"...\" /&gt; to your spring config."</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">if</span> (urls.size() == <span class="number">1</span>) &#123;</span><br><span class="line">		<span class="comment">//引用一个远程服务(后面会分析该方法)</span></span><br><span class="line">		<span class="comment">//registry://172.172.172.47:2181/com.alibaba.dubbo.registry.RegistryService?application=demo-consumer&amp;dubbo=2.0.0&amp;pid=1172&amp;qos.port=33333&amp;refer=application%3Ddemo-consumer%26check%3Dfalse%26dubbo%3D2.0.0%26interface%3Dcom.alibaba.dubbo.demo.DemoService%26methods%3DsayHello%26pid%3D1172%26qos.port%3D33333%26register.ip%3D192.168.99.60%26side%3Dconsumer%26timestamp%3D1535094943004&amp;registry=zookeeper&amp;timestamp=1535095022853</span></span><br><span class="line">		invoker = refprotocol.refer(interfaceClass, urls.get(<span class="number">0</span>));</span><br><span class="line">	    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">//如果有多个url</span></span><br><span class="line">		List&lt;Invoker&lt;?&gt;&gt; invokers = <span class="keyword">new</span> ArrayList&lt;Invoker&lt;?&gt;&gt;();</span><br><span class="line">		URL registryURL = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">for</span> (URL url : urls) &#123;</span><br><span class="line">		    <span class="comment">//记录"远程引用"</span></span><br><span class="line">		    invokers.add(refprotocol.refer(interfaceClass, url));</span><br><span class="line">		    <span class="keyword">if</span> (Constants.REGISTRY_PROTOCOL.equals(url.getProtocol())) &#123;</span><br><span class="line">			<span class="comment">//使用最后一个注册中心url</span></span><br><span class="line">			registryURL = url;</span><br><span class="line">		    &#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (registryURL != <span class="keyword">null</span>) &#123;</span><br><span class="line">		    <span class="comment">//有注册中心协议的URL，使用AvailableCluster</span></span><br><span class="line">		    URL u = registryURL.addParameter(Constants.CLUSTER_KEY, AvailableCluster.NAME);</span><br><span class="line">		    invoker = cluster.join(<span class="keyword">new</span> StaticDirectory(u, invokers));</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123; </span><br><span class="line">		    <span class="comment">//不是注册中心的url</span></span><br><span class="line">		    invoker = cluster.join(<span class="keyword">new</span> StaticDirectory(invokers));</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//检测服务提供者是否存在</span></span><br><span class="line">	Boolean c = check;</span><br><span class="line">	<span class="keyword">if</span> (c == <span class="keyword">null</span> &amp;&amp; consumer != <span class="keyword">null</span>) &#123;</span><br><span class="line">	    c = consumer.isCheck();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">	    <span class="comment">//默认需要检测服务提供者是否存在</span></span><br><span class="line">	    c = <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//检测服务提供者是否存在</span></span><br><span class="line">	<span class="keyword">if</span> (c &amp;&amp; !invoker.isAvailable()) &#123;</span><br><span class="line">	    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Failed to check the status of the service "</span> + interfaceName + <span class="string">". No provider available for the service "</span> + (group == <span class="keyword">null</span> ? <span class="string">""</span> : group + <span class="string">"/"</span>) + interfaceName + (version == <span class="keyword">null</span> ? <span class="string">""</span> : <span class="string">":"</span> + version) + <span class="string">" from the url "</span> + invoker.getUrl() + <span class="string">" to the consumer "</span> + NetUtils.getLocalHost() + <span class="string">" use dubbo version "</span> + Version.getVersion());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">	    logger.info(<span class="string">"Refer dubbo service "</span> + interfaceClass.getName() + <span class="string">" from url "</span> + invoker.getUrl());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//创建服务代理</span></span><br><span class="line">	<span class="keyword">return</span> (T) proxyFactory.getProxy(invoker);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 构造注册中心URL</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> provider</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> List&lt;URL&gt; <span class="title">loadRegistries</span><span class="params">(<span class="keyword">boolean</span> provider)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//检测是否配置了RegistryConfig，并配置</span></span><br><span class="line">	checkRegistry();</span><br><span class="line">	List&lt;URL&gt; registryList = <span class="keyword">new</span> ArrayList&lt;URL&gt;();</span><br><span class="line">	<span class="keyword">if</span> (registries != <span class="keyword">null</span> &amp;&amp; !registries.isEmpty()) &#123;</span><br><span class="line">	    <span class="comment">//遍历注册中心配置</span></span><br><span class="line">	    <span class="keyword">for</span> (RegistryConfig config : registries) &#123;</span><br><span class="line">		<span class="comment">//获取当前注册中心地址，例如： zookeeper://172.172.172.47:2181</span></span><br><span class="line">		String address = config.getAddress();</span><br><span class="line">		<span class="keyword">if</span> (address == <span class="keyword">null</span> || address.length() == <span class="number">0</span>) &#123;</span><br><span class="line">		    <span class="comment">//设置address = 0.0.0.0</span></span><br><span class="line">		    address = Constants.ANYHOST_VALUE;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//从系统配置中获取注册中心地址</span></span><br><span class="line">		String sysaddress = System.getProperty(<span class="string">"dubbo.registry.address"</span>);</span><br><span class="line">		<span class="keyword">if</span> (sysaddress != <span class="keyword">null</span> &amp;&amp; sysaddress.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		    <span class="comment">//如果系统配置的注册中心地址不为空，则优先使用系统配置</span></span><br><span class="line">		    address = sysaddress;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (address != <span class="keyword">null</span> &amp;&amp; address.length() &gt; <span class="number">0</span></span><br><span class="line">			&amp;&amp; !RegistryConfig.NO_AVAILABLE.equalsIgnoreCase(address)) &#123;</span><br><span class="line">		    <span class="comment">//注册中心地址可用</span></span><br><span class="line">		    Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">		    <span class="comment">//附加参数，即找到application、config类中的属性，并添加进来</span></span><br><span class="line">		    appendParameters(map, application);</span><br><span class="line">		    appendParameters(map, config);</span><br><span class="line">		    map.put(<span class="string">"path"</span>, RegistryService.class.getName());</span><br><span class="line">		    map.put(<span class="string">"dubbo"</span>, Version.getVersion());</span><br><span class="line">		    map.put(Constants.TIMESTAMP_KEY, String.valueOf(System.currentTimeMillis()));</span><br><span class="line">		    <span class="keyword">if</span> (ConfigUtils.getPid() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			map.put(Constants.PID_KEY, String.valueOf(ConfigUtils.getPid()));</span><br><span class="line">		    &#125;</span><br><span class="line">		    <span class="keyword">if</span> (!map.containsKey(<span class="string">"protocol"</span>)) &#123;</span><br><span class="line">			<span class="comment">//添加protocol参数</span></span><br><span class="line">			<span class="keyword">if</span> (ExtensionLoader.getExtensionLoader(RegistryFactory.class).hasExtension(<span class="string">"remote"</span>)) &#123;</span><br><span class="line">			    map.put(<span class="string">"protocol"</span>, <span class="string">"remote"</span>);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			    map.put(<span class="string">"protocol"</span>, <span class="string">"dubbo"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		    &#125;</span><br><span class="line">		    <span class="comment">//根据address和map生成注册中心url</span></span><br><span class="line">		    List&lt;URL&gt; urls = UrlUtils.parseURLs(address, map);</span><br><span class="line">		    </span><br><span class="line">		    <span class="comment">//遍历注册中心url，添加registry参数,并设置protocol属性，然后保存起来</span></span><br><span class="line">		    <span class="keyword">for</span> (URL url : urls) &#123;</span><br><span class="line">			<span class="comment">//url = zookeeper://172.172.172.47:2181/com.alibaba.dubbo.registry.RegistryService?application=demo-consumer&amp;dubbo=2.0.0&amp;pid=1172&amp;qos.port=33333&amp;timestamp=1535095022853</span></span><br><span class="line">			<span class="comment">//添加registry参数 = zookeeper</span></span><br><span class="line">			url = url.addParameter(Constants.REGISTRY_KEY, url.getProtocol());</span><br><span class="line">			</span><br><span class="line">			<span class="comment">//重新设置协议为registry</span></span><br><span class="line">			url = url.setProtocol(Constants.REGISTRY_PROTOCOL);</span><br><span class="line">			<span class="keyword">if</span> ((provider &amp;&amp; url.getParameter(Constants.REGISTER_KEY, <span class="keyword">true</span>))</span><br><span class="line">				|| (!provider &amp;&amp; url.getParameter(Constants.SUBSCRIBE_KEY, <span class="keyword">true</span>))) &#123;</span><br><span class="line">			    <span class="comment">//registry://172.172.172.47:2181/com.alibaba.dubbo.registry.RegistryService?application=demo-consumer&amp;dubbo=2.0.0&amp;pid=1172&amp;qos.port=33333&amp;registry=zookeeper&amp;timestamp=1535095022853</span></span><br><span class="line">			    registryList.add(url);</span><br><span class="line">			&#125;</span><br><span class="line">		    &#125;</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> registryList;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 检测RegistryConfig配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">checkRegistry</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//向后兼容</span></span><br><span class="line">	<span class="keyword">if</span> (registries == <span class="keyword">null</span> || registries.isEmpty()) &#123;</span><br><span class="line">	    <span class="comment">//获取到注册中心属性配置值</span></span><br><span class="line">	    String address = ConfigUtils.getProperty(<span class="string">"dubbo.registry.address"</span>);</span><br><span class="line">	    <span class="keyword">if</span> (address != <span class="keyword">null</span> &amp;&amp; address.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		registries = <span class="keyword">new</span> ArrayList&lt;RegistryConfig&gt;();</span><br><span class="line">		<span class="comment">//使用"|"分隔注册中心，然后构造RegistryConfig对象</span></span><br><span class="line">		String[] as = address.split(<span class="string">"\\s*[|]+\\s*"</span>);</span><br><span class="line">		<span class="keyword">for</span> (String a : as) &#123;</span><br><span class="line">		    RegistryConfig registryConfig = <span class="keyword">new</span> RegistryConfig();</span><br><span class="line">		    registryConfig.setAddress(a);</span><br><span class="line">		    registries.add(registryConfig);</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> ((registries == <span class="keyword">null</span> || registries.isEmpty())) &#123;</span><br><span class="line">	    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException((getClass().getSimpleName().startsWith(<span class="string">"Reference"</span>)</span><br><span class="line">		    ? <span class="string">"No such any registry to refer service in consumer "</span></span><br><span class="line">		    : <span class="string">"No such any registry to export service in provider "</span>)</span><br><span class="line">		    + NetUtils.getLocalHost()</span><br><span class="line">		    + <span class="string">" use dubbo version "</span></span><br><span class="line">		    + Version.getVersion()</span><br><span class="line">		    + <span class="string">", Please add &lt;dubbo:registry address=\"...\" /&gt; to your spring config. If you want unregister, please set &lt;dubbo:service registry=\"N/A\" /&gt;"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (RegistryConfig registryConfig : registries) &#123;</span><br><span class="line">	    <span class="comment">//添加属性</span></span><br><span class="line">	    appendProperties(registryConfig);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来我们看下Protocol的refer方法，在《Dubbo源码阅读之服务暴露》小节我们介绍过，将会生成Protocol$Adaptive类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Protocol</span>$<span class="title">Adaptive</span> <span class="keyword">implements</span> <span class="title">com</span>.<span class="title">alibaba</span>.<span class="title">dubbo</span>.<span class="title">rpc</span>.<span class="title">Protocol</span> </span>&#123;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> arg0 服务接口类</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> arg1 注册中心url</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> com.alibaba.dubbo.rpc.<span class="function">Invoker <span class="title">refer</span><span class="params">(java.lang.Class arg0, com.alibaba.dubbo.common.URL arg1)</span> <span class="keyword">throws</span> com.alibaba.dubbo.rpc.RpcException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (arg1 == <span class="keyword">null</span>)&#123;</span><br><span class="line">			<span class="comment">//url参数不可以为空</span></span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"url == null"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		com.alibaba.dubbo.common.URL url = arg1;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//使用url的protocol属性值(这里为registry)，作为扩展名称，如果为空，则默认使用"dubbo"</span></span><br><span class="line">		String extName = url.getProtocol() == <span class="keyword">null</span> ? <span class="string">"dubbo"</span> : url.getProtocol();</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(extName == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Fail to get extension(com.alibaba.dubbo.rpc.Protocol) name from url("</span> + url.toString() + <span class="string">") use keys([protocol])"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//获取扩展名称为extName的Protocol扩展实例(这里可能是被包装过的类)</span></span><br><span class="line">		com.alibaba.dubbo.rpc.Protocol extension = (com.alibaba.dubbo.rpc.Protocol)ExtensionLoader.getExtensionLoader(com.alibaba.dubbo.rpc.Protocol.class).getExtension(extName);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//调用该extension实例的refer方法</span></span><br><span class="line">		<span class="keyword">return</span> extension.refer(arg0, arg1);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里和服务暴露时的流程一样，将会调用两个包装类ProtocolFilterWrapper和ProtocolListenerWrapper的refer方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProtocolFilterWrapper</span> <span class="keyword">implements</span> <span class="title">Protocol</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">refer</span><span class="params">(Class&lt;T&gt; type, URL url)</span> <span class="keyword">throws</span> RpcException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (Constants.REGISTRY_PROTOCOL.equals(url.getProtocol())) &#123;</span><br><span class="line">		    <span class="comment">//这里将会调用ProtocolListenerWrapper类的refer方法</span></span><br><span class="line">		    <span class="keyword">return</span> protocol.refer(type, url);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> buildInvokerChain(protocol.refer(type, url), Constants.REFERENCE_FILTER_KEY, Constants.CONSUMER);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProtocolListenerWrapper</span> <span class="keyword">implements</span> <span class="title">Protocol</span> </span>&#123;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> type interface com.alibaba.dubbo.demo.DemoService</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> url  registry://224.5.6.7:1234/com.alibaba.dubbo.registry.RegistryService?application=demo-consumer&amp;dubbo=2.0.0&amp;pid=1512&amp;qos.port=33333&amp;refer=application%3Ddemo-consumer%26check%3Dfalse%26dubbo%3D2.0.0%26interface%3Dcom.alibaba.dubbo.demo.DemoService%26methods%3DsayHello%26pid%3D1512%26qos.port%3D33333%26register.ip%3D192.168.99.60%26side%3Dconsumer%26timestamp%3D1528340394760&amp;registry=multicast&amp;timestamp=1528340417091</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> RpcException</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">refer</span><span class="params">(Class&lt;T&gt; type, URL url)</span> <span class="keyword">throws</span> RpcException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (Constants.REGISTRY_PROTOCOL.equals(url.getProtocol())) &#123;</span><br><span class="line">		    <span class="comment">//这里将会调用RegistryProtocol类的refer方法</span></span><br><span class="line">		    <span class="keyword">return</span> protocol.refer(type, url);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ListenerInvokerWrapper&lt;T&gt;(protocol.refer(type, url),</span><br><span class="line">			Collections.unmodifiableList(</span><br><span class="line">				ExtensionLoader.getExtensionLoader(InvokerListener.class)</span><br><span class="line">					.getActivateExtension(url, Constants.INVOKER_LISTENER_KEY)));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>RegistryProtocol的refer方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type远程服务接口类型</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> url 远程服务的URL地址</span></span><br><span class="line"><span class="comment"> * registry://172.172.172.47:2181/com.alibaba.dubbo.registry.RegistryService?application=demo-consumer&amp;dubbo=2.0.0&amp;pid=1172&amp;qos.port=33333&amp;refer=application%3Ddemo-consumer%26check%3Dfalse%26dubbo%3D2.0.0%26interface%3Dcom.alibaba.dubbo.demo.DemoService%26methods%3DsayHello%26pid%3D1172%26qos.port%3D33333%26register.ip%3D192.168.99.60%26side%3Dconsumer%26timestamp%3D1535094943004&amp;registry=zookeeper&amp;timestamp=1535095022853</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> RpcException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">refer</span><span class="params">(Class&lt;T&gt; type, URL url)</span> <span class="keyword">throws</span> RpcException </span>&#123;</span><br><span class="line">	<span class="comment">//生成注册中心url</span></span><br><span class="line">	url = url.setProtocol(</span><br><span class="line">		<span class="comment">//设置协议，从url中的registry参数中获取注册时的协议(zookeeper)，没有获取到的话，则默认为dubbo协议</span></span><br><span class="line">		url.getParameter(Constants.REGISTRY_KEY, Constants.DEFAULT_REGISTRY)</span><br><span class="line">		<span class="comment">//然后移除registry参数</span></span><br><span class="line">	).removeParameter(Constants.REGISTRY_KEY);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//根据url获取注册中心</span></span><br><span class="line">	<span class="comment">//zookeeper://172.172.172.47:2181/com.alibaba.dubbo.registry.RegistryService?application=demo-consumer&amp;dubbo=2.0.0&amp;pid=1172&amp;qos.port=33333&amp;refer=application%3Ddemo-consumer%26check%3Dfalse%26dubbo%3D2.0.0%26interface%3Dcom.alibaba.dubbo.demo.DemoService%26methods%3DsayHello%26pid%3D1172%26qos.port%3D33333%26register.ip%3D192.168.99.60%26side%3Dconsumer%26timestamp%3D1535094943004&amp;timestamp=1535095022853</span></span><br><span class="line">	Registry registry = registryFactory.getRegistry(url);</span><br><span class="line">	<span class="keyword">if</span> (RegistryService.class.equals(type)) &#123;</span><br><span class="line">	    <span class="keyword">return</span> proxyFactory.getInvoker((T) registry, type, url);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//获取url中的refer参数，并转换成map</span></span><br><span class="line">	Map&lt;String, String&gt; qs = StringUtils.parseQueryString(</span><br><span class="line">		url.getParameterAndDecoded(Constants.REFER_KEY)</span><br><span class="line">	);</span><br><span class="line">	<span class="comment">//获取map中的group参数</span></span><br><span class="line">	String group = qs.get(Constants.GROUP_KEY);</span><br><span class="line">	<span class="keyword">if</span> (group != <span class="keyword">null</span> &amp;&amp; group.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">	    <span class="keyword">if</span> ((Constants.COMMA_SPLIT_PATTERN.split(group)).length &gt; <span class="number">1</span></span><br><span class="line">		    || <span class="string">"*"</span>.equals(group)) &#123;</span><br><span class="line">		<span class="comment">//group="a,b" or group="*"</span></span><br><span class="line">		<span class="keyword">return</span> doRefer(getMergeableCluster(), registry, type, url);</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> doRefer(cluster, registry, type, url);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> cluster</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> registry 注册中心</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type 远程服务接口类型</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> url 注册中心url</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">doRefer</span><span class="params">(Cluster cluster, Registry registry, Class&lt;T&gt; type, URL url)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//根据服务接口type和注册中心url创建RegistryDirectory对象(后面会分析该方法)</span></span><br><span class="line">	<span class="comment">//Directory代表多个Invoker,可以把它看成List&lt;Invoker&gt;，</span></span><br><span class="line">        <span class="comment">//但与List不同的是,它的值可能是动态变化的,比如注册中心推送变更</span></span><br><span class="line">	RegistryDirectory&lt;T&gt; directory = <span class="keyword">new</span> RegistryDirectory&lt;T&gt;(type, url);</span><br><span class="line">	<span class="comment">//设置注册中心实例</span></span><br><span class="line">	directory.setRegistry(registry);</span><br><span class="line">	<span class="comment">//设置协议</span></span><br><span class="line">	directory.setProtocol(protocol);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//refer参数指定的url的所有属性</span></span><br><span class="line">	Map&lt;String, String&gt; parameters = <span class="keyword">new</span> HashMap&lt;String, String&gt;(directory.getUrl().getParameters());</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//生成消费者url</span></span><br><span class="line">	<span class="comment">//consumer://192.168.99.60/com.alibaba.dubbo.demo.DemoService?application=demo-consumer&amp;check=false&amp;dubbo=2.0.0&amp;interface=com.alibaba.dubbo.demo.DemoService&amp;methods=sayHello&amp;pid=1172&amp;qos.port=33333&amp;side=consumer&amp;timestamp=1535094943004</span></span><br><span class="line">	URL subscribeUrl = <span class="keyword">new</span> URL(Constants.CONSUMER_PROTOCOL, parameters.remove(Constants.REGISTER_IP_KEY), <span class="number">0</span>, type.getName(), parameters);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (!Constants.ANY_VALUE.equals(url.getServiceInterface())</span><br><span class="line">		&amp;&amp; url.getParameter(Constants.REGISTER_KEY, <span class="keyword">true</span>)) &#123;</span><br><span class="line">	    <span class="comment">//注册消费者，添加category=consumers,check=false参数</span></span><br><span class="line">	    registry.register(subscribeUrl.addParameters(Constants.CATEGORY_KEY, Constants.CONSUMERS_CATEGORY,</span><br><span class="line">		    Constants.CHECK_KEY, String.valueOf(<span class="keyword">false</span>)));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//订阅此url</span></span><br><span class="line">	directory.subscribe(subscribeUrl.addParameter(Constants.CATEGORY_KEY,</span><br><span class="line">		<span class="comment">//提供者 /dubbo/interfaceClass/providers</span></span><br><span class="line">		<span class="comment">//配置  /dubbo/interfaceClass/configurators</span></span><br><span class="line">		<span class="comment">//路由  /dubbo/interfaceClass/routers</span></span><br><span class="line">		Constants.PROVIDERS_CATEGORY</span><br><span class="line">			+ <span class="string">","</span> + Constants.CONFIGURATORS_CATEGORY</span><br><span class="line">			+ <span class="string">","</span> + Constants.ROUTERS_CATEGORY));</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//Cluster将Directory中的多个Invoker伪装成一个Invoker,对上层透明,伪装过程包含了容错逻辑,调用失败后,重试另一个(后面会分析该方法)</span></span><br><span class="line">	Invoker invoker = cluster.join(directory);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//注册消费者</span></span><br><span class="line">	ProviderConsumerRegTable.registerConsumer(invoker, url, subscribeUrl, directory);</span><br><span class="line">	<span class="keyword">return</span> invoker;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里首先注册了消费者，然后订阅了相关目录(providers、configurations、routers)，当有相应服务提供者提供服务时，注册中心会通过notify通知到消费者，接着消费者会通过RegistryDirectory类异步更新本地缓存。<br>注册消费者时，首先会调用AbstractRegistry类的register方法，将注册url保存起来，然后会调用FailbackRegistry类的register方法，在该方法中会调用doRegister方法(该方法调用失败的话，会稍后进行重试),最后会调用ZookeeperRegistry的doRegister方法，进行最终的注册。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ZookeeperRegistry类的doRegister方法</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doRegister</span><span class="params">(URL url)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">	    <span class="comment">//执行注册 dubbo://192.168.99.60:20880/com.alibaba.dubbo.demo.DemoService?anyhost=true&amp;application=demo-provider&amp;dubbo=2.0.0&amp;generic=false&amp;interface=com.alibaba.dubbo.demo.DemoService&amp;methods=sayHello&amp;pid=5312&amp;side=provider&amp;timestamp=1534994264738</span></span><br><span class="line">	    <span class="comment">//根据url确定节点路径；根据url的dynamic参数确定是否是临时节点 /dubbo/com.alibaba.dubbo.demo.DemoService/providers/dubbo%3A%2F%2F192.168.99.60%3A20880%2Fcom.alibaba.dubbo.demo.DemoService%3Fanyhost%3Dtrue%26application%3Ddemo-provider%26dubbo%3D2.0.0%26generic%3Dfalse%26interface%3Dcom.alibaba.dubbo.demo.DemoService%26methods%3DsayHello%26pid%3D5312%26side%3Dprovider%26timestamp%3D1534994264738</span></span><br><span class="line">	    zkClient.create(toUrlPath(url), url.getParameter(Constants.DYNAMIC_KEY, <span class="keyword">true</span>));</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">	    <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">"Failed to register "</span> + url + <span class="string">" to zookeeper "</span> + getUrl() + <span class="string">", cause: "</span> + e.getMessage(), e);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>订阅时，会调用RegistryDirectory类的subscribe方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RegistryDirectory</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractDirectory</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">NotifyListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 订阅url</span></span><br><span class="line"><span class="comment">	* <span class="doctag">@param</span> url 消费者url </span></span><br><span class="line"><span class="comment">	* consumer://192.168.99.60/com.alibaba.dubbo.demo.DemoService?application=demo-consumer&amp;category=providers,configurators,routers&amp;check=false&amp;dubbo=2.0.0&amp;interface=com.alibaba.dubbo.demo.DemoService&amp;methods=sayHello&amp;pid=1880&amp;qos.port=33333&amp;side=consumer&amp;timestamp=1535449640995</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(URL url)</span> </span>&#123;</span><br><span class="line">		<span class="comment">//设置消费者url(将url保存到AbstractDirectory父类中)</span></span><br><span class="line">		setConsumerUrl(url);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//订阅该消费者url(this即为当前RegistryDirectory对象,它实现了NotifyListener接口)</span></span><br><span class="line">		<span class="comment">//首先调用AbstractRegistry的subscribe方法(保存订阅信息)</span></span><br><span class="line">		<span class="comment">//接着调用FailbackRegistry的subscribe方法(调用ZookeeperRegistry的doSubscribe方法，如果发生异常了会捕获到，然后保存下来稍后重试)</span></span><br><span class="line">		<span class="comment">//然后调用ZookeeperRegistry的doSubscribe方法(获取待通知urls，最后调用notify方法进行通知)</span></span><br><span class="line">		registry.subscribe(url, <span class="keyword">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们简单看下ZookeeperRegistry类的doSubscribe方法，其中省略掉了一些代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//此listener参数就是上文创建的RegistryDirectory类</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doSubscribe</span><span class="params">(<span class="keyword">final</span> URL url, <span class="keyword">final</span> NotifyListener listener)</span> </span>&#123;</span><br><span class="line">	List&lt;URL&gt; urls = <span class="keyword">new</span> ArrayList&lt;URL&gt;();</span><br><span class="line">	<span class="comment">//根据toCategoriesPath(url)方法获取到类别列表，然后遍历该列表</span></span><br><span class="line">	<span class="comment">//如：/dubbo/com.alibaba.dubbo.demo.DemoService/providers</span></span><br><span class="line">	<span class="keyword">for</span> (String path : toCategoriesPath(url)) &#123;</span><br><span class="line">	    ConcurrentMap&lt;NotifyListener, ChildListener&gt; listeners = zkListeners.get(url);</span><br><span class="line">	    <span class="keyword">if</span> (listeners == <span class="keyword">null</span>) &#123;</span><br><span class="line">		zkListeners.putIfAbsent(url, <span class="keyword">new</span> ConcurrentHashMap&lt;NotifyListener, ChildListener&gt;());</span><br><span class="line">		listeners = zkListeners.get(url);</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="comment">//根据dubbo的监听获取zk的监听</span></span><br><span class="line">	    ChildListener zkListener = listeners.get(listener);</span><br><span class="line">	    <span class="keyword">if</span> (zkListener == <span class="keyword">null</span>) &#123;</span><br><span class="line">	        <span class="comment">//创建节点监听</span></span><br><span class="line">		listeners.putIfAbsent(listener, <span class="keyword">new</span> ChildListener() &#123;</span><br><span class="line">		    <span class="meta">@Override</span></span><br><span class="line">		    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">childChanged</span><span class="params">(String parentPath, List&lt;String&gt; currentChilds)</span> </span>&#123;</span><br><span class="line">			<span class="comment">//执行通知</span></span><br><span class="line">			ZookeeperRegistry.<span class="keyword">this</span>.notify(url, listener, toUrlsWithEmpty(url, parentPath, currentChilds));</span><br><span class="line">		    &#125;</span><br><span class="line">		&#125;);</span><br><span class="line">		zkListener = listeners.get(listener);</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="comment">//创建path节点,</span></span><br><span class="line">	    <span class="comment">//即：/dubbo/com.xxx.demoService/providers</span></span><br><span class="line">	    <span class="comment">//即：/dubbo/consumers  /dubbo/com.alibaba.dubbo.demo.DemoService/configurators</span></span><br><span class="line">	    zkClient.create(path, <span class="keyword">false</span>);</span><br><span class="line">	    <span class="comment">//为path节点添加zkListener监听(children变量即为该path节点的子节点数据)</span></span><br><span class="line">	    List&lt;String&gt; children = zkClient.addChildListener(path, zkListener);</span><br><span class="line">	    <span class="keyword">if</span> (children != <span class="keyword">null</span>) &#123;</span><br><span class="line">	        <span class="comment">//节点数据(待通知列表)</span></span><br><span class="line">		<span class="comment">//empty://192.168.99.60:20880/com.alibaba.dubbo.demo.DemoService?anyhost=true&amp;application=demo-provider&amp;category=configurators&amp;check=false&amp;dubbo=2.0.0&amp;generic=false&amp;interface=com.alibaba.dubbo.demo.DemoService&amp;methods=sayHello&amp;pid=6504&amp;side=provider&amp;timestamp=1534927826842</span></span><br><span class="line">		urls.addAll(toUrlsWithEmpty(url, path, children));</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//执行通知(urls即为待通知的消息列表)</span></span><br><span class="line">	notify(url, listener, urls);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>调用notify方法进行通知时,会先调用FailbackRegistry类的notify方法,内部会调用doNotify方法(调用失败的话,会保存失败信息,稍后重试)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//FailbackRegistry类的notify</span></span><br><span class="line"><span class="comment">//省略了一些不重要的代码</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(URL url, NotifyListener listener, List&lt;URL&gt; urls)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">	    <span class="comment">//执行通知(将会调用父类AbstractRegistry中的notify方法)</span></span><br><span class="line">	    doNotify(url, listener, urls);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception t) &#123;</span><br><span class="line">	    <span class="comment">//通知失败，添加到失败列表，定期重试</span></span><br><span class="line">	    Map&lt;NotifyListener, List&lt;URL&gt;&gt; listeners = failedNotified.get(url);</span><br><span class="line">	    <span class="keyword">if</span> (listeners == <span class="keyword">null</span>) &#123;</span><br><span class="line">		failedNotified.putIfAbsent(url, <span class="keyword">new</span> ConcurrentHashMap&lt;NotifyListener, List&lt;URL&gt;&gt;());</span><br><span class="line">		listeners = failedNotified.get(url);</span><br><span class="line">	    &#125;</span><br><span class="line">	    listeners.put(listener, urls);</span><br><span class="line">	    logger.error(<span class="string">"Failed to notify for subscribe "</span> + url + <span class="string">", waiting for retry, cause: "</span> + t.getMessage(), t);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>而doNotify方法最终会调用AbstractRegistry类的notify方法,在AbstractRegistry类的notify方法中,会根据category将待通知urls进行分组,然后挨个处理每一个category,并按照&lt;订阅url服务唯一标识,空格分隔的多个待通知url&gt;的形式，保存到本地properties文件中，最后调用RegistryDirectory类的notify方法将待通知列表categoryList下发给消费者。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//AbstractRegistry类的notify方法</span></span><br><span class="line"><span class="comment">//省略了一些不重要的代码</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(URL url, NotifyListener listener, List&lt;URL&gt; urls)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//&lt;category,List&lt;URL&gt;&gt;</span></span><br><span class="line">	Map&lt;String, List&lt;URL&gt;&gt; result = <span class="keyword">new</span> HashMap&lt;String, List&lt;URL&gt;&gt;();</span><br><span class="line">	<span class="comment">//遍历待通知urls，根据url中的category参数进行分组，保存到result中</span></span><br><span class="line">	<span class="keyword">for</span> (URL u : urls) &#123;</span><br><span class="line">	    <span class="comment">//url和u是否匹配(url的范围是否比u大)</span></span><br><span class="line">	    <span class="keyword">if</span> (UrlUtils.isMatch(url, u)) &#123;</span><br><span class="line">		<span class="comment">//获取待通知url的category，默认值是providers</span></span><br><span class="line">		String category = u.getParameter(Constants.CATEGORY_KEY, Constants.DEFAULT_CATEGORY);</span><br><span class="line">		List&lt;URL&gt; categoryList = result.get(category);</span><br><span class="line">		<span class="keyword">if</span> (categoryList == <span class="keyword">null</span>) &#123;</span><br><span class="line">		    categoryList = <span class="keyword">new</span> ArrayList&lt;URL&gt;();</span><br><span class="line">		    result.put(category, categoryList);</span><br><span class="line">		&#125;</span><br><span class="line">		categoryList.add(u);</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (result.size() == <span class="number">0</span>) &#123;</span><br><span class="line">	    <span class="comment">//类别待通知url列表为空，直接返回</span></span><br><span class="line">	    <span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//下面会将notified中的url及其values.values中的URL保存到缓存文件中</span></span><br><span class="line">	Map&lt;String, List&lt;URL&gt;&gt; categoryNotified = notified.get(url);</span><br><span class="line">	<span class="keyword">if</span> (categoryNotified == <span class="keyword">null</span>) &#123;</span><br><span class="line">	    notified.putIfAbsent(url, <span class="keyword">new</span> ConcurrentHashMap&lt;String, List&lt;URL&gt;&gt;());</span><br><span class="line">	    categoryNotified = notified.get(url);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (Map.Entry&lt;String, List&lt;URL&gt;&gt; entry : result.entrySet()) &#123;</span><br><span class="line">	    <span class="comment">//类别</span></span><br><span class="line">	    String category = entry.getKey();</span><br><span class="line">	    <span class="comment">//类别待通知url列表</span></span><br><span class="line">	    List&lt;URL&gt; categoryList = entry.getValue();</span><br><span class="line">	    <span class="comment">//保存&lt;类别,类别待通知url列表&gt;</span></span><br><span class="line">	    categoryNotified.put(category, categoryList);</span><br><span class="line">	    <span class="comment">//保存注册中心缓存文件(将订阅url、待通知url列表保存到缓存文件)</span></span><br><span class="line">	    saveProperties(url);</span><br><span class="line">	    <span class="comment">//触发通知给消费者(类别待通知url列表)，此listener就是RegistryDirectory类</span></span><br><span class="line">	    listener.notify(categoryList);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后我们来看RegistryDirectory类的notify方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(List&lt;URL&gt; urls)</span> </span>&#123;</span><br><span class="line">	List&lt;URL&gt; invokerUrls = <span class="keyword">new</span> ArrayList&lt;URL&gt;();</span><br><span class="line">	List&lt;URL&gt; routerUrls = <span class="keyword">new</span> ArrayList&lt;URL&gt;();</span><br><span class="line">	List&lt;URL&gt; configuratorUrls = <span class="keyword">new</span> ArrayList&lt;URL&gt;();</span><br><span class="line">	<span class="comment">//遍历待通知列表，根据category进行分组，并分别保存到上面定义的list列表中</span></span><br><span class="line">	<span class="keyword">for</span> (URL url : urls) &#123;</span><br><span class="line">	    <span class="comment">//获取url协议</span></span><br><span class="line">	    String protocol = url.getProtocol();</span><br><span class="line">	    <span class="comment">//获取url分类</span></span><br><span class="line">	    String category = url.getParameter(Constants.CATEGORY_KEY, Constants.DEFAULT_CATEGORY);</span><br><span class="line">	    <span class="keyword">if</span> (Constants.ROUTERS_CATEGORY.equals(category)</span><br><span class="line">		    || Constants.ROUTE_PROTOCOL.equals(protocol)) &#123;</span><br><span class="line">		<span class="comment">//添加路由url</span></span><br><span class="line">		routerUrls.add(url);</span><br><span class="line">	    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Constants.CONFIGURATORS_CATEGORY.equals(category)</span><br><span class="line">		    || Constants.OVERRIDE_PROTOCOL.equals(protocol)) &#123;</span><br><span class="line">		<span class="comment">//添加配置url</span></span><br><span class="line">		configuratorUrls.add(url);</span><br><span class="line">	    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Constants.PROVIDERS_CATEGORY.equals(category)) &#123;</span><br><span class="line">		<span class="comment">//添加服务提供者url</span></span><br><span class="line">		invokerUrls.add(url);</span><br><span class="line">	    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">//不支持的分类</span></span><br><span class="line">		logger.warn(<span class="string">"Unsupported category "</span> + category + <span class="string">" in notified url: "</span> + url + <span class="string">" from registry "</span> + getUrl().getAddress() + <span class="string">" to consumer "</span> + NetUtils.getLocalHost());</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (configuratorUrls != <span class="keyword">null</span> &amp;&amp; !configuratorUrls.isEmpty()) &#123;</span><br><span class="line">	    <span class="comment">//将url转换成Configurator类并保存(后面会分析该方法)</span></span><br><span class="line">	    <span class="keyword">this</span>.configurators = toConfigurators(configuratorUrls);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (routerUrls != <span class="keyword">null</span> &amp;&amp; !routerUrls.isEmpty()) &#123;</span><br><span class="line">	    <span class="comment">//将路由url转换成路由对象(后面会分析该方法)</span></span><br><span class="line">	    List&lt;Router&gt; routers = toRouters(routerUrls);</span><br><span class="line">	    <span class="keyword">if</span> (routers != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="comment">//保存路由(后面会分析该方法)</span></span><br><span class="line">		setRouters(routers);</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	List&lt;Configurator&gt; localConfigurators = <span class="keyword">this</span>.configurators;</span><br><span class="line">	<span class="comment">//合并override参数</span></span><br><span class="line">	<span class="keyword">this</span>.overrideDirectoryUrl = directoryUrl;</span><br><span class="line">	<span class="keyword">if</span> (localConfigurators != <span class="keyword">null</span> &amp;&amp; !localConfigurators.isEmpty()) &#123;</span><br><span class="line">	    <span class="keyword">for</span> (Configurator configurator : localConfigurators) &#123;</span><br><span class="line">		<span class="comment">//根据configurator覆盖overrideDirectoryUrl中的属性，</span></span><br><span class="line">		<span class="comment">//或者将configurator中的属性添加到overrideDirectoryUrl中</span></span><br><span class="line">		<span class="keyword">this</span>.overrideDirectoryUrl = configurator.configure(overrideDirectoryUrl);</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//刷新Invoker(后面会分析该方法)</span></span><br><span class="line">	refreshInvoker(invokerUrls);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接下来，我们来挨个看下上面用到的方法</p>
<h4 id="更新Configurator"><a href="#更新Configurator" class="headerlink" title="更新Configurator"></a>更新Configurator</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将待通知url转换成Configurator</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Configurator&gt; <span class="title">toConfigurators</span><span class="params">(List&lt;URL&gt; urls)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (urls == <span class="keyword">null</span> || urls.isEmpty()) &#123;</span><br><span class="line">	    <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">	&#125;</span><br><span class="line">	List&lt;Configurator&gt; configurators = <span class="keyword">new</span> ArrayList&lt;Configurator&gt;(urls.size());</span><br><span class="line">	<span class="comment">//遍历待通知url列表</span></span><br><span class="line">	<span class="keyword">for</span> (URL url : urls) &#123;</span><br><span class="line">	    <span class="keyword">if</span> (Constants.EMPTY_PROTOCOL.equals(url.getProtocol())) &#123;</span><br><span class="line">		<span class="comment">//协议为empty，则清空configurators，并跳出循环</span></span><br><span class="line">		configurators.clear();</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="comment">//获取url所有参数</span></span><br><span class="line">	    Map&lt;String, String&gt; override = <span class="keyword">new</span> HashMap&lt;String, String&gt;(url.getParameters());</span><br><span class="line">	    </span><br><span class="line">	    <span class="comment">//override的anyhost参数可以被自动添加</span></span><br><span class="line">	    <span class="comment">//它不可以改变对变化中的url的判断，因此需要移除掉anyhost参数</span></span><br><span class="line">	    override.remove(Constants.ANYHOST_KEY);</span><br><span class="line">	    <span class="keyword">if</span> (override.size() == <span class="number">0</span>) &#123;</span><br><span class="line">		configurators.clear();</span><br><span class="line">		<span class="keyword">continue</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="comment">//添加配置</span></span><br><span class="line">	    configurators.add(configuratorFactory.getConfigurator(url));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//排序</span></span><br><span class="line">	Collections.sort(configurators);</span><br><span class="line">	<span class="keyword">return</span> configurators;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="更新Router"><a href="#更新Router" class="headerlink" title="更新Router"></a>更新Router</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将待通知url转换成Router对象</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> List&lt;Router&gt; <span class="title">toRouters</span><span class="params">(List&lt;URL&gt; urls)</span> </span>&#123;</span><br><span class="line">	List&lt;Router&gt; routers = <span class="keyword">new</span> ArrayList&lt;Router&gt;();</span><br><span class="line">	<span class="keyword">if</span> (urls == <span class="keyword">null</span> || urls.isEmpty()) &#123;</span><br><span class="line">	    <span class="keyword">return</span> routers;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (urls != <span class="keyword">null</span> &amp;&amp; !urls.isEmpty()) &#123;</span><br><span class="line">	    <span class="comment">//遍历待通知url列表</span></span><br><span class="line">	    <span class="keyword">for</span> (URL url : urls) &#123;</span><br><span class="line">		<span class="keyword">if</span> (Constants.EMPTY_PROTOCOL.equals(url.getProtocol())) &#123;</span><br><span class="line">		    <span class="comment">//协议为empty的话，直接返回</span></span><br><span class="line">		    <span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//获取url的router参数，该参数标识了路由协议</span></span><br><span class="line">		String routerType = url.getParameter(Constants.ROUTER_KEY);</span><br><span class="line">		<span class="keyword">if</span> (routerType != <span class="keyword">null</span> &amp;&amp; routerType.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		    <span class="comment">//设置路由协议</span></span><br><span class="line">		    url = url.setProtocol(routerType);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">		    <span class="comment">//根据url获取路由实例</span></span><br><span class="line">		    Router router = routerFactory.getRouter(url);</span><br><span class="line">		    <span class="keyword">if</span> (!routers.contains(router)) &#123;</span><br><span class="line">			<span class="comment">//添加路由</span></span><br><span class="line">			routers.add(router);</span><br><span class="line">		    &#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">		    logger.error(<span class="string">"convert router url to router error, url: "</span> + url, t);</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> routers;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setRouters</span><span class="params">(List&lt;Router&gt; routers)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//复制routers列表</span></span><br><span class="line">	routers = routers == <span class="keyword">null</span> ? <span class="keyword">new</span> ArrayList&lt;Router&gt;() : <span class="keyword">new</span> ArrayList&lt;Router&gt;(routers);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//获取路由工厂的扩展名称</span></span><br><span class="line">	String routerkey = url.getParameter(Constants.ROUTER_KEY);</span><br><span class="line">	<span class="keyword">if</span> (routerkey != <span class="keyword">null</span> &amp;&amp; routerkey.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">	    <span class="comment">//根据 路由工厂扩展名 获取 路由工厂扩展实例</span></span><br><span class="line">	    RouterFactory routerFactory = ExtensionLoader.getExtensionLoader(RouterFactory.class).getExtension(routerkey);</span><br><span class="line">	    <span class="comment">//根据url获取路由实例，并放入routers</span></span><br><span class="line">	    routers.add(routerFactory.getRouter(url));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//添加支持mock协议的invoker选择器</span></span><br><span class="line">	routers.add(<span class="keyword">new</span> MockInvokersSelector());</span><br><span class="line">	<span class="comment">//排序</span></span><br><span class="line">	Collections.sort(routers);</span><br><span class="line">	<span class="comment">//保存最新的路由信息</span></span><br><span class="line">	<span class="keyword">this</span>.routers = routers;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="更新Invoker"><a href="#更新Invoker" class="headerlink" title="更新Invoker"></a>更新Invoker</h4><p>然后我们来看refreshInvoker方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将待通知invoker url转换成invoker Map，转换规则如下：</span></span><br><span class="line"><span class="comment"> * 1、如果url已经转换成invoker，则不再重新引用并直接从缓存中获取，并注意url中的任何参数更改都将被重新引用。</span></span><br><span class="line"><span class="comment"> * 2、如果传入的invoker列表不为空，则意味着这是最新的调用者列表</span></span><br><span class="line"><span class="comment"> * 3、如果传入的invoker列表为空，则意味着该规则只是一个override规则或者route规则，需要重新对比以决定是否需要重新引用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">refreshInvoker</span><span class="params">(List&lt;URL&gt; invokerUrls)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (invokerUrls != <span class="keyword">null</span> &amp;&amp; invokerUrls.size() == <span class="number">1</span> &amp;&amp; invokerUrls.get(<span class="number">0</span>) != <span class="keyword">null</span></span><br><span class="line">		&amp;&amp; Constants.EMPTY_PROTOCOL.equals(invokerUrls.get(<span class="number">0</span>).getProtocol())) &#123;</span><br><span class="line">	    <span class="comment">//empty协议</span></span><br><span class="line">	    <span class="comment">//禁止访问</span></span><br><span class="line">	    <span class="keyword">this</span>.forbidden = <span class="keyword">true</span>;</span><br><span class="line">	    <span class="keyword">this</span>.methodInvokerMap = <span class="keyword">null</span>;</span><br><span class="line">	    <span class="comment">//销毁所有的invokers</span></span><br><span class="line">	    destroyAllInvokers();</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	    <span class="comment">//允许访问</span></span><br><span class="line">	    <span class="keyword">this</span>.forbidden = <span class="keyword">false</span>;</span><br><span class="line">	    <span class="comment">//记录当前的 urlInvokerMap</span></span><br><span class="line">	    Map&lt;String, Invoker&lt;T&gt;&gt; oldUrlInvokerMap = <span class="keyword">this</span>.urlInvokerMap;</span><br><span class="line">	    <span class="keyword">if</span> (invokerUrls.isEmpty() &amp;&amp; <span class="keyword">this</span>.cachedInvokerUrls != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="comment">//收到的invokerUrls为空，但是缓存中的不为空，则使用当前缓存中的invoker</span></span><br><span class="line">		invokerUrls.addAll(<span class="keyword">this</span>.cachedInvokerUrls);</span><br><span class="line">	    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">this</span>.cachedInvokerUrls = <span class="keyword">new</span> HashSet&lt;URL&gt;();</span><br><span class="line">		<span class="comment">//缓存invokerUrls列表，方便比较</span></span><br><span class="line">		<span class="keyword">this</span>.cachedInvokerUrls.addAll(invokerUrls);</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">if</span> (invokerUrls.isEmpty()) &#123;</span><br><span class="line">		<span class="comment">//invoker url列表为空，直接返回</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="comment">//将invoker-url转换成invoker-map(后面会分析该方法)</span></span><br><span class="line">	    Map&lt;String, Invoker&lt;T&gt;&gt; newUrlInvokerMap = toInvokers(invokerUrls);</span><br><span class="line">	    </span><br><span class="line">	    <span class="comment">//建立 方法名与invoker的映射(后面会分析该方法)</span></span><br><span class="line">	    Map&lt;String, List&lt;Invoker&lt;T&gt;&gt;&gt; newMethodInvokerMap = toMethodInvokers(newUrlInvokerMap);</span><br><span class="line">	   </span><br><span class="line">	    <span class="comment">//状态改变</span></span><br><span class="line">	    <span class="keyword">if</span> (newUrlInvokerMap == <span class="keyword">null</span> || newUrlInvokerMap.size() == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="comment">//转换发生错误</span></span><br><span class="line">		logger.error(<span class="keyword">new</span> IllegalStateException(<span class="string">"urls to invokers error .invokerUrls.size :"</span> + invokerUrls.size() + <span class="string">", invoker.size :0. urls :"</span> + invokerUrls.toString()));</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="comment">//保存最新的 methodInvokerMap(后面会分析该方法)</span></span><br><span class="line">	    <span class="keyword">this</span>.methodInvokerMap = multiGroup ? toMergeMethodInvokerMap(newMethodInvokerMap) : newMethodInvokerMap;</span><br><span class="line">	    <span class="comment">//保存最新的 urlInvokerMap</span></span><br><span class="line">	    <span class="keyword">this</span>.urlInvokerMap = newUrlInvokerMap;</span><br><span class="line">	    <span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">//关闭未使用的invoker(后面会分析该方法)</span></span><br><span class="line">		destroyUnusedInvokers(oldUrlInvokerMap, newUrlInvokerMap);</span><br><span class="line">	    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">		logger.warn(<span class="string">"destroyUnusedInvokers error. "</span>, e);</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="toInvokers方法"><a href="#toInvokers方法" class="headerlink" title="toInvokers方法"></a>toInvokers方法</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将invoker-url转换成invoker，如果url已经被引用，将不会重新引用</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> urls 服务提供者url</span></span><br><span class="line"><span class="comment"> * dubbo://192.168.99.60:20880/com.alibaba.dubbo.demo.DemoService?anyhost=true&amp;application=demo-provider&amp;dubbo=2.0.0&amp;generic=false&amp;interface=com.alibaba.dubbo.demo.DemoService&amp;methods=sayHello&amp;pid=6640&amp;side=provider&amp;timestamp=1535449604077</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> invokers</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Map&lt;String, Invoker&lt;T&gt;&gt; toInvokers(List&lt;URL&gt; urls) &#123;</span><br><span class="line">	Map&lt;String, Invoker&lt;T&gt;&gt; newUrlInvokerMap = <span class="keyword">new</span> HashMap&lt;String, Invoker&lt;T&gt;&gt;();</span><br><span class="line">	<span class="keyword">if</span> (urls == <span class="keyword">null</span> || urls.isEmpty()) &#123;</span><br><span class="line">	    <span class="keyword">return</span> newUrlInvokerMap;</span><br><span class="line">	&#125;</span><br><span class="line">	Set&lt;String&gt; keys = <span class="keyword">new</span> HashSet&lt;String&gt;();</span><br><span class="line">	<span class="comment">//获取当前url支持的协议</span></span><br><span class="line">	String queryProtocols = <span class="keyword">this</span>.queryMap.get(Constants.PROTOCOL_KEY);</span><br><span class="line">	<span class="comment">//遍历urls，检测每一个providerUrl是否满足当前调用者url的协议要求(queryProtocols)</span></span><br><span class="line">	<span class="keyword">for</span> (URL providerUrl : urls) &#123;</span><br><span class="line">	    <span class="comment">//如果在reference端配置了协议protocol，则只选择匹配的协议</span></span><br><span class="line">	    <span class="keyword">if</span> (queryProtocols != <span class="keyword">null</span> &amp;&amp; queryProtocols.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">boolean</span> accept = <span class="keyword">false</span>;</span><br><span class="line">		<span class="comment">//可接受的协议数组</span></span><br><span class="line">		String[] acceptProtocols = queryProtocols.split(<span class="string">","</span>);</span><br><span class="line">		<span class="keyword">for</span> (String acceptProtocol : acceptProtocols) &#123;</span><br><span class="line">		    <span class="keyword">if</span> (providerUrl.getProtocol().equals(acceptProtocol)) &#123;</span><br><span class="line">			<span class="comment">//如果该提供者url的协议在可接受的协议范围内，则跳出循环</span></span><br><span class="line">			accept = <span class="keyword">true</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		    &#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!accept) &#123;</span><br><span class="line">		    <span class="comment">//没找到，则判断下一个服务提供者</span></span><br><span class="line">		    <span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">if</span> (Constants.EMPTY_PROTOCOL.equals(providerUrl.getProtocol())) &#123;</span><br><span class="line">	        <span class="comment">//服务提供者协议为empty，则进行下次循环</span></span><br><span class="line">		<span class="keyword">continue</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">if</span> (!ExtensionLoader.getExtensionLoader(Protocol.class).hasExtension(providerUrl.getProtocol())) &#123;</span><br><span class="line">		<span class="comment">//不支持的协议</span></span><br><span class="line">		logger.error(<span class="keyword">new</span> IllegalStateException(<span class="string">"Unsupported protocol "</span> + providerUrl.getProtocol() + <span class="string">" in notified url: "</span> + providerUrl + <span class="string">" from registry "</span> + getUrl().getAddress() + <span class="string">" to consumer "</span> + NetUtils.getLocalHost()</span><br><span class="line">			+ <span class="string">", supported protocol: "</span> + ExtensionLoader.getExtensionLoader(Protocol.class).getSupportedExtensions()));</span><br><span class="line">		<span class="keyword">continue</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="comment">//合并url参数(后面会分析该方法)</span></span><br><span class="line">	    URL url = mergeUrl(providerUrl);</span><br><span class="line">	    </span><br><span class="line">	    <span class="comment">//url的参数已经排过序</span></span><br><span class="line">	    <span class="comment">//dubbo://192.168.99.60:20880/com.alibaba.dubbo.demo.DemoService?anyhost=true&amp;application=demo-consumer&amp;check=false&amp;dubbo=2.0.0&amp;generic=false&amp;interface=com.alibaba.dubbo.demo.DemoService&amp;methods=sayHello&amp;pid=1880&amp;qos.port=33333&amp;register.ip=192.168.99.60&amp;remote.timestamp=1535449604077&amp;side=consumer&amp;timestamp=1535449640995</span></span><br><span class="line">	    String key = url.toFullString();</span><br><span class="line">	    <span class="keyword">if</span> (keys.contains(key)) &#123;</span><br><span class="line">		<span class="comment">//重复的url</span></span><br><span class="line">		<span class="keyword">continue</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	    keys.add(key);</span><br><span class="line">	    <span class="comment">//缓存key是url，不与消费者端的参数合并，无论消费者如何组合参数，</span></span><br><span class="line">            <span class="comment">//如果服务器url发生改变，则重新进行引用</span></span><br><span class="line">	    Map&lt;String, Invoker&lt;T&gt;&gt; localUrlInvokerMap = <span class="keyword">this</span>.urlInvokerMap;</span><br><span class="line">	    <span class="comment">//根据缓存key获取invoker</span></span><br><span class="line">	    Invoker&lt;T&gt; invoker = localUrlInvokerMap == <span class="keyword">null</span> ? <span class="keyword">null</span> : localUrlInvokerMap.get(key);</span><br><span class="line">	    <span class="keyword">if</span> (invoker == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="comment">//不在缓存中，重新引用</span></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">		    <span class="keyword">boolean</span> enabled = <span class="keyword">true</span>;</span><br><span class="line">		    <span class="comment">//获取disabled参数、enabled参数，来判断是否可用</span></span><br><span class="line">		    <span class="keyword">if</span> (url.hasParameter(Constants.DISABLED_KEY)) &#123;</span><br><span class="line">			enabled = !url.getParameter(Constants.DISABLED_KEY, <span class="keyword">false</span>);</span><br><span class="line">		    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			enabled = url.getParameter(Constants.ENABLED_KEY, <span class="keyword">true</span>);</span><br><span class="line">		    &#125;</span><br><span class="line">		    <span class="keyword">if</span> (enabled) &#123;</span><br><span class="line">			<span class="comment">//可以引用，重新引用(后面会介绍)</span></span><br><span class="line">			invoker = <span class="keyword">new</span> InvokerDelegate&lt;T&gt;(</span><br><span class="line">			        <span class="comment">//根据服务接口、远程服务url重新引用</span></span><br><span class="line">				protocol.refer(serviceType, url),</span><br><span class="line">				url,</span><br><span class="line">				providerUrl</span><br><span class="line">			);</span><br><span class="line">		    &#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">		    logger.error(<span class="string">"Failed to refer invoker for interface:"</span> + serviceType + <span class="string">",url:("</span> + url + <span class="string">")"</span> + t.getMessage(), t);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (invoker != <span class="keyword">null</span>) &#123;</span><br><span class="line">		    <span class="comment">//保存新的invoker到缓存</span></span><br><span class="line">		    newUrlInvokerMap.put(key, invoker);</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		newUrlInvokerMap.put(key, invoker);</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	keys.clear();</span><br><span class="line">	<span class="keyword">return</span> newUrlInvokerMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="toMethodInvokers方法"><a href="#toMethodInvokers方法" class="headerlink" title="toMethodInvokers方法"></a>toMethodInvokers方法</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取Invoker和method之间的映射关系</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> invokersMap Invoker Map</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> Mapping relation between Invoker and method</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Map&lt;String, List&lt;Invoker&lt;T&gt;&gt;&gt; toMethodInvokers(Map&lt;String, Invoker&lt;T&gt;&gt; invokersMap) &#123;</span><br><span class="line">	<span class="comment">//method与invoker列表的映射</span></span><br><span class="line">	Map&lt;String, List&lt;Invoker&lt;T&gt;&gt;&gt; newMethodInvokerMap = <span class="keyword">new</span> HashMap&lt;String, List&lt;Invoker&lt;T&gt;&gt;&gt;();</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// According to the methods classification declared by the provider URL,</span></span><br><span class="line">	<span class="comment">// the methods is compatible with the registry to execute the filtered methods</span></span><br><span class="line">	List&lt;Invoker&lt;T&gt;&gt; invokersList = <span class="keyword">new</span> ArrayList&lt;Invoker&lt;T&gt;&gt;();</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (invokersMap != <span class="keyword">null</span> &amp;&amp; invokersMap.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">	    <span class="comment">//遍历invokers</span></span><br><span class="line">	    <span class="keyword">for</span> (Invoker&lt;T&gt; invoker : invokersMap.values()) &#123;</span><br><span class="line">		<span class="comment">//获取服务提供者方法列表</span></span><br><span class="line">		String parameter = invoker.getUrl().getParameter(Constants.METHODS_KEY);</span><br><span class="line">		<span class="keyword">if</span> (parameter != <span class="keyword">null</span> &amp;&amp; parameter.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		    <span class="comment">//逗号分隔方法</span></span><br><span class="line">		    String[] methods = Constants.COMMA_SPLIT_PATTERN.split(parameter);</span><br><span class="line">		    <span class="keyword">if</span> (methods != <span class="keyword">null</span> &amp;&amp; methods.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">for</span> (String method : methods) &#123;</span><br><span class="line">			    <span class="keyword">if</span> (method != <span class="keyword">null</span> &amp;&amp; method.length() &gt; <span class="number">0</span> &amp;&amp; !Constants.ANY_VALUE.equals(method)) &#123;</span><br><span class="line">				<span class="comment">//通过method获取invoker列表</span></span><br><span class="line">				List&lt;Invoker&lt;T&gt;&gt; methodInvokers = newMethodInvokerMap.get(method);</span><br><span class="line">				<span class="keyword">if</span> (methodInvokers == <span class="keyword">null</span>) &#123;</span><br><span class="line">				    methodInvokers = <span class="keyword">new</span> ArrayList&lt;Invoker&lt;T&gt;&gt;();</span><br><span class="line">				    <span class="comment">//添加方法、invoker映射</span></span><br><span class="line">				    newMethodInvokerMap.put(method, methodInvokers);</span><br><span class="line">				&#125;</span><br><span class="line">				methodInvokers.add(invoker);</span><br><span class="line">			    &#125;</span><br><span class="line">			&#125;</span><br><span class="line">		    &#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//添加invoker</span></span><br><span class="line">		invokersList.add(invoker);</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//根据路由筛选InvokersList(后面会分析该方法)</span></span><br><span class="line">	List&lt;Invoker&lt;T&gt;&gt; newInvokersList = route(invokersList, <span class="keyword">null</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//保存&lt;*,newInvokersList&gt;</span></span><br><span class="line">	newMethodInvokerMap.put(Constants.ANY_VALUE, newInvokersList);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (serviceMethods != <span class="keyword">null</span> &amp;&amp; serviceMethods.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">	    <span class="comment">//遍历服务method列表,并从newMethodInvokerMap中获取该method对应的Invoker列表</span></span><br><span class="line">	    <span class="comment">//如果没有获取到，则将该method映射到newInvokersList列表上</span></span><br><span class="line">	    <span class="keyword">for</span> (String method : serviceMethods) &#123;</span><br><span class="line">		List&lt;Invoker&lt;T&gt;&gt; methodInvokers = newMethodInvokerMap.get(method);</span><br><span class="line">		<span class="keyword">if</span> (methodInvokers == <span class="keyword">null</span> || methodInvokers.isEmpty()) &#123;</span><br><span class="line">		    methodInvokers = newInvokersList;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//根据路由筛选invoker列表，然后保存method、invokerList映射</span></span><br><span class="line">		newMethodInvokerMap.put(method, route(methodInvokers, method));</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (String method : <span class="keyword">new</span> HashSet&lt;String&gt;(newMethodInvokerMap.keySet())) &#123;</span><br><span class="line">	    List&lt;Invoker&lt;T&gt;&gt; methodInvokers = newMethodInvokerMap.get(method);</span><br><span class="line">	    <span class="comment">//排序invoker</span></span><br><span class="line">	    Collections.sort(methodInvokers, InvokerComparator.getComparator());</span><br><span class="line">	    <span class="comment">//不可变集合</span></span><br><span class="line">	    newMethodInvokerMap.put(method, Collections.unmodifiableList(methodInvokers));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> Collections.unmodifiableMap(newMethodInvokerMap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="route方法"><a href="#route方法" class="headerlink" title="route方法"></a>route方法</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据路由筛选InvokersList</span></span><br><span class="line"><span class="comment"> * Router 负责从多个 Invoker 中按路由规则选出子集，比如读写分离，应用隔离等</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> invokers</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> method</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> List&lt;Invoker&lt;T&gt;&gt; route(List&lt;Invoker&lt;T&gt;&gt; invokers, String method) &#123;</span><br><span class="line">	<span class="comment">//创建Invocation对象</span></span><br><span class="line">	Invocation invocation = <span class="keyword">new</span> RpcInvocation(method, <span class="keyword">new</span> Class&lt;?&gt;[<span class="number">0</span>], <span class="keyword">new</span> Object[<span class="number">0</span>]);</span><br><span class="line">	<span class="comment">//获取路由列表</span></span><br><span class="line">	List&lt;Router&gt; routers = getRouters();</span><br><span class="line">	<span class="keyword">if</span> (routers != <span class="keyword">null</span>) &#123;</span><br><span class="line">	    <span class="keyword">for</span> (Router router : routers) &#123;</span><br><span class="line">		<span class="keyword">if</span> (router.getUrl() != <span class="keyword">null</span>) &#123;</span><br><span class="line">		    <span class="comment">//执行路由</span></span><br><span class="line">		    invokers = router.route(invokers, getConsumerUrl(), invocation);</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> invokers;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="toMergeMethodInvokerMap方法"><a href="#toMergeMethodInvokerMap方法" class="headerlink" title="toMergeMethodInvokerMap方法"></a>toMergeMethodInvokerMap方法</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Map&lt;String, List&lt;Invoker&lt;T&gt;&gt;&gt; toMergeMethodInvokerMap(Map&lt;String, List&lt;Invoker&lt;T&gt;&gt;&gt; methodMap) &#123;</span><br><span class="line">	Map&lt;String, List&lt;Invoker&lt;T&gt;&gt;&gt; result = <span class="keyword">new</span> HashMap&lt;String, List&lt;Invoker&lt;T&gt;&gt;&gt;();</span><br><span class="line">	<span class="keyword">for</span> (Map.Entry&lt;String, List&lt;Invoker&lt;T&gt;&gt;&gt; entry : methodMap.entrySet()) &#123;</span><br><span class="line">	    <span class="comment">//当前方法名</span></span><br><span class="line">	    String method = entry.getKey();</span><br><span class="line">	    <span class="comment">//当前invokers</span></span><br><span class="line">	    List&lt;Invoker&lt;T&gt;&gt; invokers = entry.getValue();</span><br><span class="line">	    <span class="comment">//将invokers按照group进行分组，放入到groupMap中(&lt;group,List&lt;invokers&gt;&gt;)</span></span><br><span class="line">	    Map&lt;String, List&lt;Invoker&lt;T&gt;&gt;&gt; groupMap = <span class="keyword">new</span> HashMap&lt;String, List&lt;Invoker&lt;T&gt;&gt;&gt;();</span><br><span class="line">	    <span class="keyword">for</span> (Invoker&lt;T&gt; invoker : invokers) &#123;</span><br><span class="line">		<span class="comment">//当前url的group</span></span><br><span class="line">		String group = invoker.getUrl().getParameter(Constants.GROUP_KEY, <span class="string">""</span>);</span><br><span class="line">		List&lt;Invoker&lt;T&gt;&gt; groupInvokers = groupMap.get(group);</span><br><span class="line">		<span class="keyword">if</span> (groupInvokers == <span class="keyword">null</span>) &#123;</span><br><span class="line">		    groupInvokers = <span class="keyword">new</span> ArrayList&lt;Invoker&lt;T&gt;&gt;();</span><br><span class="line">		    groupMap.put(group, groupInvokers);</span><br><span class="line">		&#125;</span><br><span class="line">		groupInvokers.add(invoker);</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">if</span> (groupMap.size() == <span class="number">1</span>) &#123;</span><br><span class="line">		<span class="comment">//只有一个group</span></span><br><span class="line">		result.put(method, groupMap.values().iterator().next());</span><br><span class="line">	    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (groupMap.size() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">		<span class="comment">//多个group的情况</span></span><br><span class="line">		List&lt;Invoker&lt;T&gt;&gt; groupInvokers = <span class="keyword">new</span> ArrayList&lt;Invoker&lt;T&gt;&gt;();</span><br><span class="line">		<span class="keyword">for</span> (List&lt;Invoker&lt;T&gt;&gt; groupList : groupMap.values()) &#123;</span><br><span class="line">		    <span class="comment">//针对每一个groupList创建一个StaticDirectory，然后生成一个invoker并放入groupInvokers中</span></span><br><span class="line">		    groupInvokers.add(cluster.join(<span class="keyword">new</span> StaticDirectory&lt;T&gt;(groupList)));</span><br><span class="line">		&#125;</span><br><span class="line">		result.put(method, groupInvokers);</span><br><span class="line">	    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">//没有group</span></span><br><span class="line">		result.put(method, invokers);</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="img/toMergeMethodInvokerMap.png" alt=""></p>
<h5 id="销毁无用的invoker"><a href="#销毁无用的invoker" class="headerlink" title="销毁无用的invoker"></a>销毁无用的invoker</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 检测缓存中的invoker是否需要被销毁</span></span><br><span class="line"><span class="comment"> * 如果设置url属性：refer.autodestroy=false</span></span><br><span class="line"><span class="comment"> * invokers将会在不减少的情况下增加，可能会有一个引用泄露</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> oldUrlInvokerMap</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> newUrlInvokerMap</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">destroyUnusedInvokers</span><span class="params">(Map&lt;String, Invoker&lt;T&gt;&gt; oldUrlInvokerMap,Map&lt;String, Invoker&lt;T&gt;&gt; newUrlInvokerMap)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (newUrlInvokerMap == <span class="keyword">null</span> || newUrlInvokerMap.size() == <span class="number">0</span>) &#123;</span><br><span class="line">	    <span class="comment">//关闭所有的invoker</span></span><br><span class="line">	    destroyAllInvokers();</span><br><span class="line">	    <span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	List&lt;String&gt; deleted = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">if</span> (oldUrlInvokerMap != <span class="keyword">null</span>) &#123;</span><br><span class="line">	    Collection&lt;Invoker&lt;T&gt;&gt; newInvokers = newUrlInvokerMap.values();</span><br><span class="line">	    <span class="keyword">for</span> (Map.Entry&lt;String, Invoker&lt;T&gt;&gt; entry : oldUrlInvokerMap.entrySet()) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!newInvokers.contains(entry.getValue())) &#123;</span><br><span class="line">		    <span class="comment">//老的invoker在新的invoker列表中不存在</span></span><br><span class="line">		    <span class="keyword">if</span> (deleted == <span class="keyword">null</span>) &#123;</span><br><span class="line">			deleted = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">		    &#125;</span><br><span class="line">		    <span class="comment">//标记该老的url，后面会进行删除</span></span><br><span class="line">		    deleted.add(entry.getKey());</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (deleted != <span class="keyword">null</span>) &#123;</span><br><span class="line">	    <span class="keyword">for</span> (String url : deleted) &#123;</span><br><span class="line">		<span class="keyword">if</span> (url != <span class="keyword">null</span>) &#123;</span><br><span class="line">		    <span class="comment">//从老的invoker-map中移除该url，并关闭该老的invoker</span></span><br><span class="line">		    Invoker&lt;T&gt; invoker = oldUrlInvokerMap.remove(url);</span><br><span class="line">		    <span class="keyword">if</span> (invoker != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">			    <span class="comment">//销毁该invoker</span></span><br><span class="line">			    invoker.destroy();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			    logger.warn(<span class="string">"destory invoker["</span> + invoker.getUrl() + <span class="string">"] faild. "</span> + e.getMessage(), e);</span><br><span class="line">			&#125;</span><br><span class="line">		    &#125;</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="重新引用invoker"><a href="#重新引用invoker" class="headerlink" title="重新引用invoker"></a>重新引用invoker</h4><p>接下来，我们来看看上面的toInvokers方法中，重新引用invoker的逻辑，即<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (enabled) &#123;</span><br><span class="line">	<span class="comment">//可以引用，重新引用</span></span><br><span class="line">	invoker = <span class="keyword">new</span> InvokerDelegate&lt;T&gt;(</span><br><span class="line">		protocol.refer(serviceType, url),</span><br><span class="line">		url,</span><br><span class="line">		providerUrl</span><br><span class="line">	);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里会先调用ProtocolListenerWrapper类的refer方法,然后在该方法内会在调用ProtocolFilterWrapper类的refer方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">refer</span><span class="params">(Class&lt;T&gt; type, URL url)</span> <span class="keyword">throws</span> RpcException </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (Constants.REGISTRY_PROTOCOL.equals(url.getProtocol())) &#123;</span><br><span class="line">	    <span class="keyword">return</span> protocol.refer(type, url);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> ListenerInvokerWrapper&lt;T&gt;(</span><br><span class="line">	        <span class="comment">//调用ProtocolFilterWrapper类的refer方法获取到invoker</span></span><br><span class="line">		protocol.refer(type, url),</span><br><span class="line">		Collections.unmodifiableList(</span><br><span class="line">		      ExtensionLoader.getExtensionLoader(InvokerListener.class)</span><br><span class="line">				     .getActivateExtension(url, Constants.INVOKER_LISTENER_KEY)</span><br><span class="line">	));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们看下ProtocolFilterWrapper类的refer方法，在该方法内部会去调用DubboProtocol类的refer方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">refer</span><span class="params">(Class&lt;T&gt; type, URL url)</span> <span class="keyword">throws</span> RpcException </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (Constants.REGISTRY_PROTOCOL.equals(url.getProtocol())) &#123;</span><br><span class="line">		<span class="keyword">return</span> protocol.refer(type, url);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//构建invoker链</span></span><br><span class="line">	<span class="keyword">return</span> buildInvokerChain(</span><br><span class="line">		<span class="comment">//调用DubboProtocol类的refer方法</span></span><br><span class="line">		protocol.refer(type, url), </span><br><span class="line">		<span class="comment">//reference.filter</span></span><br><span class="line">		Constants.REFERENCE_FILTER_KEY, </span><br><span class="line">		<span class="comment">//consumer</span></span><br><span class="line">		Constants.CONSUMER</span><br><span class="line">	);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 构建Invoker链</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> invoker</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> group </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">buildInvokerChain</span><span class="params">(<span class="keyword">final</span> Invoker&lt;T&gt; invoker,String key, String group)</span> </span>&#123;</span><br><span class="line">	Invoker&lt;T&gt; last = invoker;</span><br><span class="line">	<span class="comment">//获取过滤器：ConsumerContextFilter、FutureFilter、MonitorFilter</span></span><br><span class="line">	List&lt;Filter&gt; filters = ExtensionLoader.getExtensionLoader(Filter.class).getActivateExtension(invoker.getUrl(), key, group);</span><br><span class="line">	<span class="keyword">if</span> (!filters.isEmpty()) &#123;</span><br><span class="line">	    <span class="keyword">for</span> (<span class="keyword">int</span> i = filters.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">		<span class="comment">//MonitorFilter、FutureFilter、ConsumerContextFilter</span></span><br><span class="line">		<span class="keyword">final</span> Filter filter = filters.get(i);</span><br><span class="line">		<span class="keyword">final</span> Invoker&lt;T&gt; next = last;</span><br><span class="line">		last = <span class="keyword">new</span> Invoker&lt;T&gt;() &#123;</span><br><span class="line">		    <span class="meta">@Override</span></span><br><span class="line">		    <span class="function"><span class="keyword">public</span> Class&lt;T&gt; <span class="title">getInterface</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">return</span> invoker.getInterface();</span><br><span class="line">		    &#125;</span><br><span class="line">		    <span class="meta">@Override</span></span><br><span class="line">		    <span class="function"><span class="keyword">public</span> URL <span class="title">getUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">return</span> invoker.getUrl();</span><br><span class="line">		    &#125;</span><br><span class="line">		    <span class="meta">@Override</span></span><br><span class="line">		    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">return</span> invoker.isAvailable();</span><br><span class="line">		    &#125;</span><br><span class="line">		    <span class="meta">@Override</span></span><br><span class="line">		    <span class="function"><span class="keyword">public</span> Result <span class="title">invoke</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> RpcException </span>&#123;</span><br><span class="line">		        <span class="comment">//调用filter的invoke方法</span></span><br><span class="line">			<span class="keyword">return</span> filter.invoke(next, invocation);</span><br><span class="line">		    &#125;</span><br><span class="line">		    <span class="meta">@Override</span></span><br><span class="line">		    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			invoker.destroy();</span><br><span class="line">		    &#125;</span><br><span class="line">		    <span class="meta">@Override</span></span><br><span class="line">		    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">return</span> invoker.toString();</span><br><span class="line">		    &#125;</span><br><span class="line">		&#125;;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> last;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>DubboProtocol类的refer方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> serviceType com.alibaba.dubbo.demo.DemoService</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> url </span></span><br><span class="line"><span class="comment"> * dubbo://192.168.99.60:20880/com.alibaba.dubbo.demo.DemoService?anyhost=true&amp;application=demo-consumer&amp;check=false&amp;dubbo=2.0.0&amp;generic=false&amp;interface=com.alibaba.dubbo.demo.DemoService&amp;methods=sayHello&amp;pid=5624&amp;qos.port=33333&amp;register.ip=192.168.99.60&amp;remote.timestamp=1535531661191&amp;side=consumer&amp;timestamp=1535531690333</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">refer</span><span class="params">(Class&lt;T&gt; serviceType, URL url)</span> <span class="keyword">throws</span> RpcException </span>&#123;</span><br><span class="line">	<span class="comment">//加载优化序列化类</span></span><br><span class="line">	optimizeSerialization(url);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//创建DubboInvoker</span></span><br><span class="line">	DubboInvoker&lt;T&gt; invoker = <span class="keyword">new</span> DubboInvoker&lt;T&gt;(</span><br><span class="line">		serviceType,</span><br><span class="line">		url,</span><br><span class="line">		<span class="comment">//创建客户端(后面小节会分析该方法)</span></span><br><span class="line">		getClients(url),</span><br><span class="line">		<span class="comment">//当前对象已创建的invoker集合</span></span><br><span class="line">		invokers</span><br><span class="line">	);</span><br><span class="line">	<span class="comment">//将invoker保存到invokers集合中</span></span><br><span class="line">	invokers.add(invoker);</span><br><span class="line">	<span class="keyword">return</span> invoker;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>该invoker中持有一个client对象，默认是NettyClient，后面小节会介绍该过程，最终生成的Invoker如下图，：<br><img src="img/InvokerChain.png" alt=""></p>
<h4 id="registerConsumer注册消费者"><a href="#registerConsumer注册消费者" class="headerlink" title="registerConsumer注册消费者"></a>registerConsumer注册消费者</h4><p>最后调用ProviderConsumerRegTable类的registerConsumer方法注册消费者<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ConcurrentHashMap&lt;String, Set&lt;ConsumerInvokerWrapper&gt;&gt; consumerInvokers = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Set&lt;ConsumerInvokerWrapper&gt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 注册消费者</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> invoker</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> registryUrl 注册中心url</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> consumerUrl 消费者url</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> registryDirectory</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerConsumer</span><span class="params">(Invoker invoker, URL registryUrl, URL consumerUrl, RegistryDirectory registryDirectory)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//创建ConsumerInvokerWrapper</span></span><br><span class="line">	ConsumerInvokerWrapper wrapperInvoker = <span class="keyword">new</span> ConsumerInvokerWrapper(invoker, registryUrl, consumerUrl, registryDirectory);</span><br><span class="line">	<span class="comment">//服务唯一标识</span></span><br><span class="line">	String serviceUniqueName = consumerUrl.getServiceKey();</span><br><span class="line">	<span class="comment">//根据服务唯一标识获取invokers</span></span><br><span class="line">	Set&lt;ConsumerInvokerWrapper&gt; invokers = consumerInvokers.get(serviceUniqueName);</span><br><span class="line">	<span class="keyword">if</span> (invokers == <span class="keyword">null</span>) &#123;</span><br><span class="line">	    consumerInvokers.putIfAbsent(serviceUniqueName, <span class="keyword">new</span> ConcurrentHashSet&lt;ConsumerInvokerWrapper&gt;());</span><br><span class="line">	    invokers = consumerInvokers.get(serviceUniqueName);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//添加wrapperInvoker到缓存</span></span><br><span class="line">	invokers.add(wrapperInvoker);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>到此为止，整个流程就介绍完毕了。下面小节将会介绍一下注册中心Registry。</p>

        
            <div class="donate-container">
    <div class="donate-button">
        <button id="donate-button">赞赏</button>
    </div>
    <div class="donate-img-container hide" id="donate-img-container">
        <img id="donate-img" src="" data-src="/blog/img/pay.png">
        <p> thank you </p>
    </div>
</div>
        
        <div id="comment-container">
        </div>
    </div>
</div>
    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <span>/</span>
        
        <span><a href="https://medium.com/netflix-techblog">Netflix</a></span>
        <span>/</span>
        
        <span><a href="https://engineering.linkedin.com/blog">Linkedin</a></span>
        <span>/</span>
        
        <span><a href="https://blogs.dropbox.com/tech/">Dropbox</a></span>
        <span>/</span>
        
        <span><a href="https://code.fb.com/">Facebook</a></span>
        <span>/</span>
        
        <span><a href="https://www.fpcomplete.com/blog">FPComplete</a></span>
        <span>/</span>
        
        <span><a href="https://blog.janestreet.com/">JaneStreet</a></span>
        <span>/</span>
        
        <span><a href="https://github.com/limengyu1990/">Github</a></span>
        <span>/</span>
        
        <span><a href="https://serokell.io/blog">serokell</a></span>
        <span>/</span>
        
    </p>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/blog/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/blog/js/index.js"></script>
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<!--create by tea9-->

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
    <script>
        var gitalk = new Gitalk({
          clientID: '7cfc73dd62b57f07ed83',
          clientSecret: 'dd03b7e54aadf0d81e4c9c93e23a41272bcfcfa1',
          repo: 'blog',
          owner: 'limengyu1990',
          admin: 'limengyu1990',
          id: location.pathname,      // Ensure uniqueness and length less than 50
          distractionFreeMode: false  // Facebook-like distraction free mode
        })
        gitalk.render('comment-container')
    </script>

<!--end-->


</html>
