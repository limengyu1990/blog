<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/blog/img/favicon.ico">

    <title>
        
        Dubbo源码阅读之集成Spring注解解析(0202) - undefined
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/blog/css/aircloud.css">
    <link rel="stylesheet" href="/blog/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> 所有的善恶都是我，良心一路走来依旧清澈鲜活... </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar">
            <img src="/blog/img/photo.png" />
        </div>
        <div class="name">
            <i>不负如来不负卿</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/blog/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/blog/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/blog/archive">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/blog/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#ReferenceAnnotationBeanPostProcessor类"><span class="toc-text">ReferenceAnnotationBeanPostProcessor类</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#ReferenceInjectionMetadata内部类"><span class="toc-text">ReferenceInjectionMetadata内部类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ReferenceMethodElement内部类"><span class="toc-text">ReferenceMethodElement内部类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ReferenceFieldElement内部类"><span class="toc-text">ReferenceFieldElement内部类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#buildReferenceBean方法"><span class="toc-text">buildReferenceBean方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#AbstractAnnotationConfigBeanBuilder类"><span class="toc-text">AbstractAnnotationConfigBeanBuilder类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ReferenceBeanBuilder实现类"><span class="toc-text">ReferenceBeanBuilder实现类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ReferenceBean类"><span class="toc-text">ReferenceBean类</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#init方法"><span class="toc-text">init方法</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#checkDefault方法"><span class="toc-text">checkDefault方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#appendProperties方法"><span class="toc-text">appendProperties方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#checkInterfaceAndMethods方法"><span class="toc-text">checkInterfaceAndMethods方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#checkApplication方法"><span class="toc-text">checkApplication方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#checkStubAndMock方法"><span class="toc-text">checkStubAndMock方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#appendParameters方法"><span class="toc-text">appendParameters方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#appendAttributes方法"><span class="toc-text">appendAttributes方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#checkAndConvertImplicitConfig方法"><span class="toc-text">checkAndConvertImplicitConfig方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#StaticContext类"><span class="toc-text">StaticContext类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#getUniqueServiceName方法"><span class="toc-text">getUniqueServiceName方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ConsumerModel类"><span class="toc-text">ConsumerModel类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ApplicationModel类"><span class="toc-text">ApplicationModel类</span></a></li></ol></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>
        <div class="index-about-mobile">
            <i> 所有的善恶都是我，良心一路走来依旧清澈鲜活... </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        Dubbo源码阅读之集成Spring注解解析(0202)
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2018-08-07 19:46:49</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/blog/tags/#dubbo" title="dubbo">dubbo</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <blockquote>
<p>本小节将会介绍ReferenceAnnotationBeanPostProcessor类的实现</p>
</blockquote>
<h3 id="ReferenceAnnotationBeanPostProcessor类"><a href="#ReferenceAnnotationBeanPostProcessor类" class="headerlink" title="ReferenceAnnotationBeanPostProcessor类"></a>ReferenceAnnotationBeanPostProcessor类</h3><p>该类用来处理@Reference注解，它实现了BeanPostProcessor接口,实现postProcessPropertyValues方法可以处理每一个属性<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReferenceAnnotationBeanPostProcessor</span> <span class="keyword">extends</span> <span class="title">InstantiationAwareBeanPostProcessorAdapter</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">MergedBeanDefinitionPostProcessor</span>, <span class="title">PriorityOrdered</span>, <span class="title">ApplicationContextAware</span>,<span class="title">BeanClassLoaderAware</span>, <span class="title">DisposableBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ReferenceAnnotationBeanPostProcessor的bean-name</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BEAN_NAME = <span class="string">"referenceAnnotationBeanPostProcessor"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ClassLoader classLoader;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * beanName/className,ReferenceInjectionMetadata</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;String, ReferenceInjectionMetadata&gt; injectionMetadataCache =</span><br><span class="line">            <span class="keyword">new</span> ConcurrentHashMap&lt;String, ReferenceInjectionMetadata&gt;(<span class="number">256</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * cacheKey,referenceBean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;String, ReferenceBean&lt;?&gt;&gt; referenceBeansCache =</span><br><span class="line">            <span class="keyword">new</span> ConcurrentHashMap&lt;String, ReferenceBean&lt;?&gt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置某个属性时调用</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pvs</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pds</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bean</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> BeanCreationException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PropertyValues <span class="title">postProcessPropertyValues</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            PropertyValues pvs, PropertyDescriptor[] pds, Object bean, String beanName)</span> <span class="keyword">throws</span> BeanCreationException </span>&#123;</span><br><span class="line">        <span class="comment">//获取bean的@Reference元数据信息</span></span><br><span class="line">        InjectionMetadata metadata = findReferenceMetadata(beanName, bean.getClass(), pvs);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//对Bean的属性进行自动注入</span></span><br><span class="line">            <span class="comment">//最终会调用内部类ReferenceFieldElement和ReferenceMethodElement的inject方法(后面会介绍)</span></span><br><span class="line">            metadata.inject(bean, beanName, pvs);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (BeanCreationException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(beanName, <span class="string">"Injection of @Reference dependencies failed"</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> pvs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取clazz的<span class="doctag">@Reference</span>元数据信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanName 当前bean的名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clazz    当前bean的class</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pvs      当前bean的属性</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> InjectionMetadata <span class="title">findReferenceMetadata</span><span class="params">(String beanName, Class&lt;?&gt; clazz, PropertyValues pvs)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Fall back to class name as cache key, for backwards compatibility with custom callers.</span></span><br><span class="line">        <span class="comment">//使用beanName或者当前bean的类名称作为cacheKey</span></span><br><span class="line">        String cacheKey = (StringUtils.hasLength(beanName) ? beanName : clazz.getName());</span><br><span class="line">        <span class="comment">// 先从缓存中查询该cacheKey</span></span><br><span class="line">        ReferenceInjectionMetadata metadata = <span class="keyword">this</span>.injectionMetadataCache.get(cacheKey);</span><br><span class="line">        <span class="comment">//是否需要刷新(metadata == null || metadata.targetClass != clazz;则需要刷新)</span></span><br><span class="line">        <span class="keyword">if</span> (InjectionMetadata.needsRefresh(metadata, clazz)) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="keyword">this</span>.injectionMetadataCache) &#123;</span><br><span class="line">                metadata = <span class="keyword">this</span>.injectionMetadataCache.get(cacheKey);</span><br><span class="line">                <span class="keyword">if</span> (InjectionMetadata.needsRefresh(metadata, clazz)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (metadata != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        metadata.clear(pvs);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">//获取clazz中被@Reference注解标注的元数据信息(字段、方法)</span></span><br><span class="line">                        metadata = buildReferenceMetadata(clazz);</span><br><span class="line">                        <span class="comment">//放入缓存</span></span><br><span class="line">                        <span class="keyword">this</span>.injectionMetadataCache.put(cacheKey, metadata);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (NoClassDefFoundError err) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Failed to introspect bean class ["</span> + clazz.getName() +</span><br><span class="line">                                <span class="string">"] for reference metadata: could not find class that it depends on"</span>, err);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> metadata;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取beanClass类中被<span class="doctag">@Reference</span>注解标注的方法和字段</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanClass</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ReferenceInjectionMetadata <span class="title">buildReferenceMetadata</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; beanClass)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//查到beanClass中存在@Reference注解的字段</span></span><br><span class="line">        Collection&lt;ReferenceFieldElement&gt; fieldElements = findFieldReferenceMetadata(beanClass);</span><br><span class="line">        <span class="comment">//查到beanClass中存在@Reference注解的方法</span></span><br><span class="line">        Collection&lt;ReferenceMethodElement&gt; methodElements = findMethodReferenceMetadata(beanClass);</span><br><span class="line">        <span class="comment">//创建新的元数据信息</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ReferenceInjectionMetadata(beanClass, fieldElements, methodElements);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从给定的类中查询到所有标注<span class="doctag">@Reference</span>注解的字段</span></span><br><span class="line"><span class="comment">     * 然后根据该字段和<span class="doctag">@Reference</span>注解</span></span><br><span class="line"><span class="comment">     * 创建ReferenceFieldElement类(InjectionMetadata.InjectedElement的子类)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanClass 当前bean的class</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> non-null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;ReferenceFieldElement&gt; <span class="title">findFieldReferenceMetadata</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; beanClass)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> List&lt;ReferenceFieldElement&gt; elements = <span class="keyword">new</span> LinkedList&lt;ReferenceFieldElement&gt;();</span><br><span class="line">        <span class="comment">//操作字段时执行的回调</span></span><br><span class="line">        ReflectionUtils.doWithFields(beanClass, <span class="keyword">new</span> ReflectionUtils.FieldCallback() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doWith</span><span class="params">(Field field)</span> <span class="keyword">throws</span> IllegalArgumentException, IllegalAccessException </span>&#123;</span><br><span class="line">                <span class="comment">//获取字段上的@Reference注解</span></span><br><span class="line">                Reference reference = getAnnotation(field, Reference.class);</span><br><span class="line">                <span class="comment">//是否存在@Reference注解</span></span><br><span class="line">                <span class="keyword">if</span> (reference != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (Modifier.isStatic(field.getModifiers())) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">                            <span class="comment">//@Reference不支持静态字段字段</span></span><br><span class="line">                            logger.warn(<span class="string">"@Reference annotation is not supported on static fields: "</span> + field);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//根据字段和@Reference注解创建ReferenceFieldElement对象,并保存</span></span><br><span class="line">                    elements.add(<span class="keyword">new</span> ReferenceFieldElement(field, reference));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> elements;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从标注<span class="doctag">@Reference</span>注解的方法上找到（InjectionMetadata.InjectedElement）元数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanClass 目标bean的class</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> non-null &#123;<span class="doctag">@link</span> List&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;ReferenceMethodElement&gt; <span class="title">findMethodReferenceMetadata</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; beanClass)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> List&lt;ReferenceMethodElement&gt; elements = <span class="keyword">new</span> LinkedList&lt;ReferenceMethodElement&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//操作方法时调用</span></span><br><span class="line">        ReflectionUtils.doWithMethods(beanClass, <span class="keyword">new</span> ReflectionUtils.MethodCallback() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doWith</span><span class="params">(Method method)</span> <span class="keyword">throws</span> IllegalArgumentException, IllegalAccessException </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//获取桥接方法(https://blog.csdn.net/mhmyqn/article/details/47342577)</span></span><br><span class="line">                Method bridgedMethod = findBridgedMethod(method);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//参数和返回类型签名相同返回true</span></span><br><span class="line">                <span class="keyword">if</span> (!isVisibilityBridgeMethodPair(method, bridgedMethod)) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//从桥接方法上找到@Reference注解</span></span><br><span class="line">                Reference reference = findAnnotation(bridgedMethod, Reference.class);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//ClassUtils.getMostSpecificMethod</span></span><br><span class="line">                <span class="comment">//通过给定的方法(可能来自接口)和当前反射调用中使用的目标类,找到相应的目标方法</span></span><br><span class="line">                <span class="keyword">if</span> (reference != <span class="keyword">null</span> &amp;&amp; method.equals(ClassUtils.getMostSpecificMethod(method, beanClass))) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (Modifier.isStatic(method.getModifiers())) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">                            <span class="comment">//@Reference不支持static方法</span></span><br><span class="line">                            logger.warn(<span class="string">"@Reference annotation is not supported on static methods: "</span> + method);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (method.getParameterTypes().length == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">//@Reference注解只能用于带参数的方法</span></span><br><span class="line">                        <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">                            logger.warn(<span class="string">"@Reference  annotation should only be used on methods with parameters: "</span> +</span><br><span class="line">                                    method);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//获取bridgedMethod方法的属性描述</span></span><br><span class="line">                    PropertyDescriptor pd = BeanUtils.findPropertyForMethod(bridgedMethod, beanClass);</span><br><span class="line">                    <span class="comment">//创建ReferenceMethodElement对象，并保存</span></span><br><span class="line">                    elements.add(<span class="keyword">new</span> ReferenceMethodElement(method, pd, reference));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> elements;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.applicationContext = applicationContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessMergedBeanDefinition</span><span class="params">(RootBeanDefinition beanDefinition, Class&lt;?&gt; beanType, String beanName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (beanType != <span class="keyword">null</span>) &#123;</span><br><span class="line">            InjectionMetadata metadata = findReferenceMetadata(beanName, beanType, <span class="keyword">null</span>);</span><br><span class="line">            metadata.checkConfigMembers(beanDefinition);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> LOWEST_PRECEDENCE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (ReferenceBean referenceBean : referenceBeansCache.values()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">                logger.info(referenceBean + <span class="string">" was destroying!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//销毁referenceBean</span></span><br><span class="line">            referenceBean.destroy();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//清空injectionMetadataCache/referenceBeansCache</span></span><br><span class="line">        injectionMetadataCache.clear();</span><br><span class="line">        referenceBeansCache.clear();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">            logger.info(getClass() + <span class="string">" was destroying!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanClassLoader</span><span class="params">(ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.classLoader = classLoader;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取所有的ReferenceBean</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> non-null &#123;<span class="doctag">@link</span> Collection&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 2.5.9</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;ReferenceBean&lt;?&gt;&gt; getReferenceBeans() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.referenceBeansCache.values();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="ReferenceInjectionMetadata内部类"><a href="#ReferenceInjectionMetadata内部类" class="headerlink" title="ReferenceInjectionMetadata内部类"></a>ReferenceInjectionMetadata内部类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> Reference&#125; &#123;<span class="doctag">@link</span> InjectionMetadata&#125; implementation</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.5.11</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ReferenceInjectionMetadata</span> <span class="keyword">extends</span> <span class="title">InjectionMetadata</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Collection&lt;ReferenceFieldElement&gt; fieldElements;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Collection&lt;ReferenceMethodElement&gt; methodElements;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> targetClass 目标类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fieldElements 存在<span class="doctag">@Reference</span>注解的字段</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> methodElements 存在<span class="doctag">@Reference</span>注解的方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ReferenceInjectionMetadata</span><span class="params">(Class&lt;?&gt; targetClass, Collection&lt;ReferenceFieldElement&gt; fieldElements,</span></span></span><br><span class="line"><span class="function"><span class="params">                                      Collection&lt;ReferenceMethodElement&gt; methodElements)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(targetClass, combine(fieldElements, methodElements));</span><br><span class="line">        <span class="keyword">this</span>.fieldElements = fieldElements;</span><br><span class="line">        <span class="keyword">this</span>.methodElements = methodElements;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将fieldElements和methodElements进行合并</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> elements</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Collection&lt;T&gt; <span class="title">combine</span><span class="params">(Collection&lt;? extends T&gt;... elements)</span> </span>&#123;</span><br><span class="line">        List&lt;T&gt; allElements = <span class="keyword">new</span> ArrayList&lt;T&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Collection&lt;? extends T&gt; e : elements) &#123;</span><br><span class="line">            allElements.addAll(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> allElements;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;ReferenceFieldElement&gt; <span class="title">getFieldElements</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> fieldElements;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;ReferenceMethodElement&gt; <span class="title">getMethodElements</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> methodElements;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="ReferenceMethodElement内部类"><a href="#ReferenceMethodElement内部类" class="headerlink" title="ReferenceMethodElement内部类"></a>ReferenceMethodElement内部类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 内部类，方法元数据，最终会调用该类的inject方法进行注入</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ReferenceMethodElement</span> <span class="keyword">extends</span> <span class="title">InjectionMetadata</span>.<span class="title">InjectedElement</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * 标注<span class="doctag">@Reference</span>注解的方法</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">final</span> Method method;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">final</span> Reference reference;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 新生成的referenceBean</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">volatile</span> ReferenceBean&lt;?&gt; referenceBean;</span><br><span class="line"></span><br><span class="line">       <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * <span class="doctag">@param</span> method</span></span><br><span class="line"><span class="comment">        * <span class="doctag">@param</span> pd 方法属性描述符</span></span><br><span class="line"><span class="comment">        * <span class="doctag">@param</span> reference</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       <span class="function"><span class="keyword">protected</span> <span class="title">ReferenceMethodElement</span><span class="params">(Method method, PropertyDescriptor pd, Reference reference)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">super</span>(method, pd);</span><br><span class="line">           <span class="keyword">this</span>.method = method;</span><br><span class="line">           <span class="keyword">this</span>.reference = reference;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">inject</span><span class="params">(Object bean, String beanName, PropertyValues pvs)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">           <span class="comment">//获取referenceClass</span></span><br><span class="line">           Class&lt;?&gt; referenceClass = pd.getPropertyType();</span><br><span class="line">           <span class="comment">//获取referenceClass对应的referenceBean</span></span><br><span class="line">           referenceBean = buildReferenceBean(reference, referenceClass);</span><br><span class="line"></span><br><span class="line">           ReflectionUtils.makeAccessible(method);</span><br><span class="line">           <span class="comment">//调用bean的method，注入依赖</span></span><br><span class="line">           method.invoke(bean, referenceBean.getObject());</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h5 id="ReferenceFieldElement内部类"><a href="#ReferenceFieldElement内部类" class="headerlink" title="ReferenceFieldElement内部类"></a>ReferenceFieldElement内部类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 内部类，字段元数据，最终会调用该类的inject方法进行注入</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ReferenceFieldElement</span> <span class="keyword">extends</span> <span class="title">InjectionMetadata</span>.<span class="title">InjectedElement</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 标注<span class="doctag">@Reference</span>注解的字段</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Field field;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Reference reference;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> ReferenceBean&lt;?&gt; referenceBean;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">ReferenceFieldElement</span><span class="params">(Field field, Reference reference)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(field, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">this</span>.field = field;</span><br><span class="line">        <span class="keyword">this</span>.reference = reference;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注入</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bean  目标bean</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanName 目标bean-name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pvs</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Throwable</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">inject</span><span class="params">(Object bean, String beanName, PropertyValues pvs)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//被@Reference注解标识的字段的类型</span></span><br><span class="line">        Class&lt;?&gt; referenceClass = field.getType();</span><br><span class="line">        <span class="comment">//获取referenceClass对应的referenceBean</span></span><br><span class="line">        referenceBean = buildReferenceBean(reference, referenceClass);</span><br><span class="line"></span><br><span class="line">        ReflectionUtils.makeAccessible(field);</span><br><span class="line">        <span class="comment">//注入依赖到目标bean中</span></span><br><span class="line">        field.set(bean, referenceBean.getObject());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="buildReferenceBean方法"><a href="#buildReferenceBean方法" class="headerlink" title="buildReferenceBean方法"></a>buildReferenceBean方法</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据<span class="doctag">@Reference</span>注解和referenceClass生成ReferenceBean</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> reference</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> referenceClass 被<span class="doctag">@Reference</span>注解标注的字段类型</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> ReferenceBean&lt;?&gt; buildReferenceBean(Reference reference, Class&lt;?&gt; referenceClass) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据@Reference注解和referenceClass 生成缓存key</span></span><br><span class="line">    String referenceBeanCacheKey = generateReferenceBeanCacheKey(reference, referenceClass);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//先从缓存中获取ReferenceBean</span></span><br><span class="line">    ReferenceBean&lt;?&gt; referenceBean = referenceBeansCache.get(referenceBeanCacheKey);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (referenceBean == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//生成一个referenceBean并放入缓存(后面会分析该方法)</span></span><br><span class="line">        ReferenceBeanBuilder beanBuilder = ReferenceBeanBuilder</span><br><span class="line">                .create(reference, classLoader, applicationContext)</span><br><span class="line">                .interfaceClass(referenceClass);</span><br><span class="line">        referenceBean = beanBuilder.build();</span><br><span class="line">        referenceBeansCache.putIfAbsent(referenceBeanCacheKey, referenceBean);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> referenceBean;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 为ReferenceBean创建一个缓存key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> reference &#123;<span class="doctag">@link</span> Reference&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanClass &#123;<span class="doctag">@link</span> Class&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">generateReferenceBeanCacheKey</span><span class="params">(Reference reference, Class&lt;?&gt; beanClass)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取接口名称(后面会分析该方法)</span></span><br><span class="line">        String interfaceName = resolveInterfaceName(reference, beanClass);</span><br><span class="line">        <span class="comment">//生成缓存key</span></span><br><span class="line">        String key = reference.url() + <span class="string">"/"</span> + interfaceName +</span><br><span class="line">                <span class="string">"/"</span> + reference.version() +</span><br><span class="line">                <span class="string">"/"</span> + reference.group();</span><br><span class="line"></span><br><span class="line">        Environment environment = applicationContext.getEnvironment();</span><br><span class="line">        <span class="comment">//处理占位符</span></span><br><span class="line">        key = environment.resolvePlaceholders(key);</span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取接口名称interfaceName</span></span><br><span class="line"><span class="comment">     * 先从<span class="doctag">@Reference</span>注解属性找，找不到则取被注解的接口变量名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> reference <span class="doctag">@Reference</span>注解</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanClass 被<span class="doctag">@Reference</span>注解标注的类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalStateException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">resolveInterfaceName</span><span class="params">(Reference reference, Class&lt;?&gt; beanClass)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IllegalStateException </span>&#123;</span><br><span class="line"></span><br><span class="line">        String interfaceName;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="string">""</span>.equals(reference.interfaceName())) &#123;</span><br><span class="line">            <span class="comment">// @Reference注解的interfaceName属性不为空</span></span><br><span class="line">            interfaceName = reference.interfaceName();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">void</span>.class.equals(reference.interfaceClass())) &#123;</span><br><span class="line">            <span class="comment">// @Reference注解的interfaceClass属性不为void</span></span><br><span class="line">            interfaceName = reference.interfaceClass().getName();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (beanClass.isInterface()) &#123;</span><br><span class="line">            <span class="comment">// 被@Reference注解标注的类是接口类型</span></span><br><span class="line">            interfaceName = beanClass.getName();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//@Reference没有定义interfaceClass/interfaceName属性，beanClass不是一个接口</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">                    <span class="string">"The @Reference undefined interfaceClass or interfaceName, and the property type "</span></span><br><span class="line">                            + beanClass.getName() + <span class="string">" is not a interface."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> interfaceName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取&lt;field,ReferenceBean&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> non-null &#123;<span class="doctag">@link</span> Map&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 2.5.11</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;InjectionMetadata.InjectedElement, ReferenceBean&lt;?&gt;&gt; getInjectedFieldReferenceBeanMap() &#123;</span><br><span class="line"></span><br><span class="line">        Map&lt;InjectionMetadata.InjectedElement, ReferenceBean&lt;?&gt;&gt; injectedElementReferenceBeanMap =</span><br><span class="line">                <span class="keyword">new</span> LinkedHashMap&lt;InjectionMetadata.InjectedElement, ReferenceBean&lt;?&gt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (ReferenceInjectionMetadata metadata : injectionMetadataCache.values()) &#123;</span><br><span class="line">            Collection&lt;ReferenceFieldElement&gt; fieldElements = metadata.getFieldElements();</span><br><span class="line">            <span class="keyword">for</span> (ReferenceFieldElement fieldElement : fieldElements) &#123;</span><br><span class="line">                injectedElementReferenceBeanMap.put(fieldElement, fieldElement.referenceBean);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> injectedElementReferenceBeanMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取&lt;方法，ReferenceBean&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> non-null &#123;<span class="doctag">@link</span> Map&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 2.5.11</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;InjectionMetadata.InjectedElement, ReferenceBean&lt;?&gt;&gt; getInjectedMethodReferenceBeanMap() &#123;</span><br><span class="line"></span><br><span class="line">        Map&lt;InjectionMetadata.InjectedElement, ReferenceBean&lt;?&gt;&gt; injectedElementReferenceBeanMap =</span><br><span class="line">                <span class="keyword">new</span> LinkedHashMap&lt;InjectionMetadata.InjectedElement, ReferenceBean&lt;?&gt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (ReferenceInjectionMetadata metadata : injectionMetadataCache.values()) &#123;</span><br><span class="line">            Collection&lt;ReferenceMethodElement&gt; methodElements = metadata.getMethodElements();</span><br><span class="line">            <span class="keyword">for</span> (ReferenceMethodElement methodElement : methodElements) &#123;</span><br><span class="line">                injectedElementReferenceBeanMap.put(methodElement, methodElement.referenceBean);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> injectedElementReferenceBeanMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="AbstractAnnotationConfigBeanBuilder类"><a href="#AbstractAnnotationConfigBeanBuilder类" class="headerlink" title="AbstractAnnotationConfigBeanBuilder类"></a>AbstractAnnotationConfigBeanBuilder类</h5><p>接下来我们看下ReferenceBean的创建</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建ReferenceBean</span></span><br><span class="line">ReferenceBeanBuilder beanBuilder = ReferenceBeanBuilder</span><br><span class="line">          <span class="comment">//create方法创建了ReferenceBeanBuilder实例</span></span><br><span class="line">	  .create(reference, classLoader, applicationContext)</span><br><span class="line">	  <span class="comment">//设置referenceClass</span></span><br><span class="line">          .interfaceClass(referenceClass);</span><br><span class="line"><span class="comment">//build方法创建ReferenceBean类</span></span><br><span class="line">ReferenceBean&lt;?&gt; referenceBean = beanBuilder.build();</span><br></pre></td></tr></table></figure>
<p>我们是通过ReferenceBeanBuilder类创建ReferenceBean的，而ReferenceBeanBuilder继承自AbstractAnnotationConfigBeanBuilder,<br>AbstractAnnotationConfigBeanBuilder定义了创建配置bean的算法骨架(即build模板方法)，其他步骤都由子类ReferenceBeanBuilder负责实现。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Annotation bean配置构造器</span></span><br><span class="line"><span class="comment"> * Abstract Configurable &#123;<span class="doctag">@link</span> Annotation&#125; Bean Builder</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.5.7</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractAnnotationConfigBeanBuilder</span>&lt;<span class="title">A</span> <span class="keyword">extends</span> <span class="title">Annotation</span>, <span class="title">B</span> <span class="keyword">extends</span> <span class="title">AbstractInterfaceConfig</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Log logger = LogFactory.getLog(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注解</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> A annotation;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> ClassLoader classLoader;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Object bean;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 接口类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; interfaceClass;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">AbstractAnnotationConfigBeanBuilder</span><span class="params">(A annotation, ClassLoader classLoader,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                  ApplicationContext applicationContext)</span> </span>&#123;</span><br><span class="line">        Assert.notNull(annotation, <span class="string">"The Annotation must not be null!"</span>);</span><br><span class="line">        Assert.notNull(classLoader, <span class="string">"The ClassLoader must not be null!"</span>);</span><br><span class="line">        Assert.notNull(applicationContext, <span class="string">"The ApplicationContext must not be null!"</span>);</span><br><span class="line">        <span class="keyword">this</span>.annotation = annotation;</span><br><span class="line">        <span class="keyword">this</span>.applicationContext = applicationContext;</span><br><span class="line">        <span class="keyword">this</span>.classLoader = classLoader;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Build &#123;<span class="doctag">@link</span> B&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> non-null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> B <span class="title">build</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//检测依赖</span></span><br><span class="line">        checkDependencies();</span><br><span class="line">        <span class="comment">//构建B（子类实现）</span></span><br><span class="line">        B bean = doBuild();</span><br><span class="line">        <span class="comment">//配置B</span></span><br><span class="line">        configureBean(bean);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">            logger.info(bean + <span class="string">" has been built."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkDependencies</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Builds &#123;<span class="doctag">@link</span> B Bean&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@link</span> B Bean&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> B <span class="title">doBuild</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configureBean</span><span class="params">(B bean)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//子类实现</span></span><br><span class="line">        preConfigureBean(annotation, bean);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//配置RegistryConfig(即将RegistryConfig实例注入到B对象中)</span></span><br><span class="line">        configureRegistryConfigs(bean);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//配置MonitorConfig</span></span><br><span class="line">        configureMonitorConfig(bean);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//配置ApplicationConfig</span></span><br><span class="line">        configureApplicationConfig(bean);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//配置ModuleConfig</span></span><br><span class="line">        configureModuleConfig(bean);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//子类实现</span></span><br><span class="line">        postConfigureBean(annotation, bean);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">preConfigureBean</span><span class="params">(A annotation, B bean)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置RegistryConfig</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">configureRegistryConfigs</span><span class="params">(B bean)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取RegistryConfig的bean-names</span></span><br><span class="line">        String[] registryConfigBeanIds = resolveRegistryConfigBeanNames(annotation);</span><br><span class="line">        <span class="comment">//根据bean-names从工厂中获取RegistryConfig实例</span></span><br><span class="line">        List&lt;RegistryConfig&gt; registryConfigs = getBeans(applicationContext, registryConfigBeanIds, RegistryConfig.class);</span><br><span class="line">        <span class="comment">//将registryConfigs注入到B中</span></span><br><span class="line">        bean.setRegistries(registryConfigs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置MonitorConfig</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">configureMonitorConfig</span><span class="params">(B bean)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取MonitorConfig的bean-names</span></span><br><span class="line">        String monitorBeanName = resolveMonitorConfigBeanName(annotation);</span><br><span class="line">        <span class="comment">//获取monitorConfig实例</span></span><br><span class="line">        MonitorConfig monitorConfig = getOptionalBean(applicationContext, monitorBeanName, MonitorConfig.class);</span><br><span class="line">        <span class="comment">//将registryConfigs注入到B中</span></span><br><span class="line">        bean.setMonitor(monitorConfig);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置ApplicationConfig</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">configureApplicationConfig</span><span class="params">(B bean)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取ApplicationConfig的bean-names</span></span><br><span class="line">        String applicationConfigBeanName = resolveApplicationConfigBeanName(annotation);</span><br><span class="line"></span><br><span class="line">        ApplicationConfig applicationConfig =</span><br><span class="line">                getOptionalBean(applicationContext, applicationConfigBeanName, ApplicationConfig.class);</span><br><span class="line"></span><br><span class="line">        bean.setApplication(applicationConfig);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置ModuleConfig</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">configureModuleConfig</span><span class="params">(B bean)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取ModuleConfig的bean-names</span></span><br><span class="line">        String moduleConfigBeanName = resolveModuleConfigBeanName(annotation);</span><br><span class="line"></span><br><span class="line">        ModuleConfig moduleConfig =</span><br><span class="line">                getOptionalBean(applicationContext, moduleConfigBeanName, ModuleConfig.class);</span><br><span class="line"></span><br><span class="line">        bean.setModule(moduleConfig);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Resolves the bean name of &#123;<span class="doctag">@link</span> ModuleConfig&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> annotation &#123;<span class="doctag">@link</span> A&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">resolveModuleConfigBeanName</span><span class="params">(A annotation)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Resolves the bean name of &#123;<span class="doctag">@link</span> ApplicationConfig&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> annotation &#123;<span class="doctag">@link</span> A&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">resolveApplicationConfigBeanName</span><span class="params">(A annotation)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Resolves the bean ids of &#123;<span class="doctag">@link</span> com.alibaba.dubbo.config.RegistryConfig&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> annotation &#123;<span class="doctag">@link</span> A&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> non-empty array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> String[] resolveRegistryConfigBeanNames(A annotation);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Resolves the bean name of &#123;<span class="doctag">@link</span> MonitorConfig&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> annotation &#123;<span class="doctag">@link</span> A&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">resolveMonitorConfigBeanName</span><span class="params">(A annotation)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Configures Bean</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> annotation</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">postConfigureBean</span><span class="params">(A annotation, B bean)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T extends AbstractAnnotationConfigBeanBuilder&lt;A, B&gt;&gt; <span class="function">T <span class="title">bean</span><span class="params">(Object bean)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.bean = bean;</span><br><span class="line">        <span class="keyword">return</span> (T) <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T extends AbstractAnnotationConfigBeanBuilder&lt;A, B&gt;&gt; <span class="function">T <span class="title">interfaceClass</span><span class="params">(Class&lt;?&gt; interfaceClass)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.interfaceClass = interfaceClass;</span><br><span class="line">        <span class="keyword">return</span> (T) <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="ReferenceBeanBuilder实现类"><a href="#ReferenceBeanBuilder实现类" class="headerlink" title="ReferenceBeanBuilder实现类"></a>ReferenceBeanBuilder实现类</h5><p>我们接下来看ReferenceBeanBuilder实现类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ReferenceBean 构造器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReferenceBeanBuilder</span> <span class="keyword">extends</span> <span class="title">AbstractAnnotationConfigBeanBuilder</span>&lt;<span class="title">Reference</span>, <span class="title">ReferenceBean</span>&gt; </span>&#123;</span><br><span class="line">	</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ReferenceBeanBuilder</span><span class="params">(Reference annotation, ClassLoader classLoader, ApplicationContext applicationContext)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(annotation, classLoader, applicationContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置referenceBean实例的interfaceClass属性</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> reference</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> referenceBean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">configureInterface</span><span class="params">(Reference reference, ReferenceBean referenceBean)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取@Reference注解的interfaceClass属性</span></span><br><span class="line">        Class&lt;?&gt; interfaceClass = reference.interfaceClass();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">void</span>.class.equals(interfaceClass)) &#123;</span><br><span class="line">            interfaceClass = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">//interfaceClass属性没有配置,则取interfaceName属性</span></span><br><span class="line">            String interfaceClassName = reference.interfaceName();</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.hasText(interfaceClassName)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ClassUtils.isPresent(interfaceClassName, classLoader)) &#123;</span><br><span class="line">                    <span class="comment">//加载interfaceClassName类，作为interfaceClass</span></span><br><span class="line">                    interfaceClass = ClassUtils.resolveClassName(interfaceClassName, classLoader);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (interfaceClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//如果@Reference注解没有配置interfaceClass属性和interfaceName属性</span></span><br><span class="line">            <span class="comment">//则使用创建对象时使用的interfaceClass</span></span><br><span class="line">            interfaceClass = <span class="keyword">this</span>.interfaceClass;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//校验interfaceClass是接口类型</span></span><br><span class="line">        Assert.isTrue(interfaceClass.isInterface(),</span><br><span class="line">                <span class="string">"The class of field or method that was annotated @Reference is not an interface!"</span>);</span><br><span class="line">        <span class="comment">//设置referenceBean对象的interfaceClass</span></span><br><span class="line">        referenceBean.setInterface(interfaceClass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置referenceBean实例的consumer属性</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> reference</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> referenceBean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">configureConsumerConfig</span><span class="params">(Reference reference, ReferenceBean&lt;?&gt; referenceBean)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取@Reference注解的consumer属性</span></span><br><span class="line">        String consumerBeanName = reference.consumer();</span><br><span class="line">        <span class="comment">//从工厂中获取ConsumerConfig实例</span></span><br><span class="line">        ConsumerConfig consumerConfig = getOptionalBean(applicationContext, consumerBeanName, ConsumerConfig.class);</span><br><span class="line">        <span class="comment">//设置referenceBean实例的consumer属性</span></span><br><span class="line">        referenceBean.setConsumer(consumerConfig);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ReferenceBean <span class="title">doBuild</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//创建ReferenceBean对象</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ReferenceBean&lt;Object&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">preConfigureBean</span><span class="params">(Reference reference, ReferenceBean referenceBean)</span> </span>&#123;</span><br><span class="line">        Assert.notNull(interfaceClass, <span class="string">"The interface class must set first!"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//根据referenceBean创建数据绑定对象</span></span><br><span class="line">        DataBinder dataBinder = <span class="keyword">new</span> DataBinder(referenceBean);</span><br><span class="line">        <span class="comment">//设置转换器</span></span><br><span class="line">        dataBinder.setConversionService(getConversionService());</span><br><span class="line">        <span class="comment">//忽略的属性名称</span></span><br><span class="line">        String[] ignoreAttributeNames = of(<span class="string">"application"</span>, <span class="string">"module"</span>, <span class="string">"consumer"</span>, <span class="string">"monitor"</span>, <span class="string">"registry"</span>);</span><br><span class="line">        <span class="comment">//dataBinder.setDisallowedFields(ignoreAttributeNames)</span></span><br><span class="line">        <span class="comment">//绑定注解属性</span></span><br><span class="line">        dataBinder.bind(<span class="keyword">new</span> AnnotationPropertyValuesAdapter(reference, applicationContext.getEnvironment(), ignoreAttributeNames));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取ConversionService</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ConversionService <span class="title">getConversionService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//创建默认转换器</span></span><br><span class="line">        DefaultConversionService conversionService = <span class="keyword">new</span> DefaultConversionService();</span><br><span class="line">        <span class="comment">//添加StringArray到String的转换</span></span><br><span class="line">        conversionService.addConverter(<span class="keyword">new</span> StringArrayToStringConverter());</span><br><span class="line">        <span class="comment">//添加StringArray到Map的转换</span></span><br><span class="line">        conversionService.addConverter(<span class="keyword">new</span> StringArrayToMapConverter());</span><br><span class="line">        <span class="keyword">return</span> conversionService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">resolveModuleConfigBeanName</span><span class="params">(Reference annotation)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取@Reference注解的module属性</span></span><br><span class="line">        <span class="keyword">return</span> annotation.<span class="keyword">module</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">resolveApplicationConfigBeanName</span><span class="params">(Reference annotation)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取@Reference注解的application属性</span></span><br><span class="line">        <span class="keyword">return</span> annotation.application();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> String[] resolveRegistryConfigBeanNames(Reference annotation) &#123;</span><br><span class="line">        <span class="comment">//获取@Reference注解的registry属性</span></span><br><span class="line">        <span class="keyword">return</span> annotation.registry();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">resolveMonitorConfigBeanName</span><span class="params">(Reference annotation)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取@Reference注解的monitor属性</span></span><br><span class="line">        <span class="keyword">return</span> annotation.monitor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">postConfigureBean</span><span class="params">(Reference annotation, ReferenceBean bean)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置applicationContext属性</span></span><br><span class="line">        bean.setApplicationContext(applicationContext);</span><br><span class="line">        <span class="comment">//设置interfaceClass属性</span></span><br><span class="line">        configureInterface(annotation, bean);</span><br><span class="line">        <span class="comment">//设置consumer属性</span></span><br><span class="line">        configureConsumerConfig(annotation, bean);</span><br><span class="line">        <span class="comment">//属性都设置完了，开始调用bean的afterPropertiesSet方法(可见ReferenceBean实现了InitializingBean接口)</span></span><br><span class="line">        <span class="comment">//在afterPropertiesSet()方法中会校验consumer/application/module/registry/monitor等属性是否为空，</span></span><br><span class="line">	<span class="comment">//为空的话,会从Spring容器中再次获取下,并重新赋值,然后会根据配置是否立即初始化该bean</span></span><br><span class="line">	bean.afterPropertiesSet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建ReferenceBeanBuilder实例</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> annotation</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> classLoader</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> applicationContext</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ReferenceBeanBuilder <span class="title">create</span><span class="params">(Reference annotation, ClassLoader classLoader,</span></span></span><br><span class="line"><span class="function"><span class="params">                                              ApplicationContext applicationContext)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ReferenceBeanBuilder(annotation, classLoader, applicationContext);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="ReferenceBean类"><a href="#ReferenceBean类" class="headerlink" title="ReferenceBean类"></a>ReferenceBean类</h5><p>接下来来看ReferenceBean类,该类继承自ReferenceConfig类,并实现了FactoryBean接口。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ReferenceFactoryBean</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@export</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReferenceBean</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">ReferenceConfig</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">FactoryBean</span>,</span></span><br><span class="line"><span class="class">        <span class="title">ApplicationContextAware</span>, <span class="title">InitializingBean</span>, <span class="title">DisposableBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ReferenceBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ReferenceBean</span><span class="params">(Reference reference)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//调用父类构造方法，在父类构造方法中会调用appendAnnotation方法处理@Reference注解的属性</span></span><br><span class="line">        <span class="keyword">super</span>(reference);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.applicationContext = applicationContext;</span><br><span class="line">        <span class="comment">//将applicationContext添加到SpringExtensionFactory中</span></span><br><span class="line">        <span class="comment">//SPI那一章节，我们介绍过SpringExtensionFactory类</span></span><br><span class="line">        SpringExtensionFactory.addApplicationContext(applicationContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//获取对象实例，调用父类中的get方法进行初始化</span></span><br><span class="line">        <span class="keyword">return</span> get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; getObjectType() &#123;</span><br><span class="line">        <span class="comment">//调用父类中的getInterfaceClass方法获取对象类型(后面会分析该方法)</span></span><br><span class="line">        <span class="keyword">return</span> getInterfaceClass();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Parameter</span>(excluded = <span class="keyword">true</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSingleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"unchecked"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//如果没有配置Consumer</span></span><br><span class="line">        <span class="keyword">if</span> (getConsumer() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//获取IOC容器中的ConsumerConfig（只获取单例类型的）</span></span><br><span class="line">            Map&lt;String, ConsumerConfig&gt; consumerConfigMap = applicationContext == <span class="keyword">null</span> ? <span class="keyword">null</span> : BeanFactoryUtils.beansOfTypeIncludingAncestors(applicationContext, ConsumerConfig.class, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (consumerConfigMap != <span class="keyword">null</span> &amp;&amp; consumerConfigMap.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                ConsumerConfig consumerConfig = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">for</span> (ConsumerConfig config : consumerConfigMap.values()) &#123;</span><br><span class="line">                    <span class="comment">//检查是否有重复的consumer配置(default属性)</span></span><br><span class="line">                    <span class="keyword">if</span> (config.isDefault() == <span class="keyword">null</span> || config.isDefault().booleanValue()) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (consumerConfig != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Duplicate consumer configs: "</span> + consumerConfig + <span class="string">" and "</span> + config);</span><br><span class="line">                        &#125;</span><br><span class="line">                        consumerConfig = config;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (consumerConfig != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//配置bean的consumer属性</span></span><br><span class="line">                    setConsumer(consumerConfig);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (getApplication() == <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; (getConsumer() == <span class="keyword">null</span> || getConsumer().getApplication() == <span class="keyword">null</span>)) &#123;</span><br><span class="line">            <span class="comment">//从IOC容器中获取ApplicationConfig</span></span><br><span class="line">            Map&lt;String, ApplicationConfig&gt; applicationConfigMap = applicationContext == <span class="keyword">null</span> ? <span class="keyword">null</span> : BeanFactoryUtils.beansOfTypeIncludingAncestors(applicationContext, ApplicationConfig.class, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (applicationConfigMap != <span class="keyword">null</span> &amp;&amp; applicationConfigMap.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                ApplicationConfig applicationConfig = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">for</span> (ApplicationConfig config : applicationConfigMap.values()) &#123;</span><br><span class="line">                    <span class="comment">//检测是否有重复的配置(default属性)</span></span><br><span class="line">                    <span class="keyword">if</span> (config.isDefault() == <span class="keyword">null</span> || config.isDefault().booleanValue()) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (applicationConfig != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Duplicate application configs: "</span> + applicationConfig + <span class="string">" and "</span> + config);</span><br><span class="line">                        &#125;</span><br><span class="line">                        applicationConfig = config;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (applicationConfig != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//设置bean的ApplicationConfig属性</span></span><br><span class="line">                    setApplication(applicationConfig);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (getModule() == <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; (getConsumer() == <span class="keyword">null</span> || getConsumer().getModule() == <span class="keyword">null</span>)) &#123;</span><br><span class="line">            <span class="comment">//从IOC容器中获取ModuleConfig</span></span><br><span class="line">            Map&lt;String, ModuleConfig&gt; moduleConfigMap = applicationContext == <span class="keyword">null</span> ? <span class="keyword">null</span> : BeanFactoryUtils.beansOfTypeIncludingAncestors(applicationContext, ModuleConfig.class, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (moduleConfigMap != <span class="keyword">null</span> &amp;&amp; moduleConfigMap.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                ModuleConfig moduleConfig = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">for</span> (ModuleConfig config : moduleConfigMap.values()) &#123;</span><br><span class="line">                    <span class="comment">//检测是否有重复的moduleConfig</span></span><br><span class="line">                    <span class="keyword">if</span> (config.isDefault() == <span class="keyword">null</span> || config.isDefault().booleanValue()) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (moduleConfig != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Duplicate module configs: "</span> + moduleConfig + <span class="string">" and "</span> + config);</span><br><span class="line">                        &#125;</span><br><span class="line">                        moduleConfig = config;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (moduleConfig != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//设置module属性</span></span><br><span class="line">                    setModule(moduleConfig);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((getRegistries() == <span class="keyword">null</span> || getRegistries().isEmpty())</span><br><span class="line">                &amp;&amp; (getConsumer() == <span class="keyword">null</span> || getConsumer().getRegistries() == <span class="keyword">null</span> || getConsumer().getRegistries().isEmpty())</span><br><span class="line">                &amp;&amp; (getApplication() == <span class="keyword">null</span> || getApplication().getRegistries() == <span class="keyword">null</span> || getApplication().getRegistries().isEmpty())) &#123;</span><br><span class="line">            <span class="comment">//从IOC容器中获取RegistryConfig</span></span><br><span class="line">            Map&lt;String, RegistryConfig&gt; registryConfigMap = applicationContext == <span class="keyword">null</span> ? <span class="keyword">null</span> : BeanFactoryUtils.beansOfTypeIncludingAncestors(applicationContext, RegistryConfig.class, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (registryConfigMap != <span class="keyword">null</span> &amp;&amp; registryConfigMap.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                List&lt;RegistryConfig&gt; registryConfigs = <span class="keyword">new</span> ArrayList&lt;RegistryConfig&gt;();</span><br><span class="line">                        registryConfigs.add(config);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (registryConfigs != <span class="keyword">null</span> &amp;&amp; !registryConfigs.isEmpty()) &#123;</span><br><span class="line">                    <span class="comment">//设置registries属性</span></span><br><span class="line">                    <span class="keyword">super</span>.setRegistries(registryConfigs);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (getMonitor() == <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; (getConsumer() == <span class="keyword">null</span> || getConsumer().getMonitor() == <span class="keyword">null</span>)</span><br><span class="line">                &amp;&amp; (getApplication() == <span class="keyword">null</span> || getApplication().getMonitor() == <span class="keyword">null</span>)) &#123;</span><br><span class="line">            <span class="comment">//从IOC容器中获取MonitorConfig</span></span><br><span class="line">            Map&lt;String, MonitorConfig&gt; monitorConfigMap = applicationContext == <span class="keyword">null</span> ? <span class="keyword">null</span> : BeanFactoryUtils.beansOfTypeIncludingAncestors(applicationContext, MonitorConfig.class, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (monitorConfigMap != <span class="keyword">null</span> &amp;&amp; monitorConfigMap.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                MonitorConfig monitorConfig = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">for</span> (MonitorConfig config : monitorConfigMap.values()) &#123;</span><br><span class="line">                    <span class="comment">//检测是否有重复的MonitorConfig</span></span><br><span class="line">                    <span class="keyword">if</span> (config.isDefault() == <span class="keyword">null</span> || config.isDefault().booleanValue()) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (monitorConfig != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Duplicate monitor configs: "</span> + monitorConfig + <span class="string">" and "</span> + config);</span><br><span class="line">                        &#125;</span><br><span class="line">                        monitorConfig = config;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (monitorConfig != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//设置MonitorConfig属性</span></span><br><span class="line">                    setMonitor(monitorConfig);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取是否 立即初始化 属性init</span></span><br><span class="line">        Boolean b = isInit();</span><br><span class="line">        <span class="keyword">if</span> (b == <span class="keyword">null</span> &amp;&amp; getConsumer() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//从ConsumerConfig属性中获取init</span></span><br><span class="line">            b = getConsumer().isInit();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (b != <span class="keyword">null</span> &amp;&amp; b.booleanValue()) &#123;</span><br><span class="line">            <span class="comment">//执行初始化</span></span><br><span class="line">            getObject();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// do nothing</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接下来，我们来看下父类ReferenceConfig中的方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 获取服务接口类</span></span><br><span class="line"><span class="comment">* interfaceClass &gt; GenericService.class &gt; interfaceName</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> Class&lt;?&gt; getInterfaceClass() &#123;</span><br><span class="line">	<span class="comment">//interfaceClass属性不为空，直接返回</span></span><br><span class="line">	<span class="keyword">if</span> (interfaceClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">	    <span class="keyword">return</span> interfaceClass;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//Reference或者Consumer的generic属性为true，则使用GenericService类</span></span><br><span class="line">	<span class="keyword">if</span> (isGeneric()</span><br><span class="line">		|| (getConsumer() != <span class="keyword">null</span> &amp;&amp; getConsumer().isGeneric())) &#123;</span><br><span class="line">	    <span class="keyword">return</span> GenericService.class;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">	    <span class="keyword">if</span> (interfaceName != <span class="keyword">null</span> &amp;&amp; interfaceName.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="comment">//interfaceName属性不为空，加载该类</span></span><br><span class="line">		<span class="keyword">this</span>.interfaceClass = Class.forName(interfaceName, <span class="keyword">true</span>, Thread.currentThread()</span><br><span class="line">			.getContextClassLoader());</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (ClassNotFoundException t) &#123;</span><br><span class="line">	    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(t.getMessage(), t);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> interfaceClass;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 是否已销毁</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> destroyed;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 接口代理引用</span></span><br><span class="line"><span class="comment"> * interface proxy reference</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> T ref;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取接口代理引用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//判断是否已经销毁</span></span><br><span class="line">        <span class="keyword">if</span> (destroyed) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Already destroyed!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ref == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//初始化</span></span><br><span class="line">            init();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ref;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="init方法"><a href="#init方法" class="headerlink" title="init方法"></a>init方法</h4><p>该init方法会生成接口代理引用ref。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//判断是否已经销毁</span></span><br><span class="line">        <span class="keyword">if</span> (destroyed) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Already destroyed!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ref == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//初始化</span></span><br><span class="line">            init();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ref;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//已经初始化过的话，则返回</span></span><br><span class="line">	<span class="keyword">if</span> (initialized) &#123;</span><br><span class="line">	    <span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	initialized = <span class="keyword">true</span>;</span><br><span class="line">	<span class="comment">//检测是否配置了interface属性</span></span><br><span class="line">	<span class="keyword">if</span> (interfaceName == <span class="keyword">null</span> || interfaceName.length() == <span class="number">0</span>) &#123;</span><br><span class="line">	    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"&lt;dubbo:reference interface=\"\" /&gt; interface not allow null!"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//获取Consumer的全局配置(设置ConsumerConfig对象的属性)(后面会分析该方法)</span></span><br><span class="line">	checkDefault();</span><br><span class="line">	<span class="comment">//加载当前ReferenceConfig对象(即ReferenceBean)的属性信息(后面会分析该方法)</span></span><br><span class="line">	appendProperties(<span class="keyword">this</span>);</span><br><span class="line">	<span class="comment">//当前ReferenceConfig没有配置generic属性的话，则使用Consumer的generic属性配置</span></span><br><span class="line">	<span class="keyword">if</span> (getGeneric() == <span class="keyword">null</span> &amp;&amp; getConsumer() != <span class="keyword">null</span>) &#123;</span><br><span class="line">	    <span class="comment">//设置generic属性</span></span><br><span class="line">	    setGeneric(getConsumer().getGeneric());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//(generic ！= null) &amp;&amp; (generic = “true” || "nativejava" || "bean") ProtocolUtils.isGeneric返回true</span></span><br><span class="line">	<span class="keyword">if</span> (ProtocolUtils.isGeneric(getGeneric())) &#123;</span><br><span class="line">	    <span class="comment">//如果配置了使用通用接口，则设置服务接口类为GenericService类</span></span><br><span class="line">	    interfaceClass = GenericService.class;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	    <span class="comment">//否则根据interfaceName加载服务接口类</span></span><br><span class="line">	    <span class="keyword">try</span> &#123;</span><br><span class="line">		interfaceClass = Class.forName(interfaceName, <span class="keyword">true</span>, Thread.currentThread()</span><br><span class="line">			.getContextClassLoader());</span><br><span class="line">	    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e.getMessage(), e);</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="comment">//检测methods方法是否都存在于接口服务类interfaceClass中(后面会分析该方法)</span></span><br><span class="line">	    checkInterfaceAndMethods(interfaceClass, methods);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//1、根据服务接口名称从系统配置中查找resolve：即通过-DinterfaceName=resolve配置</span></span><br><span class="line">	<span class="comment">//2、resolve为空，则加载dubbo.resolve.file文件,从resolveFile中加载resolve</span></span><br><span class="line">	<span class="comment">//   a、从系统配置文件中加载resolve文件：即-Ddubbo.resolve.file=xxx配置</span></span><br><span class="line">	<span class="comment">//   b、使用dubbo的默认resolve文件：$&#123;user.home&#125;/dubbo-resolve.properties</span></span><br><span class="line">	String resolve = System.getProperty(interfaceName);</span><br><span class="line">	String resolveFile = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">if</span> (resolve == <span class="keyword">null</span> || resolve.length() == <span class="number">0</span>) &#123;</span><br><span class="line">	    resolveFile = System.getProperty(<span class="string">"dubbo.resolve.file"</span>);</span><br><span class="line">	    <span class="keyword">if</span> (resolveFile == <span class="keyword">null</span> || resolveFile.length() == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="comment">//没有配置resolveFile的话，则使用dubbo默认的resolve文件</span></span><br><span class="line">		<span class="comment">//如：System.getProperty("user.home") = C:\Users\Administrator</span></span><br><span class="line">		<span class="comment">//resolveFile = userResolveFile = C:\Users\Administrator\dubbo-resolve.properties</span></span><br><span class="line">		File userResolveFile = <span class="keyword">new</span> File(<span class="keyword">new</span> File(System.getProperty(<span class="string">"user.home"</span>)), <span class="string">"dubbo-resolve.properties"</span>);</span><br><span class="line">		<span class="keyword">if</span> (userResolveFile.exists()) &#123;</span><br><span class="line">		    resolveFile = userResolveFile.getAbsolutePath();</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="comment">//加载resolveFile文件</span></span><br><span class="line">	    <span class="keyword">if</span> (resolveFile != <span class="keyword">null</span> &amp;&amp; resolveFile.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">		FileInputStream fis = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">		    fis = <span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(resolveFile));</span><br><span class="line">		    properties.load(fis);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">		    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unload "</span> + resolveFile + <span class="string">", cause: "</span> + e.getMessage(), e);</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		    <span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">null</span> != fis) &#123;</span><br><span class="line">			    fis.close();</span><br><span class="line">			&#125;</span><br><span class="line">		    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			logger.warn(e.getMessage(), e);</span><br><span class="line">		    &#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//从resolveFile配置文件中加载resolve</span></span><br><span class="line">		resolve = properties.getProperty(interfaceName);</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (resolve != <span class="keyword">null</span> &amp;&amp; resolve.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">	    url = resolve;</span><br><span class="line">	    <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">		<span class="keyword">if</span> (resolveFile != <span class="keyword">null</span> &amp;&amp; resolveFile.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		    <span class="comment">//使用默认dubbo resolve file</span></span><br><span class="line">		    logger.warn(<span class="string">"Using default dubbo resolve file "</span> + resolveFile + <span class="string">" replace "</span> + interfaceName + <span class="string">""</span> + resolve + <span class="string">" to p2p invoke remote service."</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		    <span class="comment">//可以使用-DinterfaceName=resolve配置p2p</span></span><br><span class="line">		    logger.warn(<span class="string">"Using -D"</span> + interfaceName + <span class="string">"="</span> + resolve + <span class="string">" to p2p invoke remote service."</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//加载注册中心、监控中心优先级</span></span><br><span class="line">	<span class="comment">//consumer &gt; module &gt; application</span></span><br><span class="line">	<span class="keyword">if</span> (consumer != <span class="keyword">null</span>) &#123;</span><br><span class="line">	    <span class="keyword">if</span> (application == <span class="keyword">null</span>) &#123;</span><br><span class="line">		application = consumer.getApplication();</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">if</span> (<span class="keyword">module</span> == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">module</span> = consumer.getModule();</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">if</span> (registries == <span class="keyword">null</span>) &#123;</span><br><span class="line">		registries = consumer.getRegistries();</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">if</span> (monitor == <span class="keyword">null</span>) &#123;</span><br><span class="line">		monitor = consumer.getMonitor();</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">module</span> != <span class="keyword">null</span>) &#123;</span><br><span class="line">	    <span class="keyword">if</span> (registries == <span class="keyword">null</span>) &#123;</span><br><span class="line">		registries = <span class="keyword">module</span>.getRegistries();</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">if</span> (monitor == <span class="keyword">null</span>) &#123;</span><br><span class="line">		monitor = <span class="keyword">module</span>.getMonitor();</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (application != <span class="keyword">null</span>) &#123;</span><br><span class="line">	    <span class="comment">//&lt;dubbo:application name="demo-consumer" qosPort="33333" id="demo-consumer" /&gt;</span></span><br><span class="line">	    <span class="keyword">if</span> (registries == <span class="keyword">null</span>) &#123;</span><br><span class="line">		registries = application.getRegistries();</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">if</span> (monitor == <span class="keyword">null</span>) &#123;</span><br><span class="line">		monitor = application.getMonitor();</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//检测Application配置(后面会分析该方法)</span></span><br><span class="line">	checkApplication();</span><br><span class="line">	<span class="comment">//检测Stub和Mock(后面会分析该方法)</span></span><br><span class="line">	checkStubAndMock(interfaceClass);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//记录Consumer端的服务接口相关信息</span></span><br><span class="line">	Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">	<span class="comment">//保存方法属性的attributes</span></span><br><span class="line">	Map&lt;Object, Object&gt; attributes = <span class="keyword">new</span> HashMap&lt;Object, Object&gt;();</span><br><span class="line">	<span class="comment">//设置消费者端</span></span><br><span class="line">	map.put(Constants.SIDE_KEY, Constants.CONSUMER_SIDE);</span><br><span class="line">	<span class="comment">//设置dubbo版本</span></span><br><span class="line">	map.put(Constants.DUBBO_VERSION_KEY, Version.getVersion());</span><br><span class="line">	<span class="comment">//设置时间戳</span></span><br><span class="line">	map.put(Constants.TIMESTAMP_KEY, String.valueOf(System.currentTimeMillis()));</span><br><span class="line">	<span class="keyword">if</span> (ConfigUtils.getPid() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">	    <span class="comment">//设置父进程id</span></span><br><span class="line">	    map.put(Constants.PID_KEY, String.valueOf(ConfigUtils.getPid()));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!isGeneric()) &#123;</span><br><span class="line">	    <span class="comment">//不是通用泛型接口，则获取revision属性,默认等于version属性</span></span><br><span class="line">	    String revision = Version.getVersion(interfaceClass, version);</span><br><span class="line">	    <span class="keyword">if</span> (revision != <span class="keyword">null</span> &amp;&amp; revision.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		map.put(<span class="string">"revision"</span>, revision);</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="comment">//获取包装类，然后获取服务接口中的方法名称数组(后面会分析该方法)</span></span><br><span class="line">	    String[] methods = Wrapper.getWrapper(interfaceClass).getMethodNames();</span><br><span class="line">	    <span class="keyword">if</span> (methods.length == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="comment">//在服务接口中，没有找到方法，则设置属性：methods = *</span></span><br><span class="line">		logger.warn(<span class="string">"NO method found in service interface "</span> + interfaceClass.getName());</span><br><span class="line">		map.put(<span class="string">"methods"</span>, Constants.ANY_VALUE);</span><br><span class="line">	    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">//设置methods=逗号分隔的方法name</span></span><br><span class="line">		map.put(<span class="string">"methods"</span>, StringUtils.join(<span class="keyword">new</span> HashSet&lt;String&gt;(Arrays.asList(methods)), <span class="string">","</span>));</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//设置interface属性</span></span><br><span class="line">	map.put(Constants.INTERFACE_KEY, interfaceName);</span><br><span class="line">	<span class="comment">//添加附加参数(后面会分析该方法)</span></span><br><span class="line">	appendParameters(map, application);</span><br><span class="line">	appendParameters(map, <span class="keyword">module</span>);</span><br><span class="line">	appendParameters(map, consumer, Constants.DEFAULT_KEY);</span><br><span class="line">	appendParameters(map, <span class="keyword">this</span>);</span><br><span class="line">	<span class="comment">//获取服务前缀：group/interface:version</span></span><br><span class="line">	String prefix = StringUtils.getServiceKey(map);</span><br><span class="line">	<span class="comment">//处理引用的方法列表</span></span><br><span class="line">	<span class="keyword">if</span> (methods != <span class="keyword">null</span> &amp;&amp; !methods.isEmpty()) &#123;</span><br><span class="line">	    <span class="keyword">for</span> (MethodConfig method : methods) &#123;</span><br><span class="line">		<span class="comment">//附加参数(后面会分析该方法)</span></span><br><span class="line">		appendParameters(map, method, method.getName());</span><br><span class="line">		<span class="comment">//处理方法重试</span></span><br><span class="line">		String retryKey = method.getName() + <span class="string">".retry"</span>;</span><br><span class="line">		<span class="keyword">if</span> (map.containsKey(retryKey)) &#123;</span><br><span class="line">		    <span class="comment">//将属性retryKey从map中移除</span></span><br><span class="line">		    String retryValue = map.remove(retryKey);</span><br><span class="line">		    <span class="keyword">if</span> (<span class="string">"false"</span>.equals(retryValue)) &#123;</span><br><span class="line">			<span class="comment">//属性retryKey的值为false,则添加新的属性到map中(即禁用方法重试)</span></span><br><span class="line">			map.put(method.getName() + <span class="string">".retries"</span>, <span class="string">"0"</span>);</span><br><span class="line">		    &#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//附加属性(后面会分析该方法)</span></span><br><span class="line">		appendAttributes(attributes, method, prefix + <span class="string">"."</span> + method.getName());</span><br><span class="line">		<span class="comment">//attributes保存的是方法名，调用checkAndConvertImplicitConfig方法后将会保存Method实例</span></span><br><span class="line">		checkAndConvertImplicitConfig(method, map, attributes);</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//从系统配置属性中获取：注册到注册中心的ip</span></span><br><span class="line">	String hostToRegistry = ConfigUtils.getSystemProperty(Constants.DUBBO_IP_TO_REGISTRY);</span><br><span class="line">	<span class="keyword">if</span> (hostToRegistry == <span class="keyword">null</span> || hostToRegistry.length() == <span class="number">0</span>) &#123;</span><br><span class="line">	    <span class="comment">//获取本地地址,如：192.168.99.60</span></span><br><span class="line">	    hostToRegistry = NetUtils.getLocalHost();</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (isInvalidLocalHost(hostToRegistry)) &#123;</span><br><span class="line">	    <span class="comment">//无效的地址</span></span><br><span class="line">	    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Specified invalid registry ip from property:"</span> + Constants.DUBBO_IP_TO_REGISTRY + <span class="string">", value:"</span> + hostToRegistry);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//设置属性：注册到注册中心的ip</span></span><br><span class="line">	map.put(Constants.REGISTER_IP_KEY, hostToRegistry);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//保存方法属性到系统上下文中</span></span><br><span class="line">	StaticContext.getSystemContext().putAll(attributes);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//根据服务接口及其属性创建代理(后面会分析该方法)</span></span><br><span class="line">	ref = createProxy(map);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//构造ConsumerModel对象,getUniqueServiceName()生成唯一服务名称</span></span><br><span class="line">	ConsumerModel consumerModel = <span class="keyword">new</span> ConsumerModel(getUniqueServiceName(), <span class="keyword">this</span>, ref, interfaceClass.getMethods());</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//根据服务名称注册消费者(后面会分析该方法)</span></span><br><span class="line">	ApplicationModel.initConsumerModel(getUniqueServiceName(), consumerModel);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接下来，我们看上面使用到的方法</p>
<h5 id="checkDefault方法"><a href="#checkDefault方法" class="headerlink" title="checkDefault方法"></a>checkDefault方法</h5><p>获取Consumer的全局配置<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkDefault</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (consumer == <span class="keyword">null</span>) &#123;</span><br><span class="line">	    <span class="comment">//consumer为空，会新创建一个ConsumerConfig对象</span></span><br><span class="line">            consumer = <span class="keyword">new</span> ConsumerConfig();</span><br><span class="line">        &#125;</span><br><span class="line">	<span class="comment">//调用appendProperties方法</span></span><br><span class="line">        appendProperties(consumer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="appendProperties方法"><a href="#appendProperties方法" class="headerlink" title="appendProperties方法"></a>appendProperties方法</h5><p>该方法在init方法中大量出现，我们先看下它的实现，它是定义在AbstractConfig抽象类中的静态方法，参数是AbstractConfig类型。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 附加属性</span></span><br><span class="line"><span class="comment"> * 找到config的所有的setXXX方法，然后切割出属性XXX，然后从系统配置/dubbo配置文件中获取到属性的值，</span></span><br><span class="line"><span class="comment"> * 然后执行setXXX方法把属性值设置到config对象中</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> config</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">appendProperties</span><span class="params">(AbstractConfig config)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (config == <span class="keyword">null</span>) &#123;</span><br><span class="line">	   <span class="comment">//config为空，直接返回</span></span><br><span class="line">	   <span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//生成前缀，如： dubbo.monitor.</span></span><br><span class="line">	String prefix = <span class="string">"dubbo."</span> + getTagName(config.getClass()) + <span class="string">"."</span>;</span><br><span class="line">	<span class="comment">//获取config类的所有方法</span></span><br><span class="line">	Method[] methods = config.getClass().getMethods();</span><br><span class="line">	<span class="comment">//遍历方法列表</span></span><br><span class="line">	<span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">	    <span class="keyword">try</span> &#123;</span><br><span class="line">		String name = method.getName();</span><br><span class="line">		<span class="comment">//方法名长度&gt;3，以set开头，修饰符是public，参数个数=1，参数类型是原始类型</span></span><br><span class="line">		<span class="keyword">if</span> (name.length() &gt; <span class="number">3</span> &amp;&amp; name.startsWith(<span class="string">"set"</span>) &amp;&amp; Modifier.isPublic(method.getModifiers())</span><br><span class="line">			&amp;&amp; method.getParameterTypes().length == <span class="number">1</span> &amp;&amp; isPrimitive(method.getParameterTypes()[<span class="number">0</span>])) &#123;</span><br><span class="line">		    <span class="comment">//转换方法名称为属性名称，如：setFirstName将会转换成first.name</span></span><br><span class="line">		    <span class="comment">//例如：property = default</span></span><br><span class="line">		    String property = StringUtils.camelToSplitName(name.substring(<span class="number">3</span>, <span class="number">4</span>).toLowerCase() + name.substring(<span class="number">4</span>), <span class="string">"."</span>);</span><br><span class="line"></span><br><span class="line">		    <span class="comment">//1、从系统配置中获取：prefix + id + property</span></span><br><span class="line">		    <span class="comment">//2、从系统配置中获取：prefix + property</span></span><br><span class="line">		    <span class="comment">//3、从config类中找到属性get方法或者is方法，然后执行该方法</span></span><br><span class="line">			<span class="comment">//3.1、从config配置中获取 prefix + id + property属性</span></span><br><span class="line">			<span class="comment">//3.2、从config配置中获取 prefix + property属性</span></span><br><span class="line">			<span class="comment">//3.3、根据prefix + property获取旧版属性legacyKey,然后根据legacyKey从config配置中获取</span></span><br><span class="line">		    <span class="comment">//ConfigUtils.getProperty(后面会分析该方法)</span></span><br><span class="line">		    <span class="comment">//如果属性值value不为空的话，则调用该set方法，将属性设置到config对象中，整个方法流程执行结束</span></span><br><span class="line">			</span><br><span class="line">		    String value = <span class="keyword">null</span>;</span><br><span class="line">		    <span class="keyword">if</span> (config.getId() != <span class="keyword">null</span> &amp;&amp; config.getId().length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="comment">//如果id属性不为空，则属性名称为：prefix + id + property</span></span><br><span class="line">			<span class="comment">//例如：pn = dubbo.monitor."id".default</span></span><br><span class="line">			String pn = prefix + config.getId() + <span class="string">"."</span> + property;</span><br><span class="line">			<span class="comment">//从系统配置中获取属性pn的值value</span></span><br><span class="line">			value = System.getProperty(pn);</span><br><span class="line">			<span class="keyword">if</span> (!StringUtils.isBlank(value)) &#123;</span><br><span class="line">			    <span class="comment">//如果系统中设置了pn属性，则使用该属性值</span></span><br><span class="line">			    logger.info(<span class="string">"Use System Property "</span> + pn + <span class="string">" to config dubbo"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		    &#125;</span><br><span class="line">		    <span class="keyword">if</span> (value == <span class="keyword">null</span> || value.length() == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="comment">//属性名称为：prefix + property</span></span><br><span class="line">			<span class="comment">//例如：dubbo.monitor.default</span></span><br><span class="line">			String pn = prefix + property;</span><br><span class="line">			<span class="comment">//获取属性pn的系统属性值value</span></span><br><span class="line">			value = System.getProperty(pn);</span><br><span class="line">			<span class="keyword">if</span> (!StringUtils.isBlank(value)) &#123;</span><br><span class="line">			    logger.info(<span class="string">"Use System Property "</span> + pn + <span class="string">" to config dubbo"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		    &#125;</span><br><span class="line">		    <span class="keyword">if</span> (value == <span class="keyword">null</span> || value.length() == <span class="number">0</span>) &#123;</span><br><span class="line">			Method getter;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">			    <span class="comment">//获取当前属性的get方法</span></span><br><span class="line">			    getter = config.getClass().getMethod(<span class="string">"get"</span> + name.substring(<span class="number">3</span>), <span class="keyword">new</span> Class&lt;?&gt;[<span class="number">0</span>]);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">			    <span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="comment">//get方法不存在的话，则获取下is方法</span></span><br><span class="line">				getter = config.getClass().getMethod(<span class="string">"is"</span> + name.substring(<span class="number">3</span>), <span class="keyword">new</span> Class&lt;?&gt;[<span class="number">0</span>]);</span><br><span class="line">			    &#125; <span class="keyword">catch</span> (NoSuchMethodException e2) &#123;</span><br><span class="line">				getter = <span class="keyword">null</span>;</span><br><span class="line">			    &#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (getter != <span class="keyword">null</span>) &#123;</span><br><span class="line">			    <span class="comment">//执行config对象的属性的getter方法，结果为空的话</span></span><br><span class="line">			    <span class="keyword">if</span> (getter.invoke(config, <span class="keyword">new</span> Object[<span class="number">0</span>]) == <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">if</span> (config.getId() != <span class="keyword">null</span> &amp;&amp; config.getId().length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">				    <span class="comment">//id属性不为空</span></span><br><span class="line">				    <span class="comment">//如：dubbo.monitor."id".default</span></span><br><span class="line">				    value = ConfigUtils.getProperty(prefix + config.getId() + <span class="string">"."</span> + property);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (value == <span class="keyword">null</span> || value.length() == <span class="number">0</span>) &#123;</span><br><span class="line">				    <span class="comment">//如：dubbo.monitor.default</span></span><br><span class="line">				    value = ConfigUtils.getProperty(prefix + property);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (value == <span class="keyword">null</span> || value.length() == <span class="number">0</span>) &#123;</span><br><span class="line">				    <span class="comment">//从旧版属性中获取(如：dubbo.monitor.default)</span></span><br><span class="line">				    String legacyKey = legacyProperties.get(prefix + property);</span><br><span class="line">				    <span class="keyword">if</span> (legacyKey != <span class="keyword">null</span> &amp;&amp; legacyKey.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">					<span class="comment">//转换旧版属性值</span></span><br><span class="line">					value = convertLegacyValue(legacyKey, ConfigUtils.getProperty(legacyKey));</span><br><span class="line">				    &#125;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">			    &#125;</span><br><span class="line">			&#125;</span><br><span class="line">		    &#125;</span><br><span class="line">		    <span class="keyword">if</span> (value != <span class="keyword">null</span> &amp;&amp; value.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="comment">//如果属性值不为空的话，则使用属性值作为参数执行config类的method方法</span></span><br><span class="line">			method.invoke(</span><br><span class="line">				config,</span><br><span class="line">				<span class="keyword">new</span> Object[]&#123;</span><br><span class="line">					<span class="comment">//转换原始类型</span></span><br><span class="line">					convertPrimitive(method.getParameterTypes()[<span class="number">0</span>], value)</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">			);</span><br><span class="line">		    &#125;</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">		logger.error(e.getMessage(), e);</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="checkInterfaceAndMethods方法"><a href="#checkInterfaceAndMethods方法" class="headerlink" title="checkInterfaceAndMethods方法"></a>checkInterfaceAndMethods方法</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 判断方法methods是否都在服务接口类中存在</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> interfaceClass 服务接口类</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> methods 引用的服务接口方法</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">checkInterfaceAndMethods</span><span class="params">(Class&lt;?&gt; interfaceClass, List&lt;MethodConfig&gt; methods)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (interfaceClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">	    <span class="comment">//服务接口不可以为空</span></span><br><span class="line">	    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"interface not allow null!"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!interfaceClass.isInterface()) &#123;</span><br><span class="line">	    <span class="comment">// interfaceClass必须为接口类型</span></span><br><span class="line">	    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The interface class "</span> + interfaceClass + <span class="string">" is not a interface!"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 检查methods方法是否存在于interfaceClass接口中</span></span><br><span class="line">	<span class="keyword">if</span> (methods != <span class="keyword">null</span> &amp;&amp; !methods.isEmpty()) &#123;</span><br><span class="line">	    <span class="comment">//遍历引用的方法</span></span><br><span class="line">	    <span class="keyword">for</span> (MethodConfig methodBean : methods) &#123;</span><br><span class="line">		<span class="comment">//方法名</span></span><br><span class="line">		String methodName = methodBean.getName();</span><br><span class="line">		<span class="keyword">if</span> (methodName == <span class="keyword">null</span> || methodName.length() == <span class="number">0</span>) &#123;</span><br><span class="line">		    <span class="comment">//&lt;dubbo:method&gt;标签的name属性必须设置</span></span><br><span class="line">		    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"&lt;dubbo:method&gt; name attribute is required! Please check: &lt;dubbo:service interface=\""</span> + interfaceClass.getName() + <span class="string">"\" ... &gt;&lt;dubbo:method name=\"\" ... /&gt;&lt;/&lt;dubbo:reference&gt;"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">boolean</span> hasMethod = <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">for</span> (java.lang.reflect.Method method : interfaceClass.getMethods()) &#123;</span><br><span class="line">		    <span class="comment">//方法名一样，则认为存在该方法</span></span><br><span class="line">		    <span class="keyword">if</span> (method.getName().equals(methodName)) &#123;</span><br><span class="line">			hasMethod = <span class="keyword">true</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		    &#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!hasMethod) &#123;</span><br><span class="line">		    <span class="comment">//引用的方法在服务接口中不存在</span></span><br><span class="line">		    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The interface "</span> + interfaceClass.getName()</span><br><span class="line">			    + <span class="string">" not found method "</span> + methodName);</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="checkApplication方法"><a href="#checkApplication方法" class="headerlink" title="checkApplication方法"></a>checkApplication方法</h5><p>该方法用来验证application,application为空的话，会新建ApplicationConfig对象<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">checkApplication</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 处理兼容</span></span><br><span class="line">	<span class="keyword">if</span> (application == <span class="keyword">null</span>) &#123;</span><br><span class="line">	    <span class="comment">//从配置文件中加载application.name属性</span></span><br><span class="line">	    String applicationName = ConfigUtils.getProperty(<span class="string">"dubbo.application.name"</span>);</span><br><span class="line">	    <span class="keyword">if</span> (applicationName != <span class="keyword">null</span> &amp;&amp; applicationName.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="comment">//新创建一个ApplicationConfig对象</span></span><br><span class="line">		application = <span class="keyword">new</span> ApplicationConfig();</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (application == <span class="keyword">null</span>) &#123;</span><br><span class="line">	    <span class="comment">//需要配置 &lt;dubbo:application name=\"...\" /&gt;</span></span><br><span class="line">	    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">		    <span class="string">"No such application config! Please add &lt;dubbo:application name=\"...\" /&gt; to your spring config."</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//添加application的属性</span></span><br><span class="line">	appendProperties(application);</span><br><span class="line">	<span class="comment">//获取配置: 服务停止时的等待时间(优先获取SHUTDOWN_WAIT_KEY属性，在获取SHUTDOWN_WAIT_SECONDS_KEY(废弃))</span></span><br><span class="line">	String wait = ConfigUtils.getProperty(Constants.SHUTDOWN_WAIT_KEY);</span><br><span class="line">	<span class="keyword">if</span> (wait != <span class="keyword">null</span> &amp;&amp; wait.trim().length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">	    <span class="comment">//设置到系统配置中</span></span><br><span class="line">	    System.setProperty(Constants.SHUTDOWN_WAIT_KEY, wait.trim());</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	    wait = ConfigUtils.getProperty(Constants.SHUTDOWN_WAIT_SECONDS_KEY);</span><br><span class="line">	    <span class="keyword">if</span> (wait != <span class="keyword">null</span> &amp;&amp; wait.trim().length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		System.setProperty(Constants.SHUTDOWN_WAIT_SECONDS_KEY, wait.trim());</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="checkStubAndMock方法"><a href="#checkStubAndMock方法" class="headerlink" title="checkStubAndMock方法"></a>checkStubAndMock方法</h5><p>该方法用来检测: 服务接口本地实现类、服务接口本地存根类、mock<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 检测local/stub/mock的配置是否正确</span></span><br><span class="line"><span class="comment">* local/stub/mock(mock 可配置为"return ")应该为interfaceClass或者为interfaceClass子类</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> interfaceClass 服务接口类</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">checkStubAndMock</span><span class="params">(Class&lt;?&gt; interfaceClass)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//处理服务接口本地实现类</span></span><br><span class="line">	<span class="keyword">if</span> (ConfigUtils.isNotEmpty(local)) &#123;</span><br><span class="line">	    <span class="comment">//如果local = true或者local = default(即local属性配置),则本地实现类名为：接口名称+Local,否则本地实现类名为：local属性</span></span><br><span class="line">	    <span class="comment">//加载本地实现类</span></span><br><span class="line">	    Class&lt;?&gt; localClass = ConfigUtils.isDefault(local) ? ReflectUtils.forName(interfaceClass.getName() + <span class="string">"Local"</span>) : ReflectUtils.forName(local);</span><br><span class="line">	    <span class="comment">//检查本地实现类是否实现了服务接口</span></span><br><span class="line">	    <span class="keyword">if</span> (!interfaceClass.isAssignableFrom(localClass)) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The local implementation class "</span> + localClass.getName() + <span class="string">" not implement interface "</span> + interfaceClass.getName());</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">//检测本地实现类中是否存在相应的构造方法，即：public 本地实现类名 (服务接口名)&#123;&#125;</span></span><br><span class="line">		ReflectUtils.findConstructor(localClass, interfaceClass);</span><br><span class="line">	    &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No such constructor \"public "</span> + localClass.getSimpleName() + <span class="string">"("</span> + interfaceClass.getName() + <span class="string">")\" in local implementation class "</span> + localClass.getName());</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//处理服务接口本地存根类</span></span><br><span class="line">	<span class="keyword">if</span> (ConfigUtils.isNotEmpty(stub)) &#123;</span><br><span class="line">	    <span class="comment">//如果stub = true或者stub = default(即stub属性)，则本地存根类名为：接口名称+Stub,否则本地存根类名为：stub属性</span></span><br><span class="line">	    <span class="comment">//加载本地存根类</span></span><br><span class="line">	    Class&lt;?&gt; localClass = ConfigUtils.isDefault(stub) ? ReflectUtils.forName(interfaceClass.getName() + <span class="string">"Stub"</span>) : ReflectUtils.forName(stub);</span><br><span class="line">	    <span class="comment">//检测本地存根类是否实现了服务接口</span></span><br><span class="line">	    <span class="keyword">if</span> (!interfaceClass.isAssignableFrom(localClass)) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The local implementation class "</span> + localClass.getName() + <span class="string">" not implement interface "</span> + interfaceClass.getName());</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">//检测本地存根类是否存在相应的构造方法, 即：public 本地存根类名 (服务接口名)&#123;&#125;</span></span><br><span class="line">		ReflectUtils.findConstructor(localClass, interfaceClass);</span><br><span class="line">	    &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No such constructor \"public "</span> + localClass.getSimpleName() + <span class="string">"("</span> + interfaceClass.getName() + <span class="string">")\" in local implementation class "</span> + localClass.getName());</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//处理mock</span></span><br><span class="line">	<span class="keyword">if</span> (ConfigUtils.isNotEmpty(mock)) &#123;</span><br><span class="line">	    <span class="comment">//判断mock属性是否以"return "开头</span></span><br><span class="line">	    <span class="keyword">if</span> (mock.startsWith(Constants.RETURN_PREFIX)) &#123;</span><br><span class="line">		<span class="comment">//获取到"return "之后的值</span></span><br><span class="line">		String value = mock.substring(Constants.RETURN_PREFIX.length());</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">		    <span class="comment">//解析mock值</span></span><br><span class="line">		    MockInvoker.parseMockValue(value);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">		    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Illegal mock json value in &lt;dubbo:service ... mock=\""</span> + mock + <span class="string">"\" /&gt;"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">//获取mock类</span></span><br><span class="line">		<span class="comment">//如果mock = true或者mock = default(即mock属性)，则本地存根类名为：接口名称+Mock,否则本地存根类名为：mock属性</span></span><br><span class="line">		Class&lt;?&gt; mockClass = ConfigUtils.isDefault(mock) ? ReflectUtils.forName(interfaceClass.getName() + <span class="string">"Mock"</span>) : ReflectUtils.forName(mock);</span><br><span class="line">		<span class="comment">//检测mock类是否实现了服务接口</span></span><br><span class="line">		<span class="keyword">if</span> (!interfaceClass.isAssignableFrom(mockClass)) &#123;</span><br><span class="line">		    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The mock implementation class "</span> + mockClass.getName() + <span class="string">" not implement interface "</span> + interfaceClass.getName());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">		    <span class="comment">//检测默认构造方法，即：pulic mock类名 () &#123;&#125;</span></span><br><span class="line">		    mockClass.getConstructor(<span class="keyword">new</span> Class&lt;?&gt;[<span class="number">0</span>]);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">		    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No such empty constructor \"public "</span> + mockClass.getSimpleName() + <span class="string">"()\" in mock implementation class "</span> + mockClass.getName());</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="appendParameters方法"><a href="#appendParameters方法" class="headerlink" title="appendParameters方法"></a>appendParameters方法</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 附加参数</span></span><br><span class="line"><span class="comment">* 1、获取config对象的方法列表，</span></span><br><span class="line"><span class="comment">* 2、找到getXXX或者isXXX方法或者getParameters方法(会通过方法上的<span class="doctag">@Parameter</span>注解判断是否需要过滤该属性)</span></span><br><span class="line"><span class="comment">* 3、然后执行该方法，拿到方法返回值(会通过方法上的<span class="doctag">@Parameter</span>注解判断是否需要编码及追加)。</span></span><br><span class="line"><span class="comment">* 然后将属性(<span class="doctag">@Parameter</span>注解配置或者通过getXXX获取，如果配置了prefix，则属性为: prefix.属性)</span></span><br><span class="line"><span class="comment">* 以及值保存到parameters中</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> parameters 当前参数Map</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> config  目标配置对象</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> prefix 属性配置前缀</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">appendParameters</span><span class="params">(Map&lt;String, String&gt; parameters, Object config, String prefix)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (config == <span class="keyword">null</span>) &#123;</span><br><span class="line">	    <span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//获取配置类config的所有方法</span></span><br><span class="line">	Method[] methods = config.getClass().getMethods();</span><br><span class="line">	<span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">	    <span class="keyword">try</span> &#123;</span><br><span class="line">		String name = method.getName();</span><br><span class="line">		<span class="comment">//方法名以get或者is开头，并且方法名不为getClass，并且存在public修饰符</span></span><br><span class="line">		<span class="comment">//并且不存在参数，并且方法返回类型为原始类型</span></span><br><span class="line">		<span class="keyword">if</span> ((name.startsWith(<span class="string">"get"</span>) || name.startsWith(<span class="string">"is"</span>))</span><br><span class="line">			&amp;&amp; !<span class="string">"getClass"</span>.equals(name)</span><br><span class="line">			&amp;&amp; Modifier.isPublic(method.getModifiers())</span><br><span class="line">			&amp;&amp; method.getParameterTypes().length == <span class="number">0</span></span><br><span class="line">			&amp;&amp; isPrimitive(method.getReturnType())) &#123;</span><br><span class="line">		    <span class="comment">//获取方法上的@Parameter注解</span></span><br><span class="line">		    Parameter parameter = method.getAnnotation(Parameter.class);</span><br><span class="line">		    <span class="keyword">if</span> (method.getReturnType() == Object.class || parameter != <span class="keyword">null</span> &amp;&amp; parameter.excluded()) &#123;</span><br><span class="line">			<span class="comment">//如果当前方法的返回类型为Object，或者该方法存在@Parameter注解且excluded属性值为true</span></span><br><span class="line">			<span class="comment">//则跳过该方法，即忽略该属性</span></span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		    &#125;</span><br><span class="line">		    <span class="keyword">int</span> i = name.startsWith(<span class="string">"get"</span>) ? <span class="number">3</span> : <span class="number">2</span>;</span><br><span class="line">		    <span class="comment">//根据方法名获取到属性名，如：getFirstName被转换成：first.name</span></span><br><span class="line">		    String prop = StringUtils.camelToSplitName(name.substring(i, i + <span class="number">1</span>).toLowerCase() + name.substring(i + <span class="number">1</span>), <span class="string">"."</span>);</span><br><span class="line">		    <span class="comment">//key为@Parameter注解的key属性或者为根据当前方法名截取到的属性名</span></span><br><span class="line">		    String key;</span><br><span class="line">		    <span class="keyword">if</span> (parameter != <span class="keyword">null</span> &amp;&amp; parameter.key() != <span class="keyword">null</span> &amp;&amp; parameter.key().length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="comment">//如果@Parameter注解的key属性不为空，则使用key属性</span></span><br><span class="line">			key = parameter.key();</span><br><span class="line">		    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">//否则使用prop作为key</span></span><br><span class="line">			key = prop;</span><br><span class="line">		    &#125;</span><br><span class="line">		    <span class="comment">//执行config对象的method方法，获取到方法返回值</span></span><br><span class="line">		    Object value = method.invoke(config, <span class="keyword">new</span> Object[<span class="number">0</span>]);</span><br><span class="line">		    <span class="comment">//将方法返回值转换成字符串，并去掉空格</span></span><br><span class="line">		    String str = String.valueOf(value).trim();</span><br><span class="line">		    <span class="keyword">if</span> (value != <span class="keyword">null</span> &amp;&amp; str.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="comment">//方法返回值不为空</span></span><br><span class="line">			<span class="keyword">if</span> (parameter != <span class="keyword">null</span> &amp;&amp; parameter.escaped()) &#123;</span><br><span class="line">			    <span class="comment">//根据@Parameter注解的escaped属性来决定是否需要对属性值进行编码</span></span><br><span class="line">			    str = URL.encode(str);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (parameter != <span class="keyword">null</span> &amp;&amp; parameter.append()) &#123;</span><br><span class="line">			    <span class="comment">//如果配置了@Parameter注解的append属性为true</span></span><br><span class="line">			    <span class="comment">//则从参数Map中获取key对应的值pre</span></span><br><span class="line">			    String pre = parameters.get(Constants.DEFAULT_KEY + <span class="string">"."</span> + key);</span><br><span class="line">			    <span class="keyword">if</span> (pre != <span class="keyword">null</span> &amp;&amp; pre.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">				<span class="comment">//追加方法返回值</span></span><br><span class="line">				str = pre + <span class="string">","</span> + str;</span><br><span class="line">			    &#125;</span><br><span class="line">			    pre = parameters.get(key);</span><br><span class="line">			    <span class="keyword">if</span> (pre != <span class="keyword">null</span> &amp;&amp; pre.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">				<span class="comment">//追加方法返回值</span></span><br><span class="line">				str = pre + <span class="string">","</span> + str;</span><br><span class="line">			    &#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (prefix != <span class="keyword">null</span> &amp;&amp; prefix.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			    <span class="comment">//如果前缀不为空，则拼接key</span></span><br><span class="line">			    key = prefix + <span class="string">"."</span> + key;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">//将key、value保存到参数Map中</span></span><br><span class="line">			parameters.put(key, str);</span><br><span class="line">		    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parameter != <span class="keyword">null</span> &amp;&amp; parameter.required()) &#123;</span><br><span class="line">			<span class="comment">//如果方法返回值为空，且@Parameter注解的required属性为true</span></span><br><span class="line">			<span class="comment">//则抛出异常，提示config类的key属性的值为空</span></span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(config.getClass().getSimpleName() + <span class="string">"."</span> + key + <span class="string">" == null"</span>);</span><br><span class="line">		    &#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"getParameters"</span>.equals(name)</span><br><span class="line">			&amp;&amp; Modifier.isPublic(method.getModifiers())</span><br><span class="line">			&amp;&amp; method.getParameterTypes().length == <span class="number">0</span></span><br><span class="line">			&amp;&amp; method.getReturnType() == Map.class) &#123;</span><br><span class="line">		    <span class="comment">//方法名称为getParameters，且方法有public修饰符，且参数为空，且方法返回值为Map</span></span><br><span class="line">		    <span class="comment">//则执行config对象的getParameters方法，获取到返回值Map</span></span><br><span class="line">		    Map&lt;String, String&gt; map = (Map&lt;String, String&gt;) method.invoke(config, <span class="keyword">new</span> Object[<span class="number">0</span>]);</span><br><span class="line">		    <span class="keyword">if</span> (map != <span class="keyword">null</span> &amp;&amp; map.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="comment">//格式化前缀，前缀以“.”结尾</span></span><br><span class="line">			String pre = (prefix != <span class="keyword">null</span> &amp;&amp; prefix.length() &gt; <span class="number">0</span> ? prefix + <span class="string">"."</span> : <span class="string">""</span>);</span><br><span class="line">			<span class="comment">//遍历getParameters方法返回值</span></span><br><span class="line">			<span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : map.entrySet()) &#123;</span><br><span class="line">			    <span class="comment">//将属性以及属性值保存到parameters中</span></span><br><span class="line">			    parameters.put(pre + entry.getKey().replace(<span class="string">'-'</span>, <span class="string">'.'</span>), entry.getValue());</span><br><span class="line">			&#125;</span><br><span class="line">		    &#125;</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e.getMessage(), e);</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="appendAttributes方法"><a href="#appendAttributes方法" class="headerlink" title="appendAttributes方法"></a>appendAttributes方法</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 附加属性</span></span><br><span class="line"><span class="comment">* 1、获取config对象的getXXX或者isXXX方法(会通过方法上的<span class="doctag">@Parameter</span>注解判断是否需要过滤该属性)，</span></span><br><span class="line"><span class="comment">* 然后调用该方法获取返回值value。</span></span><br><span class="line"><span class="comment">* 2、然后根据<span class="doctag">@Parameter</span>注解的key属性或者当前方法名称(取消get/is前缀)作为key（prefix+"."+key），</span></span><br><span class="line"><span class="comment">* 3、最终将key和value保存到parameters中</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> parameters 保存方法属性</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> config MethodConfig等对象</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> prefix</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">appendAttributes</span><span class="params">(Map&lt;Object, Object&gt; parameters, Object config, String prefix)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (config == <span class="keyword">null</span>) &#123;</span><br><span class="line">	    <span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	Method[] methods = config.getClass().getMethods();</span><br><span class="line">	<span class="comment">//遍历config对象的方法</span></span><br><span class="line">	<span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">	    <span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">//方法名</span></span><br><span class="line">		String name = method.getName();</span><br><span class="line">		<span class="comment">//找到get方法或者is方法</span></span><br><span class="line">		<span class="keyword">if</span> ((name.startsWith(<span class="string">"get"</span>) || name.startsWith(<span class="string">"is"</span>))</span><br><span class="line">			&amp;&amp; !<span class="string">"getClass"</span>.equals(name)</span><br><span class="line">			&amp;&amp; Modifier.isPublic(method.getModifiers())</span><br><span class="line">			&amp;&amp; method.getParameterTypes().length == <span class="number">0</span></span><br><span class="line">			&amp;&amp; isPrimitive(method.getReturnType())) &#123;</span><br><span class="line">		    <span class="comment">//获取方法上的@Parameter注解</span></span><br><span class="line">		    Parameter parameter = method.getAnnotation(Parameter.class);</span><br><span class="line">		    <span class="keyword">if</span> (parameter == <span class="keyword">null</span> || !parameter.attribute()) &#123;</span><br><span class="line">			<span class="comment">//如果该方法没有@Parameter注解，或者@Parameter注解的attribute属性为false</span></span><br><span class="line">			<span class="comment">//则跳过该方法</span></span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		    &#125;</span><br><span class="line">		    <span class="comment">//优先获取@Parameter注解的key属性，否则获取当前方法名(去掉get或者is前缀)</span></span><br><span class="line">		    String key;</span><br><span class="line">		    <span class="keyword">if</span> (parameter.key() != <span class="keyword">null</span> &amp;&amp; parameter.key().length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			key = parameter.key();</span><br><span class="line">		    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">int</span> i = name.startsWith(<span class="string">"get"</span>) ? <span class="number">3</span> : <span class="number">2</span>;</span><br><span class="line">			key = name.substring(i, i + <span class="number">1</span>).toLowerCase() + name.substring(i + <span class="number">1</span>);</span><br><span class="line">		    &#125;</span><br><span class="line">		    <span class="comment">//执行config对象的当前方法，获取方法返回值</span></span><br><span class="line">		    Object value = method.invoke(config, <span class="keyword">new</span> Object[<span class="number">0</span>]);</span><br><span class="line">		    <span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (prefix != <span class="keyword">null</span> &amp;&amp; prefix.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			    <span class="comment">//前缀不为空的话，拼接上前缀</span></span><br><span class="line">			    key = prefix + <span class="string">"."</span> + key;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">//将属性和属性值放到parameters中</span></span><br><span class="line">			parameters.put(key, value);</span><br><span class="line">		    &#125;</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e.getMessage(), e);</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="checkAndConvertImplicitConfig方法"><a href="#checkAndConvertImplicitConfig方法" class="headerlink" title="checkAndConvertImplicitConfig方法"></a>checkAndConvertImplicitConfig方法</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 处理onreturn、onthrow、oninvoke属性，将attributes中的value，从"方法名称"转换成"方法对象"</span></span><br><span class="line"><span class="comment">* 如：将&lt;onReturnMethodKey,onReturnMethod方法名&gt;转换为&lt;onReturnMethodKey,onReturnMethod方法对象&gt;</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> method 当前方法配置</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> map 当前所有属性map</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> attributes 当前方法的属性map</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkAndConvertImplicitConfig</span><span class="params">(MethodConfig method, Map&lt;String, String&gt; map, Map&lt;Object, Object&gt; attributes)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//检测配置冲突</span></span><br><span class="line">	<span class="keyword">if</span> (Boolean.FALSE.equals(method.isReturn()) &amp;&amp; (method.getOnreturn() != <span class="keyword">null</span> || method.getOnthrow() != <span class="keyword">null</span>)) &#123;</span><br><span class="line">	    <span class="comment">//当设置了onreturn或者onthrow时，必须同时设置isReturn为true</span></span><br><span class="line">	    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"method config error : return attribute must be set true when onreturn or onthrow has been setted."</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//attributes存的是&lt;onReturnMethodKey,onReturnMethod方法名&gt;</span></span><br><span class="line">	<span class="comment">//经过转换后存的是&lt;onReturnMethodKey,onReturnMethod方法类&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//onReturnMethodKey是属性key</span></span><br><span class="line">	String onReturnMethodKey = StaticContext.getKey(map, method.getName(), Constants.ON_RETURN_METHOD_KEY);</span><br><span class="line">	<span class="comment">//从attributes中获取属性onReturnMethodKey对应的值(方法名)</span></span><br><span class="line">	Object onReturnMethod = attributes.get(onReturnMethodKey);</span><br><span class="line">	<span class="keyword">if</span> (onReturnMethod != <span class="keyword">null</span> &amp;&amp; onReturnMethod <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">	    <span class="comment">//getMethodByName方法根据方法名onReturnMethod从类method.getOnreturn().getClass()中找到相应的方法</span></span><br><span class="line">	    attributes.put(onReturnMethodKey, getMethodByName(method.getOnreturn().getClass(), onReturnMethod.toString()));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//下面的类似</span></span><br><span class="line">	<span class="comment">//convert onthrow methodName to Method</span></span><br><span class="line">	String onThrowMethodKey = StaticContext.getKey(map, method.getName(), Constants.ON_THROW_METHOD_KEY);</span><br><span class="line">	Object onThrowMethod = attributes.get(onThrowMethodKey);</span><br><span class="line">	<span class="keyword">if</span> (onThrowMethod != <span class="keyword">null</span> &amp;&amp; onThrowMethod <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">	    attributes.put(onThrowMethodKey, getMethodByName(method.getOnthrow().getClass(), onThrowMethod.toString()));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//convert oninvoke methodName to Method</span></span><br><span class="line">	String onInvokeMethodKey = StaticContext.getKey(map, method.getName(), Constants.ON_INVOKE_METHOD_KEY);</span><br><span class="line">	Object onInvokeMethod = attributes.get(onInvokeMethodKey);</span><br><span class="line">	<span class="keyword">if</span> (onInvokeMethod != <span class="keyword">null</span> &amp;&amp; onInvokeMethod <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">	    attributes.put(onInvokeMethodKey, getMethodByName(method.getOninvoke().getClass(), onInvokeMethod.toString()));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="StaticContext类"><a href="#StaticContext类" class="headerlink" title="StaticContext类"></a>StaticContext类</h5><p>init方法中，最终会将方法的属性添加到StaticContext中<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">StaticContext.getSystemContext().putAll(attributes);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 系统上下文，只是框架内部使用</span></span><br><span class="line"><span class="comment"> * System context, for internal use only</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StaticContext</span> <span class="keyword">extends</span> <span class="title">ConcurrentHashMap</span>&lt;<span class="title">Object</span>, <span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SYSTEMNAME = <span class="string">"system"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentMap&lt;String, StaticContext&gt; context_map = <span class="keyword">new</span> ConcurrentHashMap&lt;String, StaticContext&gt;();</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">StaticContext</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取系统上下文,即key为system</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> StaticContext <span class="title">getSystemContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getContext(SYSTEMNAME);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据name获取上下文</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> StaticContext <span class="title">getContext</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//通过name从context_map中获取StaticContext</span></span><br><span class="line">        StaticContext appContext = context_map.get(name);</span><br><span class="line">        <span class="keyword">if</span> (appContext == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//没有获取到StaticContext，则为name新建一个StaticContext，然后放入context_map中</span></span><br><span class="line">            appContext = context_map.putIfAbsent(name, <span class="keyword">new</span> StaticContext(name));</span><br><span class="line">            <span class="keyword">if</span> (appContext == <span class="keyword">null</span>) &#123;</span><br><span class="line">                appContext = context_map.get(name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> appContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从context_map中移除name对应的上下文</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> StaticContext <span class="title">remove</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> context_map.remove(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getKey</span><span class="params">(URL url, String methodName, String suffix)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getKey(url.getServiceKey(), methodName, suffix);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getKey</span><span class="params">(Map&lt;String, String&gt; paras, String methodName, String suffix)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getKey(StringUtils.getServiceKey(paras), methodName, suffix);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取唯一标识</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> servicekey 服务唯一标识</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> methodName 方法名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> suffix  前缀</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getKey</span><span class="params">(String servicekey, String methodName, String suffix)</span> </span>&#123;</span><br><span class="line">        StringBuffer sb = <span class="keyword">new</span> StringBuffer().append(servicekey).append(<span class="string">"."</span>).append(methodName).append(<span class="string">"."</span>).append(suffix);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="getUniqueServiceName方法"><a href="#getUniqueServiceName方法" class="headerlink" title="getUniqueServiceName方法"></a>getUniqueServiceName方法</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 获取唯一服务名称（group和version可以为空）</span></span><br><span class="line"><span class="comment">* group/interfaceName:version</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Parameter</span>(excluded = <span class="keyword">true</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getUniqueServiceName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	StringBuilder buf = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">	<span class="keyword">if</span> (group != <span class="keyword">null</span> &amp;&amp; group.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">	    buf.append(group).append(<span class="string">"/"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	buf.append(interfaceName);</span><br><span class="line">	<span class="keyword">if</span> (version != <span class="keyword">null</span> &amp;&amp; version.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">	    buf.append(<span class="string">":"</span>).append(version);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> buf.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="ConsumerModel类"><a href="#ConsumerModel类" class="headerlink" title="ConsumerModel类"></a>ConsumerModel类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerModel</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 元数据(即ReferenceBean实例)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> ReferenceConfig metadata;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 代理对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object proxyObject;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 唯一的服务接口名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String serviceName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Method, ConsumerMethodModel&gt; methodModels = <span class="keyword">new</span> IdentityHashMap&lt;Method, ConsumerMethodModel&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConsumerModel</span><span class="params">(String serviceName,ReferenceConfig metadata, Object proxyObject, Method[] methods)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.serviceName = serviceName;</span><br><span class="line">        <span class="keyword">this</span>.metadata = metadata;</span><br><span class="line">        <span class="keyword">this</span>.proxyObject = proxyObject;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (proxyObject != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//代理对象不为空,遍历服务接口方法列表，创建ConsumerMethodModel类</span></span><br><span class="line">            <span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">                <span class="comment">//&lt;服务接口方法，ConsumerMethodModel&lt;服务接口方法,metadata实例&gt;&gt;</span></span><br><span class="line">                methodModels.put(method, <span class="keyword">new</span> ConsumerMethodModel(method, metadata));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return service metadata for consumer</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> service metadata</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ReferenceConfig <span class="title">getMetadata</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> metadata;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getProxyObject</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> proxyObject;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取消费者端的给定方法的MethodModel</span></span><br><span class="line"><span class="comment">     * Return method model for the given method on consumer side</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> method method object</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> method model</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConsumerMethodModel <span class="title">getMethodModel</span><span class="params">(Method method)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> methodModels.get(method);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取当前服务的所有方法MethodModel</span></span><br><span class="line"><span class="comment">     * Return all method models for the current service</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> method model list</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;ConsumerMethodModel&gt; <span class="title">getAllMethods</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;ConsumerMethodModel&gt;(methodModels.values());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getServiceName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> serviceName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="ApplicationModel类"><a href="#ApplicationModel类" class="headerlink" title="ApplicationModel类"></a>ApplicationModel类</h5><p>接下来我们简单看下ApplicationModel.initConsumerModel(getUniqueServiceName(), consumerModel);<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 将服务的ConsumerModel方法保存到本地Map中</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> serviceName</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> consumerModel</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">initConsumerModel</span><span class="params">(String serviceName, ConsumerModel consumerModel)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (consumedServices.putIfAbsent(serviceName, consumerModel) != <span class="keyword">null</span>) &#123;</span><br><span class="line">	    logger.warn(<span class="string">"Already register the same consumer:"</span> + serviceName);</span><br><span class="line">	    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>init方法我们还剩下两个方法没有讲解：<br>1、 ref = createProxy(map); 即创建代理对象<br>2、String[] methods = Wrapper.getWrapper(interfaceClass).getMethodNames(); 即包装类</p>
<p>计划这两个方法留着后面的章节(讲完注册中心等章节后)在讲解。</p>

        
            <div class="donate-container">
    <div class="donate-button">
        <button id="donate-button">赞赏</button>
    </div>
    <div class="donate-img-container hide" id="donate-img-container">
        <img id="donate-img" src="" data-src="/blog/img/pay.png">
        <p> thank you </p>
    </div>
</div>
        
        <div id="comment-container">
        </div>
    </div>
</div>
    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <span>/</span>
        
        <span><a href="https://medium.com/netflix-techblog">Netflix</a></span>
        <span>/</span>
        
        <span><a href="https://engineering.linkedin.com/blog">Linkedin</a></span>
        <span>/</span>
        
        <span><a href="https://blogs.dropbox.com/tech/">Dropbox</a></span>
        <span>/</span>
        
        <span><a href="https://code.fb.com/">Facebook</a></span>
        <span>/</span>
        
        <span><a href="https://www.fpcomplete.com/blog">FPComplete</a></span>
        <span>/</span>
        
        <span><a href="https://blog.janestreet.com/">JaneStreet</a></span>
        <span>/</span>
        
        <span><a href="https://github.com/limengyu1990/">Github</a></span>
        <span>/</span>
        
        <span><a href="https://serokell.io/blog">serokell</a></span>
        <span>/</span>
        
    </p>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/blog/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/blog/js/index.js"></script>
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

</html>
