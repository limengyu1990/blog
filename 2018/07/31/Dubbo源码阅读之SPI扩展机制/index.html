<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/blog/img/favicon.ico">

    <title>
        
        Dubbo源码阅读之SPI扩展机制 - undefined
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/blog/css/aircloud.css">
    <link rel="stylesheet" href="/blog/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> 所有的善恶都是我，良心一路走来依旧清澈鲜活... </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar">
            <img src="/blog/img/photo.png" />
        </div>
        <div class="name">
            <i>不负如来不负卿</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/blog/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/blog/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/blog/archive">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/blog/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Java的SPI机制"><span class="toc-text">Java的SPI机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Dubbo的SPI机制"><span class="toc-text">Dubbo的SPI机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Dubbo-SPI相关接口"><span class="toc-text">Dubbo SPI相关接口</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SPI接口"><span class="toc-text">SPI接口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Adaptive接口"><span class="toc-text">Adaptive接口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Activate接口"><span class="toc-text">Activate接口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ExtensionFactory接口"><span class="toc-text">ExtensionFactory接口</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ExtensionLoader类"><span class="toc-text">ExtensionLoader类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#getExtensionLoader方法"><span class="toc-text">getExtensionLoader方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#getExtension方法"><span class="toc-text">getExtension方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#getDefaultExtension方法"><span class="toc-text">getDefaultExtension方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#getExtensionClasses方法-加载扩展实现类"><span class="toc-text">getExtensionClasses方法(加载扩展实现类)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#createExtension方法-创建扩展实现类实例"><span class="toc-text">createExtension方法(创建扩展实现类实例)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#getActivateExtension方法"><span class="toc-text">getActivateExtension方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#getAdaptiveExtension方法"><span class="toc-text">getAdaptiveExtension方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ExtensionFactory工厂实现"><span class="toc-text">ExtensionFactory工厂实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SpringExtensionFactory"><span class="toc-text">SpringExtensionFactory</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SpiExtensionFactory"><span class="toc-text">SpiExtensionFactory</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AdaptiveExtensionFactory"><span class="toc-text">AdaptiveExtensionFactory</span></a></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>
        <div class="index-about-mobile">
            <i> 所有的善恶都是我，良心一路走来依旧清澈鲜活... </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        Dubbo源码阅读之SPI扩展机制
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2018-07-31 09:10:44</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/blog/tags/#dubbo" title="dubbo">dubbo</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <blockquote>
<p>本文主要分析Dubbo的SPI扩展机制。</p>
</blockquote>
<ul>
<li><a href="https://docs.oracle.com/javase/1.5.0/docs/guide/jar/jar.html#Service%20Provider" target="_blank" rel="noopener">Java的SPI机制</a></li>
<li>Dubbo的SPI机制</li>
</ul>
<h3 id="Java的SPI机制"><a href="#Java的SPI机制" class="headerlink" title="Java的SPI机制"></a>Java的SPI机制</h3><p>SPI全称为(Service Provider Interface)，是JDK内置的一种服务提供发现机制。通过SPI服务加载机制进行服务的注册和发现，可以实现基于接口的编程，避免在Java代码中写死服务的提供者，实现多个模块的解耦。<br>根据Java的SPI规范，我们可以定义一个服务接口，具体的实现由对应的实现者（Service Provider服务提供者）提供，然后在使用的时候只要根据SPI的规范去获取对应的服务提供者的服务实现即可。我们看一个简单的例子：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> java.spi;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Developer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPrograme</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> java.spi;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JavaDeveloper</span> <span class="keyword">implements</span> <span class="title">Developer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPrograme</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Java"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> java.spi;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PerlDeveloper</span> <span class="keyword">implements</span> <span class="title">Developer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPrograme</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Perl"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后在META-INF\services目录下创建名为java.spi.Developer的文件，文件内容是接口实现类的全限定名：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java.spi.JavaDeveloper</span><br><span class="line">java.spi.PerlDeveloper</span><br></pre></td></tr></table></figure></p>
<p>将文件导出为jar包，新建一个项目，在项目中导入该jar,然后新建一个测试类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.ServiceLoader;</span><br><span class="line"><span class="keyword">import</span> cn.edu.knowledge.spi.Developer;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] arg)</span> </span>&#123;</span><br><span class="line">         ServiceLoader&lt;Developer&gt; serviceLoader = ServiceLoader.load(Developer.class);</span><br><span class="line">	 <span class="keyword">for</span> (Developer developer : Developer) &#123;</span><br><span class="line">	        <span class="comment">//将会输出: I use Java; I use Perl;</span></span><br><span class="line">		System.out.println(<span class="string">"I use "</span>+developer.getPrograme());</span><br><span class="line">	 &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Dubbo的SPI机制"><a href="#Dubbo的SPI机制" class="headerlink" title="Dubbo的SPI机制"></a>Dubbo的SPI机制</h3><p>Dubbo的扩展点加载是对JDK内置的SPI机制的一种加强。继续使用上面的例子介绍，<br>META-INF\services\java.spi.Developer文件中的内容将会变为key=value形式：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java=java.spi.JavaDeveloper</span><br><span class="line">perl=java.spi.PerlDeveloper</span><br></pre></td></tr></table></figure></p>
<p>其中，key为扩展名称，value为扩展实例。扩展配置文件修改为这样子是因为，如果扩展实现中的方法或者静态字段引用了第三方库，而第三方库不存在时，那么这个类将会初始化失败，在这种情况下，如果使用以前的格式，Dubbo不可以弄清楚扩展的id，因此不可以映射这个扩展的异常信息。<br>例如：<br>无法加载扩展(“mina”),当用户配置使用mina，Dubbo将会抱怨无法加载扩展，而不是报告提取哪一个扩展实现失败及原因。</p>
<p>与Java标准SPI相比，Dubbo SPI又增加了如下功能：</p>
<ul>
<li>Dubbo可以通过getExtension（String key）只加载某一个想要的扩展，Java的SPI机制则需要加载全部的实现类。</li>
<li>对于扩展实现IOC依赖注入功能，如果扩展实现A含有setB()方法，而接口B有B1和B2两个具体的实现，此时Dubbo并不会具体注入B1或者B2，而是会注入一个自动生成的接口B实现：B$Adpative，该实现者能够根据参数的不同，自动引用B1或者B2来完成相应的功能。</li>
<li>对扩展采用装饰器模式进行功能增强。</li>
</ul>
<h3 id="Dubbo-SPI相关接口"><a href="#Dubbo-SPI相关接口" class="headerlink" title="Dubbo SPI相关接口"></a>Dubbo SPI相关接口</h3><h4 id="SPI接口"><a href="#SPI接口" class="headerlink" title="SPI接口"></a>SPI接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.TYPE&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SPI &#123;</span><br><span class="line">    <span class="comment">//默认扩展名称</span></span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当接口上表明了@SPI注解时，Dubbo将会依次从如下目录中读取相应的扩展点：<br>META-INF/dubbo/internal/<br>META-INF/dubbo/<br>META-INF/services/</p>
<h4 id="Adaptive接口"><a href="#Adaptive接口" class="headerlink" title="Adaptive接口"></a>Adaptive接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Adaptive &#123;</span><br><span class="line">    String[] value() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ExtensionLoader注入依赖扩展实例时，该接口为其提供了有用的信息。<br>value方法决定要注入哪个目标扩展。目标扩展由URL中传递的参数决定，value方法提供了url上的参数名称。如果在URL中没有找到指定的参数名称，则将使用默认的扩展（在其接口上的@SPI注解中进行指定）。<br>例如,给定字符串：value={“key1”, “key2”}，如果在URL中发现参数key1，则使用参数key1的值作为扩展名称，如果在URL中没有发现参数key1或者参数key1的值为空，则尝试使用参数key2的值作为扩展名称，如果key2也不存在，则使用默认的扩展，否则抛异常。<br>如果默认的扩展名称在@SPI注解中没有提供，则使用规则生成一个name，这个name将用作URL中的搜索参数。规则为：将接口类名从大写字符开始分成几个部分, 并将各部分用点 “.” 分开。<br>例如：com.alibaba.dubbo.xxx.YyyInvokerWrapper，则生成的name为yyy.invoker.wrapper，将会使用该name从url中进行搜索。</p>
<h4 id="Activate接口"><a href="#Activate接口" class="headerlink" title="Activate接口"></a>Activate接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Activate &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当group数组中有一个group匹配时，就激活当前扩展。</span></span><br><span class="line"><span class="comment">     * 将使用传递给ExtensionLoader#getActivateExtension(URL, String, String)方法的group(第三个参数)来和该注解的group进行匹配</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String[] group() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当指定的key出现在URL的参数中时，则激活当前扩展 </span></span><br><span class="line"><span class="comment">     * 例如：给定<span class="doctag">@Activate</span>("cache, validation")时，只有url中出现cache或者validation参数时，才会激活当前扩展</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String[] value() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//相对顺序 扩展列表中的哪些扩展将要放到当前扩展前面</span></span><br><span class="line">    String[] before() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//相对顺序 扩展列表中的哪些扩展将要放到当前扩展后面</span></span><br><span class="line">    String[] after() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//绝对顺序</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">order</span><span class="params">()</span> <span class="keyword">default</span> 0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用于激活扩展。此注解对于使用给定条件自动激活某些扩展是非常有用的，比如：如果有多个Filter实现，@Activate可以用来加载某些Filter。<br>SPI提供者可以调用ExtensionLoader#getActivateExtension(URL, String, String)方法找到所有符合条件的activated扩展。</p>
<h4 id="ExtensionFactory接口"><a href="#ExtensionFactory接口" class="headerlink" title="ExtensionFactory接口"></a>ExtensionFactory接口</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@SPI</span><br><span class="line">public interface ExtensionFactory &#123;</span><br><span class="line">    /**</span><br><span class="line">     * 获取扩展实现类实例</span><br><span class="line">     * Get extension.</span><br><span class="line">     * @param type object type. 扩展接口类型</span><br><span class="line">     * @param name object name. 扩展名称</span><br><span class="line">     * @return object instance. 返回扩展实例</span><br><span class="line">     */</span><br><span class="line">    &lt;T&gt; T getExtension(Class&lt;T&gt; type, String name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该接口根据扩展类型和扩展名称获取扩展实例。可以看到该接口声明上也加上了@SPI注解，说明存在多种实现，Dubbo提供了三种实现，分别为AdaptiveExtensionFactory、SpiExtensionFactory、SpringExtensionFactory，后面会详细介绍具体实现。</p>
<h3 id="ExtensionLoader类"><a href="#ExtensionLoader类" class="headerlink" title="ExtensionLoader类"></a>ExtensionLoader类</h3><p>ExtensionLoader类用来处理Dubbo扩展,里面定义了大量的实用方法，该类支持以下主要功能：</p>
<ul>
<li>自动注入依赖扩展</li>
<li>在wrapper中，自动包装扩展</li>
<li>默认扩展是一个adaptive实例</li>
</ul>
<p>ExtensionLoader类代码量比较多，我们先来看下ExtensionLoader类的getExtensionLoader方法，通过该方法可以得到指定扩展类型接口的扩展加载器，<br>例如我们想要得到ProxyFactory类型的ExtensionLoader，可以这样做：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ExtensionLoader&lt;ProxyFactory&gt; loader = ExtensionLoader.getExtensionLoader(ProxyFactory.class);</span><br></pre></td></tr></table></figure></p>
<h4 id="getExtensionLoader方法"><a href="#getExtensionLoader方法" class="headerlink" title="getExtensionLoader方法"></a>getExtensionLoader方法</h4><p>我们来看getExtensionLoader方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取扩展类型接口的扩展加载器</span></span><br><span class="line"><span class="comment"> * 1、校验扩展类型</span></span><br><span class="line"><span class="comment"> * 2、从缓存中获取扩展类型对应的扩展加载器</span></span><br><span class="line"><span class="comment"> * 3、缓存中不存在，则新建一个并放入缓存</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">ExtensionLoader&lt;T&gt; <span class="title">getExtensionLoader</span><span class="params">(Class&lt;T&gt; type)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//扩展类型不可以为空</span></span><br><span class="line">        <span class="keyword">if</span> (type == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Extension type == null"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">	<span class="comment">//扩展类型必须为接口</span></span><br><span class="line">        <span class="keyword">if</span> (!type.isInterface()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Extension type("</span> + type + <span class="string">") is not interface!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">	<span class="comment">//检测扩展类型接口是否是一个扩展点，判断依据是：接口必须有@SPI注解</span></span><br><span class="line">        <span class="keyword">if</span> (!withExtensionAnnotation(type)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Extension type("</span> + type +</span><br><span class="line">                    <span class="string">") is not extension, because WITHOUT @"</span> + SPI.class.getSimpleName() + <span class="string">" Annotation!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//首先从缓存中获取该扩展类型的ExtensionLoader</span></span><br><span class="line">        ExtensionLoader&lt;T&gt; loader = (ExtensionLoader&lt;T&gt;) EXTENSION_LOADERS.get(type);</span><br><span class="line">        <span class="keyword">if</span> (loader == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//缓存中不存在，则为扩展类型type新建一个ExtensionLoader，并放入缓存</span></span><br><span class="line">            EXTENSION_LOADERS.putIfAbsent(type, <span class="keyword">new</span> ExtensionLoader&lt;T&gt;(type));</span><br><span class="line">            loader = (ExtensionLoader&lt;T&gt;) EXTENSION_LOADERS.get(type);</span><br><span class="line">        &#125;</span><br><span class="line">	<span class="comment">//返回扩展类型的ExtensionLoader</span></span><br><span class="line">        <span class="keyword">return</span> loader;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 私有构造方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">ExtensionLoader</span><span class="params">(Class&lt;?&gt; type)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//保存扩展类型接口</span></span><br><span class="line">        <span class="keyword">this</span>.type = type;</span><br><span class="line">        <span class="comment">//ExtensionFactory接口的扩展实现类不需要进行注入依赖，因此这里将objectFactory设置成null</span></span><br><span class="line">	<span class="comment">//其他扩展接口可能依赖其他扩展接口，因此需要进行依赖注入，通过objectFactory可以获取到某个扩展类型的扩展实例</span></span><br><span class="line">        objectFactory = (type == ExtensionFactory.class ? <span class="keyword">null</span> :</span><br><span class="line">                    ExtensionLoader.getExtensionLoader(ExtensionFactory.class).getAdaptiveExtension()</span><br><span class="line">        );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其中type和objectFactory是ExtensionLoader类中定义的实例变量,EXTENSION_LOADERS缓存是静态常量：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 扩展接口的类型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Class&lt;?&gt; type;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 扩展工厂，通过扩展工厂可以获取到某个扩展类型的扩展实例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ExtensionFactory objectFactory;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 每个扩展类型接口(即带有<span class="doctag">@SPI</span>注解的接口)，都有一个相对应的ExtensionLoader实例</span></span><br><span class="line"><span class="comment"> * &lt;扩展类型接口，ExtensionLoader实例&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentMap&lt;Class&lt;?&gt;, ExtensionLoader&lt;?&gt;&gt; EXTENSION_LOADERS =</span><br><span class="line">		<span class="keyword">new</span> ConcurrentHashMap&lt;Class&lt;?&gt;, ExtensionLoader&lt;?&gt;&gt;();</span><br></pre></td></tr></table></figure></p>
<h4 id="getExtension方法"><a href="#getExtension方法" class="headerlink" title="getExtension方法"></a>getExtension方法</h4><p>有了ExtensionLoader实例后，就可以通过该实例的getExtension(String name)方法加载扩展类型的指定实例：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通过扩展名称name获取扩展实例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">getExtension</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//扩展名称不可以为空</span></span><br><span class="line">        <span class="keyword">if</span> (name == <span class="keyword">null</span> || name.length() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Extension name == null"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"true"</span>.equals(name)) &#123;</span><br><span class="line">            <span class="comment">//name = true 返回默认扩展实例（后面会分析该方法）</span></span><br><span class="line">            <span class="keyword">return</span> getDefaultExtension();</span><br><span class="line">        &#125;</span><br><span class="line">	<span class="comment">//根据扩展名称从cachedInstances实例变量中获取扩展实例</span></span><br><span class="line">	<span class="comment">//扩展实例被放入到Holder对象中，Holder类是一个持有值的助手类，提供了get/set方法</span></span><br><span class="line">        Holder&lt;Object&gt; holder = cachedInstances.get(name);</span><br><span class="line">        <span class="keyword">if</span> (holder == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//缓存中不存在的话，则为扩展名称name新建一个Holder实例。</span></span><br><span class="line">            cachedInstances.putIfAbsent(name, <span class="keyword">new</span> Holder&lt;Object&gt;());</span><br><span class="line">            holder = cachedInstances.get(name);</span><br><span class="line">        &#125;</span><br><span class="line">	<span class="comment">//从holder对象中获取到扩展名称name对应的扩展实例</span></span><br><span class="line">        Object instance = holder.get();</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">	    <span class="comment">//扩展实例为空，则为扩展名称name新建一个扩展实例并放入Holder对象中。</span></span><br><span class="line">	    <span class="comment">//这里可能会存在多个线程同时访问，因此需要同步创建扩展实例</span></span><br><span class="line">            <span class="keyword">synchronized</span> (holder) &#123;</span><br><span class="line">	        <span class="comment">//再次判断holder对象中的扩展实例是否为空</span></span><br><span class="line">                instance = holder.get();</span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//根据扩展名称name创建扩展实例（后面会分析该方法）</span></span><br><span class="line">                    instance = createExtension(name);</span><br><span class="line">		    <span class="comment">//放入缓存</span></span><br><span class="line">                    holder.set(instance);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">	<span class="comment">//返回扩展实例</span></span><br><span class="line">        <span class="keyword">return</span> (T) instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在看getDefaultExtension方法和createExtension方法之前，我们先看下上面getExtension方法中出现的变量定义：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 缓存 &lt;扩展名称，扩展实例&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;String, Holder&lt;Object&gt;&gt; cachedInstances =</span><br><span class="line">    <span class="keyword">new</span> ConcurrentHashMap&lt;String, Holder&lt;Object&gt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 持有一个值的助手类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Holder</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> T value;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="getDefaultExtension方法"><a href="#getDefaultExtension方法" class="headerlink" title="getDefaultExtension方法"></a>getDefaultExtension方法</h4><p>接下来我们来看getDefaultExtension方法，该方法用来获取默认扩展实例。在该方法内部又调用了多个方法，我们一步步来分析，分析完整个流程后，我们在看createExtension方法.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回默认扩展实例，如果没有配置默认扩展名称(<span class="doctag">@SPI</span>注解上配置的)，则返回null</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">getDefaultExtension</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取扩展接口type对应的扩展实现类集合(后面会分析该方法)</span></span><br><span class="line">	getExtensionClasses();</span><br><span class="line">	<span class="comment">//判断cachedDefaultName变量是否为空</span></span><br><span class="line">	<span class="comment">//cachedDefaultName变量是在getExtensionClasses()方法中进行赋值的，我们稍后去看</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">null</span> == cachedDefaultName || cachedDefaultName.length() == <span class="number">0</span> || <span class="string">"true"</span>.equals(cachedDefaultName)) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//获取默认扩展名称对应的扩展实例</span></span><br><span class="line">	<span class="keyword">return</span> getExtension(cachedDefaultName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="getExtensionClasses方法-加载扩展实现类"><a href="#getExtensionClasses方法-加载扩展实现类" class="headerlink" title="getExtensionClasses方法(加载扩展实现类)"></a>getExtensionClasses方法(加载扩展实现类)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取扩展接口type对应的扩展实现类集合，先从缓存获取，缓存没有的话，再去重新加载</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Map&lt;String, Class&lt;?&gt;&gt; getExtensionClasses() &#123;</span><br><span class="line">	<span class="comment">//先从cachedClasses缓存中获取</span></span><br><span class="line">	Map&lt;String, Class&lt;?&gt;&gt; classes = cachedClasses.get();</span><br><span class="line">	<span class="keyword">if</span> (classes == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="comment">//缓存中为空，同步加载</span></span><br><span class="line">		<span class="keyword">synchronized</span> (cachedClasses) &#123;</span><br><span class="line">			<span class="comment">//再次判断</span></span><br><span class="line">			classes = cachedClasses.get();</span><br><span class="line">			<span class="keyword">if</span> (classes == <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="comment">//重新加载扩展实现类（后面会分析该方法）</span></span><br><span class="line">				classes = loadExtensionClasses();</span><br><span class="line">				<span class="comment">//放入缓存</span></span><br><span class="line">				cachedClasses.set(classes);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> classes;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 默认扩展名称,<span class="doctag">@SPI</span>注解上配置的值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> String cachedDefaultName;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用来缓存扩展接口type对应的所有扩展实现类</span></span><br><span class="line"><span class="comment"> * &lt;扩展名称，扩展实现类&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Holder&lt;Map&lt;String, Class&lt;?&gt;&gt;&gt; cachedClasses = <span class="keyword">new</span> Holder&lt;Map&lt;String, Class&lt;?&gt;&gt;&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 加载扩展接口type对应的所有扩展实现类</span></span><br><span class="line"><span class="comment"> * 在getExtensionClasses中会进行同步</span></span><br><span class="line"><span class="comment"> * synchronized in getExtensionClasses</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Map&lt;String, Class&lt;?&gt;&gt; loadExtensionClasses() &#123;</span><br><span class="line">	<span class="comment">//获取扩展接口type上的@SPI注解</span></span><br><span class="line">	<span class="keyword">final</span> SPI defaultAnnotation = type.getAnnotation(SPI.class);</span><br><span class="line">	<span class="keyword">if</span> (defaultAnnotation != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="comment">//存在@SPI注解，则获取注解值(即默认扩展名称)</span></span><br><span class="line">		String value = defaultAnnotation.value();</span><br><span class="line">		<span class="keyword">if</span> ((value = value.trim()).length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="comment">//使用逗号分隔扩展名称</span></span><br><span class="line">			String[] names = NAME_SEPARATOR.split(value);</span><br><span class="line">			<span class="keyword">if</span> (names.length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">			    <span class="comment">//存在多个默认扩展名称，则抛异常</span></span><br><span class="line">			    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"more than 1 default extension name on extension "</span> + type.getName()</span><br><span class="line">				    + <span class="string">": "</span> + Arrays.toString(names));</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (names.length == <span class="number">1</span>) &#123;</span><br><span class="line">			    <span class="comment">//保存默认扩展名称到cachedDefaultName</span></span><br><span class="line">			    cachedDefaultName = names[<span class="number">0</span>];</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//开始加载扩展类，依次从3个目录进行加载,保存到extensionClasses中</span></span><br><span class="line">	Map&lt;String, Class&lt;?&gt;&gt; extensionClasses = <span class="keyword">new</span> HashMap&lt;String, Class&lt;?&gt;&gt;();</span><br><span class="line">	<span class="comment">//目录看下面的常量定义(后面会分析该方法)</span></span><br><span class="line">	loadDirectory(extensionClasses, DUBBO_INTERNAL_DIRECTORY);</span><br><span class="line">	loadDirectory(extensionClasses, DUBBO_DIRECTORY);</span><br><span class="line">	loadDirectory(extensionClasses, SERVICES_DIRECTORY);</span><br><span class="line">	<span class="keyword">return</span> extensionClasses;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 扩展所在目录</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SERVICES_DIRECTORY = <span class="string">"META-INF/services/"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DUBBO_DIRECTORY = <span class="string">"META-INF/dubbo/"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DUBBO_INTERNAL_DIRECTORY = DUBBO_DIRECTORY + <span class="string">"internal/"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取ExtensionLoader的类加载器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ClassLoader <span class="title">findClassLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> ExtensionLoader.class.getClassLoader();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 扫描相应目录，加载扩展并保存到extensionClasses集合</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> extensionClasses 保存扩展类的Map集合</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> dir  扫描目录</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadDirectory</span><span class="params">(Map&lt;String, Class&lt;?&gt;&gt; extensionClasses, String dir)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//待加载的文件名，如：fileName = META-INF/dubbo/internal/com.alibaba.dubbo.rpc.ProxyFactory</span></span><br><span class="line">	String fileName = dir + type.getName();</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">	    Enumeration&lt;java.net.URL&gt; urls;</span><br><span class="line">	    <span class="comment">//获取ExtensionLoader类加载器(后面会分析该方法)</span></span><br><span class="line">	    ClassLoader classLoader = findClassLoader();</span><br><span class="line">	    <span class="keyword">if</span> (classLoader != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="comment">//当前类加载器不为空，加载该文件</span></span><br><span class="line">		urls = classLoader.getResources(fileName);</span><br><span class="line">	    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">//当前类加载器为空，则从用来加载类的搜索路径中查找改文件</span></span><br><span class="line">		urls = ClassLoader.getSystemResources(fileName);</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">if</span> (urls != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">while</span> (urls.hasMoreElements()) &#123;</span><br><span class="line">		    <span class="comment">//获取到资源定位符</span></span><br><span class="line">		    java.net.URL resourceURL = urls.nextElement();</span><br><span class="line">		    <span class="comment">//加载资源,即读取并解析配置文件，然后加载类(后面会分析该方法)</span></span><br><span class="line">		    loadResource(extensionClasses, classLoader, resourceURL);</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">	    logger.error(<span class="string">"Exception when load extension class(interface: "</span> +</span><br><span class="line">		    type + <span class="string">", description file: "</span> + fileName + <span class="string">")."</span>, t);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解析配置文件，然后加载扩展类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> extensionClasses 保存扩展类的集合</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> classLoader  类加载器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> resourceURL  资源定位符</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadResource</span><span class="params">(Map&lt;String, Class&lt;?&gt;&gt; extensionClasses, ClassLoader classLoader, java.net.URL resourceURL)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">	    BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(resourceURL.openStream(), <span class="string">"utf-8"</span>));</span><br><span class="line">	    <span class="keyword">try</span> &#123;</span><br><span class="line">		String line;</span><br><span class="line">		<span class="comment">//读取配置文件每一行</span></span><br><span class="line">		<span class="keyword">while</span> ((line = reader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">		    <span class="comment">//判断当前行是否包含#号，#号后面的内容都是注释，需要去掉</span></span><br><span class="line">		    <span class="keyword">final</span> <span class="keyword">int</span> ci = line.indexOf(<span class="string">'#'</span>);</span><br><span class="line">		    <span class="keyword">if</span> (ci &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="comment">//截取#号之前的内容，并重新设置line</span></span><br><span class="line">			line = line.substring(<span class="number">0</span>, ci);</span><br><span class="line">		    &#125;</span><br><span class="line">		    line = line.trim();</span><br><span class="line">		    <span class="keyword">if</span> (line.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">			    String name = <span class="keyword">null</span>;</span><br><span class="line">			    <span class="comment">//当前行是否包含=号</span></span><br><span class="line">			    <span class="keyword">int</span> i = line.indexOf(<span class="string">'='</span>);</span><br><span class="line">			    <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">				<span class="comment">//当前行存在=号，则使用=号分隔line，获取到key-value(line)</span></span><br><span class="line">				<span class="comment">//name就是key，即定义的扩展名称</span></span><br><span class="line">				<span class="comment">//line就是value，即定义的扩展实现类全限定名</span></span><br><span class="line">				name = line.substring(<span class="number">0</span>, i).trim();</span><br><span class="line">				line = line.substring(i + <span class="number">1</span>).trim();</span><br><span class="line">			    &#125;</span><br><span class="line">			    <span class="comment">//如果line不等于空，则需要加载该扩展实现类</span></span><br><span class="line">			    <span class="keyword">if</span> (line.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">				<span class="comment">//加载扩展实现类(后面会分析该方法)</span></span><br><span class="line">				loadClass(</span><br><span class="line">					extensionClasses,</span><br><span class="line">					resourceURL,</span><br><span class="line">					<span class="comment">//加载扩展实现类</span></span><br><span class="line">					Class.forName(line, <span class="keyword">true</span>, classLoader),</span><br><span class="line">					name</span><br><span class="line">				);</span><br><span class="line">			    &#125;</span><br><span class="line">			&#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">			    IllegalStateException e = <span class="keyword">new</span> IllegalStateException(<span class="string">"Failed to load extension class(interface: "</span> + type + <span class="string">", class line: "</span> + line + <span class="string">") in "</span> + resourceURL + <span class="string">", cause: "</span> + t.getMessage(), t);</span><br><span class="line">			    <span class="comment">//解析行出错，记录错误行到exceptions实例变量中</span></span><br><span class="line">			    exceptions.put(line, e);</span><br><span class="line">			&#125;</span><br><span class="line">		    &#125;</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		reader.close();</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">	    logger.error(<span class="string">"Exception when load extension class(interface: "</span> +</span><br><span class="line">		    type + <span class="string">", class file: "</span> + resourceURL + <span class="string">") in "</span> + resourceURL, t);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 保存解析配置文件发生的异常信息</span></span><br><span class="line"><span class="comment"> * &lt;当前key-value行，异常信息&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Map&lt;String, IllegalStateException&gt; exceptions = <span class="keyword">new</span> ConcurrentHashMap&lt;String, IllegalStateException&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 当前扩展类型接口type对应的扩展自适应类</span></span><br><span class="line"><span class="comment"> * 即存在<span class="doctag">@Adaptive</span>注解的扩展实现类</span></span><br><span class="line"><span class="comment"> * 每个扩展类型接口type只能有一个实现类有<span class="doctag">@Adaptive</span>注解，如果多个扩展实现类都有<span class="doctag">@Adaptive</span>，则会抛异常</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> Class&lt;?&gt; cachedAdaptiveClass = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 如果扩展实现类是一个包装类，</span></span><br><span class="line"><span class="comment"> * 则会将该该实现类添加到cachedWrapperClasses集合中</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Set&lt;Class&lt;?&gt;&gt; cachedWrapperClasses;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 扩展名称正则表达式，将会使用该正则表达式切割扩展名称name，即使用逗号分隔</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern NAME_SEPARATOR = Pattern.compile(<span class="string">"\\s*[,]+\\s*"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 缓存&lt;扩展名称，Activate注解&gt;</span></span><br><span class="line"><span class="comment"> * 如果是逗号分隔的多个name，则取第1个扩展名称name</span></span><br><span class="line"><span class="comment"> * Activate为当前扩展实现类上的<span class="doctag">@Activate</span>注解</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Activate&gt; cachedActivates = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Activate&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 缓存&lt;扩展实现类，扩展名称&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;Class&lt;?&gt;, String&gt; cachedNames = <span class="keyword">new</span> ConcurrentHashMap&lt;Class&lt;?&gt;, String&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 加载扩展实现类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> extensionClasses 保存扩展实现类的map</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> resourceURL 资源文件定位符</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> clazz 扩展实现类，即实现了type接口的类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> name  扩展名称，即配置文件中的key</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> NoSuchMethodException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadClass</span><span class="params">(Map&lt;String, Class&lt;?&gt;&gt; extensionClasses,</span></span></span><br><span class="line"><span class="function"><span class="params">		   java.net.URL resourceURL,</span></span></span><br><span class="line"><span class="function"><span class="params">		   Class&lt;?&gt; clazz,</span></span></span><br><span class="line"><span class="function"><span class="params">		   String name)</span> <span class="keyword">throws</span> NoSuchMethodException </span>&#123;</span><br><span class="line">	<span class="comment">//检测实现类clazz是否是type的子类型，即clazz是否实现了接口type</span></span><br><span class="line">	<span class="keyword">if</span> (!type.isAssignableFrom(clazz)) &#123;</span><br><span class="line">	    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Error when load extension class(interface: "</span> +</span><br><span class="line">		    type + <span class="string">", class line: "</span> + clazz.getName() + <span class="string">"), class "</span></span><br><span class="line">		    + clazz.getName() + <span class="string">"is not subtype of interface."</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//检测实现类clazz是否有@Adaptive注解</span></span><br><span class="line">	<span class="keyword">if</span> (clazz.isAnnotationPresent(Adaptive.class)) &#123;</span><br><span class="line">	    <span class="keyword">if</span> (cachedAdaptiveClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">	        <span class="comment">//cachedAdaptiveClass变量为空，则将cachedAdaptiveClass赋值为clazz</span></span><br><span class="line">		cachedAdaptiveClass = clazz;</span><br><span class="line">	    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!cachedAdaptiveClass.equals(clazz)) &#123;</span><br><span class="line">	        <span class="comment">//cachedAdaptiveClass变量不为空，则判断cachedAdaptiveClass是否和当前实现类class是否是同一个</span></span><br><span class="line">		<span class="comment">//如果不是同一个，则抛异常：每个扩展类型type不可以存在多个自适应扩展类</span></span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"More than 1 adaptive class found: "</span></span><br><span class="line">			+ cachedAdaptiveClass.getClass().getName()</span><br><span class="line">			+ <span class="string">", "</span> + clazz.getClass().getName());</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (isWrapperClass(clazz)) &#123;</span><br><span class="line">	    <span class="comment">//实现类clazz是包装类(后面会分析该方法)</span></span><br><span class="line">	    Set&lt;Class&lt;?&gt;&gt; wrappers = cachedWrapperClasses;</span><br><span class="line">	    <span class="keyword">if</span> (wrappers == <span class="keyword">null</span>) &#123;</span><br><span class="line">		cachedWrapperClasses = <span class="keyword">new</span> ConcurrentHashSet&lt;Class&lt;?&gt;&gt;();</span><br><span class="line">		wrappers = cachedWrapperClasses;</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="comment">//将该扩展实现类添加到包装类集合中</span></span><br><span class="line">	    wrappers.add(clazz);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	    <span class="comment">//检测该实现类是否有默认构造方法</span></span><br><span class="line">	    clazz.getConstructor();</span><br><span class="line">	    <span class="keyword">if</span> (name == <span class="keyword">null</span> || name.length() == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="comment">//扩展名称name为空时，则根据规则重新设置name(后面会分析该方法)</span></span><br><span class="line">		name = findAnnotationName(clazz);</span><br><span class="line">		<span class="keyword">if</span> (name == <span class="keyword">null</span> || name.length() == <span class="number">0</span>) &#123;</span><br><span class="line">		    <span class="comment">//name仍然为空</span></span><br><span class="line">		    <span class="keyword">if</span> (clazz.getSimpleName().length() &gt; type.getSimpleName().length()</span><br><span class="line">			    &amp;&amp; clazz.getSimpleName().endsWith(type.getSimpleName())) &#123;</span><br><span class="line">			<span class="comment">//如果当前扩展实现类的类名以扩展接口type的名称结尾，则截取接口类名称之前的部分作为name，并转换成小写</span></span><br><span class="line">			<span class="comment">//例如：当clazz = JavassistProxyFactory，type = ProxyFactory时，则name = javassist</span></span><br><span class="line">			name = clazz.getSimpleName().substring(<span class="number">0</span>, clazz.getSimpleName().length() - type.getSimpleName().length()).toLowerCase();</span><br><span class="line">		    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">//扩展实现类class没有对应的扩展名称，抛异常</span></span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No such extension name for the class "</span> + clazz.getName() + <span class="string">" in the config "</span> + resourceURL);</span><br><span class="line">		    &#125;</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="comment">//使用逗号分隔扩展名称name</span></span><br><span class="line">	    String[] names = NAME_SEPARATOR.split(name);</span><br><span class="line">	    <span class="keyword">if</span> (names != <span class="keyword">null</span> &amp;&amp; names.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">	        <span class="comment">//获取扩展实现类上的@Activate注解</span></span><br><span class="line">		Activate activate = clazz.getAnnotation(Activate.class);</span><br><span class="line">		<span class="keyword">if</span> (activate != <span class="keyword">null</span>) &#123;</span><br><span class="line">		    <span class="comment">//存在@Activate注解</span></span><br><span class="line">		    <span class="comment">//则将第1个扩展名称和@Activate注解缓存起来</span></span><br><span class="line">		    cachedActivates.put(names[<span class="number">0</span>], activate);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//遍历扩展名称</span></span><br><span class="line">		<span class="keyword">for</span> (String n : names) &#123;</span><br><span class="line">		    <span class="keyword">if</span> (!cachedNames.containsKey(clazz)) &#123;</span><br><span class="line">			<span class="comment">//如果&lt;扩展实现类,name&gt;缓存中不包含该扩展实现类,则保存到缓存</span></span><br><span class="line">			cachedNames.put(clazz, n);</span><br><span class="line">		    &#125;</span><br><span class="line">		    <span class="comment">//通过扩展名称n从扩展实现类集合中获取扩展实现类c</span></span><br><span class="line">		    Class&lt;?&gt; c = extensionClasses.get(n);</span><br><span class="line">		    <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="comment">//扩展实现类c不存在，则保存&lt;扩展名称n，扩展实现类clazz&gt;到缓存</span></span><br><span class="line">			extensionClasses.put(n, clazz);</span><br><span class="line">		    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c != clazz) &#123;</span><br><span class="line">			<span class="comment">//一个扩展名称对应多个扩展实现类，则抛异常</span></span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Duplicate extension "</span> + type.getName() + <span class="string">" name "</span> + n + <span class="string">" on "</span> + c.getName() + <span class="string">" and "</span> + clazz.getName());</span><br><span class="line">		    &#125;</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 检测扩展实例类clazz是否是包装类。</span></span><br><span class="line"><span class="comment"> * 判断依据是：扩展实现类clazz中有一个接收扩展接口(type接口)作为参数的构造方法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> clazz 扩展实现类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isWrapperClass</span><span class="params">(Class&lt;?&gt; clazz)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">	    clazz.getConstructor(type);</span><br><span class="line">	    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">	    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>加载扩展类型接口type对应的扩展实现类流程到此就全部结束了(即上文中介绍的getExtensionClasses()方法流程)。</p>
<h4 id="createExtension方法-创建扩展实现类实例"><a href="#createExtension方法-创建扩展实现类实例" class="headerlink" title="createExtension方法(创建扩展实现类实例)"></a>createExtension方法(创建扩展实现类实例)</h4><p>我们回到上文中遗留的createExtension(name)方法，看看是如何根据扩展名称name创建扩展实现类实例的。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据扩展名称name创建扩展实现类实例</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> name 扩展名称</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 扩展实现类实例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line"><span class="function"><span class="keyword">private</span> T <span class="title">createExtension</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//根据扩展名称name获取扩展实现类clazz</span></span><br><span class="line">	<span class="comment">//getExtensionClasses()方法我们上文已经介绍过了，拿到扩展类型接口type对应的所有扩展实现类</span></span><br><span class="line">	Class&lt;?&gt; clazz = getExtensionClasses().get(name);</span><br><span class="line">	<span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">	    <span class="comment">//根据扩展名称没有获取到扩展实现类，则抛出异常</span></span><br><span class="line">	    <span class="keyword">throw</span> findException(name);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">	    <span class="comment">//先从缓存中获取扩展实现类的实例</span></span><br><span class="line">	    T instance = (T) EXTENSION_INSTANCES.get(clazz);</span><br><span class="line">	    <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">	        <span class="comment">//如果没有获取到实例，则新建一个实现类clazz的实例并放入缓存。</span></span><br><span class="line">		EXTENSION_INSTANCES.putIfAbsent(clazz, clazz.newInstance());</span><br><span class="line">		instance = (T) EXTENSION_INSTANCES.get(clazz);</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="comment">//处理实现类实例的依赖注入(后面会分析该方法)</span></span><br><span class="line">	    injectExtension(instance);</span><br><span class="line">	    <span class="comment">//处理包装类</span></span><br><span class="line">	    Set&lt;Class&lt;?&gt;&gt; wrapperClasses = cachedWrapperClasses;</span><br><span class="line">	    <span class="keyword">if</span> (wrapperClasses != <span class="keyword">null</span> &amp;&amp; !wrapperClasses.isEmpty()) &#123;</span><br><span class="line">	        <span class="comment">//当前扩展接口type存在包装类扩展实现类</span></span><br><span class="line">		<span class="comment">//遍历包装类列表</span></span><br><span class="line">		<span class="keyword">for</span> (Class&lt;?&gt; wrapperClass : wrapperClasses) &#123;</span><br><span class="line">		    <span class="comment">//通过参数为type接口的构造方法创建包装类实例(将当前实例instance传递进去)，然后处理包装类的依赖注入</span></span><br><span class="line">		    <span class="comment">//这里可能会有多个包装类，依次进行包装</span></span><br><span class="line">		    instance = injectExtension((T) wrapperClass.getConstructor(type).newInstance(instance));</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="comment">//返回扩展实例</span></span><br><span class="line">	    <span class="keyword">return</span> instance;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">	    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Extension instance(name: "</span> + name + <span class="string">", class: "</span> +</span><br><span class="line">		    type + <span class="string">")  could not be instantiated: "</span> + t.getMessage(), t);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理扩展实现类实例instance的依赖项，进行依赖注入</span></span><br><span class="line"><span class="comment"> * 通过set方法注入依赖项</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> instance 扩展实现类的实例</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> T <span class="title">injectExtension</span><span class="params">(T instance)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">	    <span class="comment">//判断加载器是否为空</span></span><br><span class="line">	    <span class="keyword">if</span> (objectFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">	        <span class="comment">//遍历实现类中的方法</span></span><br><span class="line">		<span class="keyword">for</span> (Method method : instance.getClass().getMethods()) &#123;</span><br><span class="line">		    <span class="comment">//找到参数长度为1、public修饰符的set方法</span></span><br><span class="line">		    <span class="keyword">if</span> (method.getName().startsWith(<span class="string">"set"</span>)</span><br><span class="line">			    &amp;&amp; method.getParameterTypes().length == <span class="number">1</span></span><br><span class="line">			    &amp;&amp; Modifier.isPublic(method.getModifiers())) &#123;</span><br><span class="line">			<span class="comment">//获取set方法的参数类型</span></span><br><span class="line">			Class&lt;?&gt; pt = method.getParameterTypes()[<span class="number">0</span>];</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">			    <span class="comment">//截取set方法的方法名，去掉"set"字符，并将余下的字符转换成小写字母，作为属性</span></span><br><span class="line">			    String property = method.getName().length() &gt; <span class="number">3</span> ? method.getName().substring(<span class="number">3</span>, <span class="number">4</span>).toLowerCase() + method.getName().substring(<span class="number">4</span>) : <span class="string">""</span>;</span><br><span class="line">			    <span class="comment">//从扩展工厂中找到该依赖项实例(pt为依赖项的类型，property为依赖项的名称)</span></span><br><span class="line">			    Object object = objectFactory.getExtension(pt, property);</span><br><span class="line">			    <span class="keyword">if</span> (object != <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="comment">//依赖项实例存在的话，通过该set方法则将该依赖项实例注入到扩展实现类实例instance中</span></span><br><span class="line">				method.invoke(instance, object);</span><br><span class="line">			    &#125;</span><br><span class="line">			&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			    logger.error(<span class="string">"fail to inject via method "</span> + method.getName()</span><br><span class="line">				    + <span class="string">" of interface "</span> + type.getName() + <span class="string">": "</span> + e.getMessage(), e);</span><br><span class="line">			&#125;</span><br><span class="line">		    &#125;</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">	    logger.error(e.getMessage(), e);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//返回扩展实现类的实例</span></span><br><span class="line">	<span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以上便是获取扩展实例的过程，最终会将扩展实例放入到缓存变量cachedInstances中,即&lt;扩展名称，扩展实例&gt;。</p>
<h4 id="getActivateExtension方法"><a href="#getActivateExtension方法" class="headerlink" title="getActivateExtension方法"></a>getActivateExtension方法</h4><p>接下来我们在看下ExtensionLoader类中的getActivateExtension方法，通过该方法可以得到已启用的扩展列表<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * key为url中标识扩展名称的参数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;T&gt; <span class="title">getActivateExtension</span><span class="params">(URL url, String key)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//调用了下面的重载方法</span></span><br><span class="line">	<span class="keyword">return</span> getActivateExtension(url, key, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;T&gt; <span class="title">getActivateExtension</span><span class="params">(URL url, String key, String group)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//从url中获取参数key对应的值(即获取扩展名称)</span></span><br><span class="line">	String value = url.getParameter(key);</span><br><span class="line">	<span class="comment">//调用了下面的重载方法</span></span><br><span class="line">	<span class="keyword">return</span> getActivateExtension(</span><br><span class="line">		url, </span><br><span class="line">		value == <span class="keyword">null</span> || value.length() == <span class="number">0</span> ? <span class="keyword">null</span> : Constants.COMMA_SPLIT_PATTERN.split(value), </span><br><span class="line">		group</span><br><span class="line">	);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取已启用的扩展列表</span></span><br><span class="line"><span class="comment"> * url </span></span><br><span class="line"><span class="comment"> * values为扩展名称列表</span></span><br><span class="line"><span class="comment"> * group为配置的组</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;T&gt; <span class="title">getActivateExtension</span><span class="params">(URL url, String[] values, String group)</span> </span>&#123;</span><br><span class="line">	List&lt;T&gt; exts = <span class="keyword">new</span> ArrayList&lt;T&gt;();</span><br><span class="line">	<span class="comment">//扩展名称数组</span></span><br><span class="line">	List&lt;String&gt; names = values == <span class="keyword">null</span> ? <span class="keyword">new</span> ArrayList&lt;String&gt;(<span class="number">0</span>) : Arrays.asList(values);</span><br><span class="line">	<span class="comment">//names是否包含-default</span></span><br><span class="line">	<span class="keyword">if</span> (!names.contains(Constants.REMOVE_VALUE_PREFIX + Constants.DEFAULT_KEY)) &#123;</span><br><span class="line">	    <span class="comment">//先获取下扩展接口type的扩展实现类集合(上文介绍过该方法)</span></span><br><span class="line">	    <span class="comment">//执行getExtensionClasses方法时，会将存在@Activate注解的实现类缓存起来：&lt;扩展名称，Activate注解&gt;</span></span><br><span class="line">	    getExtensionClasses();</span><br><span class="line">	    <span class="comment">//遍历cachedActivates集合</span></span><br><span class="line">	    <span class="keyword">for</span> (Map.Entry&lt;String, Activate&gt; entry : cachedActivates.entrySet()) &#123;</span><br><span class="line">		<span class="comment">//扩展名称</span></span><br><span class="line">		String name = entry.getKey();</span><br><span class="line">		<span class="comment">//@Activate注解</span></span><br><span class="line">		Activate activate = entry.getValue();</span><br><span class="line">		<span class="comment">//group是否匹配(后面会分析该方法)</span></span><br><span class="line">		<span class="keyword">if</span> (isMatchGroup(group, activate.group())) &#123;</span><br><span class="line">		    <span class="comment">//根据扩展名称name获取扩展实例</span></span><br><span class="line">		    T ext = getExtension(name);</span><br><span class="line">		    <span class="keyword">if</span> (!names.contains(name)</span><br><span class="line">			    &amp;&amp; !names.contains(Constants.REMOVE_VALUE_PREFIX + name)</span><br><span class="line">			    &amp;&amp; isActive(activate, url)) &#123;</span><br><span class="line">			<span class="comment">//当扩展名称数组不包含该扩展名name，并且不包含-name，并且已激活时，</span></span><br><span class="line">			<span class="comment">//将当前扩展实例添加到返回结果集中</span></span><br><span class="line">			exts.add(ext);</span><br><span class="line">		    &#125;</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="comment">//按照配置的before()和after()/order()进行排序</span></span><br><span class="line">	    Collections.sort(exts, ActivateComparator.COMPARATOR);</span><br><span class="line">	&#125;</span><br><span class="line">	List&lt;T&gt; usrs = <span class="keyword">new</span> ArrayList&lt;T&gt;();</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; names.size(); i++) &#123;</span><br><span class="line">	    <span class="comment">//当前扩展名称name</span></span><br><span class="line">	    String name = names.get(i);</span><br><span class="line">	    <span class="keyword">if</span> (!name.startsWith(Constants.REMOVE_VALUE_PREFIX)</span><br><span class="line">		    <span class="comment">//当前扩展名称name不是以-开头，并且扩展名称数组names不包含-name时，</span></span><br><span class="line">		    &amp;&amp; !names.contains(Constants.REMOVE_VALUE_PREFIX + name)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (Constants.DEFAULT_KEY.equals(name)) &#123;</span><br><span class="line">		    <span class="comment">//当前扩展名称name=default</span></span><br><span class="line">		    <span class="keyword">if</span> (!usrs.isEmpty()) &#123;</span><br><span class="line">		        <span class="comment">//usrs不为空，将usrs集合添加到exts头部</span></span><br><span class="line">			exts.addAll(<span class="number">0</span>, usrs);</span><br><span class="line">			<span class="comment">//清空usrs</span></span><br><span class="line">			usrs.clear();</span><br><span class="line">		    &#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		    <span class="comment">//当前扩展名称name != default时，获取该name的扩展实例，并存起来</span></span><br><span class="line">		    T ext = getExtension(name);</span><br><span class="line">		    usrs.add(ext);</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!usrs.isEmpty()) &#123;</span><br><span class="line">	    exts.addAll(usrs);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> exts;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * group是否匹配</span></span><br><span class="line"><span class="comment"> * 1、group为空，则匹配</span></span><br><span class="line"><span class="comment"> * 2、group在groups中存在，则匹配</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> group</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> groups <span class="doctag">@Activate</span>中配置的group数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isMatchGroup</span><span class="params">(String group, String[] groups)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (group == <span class="keyword">null</span> || group.length() == <span class="number">0</span>) &#123;</span><br><span class="line">	    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (groups != <span class="keyword">null</span> &amp;&amp; groups.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">	    <span class="keyword">for</span> (String g : groups) &#123;</span><br><span class="line">		<span class="keyword">if</span> (group.equals(g)) &#123;</span><br><span class="line">		    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 是否已激活</span></span><br><span class="line"><span class="comment"> * 1、<span class="doctag">@activate</span>没有配置value()</span></span><br><span class="line"><span class="comment"> * 2、<span class="doctag">@Activate</span>中配置的value()在url的参数列表中存在,且url参数对应的value不为空</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> activate</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> url</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isActive</span><span class="params">(Activate activate, URL url)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取@Activate注解中配置的keys</span></span><br><span class="line">	String[] keys = activate.value();</span><br><span class="line">	<span class="keyword">if</span> (keys.length == <span class="number">0</span>) &#123;</span><br><span class="line">	    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (String key : keys) &#123;</span><br><span class="line">	    <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : url.getParameters().entrySet()) &#123;</span><br><span class="line">		String k = entry.getKey();</span><br><span class="line">		String v = entry.getValue();</span><br><span class="line">		<span class="keyword">if</span> ((k.equals(key) || k.endsWith(<span class="string">"."</span> + key))</span><br><span class="line">			&amp;&amp; ConfigUtils.isNotEmpty(v)) &#123;</span><br><span class="line">		    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="getAdaptiveExtension方法"><a href="#getAdaptiveExtension方法" class="headerlink" title="getAdaptiveExtension方法"></a>getAdaptiveExtension方法</h4><p>接下来看下getAdaptiveExtension方法，该方法用来获取扩展接口type对应的自适应扩展实例。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 缓存的自适应实例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Holder&lt;Object&gt; cachedAdaptiveInstance = <span class="keyword">new</span> Holder&lt;Object&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 记录创建自适应扩展实例时发生的异常</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> Throwable createAdaptiveInstanceError;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取扩展接口type的自适应扩展实例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">getAdaptiveExtension</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//先从缓存中获取</span></span><br><span class="line">	Object instance = cachedAdaptiveInstance.get();</span><br><span class="line">	<span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">	    <span class="comment">//缓存中不存在</span></span><br><span class="line">	    <span class="comment">//判断createAdaptiveInstanceError变量是否为空，不为空说明之前创建自适应实例时发生了异常</span></span><br><span class="line">	    <span class="keyword">if</span> (createAdaptiveInstanceError == <span class="keyword">null</span>) &#123;</span><br><span class="line">	        <span class="comment">//没有发生异常，同步创建自适应扩展实例</span></span><br><span class="line">		<span class="keyword">synchronized</span> (cachedAdaptiveInstance) &#123;</span><br><span class="line">		    <span class="comment">//再次验证缓存中是否存在该实例</span></span><br><span class="line">		    instance = cachedAdaptiveInstance.get();</span><br><span class="line">		    <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">			    <span class="comment">//创建自适应扩展实例(后面会分析该方法)</span></span><br><span class="line">			    instance = createAdaptiveExtension();</span><br><span class="line">			    <span class="comment">//将创建好的实例保存进缓存</span></span><br><span class="line">			    cachedAdaptiveInstance.set(instance);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">			    <span class="comment">//创建实例时发生异常，记录异常</span></span><br><span class="line">			    createAdaptiveInstanceError = t;</span><br><span class="line">			    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"fail to create adaptive instance: "</span> + t.toString(), t);</span><br><span class="line">			&#125;</span><br><span class="line">		    &#125;</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"fail to create adaptive instance: "</span> + createAdaptiveInstanceError.toString(), createAdaptiveInstanceError);</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> (T) instance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 为扩展接口type创建自适应扩展实例，并处理依赖注入</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> T <span class="title">createAdaptiveExtension</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">	    <span class="comment">//在这里调用了getAdaptiveExtensionClass方法获取到自适应扩展类，然后生成实例</span></span><br><span class="line">	    <span class="keyword">return</span> injectExtension((T) getAdaptiveExtensionClass().newInstance());</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">	    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Can not create adaptive extension "</span> + type + <span class="string">", cause: "</span> + e.getMessage(), e);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取扩展接口type的自适应扩展类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Class&lt;?&gt; getAdaptiveExtensionClass() &#123;</span><br><span class="line">        <span class="comment">//加载扩展接口type对应的所有扩展实现类(上文介绍过该方法)</span></span><br><span class="line">	getExtensionClasses();</span><br><span class="line">	<span class="comment">//查看缓存中是否已经存在扩展接口type对应的自适应扩展类，如果存在，则直接返回(调用getExtensionClasses方法时，会去设置cachedAdaptiveClass值)</span></span><br><span class="line">	<span class="keyword">if</span> (cachedAdaptiveClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">	    <span class="keyword">return</span> cachedAdaptiveClass;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//不存在的话，为该扩展接口type创建一个自适应扩展类(后面会分析该方法)</span></span><br><span class="line">	<span class="keyword">return</span> cachedAdaptiveClass = createAdaptiveExtensionClass();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 扩展接口type不存在自适应扩展类的时候，dubbo默认会为其创建</span></span><br><span class="line"><span class="comment"> * 创建条件：type接口的方法中必须有一个带<span class="doctag">@Adaptive</span>注解的方法dubbo才会创建自适应扩展类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Class&lt;?&gt; createAdaptiveExtensionClass() &#123;</span><br><span class="line">	<span class="comment">//生成自适应扩展实现类的代码(后面会分析该方法)</span></span><br><span class="line">	String code = createAdaptiveExtensionClassCode();</span><br><span class="line">	<span class="comment">//获取类加载器</span></span><br><span class="line">	ClassLoader classLoader = findClassLoader();</span><br><span class="line">	<span class="comment">//获取Compiler自适应扩展实例</span></span><br><span class="line">	com.alibaba.dubbo.common.compiler.Compiler compiler =</span><br><span class="line">		ExtensionLoader.getExtensionLoader(com.alibaba.dubbo.common.compiler.Compiler.class)</span><br><span class="line">			.getAdaptiveExtension();</span><br><span class="line">	<span class="comment">//编译code(后面会分析该方法)</span></span><br><span class="line">	<span class="keyword">return</span> compiler.compile(code, classLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接下来的createAdaptiveExtensionClassCode方法比较长，在分析之前，我们先来看下ProxyFactory接口，我们将使用该接口作为例子(即假设当前扩展接口type为ProxyFactory),配合着该方法一起看：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SPI</span>(<span class="string">"javassist"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ProxyFactory</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//@Adaptive(&#123;"proxy"&#125;)</span></span><br><span class="line">    <span class="meta">@Adaptive</span>(&#123;Constants.PROXY_KEY&#125;)</span><br><span class="line">    &lt;T&gt; <span class="function">T <span class="title">getProxy</span><span class="params">(Invoker&lt;T&gt; invoker)</span> <span class="keyword">throws</span> RpcException</span>;</span><br><span class="line">   </span><br><span class="line">    <span class="meta">@Adaptive</span>(&#123;Constants.PROXY_KEY&#125;)</span><br><span class="line">    &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">getInvoker</span><span class="params">(T proxy, Class&lt;T&gt; type, URL url)</span> <span class="keyword">throws</span> RpcException</span>;</span><br></pre></td></tr></table></figure></p>
<p>可以看到该接口上添加了@SPI(“javassist”)注解、接口方法上添加了@Adaptive({Constants.PROXY_KEY})</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 为扩展接口type生成自适应扩展类的类代码</span></span><br><span class="line"><span class="comment">* 假设 type = com.alibaba.dubbo.rpc.ProxyFactory</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">createAdaptiveExtensionClassCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	StringBuilder codeBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">	<span class="comment">//获取扩展接口type的方法列表，查看方法上是否存在@Adaptive注解，</span></span><br><span class="line">	<span class="comment">//如果不存在@Adaptive注解，则不用生成自适应扩展类</span></span><br><span class="line">	Method[] methods = type.getMethods();</span><br><span class="line">	<span class="keyword">boolean</span> hasAdaptiveAnnotation = <span class="keyword">false</span>;</span><br><span class="line">	<span class="keyword">for</span> (Method m : methods) &#123;</span><br><span class="line">	    <span class="keyword">if</span> (m.isAnnotationPresent(Adaptive.class)) &#123;</span><br><span class="line">		hasAdaptiveAnnotation = <span class="keyword">true</span>;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 不存在带有@Adaptive注解的方法，因此不需要生成自适应扩展类</span></span><br><span class="line">	<span class="keyword">if</span> (!hasAdaptiveAnnotation) &#123;</span><br><span class="line">	    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No adaptive method on extension "</span> + type.getName() + <span class="string">", refuse to create the adaptive class!"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//添加包声明：type扩展接口所在包包名</span></span><br><span class="line">	<span class="comment">//package com.alibaba.dubbo.rpc;</span></span><br><span class="line">	codeBuilder.append(<span class="string">"package "</span>).append(type.getPackage().getName()).append(<span class="string">";"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//import com.alibaba.dubbo.common.extension.ExtensionLoader;</span></span><br><span class="line">	codeBuilder.append(<span class="string">"\nimport "</span>).append(ExtensionLoader.class.getName()).append(<span class="string">";"</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//可以看到生成的实现类名称为ProxyFactory$Adaptive，实现了ProxyFactory接口</span></span><br><span class="line">	<span class="comment">//public class com.alibaba.dubbo.rpc.ProxyFactory$Adaptive implements com.alibaba.dubbo.rpc.ProxyFactory&#123;</span></span><br><span class="line">	codeBuilder.append(<span class="string">"\npublic class "</span>)</span><br><span class="line">		.append(type.getSimpleName())</span><br><span class="line">		.append(<span class="string">"$Adaptive"</span>)</span><br><span class="line">		.append(<span class="string">" implements "</span>)</span><br><span class="line">		.append(type.getCanonicalName()).append(<span class="string">" &#123;"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//遍历type接口的方法</span></span><br><span class="line">	<span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">	    <span class="comment">//接口方法返回类型</span></span><br><span class="line">	    Class&lt;?&gt; rt = method.getReturnType();</span><br><span class="line">	    <span class="comment">//接口方法参数类型数组</span></span><br><span class="line">	    Class&lt;?&gt;[] pts = method.getParameterTypes();</span><br><span class="line">	    <span class="comment">//接口方法异常类型数组</span></span><br><span class="line">	    Class&lt;?&gt;[] ets = method.getExceptionTypes();</span><br><span class="line">	   </span><br><span class="line">	    <span class="comment">//判断当前方法上是否存在@Adaptive注解</span></span><br><span class="line">	    Adaptive adaptiveAnnotation = method.getAnnotation(Adaptive.class);</span><br><span class="line">            <span class="comment">//方法内容</span></span><br><span class="line">	    StringBuilder code = <span class="keyword">new</span> StringBuilder(<span class="number">512</span>);</span><br><span class="line">	    <span class="keyword">if</span> (adaptiveAnnotation == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="comment">//添加异常：type接口的当前方法不是一个adaptive方法</span></span><br><span class="line">		code.append(<span class="string">"throw new UnsupportedOperationException(\"method "</span>)</span><br><span class="line">			.append(method.toString()).append(<span class="string">" of interface "</span>)</span><br><span class="line">			.append(type.getName()).append(<span class="string">" is not adaptive method!\");"</span>);</span><br><span class="line">	    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">//获取到的当前方法的"URL类型参数/返回URL类型的get方法的参数"的下标（在当前方法参数中的下标）</span></span><br><span class="line">		<span class="keyword">int</span> urlTypeIndex = -<span class="number">1</span>;</span><br><span class="line">		<span class="comment">//遍历当前方法参数</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pts.length; ++i) &#123;</span><br><span class="line">		    <span class="keyword">if</span> (pts[i].equals(URL.class)) &#123;</span><br><span class="line">		        <span class="comment">//第i个下标是URL类型的参数</span></span><br><span class="line">			urlTypeIndex = i;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		    &#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (urlTypeIndex != -<span class="number">1</span>) &#123;</span><br><span class="line">		    <span class="comment">//从当前方法参数中找到了URL类型的参数</span></span><br><span class="line">		    <span class="comment">//添加"校验Url类型参数是否为空"的code</span></span><br><span class="line">		    String s = String.format(<span class="string">"\nif (arg%d == null) throw new IllegalArgumentException(\"url == null\");"</span>,</span><br><span class="line">			    urlTypeIndex);</span><br><span class="line">		    code.append(s);</span><br><span class="line">		    </span><br><span class="line">		    <span class="comment">//添加"声明url类型的变量"的code</span></span><br><span class="line">		    <span class="comment">//URL url = arg&#123;$urlTypeIndex&#125;</span></span><br><span class="line">		    s = String.format(<span class="string">"\n%s url = arg%d;"</span>, URL.class.getName(), urlTypeIndex);</span><br><span class="line">		    code.append(s);</span><br><span class="line">		&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">		    <span class="comment">//从当前方法参数中没有找到URL类型的参数</span></span><br><span class="line">		    <span class="comment">//返回URL类型的get方法的名称</span></span><br><span class="line">		    String attribMethod = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">		    <span class="comment">//遍历参数列表，查询每个参数的方法列表，查找返回URL类型的get方法</span></span><br><span class="line">		    LBL_PTS:</span><br><span class="line">		    <span class="comment">//遍历当前方法参数</span></span><br><span class="line">		    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pts.length; ++i) &#123;</span><br><span class="line">			<span class="comment">//遍历方法第i个参数的所有方法</span></span><br><span class="line">			Method[] ms = pts[i].getMethods();</span><br><span class="line">			<span class="keyword">for</span> (Method m : ms) &#123;</span><br><span class="line">			    <span class="comment">//当前方法名</span></span><br><span class="line">			    String name = m.getName();</span><br><span class="line">			    <span class="comment">//当前方法没有参数，且返回值是URL类型，以get开头或者长度&gt;3,且是public修饰，没有static修饰</span></span><br><span class="line">			    <span class="keyword">if</span> ((name.startsWith(<span class="string">"get"</span>) || name.length() &gt; <span class="number">3</span>)</span><br><span class="line">				    &amp;&amp; Modifier.isPublic(m.getModifiers())</span><br><span class="line">				    &amp;&amp; !Modifier.isStatic(m.getModifiers())</span><br><span class="line">				    &amp;&amp; m.getParameterTypes().length == <span class="number">0</span></span><br><span class="line">				    &amp;&amp; m.getReturnType() == URL.class) &#123;</span><br><span class="line">				<span class="comment">//方法的第i个参数是"返回URL类型的get方法"</span></span><br><span class="line">				urlTypeIndex = i;</span><br><span class="line">				<span class="comment">//“返回URL类型的get方法的名称”</span></span><br><span class="line">				attribMethod = name;</span><br><span class="line">				<span class="comment">//跳转到LBL_PTS</span></span><br><span class="line">				<span class="keyword">break</span> LBL_PTS;</span><br><span class="line">			    &#125;</span><br><span class="line">			&#125;</span><br><span class="line">		    &#125;</span><br><span class="line">		    <span class="keyword">if</span> (attribMethod == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="comment">//没有找到返回URL类型的方法，抛异常</span></span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"fail to create adaptive class for interface "</span> + type.getName()</span><br><span class="line">				+ <span class="string">": not found url parameter or url attribute in parameters of method "</span> + method.getName());</span><br><span class="line">		    &#125;</span><br><span class="line">			</span><br><span class="line">		    <span class="comment">//添加“方法第urlTypeIndex个参数为空的判断”</span></span><br><span class="line">		    String s = String.format(<span class="string">"\nif (arg%d == null) throw new IllegalArgumentException(\"%s argument == null\");"</span>,</span><br><span class="line">			    urlTypeIndex, pts[urlTypeIndex].getName());</span><br><span class="line">		    code.append(s);</span><br><span class="line">			</span><br><span class="line">		    <span class="comment">//添加“方法第urlTypeIndex个参数的attribMethod方法的返回值为空的判断”</span></span><br><span class="line">		    s = String.format(<span class="string">"\nif (arg%d.%s() == null) throw new IllegalArgumentException(\"%s argument %s() == null\");"</span>,</span><br><span class="line">			    urlTypeIndex, attribMethod, pts[urlTypeIndex].getName(), attribMethod);</span><br><span class="line">		    code.append(s);</span><br><span class="line"></span><br><span class="line">		    <span class="comment">//添加：com.alibaba.dubbo.common.URL url = arg&#123;$urlTypeIndex&#125;.attribMethod();</span></span><br><span class="line">		    s = String.format(<span class="string">"%s url = arg%d.%s();"</span>, URL.class.getName(), urlTypeIndex, attribMethod);</span><br><span class="line">		    code.append(s);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//@Adaptive注解的value值</span></span><br><span class="line">		String[] value = adaptiveAnnotation.value();</span><br><span class="line">		<span class="keyword">if</span> (value.length == <span class="number">0</span>) &#123;</span><br><span class="line">		    <span class="comment">//没有设置value，则根据扩展接口名称按照一定规则生成value</span></span><br><span class="line">		    <span class="comment">//如：ProxyFactory 将生成value：proxy.factory</span></span><br><span class="line">		    <span class="comment">//则charArray = [P,r,o,x,y,F,a,c,t,o,r,y]</span></span><br><span class="line">		    <span class="keyword">char</span>[] charArray = type.getSimpleName().toCharArray();</span><br><span class="line">		    StringBuilder sb = <span class="keyword">new</span> StringBuilder(<span class="number">128</span>);</span><br><span class="line">		    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; charArray.length; i++) &#123;</span><br><span class="line">			<span class="keyword">if</span> (Character.isUpperCase(charArray[i])) &#123;</span><br><span class="line">			    <span class="comment">//当前字符是大写的</span></span><br><span class="line">			    <span class="keyword">if</span> (i != <span class="number">0</span>) &#123;</span><br><span class="line">			        <span class="comment">//当前字符不是第1个字符，则添加“.”到sb中</span></span><br><span class="line">				sb.append(<span class="string">"."</span>);</span><br><span class="line">			    &#125;</span><br><span class="line">			    <span class="comment">//将当前字符转为小写，并添加到sb中</span></span><br><span class="line">			    sb.append(Character.toLowerCase(charArray[i]));</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			    <span class="comment">//当前字符是小写的，直接添加到sb中</span></span><br><span class="line">			    sb.append(charArray[i]);</span><br><span class="line">			&#125;</span><br><span class="line">		    &#125;</span><br><span class="line">		    <span class="comment">//生成的value = [&#123;"proxy.factory"&#125;]</span></span><br><span class="line">		    value = <span class="keyword">new</span> String[]&#123;sb.toString()&#125;;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//当前方法中是否存在Invocation类型的参数</span></span><br><span class="line">		<span class="keyword">boolean</span> hasInvocation = <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pts.length; ++i) &#123;</span><br><span class="line">		    <span class="comment">//当前方法的第i个参数名称是否为“com.alibaba.dubbo.rpc.Invocation”</span></span><br><span class="line">		    <span class="keyword">if</span> (pts[i].getName().equals(<span class="string">"com.alibaba.dubbo.rpc.Invocation"</span>)) &#123;</span><br><span class="line">			<span class="comment">//添加"校验参数Invocation是否为空"的code</span></span><br><span class="line">			String s = String.format(<span class="string">"\nif (arg%d == null) throw new IllegalArgumentException(\"invocation == null\");"</span>, i);</span><br><span class="line">			code.append(s);</span><br><span class="line">			<span class="comment">//添加"获取方法名"的code</span></span><br><span class="line">			s = String.format(<span class="string">"\nString methodName = arg%d.getMethodName();"</span>, i);</span><br><span class="line">			code.append(s);</span><br><span class="line">			<span class="comment">//标识 存在Invocation类型的参数</span></span><br><span class="line">			hasInvocation = <span class="keyword">true</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		    &#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//@SPI注解上配置的值，默认扩展名称</span></span><br><span class="line">		String defaultExtName = cachedDefaultName;</span><br><span class="line">		String getNameCode = <span class="keyword">null</span>;</span><br><span class="line">		<span class="comment">//遍历@Adaptive注解的value数组</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = value.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">		    <span class="keyword">if</span> (i == value.length - <span class="number">1</span>) &#123;</span><br><span class="line">		        <span class="comment">//当前i为value的最后1个元素</span></span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">null</span> != defaultExtName) &#123;</span><br><span class="line">			    <span class="comment">//默认扩展名称不为空，如果没有获取到值，则会使用默认值</span></span><br><span class="line">			    <span class="comment">//第i个元素是否等于protocol</span></span><br><span class="line">			    <span class="keyword">if</span> (!<span class="string">"protocol"</span>.equals(value[i])) &#123;</span><br><span class="line">				<span class="keyword">if</span> (hasInvocation) &#123;</span><br><span class="line">				    <span class="comment">//存在Invocation类型的参数</span></span><br><span class="line">				    <span class="comment">//调用url的getMethodParameter方法，获取value[i]对应的扩展名，如果为空，则取默认扩展名defaultExtName</span></span><br><span class="line">				    getNameCode = String.format(<span class="string">"url.getMethodParameter(methodName, \"%s\", \"%s\")"</span>, value[i], defaultExtName);</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				    <span class="comment">//不存在Invocation类型的参数</span></span><br><span class="line">				    <span class="comment">//从url的value[i]参数中(当前例子为proxy)获取扩展名，如果没有获取到，则使用默认扩展名javassist</span></span><br><span class="line">				    <span class="comment">//url.getParameter("proxy","javassist")</span></span><br><span class="line">				    getNameCode = String.format(<span class="string">"url.getParameter(\"%s\", \"%s\")"</span>, value[i], defaultExtName);</span><br><span class="line">				&#125;</span><br><span class="line">			    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			        <span class="comment">//第i个元素等于protocol</span></span><br><span class="line">				<span class="comment">//从url中获取protocol属性值，如果没有获取到，则使用默认扩展名defaultExtName</span></span><br><span class="line">				getNameCode = String.format(<span class="string">"( url.getProtocol() == null ? \"%s\" : url.getProtocol() )"</span>, defaultExtName);</span><br><span class="line">			    &#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			    <span class="comment">//默认扩展名称为空，如果没有获取到值，则不会使用默认值</span></span><br><span class="line">			    <span class="keyword">if</span> (!<span class="string">"protocol"</span>.equals(value[i])) &#123;</span><br><span class="line">				<span class="keyword">if</span> (hasInvocation) &#123;</span><br><span class="line">				    getNameCode = String.format(<span class="string">"url.getMethodParameter(methodName, \"%s\", \"%s\")"</span>, value[i], defaultExtName);</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				    <span class="comment">//从url中获取参数value[i]对应的值</span></span><br><span class="line">				    getNameCode = String.format(<span class="string">"url.getParameter(\"%s\")"</span>, value[i]);</span><br><span class="line">				&#125;</span><br><span class="line">			    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			        <span class="comment">//从url中获取protocol属性值</span></span><br><span class="line">				getNameCode = <span class="string">"url.getProtocol()"</span>;</span><br><span class="line">			    &#125;</span><br><span class="line">			&#125;</span><br><span class="line">		    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		        <span class="comment">//当前第i个元素不是value最后一个元素</span></span><br><span class="line">			<span class="keyword">if</span> (!<span class="string">"protocol"</span>.equals(value[i])) &#123;</span><br><span class="line">			    <span class="keyword">if</span> (hasInvocation) &#123;</span><br><span class="line">				getNameCode = String.format(<span class="string">"url.getMethodParameter(methodName, \"%s\", \"%s\")"</span>, value[i], defaultExtName);</span><br><span class="line">			    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				getNameCode = String.format(<span class="string">"url.getParameter(\"%s\", %s)"</span>, value[i], getNameCode);</span><br><span class="line">			    &#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			    getNameCode = String.format(<span class="string">"url.getProtocol() == null ? (%s) : url.getProtocol()"</span>, getNameCode);</span><br><span class="line">			&#125;</span><br><span class="line">		    &#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//添加：String extName = url.getParameter("proxy", "javassist");</span></span><br><span class="line">		<span class="comment">//获取扩展名</span></span><br><span class="line">		code.append(<span class="string">"\nString extName = "</span>).append(getNameCode).append(<span class="string">";"</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//添加“校验扩展名不为空”的code</span></span><br><span class="line">		String s = String.format(<span class="string">"\nif(extName == null) "</span> +</span><br><span class="line">				<span class="string">"throw new IllegalStateException(\"Fail to get extension(%s) name from url(\" + url.toString() + \") use keys(%s)\");"</span>,</span><br><span class="line">			type.getName(), Arrays.toString(value));</span><br><span class="line">		code.append(s);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//添加"根据扩展名获取扩展实例"的code</span></span><br><span class="line">		<span class="comment">//com.alibaba.dubbo.rpc.ProxyFactory extension = (com.alibaba.dubbo.rpc.ProxyFactory)ExtensionLoader.getExtensionLoader(com.alibaba.dubbo.rpc.ProxyFactory.class).getExtension(extName) ;</span></span><br><span class="line">		s = String.format(<span class="string">"\n%s extension = (%&lt;s)%s.getExtensionLoader(%s.class).getExtension(extName);"</span>,</span><br><span class="line">			type.getName(), ExtensionLoader.class.getSimpleName(), type.getName());</span><br><span class="line">		code.append(s);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//处理返回值</span></span><br><span class="line">		<span class="keyword">if</span> (!rt.equals(<span class="keyword">void</span>.class)) &#123;</span><br><span class="line">		    <span class="comment">//返回值不是void类型</span></span><br><span class="line">		    code.append(<span class="string">"\nreturn "</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//例如：return extension.getInvoker(arg0);</span></span><br><span class="line">		<span class="comment">//这里的逻辑就是：根据扩展名称的不同获取相应的扩展实现，然后调用方法，并返回</span></span><br><span class="line">		s = String.format(<span class="string">"extension.%s("</span>, method.getName());</span><br><span class="line">		<span class="comment">//先填写调用信息</span></span><br><span class="line">		code.append(s);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//遍历当前方法参数，添加方法参数</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pts.length; i++) &#123;</span><br><span class="line">		    <span class="keyword">if</span> (i != <span class="number">0</span>) &#123;</span><br><span class="line">			code.append(<span class="string">", "</span>);</span><br><span class="line">		    &#125;</span><br><span class="line">		    code.append(<span class="string">"arg"</span>).append(i);</span><br><span class="line">		&#125;</span><br><span class="line">		code.append(<span class="string">");"</span>);</span><br><span class="line">	    &#125;</span><br><span class="line"></span><br><span class="line">	    <span class="comment">//生成方法签名code</span></span><br><span class="line">	    <span class="comment">//如：public java.lang.Object getProxy(com.alibaba.dubbo.rpc.Invoker arg0) throws com.alibaba.dubbo.rpc.RpcException</span></span><br><span class="line">	    codeBuilder.append(<span class="string">"\npublic "</span>)</span><br><span class="line">		    .append(rt.getCanonicalName())</span><br><span class="line">		    .append(<span class="string">" "</span>)</span><br><span class="line">		    .append(method.getName())</span><br><span class="line">		    .append(<span class="string">"("</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//添加参数</span></span><br><span class="line">	    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pts.length; i++) &#123;</span><br><span class="line">		<span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		    codeBuilder.append(<span class="string">", "</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		codeBuilder.append(pts[i].getCanonicalName());</span><br><span class="line">		codeBuilder.append(<span class="string">" "</span>);</span><br><span class="line">		codeBuilder.append(<span class="string">"arg"</span>).append(i);</span><br><span class="line">	    &#125;</span><br><span class="line">	    codeBuilder.append(<span class="string">")"</span>);</span><br><span class="line"></span><br><span class="line">	    <span class="comment">//添加异常</span></span><br><span class="line">	    <span class="keyword">if</span> (ets.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		codeBuilder.append(<span class="string">" throws "</span>);</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ets.length; i++) &#123;</span><br><span class="line">		    <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			codeBuilder.append(<span class="string">", "</span>);</span><br><span class="line">		    &#125;</span><br><span class="line">		    codeBuilder.append(ets[i].getCanonicalName());</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125;</span><br><span class="line">	   </span><br><span class="line">	    codeBuilder.append(<span class="string">" &#123;"</span>);</span><br><span class="line">	     <span class="comment">//将方法code添加到方法代码块中</span></span><br><span class="line">	    codeBuilder.append(code.toString());</span><br><span class="line">	    codeBuilder.append(<span class="string">"\n&#125;"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	codeBuilder.append(<span class="string">"\n&#125;"</span>);</span><br><span class="line">	<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">	    logger.debug(codeBuilder.toString());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//返回生产的code</span></span><br><span class="line">	<span class="keyword">return</span> codeBuilder.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以type = com.alibaba.dubbo.rpc.ProxyFactory为例子，生成的代码大概如下所示:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.alibaba.dubbo.rpc;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.common.extension.ExtensionLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyFactory</span>$<span class="title">Adaptive</span> <span class="keyword">implements</span> <span class="title">com</span>.<span class="title">alibaba</span>.<span class="title">dubbo</span>.<span class="title">rpc</span>.<span class="title">ProxyFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> java.lang.<span class="function">Object <span class="title">getProxy</span><span class="params">(com.alibaba.dubbo.rpc.Invoker arg0)</span> <span class="keyword">throws</span> com.alibaba.dubbo.rpc.RpcException </span>&#123;</span><br><span class="line">	 <span class="keyword">if</span> (arg0 == <span class="keyword">null</span>)&#123;</span><br><span class="line">	    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"com.alibaba.dubbo.rpc.Invoker argument == null"</span>);</span><br><span class="line">	 &#125;</span><br><span class="line">	 <span class="keyword">if</span> (arg0.getUrl() == <span class="keyword">null</span>) &#123;</span><br><span class="line">	    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"com.alibaba.dubbo.rpc.Invoker argument getUrl() == null"</span>);</span><br><span class="line">	 &#125;</span><br><span class="line">	 com.alibaba.dubbo.common.URL url = arg0.getUrl();</span><br><span class="line">	 String extName = url.getParameter(<span class="string">"proxy"</span>, <span class="string">"javassist"</span>);</span><br><span class="line">	 <span class="keyword">if</span>(extName == <span class="keyword">null</span>) &#123;</span><br><span class="line">	    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Fail to get extension(com.alibaba.dubbo.rpc.ProxyFactory) name from url("</span> + url.toString() + <span class="string">") use keys([proxy])"</span>);</span><br><span class="line">	 &#125;</span><br><span class="line">	 com.alibaba.dubbo.rpc.ProxyFactory extension = (com.alibaba.dubbo.rpc.ProxyFactory)ExtensionLoader.getExtensionLoader(com.alibaba.dubbo.rpc.ProxyFactory.class).getExtension(extName);</span><br><span class="line">	 <span class="keyword">return</span> extension.getProxy(arg0);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> com.alibaba.dubbo.rpc.<span class="function">Invoker <span class="title">getInvoker</span><span class="params">(java.lang.Object arg0, java.lang.Class arg1, com.alibaba.dubbo.common.URL arg2)</span> <span class="keyword">throws</span> com.alibaba.dubbo.rpc.RpcException </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (arg2 == <span class="keyword">null</span>) &#123;</span><br><span class="line">	    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"url == null"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	com.alibaba.dubbo.common.URL url = arg2;</span><br><span class="line">	String extName = url.getParameter(<span class="string">"proxy"</span>, <span class="string">"javassist"</span>);</span><br><span class="line">	<span class="keyword">if</span>(extName == <span class="keyword">null</span>)&#123;</span><br><span class="line">	    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Fail to get extension(com.alibaba.dubbo.rpc.ProxyFactory) name from url("</span> + url.toString() + <span class="string">") use keys([proxy])"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	com.alibaba.dubbo.rpc.ProxyFactory extension = (com.alibaba.dubbo.rpc.ProxyFactory)ExtensionLoader.getExtensionLoader(com.alibaba.dubbo.rpc.ProxyFactory.class).getExtension(extName);</span><br><span class="line">	<span class="keyword">return</span> extension.getInvoker(arg0, arg1, arg2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以上就是生成自适应实现类的全部内容，生成好代码后，会交由Compiler扩展进行编译得到Class对象，然后在本小节开头介绍的createAdaptiveExtension()方法中进行实例化，并进行依赖注入。<br>本文内容过多，Compiler编译的部分就放到后面的博文中在介绍了。另外ExtensionLoader类中也提供了很多辅助方法，内容比较简单，在这里就不详细介绍了。</p>
<h3 id="ExtensionFactory工厂实现"><a href="#ExtensionFactory工厂实现" class="headerlink" title="ExtensionFactory工厂实现"></a>ExtensionFactory工厂实现</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@SPI</span><br><span class="line">public interface ExtensionFactory &#123;</span><br><span class="line">    /**</span><br><span class="line">     * 获取扩展实现类实例</span><br><span class="line">     * Get extension.</span><br><span class="line">     * @param type object type. 扩展接口类型</span><br><span class="line">     * @param name object name. 扩展名称</span><br><span class="line">     * @return object instance. 返回扩展实例</span><br><span class="line">     */</span><br><span class="line">    &lt;T&gt; T getExtension(Class&lt;T&gt; type, String name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该接口根据扩展类型和扩展名称获取扩展实例。可以看到该接口声明上也加上了@SPI注解，说明存在多种实现，Dubbo提供了三种实现，分别为AdaptiveExtensionFactory、SpiExtensionFactory、SpringExtensionFactory.</p>
<h4 id="SpringExtensionFactory"><a href="#SpringExtensionFactory" class="headerlink" title="SpringExtensionFactory"></a>SpringExtensionFactory</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringExtensionFactory</span> <span class="keyword">implements</span> <span class="title">ExtensionFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存所有的ApplicationContext上下文对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;ApplicationContext&gt; contexts = <span class="keyword">new</span> ConcurrentHashSet&lt;ApplicationContext&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加ApplicationContext</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addApplicationContext</span><span class="params">(ApplicationContext context)</span> </span>&#123;</span><br><span class="line">        contexts.add(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 移除ApplicationContext</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">removeApplicationContext</span><span class="params">(ApplicationContext context)</span> </span>&#123;</span><br><span class="line">        contexts.remove(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getExtension</span><span class="params">(Class&lt;T&gt; type, String name)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//遍历所有的context</span></span><br><span class="line">        <span class="keyword">for</span> (ApplicationContext context : contexts) &#123;</span><br><span class="line">            <span class="comment">//判断该context上下文是否包含此bean</span></span><br><span class="line">            <span class="keyword">if</span> (context.containsBean(name)) &#123;</span><br><span class="line">                <span class="comment">//根据名称获取context中的bean</span></span><br><span class="line">                Object bean = context.getBean(name);</span><br><span class="line">                <span class="comment">//判断该bean是否是type类型的实例，如果是的话，则返回该bean</span></span><br><span class="line">                <span class="keyword">if</span> (type.isInstance(bean)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> (T) bean;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="SpiExtensionFactory"><a href="#SpiExtensionFactory" class="headerlink" title="SpiExtensionFactory"></a>SpiExtensionFactory</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpiExtensionFactory</span> <span class="keyword">implements</span> <span class="title">ExtensionFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getExtension</span><span class="params">(Class&lt;T&gt; type, String name)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//判断类型type是否是接口，并且存在@SPI注解</span></span><br><span class="line">        <span class="keyword">if</span> (type.isInterface() &amp;&amp; type.isAnnotationPresent(SPI.class)) &#123;</span><br><span class="line">            <span class="comment">//获取扩展接口type的扩展加载器</span></span><br><span class="line">            ExtensionLoader&lt;T&gt; loader = ExtensionLoader.getExtensionLoader(type);</span><br><span class="line">	    <span class="comment">//通过扩展加载器获取接口type支持的所有扩展的名称列表</span></span><br><span class="line">            <span class="keyword">if</span> (!loader.getSupportedExtensions().isEmpty()) &#123;</span><br><span class="line">                <span class="comment">//返回自适应扩展实例</span></span><br><span class="line">                <span class="keyword">return</span> loader.getAdaptiveExtension();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="AdaptiveExtensionFactory"><a href="#AdaptiveExtensionFactory" class="headerlink" title="AdaptiveExtensionFactory"></a>AdaptiveExtensionFactory</h4><p>该ExtensionFactory实现存在@Adaptive注解，因此它是自适应实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Adaptive</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdaptiveExtensionFactory</span> <span class="keyword">implements</span> <span class="title">ExtensionFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ExtensionFactory扩展实现类实例集合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;ExtensionFactory&gt; factories;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AdaptiveExtensionFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取ExtensionFactory.class对应的扩展加载器</span></span><br><span class="line">        ExtensionLoader&lt;ExtensionFactory&gt; loader = ExtensionLoader.getExtensionLoader(ExtensionFactory.class);</span><br><span class="line">        </span><br><span class="line">        List&lt;ExtensionFactory&gt; list = <span class="keyword">new</span> ArrayList&lt;ExtensionFactory&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//遍历扩展接口ExtensionFactory支持的扩展名称列表(spi、spring)</span></span><br><span class="line">        <span class="keyword">for</span> (String name : loader.getSupportedExtensions()) &#123;</span><br><span class="line">            <span class="comment">//根据扩展名称name加载扩展实现类实例</span></span><br><span class="line">            list.add(loader.getExtension(name));</span><br><span class="line">        &#125;</span><br><span class="line">        factories = Collections.unmodifiableList(list);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自适应的扩展工厂，挨个遍历spring和spi，从中查询指定类型的实例</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type object type. 扩展接口类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name object name. 扩展名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getExtension</span><span class="params">(Class&lt;T&gt; type, String name)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//遍历ExtensionFactory实现类集合，从中挨个查找指定类型的扩展</span></span><br><span class="line">        <span class="keyword">for</span> (ExtensionFactory factory : factories) &#123;</span><br><span class="line">            <span class="comment">//获取type类型的扩展实例</span></span><br><span class="line">            T extension = factory.getExtension(type, name);</span><br><span class="line">            <span class="keyword">if</span> (extension != <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="comment">//实例不为空，返回实例 </span></span><br><span class="line">               <span class="keyword">return</span> extension;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到此，关于SPI的实现就全部介绍完了，下一小节将会介绍和Sping集成相关的内容。</p>

        
            <div class="donate-container">
    <div class="donate-button">
        <button id="donate-button">赞赏</button>
    </div>
    <div class="donate-img-container hide" id="donate-img-container">
        <img id="donate-img" src="" data-src="/blog/img/pay.png">
        <p> thank you </p>
    </div>
</div>
        
        <div id="comment-container">
        </div>
    </div>
</div>
    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <span>/</span>
        
        <span><a href="https://medium.com/netflix-techblog">Netflix</a></span>
        <span>/</span>
        
        <span><a href="https://engineering.linkedin.com/blog">Linkedin</a></span>
        <span>/</span>
        
        <span><a href="https://blogs.dropbox.com/tech/">Dropbox</a></span>
        <span>/</span>
        
        <span><a href="https://code.fb.com/">Facebook</a></span>
        <span>/</span>
        
        <span><a href="https://www.fpcomplete.com/blog">FPComplete</a></span>
        <span>/</span>
        
        <span><a href="https://blog.janestreet.com/">JaneStreet</a></span>
        <span>/</span>
        
        <span><a href="https://github.com/limengyu1990/">Github</a></span>
        <span>/</span>
        
        <span><a href="https://serokell.io/blog">serokell</a></span>
        <span>/</span>
        
    </p>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/blog/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/blog/js/index.js"></script>
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<!--create by tea9-->

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
    <script>
        var gitalk = new Gitalk({
          clientID: '7cfc73dd62b57f07ed83',
          clientSecret: 'dd03b7e54aadf0d81e4c9c93e23a41272bcfcfa1',
          repo: 'blog',
          owner: 'limengyu1990',
          admin: 'limengyu1990',
          id: location.pathname,      // Ensure uniqueness and length less than 50
          distractionFreeMode: false  // Facebook-like distraction free mode
        })
        gitalk.render('comment-container')
    </script>

<!--end-->


</html>
