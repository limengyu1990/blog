[{"title":"Lambdaæ¼”ç®—","url":"/blog/2019/09/28/Lambdaæ¼”ç®—/","content":"> èªè¨€æ˜¯äººé¡ç†æ€§çš„å·¥å…·ï¼Œè€Œä¸åƒ…åƒ…æ˜¯è¡¨é”æ€æƒ³çš„åª’ä»‹ï¼Œé€™æ˜¯å…¬èªçš„çœŸç†ã€‚ --- George Boole\n> http://dev.stephendiehl.com/fun/003_lambda_calculus.html\n\n## Lambdaæ¼”ç®—\næ‰€æœ‰å‡½æ•¸å¼èªè¨€çš„åŸºç¤éƒ½æ˜¯åŸå­çš„çµ„åˆæ¦‚å¿µï¼Œå³å–®å€‹è®Šé‡çš„å‡½æ•¸æŠ½è±¡ã€‚`Lambda`æ¼”ç®—éå¸¸ç°¡å–®çš„ç”±ä¸‰å€‹é …åŠå…¶æ‰€æœ‰æœ‰æ•ˆçš„éæ­¸çµ„åˆçµ„æˆã€‚\n![](img/img01.png)\n\né€™å€‹ç·Šæ¹Šçš„ç¬¦è™Ÿçœ‹èµ·ä¾†èˆ‡æ‚¨åœ¨`Haskell`ä¸­ä½¿ç”¨çš„ç¬¦è™Ÿç•¥æœ‰ä¸åŒï¼Œä½†å¯¦éš›ä¸Šæ²’æœ‰: `Î»x.xa`ç­‰åŒæ–¼`\\x -> x a`ã€‚é€™æ„å‘³è‘—æ‚¨åœ¨ä¸Šåœ–ä¸­çœ‹åˆ°çš„å…§å®¹å°‡è½‰æ›ç‚º`(\\x -> x) (\\y -> y)`ï¼Œé€™ç­‰åŒæ–¼`id id`ï¼ˆç•¶ç„¶ï¼Œå…¶çµæœç‚º`id`ï¼‰ã€‚\n\né€™ä¸‰å€‹è¡“èªé€šå¸¸åœ¨ä»£ç¢¼ä¸­é€šéå®ƒå€‘åç¨±çš„å¹¾å€‹ç¸®å¯«ä¾†è¡¨ç¤º:\n* **Var** - æ¨™è­˜ä¸€å€‹è®Šé‡\n* **Lam** - æ¨™è­˜ä¸€å€‹lambdaæŠ½è±¡\n* **App** - æ¨™è­˜ä¸€å€‹æ‡‰ç”¨\n\nä¸€å€‹lambdaé …è¢«ç¨±ç‚ºç¶å®šå®ƒçš„è®Šé‡ã€‚ä¾‹å¦‚é€™è£çš„`lambda`ç¶å®š`x`ï¼Œåœ¨æ•¸å­¸ä¸­æˆ‘å€‘é€šå¸¸æœƒé€™éº¼å¯«:\n```\nf(x) = e\n```\n\nä½¿ç”¨lambdaæ¼”ç®—ç¬¦è™Ÿï¼Œæˆ‘å€‘å¯«ç‚º:\n```\nf = Î»x.e\n```\næ›å¥è©±èª¬ï¼Œ`Î»x.e`æ˜¯ä¸€å€‹æ¥æ”¶è®Šé‡`x`ï¼Œè¿”å›`e`çš„å‡½æ•¸.\n```\ne := x      (Var)\n     Î»x.e   (Lam)\n     e e    (App)\n```\n`lambda`æ¼”ç®—é€šå¸¸è¢«ç¨±ç‚ºå‡½æ•¸å¼ç·¨ç¨‹çš„\"åŒ¯ç·¨èªè¨€\"ï¼Œå®ƒçš„è®Šé«”å’Œæ“´å±•æ§‹æˆäº†è¨±å¤šå‡½æ•¸ç·¨è­¯å™¨ä¸­é–“å½¢å¼çš„åŸºç¤ï¼Œé€™äº›ä¸­é–“å½¢å¼é©ç”¨æ–¼`Haskell/Ocaml/StandardML`ç­‰èªè¨€ã€‚\n\næˆ‘å€‘é¦–å…ˆè¨è«–çš„è®Šé«”ç¨±ç‚º`ç„¡é¡å‹çš„Lambdaæ¼”ç®—`ï¼Œç›¸æ¯”ä¹‹ä¸‹ï¼Œç¨å¾Œæˆ‘å€‘å°‡è¨è«–`é¡å‹åŒ–çš„Lambdaæ¼”ç®—`ï¼Œå®ƒæ˜¯å…¶æ“´å±•ã€‚\n\nç·¨å¯«`Lambda`è¡¨é”å¼æ™‚ï¼Œæˆ‘å€‘å°‡æ¡ç”¨æ©Ÿç¨®èªæ³•ç´„å®šã€‚å¤šå€‹è¡¨é”å¼çš„`App`åŸ·è¡Œå·¦é—œè¯:\n```\nx1 x2 x3 ...Xn = (...((x1x2)x3)...Xn)\n```\næŒ‰ç…§æ…£ä¾‹ï¼Œ`App`åœ¨èªæ³•ä¸Šç›¡å¯èƒ½å‘å³æ“´å±•ï¼Œæ‹¬è™Ÿç”¨æ–¼æ¶ˆé™¤æ­§ç•°ã€‚\n\nåœ¨`Lambda`æ¼”ç®—ä¸­ï¼Œæ¯å€‹`Lambda`æŠ½è±¡ç¶å®šä¸€å€‹è®Šé‡ï¼Œè€Œ`lambda`æŠ½è±¡çš„ä¸»é«”å¯èƒ½æ˜¯å¦ä¸€å€‹`lambda`æŠ½è±¡ï¼Œç‚ºäº†æ–¹ä¾¿ï¼Œæˆ‘å€‘ç¶“å¸¸åœ¨ä¸€å€‹ç¬¦è™Ÿä¸Šå¯«å¤šå€‹`lambda`æŠ½è±¡åŠå…¶è®Šé‡ã€‚é€™åªæ˜¯ä¸€ç¨®èªæ³•ç´„å®šï¼Œä¸¦ä¸æœƒæ”¹è®Šå…¶åŸºæœ¬å«ç¾©ã€‚\n```\nÎ»xy.z = Î»x.Î»y.z\n```\n`lambda`æ¼”ç®—çš„å¯¦éš›å¯¦ç¾å…è¨±åœ¨è¡¨ç¤º`lambda`æŠ½è±¡æ–¹é¢æœ‰å¹¾å€‹è‡ªç”±åº¦ã€‚\næœ€å€¼å¾—æ³¨æ„çš„æ˜¯ç‚ºç¶å®šè®Šé‡é¸æ“‡æ¨™è­˜ç¬¦ã€‚\n\nå¦‚æœä¸€å€‹è®Šé‡åŒ…å«åœ¨åŒä¸€å€‹è®Šé‡ç¶å®šçš„`lambda`è¡¨é”å¼ä¸­ï¼Œå‰‡ç¨±è©²è®Šé‡`bound`(ç¯„åœå…§çš„)ã€‚ç›¸åï¼Œå¦‚æœè®Šé‡æ²’æœ‰`bound`(ä¸åœ¨ç¯„åœå…§)ï¼Œå‰‡ç¨±å®ƒæ˜¯`free`(è‡ªç”±)çš„ã€‚\næœ‰`free`è®Šé‡çš„é …ç¨±ç‚º`open term`(é–‹é …)ï¼Œè€Œæ²’æœ‰`free`è®Šé‡çš„é …ç¨±ç‚º`closed`(é–‰é …)æˆ–`combinator`(çµ„åˆå­)ã€‚\n\n![](img/img02.png)\n\n`e0`æ˜¯ä¸€å€‹`combinator`ï¼Œè€Œ`e1`ä¸æ˜¯ã€‚\nåœ¨`e1`ä¸­å‡ºç¾çš„å…©æ¬¡`x`ï¼Œéƒ½æ˜¯`bound`çš„ï¼Œç¬¬ä¸€å€‹`y`ä¹Ÿæ˜¯`bound`çš„ï¼Œè€Œç¬¬äºŒå€‹`y`æ˜¯`free`çš„ã€‚`a`ä¹Ÿæ˜¯`free`çš„ã€‚\n\nå¤šå€‹`lambda`æŠ½è±¡å¯ä»¥ç¶å®šç›¸åŒçš„è®Šé‡åç¨±ï¼Œç„¶å¾Œï¼Œæ¯æ¬¡å‡ºç¾çš„è®Šé‡éƒ½ç”±æœ€è¿‘çš„`enclosing binder`(å°é–‰ç¶å®šå™¨)ä¾†`bound`(é™å®šå®ƒçš„ç¯„åœ)ã€‚\nä¾‹å¦‚: ä»¥ä¸‹è¡¨é”å¼ä¸­çš„`x`è®Šé‡`bound`(é™å®š)åœ¨å…§éƒ¨çš„`lambda`ä¸Šï¼Œè€Œ`y`è®Šé‡`bound`(é™å®š)åœ¨å¤–éƒ¨`lambda`ä¸Šã€‚é€™ç¨®ç¾è±¡ç¨±ç‚º`name shadowing`(åç¨±é™°å½±)ã€‚\n```\nÎ»xy.(Î»xz.x + y)\n```\n\n### SKI Combinators\næœ‰ä¸‰å€‹åŸºæœ¬çš„`closed`è¡¨é”å¼ï¼Œç¨±ç‚º`SKI`çµ„åˆå™¨ã€‚\n![](img/img03.png)\n\nåœ¨`Haskell`ä¸­ï¼Œå®ƒå€‘è¢«å¯«åš:\n```\ns f g x = f x (g x)\nk x y = x\ni x = x\n```\nç›¸ç•¶å¼•äººæ³¨ç›®çš„`Moses Schonfinkel`è¡¨æ˜: æ‰€æœ‰çš„`closed lambda`è¡¨é”å¼éƒ½å¯ä»¥åƒ…ç”¨`S`å’Œ`K`çµ„åˆå­è¡¨ç¤º(ç”šè‡³æ˜¯`I`çµ„åˆå­)ã€‚\nä¾‹å¦‚ï¼Œæˆ‘å€‘å¯ä»¥å¾ˆå®¹æ˜“çš„è­‰æ˜`SKK`å¯ä»¥ç°¡åŒ–ç‚º`I`.\n![](img/img04.png)\n\nåœ¨æµ‹è¯•`lambda`æ¼”ç®—çš„å®ç°æ—¶ï¼Œè¿™æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„å®Œæ•´æ€§æ£€æŸ¥ã€‚\n\n### Implementation(å¯¦ç¾)\nå…·æœ‰å‘½åç¶å®šçš„`lambda`æ¼”ç®—èªæ³• æœ€ç°¡å–®çš„å¯¦ç¾æ˜¯ä½¿ç”¨ä»¥ä¸‹å®šç¾©:\n```\ntype Name = String\n\ndata Expr\n  = Var Name\n  | App Expr Expr\n  | Lam Name Expr\n```\n\n`lambda`è¡¨é”å¼æœ‰æ©Ÿç¨®è©æ³•èªæ³•é¸æ“‡ï¼Œæˆ‘å€‘å°‡ç°¡å–®çš„é¸æ“‡`Haskell`ç´„å®š, å®ƒä»¥åæ–œæ§“(`\\`)åˆ°å…·æœ‰(`->`)çš„ä¸»é«”è¡¨ç¤º`lambda`ï¼Œå¹¶ä»¥ç©ºæ ¼è¡¨ç¤º`App`ã€‚å‘½åè®Šé‡åªæ˜¯å­—æ¯æ•¸å­—å­—ç¬¦åºåˆ—ã€‚\n\n* ***Logical notation***: `ğšŒğš˜ğš—ğšœğš = Î»xy.x`\n* ***Haskell notation***: `const = \\x y -> x`\n\næ­¤å¤–ï¼Œå¯ä»¥æ·»åŠ å…¶ä»–è¡“èªï¼Œå¦‚æ–‡å­—æ•¸å­—æˆ–å¸ƒçˆ¾å€¼ï¼Œé€™ä½¿ç·¨å¯«èªªæ˜æ€§ç¤ºä¾‹æ›´åŠ å®¹æ˜“ï¼Œå°æ–¼é€™äº›ï¼Œæˆ‘å€‘å°‡æ·»åŠ ä¸€å€‹`Lit`æ§‹é€ å‡½æ•¸ã€‚\n\n```\ndata Expr\n  = ...\n  | Lit Lit\n\ndata Lit\n  = LInt Int\n  | LBool Bool\n```\n\n### Substitution(æ›¿æ›)\n`lambda`é …`(((xx.e)a))`çš„è©•ä¼°é€šéç”¨åƒæ•¸`a`æ›¿æ›`e`ä¸­æ‰€æœ‰è‡ªç”±å‡ºç¾çš„è®Šé‡`x`ä¾†é€²è¡Œã€‚\nä¸€å€‹å–®å€‹çš„æ›¿æ›æ­¥é©Ÿè¢«ç¨±ç‚º`reduction`(æ¸›å°‘/ç´„ç°¡)ã€‚\n\næˆ‘å€‘å°‡æ›¿æ›`application`æ”¾åœ¨è¦æ‡‰ç”¨çš„è¡¨é”å¼ä¹‹å‰çš„æ–¹æ‹¬è™Ÿä¸­ï¼Œ\n`[x/a]e`å°†å˜é‡`x`æ˜ å°„åˆ°è¡¨è¾¾å¼`e`ä¸Šçš„æ–°æ›¿æ¢`a`ã€‚\n```\n(Î»x.e)a â†’ [x/a]e\n```\nä¸€å€‹æ›¿æ›å…ƒè®Šé‡è¢«å¯«ä½œ`[s]`.\nè©³ç´°çš„æ›¿æ›å®šç¾©å¦‚ä¸‹:\n![](img/img05.png)\n\n`fv(e)`æ˜¯`e`ä¸­çš„è‡ªç”±è®Šé‡é›†.\n\nä½¿ç”¨æœ¬åœ°å‘½åçš„ç¶å®šå™¨çš„æ ¹æœ¬å•é¡Œæ˜¯åç¨±æ•ç²çš„å•é¡Œï¼Œæˆ–è€…å¦‚ä½•è™•ç†æ›¿æ›èˆ‡è‡ªç”±è®Šé‡çš„åç¨±è¡çªçš„æƒ…æ³ã€‚æˆ‘å€‘éœ€è¦åœ¨æœ€å¾Œä¸€ç¨®æƒ…æ³ä¸‹ä½¿ç”¨è©²æ¢ä»¶ï¼Œä»¥é¿å…å°‡`y`é‡å¯«ç‚º`x`æ™‚æœƒå¾æ ¹æœ¬ä¸Šæ”¹è®Šä»¥ä¸‹è¡¨é”å¼å«ç¾©çš„å¹¼ç¨šæ›¿æ›ã€‚\n```\n[y/x](Î»x.xy) â†’ Î»x.xx\n```\næŒ‰ç…§æ…£ä¾‹ï¼Œæˆ‘å€‘ç¸½æ˜¯ä½¿ç”¨`capture-avoiding`(é¿å…æ•ç²)æ›¿æ›ï¼Œåªæœ‰ç•¶è®Šé‡ä¸åœ¨è¡¨é”å¼çš„è‡ªç”±è®Šé‡é›†åˆä¸­æ™‚ï¼Œæ›¿æ›æ‰æœƒç¹¼çºŒé€²è¡Œï¼Œå¦‚æœè®Šé‡ä¸åœ¨è¡¨é”å¼çš„è‡ªç”±è®Šé‡é›†åˆä¸­ï¼Œå‰‡æœƒåœ¨å…¶ä½ç½®ä¸Šå‰µå»ºä¸€å€‹æ–°çš„è®Šé‡ã€‚\n```\n(Î»x.e)a â†’ [x/a]e   if x âˆ‰ ğšğšŸ(a)\n```\næœ‰å¹¾å€‹ç¶å®šåº«å’Œ`lambda`æ¼”ç®—èªæ³•çš„æ›¿ä»£å¯¦ç¾å¯ä»¥é¿å…é€™äº›å•é¡Œï¼Œé€™æ˜¯ä¸€å€‹éå¸¸å¸¸è¦‹çš„å•é¡Œï¼Œå³ä½¿æ˜¯å°ˆå®¶ä¹Ÿå¾ˆå®¹æ˜“åŸ·è¡ŒéŒ¯èª¤ã€‚\n```\n### free occurance demo\n(Î»x. x) y  =  y\n(Î»x. f x x) y  =  f y y\n(Î»x. f x x) (g y)  =  f (g y) (g y)\n\n(Î»x. Î»z. f x z) (g y)  =  Î»z. f (g y) z\n\n(Î»x. Î»z. f (Î»x. g x) z) (g y)  =  Î»z. f (Î»x. g x) z\n\n### è¿™æ˜¯ä¸€ä¸ªæ›´æ£˜æ‰‹çš„ç¤ºä¾‹\n### åœ¨æ‰§è¡Œ(é¿å…æ•è·)æ›¿æ¢ä¹‹å‰ï¼Œéœ€è¦alphaè½¬æ¢(ç»‘å®šå˜é‡çš„é‡å‘½å)\n### ç­”æ¡ˆÎ»z. f (Î»y. f (g y) y) (g y)æ˜¯éŒ¯èª¤çš„\n### å› ç‚ºÎ»y. f ..y..ä¸­çš„yå’Œg yä¸­çš„yä¸æ˜¯ä¸€å€‹ç›¸åŒçš„çš„y)\n(Î»x. Î»z. f (Î»y. f x y) x) (g y)  =  (Î»x. Î»z. f (Î»t. f x t) x) (g y)  =  Î»z. f (Î»t. f (g y) t) (g y)\n```\n\n### Conversion and Equivalences(è½‰æ›å’Œç›¸ç­‰é—œä¿‚)\n\n#### Alpha(Î±)ç­‰åƒ¹\n\n![](img/img06.png)\n\nAlphaç­‰ä»·æ˜¯ä¸€ç§å±æ€§ï¼ˆå½“ä½¿ç”¨å‘½åçš„æ´»é¡µå¤¹æ—¶ï¼‰ï¼Œæ›´æ”¹æ´»é¡µå¤¹ä¸Šä»¥åŠæ•´ä¸ªè¡¨è¾¾å¼ä¸»ä½“ä¸­çš„å˜é‡ä¸åº”æ›´æ”¹æ•´ä¸ªè¡¨è¾¾å¼çš„åŸºæœ¬å«ä¹‰ã€‚ å› æ­¤ï¼Œä¾‹å¦‚ï¼Œä»¥ä¸‹æ˜¯ç­‰æ•ˆçš„å­—æ¯ã€‚\n`Alpha`ç­‰åƒ¹æ˜¯ä¸€ç¨®å±¬æ€§(ç•¶ä½¿ç”¨`named binders`å‘½åç¶å®šå™¨æ™‚),æ›´æ”¹ç¶å®šå™¨ä¸Šä»¥åŠæ•´å€‹è¡¨é”å¼ä¸»é«”ä¸­çš„è®Šé‡ä¸æ‡‰è©²æ›´å€‹æ•´å€‹è¡¨é”å¼çš„åŸºæœ¬å«ç¾©ï¼Œå› æ­¤ï¼Œå¦‚ä¸‹æ˜¯`Alpha`ç­‰åƒ¹:\n\n![](img/img07.png)\n\n##### Beta-reductionæ­¸ç´„(Î²)\n\n`Beta`æ­¸ç´„åƒ…æ˜¯ä¸€å€‹ç°¡å–®çš„æ›¿æ›æ­¥é©Ÿï¼Œå³åœ¨æ•´å€‹è¡¨é”å¼ä¸»é«”ä¸­ç”¨`lambda`çš„åƒæ•¸æ›¿æ›ç”±`lambda`è¡¨é”å¼ç¶å®šçš„è®Šé‡ã€‚\n\n![](img/img08.png)\n\n\n#### Eta-reductionæ­¸ç´„(Î·)\n\n![](img/img09.png)\n\né€™å¯ä»¥é€šéå¦‚ä¸‹äº‹å¯¦è­‰æ˜ï¼Œå¦‚æœæˆ‘å€‘æŠŠå…©é‚Šéƒ½æ‡‰ç”¨åˆ°ä¸€å€‹`term`(é …)ä¸Š,ä¸€å€‹`Beta`æ­¸ç´„çš„æ­¥é©ŸæœƒæŠŠå·¦é‚Šè®Šæˆå³é‚Šã€‚\n\n![](img/img10.png)\n\n\n#### Eta-expansion(å±•é–‹)\n\nèˆ‡`Eta-reduction`ç›¸åçš„æ˜¯`eta-expansion`,å®ƒæ¡ç”¨ä¸€å€‹ä¸é£½å’Œçš„å‡½æ•¸ä¸¦ä½¿æ‰€æœ‰è®Šé‡é¡¯å¼ç¶å®šåœ¨`lambda`ä¸­ï¼Œç•¶æˆ‘å€‘è¨è«–ç¿»è­¯æˆ`STG`æ™‚ï¼Œ`Eta-expansion`å°‡æœƒå¾ˆé‡è¦ã€‚\n\n### Reduction\n`Î»`æ¼”ç®—è¡¨é”å¼çš„è©•ä¼°é€šé`Beta-reduction`é€²è¡Œã€‚`lambda`ä¸­ç¶å®šçš„è®Šé‡å°‡åœ¨`lambda`çš„ä¸»é«”ä¸­æ›¿æ›ã€‚\n\nåœ¨è¨­è¨ˆç©ºé–“ä¸­ï¼Œé—œæ–¼å¦‚ä½•åšåˆ°é€™ä¸€é»ï¼Œä»¥åŠè¡¨é”å¼çš„è¨ˆç®—é †åºï¼Œæœ‰å¹¾å€‹è‡ªç”±åº¦ã€‚\nä¾‹å¦‚ï¼Œæˆ‘å€‘å¯ä»¥åœ¨`lambda`ä¸‹æ±‚å€¼ï¼Œç„¶å¾Œå°‡è®Šé‡ä»£å…¥å…¶ä¸­ï¼Œæˆ–è€…å–è€Œä»£ä¹‹çš„æ˜¯å°åƒæ•¸æ±‚å€¼ï¼Œç„¶å¾Œæ›¿æ›ä¸¦æ¸›å°‘`lambda`è¡¨é”å¼ã€‚\næœ‰é—œæ›´å¤šä¿¡æ¯ï¼Œæˆ‘å€‘å°‡åœ¨è©•ä¼°æ¨¡å‹éƒ¨åˆ†ä¸­é€²è¡Œè¨è«–ã€‚\n```\nUntyped> (\\x.x) 1\n1\n\nUntyped> (\\x y . y) 1 2\n2\n\nUntyped> (\\x y z. x z (y z)) (\\x y . x) (\\x y . x)\n  => \\x y z . (x z (y z))\n  => \\y z . ((\\x y . x) z (y z))\n    => \\x y . x\n    => \\y . z\n   => z\n => \\z . z\n\\z . z\n```\nè«‹æ³¨æ„ï¼Œæœ€å¾Œä¸€æ¬¡è©•ä¼°æ˜¯æˆ‘å€‘å…ˆå‰é‡åˆ°çš„`SKK`ã€‚\n\nåœ¨ç„¡é¡å‹çš„`lambda`æ¼”ç®—ä¸­ï¼Œæˆ‘å€‘å¯ä»¥è‡ªç”±çš„è¡¨ç¤ºç„¡é™ç™¼æ•£çš„è¡¨é”å¼:\n```\nUntyped> \\f . (f (\\x . (f x x)) (\\x . (f x x)))\n\\f . (f (\\x . (f x x)) (\\x . (f x x)))\n\nUntyped> (\\f . (\\x. (f x x)) (\\x. (f x x))) (\\f x . f f)\n...\n\nUntyped> (\\x. x x) (\\x. x x)\n...\n```\n### Let\né™¤äº†`App`ä»¥å¤–ï¼Œé€šå¸¸å°‡ç¨±ç‚º`Let`ç¶å®šçš„æ§‹é€ å™¨æ·»åŠ åˆ°`lambda`æ¼”ç®—èªæ³•ä¸­ã€‚åœ¨ç„¡é¡å‹çš„`lambda`æ¼”ç®—ä¸­ï¼Œ`let`ç¶å®šåœ¨èªç¾©ä¸Šç­‰åŒæ–¼æ‡‰ç”¨çš„`lambda`è¡¨é”å¼ã€‚\n```\nğš•ğšğš a = e ğš’ğš— b   :=   (Î»a.b)e\n```\nåœ¨æˆ‘å€‘çš„èªè¨€ä¸­ï¼Œæˆ‘å€‘å°‡åƒåœ¨`Haskell`ä¸­ä¸€æ¨£ç·¨å¯«`let`èªå¥ã€‚\n`Toplevel`è¡¨é”å¼å°‡è¢«ç·¨å¯«ç‚º`let`èªå¥ï¼Œæ²’æœ‰ä¸€å€‹ä¸»é«”ä¾†è¡¨ç¤ºå®ƒå€‘è¢«æ·»åŠ åˆ°å…¨å±€ç¯„åœã€‚\n`Haskell`èªè¨€ä¸ä½¿ç”¨é€™å€‹ç´„å®šï¼Œä½†æ˜¯`Ocaml`å’Œ`StandardML`ä½¿ç”¨é€™å€‹ç´„å®šã€‚åœ¨`Haskell`ä¸­ï¼Œå¯¹äº`toplevel`å£°æ˜ï¼Œå‰é¢çš„`let`è¢«ç®€å•åœ°çœç•¥ã€‚\n```\nlet S f g x = f x (g x);\nlet K x y = x;\nlet I x = x;\n\nlet skk = S K K;\n```\nç›®å‰ï¼Œ`let`çš„è©•ä¼°è¦å‰‡èˆ‡æ‰€æ‡‰ç”¨çš„`lambda`ç›¸åŒ.\n![](img/img11.png)\nåœ¨å¾Œä¾†çš„`lambda`æ¼”ç®—è®Šé«”ä¸­ï¼Œè¡¨é”å¼å°‡å…·æœ‰ä¸åŒçš„èªç¾©ï¼Œä¸¦ä¸”å°‡æ–¼æ‡‰ç”¨çš„`lambda`è¡¨é”å¼ä¸åŒã€‚é—œæ–¼é€™ä¸€é»çš„æ›´å¤šä¿¡æ¯å°‡åœ¨`Hindley-Milner`æ¨ç†éƒ¨åˆ†ä¸­é€²è¡Œè¨è«–ã€‚\n\n### Everything Can Be a Î» term(ä¸€åˆ‡éƒ½å¯ä»¥æˆä¸ºÎ»é¡¹)\n**0**\n\n**1**\n\n**2**\n\n**succ**\n\n**pred**\n\n**not**\n\n**and**\n\n**or**\n\n**add**\n\n**mul**\n\n### Recursion(éæ­¸)\nå¯èƒ½æœ€è‘—åçš„çµ„åˆå™¨æ˜¯`Curry`çš„`Y`çµ„åˆå™¨ï¼Œåœ¨ç„¡é¡å‹çš„`Î»`æ¼”ç®—ä¸­ï¼Œ`Y`å¯ç”¨æ–¼å…è¨±è¡¨é”å¼åŒ…å«å°è‡ªèº«çš„å¼•ç”¨ï¼Œä»¥åŠ`reduce`(æ­¸ç´„/æ¸›å°‘)å°è‡ªèº«çš„å¼•ç”¨ï¼Œå¾è€Œå…è¨±éæ­¸å’Œå¾ªç’°é‚è¼¯ã€‚\n`Y`çµ„åˆå™¨æ˜¯è¨±å¤šæ‰€è¬‚çš„å®šé»çµ„åˆå™¨ä¹‹ä¸€ã€‚\n![](img/img12.png)\n\n`Y`åœ¨çµ¦å®š`R`çš„æƒ…æ³ä¸‹éå¸¸ç‰¹æ®Šï¼Œå®ƒè¿”å›`R`çš„å›ºå®šé»ã€‚\n\n![](img/img13.png)\n\nä¾‹å¦‚ï¼Œéšä¹˜å‡½æ•¸å¯ä»¥æ ¹æ“šè‡ªèº«å°å®šé»çš„é‡è¤‡æ‡‰ç”¨ä¾†éæ­¸å®šç¾©ï¼Œç›´åˆ°åŸºæœ¬æƒ…æ³ç‚º0!ã€‚\n\n![](img/img14.png)\n\nè™•æ–¼æ¨‚è¶£ï¼Œå¯ä»¥è­‰æ˜`Y`çµ„åˆå™¨å¯ä»¥ç”¨`S`å’Œ`K`çµ„åˆå™¨ä¾†è¡¨ç¤ºã€‚\n![](img/img15.png)\n\nåœ¨æ²’æœ‰é¡¯å¼å®šé»æˆ–éæ­¸`let`ç¶å®šçš„ç„¡é¡å‹`lambda`æ¼”ç®—èªè¨€ä¸­ï¼Œ`Y`çµ„åˆå™¨å¯ä»¥åƒ…ä½¿ç”¨`lambda`è¡¨é”å¼å‰µå»ºé€™å…©å€‹çµæ§‹ã€‚\nä½†æ˜¯ï¼Œæ›´å¸¸è¦‹çš„æ˜¯åœ¨è¡“èªèªæ³•ä¸­åƒ…æ·»åŠ åŸå­å®šé»é‹ç®—ç¬¦æˆ–éæ­¸`let`ä½œç‚ºåŸºæœ¬æ§‹é€ ã€‚\n![](img/img16.png)\n\n`fix`å…·æœ‰è©•ä¼°è¦å‰‡:\n\n![](img/img17.png)\n\nèˆ‡`fixpoint`(å®šé»)(æˆ–`Y`çµ„åˆå™¨)ä¸€èµ·ï¼Œæˆ‘å€‘å¯ä»¥å‰µå»º`let`ç¶å®šï¼Œé€™äº›ç¶å®šåœ¨ç¶å®šè¡¨é”å¼çš„ä¸»é«”å…§åŒ…å«å°è‡ªèº«çš„å¼•ç”¨ã€‚æˆ‘å€‘å°‡é€™äº›éæ­¸`let`ç¶å®šç¨±ç‚º`ML`æ–¹è¨€ä¸­çš„`let rec`.\nç›®å‰ï¼Œæˆ‘å€‘å°‡å¯¦ç¾éæ­¸`let`ä½œç‚ºç°¡å–®çš„èªæ³•ç³–ï¼Œä¸¦é€šéä»¥ä¸‹ç­‰æ•ˆæ€§å°‡å®šé»åŒ…è£¹åœ¨`lambda`ç¶å®šå‘¨åœã€‚\n```\nlet rec x = e1 in e2    =    let x = fix (\\x. e1) in e2\n```\nå› æ­¤ï¼Œç¾åœ¨æˆ‘å€‘å¯ä»¥å¯«ä¸‹æ¯å€‹å‡½æ•¸å¼ç¨‹åºå“¡æœ€å–œæ­¡çš„å…©å€‹å‡½æ•¸:`factorial`(éšä¹˜)å’Œ`fibonacci`(æ–æ³¢é‚£å¥‘)ã€‚\n\nç‚ºäº†é¡¯ç¤ºå…©ç¨®é¢¨æ ¼æ¨£å¼ï¼Œä¸€ç¨®ä½¿ç”¨`let rec`ç·¨å¯«ï¼Œå¦ä¸€ç¨®ä½¿ç”¨é¡¯å¼`fix`ç·¨å¯«ã€‚\n```\nlet fact = fix (\\fact -> \\n ->\n  if (n == 0)\n    then 1\n    else (n * (fact (n-1))));\n\n\nlet rec fib n =\n  if (n == 0)\n  then 0\n  else if (n==1)\n  then 1\n  else ((fib (n-1)) + (fib (n-2)));\n```\n\n#### Omega Combinator\næˆ‘å€‘å°‡æ¸¬è©¦çš„ä¸€å€‹é‡è¦çš„é€€åŒ–æ¡ˆä¾‹æ˜¯`omega`çµ„åˆå™¨ï¼Œè©²çµ„åˆå™¨å°å…¶è‡ªèº«æ‡‰ç”¨äº†ä¸€å€‹åƒæ•¸ã€‚\n```\nÏ‰ = Î»x.xx\n```\nç•¶æˆ‘å€‘å°‡`Ï‰`çµ„åˆå™¨æ‡‰ç”¨èˆ‡è‡ªèº«æ™‚ï¼Œæˆ‘å€‘ç™¼ç¾é€™æœƒå°è‡´ç„¡é™é•·çš„é‡è¤‡`reductions`éˆ.\n\næ²’æœ‰æ­£å¸¸å½¢å¼çš„`reductions`åºåˆ—è¢«ç¨±ç‚º`diverge`(ç™¼æ•£)\n\n![](img/img18.png)\n\næˆ‘å€‘å°‡æ­¤è¡¨é”å¼ç¨±ç‚º`Î©`çµ„åˆå™¨ã€‚å®ƒæ˜¯`Î»`æ¼”ç®—ä¸­çš„è¦ç¯„å¾ªç’°`term`(é …)ã€‚\nç›¸ç•¶å¤šçš„éœæ…‹é¡å‹ç³»çµ±æœƒæ‹’çµ•ä½¿ç”¨é€™å€‹è¡“èªï¼Œå› æ­¤å®ƒæ˜¯ä¸€å€‹éå¸¸æœ‰ç”¨çš„æ¸¬è©¦å·¥å…·ã€‚\n\n\n![](img/img19.png)\n\n\n\n### Pretty Printing\n`Hackage`æä¾›äº†è¨±å¤šæ¼‚äº®çš„æ‰“å°åº«ï¼Œé€™äº›åº«ç°¡åŒ–äº†ç‚ºæˆ‘å€‘çš„æ•¸æ“šé¡å‹è½‰å„²æ–‡æœ¬å½¢å¼çš„éç¨‹ã€‚å„˜ç®¡åº«ä¹‹é–“å­˜åœ¨ä¸€äº›å·®ç•°ï¼Œä½†å¤§å¤šæ•¸åº«éƒ½ä½¿ç”¨åŒä¸€çµ„çµ„åˆå™¨ã€‚æˆ‘å€‘å°‡ä½¿ç”¨`Hackage`ä¸Šçš„`pretty`åŒ…ä¸­çš„`Text.PrettyPrint`æ¨¡å¡Šã€‚æˆ‘å€‘å¤§å¤šæ•¸æ¼‚äº®çš„æ‰“å°éƒ½æ˜¯ä¸å¯é¿å…çš„æ¨£æ¿ï¼Œä½†æ˜¯æœƒä½¿å…§éƒ¨ç‹€æ…‹çš„èª¿é©æ›´åŠ å®¹æ˜“ã€‚\n\n```\n\t    Combinators\n<>\t    Concatenation\n<+>\t    Spaced concatenation\nchar\tRenders a character as a Doc\ntext\tRenders a string as a Doc\nhsep\tHorizontally concatenates a list of Doc\nvcat\tVertically joins a list of Doc with newlines\n```\næ¼‚äº®æ‰“å°çš„æ ¸å¿ƒé¡å‹æ˜¯`Doc`é¡å‹ï¼Œå³æ–‡æª”çš„æŠ½è±¡é¡å‹ã€‚é€™ç¨®é¡å‹çš„çµ„åˆå™¨å°‡æ“ç¸±æ­¤æ–‡æª”çš„å…§éƒ¨çµæ§‹ï¼Œç„¶å¾Œæœ€çµ‚ä½¿ç”¨`render`å‡½æ•¸å°‡å…¶å…§éƒ¨åŒ–ç‚ºç‰©ç†å­—ç¬¦ä¸²ã€‚ç”±æ–¼æˆ‘å€‘æ‰“ç®—åœ¨å¤šç¨®é¡å‹ä¹‹é–“é€²è¡Œæ¼‚äº®æ‰“å°ï¼Œå› æ­¤æˆ‘å€‘å°‡å‰µå»ºä¸€å€‹æ¼‚äº®é¡å‹é¡ã€‚\n```\nmodule Pretty where\n\nimport Text.PrettyPrint\n\nclass Pretty p where\n  ppr :: Int -> p -> Doc\n\n  pp :: p -> Doc\n  pp = ppr 0\n```\né¦–å…ˆï¼Œæˆ‘å€‘å‰µå»ºå…©å€‹è¼”åŠ©å‡½æ•¸ä¾†æŠ˜ç–Šæˆ‘å€‘çš„`lambda`ç¶å®šï¼Œä»¥ä¾¿æˆ‘å€‘å¯ä»¥å°‡å®ƒå€‘æ‰“å°ç‚ºå–®å€‹çš„`lambda`è¡¨é”å¼ã€‚\n```\nviewVars :: Expr -> [Name]\nviewVars (Lam n a) = n : viewVars a\nviewVars _ = []\n\nviewBody :: Expr -> Expr\nviewBody (Lam _ a) = viewBody a\nviewBody x = x\n```\nç„¶å¾Œï¼Œæˆ‘å€‘å‰µå»ºä¸€å€‹ç”¨æ–¼å°å­è¡¨é”å¼åŠ æ‹¬è™Ÿçš„è¼”åŠ©å‡½æ•¸ã€‚\n```\nparensIf ::  Bool -> Doc -> Doc\nparensIf True = parens\nparensIf False = id\n```\næœ€å¾Œï¼Œæˆ‘å€‘å®šç¾©`ppr`ï¼Œè®Šé‡`p`å°‡æŒ‡ç¤ºæˆ‘å€‘åœ¨ç•¶å‰æ­£åœ¨æ‰“å°çš„çµæ§‹ä¸­çš„æ·±åº¦ã€‚ä¸¦å…è¨±æˆ‘å€‘é€²è¡Œä¸åŒçš„æ‰“å°ï¼Œä»¥åœ¨å¿…è¦æ™‚å°‡å…¶èˆ‡å‘¨åœç’°å¢ƒé€²è¡Œå€åˆ†ã€‚\n```\ninstance Pretty Expr where\n  ppr p e = case e of\n    Lit (LInt a)  -> text (show a)\n    Lit (LBool b) -> text (show b)\n    Var x   -> text x\n    App a b -> parensIf (p>0) $ (ppr (p+1) a) <+> (ppr p b)\n    Lam x a -> parensIf (p>0) $\n         char '\\\\'\n      <> hsep (fmap pp (viewVars e))\n      <+> \"->\"\n      <+> ppr (p+1) (viewBody e)\n\nppexpr :: Expr -> String\nppexpr = render . ppr 0\n```","tags":["Î»"]},{"title":"Hindley-Milneræ¨è®º","url":"/blog/2019/09/18/Hindley-Milneræ¨è®º/","content":"\n> [http://dev.stephendiehl.com/fun/006_hindley_milner.html]\n### HMç±»å‹ç³»ç»Ÿ\nè¾›å¾·é›·-ç±³å°”çº³ç±»å‹ç³»ç»Ÿ(ä¹Ÿç§°ä¸º`Damas-Hindley-Milner`æˆ–`HM`)æ˜¯ä¸€ç»„ç±»å‹ç³»ç»Ÿ,å®ƒä»¬æ‰¿è®¤æœ‰ä¸€ä¸ªå¯å¤„ç†çš„ç®—æ³•å¯ä»¥ä»éç±»å‹åŒ–è¯­æ³•ç¡®å®šç±»å‹,è¿™æ˜¯ä¸€ä¸ªå¶ç„¶çš„ç‰¹æ€§ã€‚\nè¿™æ˜¯é€šè¿‡ä¸€ä¸ªç§°ä¸º`unification`(ç»Ÿä¸€)çš„è¿‡ç¨‹æ¥å®ç°çš„,åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­,ä¸€ä¸ªç»“æ„è‰¯å¥½çš„ç¨‹åºçš„ç±»å‹ä¼šäº§ç”Ÿä¸€ç»„çº¦æŸ,å½“è§£å†³è¿™äº›çº¦æŸæ—¶,æ€»æ˜¯æœ‰ä¸€ä¸ªæƒŸä¸€çš„ä¸»ä½“ç±»å‹ã€‚\n\næœ€ç®€å•çš„`Hindley Milner`ç±»å‹ç³»ç»Ÿç”±ä¸€ç»„éå¸¸çŸ­çš„è§„åˆ™å®šä¹‰ã€‚\nå‰å››ä¸ªè§„åˆ™æè¿°äº†æˆ‘ä»¬å¯ä»¥å¦‚ä½•åˆ¤æ–­å°†æ¯ä¸ªå¥æ³•ç»“æ„(`Lam`ï¼Œ`App`ï¼Œ`Var`ï¼Œ`Let`)æ˜ å°„åˆ°å®ƒä»¬çš„é¢„æœŸç±»å‹,æˆ‘ä»¬å¾ˆå¿«å°±ä¼šè¯¦ç»†é˜è¿°è¿™äº›è§„åˆ™ã€‚\n![](img/HM0.png)\nç±³å°”çº³çš„è§‚å¯Ÿæ˜¯,å› ä¸ºç±»å‹è§„åˆ™æ˜ å°„åˆ°å”¯ä¸€çš„è¯­æ³•,æˆ‘ä»¬å®é™…ä¸Šå¯ä»¥å‘åè¿è¡Œç±»å‹è§„åˆ™,æ¯å½“æˆ‘ä»¬æ²¡æœ‰å­è¡¨è¾¾å¼çš„å·²çŸ¥ç±»å‹æ—¶,æˆ‘ä»¬é€šè¿‡åœ¨å…¶ä½ç½®æ”¾ç½®ä¸€ä¸ªæ–°å˜é‡,\næ”¶é›†å…³äºå…¶åç»­ç±»å‹åˆ¤æ–­å¼•èµ·çš„ä½¿ç”¨é™åˆ¶æ¥è¿›è¡Œ\"çŒœæµ‹\".\nè¿™æ˜¯MLæ—è¯­è¨€ä¸­ç±»å‹æ¨æ–­çš„æœ¬è´¨,é€šè¿‡ç”Ÿæˆå’Œè§£å†³ä¸€ç§ç»Ÿä¸€(`unification`)é—®é¢˜,æˆ‘ä»¬å¯ä»¥ä»è¯­æ³•ä¸­å”¯ä¸€åœ°é‡æ„ç±»å‹,ç®—æ³•æœ¬èº«å¾ˆå¤§ç¨‹åº¦ä¸Šåªæ˜¯ç»Ÿä¸€æ±‚è§£å™¨çš„ç»“æ„åŒ–ä½¿ç”¨.\nç„¶è€Œ,å®Œæ•´çš„ç±»å‹æ¨æ–­ä½¿æˆ‘ä»¬æœ‰ç‚¹æŸç¼š,å› ä¸ºè™½ç„¶æ¨ç†é—®é¢˜åœ¨è¿™ç§ç®€å•çš„è¯­è¨€å’Œç®€å•çš„æ‰©å±•ä¸­æ˜¯æ˜“å¤„ç†çš„,ä½†å‡ ä¹æ‰€æœ‰å¯¹è¯­è¨€çš„é‡è¦è¡¥å……éƒ½ä¼šç ´ååœ¨æ²¡æœ‰æ³¨é‡Šçš„æƒ…å†µä¸‹æ¨æ–­ç±»å‹çš„èƒ½åŠ›,\næˆ–è€…ä½¿æ¨ç†ç®—æ³•ä¸¥é‡å¤æ‚åŒ–.ç„¶è€Œ,`Hindley-Milner`å®¶æ—åœ¨è®¾è®¡é¢†åŸŸä»£è¡¨äº†ä¸€ä¸ªéå¸¸æœ‰ç”¨,å¯Œæœ‰æˆæ•ˆçš„\"ç”œèœœç‚¹\".\n\n### è¯­æ³•\næˆ‘ä»¬çš„ç¬¬ä¸€ç§ç±»å‹æ¨æ–­è¯­è¨€çš„è¯­æ³•å®é™…ä¸Šå°†æ˜¯æˆ‘ä»¬çš„æ— ç±»å‹`lambda`æ¼”ç®—çš„æ‰©å±•,åŒ…æ‹¬`fixpoint`è¿ç®—ç¬¦,`booleans`,`integers`,`let`å’Œä¸€äº›åŸºæœ¬çš„ç®—æœ¯è¿ç®—.\n```\ntype Name = String\n\ndata Expr\n  = Var Name\n  | App Expr Expr\n  | Lam Name Expr\n  | Let Name Expr Expr\n  | Lit Lit\n  | If Expr Expr Expr\n  | Fix Expr\n  | Op Binop Expr Expr\n  deriving (Show, Eq, Ord)\n\ndata Lit\n  = LInt Integer\n  | LBool Bool\n  deriving (Show, Eq, Ord)\n\ndata Binop = Add | Sub | Mul | Eql\n  deriving (Eq, Ord, Show)\n\ndata Program = Program [Decl] Expr deriving Eq\n\ntype Decl = (String, Expr)\n```\n`parser`æ˜¯å¾®ä¸è¶³é“çš„,å”¯ä¸€çš„è¡¥å……æ˜¯`toplevel` `let`å£°æ˜(`Decl`),å®ƒä»¬è¢«åŠ å…¥åˆ°å…¨å±€ç¨‹åºä¸­,\næ‰€æœ‰é¡¶çº§å£°æ˜éƒ½å¿…é¡»ä»¥åˆ†å·ç»“æŸ,å°½ç®¡å®ƒä»¬å¯ä»¥è·¨è¶Šå¤šè¡Œå¹¶ä¸”å¿½ç•¥ç©ºæ ¼.ä¾‹å¦‚:\n```\n-- SKI combinators\nlet I x = x;\nlet K x y = x;\nlet S f g x = f x (g x);\n```\nå’Œä¹‹å‰ä¸€æ ·,`let rec`è¡¨è¾¾å¼å°†æ ¹æ®`fixpoint`è¿ç®—ç¬¦å±•å¼€,åªæ˜¯è¯­æ³•ç³–.\n\n### å¤šæ€æ€§\næˆ‘ä»¬å°†å‘æˆ‘ä»¬çš„è¯­è¨€æ·»åŠ ä¸€ä¸ªé¢å¤–çš„æ„é€ ,å®ƒå°†å…è®¸æˆ‘ä»¬çš„è¯­è¨€å…·æœ‰ä¸€ç§æ–°çš„å¤šæ€æ€§å½¢å¼.\nå¤šæ€æ€§æ˜¯ä¸€ä¸ªæœ¯è¯­çš„å±æ€§,å®ƒå…è®¸åŒä¸€å‡½æ•°å®ç°åŒæ—¶ä½¿ç”¨å‡ ç§ä¸åŒçš„ç±»å‹.\nä¾‹å¦‚,`identity`å‡½æ•°çš„å¤šæ€ç­¾åå®ä¾‹æ˜ å°„ä¸€ä¸ª`Î±`ç±»å‹çš„è¾“å…¥:\n\n![](img/HM01.png)\nç°åœ¨ä¸å¿…ä¸ºæ¯ç§å¯èƒ½çš„ç±»å‹é‡å¤å‡½æ•°(å³å®ç°`idInt`,`idBool`...)\næˆ‘ä»¬çš„ç±»å‹ç³»ç»Ÿå…è®¸åŒ…å«åœ¨å¤šæ€ç±»å‹ç­¾åä¸­çš„ä»»ä½•å®ä¾‹.\n![](img/HM02.png)\næ™®éé‡åŒ–çš„ä¸€ä¸ªç›¸å½“æ˜¾è‘—çš„äº‹å®æ˜¯,å…³äºä¸€ç±»çš„`inhabitants`çš„è®¸å¤šå±æ€§æ˜¯ç”±æ„é€ ä¿è¯çš„,è¿™äº›å°±æ˜¯æ‰€è°“çš„`free`å®šç†.\nä¾‹å¦‚,ä»»ä½•`(a, b) -> a`ç±»å‹çš„(`nonpathological`)å®ç°å¿…é¡»ç­‰åŒäº`fst`.\nä¸€ä¸ªç¨å¾®ä¸é‚£ä¹ˆç®€å•çš„ä¾‹å­æ˜¯`fmap`å‡½æ•°çš„ç±»å‹`Functor f =>ï¼ˆa -> bï¼‰-> f a -> f b`\nç¬¬äºŒä¸ª`functor`æ³•å¾‹è¦æ±‚:\n```\nforall f g. fmap f . fmap g = fmap (f . g)\n```\nä½†æ˜¯,æˆ‘ä»¬ä¸å¯èƒ½ä¸º`fmap`ç¼–å†™ä¸€ä¸ª(`nonpathological`)å‡½æ•°,è¯¥å‡½æ•°å…·æœ‰æ‰€éœ€çš„ç±»å‹,ä½†æ²¡æœ‰æ­¤å±æ€§.æˆ‘ä»¬å¾—åˆ°`free`å®šç†!\n\n### ç±»å‹\næˆ‘ä»¬å°†ä½¿ç”¨çš„ç±»å‹è¯­è¨€ä»ç”¨äºç±»å‹åŒ–`lambda`æ¼”ç®—çš„ç®€å•ç±»å‹ç³»ç»Ÿå¼€å§‹.\n```\nnewtype TVar = TV String\n  deriving (Show, Eq, Ord)\n\ndata Type\n  = TVar TVar\n  | TCon String\n  | TArr Type Type\n  deriving (Show, Eq, Ord)\n\ntypeInt, typeBool :: Type\ntypeInt  = TCon \"Int\"\ntypeBool = TCon \"Bool\"\n```\n`Type schemes``model polymorphic types`(æ ·æ¿å¤šæ€ç±»å‹)ï¼Œå®ƒä»¬è¡¨ç¤ºé‡è¯ä¸­ç»‘å®šçš„ç±»å‹å˜é‡åœ¨å°é—­çš„ç±»å‹ä¸­æ˜¯å¤šæ€çš„ï¼Œå¯ä»¥ç”¨ä¸ç­¾åä¸€è‡´çš„ä»»ä½•ç±»å‹å®ä¾‹åŒ–ã€‚ç›´è§‚åœ°è¯´æ˜äº†è¯¥å‡½æ•°çš„å®ç°:\n```\ndata Scheme = Forall [TVar] Type\n```\n`Type schemes`(ç±»å‹æ¨¡å¼)å°†åœ¨æˆ‘ä»¬çš„è¾“å…¥è§„åˆ™ä¸­å†™ä¸º`Ïƒ`.\n![](img/HM03.png)\nä¾‹å¦‚:`id`å’Œ`const`å‡½æ•°å°†ä¼šæœ‰ä»¥ä¸‹ç±»å‹:\n![](img/HM04.png)\næˆ‘ä»¬ç°åœ¨å°†æˆ‘ä»¬çš„ç±»å‹åˆ’åˆ†ä¸ºä¸¤ä¸ªå¥æ³•ç±»åˆ«,å•å‹å’Œå¤šå‹.\nåœ¨æˆ‘ä»¬ç®€å•çš„åˆå§‹è¯­è¨€ä¸­,`type schemes`(ç±»å‹æ¨¡å¼)å°†å§‹ç»ˆæ˜¯`top level`(é¡¶çº§)ç­¾åçš„è¡¨ç¤º,å³ä½¿æ²¡æœ‰å¤šæ€ç±»å‹å˜é‡.\nåœ¨å®ç°æœ¯è¯­ä¸­,è¿™æ„å‘³ç€åœ¨æ¨æ–­åä»æˆ‘ä»¬çš„`Infer monad`ä¸­äº§ç”Ÿå•å‹æ—¶,\n`we will immediately generalize it at the toplevel \"closing over\" all free type variables in a type scheme.`\n(æˆ‘ä»¬å°†ç«‹å³åœ¨ç±»å‹æ¨¡å¼çš„é¡¶å±‚\"å…³é—­æ‰€æœ‰\"è‡ªç”±ç±»å‹å˜é‡ä¸­å½’çº³å®ƒ)\n\n### ä¸Šä¸‹æ–‡\n```\nnewtype TypeEnv = TypeEnv (Map.Map Var Scheme)\n```\nä¸¤ä¸ªä¸»è¦æ“ä½œæ˜¯æ‰©å±•å’Œé™å®š,å®ƒä»ä¸Šä¸‹æ–‡ä¸­å¼•å…¥æˆ–åˆ é™¤å‘½åæ•°é‡.\n![](img/HM05.png)\nå¯¹ä¸Šä¸‹æ–‡çš„æ“ä½œåªæ˜¯å¯¹åº•å±‚`map`ä¸Šçš„å¸¸ç”¨`Set`æ“ä½œ.\n```\nextend :: TypeEnv -> (Var, Scheme) -> TypeEnv\nextend (TypeEnv env) (x, s) = TypeEnv $ Map.insert x s env\n```\n### Inference Monad(æ¨ç†)\næˆ‘ä»¬æ‰€æœ‰çš„ç±»å‹æ¨æ–­é€»è¾‘éƒ½å°†å­˜åœ¨äº`Infer monad`ä¸­,å®ƒæ˜¯`ExcpetT`+`State`çš„`monad`å˜æ¢å™¨å †æ ˆ.å…è®¸å„ç§é”™è¯¯æŠ¥å‘Šå¹¶æœ‰çŠ¶æ€åœ°ä¿å­˜æ–°åç§°.\n```\ntype Infer a = ExceptT TypeError (State Unique) a\n```\nåœ¨`monad`ä¸­è¿è¡Œé€»è¾‘ä¼šå¯¼è‡´ç±»å‹é”™è¯¯æˆ–ç»“æœç±»å‹æ¨¡å¼.\n```\nrunInfer :: Infer (Subst, Type) -> Either TypeError Scheme\nrunInfer m = case evalState (runExceptT m) initUnique of\n  Left err  -> Left err\n  Right res -> Right $ closeOver res\n```\n### Substitution(æ›¿æ¢)\næŸ¥è¯¢è¡¨è¾¾å¼çš„è‡ªç”±å˜é‡å’Œå¯¹è¡¨è¾¾å¼åº”ç”¨æ›¿æ¢,è¿™ä¸¤ä¸ªæ“ä½œå°†æ‰§è¡Œç›¸å½“å¤šçš„æ“ä½œ.\n![](img/HM06.png)\nç›¸åŒçš„æ¨¡å¼é€‚ç”¨äºç±»å‹çº§åˆ«çš„ç±»å‹å˜é‡.\n![](img/HM07.png)\nè¡¨è¾¾å¼ä¸Šçš„æ›¿æ¢å°†æ›¿æ¢åº”ç”¨äºå±€éƒ¨å˜é‡ï¼Œå¦‚æœåŒ¹é…ï¼Œåˆ™æ›¿æ¢æŒ‡å®šçš„å­è¡¨è¾¾å¼ã€‚åœ¨åç§°æ•è·çš„æƒ…å†µä¸‹ï¼Œå°†å¼•å…¥ä¸€ä¸ªæ–°çš„å˜é‡ã€‚\n![](img/HM08.png)\nåŒæ ·ï¼Œæ›¿æ¢ä¹Ÿå¯ä»¥åº”ç”¨äºç±»å‹ç¯å¢ƒä¹‹ä¸Šçš„å…ƒç´ ã€‚\n![](img/HM09.png)\næˆ‘ä»¬åœ¨`Haskell`ä¸­çš„æ›¿æ¢å®ç°åªæ˜¯ä»ç±»å‹å˜é‡åˆ°ç±»å‹çš„`Map`.\n```\ntype Subst = Map.Map TVar Type\n```\næ›¿æ¢çš„ç»„åˆ(`s1 âˆ˜ s2`, `s1 compose s2`)å¯ä»¥ç®€å•åœ°ç¼–ç ä¸ºåŸºç¡€`Map`ä¸Šçš„æ“ä½œ,é‡è¦çš„æ˜¯è¦æ³¨æ„,åœ¨æˆ‘ä»¬çš„å®ç°ä¸­,æˆ‘ä»¬é€‰æ‹©äº†æ›¿æ¢ä¸º`left-biased`,å–å†³äºæ¨ç†ç®—æ³•çš„å®ç°,ä»¥ç¡®ä¿åœ¨æ›¿æ¢ä¹‹é—´ä¸å‘ç”Ÿå†²çª.\n```\nnullSubst :: Subst\nnullSubst = Map.empty\n\ncompose :: Subst -> Subst -> Subst\ns1 `compose` s2 = Map.map (apply s1) s2 `Map.union` s1\n```\n\n`Haskell`ä¸­çš„å®ç°æ˜¯é€šè¿‡`Substitutable`ç±»å‹ç±»çš„ä¸€ç³»åˆ—å®ç°æ¥å…¬å¼€ä¸€ä¸ª`apply`å‡½æ•°,è¯¥å‡½æ•°åº”ç”¨åœ¨ æŒ‡å®šç±»å‹å˜é‡çš„ ç±»å‹ç»“æ„ä¸Š ç»™å‡ºçš„æ›¿æ¢.\n```\nclass Substitutable a where\n  apply :: Subst -> a -> a\n  ftv   :: a -> Set.Set TVar\n\ninstance Substitutable Type where\n  apply _ (TCon a)       = TCon a\n  apply s t@(TVar a)     = Map.findWithDefault t a s\n  apply s (t1 `TArr` t2) = apply s t1 `TArr` apply s t2\n\n  ftv TCon{}         = Set.empty\n  ftv (TVar a)       = Set.singleton a\n  ftv (t1 `TArr` t2) = ftv t1 `Set.union` ftv t2\n\ninstance Substitutable Scheme where\n  apply s (Forall as t)   = Forall as $ apply s' t\n                            where s' = foldr Map.delete s as\n  ftv (Forall as t) = ftv t `Set.difference` Set.fromList as\n\ninstance Substitutable a => Substitutable [a] where\n  apply = fmap . apply\n  ftv   = foldr (Set.union . ftv) Set.empty\n\ninstance Substitutable TypeEnv where\n  apply s (TypeEnv env) =  TypeEnv $ Map.map (apply s) env\n  ftv (TypeEnv env) = ftv $ Map.elems env\n```\nåœ¨æ•´ä¸ªç±»å‹è§„åˆ™å’Œæ›¿æ¢ä¸­,æˆ‘ä»¬éœ€è¦æ–°çš„åç§°.åœ¨è¿™ä¸ªå¤©çœŸçš„ç‰ˆæœ¬ä¸­,æˆ‘ä»¬å°†ç®€å•åœ°ä½¿ç”¨æ— é™çš„å­—ç¬¦ä¸²åˆ—è¡¨,å¹¶æŒ‰ç…§æˆ‘ä»¬åœ¨`çŠ¶æ€monad`ä¸­ä¿å­˜çš„ç´¢å¼•åˆ‡å…¥åˆ—è¡¨çš„ç¬¬`n`ä¸ªå…ƒç´ ,è¿™æ˜¯æœ€ç®€å•çš„å®ç°,ç¨åæˆ‘ä»¬å°†ä½¿è¿™ç§åç§°ç”ŸæˆæŠ€æœ¯æ›´åŠ å¥å£®.\n```\nletters :: [String]\nletters = [1..] >>= flip replicateM ['a'..'z']\n\nfresh :: Infer Type\nfresh = do\n  s <- get\n  put s{count = count s + 1}\n  return $ TVar $ TV (letters !! count s)\n```\nåˆ›å»ºæ–°å˜é‡å¯¹äºå®æ–½æ¨ç†è§„åˆ™è‡³å…³é‡è¦ã€‚ æ¯å½“æˆ‘ä»¬åœ¨æŸä¸ªè¡¨è¾¾å¼ä¸­é‡åˆ°ç¬¬ä¸€æ¬¡ä½¿ç”¨å˜é‡æ—¶ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªæ–°çš„ç±»å‹å˜é‡ã€‚\n\n### Unification(ç»Ÿä¸€)\næ¨ç†æ€æƒ³çš„æ ¸å¿ƒæ˜¯ç»Ÿä¸€çš„æ¦‚å¿µ,ä¸¤ä¸ªè¡¨è¾¾å¼`e1`å’Œ`e2`çš„ç»Ÿä¸€ç¬¦æ˜¯æ›¿æ¢`s`,ä½¿å¾—:\n![](img/HM10.png)\nå¦‚æœåœ¨å®ƒä»¬ä¹‹é—´å­˜åœ¨ç»Ÿä¸€çš„æ›¿æ¢é›†åˆï¼Œåˆ™è®¤ä¸ºä¸¤ä¸ªæœ¯è¯­æ˜¯ç»Ÿä¸€çš„ã€‚ å¦‚æœæ›¿æ¢çš„åº”ç”¨ä¸æ‰€åº”ç”¨çš„é¡ºåºæ— å…³ï¼Œå³å¦‚æœæˆ‘ä»¬æ€»æ˜¯ä»¥ç›¸åŒçš„æ­£å¸¸å½¢å¼åˆ°è¾¾è€Œä¸ç®¡æ‰€é€‰æ‹©çš„æ›¿æ¢é¡ºåºå¦‚ä½•ï¼Œåˆ™ç§°æ›¿æ¢é›†æ˜¯æ±‡åˆçš„ã€‚\næˆ‘ä»¬å°†é‡‡ç”¨è¿™ç§è¡¨ç¤ºæ³•:\n```\nÏ„ âˆ¼ Ï„â€²:s\n```\näº‹å®ä¸Š`Ï„,Ï„'`è¿™ä¸¤ç§ç±»å‹æ˜¯å¯ä»¥é€šè¿‡ä¸€ä¸ªæ›¿æ¢`s`è¿›è¡Œç»Ÿä¸€çš„,è¿™æ ·:\n```\n[s]Ï„ = [s]Ï„â€²\n```\nä¸¤ä¸ªç›¸åŒçš„é¡¹å¯ä»¥ç”¨ç©ºçš„ç»Ÿä¸€å™¨è½»æ¾åœ°ç»Ÿä¸€:\n```\nc âˆ¼ c : [ ]\n```\næˆ‘ä»¬çš„å°HMè¯­è¨€çš„ç»Ÿä¸€è§„åˆ™å¦‚ä¸‹:\n![](img/HM11.png)\nå¦‚æœæˆ‘ä»¬æƒ³è¦å°†ç±»å‹å˜é‡`Î±`ä¸ç±»å‹`Ï„`ç»Ÿä¸€èµ·æ¥,æˆ‘ä»¬é€šå¸¸å¯ä»¥ç”¨ç±»å‹æ›¿æ¢å˜é‡: `[Î±/Ï„]`.ä½†æ˜¯,æˆ‘ä»¬çš„è§„åˆ™è§„å®šäº†ä¸€ä¸ªå‰ææ¡ä»¶,ç§°ä¸ºè¯¥ç»Ÿä¸€çš„å‘ç”Ÿæ£€æŸ¥: ç±»å‹å˜é‡`Î±`ä¸å¾—åœ¨`Ï„`ä¸­è‡ªç”±å‡ºç°.å¦‚æœç¡®å®å¦‚æ­¤.åˆ™æ›¿æ¢å°†ä¸æ˜¯ç»Ÿä¸€.\nä¾‹å¦‚,ç»Ÿä¸€`Î±`å’Œ`Î± â†’ Î²`çš„é—®é¢˜.\næ›¿æ¢`s` = `[Î±/Î± â†’ Î²]`ä¸ç»Ÿä¸€: æˆ‘ä»¬å¾—åˆ°\n```\n[s]Î± = Î± â†’ Î²\nå’Œ\n[s]Î± â†’ Î² = (Î± â†’ Î²) â†’ Î²\n```\nå®é™…ä¸Š,æ— è®ºæˆ‘ä»¬å°è¯•ä»€ä¹ˆæ›¿ä»£,`[s]Î± â†’ Î²`æ€»æ˜¯æ¯”`[s]Î±`é•¿,æ‰€ä»¥ä¸å­˜åœ¨ç»Ÿä¸€è€…,å”¯ä¸€çš„æœºä¼šæ˜¯ç”¨æ— é™ç±»å‹æ›¿æ¢: `[Î±/(...((Î± â†’ Î²) â†’ Î²)â†’ â‹¯ â†’ Î²) â†’ Î²]`å°†æ˜¯ä¸€ä¸ªç»Ÿä¸€è€…ï¼Œä½†æˆ‘ä»¬çš„è¯­è¨€æ²¡æœ‰è¿™æ ·çš„ç±»å‹ã€‚\nå¦‚æœç”±äºå‘ç”Ÿæ£€æŸ¥(`occurs check`)è€Œç»Ÿä¸€å¤±è´¥,æˆ‘ä»¬è¯´ç»Ÿä¸€å°†ç»™å‡ºæ— é™ç±»å‹ã€‚\nè¯·æ³¨æ„,å¦‚æœæˆ‘ä»¬å°è¯•ç±»å‹æ£€æŸ¥`omega`ç»„åˆå™¨`Î»x.xx`ï¼Œé‚£ä¹ˆç»Ÿä¸€`Î± â†’ Î²`å’Œ`Î±`æ­£æ˜¯æˆ‘ä»¬å¿…é¡»è¦åšçš„,æ‰€ä»¥å®ƒè¢«å‘ç”Ÿæ£€æŸ¥(`occurs check`)æ’é™¤äº†ï¼Œ\næ­£å¦‚æˆ‘ä»¬åœ¨è¦†ç›–æ— ç±»å‹`lambda`æ¼”ç®—æ—¶æ‰€è®¨è®ºçš„å…¶ä»–`pathological`æœ¯è¯­ä¸€æ ·.\n```\noccursCheck ::  Substitutable a => TVar -> a -> Bool\noccursCheck a t = a `Set.member` ftv t\n```\n`unify`å‡½æ•°å­˜åœ¨äº`Infer monad`ä¸­å¹¶äº§ç”Ÿæ›¿æ¢:\n```\nunify ::  Type -> Type -> Infer Subst\nunify (l `TArr` r) (l' `TArr` r')  = do\n    s1 <- unify l l'\n    s2 <- unify (apply s1 r) (apply s1 r')\n    return (s2 `compose` s1)\n\nunify (TVar a) t = bind a t\nunify t (TVar a) = bind a t\nunify (TCon a) (TCon b) | a == b = return nullSubst\nunify t1 t2 = throwError $ UnificationFail t1 t2\n\nbind ::  TVar -> Type -> Infer Subst\nbind a t | t == TVar a     = return nullSubst\n         | occursCheck a t = throwError $ InfiniteType a t\n         | otherwise       = return $ Map.singleton a t\n```\n\n### Generalization and Instantiation (æ³›åŒ–å’Œå®ä¾‹åŒ–)\n`Hindley-Milner`çš„æ ¸å¿ƒæ˜¯ä¸¤ä¸ªåŸºæœ¬æ“ä½œ:\n`Generalization`æ³›åŒ–: é€šè¿‡å…³é—­ç±»å‹æ–¹æ¡ˆä¸­çš„æ‰€æœ‰è‡ªç”±ç±»å‹å˜é‡,å°†`Ï„`ç±»å‹è½¬æ¢ä¸º`Ïƒ`ç±»å‹ã€‚\n`Instantiation`å®ä¾‹åŒ–: é€šè¿‡ä¸ºå½“å‰ç±»å‹ç¯å¢ƒä¸­æœªå‡ºç°çš„æ¯ä¸ªç±»å‹å˜é‡åˆ›å»ºæ–°åç§°,å°†`Ïƒ`ç±»å‹è½¬æ¢ä¸º`Ï„`ç±»å‹ã€‚\n![](img/HM12.png)\n(`T-Inst`)è§„åˆ™ä¸­çš„`âŠ‘`è¿ç®—ç¬¦è¡¨ç¤ºç±»å‹æ˜¯ç±»å‹æ¨¡å¼(`type scheme`)çš„å®ä¾‹.\n![](img/HM13.png)\n`âŠ‘`ç¬¦å·å³è¾¹çš„ç±»å‹`Ï„1`æ˜¯å·¦è¾¹ç±»å‹æ¨¡å¼(`Ïƒ = å·¦è¾¹`)çš„å®ä¾‹åŒ–,å¦‚æœå¯¹äºæ‰€æœ‰çš„`Î² âˆˆ ğšğšğšŸ(Ïƒ)`å­˜åœ¨ä¸€ä¸ªæ›¿æ¢`[s]Î² = Î²`,åˆ™` Ï„1 = [s]Ï„2`,çœ‹ä¾‹å­:\n\n```\nâˆ€a.a â†’ a âŠ‘ ğ™¸ğš—ğš â†’ ğ™¸ğš—ğš\nâˆ€a.a â†’ a âŠ‘ b â†’ b\nâˆ€ab.a â†’ b â†’ a âŠ‘ ğ™¸ğš—ğš â†’ ğ™±ğš˜ğš˜ğš• â†’ ğ™¸ğš—ğš\n```\nè¿™äº›æ˜ å°„éå¸¸ç›´è§‚åœ°æ˜ å°„åˆ°ç®€å•åœ°æ“ä½œ`Haskell Set`å˜é‡å¯¹è±¡å’Œæ–°åç§°ä¾›åº”çš„ä»£ç :\n```\ninstantiate ::  Scheme -> Infer Type\ninstantiate (Forall as t) = do\n  as' <- mapM (const fresh) as\n  let s = Map.fromList $ zip as as'\n  return $ apply s t\n\ngeneralize :: TypeEnv -> Type -> Scheme\ngeneralize env t  = Forall as t\n    where as = Set.toList $ ftv t `Set.difference` ftv env\n```\næŒ‰ç…§çº¦å®š,`let`ç»‘å®šè¢«å°½å¯èƒ½åœ°ä¸€èˆ¬åŒ–(`generalized`).\nå› æ­¤,åœ¨ä¸‹é¢çš„å®šä¹‰ä¸­,`f`åœ¨ç»‘å®šçš„ä¸»ä½“ä¸Šè¿›è¡Œäº†ä¸€èˆ¬åŒ–,ä»¥ä¾¿åœ¨æ¯æ¬¡è°ƒç”¨`f`æ—¶,éƒ½ç”¨æ–°çš„ç±»å‹å˜é‡å®ä¾‹åŒ–å®ƒ.\n```\nPoly> let f = (\\x -> x) in let g = (f True) in f 3\n3 : Int\n```\nåœ¨è¿™ä¸ªè¡¨è¾¾å¼ä¸­,`f`çš„ç±»å‹åœ¨`let`å®šä¹‰ä¸­ç”Ÿæˆ,å¹¶å°†ä½¿ç”¨ä¸¤ä¸ªä¸åŒçš„ç­¾åå®ä¾‹åŒ–.\nåœ¨fçš„è°ƒç”¨ä½ç½®,å®ƒå°†ä¸`Int`ç›¸ç»Ÿä¸€,å¦ä¸€ä¸ªä¸`Bool`ç›¸ç»Ÿä¸€ã€‚\nç›¸å,åœ¨`lambda`ä¸­ç»‘å®š`f`å°†å¯¼è‡´ç±»å‹é”™è¯¯.\n```\nPoly> (\\f -> let g = (f True) in (f 3)) (\\x -> x)\nCannot unify types: \n    Bool\nwith \n    Int\n```\nè¿™æ˜¯`let generalization(ä¸€èˆ¬åŒ–)`çš„æœ¬è´¨.\n\n### Typing Rules (ç±»å‹è§„åˆ™)\næœ€å,åœ¨æ‰€æœ‰ç±»å‹æœºåˆ¶åˆ°ä½å,æˆ‘ä»¬å¯ä»¥å†™ä¸‹æˆ‘ä»¬ç®€å•çš„å°å¤šæ€`lambda`æ¼”ç®—çš„ç±»å‹è§„åˆ™.\n```\ninfer :: TypeEnv -> Expr -> Infer (Subst, Type)\n```\n`infer`å°†å±€éƒ¨ç±»å‹ç¯å¢ƒå’Œæ´»åŠ¨è¡¨è¾¾å¼æ˜ å°„åˆ°éƒ¨åˆ†ç»Ÿä¸€è§£å†³æ–¹æ¡ˆå’Œä¸­é—´ç±»å‹çš„2å…ƒç»„.é€šè¿‡åœ¨æ¯ä¸ªéƒ¨åˆ†æ¨æ–­çš„å­è¡¨è¾¾å¼å’Œå±€éƒ¨ç¯å¢ƒä¸­åº”ç”¨æ¥è‡ªç»Ÿä¸€çš„éƒ¨åˆ†æ›¿æ¢,è‡ªä¸‹è€Œä¸Šéå†`AST`å¹¶ä¸”åœ¨æ¯ä¸ªé€’å½’çº§åˆ«å¤„æ±‚è§£çº¦æŸ,å¦‚æœé‡åˆ°é”™è¯¯,åˆ™ä¼šåœ¨`Infer monad`ä¸­è°ƒç”¨`throwError`,å¹¶æŠ¥å‘Šé”™è¯¯:\n```\ninfer :: TypeEnv -> Expr -> Infer (Subst, Type)\ninfer env ex = case ex of\n\n  Var x -> lookupEnv env x\n\n  Lam x e -> do\n    tv <- fresh\n    let env' = env `extend` (x, Forall [] tv)\n    (s1, t1) <- infer env' e\n    return (s1, apply s1 tv `TArr` t1)\n\n  App e1 e2 -> do\n    tv <- fresh\n    (s1, t1) <- infer env e1\n    (s2, t2) <- infer (apply s1 env) e2\n    s3       <- unify (apply s2 t1) (TArr t2 tv)\n    return (s3 `compose` s2 `compose` s1, apply s3 tv)\n\n  Let x e1 e2 -> do\n    (s1, t1) <- infer env e1\n    let env' = apply s1 env\n        t'   = generalize env' t1\n    (s2, t2) <- infer (env' `extend` (x, t')) e2\n    return (s1 `compose` s2, t2)\n\n  If cond tr fl -> do\n    (s1, t1) <- infer env cond\n    (s2, t2) <- infer env tr\n    (s3, t3) <- infer env fl\n    s4 <- unify t1 typeBool\n    s5 <- unify t2 t3\n    return (s5 `compose` s4 `compose` s3 `compose` s2 `compose` s1, apply s5 t2)\n\n  Fix e1 -> do\n    (s1, t) <- infer env e1\n    tv <- fresh\n    s2 <- unify (TArr tv tv) t\n    return (s2, apply s1 tv)\n\n  Op op e1 e2 -> do\n    (s1, t1) <- infer env e1\n    (s2, t2) <- infer env e2\n    tv <- fresh\n    s3 <- unify (TArr t1 (TArr t2 tv)) (ops Map.! op)\n    return (s1 `compose` s2 `compose` s3, apply s3 tv)\n\n  Lit (LInt _)  -> return (nullSubst, typeInt)\n  Lit (LBool _) -> return (nullSubst, typeBool)\n```\nè®©æˆ‘ä»¬æµè§ˆæ¯ä¸ªè§„åˆ™æ´¾ç”Ÿï¼Œçœ‹çœ‹å®ƒå¦‚ä½•è½¬æ¢ä¸ºä»£ç :\n#### T-Var\nT-Varè§„åˆ™ï¼Œåªéœ€ä»`typing`å˜æ¢ä¸Šä¸‹æ–‡ä¸­æå–å˜é‡çš„ç±»å‹å³å¯.\n```\nVar x -> lookupEnv env x\n```\nå‡½æ•°`lookupVar`åœ¨`typing`ç¯å¢ƒä¸­æŸ¥æ‰¾å±€éƒ¨å˜é‡å¼•ç”¨,å¦‚æœæ‰¾åˆ°å®ƒ,åˆ™å®ä¾‹åŒ–ä¸€ä¸ªæ–°å‰¯æœ¬.\n```\nlookupEnv :: TypeEnv -> Var -> Infer (Subst, Type)\nlookupEnv (TypeEnv env) x = do\n  case Map.lookup x env of\n    Nothing -> throwError $ UnboundVariable (show x)\n    Just s  -> do t <- instantiate s\n                  return (nullSubst, t)\n```\n![](img/HM14.png)\n\t\n#### T-Lam\nå¯¹äº`lambdas`,ç”±`lambda`ç»‘å®šçš„å˜é‡æœ¬åœ°ä½œç”¨äº`typing`ç¯å¢ƒ,ç„¶åä½¿ç”¨æ­¤ä½œç”¨åŸŸæ¨æ–­è¡¨è¾¾å¼çš„ä¸»ä½“.\nè¾“å‡ºç±»å‹æ˜¯ä¸€ä¸ªæ–°ç±»å‹å˜é‡,å¹¶ä¸ç”Ÿæˆçš„æ¨æ–­ç±»å‹ç»Ÿä¸€.\n```\nLam x e -> do\n    tv <- fresh\n    let env' = env `extend` (x, Forall [] tv)\n    (s1, t1) <- infer env' e\n    return (s1, apply s1 tv `TArr` t1)\n```\n![](img/HM15.png)\n\n\n#### T-App\nå¯¹äºåº”ç”¨ç¨‹åº,ç¬¬ä¸€ä¸ªå‚æ•°å¿…é¡»æ˜¯`lambda`è¡¨è¾¾å¼æˆ–è¿”å›`lambda`è¡¨è¾¾å¼,å› æ­¤è¦çŸ¥é“å®ƒå¿…é¡»æ˜¯`t1 -> t2`çš„å½¢å¼,ä½†é™¤äº†ä¸¤ä¸ªå€¼çš„æ±‡åˆå¤–,ä¸ç¡®å®šè¾“å‡ºç±»å‹ã€‚\næˆ‘ä»¬æ¨æ–­ä¸¤ç§ç±»å‹,\nå°†ç¬¬ä¸€ä¸ªå‚æ•°ä¸­çš„çº¦æŸåº”ç”¨äºç¬¬äºŒæ¨æ–­ç±»å‹çš„ç»“æœ,ç„¶åä½¿ç”¨æ•´ä¸ªåº”ç”¨ç¨‹åºè¡¨è¾¾å¼çš„ä¾‹å¤–å½¢å¼(`excepted form`)ç»Ÿä¸€è¿™ä¸¤ä¸ªç±»å‹ã€‚\n```\nApp e1 e2 -> do\n    tv <- fresh\n    (s1, t1) <- infer env e1\n    (s2, t2) <- infer (apply s1 env) e2\n    s3       <- unify (apply s2 t1) (TArr t2 tv)\n    return (s3 `compose` s2 `compose` s1, apply s3 tv)\n```\n![](img/HM16.png)\n\n#### T-Let\nå¦‚å‰æ‰€è¿°,`let`å°†ä¼š`generalized`(ä¸€èˆ¬åŒ–),å› æ­¤æˆ‘ä»¬å°†ä¸º`let`è¡¨è¾¾å¼çš„ä¸»ä½“åˆ›å»ºä¸€ä¸ªæœ¬åœ°`typing`ç±»å‹åŒ–ç¯å¢ƒ,å¹¶æ·»åŠ ä¸€èˆ¬åŒ–æ¨æ–­ç±»å‹çš„`let`ç»‘å®šå€¼åˆ°ä¸»ä½“çš„`typing`ç¯å¢ƒä¸­.\n```\n Let x e1 e2 -> do\n    (s1, t1) <- infer env e1\n    let env' = apply s1 env\n        t'   = generalize env' t1\n    (s2, t2) <- infer (env' `extend` (x, t')) e2\n    return (s1 `compose` s2, t2)\n```\n![](img/HM17.png)\n\n#### T-BinOp\næœ‰å‡ ä¸ªå†…å»ºæ“ä½œ,æˆ‘ä»¬åˆ°ç›®å‰ä¸ºæ­¢è¿˜æ²¡æœ‰æåˆ°,å› ä¸ºç±»å‹è§„åˆ™å¾ˆç®€å•,æˆ‘ä»¬åªéœ€ç»Ÿä¸€è¿™ä¸ªæ“ä½œçš„é¢„è®¾ç½®ç±»å‹ç­¾å.\n```\nOp op e1 e2 -> do\n    (s1, t1) <- infer env e1\n    (s2, t2) <- infer env e2\n    tv <- fresh\n    s3 <- unify (TArr t1 (TArr t2 tv)) (ops Map.! op)\n    return (s1 `compose` s2 `compose` s3, apply s3 tv)\n\nops :: Map.Map Binop Type\nops = Map.fromList [\n      (Add, (typeInt `TArr` (typeInt `TArr` typeInt)))\n    , (Mul, (typeInt `TArr` (typeInt `TArr` typeInt)))\n    , (Sub, (typeInt `TArr` (typeInt `TArr` typeInt)))\n    , (Eql, (typeInt `TArr` (typeInt `TArr` typeBool)))\n  ]\n```\n\n#### Literals\n`literal`æ•´æ•°å’Œ`boolean`ç±»å‹çš„ç±»å‹é€šå¸¸æ˜¯å®ƒä»¬å„è‡ªçš„ç±»å‹.\n```\n(+) :: ğ™¸ğš—ğš â†’ ğ™¸ğš—ğš â†’ ğ™¸ğš—ğš\n(Ã—) :: ğ™¸ğš—ğš â†’ ğ™¸ğš—ğš â†’ ğ™¸ğš—ğš\n(âˆ’) :: ğ™¸ğš—ğš â†’ ğ™¸ğš—ğš â†’ ğ™¸ğš—ğš\n(=) :: ğ™¸ğš—ğš â†’ ğ™¸ğš—ğš â†’ ğ™±ğš˜ğš˜ğš•\n```\n![](img/HM18.png)\n\n### Constraint Generation (çº¦æŸç”Ÿæˆ)\n`Hindley Milner`çš„å…ˆå‰å®ç°å¾ˆç®€å•,ä½†å…·æœ‰æ··åˆä¸¤ä¸ªç‹¬ç«‹è¿‡ç¨‹çš„å¥‡æ€ªç‰¹æ€§: `constraint solving`(çº¦æŸæ±‚è§£å™¨)å’Œ`traversal`(éå†).è®©æˆ‘ä»¬è®¨è®ºä¸æ‰§è¡Œæ­¤æ“ä½œçš„æ¨ç†ç®—æ³•çš„å¦ä¸€ç§å®ç°.\nåœ¨çº¦æŸç”Ÿæˆæ–¹æ³•ä¸­,çº¦æŸæ˜¯é€šè¿‡è‡ªä¸‹è€Œä¸Šéå†ç”Ÿæˆçš„,æ·»åŠ åˆ°æœ‰åºå®¹å™¨ä¸­,è§„èŒƒåŒ–,æ±‚è§£,ç„¶åå¯èƒ½åœ¨ç±»å‹åŒ–ASTä¸Šè¿›è¡Œåç½®æ›¿æ¢.è¿™å°†æ˜¯æˆ‘ä»¬å°†ä»è¿™é‡Œä½¿ç”¨çš„æ–¹æ³•,\nè™½ç„¶ä¸`on-line solver`ä¹‹é—´å­˜åœ¨ç­‰ä»·,ä½†ä½¿ç”¨å•ç‹¬çš„çº¦æŸæ±‚è§£å™¨å˜å¾—æ›´å®¹æ˜“ç®¡ç†,å› ä¸ºæˆ‘ä»¬çš„ç±»å‹ç³»ç»Ÿå˜å¾—æ›´å¤æ‚,æˆ‘ä»¬å¼€å§‹æ„å»ºè¯­è¨€.\nç°åœ¨æˆ‘ä»¬çš„æ¨ç†`monad`å˜æˆäº†`RWST`(`Reader-Writer-State`è½¬æ¢å™¨)+`Either`(å¤„ç†ç±»å‹é”™è¯¯).æ¨ç†çŠ¶æ€ä¿æŒä¸å˜,åªæ˜¯æä¾›æ–°é²œçš„åç§°.\n```\n-- | Inference monad\ntype Infer a = (RWST\n                  Env             -- Typing environment\n                  [Constraint]    -- Generated constraints\n                  InferState      -- Inference state\n                  (Except         -- Inference errors\n                    TypeError)\n                  a)              -- Result\n\n-- | Inference state\ndata InferState = InferState { count :: Int }\n```\næˆ‘ä»¬å°†åªæ”¶é›†`Writer`ä¸­çš„`unifier`å¹¶ä½¿ç”¨`uni`å‡½æ•°å‘å‡ºå®ƒä»¬,è€Œä¸æ˜¯åœ¨æ¯ä¸ªéå†çº§åˆ«ç»Ÿä¸€ç±»å‹å˜é‡.\n```\n-- | Unify two types\nuni :: Type -> Type -> Infer ()\nuni t1 t2 = tell [(t1, t2)]\n```\nç”±äº`typing`è¾“å…¥ç¯å¢ƒå­˜å‚¨åœ¨`Reader monad`ä¸­,æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`local`æ¥ä¸º`typing`ç¯å¢ƒåˆ›å»ºä¸€ä¸ªæœ¬åœ°èŒƒå›´çš„é™„åŠ ç»„ä»¶.è¿™å¯¹äº`typing`ç»‘å®šå™¨å¾ˆæ–¹ä¾¿.\n```\n-- | Extend type environment\ninEnv :: (Name, Scheme) -> Infer a -> Infer a\ninEnv (x, sc) m = do\n  let scope e = (remove e x) `extend` (x, sc)\n  local scope m\n```\n\n### Typing\nè¿™äº›ç±»å‹è§„åˆ™æ˜¯ç›¸åŒçš„,åªæ˜¯ç°åœ¨æˆ‘ä»¬å¯ä»¥ç”¨ä¸€ç§ä¸éœ€è¦çº¿ç¨‹å¤„ç†å¤ªå¤šçŠ¶æ€çš„æ›´å°‘å™ªéŸ³çš„æ–¹å¼æ¥ç¼–å†™å®ƒä»¬.\næ‰€æœ‰çš„ç»†èŠ‚éƒ½è¢«éšè—èµ·æ¥,å¹¶è¢«ç¼–ç åœ¨ç‰¹å®šçš„ç»„åˆå™¨ä¸­,ä»¥ä¸€ç§è®©æˆ‘ä»¬ä¸“æ³¨äºé¢†åŸŸé€»è¾‘çš„æ–¹å¼æ“çºµæˆ‘ä»¬çš„`Infer monad`çš„çŠ¶æ€ã€‚\n```\ninfer :: Expr -> Infer Type\ninfer expr = case expr of\n  Lit (LInt _)  -> return $ typeInt\n  Lit (LBool _) -> return $ typeBool\n\n  Var x -> lookupEnv x\n\n  Lam x e -> do\n    tv <- fresh\n    t <- inEnv (x, Forall [] tv) (infer e)\n    return (tv `TArr` t)\n\n  App e1 e2 -> do\n    t1 <- infer e1\n    t2 <- infer e2\n    tv <- fresh\n    uni t1 (t2 `TArr` tv)\n    return tv\n\n  Let x e1 e2 -> do\n    env <- ask\n    t1 <- infer e1\n    let sc = generalize env t1\n    t2 <- inEnv (x, sc) (infer e2)\n    return t2\n\n  Fix e1 -> do\n    t1 <- infer e1\n    tv <- fresh\n    uni (tv `TArr` tv) t1\n    return tv\n\n  Op op e1 e2 -> do\n    t1 <- infer e1\n    t2 <- infer e2\n    tv <- fresh\n    let u1 = t1 `TArr` (t2 `TArr` tv)\n        u2 = ops Map.! op\n    uni u1 u2\n    return tv\n\n  If cond tr fl -> do\n    t1 <- infer cond\n    t2 <- infer tr\n    t3 <- infer fl\n    uni t1 typeBool\n    uni t2 t3\n    return t2\n```\n\n### Constraint Solver (çº¦æŸè§£å†³å™¨)\n`Infer monad`çš„`Writer`å±‚åŒ…å«ä»æ¨ç†ä¼ é€’å‘å‡ºçš„ç”Ÿæˆçš„çº¦æŸé›†.\nä¸€æ—¦æ¨æ–­å®Œæˆ,æˆ‘ä»¬å°±ä¼šå¾—åˆ°ä¸€ä¸ªç»“æœç±»å‹ç­¾å,å…¶ä¸­åŒ…å«æ— æ„ä¹‰çš„å”¯ä¸€æ–°å˜é‡å’Œä¸€ç»„çº¦æŸ,æˆ‘ä»¬å¿…é¡»è§£å†³è¿™äº›çº¦æŸä»¥å°†ç±»å‹ç»†åŒ–ä¸ºå…¶ä¸»è¦ç±»å‹.\nçº¦æŸç”±ä¸€ä¸ªå•ç‹¬çš„`Solve monad`è§£å†³,è¯¥`monad`åŒ…å«`Unifier`(æœ€å¸¸è§çš„ç»Ÿä¸€)è§£å†³æ–¹æ¡ˆ,å½“åº”ç”¨äºç”Ÿæˆçš„ç­¾åæ—¶,å®ƒå°†äº§ç”Ÿè§£å†³æ–¹æ¡ˆ.\n```\ntype Constraint = (Type, Type)\n\ntype Unifier = (Subst, [Constraint])\n\n-- | Constraint solver monad\ntype Solve a = StateT Unifier (ExceptT TypeError Identity) a\n```\n\nç»Ÿä¸€é€»è¾‘ä¹Ÿä¸ä»¥å‰ç›¸åŒ,é™¤äº†å®ƒç°åœ¨è„±ç¦»æ¨ç†ç‹¬ç«‹ç¼–å†™,å¹¶å°†å…¶éƒ¨åˆ†çŠ¶æ€å­˜å‚¨åœ¨`Solve monad`çš„çŠ¶æ€å±‚å†….\n```\nunifies :: Type -> Type -> Solve Unifier\nunifies t1 t2 | t1 == t2 = return emptyUnifer\nunifies (TVar v) t = v `bind` t\nunifies t (TVar v) = v `bind` t\nunifies (TArr t1 t2) (TArr t3 t4) = unifyMany [t1, t2] [t3, t4]\nunifies t1 t2 = throwError $ UnificationFail t1 t2\n\nunifyMany :: [Type] -> [Type] -> Solve Unifier\nunifyMany [] [] = return emptyUnifer\nunifyMany (t1 : ts1) (t2 : ts2) =\n  do (su1,cs1) <- unifies t1 t2\n     (su2,cs2) <- unifyMany (apply su1 ts1) (apply su1 ts2)\n     return (su2 `compose` su1, cs1 ++ cs2)\nunifyMany t1 t2 = throwError $ UnificationMismatch t1 t2\n```\n```\nThe solver function simply iterates over the set of constraints, composing them and applying the resulting constraint solution over the intermediate solution eventually converting on the most general unifier which yields the final substitution which when applied over the inferred type signature, yields the principal type solution for the expression.\n```\næ±‚è§£å™¨å‡½æ•°ç®€å•åœ°è¿­ä»£çº¦æŸé›†,ç»„åˆå®ƒä»¬å¹¶å°†ç»“æœçº¦æŸè§£å†³æ–¹æ¡ˆåº”ç”¨äºä¸­é—´è§£å†³æ–¹æ¡ˆ,æœ€ç»ˆè½¬æ¢ä¸ºæœ€é€šç”¨çš„ç»Ÿä¸€,äº§ç”Ÿæœ€ç»ˆæ›¿æ¢,å½“åº”ç”¨äºæ¨æ–­ç±»å‹ç­¾åæ—¶,ä¸ºè¡¨è¾¾å¼äº§ç”Ÿä¸»è¦ç±»å‹è§£å†³æ–¹æ¡ˆ.\n\n```\n-- Unification solver\nsolver :: Solve Subst\nsolver = do\n  (su, cs) <- get\n  case cs of\n    [] -> return su\n    ((t1, t2): cs0) -> do\n      (su1, cs1)  <- unifies t1 t2\n      put (su1 `compose` su, cs1 ++ (apply su1 cs0))\n      solver\n```\nè¿™æ˜¯ä¸€ä¸ªæ›´åŠ ä¼˜é›…çš„è§£å†³æ–¹æ¡ˆï¼Œè€Œä¸æ˜¯åœ¨åŒä¸€ä¸ªä¼ é€’ä¸­æ··åˆæ¨ç†å’Œæ±‚è§£ï¼Œå¹¶ä¸”å¾ˆå¥½åœ°é€‚åº”äº†æˆ‘ä»¬å°†åœ¨åé¢çš„ç« èŠ‚ä¸­è®¨è®ºçš„ç±»å‹åŒ–æ ¸å¿ƒå½¢å¼çš„ç”Ÿæˆã€‚\n\n\n\n### Worked Examples\nè®©æˆ‘ä»¬æ¥çœ‹ä¸¤ä¸ªæ¨ç†å¦‚ä½•é€‚ç”¨äºç®€å•å‡½æ•°çš„ä¾‹å­.\n#### ä¾‹å­1\nè€ƒè™‘:\n```\n\\x y z -> x + y + z\n```\n`infer`å‡½æ•°ç”Ÿæˆçš„ç±»å‹åªåŒ…å«æ¯ä¸ªå‚æ•°å’Œè¿”å›ç±»å‹çš„æ–°å˜é‡.\n```\na -> b -> c -> e\n```\nå½“æˆ‘ä»¬éå†ä¸¤ä¸ªåŠ æ³•è¿ç®—æ—¶ï¼Œå‘å‡ºç”±T-BinOpå¼•èµ·çš„çº¦æŸ.\n```\n1. a -> b -> d ~ Int -> Int -> Int\n2. d -> c -> e ~ Int -> Int -> Int\n```\nè¿™é‡Œ`d`æ˜¯ä¸­é—´é¡¹`x + y`çš„ç±»å‹.é€šè¿‡åº”ç”¨`Uni-Arrow`,æˆ‘ä»¬å¯ä»¥æ¨å¯¼å‡ºä»¥ä¸‹ä¸€ç»„æ›¿æ¢.\n```\n1. a ~ Int\n2. b ~ Int\n3. c ~ Int\n4. d ~ Int\n5. e ~ Int\n```\nå°†æ­¤è§£å†³æ–¹æ¡ˆæ›¿æ¢å›ç±»å‹ä¼šäº§ç”Ÿæ¨æ–­ç±»å‹:\n```\nInt -> Int -> Int -> Int\n```\n\n#### ä¾‹å­2\n```\ncompose f g x = f (g x)\n```\næ¨æ–­å‡½æ•°ç”Ÿæˆçš„ç±»å‹ä»…åŒ…å«å”¯ä¸€çš„æ–°å˜é‡.\n```\na -> b -> c -> e\n```\nç”±ä¸¤ä¸ªT-Appè§„åˆ™å¼•èµ·çš„æˆ‘ä»¬å¾—åˆ°ä»¥ä¸‹çº¦æŸ:\n```\n1. b ~ c -> d\n2. a ~ d -> e\n```\nè¿™é‡Œ`d`æ˜¯`(g x)`çš„ç±»å‹,çº¦æŸå·²ç»æ˜¯è§„èŒƒå½¢å¼,é€šè¿‡åº”ç”¨`Uni-VarLeft`ä¸¤æ¬¡,æˆ‘ä»¬å¾—åˆ°ä»¥ä¸‹ä¸€ç»„æ›¿æ¢:\n```\n1. b ~ c -> d\n2. a ~ d -> e\n```\næ‰€ä»¥æˆ‘ä»¬å¾—åˆ°è¿™ç§ç±»å‹:\n```\ncompose :: forall c d e. (d -> e) -> (c -> d) -> c -> e\n```\nå¦‚æœéœ€è¦ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰å­—æ¯é¡ºåºé‡å‘½åå˜é‡ä»¥è·å¾—:\n```\ncompose :: forall a b c. (a -> b) -> (c -> a) -> c -> b\n```\n\n### Interpreter\næˆ‘ä»¬çš„æ±‚å€¼ç¨‹åºå°†ç›´æ¥åœ¨è¯­æ³•ä¸Šè¿è¡Œï¼Œå¹¶å°†ç»“æœè®¡ç®—ä¸º`Value`ç±»å‹.\n```\ndata Value\n  = VInt Integer\n  | VBool Bool\n  | VClosure String Expr TermEnv\n```\nè§£é‡Šå™¨è®¾ç½®ä¸º`Identity monad`,åé¢å®ƒå°†æˆä¸ºä¸€ä¸ªæ›´å¤æ‚çš„`monad`,ä½†ç°åœ¨å®ƒå¾ˆç®€å•.å€¼(`value`)ç¯å¢ƒå°†æ˜¾å¼åœ°çº¿ç¨‹åŒ–,å¹¶ä¸”æ¯å½“åˆ›å»ºé—­åŒ…æ—¶,æˆ‘ä»¬åªéœ€åœ¨é—­åŒ…ä¸­å­˜å‚¨æœ¬åœ°ç¯å¢ƒçš„å‰¯æœ¬.\n```\ntype TermEnv = Map.Map String Value\ntype Interpreter t = Identity t\n```\næˆ‘ä»¬çš„è®¡ç®—é€»è¾‘æ˜¯ä¸Šä¸€ç« å®ç°çš„lambdaæ¼”ç®—æ±‚å€¼å™¨çš„æ‰©å±•.\nç„¶è€Œï¼Œæ‚¨å¯èƒ½ä¼šæ³¨æ„åˆ°åœ¨æ•´ä¸ªè¯„ä¼°è¿‡ç¨‹ä¸­ä½¿ç”¨äº†è®¸å¤šä¸å®Œæ•´çš„æ¨¡å¼.\nä¸è¿‡ä¸è¦å®³æ€•,æˆ‘ä»¬çš„ç¨‹åºè¯„ä¼°ä¸ä¼š\"å‡ºé”™\".\nè¿™äº›æ¨¡å¼ä¸­çš„æ¯ä¸€ä¸ªéƒ½ä»£è¡¨äº†æˆ‘ä»¬çš„ç±»å‹ç³»ç»Ÿä¿è¯æ°¸è¿œä¸ä¼šå‘ç”Ÿçš„ä¸€ç§çŠ¶æ€.\nä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬çš„ç¨‹åºæ²¡æœ‰åœ¨ä½œç”¨åŸŸä¸­å¼•ç”¨æ¯ä¸ªå˜é‡,é‚£ä¹ˆå®ƒå°†æ°¸è¿œä¸ä¼šè¾¾åˆ°å¼€å§‹æ—¶çš„æ±‚å€¼,å¹¶ä¸”å°†åœ¨ç±»å‹æ£€æŸ¥å™¨ä¸­è¢«æ‹’ç»,æˆ‘ä»¬åœ¨è¿™é‡Œä½¿ç”¨ä¸å®Œæ•´çš„æ¨¡å¼åœ¨é“ä¹‰ä¸Šæ˜¯æ­£ç¡®çš„!\t\n```\neval :: TermEnv -> Expr -> Interpreter Value\neval env expr = case expr of\n  Lit (LInt k)  -> return $ VInt k\n  Lit (LBool k) -> return $ VBool k\n\n  Var x -> do\n    let Just v = Map.lookup x env\n    return v\n\n  Op op a b -> do\n    VInt a' <- eval env a\n    VInt b' <- eval env b\n    return $ (binop op) a' b'\n\n  Lam x body -> \n    return (VClosure x body env)\n\n  App fun arg -> do\n    VClosure x body clo <- eval env fun\n    argv <- eval env arg\n    let nenv = Map.insert x argv clo\n    eval nenv body\n\n  Let x e body -> do\n    e' <- eval env e\n    let nenv = Map.insert x e' env\n    eval nenv body\n\n  If cond tr fl -> do\n    VBool br <- eval env cond\n    if br == True\n    then eval env tr\n    else eval env fl\n\n  Fix e -> do\n    eval env (App e (Fix e))\n\nbinop :: Binop -> Integer -> Integer -> Value\nbinop Add a b = VInt $ a + b\nbinop Mul a b = VInt $ a * b\nbinop Sub a b = VInt $ a - b\nbinop Eql a b = VBool $ a == b\n```\n\n\n### Interactive Shell\næˆ‘ä»¬çš„è¯­è¨€ç°åœ¨å·²ç»æˆé•¿ä¸ºæˆ‘ä»¬ä¹‹å‰ä½¿ç”¨è¿‡çš„å°å‹`shell`,ç°åœ¨æˆ‘ä»¬éœ€è¦æ›´å¼ºå¤§çš„ä¸œè¥¿æ¥ä¿æŒæˆ‘ä»¬çš„äº¤äº’å¼è§£é‡Šå™¨çš„é€»è¾‘.\n```\ndata IState = IState\n  { tyctx :: TypeEnv  -- Type environment\n  , tmctx :: TermEnv  -- Value environment\n  }\n\ninitState :: IState\ninitState = IState emptyTyenv emptyTmenv\n\ntype Repl a = HaskelineT (StateT IState IO) a\n\nhoistErr :: Show e => Either e a -> Repl a\nhoistErr (Right val) = return val\nhoistErr (Left err) = do\n  liftIO $ print err\n  abort\n```\næˆ‘ä»¬çš„è¯­è¨€å¯ä»¥ç”±`GHC`ç¼–è¯‘æˆç‹¬ç«‹çš„äºŒè¿›åˆ¶æ–‡ä»¶:\n```\n$ ghc --make Main.hs -o poly\n$ ./poly\nPoly>\n```\nåœ¨æˆ‘ä»¬ç¨‹åºçš„é¡¶éƒ¨ï¼Œæˆ‘ä»¬å°†æŸ¥çœ‹å‘½ä»¤é€‰é¡¹å¹¶å…è®¸ä¸‰ç§å‘½ä»¤å˜ä½“:\n```\n$ poly                # launch shell\n$ poly input.ml       # launch shell with 'input.ml' loaded\n$ poly test input.ml  # dump test for 'input.ml' to stdout\n```\n```\nmain :: IO ()\nmain = do\n  args <- getArgs\n  case args of\n    []      -> shell (return ())\n    [fname] -> shell (load [fname])\n    [\"test\", fname] -> shell (load [fname] >> browse [] >> quit ())\n    _ -> putStrLn \"invalid arguments\"\n```\n`shell`å‘½ä»¤éœ€è¦ä¸€ä¸ª`pre`åŠ¨ä½œ,è¯¥åŠ¨ä½œåœ¨`shell`å¯åŠ¨ä¹‹å‰è¿è¡Œ,é€»è¾‘ç®€å•åœ°å°†æˆ‘ä»¬çš„`Repl monad`è¯„ä¼°ä¸º`IO`å¹¶ä»`main`å‡½æ•°è¿è¡Œå®ƒ.\n```\nshell :: Repl a -> IO ()\nshell pre\n  = flip evalStateT initState\n  $ evalRepl \"Poly> \" cmd options completer pre\n```\n`cmd`é©±åŠ¨ç¨‹åºæ˜¯æˆ‘ä»¬ç¨‹åºçš„ä¸»è¦å…¥å£ç‚¹,æ¯æ¬¡ç”¨æˆ·è¾“å…¥ä¸€è¡Œè¾“å…¥æ—¶éƒ½ä¼šæ‰§è¡Œå®ƒ,ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç”¨æˆ·è¾“å…¥è¡Œ.\n```\ncmd :: String -> Repl ()\ncmd source = exec True (L.pack source)\n```\nç„¶åï¼Œæˆ‘ä»¬çš„è¯­è¨€çš„æ ¸å¿ƒæ˜¯`exec`å‡½æ•°ï¼Œå®ƒå¯¼å…¥æ‰€æœ‰ç¼–è¯‘å™¨ä¼ é€’çš„ä¿¡æ¯ï¼Œç„¶åæŒ‰é¡ºåºçº¿ç¨‹åŒ–è¾“å…¥å’Œè¾“å‡ºï¼Œæœ€ç»ˆç”Ÿæˆä¸€ä¸ªç»“æœç±»å‹ç¯å¢ƒå’Œç¨‹åºçš„è¯„ä¼°ç»“æœã€‚å®ƒä»¬è¢«`monoidally`è¿æ¥åˆ°è§£é‡Šå™¨çš„çŠ¶æ€ä¸­ï¼Œç„¶åå¾ªç¯äº§ç”Ÿä¸‹ä¸€ç»„è¾“å…¥.\n```\nexec :: Bool -> L.Text -> Repl ()\nexec update source = do\n  -- Get the current interpreter state\n  st <- get\n\n  -- Parser ( returns AST )\n  mod <- hoistErr $ parseModule \"<stdin>\" source\n\n  -- Type Inference ( returns Typing Environment )\n  tyctx' <- hoistErr $ inferTop (tyctx st) mod\n\n  -- Create the new environment\n  let st' = st { tmctx = foldl' evalDef (tmctx st) mod\n               , tyctx = tyctx' <> (tyctx st)\n               }\n\n  -- Update the interpreter state\n  when update (put st')\n```\n`Repline`è¿˜æ”¯æŒæ·»åŠ ç‰¹å®šçš„å¥—æ¥å­—è¾“å…¥é›†ï¼Œä»¥ä¾¿å°†å®ƒä»¬æ˜ å°„åˆ°ç¼–è¯‘å™¨ä¸­çš„å†…ç½®å‘½ä»¤ã€‚æˆ‘ä»¬å°†å®ç°å…¶ä¸­ä¸‰ä¸ªã€‚\n```\nCommand\tAction\n:browse\t\tBrowse the type signatures for a program\n:load <file>\tLoad a program from file\n:type\t\tShow the type of an expression\n:quit\t\tExit interpreter\n```\nå®ƒä»¬çš„å®ç°å¤§å¤šå¾ˆç®€å•ã€‚\n```\noptions :: [(String, [String] -> Repl ())]\noptions = [\n    (\"load\"   , load)\n  , (\"browse\" , browse)\n  , (\"quit\"   , quit)\n  , (\"type\"   , Main.typeof)\n  ]\n\n-- :browse command\nbrowse :: [String] -> Repl ()\nbrowse _ = do\n  st <- get\n  liftIO $ mapM_ putStrLn $ ppenv (tyctx st)\n\n-- :load command\nload :: [String] -> Repl ()\nload args = do\n  contents <- liftIO $ L.readFile (unwords args)\n  exec True contents\n\n-- :type command\ntypeof :: [String] -> Repl ()\ntypeof args = do\n  st <- get\n  let arg = unwords args\n  case Infer.typeof (tyctx st) arg of\n    Just val -> liftIO $ putStrLn $ ppsignature (arg, val)\n    Nothing -> exec False (L.pack arg)\n\n-- :quit command\nquit :: a -> Repl ()\nquit _ = liftIO $ exitSuccess\n```\næœ€åï¼Œ`shell`çš„`tab`è¡¥å…¨å°†ä½¿ç”¨è§£é‡Šå™¨çš„ç±»å‹ç¯å¢ƒ`key`åœ¨ä¸€ç»„æœ¬åœ°å®šä¹‰çš„å˜é‡ä¸Šå®Œæˆã€‚`Repline`æ”¯æŒåŸºäºå‰ç¼€çš„`tab`å®Œæˆï¼Œå…¶ä¸­å°†ä½¿ç”¨å½“å‰å‘½ä»¤çš„å‰ç¼€æ¥ç¡®å®šè¦æ‰§è¡Œå“ªäº›`tab`å®Œæˆã€‚\nåœ¨æˆ‘ä»¬ä»¥`command:load`å¼€å¤´çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†ç›´æ¥åœ¨å½“å‰å·¥ä½œçš„æ–‡ä»¶åä¸Š`tab`å®Œæˆã€‚\n```\ncompleter :: CompleterStyle (StateT IState IO)\ncompleter = Prefix (wordCompleter comp) defaultMatcher\n\n-- Prefix tab completer\ndefaultMatcher :: MonadIO m => [(String, CompletionFunc m)]\ndefaultMatcher = [\n    (\":load\"  , fileCompleter)\n  ]\n\n-- Default tab completer\ncomp :: (Monad m, MonadState IState m) => WordCompleter m\ncomp n = do\n  let cmds = [\":load\", \":browse\", \":quit\", \":type\"]\n  TypeEnv ctx <- gets tyctx\n  let defs = Map.keys ctx\n  return $ filter (isPrefixOf n) (cmds ++ defs)\n```\n\n### Observations (æ„è§)\næˆ‘ä»¬æœ‰å®ƒï¼Œæˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªå°å‹æ¨æ–­è¯­è¨€ï¼\né€šè¿‡è¿è¡Œ`ghci Main.hs`åŠ è½½`poly`è§£é‡Šå™¨å¹¶è°ƒç”¨`main`å‡½æ•°ã€‚\n```\n$ ghci Main.hs\nÎ»: main\nPoly> :load test.ml\nPoly> :browse\n```\né€šè¿‡åœ¨ç¨‹åºçš„`toplevel`å£°æ˜ä¸€äº›å‡½æ•°æ¥å°è¯•ä¸€äº›ç®€å•çš„ä¾‹å­ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`:type`å‘½ä»¤ä»¥äº¤äº’æ–¹å¼æŸ¥è¯¢è¡¨è¾¾å¼çš„ç±»å‹ï¼Œè¯¥å‘½ä»¤å®é™…ä¸Šåªæ˜¯åœ¨ç®¡é“ä¸­é€”è¿è¡Œè¡¨è¾¾å¼å¹¶åœ¨ç±»å‹æ£€æŸ¥ååœæ­¢ã€‚\n```\nPoly> let id x = x\nPoly> let const x y = x\nPoly> let twice x = x + x\n\nPoly> :type id\nid : forall a. a -> a\n\nPoly> :type const\nconst : forall a b. a -> b -> a\n\nPoly> :type twice\ntwice : Int -> Int\n```\næ³¨æ„å‡ ä¸ªé‡è¦çš„äº‹å®ã€‚\næˆ‘ä»¬çš„ç±»å‹æ£€æŸ¥å™¨ç°åœ¨å°†åœ¨è§£é‡Šä¹‹å‰å°†æˆ‘ä»¬çš„æ‹’ç»ç¨‹åºä¸èŒƒå›´é”™è¯¯ç›¸å…³è”ã€‚\n```\nPoly> \\x -> y\nNot in scope: \"y\"\n```\næ­¤å¤–ï¼Œé‚£äº›ç±»å‹ä¸å¤ªå¥½çš„ç¨‹åºç°åœ¨ä¹Ÿä¼šè¢«ç›´æ¥æ‹’ç».\n```\nPoly> 1 + True\nCannot unify types: \n    Bool\nwith \n    Int\n```\n`omega`ç»„åˆå­å°†æ— æ³•é€šè¿‡`occurs`æ£€æŸ¥:\n```\nPoly> \\x -> x x\nCannot construct the the infinite type: a = a -> b\n```\n`test.ml`æ–‡ä»¶æä¾›äº†å¯¹å°è§£é‡Šå™¨çš„å„ç§æµ‹è¯•. ä¾‹å¦‚,`fact`å’Œ`fib`å‡½æ•°éƒ½ä½¿ç”¨`fixpoint`æ¥è®¡ç®—`Fibonacci`æ•°æˆ–é˜¶ä¹˜ã€‚\n```\nlet fact = fix (\\fact -> \\n -> \n  if (n == 0) \n    then 1 \n    else (n * (fact (n-1))));\n\nlet rec fib n = \n  if (n == 0) \n    then 0\n    else if (n==1) \n      then 1\n      else ((fib (n-1)) + (fib (n-2)));\nPoly> :type fact\nfact : Int -> Int\n\nPoly> fact 5\n120\n\nPoly> fib 16\n610\n```\n\n\n\n"},{"title":"Haskellçš„è‡ªåŠ¨åŒ–æµ‹è¯•å·¥å…·-QuickCheck","url":"/blog/2019/08/07/Haskellçš„è‡ªåŠ¨åŒ–æµ‹è¯•å·¥å…·-QuickCheck/","content":"> [åŸæ–‡åœ°å€](http://www.cse.chalmers.se/~rjmh/QuickCheck/manual.html)\n### QuickCheckæ˜¯ä»€ä¹ˆ\n`QuickCheck`æ˜¯ä¸€ç§è‡ªåŠ¨æµ‹è¯•`Haskell`ç¨‹åºçš„å·¥å…·ã€‚ç¨‹åºå‘˜ä»¥`å‡½æ•°åº”æ»¡è¶³å“ªäº›å±æ€§`çš„å½¢å¼æä¾›ç¨‹åºçš„è§„èŒƒï¼Œç„¶åï¼Œ`QuickCheck`æµ‹è¯•è¿™äº›å±æ€§æ˜¯å¦å­˜åœ¨äºå¤§é‡éšæœºç”Ÿæˆçš„æ¡ˆä¾‹ä¸­ã€‚\nè§„èŒƒåœ¨`Haskell`ä¸­ä½¿ç”¨`QuickCheck`åº“ä¸­å®šä¹‰çš„ç»„åˆå™¨æ¥è¡¨ç¤ºã€‚`QuickCheck`æä¾›ç»„åˆå™¨æ¥å®šä¹‰å±æ€§ï¼Œè§‚å¯Ÿæµ‹è¯•æ•°æ®çš„åˆ†å¸ƒï¼Œå¹¶å®šä¹‰æµ‹è¯•æ•°æ®ç”Ÿæˆå™¨ã€‚\n\n### ä¸€ä¸ªç®€å•çš„ä¾‹å­\nä¸€ä¸ªç®€å•çš„å±æ€§å®šä¹‰ç¤ºä¾‹æ˜¯ï¼š\n```\nprop_RevRev xs = reverse (reverse xs) == xs\n  where types = xs::[Int]\n```\nè¦æ£€æŸ¥è¯¥å±æ€§ï¼Œæˆ‘ä»¬éœ€è¦å°†æ­¤å®šä¹‰åŠ è½½åˆ°`hugs`ä¸­ï¼Œç„¶åè°ƒç”¨:\n```\nMain> quickCheck prop_RevRev\nOK, passed 100 tests.\n```\nå½“å±æ€§å¤±è´¥æ—¶ï¼Œ`QuickCheck`ä¼šæ˜¾ç¤ºå‡ºä¸€ä¸ªåä¾‹ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬å®šä¹‰:\n```\nprop_RevId xs = reverse xs == xs\n  where types = xs::[Int]\n```\nç„¶åæ£€æŸ¥å®ƒçš„ç»“æœ:\n```\nMain> quickCheck prop_RevId\nFalsifiable, after 1 tests:\n[-3,15]\n```\n\n### ä½¿ç”¨QuickCheck\nè¦ä½¿ç”¨`QuickCheck`ï¼Œæ‚¨å¿…é¡»ä¸‹è½½æ¨¡å—`QuickCheck.hs`ï¼Œæœ€å¥½è¿˜æ˜¯è„šæœ¬`quickCheck`ã€‚å°†æ¨¡å—`QuickCheck`å¯¼å…¥åˆ°åŒ…å«è§„èŒƒæˆ–æµ‹è¯•æ•°æ®ç”Ÿæˆå™¨çš„æ¯ä¸ªæ¨¡å—ä¸­ã€‚ç„¶åï¼Œæ‚¨å¯ä»¥é€šè¿‡å°†å®šä¹‰çš„æ¨¡å—åŠ è½½åˆ°`hugs`ä¸­å¹¶è°ƒç”¨å®ƒæ¥æµ‹è¯•å±æ€§:\n```\nquickCheck <property-name>\n```\næˆ–è€…é€šè¿‡è¿è¡Œè„šæœ¬:\n```\n> quickCheck <options> <file names>\n```\nå®ƒæ£€æŸ¥ç»™å®šæ¨¡å—ä¸­å®šä¹‰çš„æ¯ä¸ªå±æ€§ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä¸`hugs`ç›¸åŒçš„å‘½ä»¤è¡Œé€‰é¡¹ã€‚\nä½ ä¸éœ€è¦ä½¿ç”¨`hugs`æ¥æ£€æŸ¥å±æ€§: ä»»ä½•`Haskell 98`å®ç°éƒ½åº”è¯¥è¶³å¤Ÿäº†ã€‚ä½†æ˜¯, `quickCheck`è„šæœ¬å‡å®šæ‚¨çš„ç³»ç»Ÿä¸Šå®‰è£…äº†`hugs`ã€‚æ‚¨å¯èƒ½éœ€è¦ç¼–è¾‘è„šæœ¬ä»¥æ’å…¥`runhugs`çš„ä½ç½®ã€‚\n\n#### å¦‚ä½•åˆ¤æ–­æ­£åœ¨æµ‹è¯•å“ªä¸ªå±æ€§ï¼Ÿ\næŸäº›ç‰ˆæœ¬çš„`hugs`åœ¨è¯„ä¼°ä¹‹å‰ä¼šæ˜¾ç¤ºè¦è¯„ä¼°çš„è¡¨è¾¾å¼; å› æ­¤ï¼Œæ‚¨å¯ä»¥éšæ—¶æŸ¥çœ‹æ­£åœ¨æ£€æŸ¥çš„å±æ€§ï¼Œä»¥åŠå“ªä¸ªå±æ€§å¤±è´¥ã€‚å¦‚æœæ‚¨çš„æ‹¥æŠ±ç‰ˆæœ¬æ²¡æœ‰è¿™æ ·åšï¼Œè¯·ç»™`quickCheck`æä¾›`+names`æ ‡è¯†:\n```\n  > quickCheck + names <options> <file names>\n```\nè¿™æ ·å®ƒåœ¨æ£€æŸ¥ä¹‹å‰å°†æ‰“å°æ¯ä¸ªå±æ€§åç§°ã€‚\n\n#### å¦‚æœæµ‹è¯•å¾ªç¯æˆ–é‡åˆ°é”™è¯¯ï¼Œæˆ‘è¯¥æ€ä¹ˆåŠï¼Ÿ\nåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çŸ¥é“è¯¥å±æ€§ä¸æˆç«‹ï¼Œä½†æ˜¯`quickCheck`æ²¡æœ‰æ˜¾ç¤ºåä¾‹ã€‚æˆ‘ä»¬ä¸ºè¿™ç§æƒ…å†µæä¾›äº†å¦ä¸€ç§æµ‹è¯•åŠŸèƒ½ã€‚ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿›è¡Œé‡å¤æµ‹è¯•:\n```\n  verboseCheck <property-name>\n```\nåœ¨è¿è¡Œæµ‹è¯•ä¹‹å‰æ˜¾ç¤ºæ¯ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼šæ˜¾ç¤ºçš„æœ€åä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹æ˜¯å‡ºç°å¾ªç¯æˆ–é”™è¯¯çš„æµ‹è¯•ç”¨ä¾‹ã€‚\n\n### å±æ€§\nå±æ€§è¡¨ç¤ºä¸º`Haskell`å‡½æ•°å®šä¹‰ï¼Œåç§°ä»¥`prop_`å¼€å¤´ã€‚å±æ€§é€šè¿‡å…¶å‚æ•°è¿›è¡Œæ™®éé‡åŒ–ï¼Œå› æ­¤:\n```\nprop_RevRev xs = reverse (reverse xs) == xs\n  where types = xs :: [Int]\n```\nè¡¨ç¤ºæ‰€æœ‰åˆ—è¡¨xsçš„ç­‰å¼æˆç«‹(ä¹Ÿå°±æ˜¯è¯´,æ‰€æœ‰æœ‰é™çš„,æ€»çš„åˆ—è¡¨)ã€‚\nå±æ€§å¿…é¡»å…·æœ‰å•æ€ç±»å‹ã€‚`å¤šæ€`å±æ€§ï¼ˆä¾‹å¦‚ä¸Šé¢çš„å±æ€§ï¼‰å¿…é¡»é™åˆ¶ä¸ºç”¨äºæµ‹è¯•çš„ç‰¹å®šç±»å‹ã€‚é€šè¿‡åœ¨é™ˆè¿°å­å¥ä¸­å£°æ˜ä¸€ä¸ªæˆ–å¤šä¸ªå‚æ•°çš„ç±»å‹æ˜¯å¾ˆæ–¹ä¾¿çš„:\n```\n  where types = (x1 :: t1, x2 :: t2, ...)\n```\nè¯·æ³¨æ„ï¼Œ`types`ä¸æ˜¯å…³é”®å­—; è¿™åªæ˜¯ä¸€ä¸ªæœ¬åœ°å£°æ˜ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªæ–¹ä¾¿çš„åœ°æ–¹æ¥é™åˆ¶`x1,x2`ç­‰çš„ç±»å‹ã€‚\né™¤éä½¿ç”¨ä¸‹é¢çš„å…¶ä»–ç»„åˆå™¨å®šä¹‰å±æ€§ï¼Œå¦åˆ™å±æ€§çš„ç»“æœåº”ä¸º`Bool`ç±»å‹ã€‚\n\n#### æ¡ä»¶å±æ€§\nå±æ€§å¯ä»¥é‡‡å–å¦‚ä¸‹å½¢å¼:\n```\n  <condition> ==> <property>\n```\nä¾‹å¦‚:\n```\nordered xs = and (zipWith (<=) xs (drop 1 xs))\ninsert x xs = takeWhile (<x) xs++[x]++dropWhile (<x) xs\n\nprop_Insert x xs = ordered xs ==> ordered (insert x xs)\n  where types = x::Int\n```\nå¦‚æœæ¡ä»¶ç¡®å®å­˜åœ¨`==>`ä¹‹åçš„å±æ€§ï¼Œåˆ™æ­¤å±æ€§æˆç«‹ã€‚\næµ‹è¯•ä¸¢å¼ƒä¸æ»¡è¶³æ¡ä»¶çš„æµ‹è¯•ç”¨ä¾‹ã€‚\næµ‹è¯•ç”¨ä¾‹ç”Ÿæˆç»§ç»­ï¼Œç›´åˆ°æ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„100ä¸ªæ¡ˆä¾‹ï¼Œæˆ–è€…ç›´åˆ°è¾¾åˆ°æµ‹è¯•ç”¨ä¾‹æ•°é‡çš„æ€»ä½“é™åˆ¶ï¼ˆå¦‚æœæ¡ä»¶æ°¸è¿œä¸æˆç«‹åˆ™é¿å…å¾ªç¯ï¼‰ã€‚\nåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä»¥ä¸‹æ¶ˆæ¯\n```\nArguments exhausted after 97 tests.\n```\nè¡¨æ˜æ»¡è¶³è¯¥æ¡ä»¶çš„97ä¸ªæµ‹è¯•ç”¨ä¾‹è¢«å‘ç°ï¼Œå¹¶ä¸”è¯¥å±æ€§ä¿ç•™åœ¨è¿™97ä¸ªæ¡ˆä¾‹ä¸­ã€‚\n\n#### é‡åŒ–å±æ€§\nå±æ€§å¯ä»¥é‡‡å–å¦‚ä¸‹å½¢å¼:\n```\nforAll <generator> $ \\<pattern> -> <property>\n```\nä¾‹å¦‚:\n```\nprop_Insert2 x = forAll orderedList $ \\xs -> ordered (insert x xs)\n  where types = x::Int \n```\n`forAll`çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æµ‹è¯•æ•°æ®ç”Ÿæˆå™¨; é€šè¿‡æä¾›è‡ªå®šä¹‰ç”Ÿæˆå™¨ï¼Œè€Œä¸æ˜¯ä½¿ç”¨è¯¥ç±»å‹çš„é»˜è®¤ç”Ÿæˆå™¨ï¼Œå¯ä»¥æ§åˆ¶æµ‹è¯•æ•°æ®çš„åˆ†å¸ƒã€‚\nåœ¨ç¤ºä¾‹ä¸­ï¼Œé€šè¿‡ä¸ºæœ‰åºåˆ—è¡¨æä¾›è‡ªå®šä¹‰ç”Ÿæˆå™¨ï¼Œè€Œä¸æ˜¯è¿‡æ»¤æ‰æœªæ’åºçš„æµ‹è¯•ç”¨ä¾‹ï¼Œ\næˆ‘ä»¬ä¿è¯åœ¨ä¸è¾¾åˆ°æµ‹è¯•ç”¨ä¾‹æ€»ä½“é™åˆ¶çš„æƒ…å†µä¸‹å¯ä»¥ç”Ÿæˆ100ä¸ªæµ‹è¯•ç”¨ä¾‹ã€‚\nä¸‹é¢çš„æè¿°ç”¨äºå®šä¹‰ç”Ÿæˆå™¨çš„ç»„åˆå™¨ã€‚\n\n### è§‚å¯Ÿæµ‹è¯•ç”¨ä¾‹åˆ†å¸ƒ\nè§‚å¯Ÿæµ‹è¯•ç”¨ä¾‹çš„åˆ†å¸ƒæ˜¯éå¸¸é‡è¦çš„ï¼šå¦‚æœæµ‹è¯•æ•°æ®åˆ†å¸ƒä¸å‡åŒ€ï¼Œé‚£ä¹ˆä»æµ‹è¯•ç»“æœä¸­å¾—å‡ºçš„ç»“è®ºå¯èƒ½æ˜¯æ— æ•ˆçš„ã€‚ç‰¹åˆ«æ˜¯ï¼Œ`==>`è¿ç®—ç¬¦ä¼šä¸¥é‡æ‰­æ›²æµ‹è¯•æ•°æ®çš„åˆ†å¸ƒï¼Œå› ä¸ºåªä½¿ç”¨æ»¡è¶³ç»™å®šæ¡ä»¶çš„æµ‹è¯•æ•°æ®ã€‚\n`QuickCheck`æä¾›äº†å‡ ç§è§‚å¯Ÿæµ‹è¯•æ•°æ®åˆ†å¸ƒçš„æ–¹æ³•ã€‚åˆ¶ä½œè§‚å¯Ÿçš„å®ˆåˆ™å·²çº³å…¥åˆ°å±æ€§å£°æ˜ä¸­ï¼Œ\næ¯æ¬¡å®é™…æµ‹è¯•è¯¥å±æ€§æ—¶ï¼Œè¿›è¡Œè§‚å¯Ÿï¼Œç„¶ååœ¨æµ‹è¯•å®Œæˆæ—¶æ±‡æ€»æ‰€æ”¶é›†çš„è§‚å¯Ÿç»“æœã€‚\n\n#### è®¡ç®—çç¢çš„æ¡ˆä¾‹\nå±æ€§å¯ä»¥é‡‡å–å¦‚ä¸‹å½¢å¼:\n```\n   <condition> `trivial` <property>\n```\nä¾‹å¦‚:\n```\nprop_Insert x xs = ordered xs ==> null xs `trivial` ordered (insert x xs)\n  where types = x::Int\n```\næ¡ä»¶ä¸ºTrueçš„æµ‹è¯•ç”¨ä¾‹è¢«å½’ç±»ä¸ºçç¢çš„ï¼Œå¹¶ä¸”æŠ¥å‘Šäº†æ€»æ•°ä¸­çš„çç¢æµ‹è¯•ç”¨ä¾‹çš„æ¯”ä¾‹ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæµ‹è¯•äº§ç”Ÿ\n```\nMain> quickCheck prop_Insert\nOK, passed 100 tests (58% trivial).\n```\n#### æµ‹è¯•ç”¨ä¾‹åˆ†ç±»\nå±æ€§å¯ä»¥é‡‡å–å¦‚ä¸‹å½¢å¼:\n```\n  classify <condition> <string>$ <property>\n```\nä¾‹å¦‚:\n```\nprop_Insert x xs = \n\tordered xs ==> \n\t\tclassify (ordered (x:xs)) \"at-head\"$\n \t\tclassify (ordered (xs++[x])) \"at-tail\"$\n\t\tordered (insert x xs)\n  where types = x::Int\n```\næ»¡è¶³æ¡ä»¶çš„æµ‹è¯•ç”¨ä¾‹è¢«èµ‹äºˆç»™å®šçš„åˆ†ç±»ï¼Œå¹¶ä¸”åœ¨æµ‹è¯•ä¹‹åæŠ¥å‘Šåˆ†ç±»çš„åˆ†å¸ƒã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç»“æœæ˜¯\n```\nMain> quickCheck prop_Insert\nOK, passed 100 tests.\n58% at-head, at-tail.\n22% at-tail.\n4% at-head.\n```\nè¯·æ³¨æ„ï¼Œæµ‹è¯•ç”¨ä¾‹å¯èƒ½å±äºå¤šä¸ªåˆ†ç±»ã€‚\n\n#### æ”¶é›†æ•°æ®å€¼\nå±æ€§å¯ä»¥é‡‡å–å¦‚ä¸‹å½¢å¼:\n```\ncollect <expression>$ <property>\n```\nä¾‹å¦‚:\n```\nprop_Insert x xs = \n\tordered xs ==> collect (length xs)$\n\t\t       ordered (insert x xs)\n  where types = x::Int\n```\nåœ¨æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹ä¸­è¯„ä¼°`collect`çš„å‚æ•°ï¼Œå¹¶æŠ¥å‘Šå€¼çš„åˆ†å¸ƒã€‚æ­¤å‚æ•°çš„ç±»å‹å¿…é¡»ä½äº`Show`ç±»ä¸­ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œè¾“å‡ºæ˜¯:\n```\nMain> quickCheck prop_Insert\nOK, passed 100 tests.\n58% 0.\n26% 1.\n13% 2.\n3% 3.\n```\n\n#### åˆå¹¶è§‚å¯Ÿ\nè¿™é‡Œæè¿°çš„è§‚å¯Ÿç»“æœå¯ä»¥ä»¥ä»»ä½•æ–¹å¼ç»„åˆã€‚å°†æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹çš„æ‰€æœ‰è§‚å¯Ÿç»“åˆèµ·æ¥ï¼Œå¹¶æŠ¥å‘Šè¿™äº›ç»„åˆçš„åˆ†å¸ƒã€‚ä¾‹å¦‚ï¼Œæµ‹è¯•å±æ€§:\n```\nrop_Insert x xs = \n\tordered xs ==> \n\t\tcollect (length xs)$\n\t\tclassify (ordered (x:xs)) \"at-head\"$\n \t\tclassify (ordered (xs++[x])) \"at-tail\"$\n\t\tordered (insert x xs)\n  where types = x::Int\n```\nå°†ä¼šäº§ç”Ÿ:\n```\nMain> quickCheck prop_Insert\nOK, passed 100 tests.\n58% 0, at-head, at-tail.\n22% 1, at-tail.\n13% 2.\n4% 1, at-head.\n3% 3.\n```\nä»ä¸­å¯ä»¥çœ‹å‡ºï¼Œåˆ—è¡¨å¤´éƒ¨æˆ–ç»“å°¾çš„æ’å…¥å°šæœªé’ˆå¯¹é•¿åº¦å¤šäºä¸€ä¸ªå…ƒç´ çš„åˆ—è¡¨è¿›è¡Œæµ‹è¯•ã€‚\n\n### æµ‹è¯•æ•°æ®ç”Ÿæˆå™¨: ç±»å‹Gen\næµ‹è¯•æ•°æ®ç”±æµ‹è¯•æ•°æ®ç”Ÿæˆå™¨ç”Ÿæˆã€‚`QuickCheck`ä¸ºå¤§å¤šæ•°ç±»å‹å®šä¹‰äº†é»˜è®¤ç”Ÿæˆå™¨ï¼Œä½†æ˜¯ä½ å¯ä»¥é€šè¿‡`forAll`ä½¿ç”¨è‡ªå·±çš„ç”Ÿæˆå™¨ï¼Œå¹¶ä¸”éœ€è¦ä¸ºä½ å¼•å…¥çš„ä»»ä½•æ–°ç±»å‹å®šä¹‰è‡ªå·±çš„ç”Ÿæˆå™¨ã€‚\nç”Ÿæˆå™¨å…·æœ‰`Gen a`å½¢å¼çš„ç±»å‹; è¿™æ˜¯`a`ç±»å‹å€¼çš„ç”Ÿæˆå™¨ã€‚`Gen`ç±»å‹æ˜¯`monad`ï¼Œå› æ­¤`Haskell`çš„`do`è¯­æ³•å’Œæ ‡å‡†`monadic`å‡½æ•°å¯ç”¨äºå®šä¹‰ç”Ÿæˆå™¨ã€‚\nç”Ÿæˆå™¨å»ºç«‹åœ¨ä»¥ä¸‹å‡½æ•°ä¹‹ä¸Š:\n```\n   choose :: Random a => (a, a) -> Gen a\n```\nå®ƒå¯ä»¥ä»ä¸€ä¸ªåŒºé—´éšæœºé€‰æ‹©ä¸€ä¸ªå…·æœ‰å‡åŒ€åˆ†å¸ƒçš„å€¼ã€‚ä¾‹å¦‚ï¼Œè¦åœ¨åˆ—è¡¨çš„å…ƒç´ ä¹‹é—´è¿›è¡Œéšæœºé€‰æ‹©ï¼Œè¯·ä½¿ç”¨\n```\ndo i<-choose (0,length xs-1)\n   return (xs!!i)\n```\n\n#### åœ¨æ›¿ä»£å“ä¹‹é—´é€‰æ‹©\nç”Ÿæˆå™¨å¯ä»¥æœ‰å¦‚ä¸‹å½¢å¼:\n```\n   oneof <list of generators>\n```\nåœ¨åˆ—è¡¨ä¸­çš„ç”Ÿæˆå™¨ä¹‹é—´ä»¥ç›¸åŒçš„æ¦‚ç‡é€‰æ‹©ã€‚ä¾‹å¦‚ï¼Œ\n```\n   oneof [return True, return False]\n```\nç”Ÿæˆä¸€ä¸ªéšæœºå¸ƒå°”å€¼ï¼Œå…¶å€¼ä¸º`true`çš„æ¦‚ç‡ä¸ºä¸€åŠã€‚\næˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ§åˆ¶ç»“æœåˆ†å¸ƒçš„å‡½æ•°ä»£æ›¿:\n```\n   frequency :: [(Int, Gen a)] -> Gen a\n```\n`frequency`ä»åˆ—è¡¨ä¸­éšæœºé€‰æ‹©ä¸€ä¸ªç”Ÿæˆå™¨ï¼Œä½†æ˜¯æŒ‰ç»™å®šå› å­åŠ æƒé€‰æ‹©æ¯ä¸ªå¤‡é€‰æ–¹æ¡ˆçš„æ¦‚ç‡ã€‚ä¾‹å¦‚ï¼Œ\n```\n   frequency [(2,return True), (1,return False)]\n```\nå°†ä¼šæœ‰ä¸‰åˆ†ä¹‹äºŒå‡ ç‡äº§ç”Ÿ`True`.\n\n### æµ‹è¯•æ•°æ®çš„å¤§å°\næµ‹è¯•æ•°æ®ç”Ÿæˆå™¨å…·æœ‰éšå¼å¤§å°å‚æ•°; `quickCheck`ä»ç”Ÿæˆå°æµ‹è¯•ç”¨ä¾‹å¼€å§‹ï¼Œéšç€æµ‹è¯•çš„è¿›è¡Œé€æ¸å¢åŠ å¤§å°ã€‚\nä¸åŒçš„æµ‹è¯•æ•°æ®ç”Ÿæˆå™¨ä»¥ä¸åŒçš„æ–¹å¼è§£é‡Šå¤§å°å‚æ•°: æœ‰äº›å¿½ç•¥å®ƒï¼Œè€Œåˆ—è¡¨ç”Ÿæˆå™¨ï¼Œä¾‹å¦‚ï¼Œå°†å…¶è§£é‡Šä¸ºç”Ÿæˆåˆ—è¡¨é•¿åº¦çš„ä¸Šé™ã€‚\næ‚¨å¯ä»¥éšæ„ä½¿ç”¨å®ƒï¼Œå› ä¸ºæ‚¨å¸Œæœ›æ§åˆ¶è‡ªå·±çš„æµ‹è¯•æ•°æ®ç”Ÿæˆå™¨ã€‚\næ‚¨å¯ä»¥ä½¿ç”¨`size`å‚æ•°è·å–å®ƒçš„å€¼:\n```\n  sized :: (Int -> Gen a) -> Gen a\n```\n`size g`è°ƒç”¨`g`ï¼Œå°†å½“å‰å¤§å°ä½œä¸ºå‚æ•°ä¼ é€’ç»™å®ƒã€‚ä¾‹å¦‚ï¼Œè¦ç”Ÿæˆ`0`åˆ°`size`èŒƒå›´å†…çš„è‡ªç„¶æ•°ï¼Œè¯·ä½¿ç”¨\n```\n  sized $ \\n -> choose (0, n)\n```\nå¤§å°æ§åˆ¶çš„ç›®çš„æ˜¯ç¡®ä¿æµ‹è¯•ç”¨ä¾‹è¶³å¤Ÿå¤§ä»¥æ˜¾ç¤ºé”™è¯¯ï¼ŒåŒæ—¶ä¿æŒè¶³å¤Ÿå°ä»¥ä¾¿å¿«é€Ÿæµ‹è¯•ã€‚æœ‰æ—¶é»˜è®¤å¤§å°æ§ä»¶æ— æ³•å®ç°æ­¤ç›®çš„ã€‚ä¾‹å¦‚ï¼Œåœ¨æµ‹è¯•è¿è¡Œç»“æŸæ—¶ï¼Œä»»æ„åˆ—è¡¨æœ€å¤šå¯åŒ…å«50ä¸ªå…ƒç´ ï¼Œå› æ­¤ä»»æ„åˆ—è¡¨çš„åˆ—è¡¨æœ€å¤šå¯èƒ½æœ‰2500ä¸ªï¼Œè¿™å¯¹äºé«˜æ•ˆæµ‹è¯•æ¥è¯´å¤ªå¤§äº†ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ˜¾å¼ä¿®æ”¹`size`å‚æ•°ä¼šå¾ˆæœ‰ç”¨ã€‚ä½ å¯ä»¥ç”¨\n```\n  resize :: Int -> Gen a -> Gen a\n```\n`resize n g`è°ƒç”¨`size`å‚æ•°ä¸º`n`çš„ç”Ÿæˆå™¨`g`ã€‚`size`å‚æ•°æ°¸è¿œä¸åº”è¯¥æ˜¯è´Ÿæ•°ã€‚ä¾‹å¦‚ï¼Œè¦ç”ŸæˆéšæœºçŸ©é˜µï¼Œå¯èƒ½éœ€è¦é‡‡ç”¨åŸå§‹å¤§å°çš„å¹³æ–¹æ ¹ï¼š\n\n```\n  matrix = sized $ \\n -> resize (round (sqrt n)) arbitrary\n```\n#### ç”Ÿæˆé€’å½’æ•°æ®ç±»å‹\né€’å½’æ•°æ®ç±»å‹çš„ç”Ÿæˆå™¨å¾ˆå®¹æ˜“ä½¿ç”¨`oneof`æˆ–`frequency`æ¥è¡¨ç¤ºæ„é€ å‡½æ•°å’Œ`Haskell`çš„æ ‡å‡†`monadic`ç»„åˆå™¨ï¼Œä»¥ä¾¿ä¸ºæ¯ç§æƒ…å†µå½¢æˆç”Ÿæˆå™¨ã€‚\nä¾‹å¦‚ï¼Œå¦‚æœæ ‘çš„ç±»å‹ç”±ä»¥ä¸‹ç±»å‹å®šä¹‰:\n```\ndata Tree = Leaf Int | Branch Tree Tre\n```\né‚£ä¹ˆä¸€ä¸ªæ ‘çš„ç”Ÿæˆå™¨å¯èƒ½ä¸ºå¦‚ä¸‹è¿™æ ·:\n```\ntree = oneof [liftM Leaf arbitrary,\n\t      liftM2 Branch tree tree]\n```\nä½†æ˜¯ï¼Œåƒè¿™æ ·çš„é€’å½’ç”Ÿæˆå™¨å¯èƒ½æ— æ³•ç»ˆæ­¢æˆ–äº§ç”Ÿéå¸¸å¤§çš„ç»“æœã€‚ä¸ºé¿å…è¿™ç§æƒ…å†µï¼Œé€’å½’ç”Ÿæˆå™¨åº”å§‹ç»ˆä½¿ç”¨å¤§å°æ§åˆ¶æœºåˆ¶ã€‚ä¾‹å¦‚ï¼Œ\n```\ntree = sized tree'\ntree' 0 = liftM Leaf arbitrary\ntree' n | n>0 = \n\toneof [liftM Leaf arbitrary,\n\t       liftM2 Branch subtree subtree]\n  where subtree = tree' (n `div` 2)\n```\næ³¨æ„:\n* æˆ‘ä»¬é€šè¿‡åœ¨å¤§å°ä¸ºé›¶æ—¶å¼ºåˆ¶ç»“æœä¸ºå¶å­æ¥ä¿è¯ç»ˆæ­¢ã€‚\n* æˆ‘ä»¬åœ¨æ¯æ¬¡é€’å½’æ—¶å°†å¤§å°å‡åŠï¼Œä»¥ä¾¿å¤§å°ç»™å‡ºæ ‘ä¸­èŠ‚ç‚¹æ•°çš„ä¸Šé™ã€‚ æˆ‘ä»¬å¯ä»¥è‡ªç”±åœ°è§£é‡Šå°ºå¯¸ã€‚\n* æˆ‘ä»¬åœ¨åˆ†æ”¯çš„ä¸¤ä¸ªåˆ†æ”¯ä¹‹é—´å…±äº«å­æ ‘ç”Ÿæˆå™¨çš„äº‹å®å½“ç„¶ä¸æ„å‘³ç€æˆ‘ä»¬åœ¨æ¯ç§æƒ…å†µä¸‹ç”Ÿæˆç›¸åŒçš„æ ‘ã€‚\n\n#### æœ‰ç”¨çš„ç”Ÿæˆå™¨ç»„åˆå™¨\nå¦‚æœ`g`æ˜¯ä¸€ä¸ªç±»å‹`t`çš„ç”Ÿæˆå™¨,é‚£ä¹ˆ:\n* ä¸¤ä¸ª`g`äº§ç”Ÿä¸€å¯¹`tS`ï¼Œ\n* 3ä¸ª`g`äº§ç”Ÿä¸‰å€çš„`tS`ï¼Œ\n* 4ä¸ª`g`äº§ç”Ÿå››å€çš„`tS`ï¼Œ\n* `vector n g`ç”Ÿæˆä¸€ä¸ª`n tS`åˆ—è¡¨ã€‚\nå¦‚æœ`xs`æ˜¯åˆ—è¡¨ï¼Œåˆ™å…ƒç´ `xs`ç”Ÿæˆ`xs`çš„ä»»æ„å…ƒç´ ã€‚\n\n### Arbitraryç±»\n`QuickCheck`ä½¿ç”¨`Haskell`çš„é‡è½½æœºåˆ¶ä¸ºæ¯ç§ç±»å‹å®šä¹‰é»˜è®¤æµ‹è¯•æ•°æ®ç”Ÿæˆå™¨ã€‚è¿™æ˜¯ä½¿ç”¨è¯¥ç±»å®Œæˆçš„:\n```\nclass Arbitrary a where\n  arbitrary   :: Gen a\n  coarbitrary :: a -> Gen b -> Gen b\n```\n`QuickCheck`ä¸ºç±»å‹ `()`ï¼Œ`Bool`ï¼Œ`Int`ï¼Œ`Integer`ï¼Œ`Float`ï¼Œ`Double`ï¼Œ`pair`ï¼Œ`triples`ï¼Œ`quadruples`ï¼Œ`lists`å’Œ`functions`å®šä¹‰äº†å®ä¾‹ã€‚\nç±»æ–¹æ³•`arbitrary`æ˜¯ç±»å‹`a`çš„é»˜è®¤ç”Ÿæˆå™¨ã€‚\nä½ å¯ä»¥ä¸ºä»»æ„å…¶ä»–ç±»å‹å£°æ˜ä¸€ä¸ªé»˜è®¤ç”Ÿæˆå™¨ï¼Œé€šè¿‡å£°æ˜ä¸€ä¸ª`Arbitrary`ç±»çš„å®ä¾‹ï¼Œå¹¶å®ç°`arbitrary`æ–¹æ³•ã€‚\n\nç±»æ–¹æ³•`coarbitrary`ç”¨äºç”Ÿæˆéšæœºå‡½æ•°å€¼ï¼šç±»å‹`a-> b`çš„`arbitrary`çš„å®ç°å¯¹ç±»å‹`a`ä½¿ç”¨`coarbitrary`ã€‚å¦‚æœä½ åªæƒ³ç”Ÿæˆ`a`ç±»å‹çš„éšæœºå€¼ï¼Œä½ åªéœ€è¦ä¸ºè¯¥ç±»å‹å®šä¹‰æ–¹æ³•`arbitrary`ï¼Œè€Œå¦‚æœä½ æƒ³åœ¨ç±»å‹ä¸Šç”Ÿæˆéšæœºå‡½æ•°ï¼Œé‚£ä¹ˆä½ åº”è¯¥å®šä¹‰ä¸¤ä¸ªç±»æ–¹æ³•ã€‚\n\n`coarbitrary`æ–¹æ³•å°†ç±»å‹`a`çš„å€¼è§£é‡Šä¸ºç”Ÿæˆå™¨å˜æ¢å™¨ã€‚åº”å¯¹å…¶è¿›è¡Œå®šä¹‰ï¼Œä»¥ä¾¿å°†ä¸åŒçš„å€¼è§£é‡Šä¸ºç‹¬ç«‹çš„ç”Ÿæˆå™¨å˜å‹å™¨ã€‚è¿™äº›å¯ä»¥é€šè¿‡ä½¿ç”¨ä»¥ä¸‹å‡½æ•°å®ç°:\n```\n  variant :: Int -> Gen a -> Gen a\n```\nå¯¹äºä¸åŒçš„è‡ªç„¶æ•°`i`å’Œ`j`ï¼Œ`variant i g`å’Œ`variant j g`æ˜¯ç‹¬ç«‹çš„ç”Ÿæˆå™¨å˜å‹å™¨ã€‚\n`variant`çš„å‚æ•°å¿…é¡»æ˜¯éè´Ÿçš„ï¼Œä¸ºäº†æé«˜æ•ˆç‡ï¼Œåº”è¯¥å¾ˆå°ã€‚\n`coarbitrary`çš„å®ä¾‹å¯ä»¥é€šè¿‡å°†ç”±`variant`æ„é€ çš„ç”Ÿæˆå™¨å˜æ¢å™¨ç»„åˆåœ¨ä¸€èµ·æ¥å®šä¹‰ã€‚\nä¾‹å¦‚ï¼Œå¦‚æœ`tree`çš„ç±»å‹å®šä¹‰å¦‚ä¸‹:\n```\n  data Tree = Leaf Int | Branch Tree Tree\n```\nç„¶åå¯ä»¥é€šè¿‡å¦‚ä¸‹ä»£ç å®šä¹‰ä¸€ä¸ªåˆé€‚çš„`Arbitrary`å®ä¾‹:\n```\ninstance Arbitrary Tree where\n  arbitrary = sized tree'\n    where tree' 0 = liftM Leaf arbitrary\n\t  tree' n | n>0 = \n\t\toneof [liftM Leaf arbitrary,\n\t          liftM2 Branch subtree subtree]\n  \t    where subtree = tree' (n `div` 2)\n  coarbitrary (Leaf n) = \n\tvariant 0 . coarbitrary n\n  coarbitrary (Branch t1 t2) = \n\tvariant 1 . coarbitrary t1 . coarbitrary t2\n```\n#### å‡½æ•°çš„å±æ€§\n`QuickCheck`å¯ä»¥ç”Ÿæˆéšæœºå‡½æ•°å€¼ï¼Œä»è€Œæ£€æŸ¥å‡½æ•°çš„å±æ€§ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥æ£€æŸ¥å‡½æ•°ç»„åˆçš„ç›¸å…³æ€§å¦‚ä¸‹:\n```\nprop_ComposeAssoc f g h x =\n  ((f . g) . h) x == (f . (g . h)) x\n  where types = [f, g, h] :: [Int->Int]\n```\nä½†æ˜¯ï¼Œåœ¨æˆ‘ä»¬æµ‹è¯•è¿™æ ·çš„å±æ€§ä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»ç¡®ä¿å¯ä»¥æ‰“å°å‡½æ•°å€¼(å¦‚æœæ‰¾åˆ°äº†åä¾‹).ä¹Ÿå°±æ˜¯è¯´ï¼Œå‡½æ•°ç±»å‹å¿…é¡»æ˜¯`Show`ç±»çš„å®ä¾‹ã€‚è¦å®ç°è¿™ä¸ªï¼Œä½ å¿…é¡»å°†æ¨¡å—`ShowFunctions`å¯¼å…¥åˆ°åŒ…å«è¿™ç§é«˜é˜¶å±æ€§çš„æ¯ä¸ªæ¨¡å—ä¸­ã€‚å¦‚æœæ‰¾åˆ°åä¾‹ï¼Œåˆ™åŠŸèƒ½å€¼å°†æ˜¾ç¤ºä¸º`<function>`.\n\n### æç¤º: ä½¿ç”¨newtype\n`QuickCheck`å¯ä»¥è½»æ¾åœ°å°†æµ‹è¯•æ•°æ®ç”Ÿæˆå™¨ä¸æ¯ç§ç±»å‹ç›¸å…³è”ï¼Œä½†æœ‰æ—¶æ‚¨éœ€è¦ä¸åŒçš„åˆ†å‘ã€‚ä¾‹å¦‚ï¼Œå‡è®¾æ‚¨æ­£åœ¨æµ‹è¯•ä¸€ä¸ªæ“ä½œè¯­æ³•æ ‘çš„ç¨‹åºï¼Œå¹¶ä½¿ç”¨å˜é‡çš„æ„é€ å‡½æ•°:\n```\n data Expr = Var String | ...\n```\nå°½ç®¡å˜é‡åç§°è¡¨ç¤ºä¸ºå­—ç¬¦ä¸²ï¼Œä½†å­—ç¬¦ä¸²çš„é»˜è®¤æµ‹è¯•æ•°æ®ç”Ÿæˆå™¨ä¸å¤ªå¯èƒ½ä¸ºå˜é‡åç§°ç”Ÿæˆè‰¯å¥½çš„åˆ†å¸ƒã€‚ ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æ­£åœ¨ç”Ÿæˆéšæœºè¡¨è¾¾å¼ï¼Œæ‚¨å¯èƒ½å¸Œæœ›æœ‰æ—¶åœ¨æµ‹è¯•æ•°æ®ä¸­å‡ºç°åç§°å†²çªï¼Œä½†æ˜¯ä¸¤ä¸ªéšæœºç”Ÿæˆçš„å­—ç¬¦ä¸²(ä¾‹å¦‚`p}v(\\231\\156A`.)ä¸å¤ªå¯èƒ½å‘ç”Ÿå†²çªã€‚\nå½“ç„¶ï¼Œæ‚¨å¯ä»¥ä¸ºå˜é‡åç§°ç¼–å†™è‡ªå®šä¹‰æµ‹è¯•æ•°æ®ç”Ÿæˆå™¨ï¼Œä¹Ÿå¯ä»¥ä»ä¸€ä¸ªå°é›†åˆä¸­éšæœºé€‰æ‹©ï¼Œå¹¶å°è¯•è®°ä½åœ¨å­—ç¬¦ä¸²æ‰®æ¼”åç§°è§’è‰²çš„ä»»ä½•åœ°æ–¹ä½¿ç”¨å®ƒã€‚ä½†è¿™å¾ˆå®¹æ˜“å‡ºé”™ã€‚æ›´å¥½çš„æ–¹æ³•æ˜¯å®šä¹‰ä¸€ä¸ªåç§°çš„æ–°ç±»å‹ï¼Œä¸`String`åŒæ„ï¼Œå¹¶ä½¿æ‚¨çš„è‡ªå®šä¹‰ç”Ÿæˆå™¨æˆä¸ºå®ƒçš„é»˜è®¤å€¼ã€‚ä¾‹å¦‚:\n```\nnewtype Name = Name String\n\ninstance Arbitrary Name where\n  arbitrary = oneof [\"a\", \"b\", \"c\", \"d\", \"e\"]\n```\nå¦‚æœæ‚¨å°å¿ƒä½¿ç”¨`Name`ç±»å‹ï¼Œæ— è®ºæ‚¨çš„åå­—æ˜¯ä»€ä¹ˆï¼Œé‚£ä¹ˆæ‚¨çš„å±æ€§å°†æ›´å®¹æ˜“ç¼–å†™å¹¶ä¸”ç»å¸¸éƒ½æ˜¯æ­£ç¡®çš„ï¼\n\n","tags":["QuickCheck"]},{"title":"è‹±è¯­è¯­æ³•å­¦ä¹ ç¬”è®°-åè¯çŸ­è¯­ä¸å† è¯","url":"/blog/2019/06/21/è‹±è¯­è¯­æ³•å­¦ä¹ ç¬”è®°-åè¯çŸ­è¯­ä¸å† è¯/","content":"\n### åè¯çŸ­è¯­ç»“æ„\n\n### ä»€ä¹ˆæ—¶å€™ä¸éœ€è¦ç”¨é™å®šè¯\n\n### ä¸“æœ‰åè¯ä¸è¡¥è¯­ä½ç½®\n\n\n\n","tags":["å† è¯"]},{"title":"è‹±è¯­è¯­æ³•å­¦ä¹ ç¬”è®°-è¡¥è¯­","url":"/blog/2019/06/21/è‹±è¯­è¯­æ³•å­¦ä¹ ç¬”è®°-è¡¥è¯­/","content":"### 5ç§å•å¥åŸºæœ¬å¥å‹\n```\n#ä¸»è¯­ Subject\n#åŠ¨è¯ Verb\n#å®¾è¯­ Object\n#è¡¥è¯­ Complemnt\n1. S + V\t\t(ä¸»è¯­ + åŠ¨è¯)\n2. S + V + O\t\t(ä¸»è¯­ + åŠ¨è¯ + å®¾è¯­)\n3. S + V + C\t\t(ä¸»è¯­ + åŠ¨è¯ + è¡¥è¯­)\n4. S + V + O + O\t(ä¸»è¯­ + åŠ¨è¯ + å®¾è¯­ + å®¾è¯­)\n5. S + V + O + C\t(ä¸»è¯­ + åŠ¨è¯ + å®¾è¯­ + è¡¥è¯­)\n```\n\n### åŠç‰©åŠ¨è¯/ä¸åŠç‰©åŠ¨è¯\nä¸€ä¸ªå®Œæ•´çš„å¥å­ï¼Œå¿…é¡»èƒ½å¤Ÿè¡¨è¾¾å®Œæ•´çš„æ„æ€ã€‚è¿™éœ€è¦ä¸¤éƒ¨åˆ†æ¥å®Œæˆ: ä¸»è¯­å’ŒåŠ¨è¯ã€‚ä¸»è¯­ï¼Œæ˜¯è¿™ä¸ªå¥å­æ‰€æè¿°çš„å¯¹è±¡ã€‚åŠ¨è¯ï¼Œæ„æˆæè¿°çš„ä¸»è¦å†…å®¹ã€‚ä¾‹å¦‚:\n```\n1. John Smith died in World War Two. (S + V)\n   (çº¦ç¿°å²å¯†æ–¯æ­»äºç¬¬äºŒæ¬¡ä¸–ç•Œå¤§æˆ˜.)\n\n2. John Smith killed three enemy soldiers. (S + V + O)\n   (çº¦ç¿°å²å¯†æ–¯æ€æ­»äº†ä¸‰åæ•Œå†›å£«å…µ.)\n```\nç¬¬1ä¸ªä¾‹å­ä¸­ï¼Œä¸»è¯­ä¸º`John Smith`ï¼Œè¡¨æ˜è¿™å¥è¯æ˜¯è¦å‘Šè¯‰ä½ æœ‰å…³`John Smith`çš„äº‹æƒ…ï¼Œæ˜¯ä»€ä¹ˆäº‹æƒ…å‘¢ï¼Ÿä»–æ­»äº†(åŠ¨è¯`died`è¡¨æ˜å™è¿°çš„ä¸»è¦å†…å®¹)ï¼è‡³äºä»–æ˜¯æ­»äºç¬¬ä¸€æ¬¡ä¸–ç•Œå¤§æˆ˜ï¼Œè¿˜æ˜¯ç¬¬äºŒæ¬¡ä¸–ç•Œå¤§æˆ˜æ˜¯å¯æœ‰å¯æ— çš„ç»†èŠ‚(ä»¥ä»‹è¯çŸ­è¯­`in World War Two`æ¥ä¿®é¥°)ï¼Œå› æ­¤ï¼Œç¬¬1ä¸ªä¾‹å­å†™æˆ`John Smith died`ï¼Œä¹Ÿå¯ä»¥æ„é€ æˆå®Œæ•´ï¼Œæ­£ç¡®çš„å¥å­ã€‚\nåƒ`die`ç§åŠ¨ä½œï¼Œå¯ä»¥ç‹¬ç«‹å‘ç”Ÿï¼Œä¸ç‰µæ¶‰åˆ°åˆ«çš„äººå’Œç‰©çš„åŠ¨è¯ï¼Œå°±ç§°ä¸º`ä¸åŠç‰©`åŠ¨è¯ã€‚è€Œç¬¬2ä¸ªä¾‹å­ä¸­çš„`kill`åŠ¨ä½œï¼Œåˆ™å¿…é¡»å‘ç”Ÿåœ¨å¦ä¸€ä¸ªå¯¹è±¡èº«ä¸Šï¼Œå› ä¸ºè¦åšå‡º`æ€`çš„åŠ¨ä½œï¼Œå°±å¿…é¡»æœ‰ä¸€ä¸ª`è¢«æ€`çš„ä¸œè¥¿ï¼Œå› æ­¤`kill`è¿™ç§åŠ¨è¯å°±æ˜¯`åŠç‰©`åŠ¨è¯ï¼Œå®ƒåé¢é€šå¸¸ä¼šæœ‰ä¸€ä¸ªå®¾è¯­æ¥`æ¥å—`è¿™ä¸ªåŠ¨ä½œï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ`three enemy soldiers`å°±æ˜¯åšä¸ºå®¾è¯­ã€‚\n \n### beåŠ¨è¯\nä¸Šä¸€èŠ‚ä¾‹2ä¸­ï¼Œå¦‚æœçœç•¥æ‰å®¾è¯­`three enemy soldiers`ï¼Œä¸»è¯­+åŠ¨è¯`John Smith killed`ä¾æ—§å¯ä»¥è¡¨ç¤ºä¸ºä¸€ä¸ªå¥å­(è™½ç„¶æ²¡æœ‰è¡¨è¾¾å‡ºå®Œæ•´çš„æ„æ€): çº¦ç¿°å²å¯†æ–¯æ€äº†äººï¼Œåªä¸è¿‡æ²¡æœ‰å…·ä½“è¡¨æ˜æ€äº†è°ã€‚\nè€Œå¦‚æœå¥å­ä¸­çœç•¥äº†è¡¥è¯­ï¼Œå°±ä¸èƒ½è¡¨è¾¾å‡ºå®Œæ•´çš„æ„æ€ã€‚\nåœ¨æ‰€æœ‰çš„è‹±è¯­åŠ¨è¯ä¸­ï¼Œä¸è®ºæ˜¯`åŠç‰©`åŠ¨è¯è¿˜æ˜¯`ä¸åŠç‰©`åŠ¨è¯ï¼Œéƒ½è¦æ‹…ä»»èµ·`å™è¿°å…¨å¥æœ€ä¸»è¦å†…å®¹`çš„å·¥ä½œï¼Œåªæœ‰è§£é‡Šä¸º`æ˜¯`çš„åŠ¨è¯æ²¡æœ‰å™è¿°èƒ½åŠ›(æ²¡æœ‰ä»»ä½•æ„ä¹‰)ï¼Œåªèƒ½æ‰®æ¼”`å¼•å¯¼å™è¿°/ä¸²è”`çš„è§’è‰²ã€‚ä¾‹å¦‚: \n```\n3. John Smith was a soldier. (S + V + C)\n   (çº¦ç¿°å²å¯†æ–¯æ˜¯å†›äºº.)\n```\nåœ¨ä¾‹3ä¸­ï¼Œä¸»è¯­ä»ç„¶æ˜¯`John Smith`ï¼Œä½†æ˜¯åŠ¨è¯`was`å°±å’Œå‰é¢ä¾‹å­ä¸­çš„åŠ¨è¯`die/kill`ä¸ä¸€æ ·äº†ï¼Œå› ä¸º`was`å¹¶æ²¡æœ‰å‘Šè¯‰æˆ‘ä»¬æœ‰å…³`John Smith`çš„ä»»ä½•äº‹æƒ…ï¼Œå™è¿°ä¸»è¦å†…å®¹çš„å·¥ä½œè½åœ¨äº†åé¢çš„è¡¥è¯­`a soldier`ä¸Šï¼ŒåŠ¨è¯`was`åœ¨è¿™é‡Œåªæ˜¯èµ·åˆ°äº†`ä¸²è”`çš„ä½œç”¨ã€‚\n\n### ä¸å¿…ç¿»è¯‘çš„åŠ¨è¯: beåŠ¨è¯\n```\n4. John Smith was courageous. (S + V + C)\n   (çº¦ç¿°å²å¯†æ–¯å¾ˆå‹‡æ•¢.)\n\n5. The soup is too hot. (S + V + C)\n   (æ±¤å¤ªçƒ«äº†.)\n```\nä¾‹4ä¸­çš„`was`å’Œä¾‹5ä¸­çš„`is`æ›´èƒ½è¯´æ˜: è§£é‡Šä¸º`æ˜¯`çš„åŠ¨è¯æ²¡æœ‰å™è¿°èƒ½åŠ›ï¼Œå®Œå…¨æ²¡æœ‰ä»»ä½•æ„ä¹‰ã€‚\nå› ä¸ºåœ¨ä¸­æ–‡ç¿»è¯‘ä¸­ï¼Œ`æ˜¯`è¢«å®Œå…¨å»æ‰äº†ï¼Œå¦‚æœç¿»è¯‘æˆ`æ±¤æ˜¯å¤ªæ±¤äº†`å°±ä¸åƒä¸­æ–‡çš„è¯´è¯å£å»äº†ã€‚\nåœ¨è‹±æ–‡ä¸­ï¼Œ`is`æ˜¯åŠ¨è¯ä¸å¯ä»¥ä¸¢æ‰ï¼Œä½†æ˜¯å®ƒä¸åƒå…¶ä»–åŠ¨è¯èƒ½å™è¿°å‡ºä¸»è¦å†…å®¹ï¼Œå¦‚æœåªè¯´`John Smith was`ï¼Œ`The soup is`ï¼Œé‚£ä¹ˆè¿™äº›å¥å­é€šå¸¸éƒ½æ˜¯é”™çš„ï¼Œè€Œä¸”æ²¡æœ‰æ„ä¹‰ã€‚å› ä¸ºåŠ¨è¯`æ˜¯`ç¼ºä¹å™è¿°èƒ½åŠ›ã€‚\n\n### è¡¥è¯­å®šä¹‰\nè§£é‡Šä¸º`æ˜¯`çš„åŠ¨è¯ï¼Œå› ä¸ºæ²¡æœ‰å™è¿°èƒ½åŠ›ï¼Œåªèƒ½æŠŠä¸»è¯­å’Œä¸»è¯­åé¢æ„æˆå™è¿°çš„éƒ¨åˆ†è¿æ¥èµ·æ¥ï¼Œæ‰€ä»¥å®ƒåˆç§°ä½œ`è¿ç¼€åŠ¨è¯(Linking Verb)`ã€‚è·Ÿåœ¨è¿™ç§åŠ¨è¯åé¢çš„éƒ¨åˆ†ï¼Œå› ä¸ºæ›¿ä»£äº†åŠ¨è¯æ‰€æ‰®æ¼”çš„å™è¿°è§’è‰²ï¼Œè¡¥è¶³å¥å­ä½¿ä¹‹è·å¾—å®Œæ•´çš„æ„æ€ï¼Œå› æ­¤ç§°ä½œ`è¡¥è¯­(Complement)`ã€‚\n\n### éœ€è¦è¡¥è¯­çš„åŠ¨è¯æœ‰å“ªäº›?(S+V+C)\n`beåŠ¨è¯`ç›´æ¥ç¿»è¯‘ä¸º`æ˜¯`ï¼Œæ˜¯æœ€æœ‰ä»£è¡¨æ€§çš„`è¿ç¼€åŠ¨è¯`ï¼Œåœ¨æ‰€æœ‰çš„è‹±è¯­åŠ¨è¯ä¸­ï¼Œå‡¡æ˜¯æ¥è¡¥è¯­çš„åŠ¨è¯(`è¿ç¼€åŠ¨è¯`)éƒ½å¯ä»¥è§£é‡Šä¸ºå„ç§å„æ ·çš„`æ˜¯`:\n```\nlook\tçœ‹èµ·æ¥æ˜¯\nseem\tä¼¼ä¹æ˜¯\nappear\tæ˜¾å¾—æ˜¯\nsound\tå¬èµ·æ¥æ˜¯\nfeel\tæ‘¸èµ·æ¥æ˜¯\ntaste\tå°èµ·æ¥æ˜¯\nturn\tè½¬å˜ä¸º\nprove\tè¯å®ä¸º\nbecome\tæˆä¸º\nmake\tåšä¸º\n```\nä¸€ä¸ªä¸»è¯­ä½¿ç”¨å¦‚ä¸Šçš„ä»»æ„åŠ¨è¯ï¼Œéƒ½ä¸èƒ½æ„æˆä¸€ä¸ªæœ‰æ„ä¹‰çš„å®Œæ•´å¥å­ï¼Œéœ€è¦ä½¿ç”¨è¡¥è¯­è¡¥è¶³ã€‚ä¾‹å¦‚:\n```\n1. That dress looks pretty. (S + V + C) \n   (é‚£ä»¶è£™å­å¾ˆå¥½çœ‹)\n\n2. The dog seems friendly. \n   (é‚£åªç‹—çœ‹èµ·æ¥å¾ˆå‹å–„)\n\n3. His demands appear reasonable. \n   (ä»–çš„è¦æ±‚æ˜¾å¾—å¾ˆåˆç†)\n\n4. He became a teacher.\n   (ä»–å½“äº†æ•™å¸ˆ)\n\n5. A nurse makes a good wife. \n   (å¨¶æŠ¤å£«åšå¤ªå¤ªçœŸä¸é”™)\n```\nå¦‚æœå°†ä»¥ä¸Šä¾‹å­ä¸­å„å¼å„æ ·çš„`æ˜¯`æ›¿æ¢æˆçº¯ç²¹çš„`æ˜¯`(`beåŠ¨è¯`)ï¼Œå¥å­çš„å¥å‹å’Œè¯­ä¹‰éƒ½æ²¡æœ‰å¤ªå¤§å˜åŒ–ã€‚è¿™å°±æ˜¯`S + V + C`çš„å¥å‹`(ä¸»è¯­è¡¥è¯­)`.\n\n### å®¾è¯­è¡¥è¯­çš„å¥å‹(S+V+O+O)\n`ä¸»è¯­+åŠ¨è¯+è¡¥è¯­(ä¸»è¯­è¡¥è¯­)`çš„å¥å‹æ˜¯ç”¨è¡¥è¯­å‘Šè¯‰è¯»è€…ä¸»è¯­æ˜¯ä»€ä¹ˆï¼Œä¸­é—´ç”¨è¡¨ç¤ºä¸º`æ˜¯`çš„åŠ¨è¯ä¸²è”èµ·æ¥ã€‚\n`ä¸»è¯­+åŠ¨è¯+å®¾è¯­+è¡¥è¯­(å®¾è¯­è¡¥è¯­)`çš„å¥å‹åˆ™æ˜¯ç”¨è¡¥è¯­å‘Šè¯‰è¯»è€…å®¾è¯­æ˜¯ä»€ä¹ˆï¼Œä¸­é—´æš—ç¤ºæœ‰ä¸€ä¸ª`æ˜¯`çš„å…³ç³»å­˜åœ¨ã€‚ä¾‹å¦‚:\n```\n1. I find the dress pretty. (S + V + O + C)\n   (æˆ‘å‘ç°è¿™è¡£æœå¾ˆæ¼‚äº®)\n\n2. The meat made the dog friendly. \n   (è‚‰è®©ç‹—å˜å¾—å‹å–„)\n\n3. They consider his demands reasonable. \n   (ä»–ä»¬è®¤ä¸ºä»–çš„è¦æ±‚æ˜¯åˆç†çš„)\n   \n4. His college training made him a teacher. \n   (ä»–çš„å¤§å­¦æ•™è‚²ä½¿ä»–æˆä¸ºä¸€åæ•™å¸ˆ)\n\n5. Most people consider a nurse a good wife. \n   (å¤§å¤šæ•°çš„äººè®¤ä¸ºæŠ¤å£«ä¼šæ˜¯ç§°èŒçš„å¤ªå¤ª)\n```\nä¾‹å¦‚ç¬¬1ä¸ªä¾‹å­: å®¾è¯­`the dress`å’Œè¡¥è¯­`pretty`ä¹‹é—´è™½ç„¶æ²¡æœ‰`æ˜¯`å­—ï¼Œä½†æ˜¯å¸¦æœ‰è¿™ç§æš—ç¤ºå­˜åœ¨ã€‚å¦‚æœåŠ ä¸ª`beåŠ¨è¯`è¿›å»å°±å˜æˆäº†ä¸Šä¸€èŠ‚ä»‹ç»çš„ä¸»è¯­è¡¥è¯­å¥å­: `That dress is pretty`ã€‚\nå…¶å®è¿™ä¹Ÿæ˜¯æ£€éªŒ`S + V + O + C`å¥å‹æœ€ç®€ä¾¿çš„æ–¹æ³•: æŠŠå¥å­ä¸­çš„å®¾è¯­å’Œè¡¥è¯­æ‹¿å‡ºæ¥ï¼Œä¸­é—´åŠ å…¥`beåŠ¨è¯`ï¼Œçœ‹çœ‹èƒ½å¦å˜æˆ`S + V + C`å¥å‹ã€‚\n\n### è¡¥è¯­çš„è¯ç±»\n```\n1. John Smith was a soldier. (S + V + C)\n   (çº¦ç¿°å²å¯†æ–¯æ˜¯å†›äºº)\n2. The military academy made John Smith a soldier. (S + V + O + C) \n   (å†›æ ¡è®­ç»ƒä½¿çº¦ç¿°å²å¯†æ–¯æˆä¸ºå†›äºº)\n\n3. John Smith was courageous. (S + V + C)\n   (çº¦ç¿°å²å¯†æ–¯å¾ˆå‹‡æ•¢)\n4. I consider John Smith courageous. (S + V + O + C)\n   (æˆ‘è®¤ä¸ºçº¦ç¿°å²å¯†æ–¯å¾ˆå‹‡æ•¢)\n```\nè¡¥è¯­çš„è¯ç±»ï¼Œåº”è¯¥æ˜¯åç§°å’Œå½¢å®¹è¯æ¯”è¾ƒåˆç†ã€‚\nå› ä¸ºä¸»è¯­æˆ–å®¾è¯­éƒ½æ˜¯åè¯ï¼Œæ‰€ä»¥è¡¥è¯­ä¹Ÿå¯ä»¥ä¸ºåè¯ï¼Œç„¶åç»ç”±åŠ¨è¯`æ˜¯`çš„è¿æ¥æ¥è¡¨è¾¾åŒç­‰çš„å…³ç³»ã€‚å¦å¤–ä¿®é¥°åè¯çš„ä¿®é¥°è¯­å°±æ˜¯å½¢å®¹è¯ï¼Œå› æ­¤è¡¥è¯­ä¹Ÿå¯ä»¥ä¸ºå½¢å®¹è¯ã€‚\nä¾‹1ä¸­`John Smith`ä¸ºä¸»è¯­ï¼Œ`a soldier`ä¸ºä¸»è¯­è¡¥è¯­ï¼Œè¯ç±»éƒ½æ˜¯åè¯ã€‚\nä¾‹2ä¸­`John Smith`ä¸ºå®¾è¯­ï¼Œ`a soldier`ä¸ºå®¾è¯­è¡¥è¯­ï¼Œä½†è¯ç±»ä»ç„¶ä¸ºåè¯ã€‚\nä¾‹3ä¸­ä¸»è¯­è¡¥è¯­`courageus`ä¸ºå½¢å®¹è¯ï¼Œå› è€Œå¯ä»¥ç»ç”±åŠ¨è¯`æ˜¯`çš„å¼•å¯¼æ¥ä¿®é¥°ä¸»è¯­`John Smith`æ˜¯æ€æ ·çš„äººã€‚\nä¾‹4ä¸­`courageus`ä¸ºå®¾è¯­è¡¥è¯­ï¼Œè¯ç±»æ²¡æœ‰å˜åŒ–ï¼Œä»ç„¶ä¸ºå½¢å®¹è¯ã€‚\n\n### æ²¡æœ‰è¡¥è¯­çš„beåŠ¨è¯(S+V)\n`beåŠ¨è¯`æ˜¯æœ€çº¯ç²¹çš„`è¿ç¼€åŠ¨è¯`ï¼Œè§£é‡Šä¸º`æ˜¯`ï¼Œåé¢åº”è¯¥è¦æœ‰è¡¥è¯­å¥å­æ‰ç®—å®Œæ•´ã€‚å¦‚æœçœ‹åˆ°`beåŠ¨è¯`åé¢æ²¡æœ‰è¡¥è¯­ï¼Œè¡¨ç¤ºè¿™ä¸ª`beåŠ¨è¯`å¹¶ä¸æ˜¯ä½œä¸º`è¿ç¼€åŠ¨è¯`æ¥ä½¿ç”¨ï¼Œæ­¤æ—¶ï¼Œ`beåŠ¨è¯`å¹¶ä¸è§£é‡Šä¸º`æ˜¯`ï¼Œè€Œæ˜¯è¦è§£é‡Šä¸º`å­˜åœ¨`ã€‚ç”¨åœ¨æœ€å•çº¯çš„`ä¸»è¯­+å®¾è¯­`å¥å‹ä¸­ã€‚\n```\n1. I think;therefore I am. \n   (æˆ‘æ€æ•…æˆ‘åœ¨)\n\n2. To be or not to be,that is the question. \n   (ç”Ÿå­˜è¿˜æ˜¯æ¯ç­,è¿™æ˜¯ä¸ªé—®é¢˜)\n```\nä¾‹1ä¸­ï¼Œ`I am`ä¸å¯ä»¥ç¿»è¯‘ä¸º`æˆ‘æ˜¯`ï¼Œå¦‚æœ`am`ä½œä¸º`è¿ç¼€åŠ¨è¯`ä½¿ç”¨ï¼Œåé¢å¿…é¡»æœ‰è¡¥è¯­æ¥è¯´æ˜`æ˜¯ä»€ä¹ˆ`ï¼Œåœ¨æ²¡æœ‰è¡¥è¯­çš„æƒ…å†µä¸‹ï¼Œ`I am`å°±å¾—ç¿»è¯‘æˆ`æˆ‘å­˜åœ¨`äº†ã€‚\nåŒç†ï¼Œä¾‹2ä¸­ï¼Œ`To be or not to be`åº”è¯¥ç¿»è¯‘æˆ`è¦å­˜åœ¨è¿˜æ˜¯ä¸è¦å­˜åœ¨`ã€‚\n\n### æœ‰ä¸¤ä¸ªå®¾è¯­çš„å¥å‹(S+V+O+O)\næœ‰ä¸¤ä¸ªå®¾è¯­çš„å¥å‹ï¼Œå³: `ä¸»è¯­ + åŠ¨è¯ + å®¾è¯­ + å®¾è¯­`ï¼Œéœ€è¦å’Œ`ä¸»è¯­ + åŠ¨è¯ + å®¾è¯­ + è¡¥è¯­`çš„å¥å‹åŒºåˆ†å¼€ã€‚åè€…çš„å®¾è¯­å’Œè¡¥è¯­ä¹Ÿå¯ä»¥éƒ½æ˜¯åè¯ï¼Œä½†å®¾è¯­å’Œè¡¥è¯­ä¹‹é—´å­˜åœ¨`ç­‰äºæ˜¯`çš„å…³ç³»ã€‚\n```\n1. John's father gave him a dog. (çº¦ç¿°çš„çˆ¶äº²ç»™ä»–ä¸€åªç‹—)\n2. John's father called him a dog. (çº¦ç¿°çš„çˆ¶äº²éª‚ä»–æ˜¯ç‹—)\n```\nä¾‹1ä¸­ï¼Œ`him`å’Œ`a dog`éƒ½æ˜¯å®¾è¯­ï¼Œå…¶ä¸­`him`æ˜¯`gave`çš„å¯¹è±¡ï¼Œ`a dog`æ˜¯`gave`çš„ä¸œè¥¿ï¼Œä¸¤ä¸ªéƒ½æ˜¯åè¯ï¼Œä¸”å¹¶ä¸ç›¸ç­‰ã€‚\nä¾‹2ä¸­ï¼Œ`him`æ˜¯å®¾è¯­ï¼Œ`a dog`æ˜¯è¡¥è¯­ï¼Œå› ä¸ºæœ‰`ä»–æ˜¯ç‹—`çš„æ„æ€åœ¨ï¼Œæ‰€ä»¥`a dog`æ˜¯`him`çš„è¡¥è¯­ã€‚\n\n### ç»ƒä¹ \nè¯·åˆ¤æ–­ä»¥ä¸‹å¥å­å±äºäº”ç§åŸºæœ¬å¥å‹ä¸­çš„å“ªä¸€ç§?\n```\n1. The magician moved his fingers quickly. (S + V + O)\n   (é­”æœ¯å¸ˆè¿…é€Ÿç§»åŠ¨ä»–çš„æ‰‹æŒ‡.)\n\n2. The police found the letter missing. (S + V + O + C)\n   (è­¦å¯Ÿå‘ç°é‚£å°ä¿¡ä¸¢å¤±äº†.)\n   \n3. The police found the missing letter. (S + V + O)\n   (è­¦å¯Ÿæ‰¾åˆ°äº†ä¸¢å¤±çš„ä¿¡.)\n\n4. He ordered himself a steak and a bottle of red wine. (S + V + O + O)\n   (ä»–ç‚¹äº†ä¸€ä»½ç‰›æ’å’Œä¸€ç“¶çº¢é…’.)\n\n5. Don't you like dancing? (S + V + O)\n   (ä½ ä¸å–œæ¬¢è·³èˆä¹ˆ?)\n\n6. The President has gone abroad on a visit. (S + V)\n   (æ€»ç»Ÿå‡ºå›½è®¿é—®äº†.)(President/has gone)\n\n7. That sounds like a good idea. (S + V + C)\n   (å¬èµ·æ¥åƒæ˜¯ä¸ªå¥½ä¸»æ„.)\n\n8. The box feels heavy. (S + V + C)\n   (ç›’å­æ‘¸èµ·æ¥å¾ˆé‡.)\n\n9. He told his guests a dirty joke at the party. (S + V + O + O)\n   (ä»–åœ¨èšä¼šä¸Šç»™å®¢äººè®²äº†ä¸ªä¸‹æµçš„ç¬‘è¯.)\n\n10. The people elected Bill Clinton President. (S + V + O + C)\n    (äººæ°‘é€‰ä¸¾æ¯”å°”å…‹æ—é¡¿ä¸ºæ€»ç»Ÿ.)\n\n11. The child asks her mother a million questions a day. (S + V + O + O)\n    (è¿™ä¸ªå­©å­æ¯å¤©é—®ä»–å¦ˆå¦ˆä¸€ç™¾ä¸‡ä¸ªé—®é¢˜.)\n\n12. Monkeys love bananas. (S + V + O)\n    (çŒ´å­å–œæ¬¢é¦™è•‰.)\n\n13. You can leave the door open. (S + V + O + C)\n    (ä½ å¯ä»¥æŠŠé—¨å¼€ç€.)\n\n14. The company has gone bankrupt. (S + V + C)\n    (è¿™å®¶å…¬å¸å·²ç»ç ´äº§äº†.)(company/has gone/bankrupt)\n\n15. Why don't you answer me? (S + V + O) \n    (ä¸ºä»€ä¹ˆä¸å›ç­”æˆ‘?)\n\n16. I consider you a member of the family. (S + V + O + C)\n    (æˆ‘è®¤ä¸ºä½ æ˜¯å®¶åº­çš„ä¸€å‘˜.)(I/consider/you/member)\n\n17. It never rains in California. (S + V)\n    (åŠ åˆ©ç¦å°¼äºšä»ä¸ä¸‹é›¨.)\n\n18. You'll look better with these designer glasses on. (S + V + C)\n    (ä½ æˆ´ä¸Šè¿™å¹…åç‰Œçœ¼ç›ä¼šå¥½çœ‹äº›.)\n\n19. I can see better without these reading glasses. (S + V)\n    (æˆ‘ä¸æˆ´è€èŠ±é•œèƒ½çœ‹çš„æ›´æ¸…æ¥šäº›.)\n\n20. Do you call me liar? (S + V + O + C)\n    (ä½ è¯´æˆ‘æ’’è°ä¹ˆ?)\n```\n\n\n\n","tags":["è¡¥è¯­"]},{"title":"æ·±å…¥ç†è§£Haskell-IO","url":"/blog/2019/05/29/æ·±å…¥ç†è§£Haskell-IO/","content":"> æœ¬æ–‡ç¿»è¯‘è‡ª[ç»´åŸºç™¾ç§‘](https://wiki.haskell.org/IO_inside),æƒ³è¦çœ‹åŸæ–‡çš„å¯ä»¥å»é‚£é‡ŒæŸ¥çœ‹.\n\n### IOå†…éƒ¨\nHaskell I/Oä¸€ç›´æ˜¯æ–°Haskellersæ··ä¹±å’ŒæƒŠå–œçš„æ ¹æºã€‚è™½ç„¶Haskellä¸­çš„ç®€å•I/Oä»£ç çœ‹èµ·æ¥éå¸¸ç±»ä¼¼äºå‘½ä»¤å¼è¯­è¨€ä¸­çš„ç­‰ä»·ç‰©ï¼Œä½†å°è¯•ç¼–å†™æ›´å¤æ‚çš„ä»£ç é€šå¸¸ä¼šå¯¼è‡´å®Œå…¨æ··ä¹±ã€‚è¿™æ˜¯å› ä¸ºHaskell I/Oå†…éƒ¨çœŸçš„éå¸¸ä¸åŒã€‚Haskellæ˜¯ä¸€ç§çº¯è¯­è¨€ï¼Œç”šè‡³I/Oç³»ç»Ÿä¹Ÿæ— æ³•æ‰“ç ´è¿™ç§çº¯åº¦ã€‚\nä»¥ä¸‹æ­£æ–‡è¯•å›¾è§£é‡ŠHaskell I/Oå®ç°çš„ç»†èŠ‚ï¼Œè¿™ä¸ªè§£é‡Šåº”è¯¥å¯ä»¥å¸®åŠ©ä½ æœ€ç»ˆæŒæ¡æ‰€æœ‰çš„æ™ºèƒ½I/OæŠ€å·§ã€‚æ­¤å¤–ï¼Œæˆ‘å·²ç»æ·»åŠ äº†æ‚¨å¯èƒ½é‡åˆ°çš„å„ç§é™·é˜±çš„è¯¦ç»†è¯´æ˜ã€‚é˜…è¯»æœ¬æ–‡åï¼Œæ‚¨å°†è·å¾—\"Haskell I/Oå¤§å¸ˆ\"å­¦ä½ï¼Œè¯¥å­¦ä½åŒç­‰äºè®¡ç®—æœºç§‘å­¦å’Œæ•°å­¦å­¦å£«å­¦ä½ã€‚\nå¦‚æœæ‚¨æ˜¯Haskell I/Oæ–°æ‰‹ï¼Œæ‚¨å¯èƒ½æ›´æ„¿æ„ä»é˜…è¯»[IOç®€ä»‹](https://wiki.haskell.org/Introduction_to_IO)å¼€å§‹\n\n#### Haskellæ˜¯ä¸€é—¨çº¯è¯­è¨€\nHaskellæ˜¯ä¸€é—¨çº¯è¯­è¨€ï¼Œè¿™æ„å‘³ç€ä»»ä½•å‡½æ•°è°ƒç”¨çš„ç»“æœå®Œå…¨ç”±å…¶å‚æ•°å†³å®šï¼ŒåƒCä¸­çš„`rand()`æˆ–`getchar()`è¿™æ ·çš„ä¼ªå‡½æ•°åœ¨æ¯æ¬¡è°ƒç”¨æ—¶éƒ½ä¼šè¿”å›ä¸åŒçš„ç»“æœï¼Œè¿™äº›å‡½æ•°æ ¹æœ¬ä¸å¯èƒ½åœ¨Haskellä¸­ç¼–å†™ã€‚è€Œä¸”ï¼ŒHaskellå‡½æ•°ä¸èƒ½æœ‰å‰¯ä½œç”¨ï¼Œè¿™æ„å‘³ç€è¿™äº›å‡½æ•°ä¸èƒ½å¯¹\"çœŸå®ä¸–ç•Œ\"åšä»»ä½•æ›´æ”¹ï¼Œä¾‹å¦‚ï¼šæ›´æ”¹æ–‡ä»¶/å†™å…¥æ–‡ä»¶/æ‰“å°/é€šè¿‡ç½‘ç»œå‘é€æ•°æ®ç­‰ã€‚è¿™ä¸¤ä¸ªé™åˆ¶ä¸€èµ·æ„å‘³ç€ä»»ä½•å‡½æ•°è°ƒç”¨éƒ½å¯ä»¥è¢«å…·æœ‰ç›¸åŒå‚æ•°çš„å…ˆå‰è°ƒç”¨çš„ç»“æœæ›¿æ¢ï¼Œå¹¶ä¸”è¯­è¨€ä¿è¯æ‰€æœ‰è¿™äº›é‡æ–°æ’åˆ—ä¸ä¼šæ”¹å˜ç¨‹åºç»“æœ!\n\nè®©æˆ‘ä»¬å°†å…¶ä¸Cè¯­è¨€è¿›è¡Œæ¯”è¾ƒ: ä¼˜åŒ–Cç¼–è¯‘å™¨å°è¯•çŒœæµ‹å“ªäº›å‡½æ•°æ²¡æœ‰å‰¯ä½œç”¨ï¼Œå¹¶ä¸”ä¸ä¾èµ–äºå¯å˜å…¨å±€å˜é‡ã€‚å¦‚æœè¿™ä¸ªçŒœæµ‹é”™äº†ï¼Œä¼˜åŒ–å¯ä»¥æ”¹å˜ç¨‹åºçš„è¯­ä¹‰ï¼ä¸ºäº†é¿å…è¿™ç§ç¾éš¾ï¼ŒCä¼˜åŒ–å™¨åœ¨çŒœæµ‹ä¸­æ˜¯ä¿å®ˆçš„ï¼Œæˆ–è€…éœ€è¦ç¨‹åºå‘˜æä¾›æœ‰å…³å‡½æ•°çº¯åº¦çš„æç¤ºã€‚\n\nä¸ä¼˜åŒ–çš„Cç¼–è¯‘å™¨ç›¸æ¯”ï¼ŒHaskellç¼–è¯‘å™¨æ˜¯ä¸€ç»„çº¯æ•°å­¦è½¬æ¢ã€‚è¿™å¯¼è‡´æ›´å¥½çš„é«˜çº§ä¼˜åŒ–è®¾æ–½ã€‚æ­¤å¤–ï¼Œçº¯æ•°å­¦è®¡ç®—å¯ä»¥æ›´å®¹æ˜“åœ°åˆ†æˆå‡ ä¸ªå¯ä»¥å¹¶è¡Œæ‰§è¡Œçš„çº¿ç¨‹ï¼Œè¿™åœ¨å¤šæ ¸CPUçš„è¿™äº›æ—¥å­é‡Œè¶Šæ¥è¶Šé‡è¦ã€‚æœ€åï¼Œçº¯è®¡ç®—ä¸æ˜“å‡ºé”™ä¸”æ›´å®¹æ˜“éªŒè¯ï¼Œè¿™å¢åŠ äº†Haskellçš„ç¨³å¥æ€§å’Œä½¿ç”¨Haskellçš„ç¨‹åºå¼€å‘é€Ÿåº¦ã€‚Haskellçº¯åº¦å…è®¸ç¼–è¯‘å™¨åªè°ƒç”¨å…¶ç»“æœç¡®å®éœ€è¦è®¡ç®—é«˜çº§å‡½æ•°çš„æœ€ç»ˆå€¼çš„å‡½æ•°(ä¾‹å¦‚: main) - è¿™ç§°ä¸ºæƒ°æ€§æ±‚å€¼ã€‚çº¯ç²¹çš„æ•°å­¦è®¡ç®—æ˜¯ä»¶å¥½äº‹ï¼Œä½†æ˜¯I/OåŠ¨ä½œæ€ä¹ˆæ ·ï¼Ÿå‡½æ•°å¦‚ä¸‹:\n```\nputStrLn \"Press any key to begin formatting\"\n```\nä¸èƒ½è¿”å›ä»»ä½•æœ‰æ„ä¹‰çš„ç»“æœå€¼ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•ç¡®ä¿ç¼–è¯‘å™¨ä¸ä¼šçœç•¥æˆ–é‡æ–°æ’åºå…¶æ‰§è¡Œï¼Ÿæ€»çš„æ¥è¯´ï¼Œæˆ‘ä»¬å¦‚ä½•ä½¿ç”¨å®Œå…¨æƒ°æ€§çš„è¯­è¨€å¤„ç†æœ‰çŠ¶æ€çš„ç®—æ³•å’Œå‰¯ä½œç”¨ï¼Ÿè¿™ä¸ªé—®é¢˜åœ¨18å¹´çš„Haskellå¼€å‘ä¸­æå‡ºäº†è®¸å¤šä¸åŒçš„è§£å†³æ–¹æ¡ˆ(å‚è§Haskellçš„å†å²)ï¼Œå°½ç®¡ç°åœ¨åŸºäºmonadsçš„è§£å†³æ–¹æ¡ˆå·²æˆä¸ºæ ‡å‡†ã€‚\n\n#### monadæ˜¯ä»€ä¹ˆ?\nä»€ä¹ˆæ˜¯monad? è¿™æ˜¯æ¥è‡ªæ•°å­¦èŒƒç•´ç†è®ºçš„ä¸œè¥¿ï¼Œæˆ‘ä¸çŸ¥é“äº†ã€‚ä¸ºäº†ç†è§£monadå¦‚ä½•ç”¨äºè§£å†³I/Oå’Œå‰¯ä½œç”¨çš„é—®é¢˜ï¼Œæ‚¨ä¸éœ€è¦çŸ¥é“å®ƒã€‚å°±åƒæˆ‘ä¸€æ ·ï¼ŒåªçŸ¥é“å°å­¦æ•°å­¦å°±è¶³å¤Ÿäº†ã€‚\nè®©æˆ‘ä»¬æƒ³è±¡ä¸€ä¸‹ï¼Œæˆ‘ä»¬æƒ³åœ¨Haskellä¸­å®ç°ä¼—æ‰€å‘¨çŸ¥çš„`getchar`å‡½æ•°ã€‚å®ƒåº”è¯¥æœ‰ä»€ä¹ˆæ ·çš„ç±»å‹ï¼Ÿæˆ‘ä»¬è¯•è¯•å§ï¼š\n```\ngetchar :: Char\n\nget2chars = [getchar,getchar]\n```\nåªæœ‰`Char`ç±»å‹çš„`getchar`å‡½æ•°ä¼šå¾—åˆ°ä»€ä¹ˆï¼Ÿæ‚¨å¯ä»¥åœ¨`get2chars`çš„å®šä¹‰ä¸­çœ‹åˆ°æ‰€æœ‰å¯èƒ½å‡ºç°çš„é—®é¢˜ï¼š\n* å› ä¸ºHaskellç¼–è¯‘å™¨å°†æ‰€æœ‰å‡½æ•°è§†ä¸ºçº¯å‡½æ•°(æ²¡æœ‰å‰¯ä½œç”¨)ï¼Œæ‰€ä»¥å®ƒå¯ä»¥é¿å…å¯¹`getchar`çš„\"è¿‡åº¦\"è°ƒç”¨, å¹¶ä½¿ç”¨ä¸¤æ¬¡è¿”å›å€¼.\n* å³ä½¿å®ƒç¡®å®è¿›è¡Œäº†ä¸¤æ¬¡è°ƒç”¨ï¼Œä¹Ÿæ— æ³•ç¡®å®šåº”é¦–å…ˆæ‰§è¡Œå“ªä¸ªè°ƒç”¨ã€‚ä½ æƒ³æŒ‰ç…§é˜…è¯»é¡ºåºæˆ–ç›¸åçš„é¡ºåºè¿”å›ä¸¤ä¸ªå­—ç¬¦å—ï¼Ÿ`get2chars`å®šä¹‰ä¸­æ²¡æœ‰ä»»ä½•å†…å®¹å¯ä»¥å›ç­”è¿™ä¸ªé—®é¢˜ã€‚\n\nä»ç¨‹åºå‘˜çš„è§’åº¦æ¥çœ‹ï¼Œå¦‚ä½•è§£å†³è¿™äº›é—®é¢˜å‘¢ï¼Ÿ\nè®©æˆ‘ä»¬ä¸º`getchar`å‡½æ•°å¢åŠ ä¸€ä¸ª\"ä¼ªè£…\"çš„å‚æ•°ï¼Œä½¿æ¯ä¸ªè°ƒç”¨ä¸ç¼–è¯‘å™¨çš„è§‚ç‚¹\"ä¸åŒ\":\n```\ngetchar :: Int -> Char\n\nget2chars = [getchar 1, getchar 2]\n```\né©¬ä¸Šï¼Œè¿™è§£å†³äº†ä¸Šé¢æåˆ°çš„ç¬¬ä¸€ä¸ªé—®é¢˜ - ç°åœ¨ç¼–è¯‘å™¨å°†è¿›è¡Œä¸¤æ¬¡è°ƒç”¨ï¼Œå› ä¸ºç¼–è¯‘å™¨å°†å®ƒä»¬è§†ä¸ºå…·æœ‰ä¸åŒçš„å‚æ•°ã€‚æ•´ä¸ª`get2chars`å‡½æ•°ä¹Ÿåº”è¯¥æœ‰ä¸€ä¸ª\"ä¼ªè£…\"å‚æ•°ï¼Œå¦åˆ™æˆ‘ä»¬ä¼šé‡åˆ°åŒæ ·çš„é—®é¢˜ï¼š\n```\ngetchar   :: Int -> Char\nget2chars :: Int -> String\n\nget2chars _ = [getchar 1, getchar 2]\n```\nç°åœ¨æˆ‘ä»¬éœ€è¦ç»™ç¼–è¯‘å™¨ä¸€äº›çº¿ç´¢æ¥ç¡®å®šå®ƒåº”è¯¥é¦–å…ˆè°ƒç”¨å“ªä¸ªå‡½æ•°ã€‚Haskellè¯­è¨€æ²¡æœ‰æä¾›ä»»ä½•è¡¨è¾¾è¯„ä¼°é¡ºåºçš„æ–¹æ³•......é™¤äº†æ•°æ®ä¾èµ–æ€§ï¼å¦‚ä½•æ·»åŠ ä¸€ä¸ªäººå·¥æ•°æ®ä¾èµ–é¡¹ï¼Œä»¥é˜²æ­¢åœ¨ç¬¬ä¸€ä¸ª`getchar`ä¹‹å‰è¯„ä¼°ç¬¬äºŒä¸ª`getchar`ï¼Ÿä¸ºäº†å®ç°è¿™ä¸€ç›®æ ‡ï¼Œæˆ‘ä»¬å°†ä»`getchar`å‡½æ•°è¿”å›ä¸€ä¸ªé¢å¤–çš„\"ä¼ªè£…\"ç»“æœï¼Œè¯¥\"ä¼ªè£…\"ç»“æœå°†ç”¨ä½œä¸‹ä¸€ä¸ª`getchar`å‡½æ•°è°ƒç”¨çš„å‚æ•°ï¼š\n```\ngetchar :: Int -> (Char, Int)\n\nget2chars _ = [a,b]  where (a,i) = getchar 1\n                           (b,_) = getchar i\n```\nåˆ°ç›®å‰ä¸ºæ­¢è¿˜ä¸é”™ - ç°åœ¨æˆ‘ä»¬å¯ä»¥ä¿è¯åœ¨è¯»`b`ä¹‹å‰è¯»å–`a`ï¼Œå› ä¸ºè¯»`b`éœ€è¦é€šè¿‡è¯»`a`è¿”å›çš„å€¼(`i`)!\næˆ‘ä»¬åœ¨`get2chars`ä¸­æ·»åŠ äº†ä¸€ä¸ª\"ä¼ªè£…\"å‚æ•°ï¼Œä½†é—®é¢˜æ˜¯Haskellç¼–è¯‘å™¨å¤ªèªæ˜äº†! å®ƒå¯ä»¥ç›¸ä¿¡å¤–éƒ¨`getchar`å‡½æ•°çœŸçš„ä¾èµ–äºå®ƒçš„å‚æ•°ï¼Œä½†æ˜¯å¯¹äº`get2chars`å‡½æ•°ï¼Œå®ƒä¼šçœ‹åˆ°æˆ‘ä»¬æ˜¯åœ¨ä½œå¼Šï¼Œå› ä¸ºæˆ‘ä»¬æ‰”æ‰äº†å®ƒ(å‚æ•°ä½¿ç”¨äº†_å ä½ç¬¦)! å› æ­¤ï¼Œç¼–è¯‘å™¨ä¸ä¼šè§‰å¾—æœ‰å¿…è¦æŒ‰ç…§æˆ‘ä»¬æƒ³è¦çš„é¡ºåºæ‰§è¡Œè°ƒç”¨ã€‚æˆ‘ä»¬è¯¥å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜? å°†è¿™ä¸ª\"è™šå‡\"çš„å‚æ•°ä¼ é€’ç»™`getchar`å‡½æ•°æ€ä¹ˆæ ·?! è¿™æ ·çš„è¯ï¼Œç¼–è¯‘å™¨å°±æ— æ³•çŒœæµ‹å®ƒæ˜¯å¦çœŸçš„æœªä½¿ç”¨è¿‡ã€‚\n\n```\nget2chars i0 = [a,b]  where (a,i1) = getchar i0\n                            (b,i2) = getchar i1\n```\nè¿˜æœ‰æ›´å¤š - `get2chars`å…·æœ‰ä¸`getchar`åŠŸèƒ½ç›¸åŒçš„çº¯åº¦é—®é¢˜ã€‚\nå¦‚æœéœ€è¦è°ƒç”¨`get2chars`ä¸¤æ¬¡ï¼Œåˆ™éœ€è¦ä¸€ç§æ–¹æ³•æ¥æè¿°è¿™äº›è°ƒç”¨çš„é¡ºåºã€‚çœ‹ç€ï¼š\n```\nget4chars = [get2chars 1, get2chars 2]  -- order of 'get2chars' calls isn't defined æœªå®šä¹‰'get2chars'è°ƒç”¨çš„é¡ºåº\n```\næˆ‘ä»¬å·²ç»çŸ¥é“å¦‚ä½•å¤„ç†è¿™äº›é—®é¢˜ - `get2chars`å‡½æ•°ä¹Ÿåº”è¯¥è¿”å›ä¸€äº›å¯ä»¥ç”¨æ¥é¡ºåºè°ƒç”¨çš„\"ä¼ªè£…\"å€¼ï¼š\n```\nget2chars :: Int -> (String, Int)\n\nget4chars i0 = (a++b)  where (a,i1) = get2chars i0\n                             (b,i2) = get2chars i1\n```\nä½†æ˜¯`get2chars`å‡½æ•°åº”è¯¥è¿”å›ä»€ä¹ˆ\"ä¼ªè£…\"å€¼ï¼Ÿå¦‚æœæˆ‘ä»¬ä½¿ç”¨ä¸€äº›æ•´æ•°å¸¸é‡ï¼Œé‚£ä¹ˆè¿‡äºèªæ˜çš„Haskellç¼–è¯‘å™¨ä¼šçŒœæµ‹æˆ‘ä»¬æƒ³å†æ¬¡ä½œå¼Šã€‚å¦‚ä½•è¿”å›`getchar`å‡½æ•°è¿”å›çš„å€¼ï¼Ÿçœ‹ï¼š\n```\nget2chars :: Int -> (String, Int)\nget2chars i0 = ([a,b], i2)  where (a,i1) = getchar i0\n                                  (b,i2) = getchar i1\n```\nä¿¡ä¸ä¿¡ç”±ä½ ï¼Œä½†æˆ‘ä»¬åˆšåˆšå·²ç»æ„å»ºäº†æ•´ä¸ª`monadic` Haskell I/Oç³»ç»Ÿã€‚\n\n#### æ¬¢è¿æ¥åˆ°çœŸå®ä¸–ç•Œï¼Œå®è´\nè­¦å‘Šï¼šå…³äºIOçš„ä»¥ä¸‹æ•…äº‹æ˜¯ä¸æ­£ç¡®çš„ï¼Œå› ä¸ºå®ƒæ— æ³•å®é™…è§£é‡ŠIOçš„ä¸€äº›é‡è¦æ–¹é¢ï¼ˆåŒ…æ‹¬äº¤äº’å’Œå¹¶å‘ï¼‰ã€‚ä½†æ˜¯ï¼Œæœ‰äº›äººå‘ç°å¼€å§‹ç†è§£æ˜¯æœ‰ç”¨çš„ã€‚\nHaskell `main`å‡½æ•°å…·æœ‰ä»¥ä¸‹ç±»å‹:\n```\nmain :: RealWorld -> ((), RealWorld)\n```\nå…¶ä¸­`RealWorld`æ˜¯ä¸€ç§\"ä¼ªè£…\"çš„ç±»å‹ï¼Œç”¨æ¥æ›¿æ¢æˆ‘ä»¬çš„Intã€‚\nè¿™å°±åƒåœ¨æ¥åŠ›èµ›ä¸­æ¥è¿‡çš„æ¥åŠ›æ£’ã€‚å½“`main`å‡½æ•°è°ƒç”¨æŸäº›IOå‡½æ•°æ—¶ï¼Œå®ƒå°†ä½œä¸ºå‚æ•°æ”¶åˆ°çš„\"RealWorld\"ä¼ é€’ç»™äº†IOå‡½æ•°ã€‚æ‰€æœ‰IOå‡½æ•°éƒ½æœ‰ç±»ä¼¼çš„ç±»å‹ï¼Œæ¶‰åŠ`RealWorld`ä½œä¸ºå‚æ•°å’Œç»“æœã€‚ç¡®åˆ‡åœ°è¯´ï¼Œ`IO`æ˜¯ä»¥ä¸‹åˆ—æ–¹å¼å®šä¹‰çš„ç±»å‹åŒä¹‰è¯ï¼š\n```\ntype IO a  =  RealWorld -> (a, RealWorld)\n```\nå› æ­¤ï¼Œ`main`å‡½æ•°åªæœ‰ç±»å‹`IO()`ï¼Œ`getChar`å‡½æ•°æœ‰ç±»å‹`IO Char`,ç­‰ç­‰ã€‚æ‚¨å¯ä»¥å°†`IO Char`ç±»å‹è§†ä¸º\"è·å–å½“å‰çš„`RealWorld`ï¼Œå¯¹å…¶æ‰§è¡ŒæŸäº›æ“ä½œï¼Œå¹¶è¿”å›`Char`å’Œï¼ˆå¯èƒ½å·²æ›´æ”¹çš„ï¼‰`RealWorld`ã€‚è®©æˆ‘ä»¬çœ‹`main`è°ƒç”¨`getChar`ä¸¤æ¬¡ï¼š\n```\ngetChar :: RealWorld -> (Char, RealWorld)\n\nmain :: RealWorld -> ((), RealWorld)\nmain world0 = let (a, world1) = getChar world0\n                  (b, world2) = getChar world1\n              in ((), world2)\n```\nä»”ç»†çœ‹çœ‹ï¼š`main`å‡½æ•°å°†æ”¶åˆ°çš„`world0`ä¼ é€’ç»™ç¬¬ä¸€ä¸ª`getChar`å‡½æ•°ã€‚ è¿™ä¸ª`getChar`å‡½æ•°è¿”å›ä¸€äº›`RealWorld`ç±»å‹çš„æ–°å€¼ï¼Œå®ƒå°†åœ¨ä¸‹ä¸€æ¬¡è°ƒç”¨ä¸­ä½¿ç”¨ã€‚æœ€åï¼Œ`main`è¿”å›å®ƒä»ç¬¬äºŒä¸ª`getChar`è·å¾—çš„`world2`ã€‚\n* å¦‚æœæ²¡æœ‰ä½¿ç”¨å®ƒè¯»å–çš„å­—ç¬¦ï¼Œè¿™é‡Œæ˜¯å¦å¯ä»¥çœç•¥ä»»ä½•`getChar`è°ƒç”¨ï¼Ÿä¸ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦è¿”å›ç¬¬äºŒä¸ª`getChar`ç»“æœçš„`world2`ï¼Œè¿™åˆéœ€è¦ä»ç¬¬ä¸€ä¸ª`getChar`è¿”å›çš„`world1`ã€‚\n* æ˜¯å¦å¯ä»¥é‡æ–°æ’åº`getChar`è°ƒç”¨ï¼Ÿ å¦ï¼šç¬¬äºŒä¸ª`getChar`åœ¨ç¬¬ä¸€ä¸ªä¹‹å‰æ— æ³•è°ƒç”¨ï¼Œå› ä¸ºå®ƒä½¿ç”¨äº†ç¬¬ä¸€æ¬¡è°ƒç”¨è¿”å›çš„`world1`.\n* æ˜¯å¦å¯ä»¥é‡å¤è°ƒç”¨ï¼Ÿ åœ¨Haskellè¯­ä¹‰ä¸­ - æ˜¯çš„ï¼Œä½†çœŸæ­£çš„ç¼–è¯‘å™¨æ°¸è¿œä¸ä¼šåœ¨è¿™ç§ç®€å•çš„æƒ…å†µä¸‹é‡å¤å·¥ä½œï¼ˆå¦åˆ™ï¼Œç”Ÿæˆçš„ç¨‹åºå°†æ²¡æœ‰ä»»ä½•é€Ÿåº¦ä¿è¯ï¼‰ã€‚\n\næ­£å¦‚æˆ‘ä»¬å·²ç»è¯´è¿‡çš„é‚£æ ·ï¼ŒRealWorldå€¼è¢«ç”¨ä½œä¸€ä¸ªæ¥åŠ›æ£’ï¼Œå®ƒåœ¨ä¸¥æ ¼çš„é¡ºåºä¸­è¢«`main`è°ƒç”¨çš„æ‰€æœ‰ä¾‹ç¨‹ä¹‹é—´ä¼ é€’ã€‚åœ¨æ¯ä¸ªä¾‹ç¨‹ä¸­ï¼ŒRealWorldå€¼ä»¥ç›¸åŒçš„æ–¹å¼ä½¿ç”¨ã€‚ æ€»çš„æ¥è¯´ï¼Œä¸ºäº†\"è®¡ç®—\"ä»`main`è¿”å›çš„`world`ï¼Œæˆ‘ä»¬åº”è¯¥ç›´æ¥æˆ–é—´æ¥åœ°æ‰§è¡Œä»`main`è°ƒç”¨çš„æ¯ä¸ªIOè¿‡ç¨‹ã€‚è¿™æ„å‘³ç€æ’å…¥é“¾ä¸­çš„æ¯ä¸ªç¨‹åºéƒ½å°†åœ¨æˆ‘ä»¬æ‰“ç®—è°ƒç”¨å®ƒæ—¶æ‰§è¡Œ(ç›¸å¯¹äºå…¶ä»–IOæ“ä½œ)ã€‚è®©æˆ‘ä»¬è€ƒè™‘ä»¥ä¸‹ç¨‹åºï¼š\n```\nmain = do a <- ask \"What is your name?\"\n          b <- ask \"How old are you?\"\n          return ()\n\nask s = do putStr s\n           readLn\n```\nç°åœ¨ä½ æœ‰è¶³å¤Ÿçš„çŸ¥è¯†ä»¥ä½çº§åˆ«æ–¹å¼é‡å†™å®ƒï¼Œå¹¶æ£€æŸ¥æ¯ä¸ªåº”è¯¥æ‰§è¡Œçš„æ“ä½œæ˜¯å¦çœŸçš„å°†ä½¿ç”¨å®ƒåº”è¯¥å…·æœ‰çš„å‚æ•°å¹¶æŒ‰ç…§æˆ‘ä»¬æœŸæœ›çš„é¡ºåºæ‰§è¡Œ(ç»ƒä¹ )ã€‚\nä½†æ˜¯æ¡ä»¶æ‰§è¡Œå‘¢ï¼Ÿæ²¡é—®é¢˜ã€‚è®©æˆ‘ä»¬å®šä¹‰ä¼—æ‰€å‘¨çŸ¥çš„`when`æ“ä½œï¼š\n```\nwhen :: Bool -> IO () -> IO ()\nwhen condition action world =\n    if condition\n      then action world\n      else ((), world)\n```\nå¦‚æ‚¨æ‰€è§ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®æ•°æ®å€¼è½»æ¾åœ°åœ¨æ‰§è¡Œé“¾ä¸­åŒ…å«æˆ–æ’é™¤IOè¿‡ç¨‹(æ“ä½œ)ï¼Œå¦‚æœåœ¨`when`çš„è°ƒç”¨ä¸­`condition`ä¸ºFalseï¼Œé‚£ä¹ˆ`action`å°†æ°¸è¿œä¸ä¼šè¢«è°ƒç”¨ï¼Œå› ä¸ºçœŸå®çš„Haskellç¼–è¯‘å™¨ï¼Œä»ä¸è°ƒç”¨å…¶ç»“æœä¸ç”¨äºæœ€ç»ˆç»“æœçš„å‡½æ•°(ä¾‹å¦‚: è¿™é‡Œmainå‡½æ•°çš„`world`æœ€ç»ˆå€¼)ã€‚å¾ªç¯å’Œæ›´å¤æ‚çš„æ§åˆ¶ç»“æ„å¯ä»¥ä»¥ç›¸åŒçš„æ–¹å¼å®ç°ã€‚è¯•è¯•çœ‹å§ï¼\næœ€åï¼Œä½ å¯èƒ½æƒ³è¦çŸ¥é“ï¼Œåœ¨ç¨‹åºä¸­ä¼ é€’è¿™äº›RealWorldå€¼éœ€è¦èŠ±è´¹çš„æˆæœ¬ï¼Œå®ƒæ˜¯å…è´¹çš„ï¼Œè¿™äº›\"ä¼ªè£…\"å€¼ä»…åœ¨ç¼–è¯‘å™¨åˆ†æå’Œä¼˜åŒ–ä»£ç æ—¶å­˜åœ¨ï¼Œä½†æ˜¯å½“å®ƒè¿›å…¥æ±‡ç¼–ä»£ç ç”Ÿæˆæ—¶ï¼Œå®ƒ\"çªç„¶\"æ„è¯†åˆ°è¿™ç§ç±»å‹å°±åƒ`()`ï¼Œå› æ­¤æ‰€æœ‰çš„è¿™äº›å‚æ•°å’Œç»“æœå€¼éƒ½å¯ä»¥ä»æœ€ç»ˆç”Ÿæˆçš„ä»£ç ä¸­çœç•¥ã€‚è¿™ä¸æ¼‚äº®å—ï¼Ÿ\n\n#### `>>=` å’Œ `do` è¡¨ç¤ºæ³•\næ‰€æœ‰åˆå­¦è€…(åŒ…æ‹¬æˆ‘)éƒ½è®¤ä¸º`do`æ˜¯æ‰§è¡ŒIOåŠ¨ä½œçš„é­”æœ¯è¯­å¥ã€‚é‚£æ˜¯é”™çš„,`do`åªæ˜¯è¯­æ³•ç³–ï¼Œå®ƒç®€åŒ–äº†ä½¿ç”¨IO(ä»¥åŠå…¶ä»–monadçš„ç¨‹åº)çš„ç¼–å†™ï¼Œä½†è¿™è¶…å‡ºäº†æœ¬æ•™ç¨‹çš„èŒƒå›´ã€‚`do`ç¬¦å·æœ€ç»ˆè¢«è½¬æ¢ä¸ºä¼ é€’`world`å€¼çš„è¯­å¥ï¼Œå°±åƒæˆ‘ä»¬ä¸Šé¢æ‰‹åŠ¨ç¼–å†™çš„é‚£æ ·ï¼Œç”¨äºç®€åŒ–å‡ ä¸ªIOæ“ä½œçš„ç²˜åˆã€‚æ‚¨ä¸éœ€è¦åªä¸ºä¸€æ¡è¯­å¥ä½¿ç”¨`do`è¯­å¥,ä¾‹å¦‚:\n```\nmain = do putStr \"Hello!\"\n```\nè„±ç³–å:\n```\nmain = putStr \"Hello!\"\n```\nè®©æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ä½¿ç”¨å¤šä¸ªè¯­å¥æ¥è§£é‡Š`do`\n```\nmain = do putStr \"What is your name?\"\n          putStr \"How old are you?\"\n          putStr \"Nice day!\"\n```\nè¿™é‡Œçš„`do`è¯­å¥åªæ˜¯åŠ å…¥äº†åº”è¯¥æŒ‰é¡ºåºæ‰§è¡Œçš„å‡ ä¸ªIOåŠ¨ä½œã€‚å®ƒè¢«ç¿»è¯‘æˆä¸€ä¸ªæ‰€è°“çš„\"ç»‘å®šè¿ç®—ç¬¦\"çš„é¡ºåºåº”ç”¨ç¨‹åºï¼Œå³`>>`ï¼š\n```\nmain = (putStr \"What is your name?\") >> ((putStr \"How old are you?\") >> (putStr \"Nice day!\"))\n```\nè¿™ä¸ªç»‘å®šæ“ä½œç¬¦åªæ˜¯ç»“åˆäº†ä¸¤ä¸ªIOåŠ¨ä½œï¼Œé€šè¿‡åœ¨å®ƒä»¬ä¹‹é—´ä¼ é€’`world`æ¥é¡ºåºæ‰§è¡Œå®ƒä»¬ï¼š\n```\n(>>) :: IO a -> IO b -> IO b\n(action1 >> action2) world0 =\n   let (a, world1) = action1 world0\n       (b, world2) = action2 world1\n   in (b, world2)\n```\nå¦‚æœä»¥è¿™ç§æ–¹å¼å®šä¹‰è¿ç®—ç¬¦å¯¹æ‚¨æ¥è¯´å¾ˆå¥‡æ€ªï¼Œè¯·æŒ‰ä»¥ä¸‹æ–¹å¼é˜…è¯»æ­¤å®šä¹‰ï¼š\n```\naction1 >> action2 = action\n  where\n    action world0 = let (a, world1) = action1 world0\n                        (b, world2) = action2 world1\n                    in (b, world2)\n```\nç°åœ¨ï¼Œæ‚¨å¯ä»¥åœ¨ä½¿ç”¨`>>`çš„ä½ç½®æ›¿æ¢å…¶å®šä¹‰ï¼Œå¹¶æ£€æŸ¥ç”±`do`è¯­æ³•ç³–æ„é€ çš„ç¨‹åºå®é™…ä¸Šä¸æˆ‘ä»¬é€šè¿‡æ‰‹åŠ¨æ“ä½œ`world`å€¼ç¼–å†™çš„ç¨‹åºç›¸åŒã€‚\n\næ›´å¤æ‚çš„ç¤ºä¾‹æ¶‰åŠä½¿ç”¨`<-`ç»‘å®šçš„å˜é‡ï¼š\n```\nmain = do \n   a <- readLn\n   print a\n```\nè¿™æ®µä»£ç å¯ä»¥è„±ç³–ä¸º:\n```\nmain = readLn >>= (\\a -> print a)\n```\næ­£å¦‚æ‚¨åº”è¯¥è®°ä½çš„é‚£æ ·,`>>`ç»‘å®šæ“ä½œç¬¦é»˜é»˜åœ°å¿½ç•¥å…¶ç¬¬ä¸€ä¸ª`action`çš„å€¼ï¼Œä»…å°†å…¶ç¬¬äºŒä¸ª`action`çš„ç»“æœåšä¸ºæ•´ä½“ç»“æœè¿”å›ã€‚\nå¦ä¸€æ–¹é¢,`>>=`ç»‘å®šæ“ä½œç¬¦(æ³¨æ„æœ«å°¾çš„é¢å¤–'=')å…è®¸æˆ‘ä»¬ä½¿ç”¨å…¶ç¬¬ä¸€ä¸ª`action`çš„ç»“æœ, å¹¶å°†å…¶ä½œä¸ºé™„åŠ å‚æ•°ä¼ é€’ç»™ç¬¬äºŒä¸ª`action`,çœ‹çœ‹å®šä¹‰ï¼š\n```\n(>>=) :: IO a -> (a -> IO b) -> IO b\n(action1 >>= action2) world0 =\n   let (a, world1) = action1 world0\n       (b, world2) = action2 a world1\n   in (b, world2)\n```\né¦–å…ˆ,ç¬¬äºŒä¸ª`action`çš„ç±»å‹(æ›´å‡†ç¡®åœ°è¯´,æ˜¯ä¸€ä¸ªè¿”å›IO actionçš„å‡½æ•°),å³`a -> IO b`æ˜¯ä»€ä¹ˆæ„æ€? \né€šè¿‡æ›¿æ¢IOå®šä¹‰,æˆ‘ä»¬å¾—åˆ°`a -> RealWorld -> (b, RealWorld)`,è¿™æ„å‘³ç€ç¬¬äºŒä¸ªactionå®é™…ä¸Šæœ‰ä¸¤ä¸ªå‚æ•°: å®é™…åœ¨å…¶ä¸­ä½¿ç”¨çš„ç±»å‹`a`,ä»¥åŠç”¨äºIO actionæ’åºçš„`RealWorld`ç±»å‹çš„å€¼. \næƒ…å†µæ€»æ˜¯å¦‚æ­¤,ä¸æ‚¨åœ¨å…¶ç±»å‹ç­¾åä¸­çœ‹åˆ°çš„ç›¸æ¯”è¾ƒ,ä»»ä½•IOè¿‡ç¨‹éƒ½å¦æœ‰ä¸€ä¸ªå‚æ•°,æ­¤å‚æ•°éšè—åœ¨åˆ«å\"IO\"çš„å®šä¹‰ä¸­ã€‚\nå…¶æ¬¡,æ‚¨å¯ä»¥ä½¿ç”¨`>>`å’Œ`>>=`è¿™äº›æ“ä½œæ¥ç®€åŒ–æ‚¨çš„ç¨‹åºã€‚ä¾‹å¦‚,åœ¨ä¸Šé¢çš„ä»£ç ä¸­æˆ‘ä»¬ä¸éœ€è¦å¼•å…¥å˜é‡a,å› ä¸º`readLn`çš„ç»“æœå¯ä»¥ç›´æ¥å‘é€åˆ°`print`:\n```\nmain = readLn >>= print\n```\nç¬¬ä¸‰,å¦‚ä½ æ‰€è§,ç¬¦å·ï¼š\n```\ndo x <- action1\n    action2\n```\nå…¶ä¸­`action1`çš„ç±»å‹ä¸º`IO a`,è€Œ`action2`çš„ç±»å‹ä¸º`IO b`,è½¬æ¢ä¸ºï¼š\n```\naction1 >>= (\\x -> action2)\n```\nå…¶ä¸­`>>=`çš„ç¬¬äºŒä¸ªå‚æ•°çš„ç±»å‹ä¸º`a -> IO b`,è¿™å°±æ˜¯å¤„ç†`<-`ç»‘å®šçš„æ–¹å¼: `<-`å·¦ä¾§çš„åç§°åªæ˜¯åç»­æ“ä½œçš„ä¸€ä¸ªå‚æ•°,è¡¨ç¤ºä¸ºä¸€ä¸ªå¤§çš„IO action.\nå¦è¯·æ³¨æ„,å¦‚æœ`action1`çš„ç±»å‹ä¸º`IO a`,é‚£ä¹ˆ`x`å°†åªæœ‰ç±»å‹`a`; æ‚¨å¯ä»¥å°†`<-`çš„æ•ˆæœè§†ä¸ºå°†`action1`çš„IOå€¼\"è§£åŒ…\"ä¸º`x`.\nè¿˜è¦æ³¨æ„`<-`ä¸æ˜¯çœŸæ­£çš„è¿ç®—ç¬¦,å®ƒæ˜¯çº¯è¯­æ³•,å°±åƒ`do`æœ¬èº«ä¸€æ ·,å®ƒçš„å«ä¹‰åªå–å†³äºå®ƒè¢«è„±ç³–çš„æ–¹å¼.\n\nçœ‹ä¸‹ä¸€ä¸ªä¾‹å­:\n```\nmain = do putStr \"What is your name?\"\n          a <- readLn\n          putStr \"How old are you?\"\n          b <- readLn\n          print (a,b)\n```\nè¿™æ®µä»£ç å¯ä»¥è„±ç³–ä¸º:\n```\nmain = putStr \"What is your name?\"\n       >> readLn\n       >>= \\a -> putStr \"How old are you?\"\n       >> readLn\n       >>= \\b -> print (a,b)\n```\næˆ‘åœ¨è¿™é‡Œçœç•¥äº†æ‹¬å·,`>>`å’Œ`>>=`è¿ç®—ç¬¦éƒ½æ˜¯å·¦å…³è”çš„,ä½†æ˜¯lambdaç»‘å®šæ€»æ˜¯å°½å¯èƒ½å‘å³å»¶ä¼¸,è¿™æ„å‘³ç€è¿™é‡Œå¼•å…¥çš„`a`å’Œ`b`ç»‘å®šå¯¹æ‰€æœ‰å‰©ä½™çš„åŠ¨ä½œéƒ½æœ‰æ•ˆ.\nä½œä¸ºç»ƒä¹ ,è‡ªå·±æ·»åŠ æ‹¬å·å¹¶å°†æ­¤è¿‡ç¨‹è½¬æ¢ä¸ºæ˜¾å¼ä¼ é€’`world`å€¼çš„ä½çº§ä»£ç (ç»ƒä¹ ),æˆ‘è®¤ä¸ºè¿™åº”è¯¥è¶³ä»¥å¸®åŠ©æ‚¨æœ€ç»ˆäº†è§£`do`è½¬æ¢å’Œç»‘å®šæ“ä½œç¬¦`>>=`çš„å·¥ä½œåŸç†.\n\nä¸å¥½,æˆ‘å¿˜è®°äº†ç¬¬ä¸‰ä¸ªmonadicè¿ç®—ç¬¦: `return`,å®ƒåªæ˜¯ç»“åˆäº†å®ƒçš„ä¸¤ä¸ªå‚æ•°: ä¼ é€’çš„å€¼å’Œ`world`:\n```\nreturn :: a -> IO a\nreturn a world0 = (a, world0)\n```\nè½¬æ¢ä¸€ä¸ªç®€å•çš„`return`ç”¨æ³•ç¤ºä¾‹æ€ä¹ˆæ ·ï¼Ÿè¯´ï¼Œ\n```\nmain = do a <- readLn\n          return (a*2)\n```\nå…·æœ‰å‘½ä»¤å¼è¯­è¨€èƒŒæ™¯çš„ç¨‹åºå‘˜é€šå¸¸è®¤ä¸ºHaskellä¸­çš„`return`ä¸å…¶ä»–è¯­è¨€ä¸€æ ·,ä¼šç«‹å³ä»IOè¿‡ç¨‹è¿”å›.æ­£å¦‚ä½ åœ¨å…¶å®šä¹‰ä¸­çœ‹åˆ°çš„é‚£æ ·(ç”šè‡³åªæ˜¯ä»å®ƒçš„ç±»å‹),è¿™æ ·çš„å‡è®¾æ˜¯å®Œå…¨é”™è¯¯çš„,\nä½¿ç”¨`return`çš„å”¯ä¸€ç›®çš„æ˜¯å°†ä¸€äº›å€¼(ç±»å‹ä¸º'a')`lift`åˆ°æ•´ä¸ªåŠ¨ä½œçš„ç»“æœä¸­(ç±»å‹ä¸º`IO a`),å› æ­¤å®ƒé€šå¸¸åº”è¯¥ä»…ç”¨ä½œæŸä¸ªIOåºåˆ—çš„æœ€åæ‰§è¡Œè¯­å¥,ä¾‹å¦‚,å°è¯•å°†ä»¥ä¸‹è¿‡ç¨‹è½¬æ¢ä¸ºç›¸åº”çš„ä½çº§ä»£ç (ç»ƒä¹ )ï¼š\n```\nmain = do a <- readLn\n          when (a>=0) $ do\n              return ()\n          print \"a is negative\"\n```\nå¹¶ä¸”æ‚¨å°†æ„è¯†åˆ°å³ä½¿å¯¹äº`a`çš„éè´Ÿå€¼,ä¹Ÿä¼šæ‰§è¡Œ`print`è¯­å¥. å¦‚æœéœ€è¦ä»IOè¿‡ç¨‹ä¸­é—´é€€å‡º,å¯ä»¥ä½¿ç”¨`if`è¯­å¥:\n```\nain = do a <- readLn\n          if (a>=0)\n            then return ()\n            else print \"a is negative\"\n```\nè€Œä¸”ï¼ŒHaskellè®¾è®¡è§„åˆ™å…è®¸æˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹è®¾è®¡:\n```\nmain = do a <- readLn\n          if (a>=0) then return ()\n            else do\n          print \"a is negative\"\n          ...\n```\nè¿™å¯èƒ½æœ‰åŠ©äºä»å†—é•¿çš„`do`è¯­å¥ä¸­é€ƒè„±ã€‚\n\næœ€åä¸€ä¸ªç»ƒä¹ : å®ç°ä¸€ä¸ªå‡½æ•°`liftM`.å®ƒå°†æ™®é€šå€¼çš„æ“ä½œæå‡åˆ°monadicçš„æ“ä½œ,å®ƒçš„ç±»å‹ç­¾å:\n```\nliftM :: (a -> b) -> (IO a -> IO b)\n```\nå¦‚æœè¿™å¯¹æ‚¨æ¥è¯´å¤ªéš¾äº†,è¯·ä»ä»¥ä¸‹é«˜çº§å®šä¹‰å¼€å§‹å¹¶ä»¥ä½çº§æ–¹å¼é‡å†™å®ƒ(ç»ƒä¹ ):\n```\nliftM f action = do \n\t    x <- action\n            return (f x)\n```\n\n#### å¯å˜æ•°æ®(å¼•ç”¨/æ•°ç»„/å“ˆå¸Œè¡¨)\næ­£å¦‚æ‚¨åº”è¯¥çŸ¥é“çš„,Haskellä¸­çš„æ¯ä¸ªåç§°éƒ½ç»‘å®šåˆ°ä¸€ä¸ªå›ºå®š(ä¸å¯å˜)å€¼,è¿™å¤§å¤§ç®€åŒ–äº†ç†è§£ç®—æ³•å’Œä»£ç ä¼˜åŒ–,ä½†åœ¨æŸäº›æƒ…å†µä¸‹è¿™æ˜¯ä¸åˆé€‚çš„,ä¼—æ‰€å‘¨çŸ¥,æœ‰è®¸å¤šç®—æ³•åœ¨å¯æ›´æ–°å˜é‡,æ•°ç»„ç­‰æ–¹é¢æ›´å®¹æ˜“å®ç°.\nè¿™æ„å‘³ç€ä¸å˜é‡å…³è”çš„å€¼(ä¾‹å¦‚,åœ¨ä¸åŒçš„æ‰§è¡Œç‚¹)å¯èƒ½ä¸åŒ,å› æ­¤è¯»å–å…¶å€¼ä¸èƒ½è§†ä¸ºçº¯å‡½æ•°.æƒ³è±¡ä¸€ä¸‹,ä¾‹å¦‚,ä»¥ä¸‹ä»£ç :\n```\nmain = do let a0 = readVariable varA\n              _  = writeVariable varA 1\n              a1 = readVariable varA\n          print (a0, a1)\n```\nè¿™çœ‹èµ·æ¥å¾ˆå¥‡æ€ªå—? é¦–å…ˆ,å¯¹`readVariable`çš„ä¸¤æ¬¡è°ƒç”¨çœ‹èµ·æ¥æ˜¯ä¸€æ ·çš„,å› æ­¤ç¼–è¯‘å™¨å¯ä»¥åªé‡ç”¨ç¬¬ä¸€æ¬¡è°ƒç”¨è¿”å›çš„å€¼. å…¶æ¬¡,ä¸ä½¿ç”¨`writeVariable`è°ƒç”¨çš„ç»“æœ,å› æ­¤ç¼–è¯‘å™¨å¯ä»¥(å¹¶ä¸”å°†ä¼š)å®Œå…¨çœç•¥æ­¤è°ƒç”¨,ä¸ºäº†å®Œæˆæè¿°,è¿™ä¸‰ä¸ªè°ƒç”¨å¯ä»¥æŒ‰ä»»ä½•é¡ºåºé‡æ–°æ’åˆ—,å› ä¸ºå®ƒä»¬çœ‹èµ·æ¥å½¼æ­¤ç‹¬ç«‹,è¿™æ˜¾ç„¶ä¸æ˜¯é¢„æœŸçš„. è§£å†³æ–¹æ¡ˆæ˜¯ä»€ä¹ˆï¼Ÿä½ å·²ç»çŸ¥é“äº†, ä½¿ç”¨IO actions, ä½¿ç”¨IO actionså¯ç¡®ä¿å®Œæˆ:\n* æŒ‰ç…§ä¹¦é¢å½¢å¼çš„é¡ºåºæ‰§è¡Œ\n* æ¯ä¸ªactionéƒ½å¿…é¡»æ‰§è¡Œ\n* ç›¸åŒactionçš„ç»“æœå°†ä¸ä¼šè¢«é‡ç”¨(ä¾‹å¦‚: `readVariable varA`)\næ‰€ä»¥,ä¸Šé¢çš„ä»£ç åº”è¯¥å†™æˆ:\n```\nimport Data.IORef\nmain = do varA <- newIORef 0  -- Create and initialize a new variable\n          a0 <- readIORef varA\n          writeIORef varA 1\n          a1 <- readIORef varA\n          print (a0, a1)\n```\nè¿™é‡Œ,`varA`çš„ç±»å‹ä¸º`IORef Int`,æ„æ€æ˜¯\"IO monadä¸­çš„ä¸€ä¸ªå˜é‡(å¼•ç”¨),æŒæœ‰ä¸€ä¸ªç±»å‹ä¸ºIntçš„å€¼\",`newIORef`åˆ›å»ºä¸€ä¸ªæ–°å˜é‡(å¼•ç”¨)å¹¶è¿”å›å®ƒ,ç„¶åä½¿ç”¨æ­¤å¼•ç”¨è¿›è¡Œè¯»/å†™æ“ä½œ,`readIORef varA`æ“ä½œè¿”å›çš„å€¼ä¸ä»…å–å†³äºæ‰€æ¶‰åŠçš„å˜é‡,è¿˜å–å†³äºæ‰§è¡Œæ­¤æ“ä½œçš„æ—¶åˆ»,å› æ­¤å®ƒå¯ä»¥åœ¨æ¯æ¬¡è°ƒç”¨æ—¶è¿”å›ä¸åŒçš„å€¼. æ•°ç»„,æ•£åˆ—è¡¨å’Œä»»ä½•å…¶ä»–_mutable_æ•°æ®ç»“æ„ä»¥ç›¸åŒçš„æ–¹å¼å®šä¹‰,å¯¹äºæ¯ä¸ªæ•°æ®ç»“æ„,éƒ½æœ‰ä¸€ä¸ªæ“ä½œå¯ä»¥åˆ›å»ºæ–°çš„\"å¯å˜å€¼\"å¹¶è¿”å›å¯¹å®ƒçš„å¼•ç”¨,ç„¶åä½¿ç”¨`IO monad`ä¸­çš„ç‰¹æ®Šè¯»å†™æ“ä½œ,ä»¥ä¸‹ä»£ç æ˜¾ç¤ºäº†ä½¿ç”¨å¯å˜æ•°ç»„çš„ç¤ºä¾‹:\n```\nimport Data.Array.IO\nmain = do arr <- newArray (1,10) 37 :: IO (IOArray Int Int)\n          a <- readArray arr 1\n          writeArray arr 1 64\n          b <- readArray arr 1\n          print (a, b)\n```\nè¿™é‡Œ,åˆ›å»ºäº†ä¸€ä¸ªç”±10ä¸ªå…ƒç´ ç»„æˆçš„æ•°ç»„,å…¶ä¸­37ä½œä¸ºæ¯ä¸ªä½ç½®çš„åˆå§‹å€¼,æ¥ç€å°†ç¬¬ä¸€ä¸ªå…ƒç´ (ç´¢å¼•ä¸º1)çš„å€¼è¯»å…¥å˜é‡`a`,ç„¶åå°†ç´¢å¼•ä¸º1çš„å…ƒç´ çš„å€¼è®¾ç½®ä¸º64,ç„¶åå†æ¬¡è¯»å…¥`b`,æ­£å¦‚æ‚¨é€šè¿‡æ‰§è¡Œæ­¤ä»£ç æ‰€çœ‹åˆ°çš„ï¼Œ`a`å°†è®¾ç½®ä¸º37,`b`å°†è®¾ç½®ä¸º64.\n\nå…¶ä»–ä¾èµ–äºçŠ¶æ€çš„æ“ä½œé€šå¸¸ä¹Ÿå®ç°ä¸ºIOæ“ä½œ,ä¾‹å¦‚,éšæœºæ•°ç”Ÿæˆå™¨åº”åœ¨æ¯æ¬¡è°ƒç”¨æ—¶è¿”å›ä¸åŒçš„å€¼ã€‚ç»™å®ƒä¸€ä¸ªæ¶‰åŠIOçš„ç±»å‹çœ‹èµ·æ¥å¾ˆè‡ªç„¶ï¼š\n```\nrand :: IO Int\n```\nå¦å¤–,å½“ä½ å¯¼å…¥Cä¾‹ç¨‹æ—¶ä½ åº”è¯¥å°å¿ƒ,å¦‚æœè¿™ä¸ªä¾‹ç¨‹ä¸çº¯,å³å®ƒçš„ç»“æœå–å†³äº\"çœŸå®ä¸–ç•Œ\"(æ–‡ä»¶ç³»ç»Ÿï¼Œå†…å­˜å†…å®¹......),å†…éƒ¨çŠ¶æ€ç­‰ç­‰,ä½ åº”è¯¥ç»™å®ƒæ˜¯ä¸€ç§IOç±»å‹,å¦åˆ™,ç¼–è¯‘å™¨å¯ä»¥\"ä¼˜åŒ–\"æ­¤ç¨‹åº(ä½¿ç”¨ç›¸åŒå‚æ•°çš„ç¨‹åº)çš„é‡å¤è°ƒç”¨.\nä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºä»¥ä¸‹å†…å®¹ç¼–å†™éIOç±»å‹ï¼š\n```\noreign import ccall\n   sin :: Double -> Double\n```\nå› ä¸º`sin`çš„ç»“æœåªå–å†³äºå®ƒçš„è®ºç‚¹ï¼Œä½†æ˜¯:\n```\nforeign import ccall\n   tell :: Int -> IO Int\n```\nå¦‚æœæ‚¨å°†`tell`å£°æ˜ä¸ºçº¯å‡½æ•°(æ²¡æœ‰IO),é‚£ä¹ˆæ‚¨å¯ä»¥åœ¨æ¯æ¬¡è°ƒç”¨æ—¶è·å¾—ç›¸åŒçš„ä½ç½®.\n\n#### IO actionsä½œä¸ºå€¼\nåˆ°ç›®å‰ä¸ºæ­¢,æ‚¨åº”è¯¥ç†è§£ä¸ºä»€ä¹ˆåœ¨éIO(çº¯)ç¨‹åºä¸­ä½¿ç”¨IOæ“ä½œæ˜¯ä¸å¯èƒ½çš„,è¿™æ ·çš„ç¨‹åºåªæ˜¯æ²¡æœ‰å¾—åˆ°\"æ¥åŠ›æ£’\";ä»–ä»¬ä¸çŸ¥é“ä¼ é€’ç»™IO actionçš„ä»»ä½•`world`å€¼,`RealWorld`ç±»å‹æ˜¯ä¸€ç§æŠ½è±¡æ•°æ®ç±»å‹,å› æ­¤çº¯å‡½æ•°ä¹Ÿä¸èƒ½è‡ªå·±æ„é€ `RealWorld`å€¼,å¹¶ä¸”å®ƒæ˜¯ä¸¥æ ¼ç±»å‹,å› æ­¤ä¹Ÿä¸èƒ½ä½¿ç”¨`undefined`,å› æ­¤,ç¦æ­¢åœ¨çº¯è¿‡ç¨‹ä¸­ä½¿ç”¨IOæ“ä½œåªæ˜¯ä¸€ç§ç±»å‹ç³»ç»ŸæŠ€å·§(é€šå¸¸åœ¨Haskellä¸­)ã€‚\nä½†æ˜¯è™½ç„¶çº¯ä»£ç ä¸èƒ½_execute_ IOåŠ¨ä½œï¼Œ\nå®ƒå¯ä»¥ä¸ä»»ä½•å…¶ä»–åŠŸèƒ½å€¼ä¸€èµ·ä½¿ç”¨ - å®ƒä»¬å¯ä»¥å­˜å‚¨åœ¨æ•°æ®ç»“æ„ä¸­,ä½œä¸ºå‚æ•°ä¼ é€’,ä½œä¸ºç»“æœè¿”å›,æ”¶é›†åœ¨åˆ—è¡¨ä¸­,å¹¶éƒ¨åˆ†åº”ç”¨,ä½†IO actionä»ç„¶æ˜¯ä¸€ä¸ªåŠŸèƒ½å€¼,å› ä¸ºæˆ‘ä»¬ä¸èƒ½å°†å®ƒåº”ç”¨äºæœ€åä¸€ä¸ªå‚æ•° - ç±»å‹ä¸ºRealWorldã€‚\nä¸ºäº†_execute_ IOåŠ¨ä½œ,æˆ‘ä»¬éœ€è¦å°†å®ƒåº”ç”¨äºä¸€äº›RealWorldå€¼,è¿™åªèƒ½åœ¨ä¸€äº›IOè¿‡ç¨‹ä¸­,åœ¨å…¶\"actioné“¾\"ä¸­å®Œæˆã€‚\nåªæœ‰å½“è¿™ä¸ªè¿‡ç¨‹è¢«è°ƒç”¨(ä½œä¸º\"ä¸º`main`å‡½æ•°è®¡ç®—worldæœ€ç»ˆå€¼\"è¿‡ç¨‹çš„ä¸€éƒ¨åˆ†æ—¶),æ‰ä¼šçœŸæ­£æ‰§è¡Œæ­¤æ“ä½œã€‚\nçœ‹çœ‹è¿™ä¸ªä¾‹å­:\n```\nmain world0 = let get2chars = getChar >> getChar\n                  ((), world1) = putStr \"Press two keys\" world0\n                  (answer, world2) = get2chars world1\n              in ((), world2)\n```\nè¿™é‡Œæˆ‘ä»¬é¦–å…ˆå°†ä¸€ä¸ªå€¼ç»‘å®šåˆ°`get2chars`,ç„¶åç¼–å†™ä¸€ä¸ªæ¶‰åŠ`putStr`çš„ç»‘å®š,ä½†æ˜¯æ‰§è¡Œé¡ºåºæ˜¯ä»€ä¹ˆï¼Ÿå®ƒä¸æ˜¯ç”±`let`ç»‘å®šçš„é¡ºåºå®šä¹‰çš„,å®ƒæ˜¯ç”±å¤„ç†`world`å€¼çš„é¡ºåºå®šä¹‰çš„! \næ‚¨å¯ä»¥éšæ„é‡æ–°æ’åºç»‘å®šè¯­å¥,æ‰§è¡Œé¡ºåºå°†ç”±å…³äºä¼ é€’çš„`world`å€¼çš„æ•°æ®ä¾èµ–æ€§å®šä¹‰,è®©æˆ‘ä»¬çœ‹çœ‹`do`è¯­æ³•ä¸­çš„`main`æ˜¯ä»€ä¹ˆæ ·çš„ï¼š\n```\nmain = do let get2chars = getChar >> getChar\n          putStr \"Press two keys\"\n          get2chars\n          return ()\n```\næ­£å¦‚æ‚¨æ‰€çœ‹åˆ°çš„,æˆ‘ä»¬å·²ç»æ¶ˆé™¤äº†ä¸¤ä¸ª`let`ç»‘å®š,åªç•™ä¸‹äº†ä¸€ä¸ªå®šä¹‰`get2chars`çš„ç»‘å®š,é`let`è¯­å¥æŒ‰ç…§å®ƒä»¬å†™å…¥çš„ç¡®åˆ‡é¡ºåºæ‰§è¡Œ,å› ä¸ºå¦‚ä¸Šæ‰€è¿°å®ƒä»¬å°†å£°æ˜ä¸­çš„`world`å€¼ä¼ é€’ç»™å£°æ˜(è¯­å¥),å› æ­¤,è¿™ä¸ªç‰ˆæœ¬çš„å‡½æ•°æ›´å®¹æ˜“ç†è§£,å› ä¸ºæˆ‘ä»¬ä¸å¿…åœ¨å¿ƒç†ä¸Šå¼„æ¸…æ¥š`world`å€¼çš„æ•°æ®ä¾èµ–æ€§.\n\næ­¤å¤–,åƒ`get2chars`è¿™æ ·çš„IO actionä¸èƒ½ç›´æ¥æ‰§è¡Œ,å› ä¸ºå®ƒä»¬æ˜¯å…·æœ‰`RealWorld`å‚æ•°çš„å‡½æ•°,è¦æ‰§è¡Œå®ƒä»¬,æˆ‘ä»¬éœ€è¦æä¾›`RealWorld`å‚æ•°,å³å°†å®ƒä»¬æ’å…¥åˆ°`main`é“¾ä¸­,å°†å®ƒä»¬æ”¾åœ¨ä»`main`æ‰§è¡Œçš„æŸäº›`do`åºåˆ—ä¸­(ç›´æ¥åœ¨`main`å‡½æ•°ä¸­,æˆ–é—´æ¥åœ¨ä»`main`è°ƒç”¨çš„IOå‡½æ•°ä¸­).åœ¨å®Œæˆä¹‹å‰,å®ƒä»¬å°†ä¿ç•™(å°±åƒä»»ä½•éƒ¨åˆ†è¯„ä¼°å½¢å¼çš„å‡½æ•°),æˆ‘ä»¬å¯ä»¥åƒä½¿ç”¨ä»»ä½•å…¶ä»–å‡½æ•°ä¸€æ ·ä½¿ç”¨IOæ“ä½œ - å°†å®ƒä»¬ç»‘å®šåˆ°åç§°(å¦‚ä¸Šæ‰€è¿°),å°†å®ƒä»¬ä¿å­˜åœ¨æ•°æ®ç»“æ„ä¸­,å°†å®ƒä»¬ä½œä¸ºå‡½æ•°å‚æ•°ä¼ é€’å¹¶å°†å®ƒä»¬ä½œä¸ºç»“æœè¿”å› - ç›´åˆ°ä½ ç»™ä»–ä»¬é­”æ³•çš„`RealWorld`å‚æ•°,ä»–ä»¬æ‰ä¼šè¢«æ‰§è¡Œ!\n\n##### ç¤ºä¾‹: IO actionsåˆ—è¡¨\nè®©æˆ‘ä»¬å°è¯•å®šä¹‰IO actionsåˆ—è¡¨:\n```\nioActions :: [IO ()]\nioActions = [\n              (print \"Hello!\"),\n              (putStr \"just kidding\"),\n              (getChar >> return ())\n            ]\n```\næˆ‘åœ¨æ¯ä¸ªactionå‘¨å›´ä½¿ç”¨äº†é¢å¤–çš„æ‹¬å·ï¼Œå°½ç®¡å®ƒä»¬å¹¶ä¸æ˜¯çœŸæ­£éœ€è¦çš„ã€‚å¦‚æœæ‚¨ä»ç„¶æ— æ³•ç›¸ä¿¡è¿™äº›æ“ä½œä¸ä¼šç«‹å³æ‰§è¡Œï¼Œè¯·å›å¿†ä¸€ä¸‹æ­¤åˆ—è¡¨çš„å®é™…ç±»å‹ï¼š\n```\nioActions :: [RealWorld -> ((), RealWorld)]\n```\nå¥½å§ï¼Œç°åœ¨æˆ‘ä»¬è¦æ‰§è¡Œå…¶ä¸­ä¸€äº›æ“ä½œã€‚æ²¡é—®é¢˜ï¼Œåªéœ€å°†å®ƒä»¬æ’å…¥`main`é“¾ï¼š\n```\nmain = do head ioActions\n          ioActions !! 1\n          last ioActions\n```\nçœ‹èµ·æ¥å¾ˆå¥‡æ€ªå§ï¼Ÿå®é™…ä¸Šï¼Œæ‚¨åœ¨`do`è¯­å¥ä¸­ç¼–å†™çš„ä»»ä½•IOæ“ä½œ(æˆ–ç”¨ä½œ`>>` / `>>=`è¿ç®—ç¬¦çš„å‚æ•°)éƒ½æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œä¸ºæŸäº›ç±»å‹`a`è¿”å›ç±»å‹`IO a`çš„ç»“æœã€‚\né€šå¸¸ï¼Œæ‚¨ä½¿ç”¨æŸäº›ç±»å‹ä¸º`x -> y -> ... -> IO a`çš„å‡½æ•°,å¹¶æä¾›æ‰€æœ‰`x,y`ç­‰å‚æ•°ã€‚\nä½†æ˜¯ä½ å¹¶ä¸å±€é™äºè¿™ä¸ªæ ‡å‡†åœºæ™¯ - ä¸è¦å¿˜è®°Haskellæ˜¯ä¸€ç§å‡½æ•°å¼è¯­è¨€,ä½ å¯ä»¥ä»¥ä»»ä½•å¯èƒ½çš„æ–¹å¼è‡ªç”±è®¡ç®—æ‰€éœ€çš„å‡½æ•°å€¼(å›æƒ³ä¸€ä¸‹`IO a`å®é™…ä¸Šæ˜¯ä¸€ç§å‡½æ•°ç±»å‹).\n\nè¿™é‡Œæˆ‘ä»¬åˆšä»åˆ—è¡¨ä¸­æå–äº†å‡ ä¸ªå‡½æ•° - æ²¡é—®é¢˜,æ­£å¦‚æˆ‘ä»¬åœ¨å‰é¢çš„ä¾‹å­ä¸­æ‰€åšçš„é‚£æ ·,è¿™ä¸ªå‡½æ•°å€¼ä¹Ÿå¯ä»¥å³æ—¶æ„å»º - è¿™ä¹Ÿæ²¡é—®é¢˜ã€‚\næƒ³çœ‹åˆ°è¿™ä¸ªå‡½æ•°å€¼ä½œä¸ºå‚æ•°ä¼ é€’ï¼Ÿåªè¦çœ‹çœ‹`when`çš„å®šä¹‰. å˜¿,æˆ‘ä»¬å¯ä»¥åƒä»»ä½•å…¶ä»–å‡½æ•°å€¼ä¸€æ ·è´­ä¹°,å‡ºå”®å’Œå‡ºç§Ÿè¿™äº›IOæ“ä½œ! ä¾‹å¦‚,è®©æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæ‰§è¡Œåˆ—è¡¨ä¸­æ‰€æœ‰IO actionsçš„å‡½æ•°ï¼š\n```\nsequence_ :: [IO a] -> IO ()\nsequence_ [] = return ()\nsequence_ (x:xs) = do x\n               sequence_ xs\n```\næ²¡æœ‰é»‘é­”æ³• - æˆ‘ä»¬åªæ˜¯ä»åˆ—è¡¨ä¸­æå–IO actionså¹¶å°†å®ƒä»¬æ’å…¥åˆ°ä¸€ç³»åˆ—IOæ“ä½œä¸­ï¼Œè¿™äº›æ“ä½œåº”è¯¥ä¸€ä¸ªæ¥ä¸€ä¸ªåœ°æ‰§è¡Œ(æŒ‰ç…§å®ƒä»¬åœ¨åˆ—è¡¨ä¸­çš„é¡ºåº)ä»¥\"è®¡ç®—æ•´ä¸ª`sequence_`è°ƒç”¨çš„æœ€ç»ˆworldå€¼\"ã€‚\nåœ¨`sequence_`çš„å¸®åŠ©ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥å°†æœ€åä¸€ä¸ª`main`å‡½æ•°é‡å†™ä¸ºï¼š\n```\nmain = sequence_ ioActions\n```\nä¸ä»»ä½•å…¶ä»–ï¼ˆåŠŸèƒ½å’ŒéåŠŸèƒ½ï¼‰å€¼ä¸€æ ·ï¼ŒHaskellä½¿ç”¨IOæ“ä½œçš„èƒ½åŠ›å…è®¸æˆ‘ä»¬å®šä¹‰ä»»æ„å¤æ‚åº¦çš„æ§åˆ¶ç»“æ„ã€‚ä¾‹å¦‚ï¼Œå°è¯•å®šä¹‰ä¸€ä¸ªé‡å¤åŠ¨ä½œçš„æ§åˆ¶ç»“æ„ï¼Œç›´åˆ°å®ƒè¿”å›`False`ç»“æœ(ç»ƒä¹ )ï¼š\n```\nwhile :: IO Bool -> IO ()\nwhile action = ???\n```\nå¤§å¤šæ•°ç¼–ç¨‹è¯­è¨€æ ¹æœ¬ä¸å…è®¸æ‚¨å®šä¹‰æ§åˆ¶ç»“æ„ï¼Œè€Œé‚£äº›å…è®¸çš„é€šå¸¸æ˜¯éœ€è¦æ‚¨ä½¿ç”¨å®æ‰©å±•ç³»ç»Ÿçš„ç¼–ç¨‹è¯­è¨€ã€‚åœ¨Haskellä¸­ï¼Œæ§åˆ¶ç»“æ„åªæ˜¯ä»»ä½•äººéƒ½å¯ä»¥ç¼–å†™çš„ç®€å•å‡½æ•°ã€‚\n\n##### ä¾‹å­: è¿”å›ä¸€ä¸ªIO actionsä½œä¸ºç»“æœ\nå¦‚ä½•é€šè¿‡å‡½æ•°è¿”å›IOæ“ä½œ? å¥½å§,æˆ‘ä»¬æ¯æ¬¡å®šä¹‰IOè¿‡ç¨‹æ—¶éƒ½ä¼šè¿™æ ·åš - å®ƒä»¬éƒ½è¿”å›éœ€è¦æ‰§è¡ŒRealWorldå€¼çš„IO actionsã€‚è™½ç„¶æˆ‘ä»¬é€šå¸¸åªæ˜¯å°†å®ƒä»¬ä½œä¸ºæ›´é«˜çº§åˆ«IOè¿‡ç¨‹çš„ä¸€éƒ¨åˆ†æ¥æ‰§è¡Œ,ä½†ä¹Ÿå¯ä»¥åœ¨æ²¡æœ‰å®é™…æ‰§è¡Œçš„æƒ…å†µä¸‹æ”¶é›†å®ƒä»¬ï¼š\n```\nmain = do let a = sequence ioActions\n              b = when True getChar\n              c = getChar >> getChar\n          putStr \"These 'let' statements are not executed!\"\n```\nè¿™äº›åˆ†é…çš„IOè¿‡ç¨‹å¯ä»¥ç”¨ä½œå…¶ä»–è¿‡ç¨‹çš„å‚æ•°ï¼Œæˆ–è€…å†™å…¥å…¨å±€å˜é‡ï¼Œæˆ–è€…ä»¥å…¶ä»–æ–¹å¼å¤„ç†ï¼Œæˆ–è€…ç¨åæ‰§è¡Œï¼Œå°±åƒæˆ‘ä»¬åœ¨`get2chars`ç¤ºä¾‹ä¸­æ‰€åšçš„é‚£æ ·ã€‚\nä½†æ˜¯å¦‚ä½•ä»IOè¿‡ç¨‹è¿”å›å‚æ•°åŒ–IO actionå‘¢ï¼Ÿè®©æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªè¿‡ç¨‹ï¼Œè¯¥è¿‡ç¨‹ä»è¡¨ç¤ºä¸ºå¥æŸ„çš„æ–‡ä»¶è¿”å›ç¬¬iä¸ªå­—èŠ‚ï¼š\n```\nreadi h i = do hSeek h AbsoluteSeek i\n               hGetChar h\n```\nåˆ°ç°åœ¨ä¸ºæ­¢è¿˜æŒºå¥½ã€‚ä½†æ˜¯ï¼Œå¦‚æœä¸€ä¸ªç¨‹åºè¿”å›å…·æœ‰ç»™å®šåç§°çš„æ–‡ä»¶çš„ç¬¬iä¸ªå­—èŠ‚ï¼Œè€Œä¸æ˜¯æ¯æ¬¡éƒ½é‡æ–°æ‰“å¼€å®ƒï¼Ÿ\n```\nreadfilei :: String -> IO (Integer -> IO Char)\nreadfilei name = do h <- openFile name ReadMode\n                    return (readi h)\n```\nå¦‚æ‚¨æ‰€è§ï¼Œè¿™æ˜¯ä¸€ä¸ªIOè¿‡ç¨‹ï¼Œå®ƒæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶å¹¶è¿”å›å¦ä¸€ä¸ªå°†è¯»å–æŒ‡å®šå­—èŠ‚çš„IOè¿‡ç¨‹ã€‚ä½†æˆ‘ä»¬å¯ä»¥æ›´è¿›ä¸€æ­¥ï¼Œåœ¨`readfilei`ä¸­åŒ…å«`readi`å†…å®¹ï¼š\n```\nreadfilei name = do h <- openFile name ReadMode\n                    let readi h i = do hSeek h AbsoluteSeek i\n                                       hGetChar h\n                    return (readi h)\n```\nç°åœ¨çœ‹èµ·æ¥æ›´å¥½äº†ã€‚ä½†æ˜¯ï¼Œå¦‚æœå¯ä»¥ä»å½“å‰å®šä¹‰`readi`çš„ç¯å¢ƒä¸­è·å–ä½œä¸º`readi`å‚æ•°çš„`h`ï¼Œæˆ‘ä»¬ä¸ºä»€ä¹ˆè¦æ·»åŠ `h`? æ›´çŸ­çš„ç‰ˆæœ¬æ˜¯è¿™æ ·çš„ï¼š\n```\nreadfilei name = do h <- openFile name ReadMode\n                    let readi i = do hSeek h AbsoluteSeek i\n                                     hGetChar h\n                    return readi\n```\næˆ‘ä»¬åœ¨è¿™åšäº†ä»€ä¹ˆ? æˆ‘ä»¬åœ¨`readfilei`ä¸­æ„å»ºäº†ä¸€ä¸ªæ¶‰åŠæœ¬åœ°åç§°çš„å‚æ•°åŒ–IO actionï¼Œå¹¶å°†å…¶ä½œä¸ºç»“æœè¿”å›ã€‚ç°åœ¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ä½¿ç”¨å®ƒï¼š\n```\nmain = do myfile <- readfilei \"test\"\n          a <- myfile 0\n          b <- myfile 1\n          print (a,b)\n```\nè¿™ç§ä½¿ç”¨IOæ“ä½œçš„æ–¹å¼å¯¹äºHaskellç¨‹åºæ¥è¯´éå¸¸å…¸å‹ - æ‚¨åªéœ€æ„é€ ä¸€ä¸ªæˆ–å¤šä¸ªæ‰€éœ€çš„IOæ“ä½œ(å¸¦æˆ–ä¸å¸¦å‚æ•°),å¯èƒ½æ¶‰åŠ\"æ„é€ å‡½æ•°\"æ¥æ”¶çš„å‚æ•°,å¹¶å°†å®ƒä»¬è¿”å›ç»™è°ƒç”¨è€…ã€‚ç„¶å,è¿™äº›IOæ“ä½œå¯ä»¥åœ¨ç¨‹åºçš„å…¶ä½™éƒ¨åˆ†ä¸­ä½¿ç”¨,è€Œæ— éœ€äº†è§£æ‚¨çš„å†…éƒ¨å®ç°ç­–ç•¥ã€‚å¯ä»¥ä½¿ç”¨çš„ä¸€ä»¶äº‹æ˜¯éƒ¨åˆ†æ¨¡æ‹ŸOOP(æˆ–æ›´ç¡®åˆ‡åœ°è¯´ADT)ç¼–ç¨‹èŒƒä¾‹ã€‚\n\n##### ç¤ºä¾‹ï¼šå†…å­˜åˆ†é…å™¨ç”Ÿæˆå™¨\nä¾‹å¦‚,æˆ‘çš„ä¸€ä¸ªç¨‹åºæœ‰ä¸€ä¸ªæ¨¡å—,å®ƒæ˜¯ä¸€ä¸ªå†…å­˜å­åˆ†é…å™¨ã€‚å®ƒæ¥æ”¶å¤§å†…å­˜å—çš„åœ°å€å’Œå¤§å°,å¹¶è¿”å›ä¸¤ä¸ªè¿‡ç¨‹ - ä¸€ä¸ªç”¨äºåˆ†é…ç»™å®šå¤§å°çš„å­å—,å¦ä¸€ä¸ªç”¨äºé‡Šæ”¾åˆ†é…çš„å­å—ï¼š\n```\nmemoryAllocator :: Ptr a -> Int -> IO (Int -> IO (Ptr b),\n                                       Ptr c -> IO ())\n\nmemoryAllocator buf size = do ......\n               let alloc size = do ...\n                                   ...\n                   free ptr = do ...\n                                 ...\n               return (alloc, free)\n```\nè¿™æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ`alloc`å’Œ`free`å‡½æ•°ä½¿ç”¨åœ¨memoryAllocatorè¿‡ç¨‹ä¸­åˆ›å»ºçš„å¼•ç”¨ã€‚ç”±äºè¿™äº›å¼•ç”¨çš„åˆ›å»ºæ˜¯`memoryAllocator IO`æ“ä½œé“¾çš„ä¸€éƒ¨åˆ†ï¼Œå› æ­¤å°†ä¸ºæ¯ä¸ªè°ƒç”¨memoryAllocatorçš„å†…å­˜å—åˆ›å»ºä¸€ç»„æ–°çš„ç‹¬ç«‹å¼•ç”¨ï¼š\n```\nmemoryAllocator buf size = do start <- newIORef buf\n                 end <- newIORef (buf `plusPtr` size)\n                 ...\n```\nè¿™ä¸¤ä¸ªå¼•ç”¨æ˜¯åœ¨`alloc`å’Œ`free`å®šä¹‰ä¸­è¯»å–å’Œå†™å…¥çš„(æˆ‘ä»¬å°†ä¸ºè¿™ä¸ªä¾‹å­å®ç°ä¸€ä¸ªéå¸¸ç®€å•çš„å†…å­˜åˆ†é…å™¨):\n```\n...\n      let alloc size = do addr <- readIORef start\n                          writeIORef start (addr `plusPtr` size)\n                          return addr\n                          \n      let free ptr = do writeIORef start ptr\n```\næˆ‘ä»¬åœ¨è¿™é‡Œå®šä¹‰çš„åªæ˜¯ä¸€å¯¹é—­åŒ…,å®ƒä»¬åœ¨å®šä¹‰æ—¶ä½¿ç”¨å¯ç”¨çš„çŠ¶æ€ã€‚æ­£å¦‚æ‚¨æ‰€çœ‹åˆ°çš„,å°½ç®¡Haskellç¼ºä¹å¯¹ä¸çº¯å‡½æ•°çš„ç›´æ¥æ”¯æŒ,ä½†å®ƒä¸ä»»ä½•å…¶ä»–å‡½æ•°è¯­è¨€ä¸€æ ·ç®€å•ã€‚\nä»¥ä¸‹ç¤ºä¾‹ä½¿ç”¨memoryAllocatorè¿”å›çš„è¿‡ç¨‹åœ¨ä¸¤ä¸ªç‹¬ç«‹çš„å†…å­˜ç¼“å†²åŒºä¸­åŒæ—¶åˆ†é…/é‡Šæ”¾å—ï¼š\n```\nmain = do buf1 <- mallocBytes (2^16)\n          buf2 <- mallocBytes (2^20)\n          (alloc1, free1) <- memoryAllocator buf1 (2^16)\n          (alloc2, free2) <- memoryAllocator buf2 (2^20)\n          ptr11 <- alloc1 100\n          ptr21 <- alloc2 1000\n          free1 ptr11\n          free2 ptr21\n          ptr12 <- alloc1 100\n          ptr22 <- alloc2 1000\n```\n##### ç¤ºä¾‹: ä½¿ç”¨è®°å½•ç±»å‹æ¨¡æ‹ŸOOP\nè®©æˆ‘ä»¬å®ç°ç»å…¸çš„OOPç¤ºä¾‹ï¼šç»˜åˆ¶å›¾å½¢ã€‚æœ‰ä¸åŒç±»å‹çš„æ•°å­—ï¼šåœ†å½¢ï¼ŒçŸ©å½¢ç­‰ã€‚ä»»åŠ¡æ˜¯åˆ›å»ºä¸€ä¸ªå¼‚æ„çš„å›¾åˆ—è¡¨ã€‚æ­¤åˆ—è¡¨ä¸­çš„æ‰€æœ‰å›¾åº”æ”¯æŒç›¸åŒçš„æ“ä½œé›†ï¼šç»˜åˆ¶`draw`ï¼Œç§»åŠ¨`move`ç­‰ã€‚æˆ‘ä»¬å°†è¿™äº›æ“ä½œè¡¨ç¤ºä¸ºIOè¿‡ç¨‹ã€‚è®©æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªåŒ…å«æ‰€æœ‰æ‰€éœ€è¿‡ç¨‹çš„å®ç°çš„ç»“æ„ï¼Œè€Œä¸æ˜¯`class`ï¼š\n```\ndata Figure = Figure { \n\tdraw :: IO (),\n        move :: Displacement -> IO ()\n}\n\ntype Displacement = (Int, Int)  -- horizontal and vertical displacement in points\n```\næ¯ä¸ªå›¾å½¢ç±»å‹çš„æ„é€ å‡½æ•°åº”è¯¥åªè¿”å›ä¸€ä¸ªFigureè®°å½•ï¼š\n```\ncircle    :: Point -> Radius -> IO Figure -- åœ† \nrectangle :: Point -> Point -> IO Figure  -- çŸ©å½¢\n\ntype Point = (Int, Int)  -- ç‚¹åæ ‡\ntype Radius = Int        -- ä»¥åœ†ä¸ºå•ä½çš„åœ†åŠå¾„\n```\næˆ‘ä»¬å°†é€šè¿‡æ‰“å°å½“å‰å‚æ•°æ¥ç»˜åˆ¶`draw`å›¾ã€‚è®©æˆ‘ä»¬ä»`circle`å’Œ`rectangle`æ„é€ å‡½æ•°çš„ç®€åŒ–å®ç°å¼€å§‹ï¼Œè€Œä¸éœ€è¦å®é™…çš„`move`æ”¯æŒ:\n```\ncircle center radius = do\n    let description = \"  Circle at \"++show center++\" with radius \"++show radius\n    return $ Figure { draw = putStrLn description }\n\nrectangle from to = do\n    let description = \"  Rectangle \"++show from++\"-\"++show to)\n    return $ Figure { draw = putStrLn description }\n```\nå¦‚æ‚¨æ‰€è§ï¼Œæ¯ä¸ªæ„é€ å‡½æ•°åªè¿”å›ä¸€ä¸ªå›ºå®šçš„ç»˜å›¾`draw`è¿‡ç¨‹ï¼Œè¯¥è¿‡ç¨‹æ‰“å°ç”¨äºåˆ›å»ºå…·ä½“å›¾å½¢çš„å‚æ•°ã€‚æˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹ï¼š\n```\ndrawAll :: [Figure] -> IO ()\ndrawAll figures = do putStrLn \"Drawing figures:\"\n                     mapM_ draw figures\n\nmain = do figures <- sequence [circle (10,10) 5,\n                               circle (20,20) 3,\n                               rectangle (10,10) (20,20),\n                               rectangle (15,15) (40,40)]\n          drawAll figures\n```\nç°åœ¨è®©æˆ‘ä»¬å®šä¹‰å¯ä»¥å®é™…ç§»åŠ¨çš„\"å…¨åŠŸèƒ½full-featured\"å›¾ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬åº”è¯¥ä¸ºæ¯ä¸ªå›¾å½¢æä¾›ä¸€ä¸ªå¯å˜å˜é‡ï¼Œç”¨äºä¿å­˜æ¯ä¸ªå›¾å½¢çš„å½“å‰å±å¹•ä½ç½®ã€‚è¯¥å˜é‡çš„ç±»å‹ä¸º`IORef Point`ã€‚è¯¥å˜é‡åº”è¯¥åœ¨å›¾æ„é€ å‡½æ•°ä¸­åˆ›å»ºï¼Œå¹¶åœ¨å›¾è®°å½•ä¸­åŒ…å«çš„IOè¿‡ç¨‹(é—­åŒ…)ä¸­è¿›è¡Œæ“ä½œï¼š\n```\ncircle center radius = do\n    centerVar <- newIORef center\n\n    let drawF = do center <- readIORef centerVar\n                   putStrLn (\"  Circle at \"++show center\n                             ++\" with radius \"++show radius)\n\n    let moveF (addX,addY) = do (x,y) <- readIORef centerVar\n                   writeIORef centerVar (x+addX, y+addY)\n\n    return $ Figure { draw=drawF, move=moveF }\n\nrectangle from to = do\n    fromVar <- newIORef from\n    toVar   <- newIORef to\n\n    let drawF = do from <- readIORef fromVar\n                   to   <- readIORef toVar\n                   putStrLn (\"  Rectangle \"++show from++\"-\"++show to)\n\n    let moveF (addX,addY) = do (fromX,fromY) <- readIORef fromVar\n                               (toX,toY)     <- readIORef toVar\n                               writeIORef fromVar (fromX+addX, fromY+addY)\n                               writeIORef toVar   (toX+addX, toY+addY)\n\n    return $ Figure { draw=drawF, move=moveF }\n```\nç°åœ¨æˆ‘ä»¬å¯ä»¥æµ‹è¯•ç§»åŠ¨å›¾çš„ä»£ç ï¼š\n```\nmain = do figures <- sequence [circle (10,10) 5,\n                               rectangle (10,10) (20,20)]\n          drawAll figures\n          mapM_ (\\fig -> move fig (10,10)) figures\n          drawAll figures\n```\né‡è¦çš„æ˜¯è¦æ„è¯†åˆ°æˆ‘ä»¬ä¸ä»…é™äºåœ¨ä¸€ä¸ªæ—¨åœ¨æ¨¡æ‹ŸC++/Javaé£æ ¼æ¥å£çš„è®°å½•ä¸­ä»…åŒ…å«IO actionã€‚è®°å½•è¿˜å¯ä»¥åŒ…æ‹¬å€¼ï¼ŒIORefsï¼Œçº¯å‡½æ•° - ç®€è€Œè¨€ä¹‹ï¼Œä»»ä½•ç±»å‹çš„æ•°æ®ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾åœ°å°†areaå’Œoriginå­—æ®µæ·»åŠ åˆ°å›¾å½¢æ¥å£ä¸­ï¼š\n```\ndata Figure = Figure { draw :: IO (),\n                       move :: Displacement -> IO (),\n                       area :: Double,\n                       origin :: IORef Point\n                     }\n```\n\n#### å¼‚å¸¸å¤„ç†\n\n\n#### ä¸C/C++å’Œå¤–éƒ¨åº“çš„æ¥å£\n\n#### IO monadçš„é»‘æš—é¢\n\n##### unsafePerformIO\næ¥è‡ªå‘½ä»¤å¼è¯­è¨€èƒŒæ™¯çš„ç¨‹åºå‘˜ç»å¸¸å¯»æ‰¾åœ¨çº¯è¿‡ç¨‹ä¸­æ‰§è¡ŒIOæ“ä½œçš„æ–¹æ³•ã€‚ä½†æ˜¯ï¼Œè¿™æ˜¯ä»€ä¹ˆæ„æ€? æƒ³è±¡ä¸€ä¸‹ï¼Œæ‚¨æ­£åœ¨å°è¯•ç¼–å†™ä¸€ä¸ªè¯»å–å…·æœ‰ç»™å®šåç§°çš„æ–‡ä»¶å†…å®¹çš„è¿‡ç¨‹ï¼Œå¹¶å°è¯•å°†å…¶å†™ä¸ºçº¯ï¼ˆéIOï¼‰å‡½æ•°ï¼š\n```\nreadContents :: Filename -> String\n```\nå°†readContentså®šä¹‰ä¸ºçº¯å‡½æ•°è‚¯å®šä¼šç®€åŒ–ä½¿ç”¨å®ƒçš„ä»£ç ã€‚ä½†å®ƒä¹Ÿä¼šç»™ç¼–è¯‘å™¨å¸¦æ¥é—®é¢˜ï¼š\n* æ­¤è°ƒç”¨æœªæ’å…¥\"worldè½¬æ¢\"åºåˆ—ä¸­,å› æ­¤ç¼–è¯‘å™¨ä¸çŸ¥é“æ‚¨å¸Œæœ›ä½•æ—¶æ‰§è¡Œæ­¤æ“ä½œã€‚ä¾‹å¦‚,å¦‚æœæ–‡ä»¶åœ¨ç¨‹åºå¼€å¤´æœ‰ä¸€ç§å†…å®¹è€Œå¦ä¸€ç§åœ¨ç»“å°¾ - ä½ æƒ³çœ‹å“ªäº›å†…å®¹ï¼Ÿæ‚¨ä¸çŸ¥é“ä½•æ—¶(æˆ–è€…ç”šè‡³æ˜¯)å°†è¦è°ƒç”¨æ­¤å‡½æ•°,å› ä¸ºHaskellå°†æ­¤å‡½æ•°è§†ä¸ºçº¯å‡½æ•°,å¹¶ä¸”å¯ä»¥æ ¹æ®éœ€è¦é‡æ–°æ’åºä»»ä½•æˆ–æ‰€æœ‰çº¯å‡½æ•°çš„æ‰§è¡Œã€‚\n* å°½ç®¡å¯ä»¥åœ¨è°ƒç”¨ä¹‹é—´æ”¹å˜æ–‡ä»¶(æˆ–å½“å‰ç›®å½•),ä½†æ˜¯å¯ä»¥è€ƒè™‘å°è¯•è¯»å–å…·æœ‰ç›¸åŒåç§°çš„æ–‡ä»¶çš„å†…å®¹(å³,å‡å°‘åˆ°å•ä¸ªè°ƒç”¨)ã€‚åŒæ ·,Haskellè®¤ä¸ºæ‰€æœ‰éIOå‡½æ•°éƒ½æ˜¯çº¯ç²¹çš„,å¹¶ä¸”å¯ä»¥éšæ„çœç•¥å…·æœ‰ç›¸åŒå‚æ•°çš„å¤šä¸ªè°ƒç”¨ã€‚\nå› æ­¤,å®ç°ä¸çœŸå®ä¸–ç•Œäº¤äº’çš„çº¯å‡½æ•°è¢«è®¤ä¸ºæ˜¯ä¸è‰¯çš„è¡Œä¸º,å¥½ç”·å­©å’Œå¥³å­©ä»æ¥æ²¡æœ‰è¿™æ ·åš;\nç„¶è€Œ,æœ‰(åŠå®˜æ–¹)æ–¹æ³•åœ¨çº¯å‡½æ•°å†…éƒ¨ä½¿ç”¨IOåŠ¨ä½œã€‚ä½ åº”è¯¥è®°ä½,é€šè¿‡è¦æ±‚ä¸€ä¸ªRealWorldæ¥åŠ›æ£’å»è°ƒç”¨ä¸€ä¸ªIO actionæ˜¯ç¦æ­¢çš„ã€‚\nçº¯å‡½æ•°æ²¡æœ‰æ¥åŠ›æ£’,ä½†æ˜¯æœ‰ä¸€ä¸ªç‰¹æ®Šçš„`magic`ç¨‹åºå¯ä»¥ä»ä¸çŸ¥åçš„åœ°æ–¹äº§ç”Ÿè¿™ä¸ª\"æ¥åŠ›æ£’\",ä½¿ç”¨å®ƒæ¥è°ƒç”¨IO action,ç„¶åæŠ›å‡ºæ‰€äº§ç”Ÿçš„`world`!è¿™æ˜¯ä¸€ä¸ªæœ‰ç‚¹ä½çº§é­”æ³•ã€‚è¿™ä¸ªéå¸¸ç‰¹æ®Š(å±é™©)çš„ç¨‹åºæ˜¯ï¼š\n```\nunsafePerformIO :: IO a -> a\n```\nè®©æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒçš„(å¯èƒ½çš„)å®šä¹‰:\n```\nunsafePerformIO :: (RealWorld -> (a, RealWorld)) -> a\nunsafePerformIO action = \n\tlet (a, world1) = action createNewWorld \n\tin a\n```\nå…¶ä¸­`createNewWorld`æ˜¯ä¸€ä¸ªå†…éƒ¨å‡½æ•°ï¼Œäº§ç”ŸRealWorldç±»å‹çš„æ–°å€¼ã€‚\nä½¿ç”¨`unsafePerformIO`,æ‚¨å¯ä»¥è½»æ¾ç¼–å†™å†…éƒ¨æ‰§è¡ŒI/Oçš„çº¯å‡½æ•°ã€‚ä½†æ˜¯ä¸è¦åœ¨æ²¡æœ‰çœŸæ­£éœ€è¦çš„æƒ…å†µä¸‹è¿™æ ·åš,å¹¶è®°ä½éµå¾ªè¿™æ¡è§„åˆ™: ç¼–è¯‘å™¨ä¸çŸ¥é“ä½ åœ¨ä½œå¼Š;å®ƒä»ç„¶è®¤ä¸ºæ¯ä¸ªéIOåŠŸèƒ½éƒ½æ˜¯çº¯ç²¹çš„ã€‚å› æ­¤,æ‰€æœ‰é€šå¸¸çš„ä¼˜åŒ–è§„åˆ™éƒ½å¯ä»¥(å¹¶ä¸”å°†ä¼š)åº”ç”¨äºå…¶æ‰§è¡Œã€‚æ‰€ä»¥ä½ å¿…é¡»ç¡®ä¿:\n* æ¯æ¬¡è°ƒç”¨çš„ç»“æœä»…å–å†³äºå…¶å‚æ•°\n* æ‚¨ä¸ä¾èµ–äºæ­¤å‡½æ•°çš„å‰¯ä½œç”¨,å¦‚æœä¸éœ€è¦å…¶ç»“æœ,åˆ™è¯¥å‡½æ•°å¯èƒ½ä¸ä¼šæ‰§è¡Œ\nè®©æˆ‘ä»¬æ›´æ·±å…¥åœ°ç ”ç©¶è¿™ä¸ªé—®é¢˜ã€‚Haskellä¸­çš„å‡½æ•°è¯„ä¼°ç”±å€¼çš„å¿…è¦æ€§å†³å®š - è¯­è¨€ä»…è®¡ç®—è®¡ç®—æœ€ç»ˆç»“æœæ‰€éœ€çš„å€¼ã€‚ä½†è¿™å¯¹äº`main`å‡½æ•°æ„å‘³ç€ä»€ä¹ˆå‘¢?ä¸ºäº†è®¡ç®—\"æœ€ç»ˆworldå€¼\"ï¼Œæ‚¨éœ€è¦æ‰§è¡Œ`main`é“¾ä¸­åŒ…å«çš„æ‰€æœ‰ä¸­é—´IOæ“ä½œ,é€šè¿‡ä½¿ç”¨`unsafePerformIO`,æˆ‘ä»¬åœ¨æ­¤é“¾ä¹‹å¤–è°ƒç”¨IOæ“ä½œ,æˆ‘ä»¬æœ‰ä»€ä¹ˆä¿è¯å¯ä»¥è¿è¡Œå®ƒä»¬ï¼Ÿæ²¡æœ‰ã€‚åªæœ‰åœ¨éœ€è¦è¿è¡Œå®ƒä»¬æ¥è®¡ç®—æ•´ä¸ªå‡½æ•°ç»“æœæ—¶æ‰ä¼šè¿è¡Œå®ƒä»¬(è¿™åè¿‡æ¥ä¹Ÿåº”è¯¥è¢«è¦æ±‚åœ¨`main`é“¾ä¸­æ‰§è¡Œä¸€äº›æ“ä½œ)ï¼Œè¿™æ˜¯HaskellæŒ‰éœ€è¯„ä¼°ç­–ç•¥çš„ä¸€ä¸ªä¾‹å­ã€‚ç°åœ¨ä½ åº”è¯¥æ¸…æ¥šåœ°çœ‹åˆ°å·®å¼‚:\n* IOè¿‡ç¨‹ä¸­çš„IOæ“ä½œä¿è¯åªè¦(ç›´æ¥æˆ–é—´æ¥)åœ¨`main`é“¾å†…æ‰§è¡Œ - å³ä½¿æœªä½¿ç”¨å…¶ç»“æœ(å› ä¸ºå®ƒè¿”å›çš„éšå¼`world`å€¼å°†è¢«ä½¿ç”¨)ã€‚æ‚¨å¯ä»¥ç›´æ¥åœ¨IOè¿‡ç¨‹ä¸­æŒ‡å®šæ“ä½œçš„æ‰§è¡Œé¡ºåºã€‚é€šè¿‡ä»æ¯ä¸ªIOæ“ä½œä¼ é€’åˆ°ä¸‹ä¸€ä¸ªIOæ“ä½œçš„éšå¼`world`å€¼æ¥æ¨¡æ‹Ÿæ•°æ®ä¾èµ–æ€§ã€‚\n* åªæœ‰åœ¨çœŸæ­£ä½¿ç”¨æ­¤æ“ä½œçš„ç»“æœæ—¶,æ‰ä¼šæ‰§è¡Œ`unsafePerformIO`å†…çš„IOæ“ä½œ,è¯„ä¼°é¡ºåºæ— æ³•ä¿è¯,æ‚¨ä¸åº”è¯¥ä¾èµ–å®ƒ(é™¤éæ‚¨ç¡®å®šå¯èƒ½å­˜åœ¨ä»»ä½•æ•°æ®ä¾èµ–æ€§)ã€‚\næˆ‘è¿˜åº”è¯¥è¯´ï¼Œåœ¨`unsafePerformIO`è°ƒç”¨ä¸­ä½ å¯ä»¥åœ¨ç›¸åŒçš„ç»‘å®šæ“ä½œç¬¦`and/or`æˆ‘ä»¬ä¸Šé¢çœ‹åˆ°çš„`do`è¯­æ³•ç³–çš„å¸®åŠ©ä¸‹ç»„ç»‡ä¸€ä¸ªå°çš„å†…éƒ¨IO actionsé“¾ã€‚\nä¾‹å¦‚ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªç‰¹åˆ«å¤æ‚çš„æ–¹æ³•æ¥è®¡ç®—0ä¹‹åçš„æ•´æ•°:\n```\none :: Int\none = unsafePerformIO $ do var <- newIORef 0\n                           modifyIORef var (+1)\n                           readIORef var\n```\nåœ¨è¿™ç§æƒ…å†µä¸‹,åªè¦éœ€è¦`unsafePerformIO`è°ƒç”¨çš„ç»“æœ,å°±ä¼šæ‰§è¡Œè¯¥é“¾ä¸­çš„æ‰€æœ‰æ“ä½œã€‚ä¸ºäº†ç¡®ä¿è¿™ä¸€ç‚¹,å®é™…çš„`unsafePerformIO`å®ç°ä¼šè¯„ä¼°`action`è¿”å›çš„`world`ï¼š\n```\nunsafePerformIO action = let (a,world1) = action createNewWorld\n                         in (world1 `seq` a)\n```\n(`seq`æ“ä½œåœ¨è¿”å›ç¬¬äºŒä¸ªå‚æ•°çš„å€¼ä¹‹å‰ä¸¥æ ¼è¯„ä¼°å…¶ç¬¬ä¸€ä¸ªå‚æ•°)\n\n##### inlinePerformIO\n`inlinePerformIO`ä¸`unsafePerformIO`å…·æœ‰ç›¸åŒçš„å®šä¹‰,ä½†æ·»åŠ äº†`INLINE`ç¼–è¯‘æŒ‡ç¤ºï¼š\n```\n-- å°±åƒunsafePerformIOä¸€æ ·,ä½†æˆ‘ä»¬å†…è”å®ƒ,å¤§é‡çš„æ€§èƒ½æå‡,å› ä¸ºå®ƒæš´éœ²äº†å¾ˆå¤šä¸œè¥¿è¿›ä¸€æ­¥å†…è”\n{-# INLINE inlinePerformIO #-}\ninlinePerformIO action = let (a, world1) = action createNewWorld\n                         in (world1 `seq` a)\n#endif\n```\nè¯­ä¹‰ä¸Š`inlinePerformIO = unsafePerformIO`ï¼Œå…¶ä¸­ä»»ä½•ä¸€ä¸ªéƒ½æœ‰ä»»ä½•è¯­ä¹‰ã€‚\nå½“ç„¶,ä¸åŒä¹‹å¤„åœ¨äº`inlinePerformIO`æ¯”`unsafePerformIO`æ›´ä¸å®‰å…¨ã€‚è™½ç„¶`ghc`å°†å°½é‡ä¸é‡å¤æˆ–å…±åŒä½¿ç”¨`unsafePerformIO`çš„ä¸åŒç”¨é€”,ä½†æˆ‘ä»¬ç§¯æåœ°å†…è”`inlinePerformIO`ã€‚å› æ­¤,å®é™…ä¸Šæ‚¨åªèƒ½åœ¨IOå†…å®¹éå¸¸çº¯æ­£çš„åœ°æ–¹ä½¿ç”¨å®ƒ,ä¾‹å¦‚ä»ä¸å¯å˜çš„å†…å­˜ç¼“å†²åŒºè¯»å–(å¦‚`ByteStrings`çš„æƒ…å†µ),ç„¶è€Œ,åˆ†é…æ–°ç¼“å†²åŒºä¹‹ç±»çš„äº‹æƒ…ä¸åº”è¯¥åœ¨`inlinePerformIO`å†…éƒ¨å®Œæˆ,å› ä¸ºå®ƒå¯ä»¥å¾ˆå®¹æ˜“åœ°åœ¨æ•´ä¸ªç¨‹åºä¸­æµ®åŠ¨å¹¶åªæ‰§è¡Œä¸€æ¬¡ï¼Œæ‰€ä»¥æœ€ç»ˆä¼šæœ‰è®¸å¤šä¸œè¥¿å…±äº«åŒä¸€ä¸ªç¼“å†²åŒºï¼Œè¿™å¾ˆç³Ÿç³•ã€‚\n```\nwrite :: Int -> (Ptr Word8 -> IO ()) -> Put ()\nwrite !n body = Put $ \\c buf@(Buffer fp o u l) ->\n  if n <= l\n    then write' c fp o u l\n    else write' (flushOld c n fp o u) (newBuffer c n) 0 0 0\n\n  where {-# NOINLINE write' #-}\n        write' c !fp !o !u !l =\n          -- warning: this is a tad hardcore\n          inlinePerformIO\n            (withForeignPtr fp\n              (\\p -> body $! (p `plusPtr` (o+u))))\n          `seq` c () (Buffer fp o (u+n) (l-n))\n```\nå®ƒçš„ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š\n```\nword8 w = write 1 (\\p -> poke p w)\n```\nè¿™ä¸ç¬¦åˆæˆ‘çš„ç»éªŒæ³•åˆ™,ä¸è¦é—®æˆ‘ä»¬ä¸ºä»€ä¹ˆå£°ç§°å®ƒæ˜¯å®‰å…¨çš„(å¦‚æœæœ‰äººçœŸçš„æƒ³çŸ¥é“,è¯·é—®`Ross Paterson`è°å…ˆåœ¨`Builder monoid`ä¸­åšè¿‡)\n\n##### unsafeInterleaveIO\nä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªæ›´å¥‡æ€ªçš„æ“ä½œå«åš`unsafeInterleaveIO`,å®ƒå¾—åˆ°äº†\"å®˜æ–¹æ¥åŠ›æ£’\",åˆ¶ä½œäº†è‡ªå·±çš„ç¿»å°å‰¯æœ¬,ç„¶åä¸mainæ¥åŠ›æ£’åŒæ—¶è¿›è¡Œä¸€åœº\"éæ³•\"çš„æ¥åŠ›æ¯”èµ›!æˆ‘æ— æ³•åœ¨ä¸å¼•èµ·æ‚²ç—›å’Œæ„¤æ…¨çš„æƒ…å†µä¸‹è¿›ä¸€æ­¥è®¨è®ºå®ƒçš„è¡Œä¸º,å› æ­¤,åœ¨ä¿„ç½—æ–¯å’Œä¸­å›½ç­‰è½¯ä»¶ç›—ç‰ˆçš„æ¸©åºŠå›½å®¶,è¿™ç§æ“ä½œè¢«å¹¿æ³›ä½¿ç”¨ä¹Ÿå°±ä¸è¶³ä¸ºå¥‡äº†!)åˆ«é—®æˆ‘ â€”â€” æˆ‘ä¸ä¼šå†ææˆ‘ç»å¸¸ç”¨çš„è¿™ç§å‘é„™çš„ä¼ä¿©äº†ã€‚\nå¯ä»¥ä½¿ç”¨`unsafePerformIO`(ä¸æ˜¯`unsafeInterleaveIO`)æ¥æ‰§è¡ŒI/Oæ“ä½œ,è€Œä¸æ˜¯æŒ‰é¢„å®šä¹‰é¡ºåºæ‰§è¡ŒI/Oæ“ä½œã€‚ä¾‹å¦‚,ä»¥ä¸‹ä»£ç ï¼š\n```\ndo let c = unsafePerformIO getChar\n   do_proc c\n```\nåªæœ‰å½“ä»£ç ç¡®å®éœ€è¦`c`çš„å€¼æ—¶æ‰ä¼šæ‰§è¡Œ`getChar I/O`è°ƒç”¨,å³å®ƒå°†åƒä»»ä½•é€šå¸¸çš„Haskellè®¡ç®—ä¸€æ ·æ‡’æƒ°åœ°æ‰§è¡Œ.\nç°åœ¨æƒ³è±¡ä¸‹é¢çš„ä»£ç ï¼š\n```\ndo let s = [unsafePerformIO getChar, unsafePerformIO getChar, unsafePerformIO getChar]\n   do_proc s\n```\næ­¤åˆ—è¡¨ä¸­çš„ä¸‰ä¸ªå­—ç¬¦ä¹Ÿå°†æŒ‰éœ€è®¡ç®—,è¿™æ„å‘³ç€å®ƒä»¬çš„å€¼å°†å–å†³äºå®ƒä»¬çš„æ¶ˆè€—é¡ºåºã€‚è¿™é€šå¸¸ä¸æ˜¯æˆ‘ä»¬éœ€è¦çš„ã€‚\n`unsafeInterleaveIO`è§£å†³äº†è¿™ä¸ªé—®é¢˜ - å®ƒåªåœ¨éœ€è¦æ—¶æ‰§è¡ŒI/O,ä½†å…è®¸ä¸ºæ•°æ®ç»“æ„çš„å„ä¸ªéƒ¨åˆ†å®šä¹‰ç²¾ç¡®çš„*å†…éƒ¨*æ‰§è¡Œé¡ºåºã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘å†™é“`unsafeInterleaveIO`åˆ¶ä½œéæ³•å¤åˆ¶çš„æ¥åŠ›æ£’ã€‚\n\né¦–å…ˆ,`unsafeInterleaveIO`å°†`(IO a)`action ä½œä¸ºå‚æ•°å¹¶è¿”å›ç±»å‹ä¸º`a`çš„å€¼ï¼š\n```\ndo str <- unsafeInterleaveIO myGetContents\n```\nå…¶æ¬¡,`unsafeInterleaveIO`ä¸ä¼šç«‹å³æ‰§è¡Œä»»ä½•æ“ä½œ,å®ƒåªåˆ›å»ºä¸€ä¸ªç±»å‹ä¸º`a`çš„ç›’å­,åœ¨è¯·æ±‚æ­¤å€¼æ—¶å°†æ‰§è¡ŒæŒ‡å®šä¸ºå‚æ•°çš„æ“ä½œã€‚\nç¬¬ä¸‰,è¿™ä¸ªactionæœ¬èº«å¯ä»¥ç«‹å³è®¡ç®—æ•´ä¸ªå€¼æˆ–è€…......å†æ¬¡ä½¿ç”¨`unsafeInterleaveIO`æ¨è¿Ÿè®¡ç®—ä¸€äº›å­ç»„ä»¶ï¼š\n```\nmyGetContents = do\n   c <- getChar\n   s <- unsafeInterleaveIO myGetContents\n   return (c:s)\n```\næ­¤ä»£ç ä»…åœ¨ç¡®å®éœ€è¦`str`çš„å€¼æ—¶æ‰§è¡Œ,åœ¨è¿™ä¸€åˆ»,å°†æ‰§è¡Œ`getChar`(ç»“æœåˆ†é…ç»™`c`),å¹¶ä¸”å°†åˆ›å»ºä¸€ä¸ªæ›´æ‡’çš„IOç›’å­`s`ã€‚ æ­¤ç›’å­å†æ¬¡åŒ…å«æŒ‡å‘`myGetContents`è°ƒç”¨çš„é“¾æ¥\nç„¶å,è¿”å›ä¸€ä¸ªåŒ…å«`char read`çš„listå•å…ƒæ ¼,å¹¶é“¾æ¥åˆ°`myGetContents`è°ƒç”¨(ä½œä¸ºè®¡ç®—åˆ—è¡¨å…¶ä½™éƒ¨åˆ†çš„æ–¹æ³•)ã€‚\nä»…å½“éœ€è¦listä¸­çš„ä¸‹ä¸€ä¸ªå€¼æ—¶,æ‰ä¼šå†æ¬¡æ‰§è¡Œæ­¤æ“ä½œã€‚\nä½œä¸ºæœ€ç»ˆç»“æœ,æˆ‘ä»¬æ— æ³•åœ¨è¯»å–ç¬¬ä¸€ä¸ªä¹‹å‰è¯»å–åˆ°åˆ—è¡¨ä¸­çš„ç¬¬äºŒä¸ªå­—ç¬¦,è€Œæ˜¯è¯»å–æ•´ä¸ªåˆ—è¡¨çš„æ‡’æƒ°å­—ç¬¦ã€‚ç­”å¯¹äº†ï¼\n\nPS:å½“ç„¶ï¼Œå®é™…ä»£ç åº”è¯¥åŒ…æ‹¬EOFæ£€æŸ¥ã€‚è¯·æ³¨æ„ï¼Œä½ å¯ä»¥åœ¨æ¯æ¬¡é€šè¯ä¸­è¯»å–å¤šä¸ªå­—ç¬¦/è®°å½•:\n```\nmyGetContents = do\n   c <- replicateM 512 getChar\n   s <- unsafeInterleaveIO myGetContents\n   return (c++s)\n```\n\n#### æ›´å®‰å…¨çš„æ–¹æ³•: ST monad\næˆ‘ä»¬ä¹‹å‰è¯´è¿‡ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`unsafePerformIO`æ¥æ‰§è¡Œå®Œå…¨çº¯ç²¹ä½†ä»ä»¥æŸç§æ–¹å¼ä¸çœŸå®ä¸–ç•Œäº¤äº’çš„è®¡ç®—ã€‚ä½†æ˜¯ï¼Œè¿˜æœ‰æ›´å¥½çš„æ–¹æ³•! å®ƒä¿æŒäº†å®Œå…¨çº¯ç²¹æ€§ï¼Œå¹¶ä¸”å…è®¸ä½¿ç”¨å¼•ç”¨/æ•°ç»„ç­‰ç­‰ - å¹¶ä¸”å®ƒå·²ç»å®Œæˆäº†ä½¿ç”¨ï¼Œä½ çŒœå¯¹äº†ï¼Œç±»å‹é­”æ³•ã€‚è¿™æ˜¯`ST monad`ã€‚\n`ST monad`çš„`unsafePerformIO`ç‰ˆæœ¬ç§°ä¸º`runST`,å®ƒæœ‰ä¸€ç§éå¸¸ä¸å¯»å¸¸çš„ç±»å‹ã€‚\n```\nrunST :: (forall s . ST s a) -> a\n```\n`ST monadä¸­`çš„`s`å˜é‡æ˜¯çŠ¶æ€ç±»å‹ã€‚æ­¤å¤–,`ST monad`ä¸­å¯ç”¨çš„æ‰€æœ‰æœ‰è¶£çš„å¯å˜å†…å®¹éƒ½æ˜¯é€šè¿‡`s`æ¥é‡åŒ–çš„ï¼š\n```\nnewSTRef :: a -> ST s (STRef s a)\nnewArray_ :: Ix i => (i, i) -> ST s (STArray s i e)\n```\né‚£ä¹ˆä¸ºä»€ä¹ˆ`runST`æœ‰è¿™ä¹ˆæ—¶é«¦çš„ç±»å‹å‘¢ï¼Ÿè®©æˆ‘ä»¬çœ‹çœ‹å¦‚æœæˆ‘ä»¬å†™ä¸‹ä¼šå‘ç”Ÿä»€ä¹ˆ\n```\nmakeSTRef :: a -> STRef s a\nmakeSTRef a = runST (newSTRef a)\n```\nè¿™å°†å¤±è´¥,å› ä¸º`newSTRef a`å¹¶ä¸é€‚ç”¨äºæ‰€æœ‰çŠ¶æ€ç±»å‹`s` â€”â€” å®ƒåªé€‚ç”¨äºè¿”å›ç±»å‹`STRef s a`çš„`s`ã€‚\nè¿™æœ‰ç‚¹å¤æ€ª,ä½†ç»“æœæ˜¯,æ‚¨åªèƒ½è¿è¡Œä¸€ä¸ª`ST`è®¡ç®—,å…¶ä¸­è¾“å‡ºç±»å‹åœ¨åŠŸèƒ½ä¸Šæ˜¯çº¯çš„,å¹¶ä¸”ä¸å¼•ç”¨è®¡ç®—çš„å†…éƒ¨å¯å˜çŠ¶æ€,`ST monad`ä¹Ÿä¸èƒ½è®¿é—®I/Oæ“ä½œ,æ¯”å¦‚å†™å…¥æ§åˆ¶å° â€”â€” åªæœ‰å¼•ç”¨ã€æ•°ç»„ä¹‹ç±»çš„æ“ä½œæ‰èƒ½æ–¹ä¾¿åœ°è¿›è¡Œçº¯è®¡ç®—ã€‚\né‡è¦æç¤º - `state`ç±»å‹å®é™…ä¸Šå¹¶ä¸æ„å‘³ç€ä»€ä¹ˆã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬ä»æœªæ‹¥æœ‰ç±»å‹`s`çš„å€¼ã€‚è¿™åªæ˜¯è®©ç±»å‹ç³»ç»Ÿé€šè¿‡çƒŸé›¾å’Œé•œå­æ¥ç¡®ä¿æˆ‘ä»¬çš„çº¯åº¦å·¥ä½œçš„ä¸€ç§æ–¹å¼ã€‚\nå®ƒå®é™…ä¸Šåªæ˜¯ä¸€ç§ç±»å‹ç³»ç»Ÿé­”æ³•:åœ¨å†…éƒ¨,`runST`åƒ`unsafePerformIO`ä¸€æ ·ï¼Œç”¨çœŸå®ä¸–ç•Œçš„æ¥åŠ›æ£’è¿è¡Œè®¡ç®—ã€‚å®ƒä»¬çš„å†…éƒ¨å®ç°å‡ ä¹æ˜¯ç›¸åŒçš„, äº‹å®ä¸Š,æœ‰ä¸€ä¸ªå‡½æ•°:\n```\nstToIO :: ST RealWorld a -> IO a\n```\nä¸åŒä¹‹å¤„åœ¨äº`ST`ä½¿ç”¨ç±»å‹ç³»ç»Ÿé­”æ³•ç¦æ­¢ä¸å®‰å…¨è¡Œä¸º,ä¾‹å¦‚ä»å®‰å…¨`ST`åŒ…è£…ä¸­æå–å¯å˜å¯¹è±¡,ä½†æ˜¯å…è®¸ä½¿ç”¨å¯¹å¯å˜å¼•ç”¨å’Œæ•°ç»„çš„æ‰€æœ‰æ–¹ä¾¿è®¿é—®æ¥æ‰§è¡Œçº¯å‡½æ•°è¾“å‡ºã€‚\nä¸‹é¢æ˜¯æˆ‘ä»¬å¦‚ä½•ç”¨ä¸Šé¢çš„`unsafePerformIO`é‡å†™æˆ‘ä»¬çš„å‡½æ•°:\n```\noneST :: ST s Int -- note that this works correctly for any s\noneST = do var <- newSTRef 0\n           modifySTRef var (+1)\n           readSTRef var\n\none :: Int\none = runST oneST\n```\n\n#### æ¬¢è¿æ¥åˆ°æœºå™¨: å®é™…çš„GHCå®ç°\nä¸€ä¸ªå°å°çš„å…è´£å£°æ˜: æˆ‘åº”è¯¥è¯´æˆ‘å¹¶æ²¡æœ‰åœ¨è¿™é‡Œè¯¦ç»†æè¿°monadæ˜¯ä»€ä¹ˆ(æˆ‘è‡ªå·±ç”šè‡³éƒ½ä¸å®Œå…¨ç†è§£å®ƒ)è€Œä¸”æˆ‘çš„è§£é‡Šåªæ˜¾ç¤ºäº†åœ¨Haskellä¸­å®ç°`IO monad`çš„ä¸€ç§å¯èƒ½æ–¹å¼ã€‚ä¾‹å¦‚,`hbc Haskell`ç¼–è¯‘å™¨å’Œ`Hugs`è§£é‡Šå™¨é€šè¿‡`continuation`å®ç°`IO monad`ã€‚æˆ‘è¿˜æ²¡æœ‰è°ˆåˆ°å¼‚å¸¸å¤„ç†,è¿™æ˜¯`monad`æ¦‚å¿µçš„ä¸€ä¸ªè‡ªç„¶éƒ¨åˆ†ã€‚æ‚¨å¯ä»¥é˜…è¯»\"All About Monads\"æŒ‡å—,äº†è§£æœ‰å…³è¿™äº›ä¸»é¢˜çš„æ›´å¤šä¿¡æ¯ã€‚\nä½†æœ‰ä¸€äº›å¥½æ¶ˆæ¯:é¦–å…ˆ,ä½ åˆšåˆšè·å¾—çš„`IO monad`ç†è§£å°†é€‚ç”¨äºä»»ä½•è®¸å¤šå…¶ä»–`monad`çš„å®ç°ã€‚æ‚¨åªæ˜¯æ— æ³•ç›´æ¥ä½¿ç”¨`RealWorld`å€¼ã€‚\nå…¶æ¬¡,è¿™é‡Œæè¿°çš„`IO monad`å®ç°å®é™…ä¸Šæ˜¯åœ¨`GHCã€yhc/nhc (jhc?)`ç¼–è¯‘å™¨ä¸­ä½¿ç”¨çš„ã€‚ä¸‹é¢æ˜¯GHCæ¥æºçš„IOå®šä¹‰:\n```\nnewtype IO a = IO (State# RealWorld -> (# State# RealWorld, a #))\n```\nå®ƒä½¿ç”¨`State# RealWorld`ç±»å‹è€Œä¸æ˜¯æˆ‘ä»¬çš„`RealWorld`,å®ƒä½¿ç”¨`(# #)`ä¸¥æ ¼çš„å…ƒç»„è¿›è¡Œä¼˜åŒ–,å¹¶å›´ç»•è¯¥ç±»å‹æ·»åŠ ä¸€ä¸ªIOæ•°æ®æ„é€ å‡½æ•°ã€‚ç„¶è€Œ,ä»æˆ‘ä»¬çš„è§£é‡Šæ¥çœ‹,å¹¶æ²¡æœ‰ä»€ä¹ˆé‡å¤§çš„å˜åŒ–ã€‚äº†è§£äº†é€šè¿‡`ä¼ªè£…worldçŠ¶æ€`å€¼\"é“¾æ¥\"IOæ“ä½œçš„åŸåˆ™,æ‚¨ç°åœ¨å¯ä»¥è½»æ¾ç†è§£å’Œç¼–å†™`GHC I/O`æ“ä½œçš„åº•å±‚å®ç°ã€‚\n\n##### Yhc/nhc98 å®ç°\n```\ndata World = World\nnewtype IO a = IO (World -> Either IOError a)\n```\nè¿™ä¸ªå®ç°ä½¿`World`åœ¨æŸç§ç¨‹åº¦ä¸Šæ¶ˆå¤±,å¹¶è¿”å›ç±»å‹ä¸º`a`çš„ç»“æœ,æˆ–è€…å¦‚æœå‡ºç°é”™è¯¯,åˆ™è¿”å›`IOError`ã€‚åªæœ‰å½“ç¼–è¯‘å™¨çŸ¥é“IOç±»å‹çš„ä¸€äº›ç‰¹æ®Šä¿¡æ¯,å¹¶ä¸”ä¸ä¼šå¯¹å…¶è¿›è¡Œè¿‡åº¦ä¼˜åŒ–æ—¶,å‡½æ•°å³è¾¹æ‰ä¼šç¼ºå°‘`World`ã€‚\n\n#### è¿›ä¸€æ­¥é˜…è¯»\n\n#### to-doåˆ—è¡¨\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","tags":["IO"]},{"title":"Dubboæºç é˜…è¯»ä¹‹æœåŠ¡å™¨åˆ›å»º","url":"/blog/2019/02/20/Dubboæºç é˜…è¯»ä¹‹æœåŠ¡å™¨åˆ›å»º/","content":">åœ¨ã€ŠDubboæºç é˜…è¯»ä¹‹æœåŠ¡æš´éœ²ã€‹ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“åœ¨æœåŠ¡æš´éœ²æ—¶ä¼šåˆ›å»ºæœåŠ¡å™¨ï¼Œè¿™ç¯‡æ–‡ç« æˆ‘ä»¬å°±è¯¦ç»†çœ‹ä¸‹æœåŠ¡å™¨ç›¸å…³çš„æºç ã€‚\n\n![](images/dubbo.jpeg)\n\n###\n\n\n\n","tags":["dubbo"]},{"title":"Haskellå¸¸ç”¨æ‰©å±•","url":"/blog/2018/11/20/Haskellå¸¸ç”¨æ‰©å±•/","content":"\n### BinaryLiterals\n\n### ExistentialQuantification\n\n### FlexibleInstances\n\n### LambdaCase\nä¸€ä¸ªå¥æ³•æ‰©å±•ï¼Œå…è®¸ä½ ç”¨\\caseä»£æ›¿\\arg - > case arg of.\nè¯·è€ƒè™‘ä»¥ä¸‹å‡½æ•°å®šä¹‰ï¼š\n```\ndayOfTheWeek :: Int -> String\ndayOfTheWeek 0 = \"Sunday\"\ndayOfTheWeek 1 = \"Monday\"\ndayOfTheWeek 2 = \"Tuesday\"\ndayOfTheWeek 3 = \"Wednesday\"\ndayOfTheWeek 4 = \"Thursday\"\ndayOfTheWeek 5 = \"Friday\"\ndayOfTheWeek 6 = \"Saturday\"\n```\nå¦‚æœæ‚¨æƒ³é¿å…é‡å¤å‡½æ•°åç§°ï¼Œå¯ä»¥è¿™æ ·ç¼–å†™ï¼š\n```\ndayOfTheWeek :: Int -> String\ndayOfTheWeek i = case i of\n    0 -> \"Sunday\"\n    1 -> \"Monday\"\n    2 -> \"Tuesday\"\n    3 -> \"Wednesday\"\n    4 -> \"Thursday\"\n    5 -> \"Friday\"\n    6 -> \"Saturday\"\n```\nè€Œä½¿ç”¨LambdaCaseæ‰©å±•åï¼Œæ‚¨å¯ä»¥å°†å…¶ç¼–å†™ä¸ºå‡½æ•°è¡¨è¾¾å¼ï¼Œè€Œæ— éœ€ä¸ºå‚æ•°å‘½åï¼š\n```\n{-# LANGUAGE LambdaCase #-}\n\ndayOfTheWeek :: Int -> String\ndayOfTheWeek = \\case\n    0 -> \"Sunday\"\n    1 -> \"Monday\"\n    2 -> \"Tuesday\"\n    3 -> \"Wednesday\"\n    4 -> \"Thursday\"\n    5 -> \"Friday\"\n    6 -> \"Saturday\"\n```\n\n### ScopedTypeVariables\nScopedTypeVariableså…è®¸æ‚¨å¼•ç”¨å£°æ˜ä¸­çš„é€šç”¨é‡åŒ–ç±»å‹, æ›´æ˜ç¡®ä¸€ç‚¹ï¼š\n```\nimport Data.Monoid\n\nfoo :: forall a b c. (Monoid b, Monoid c) => (a, b, c) -> (b, c) -> (a, b, c)\nfoo (a, b, c) (b', c') = (a :: a, b'', c'')\n    where (b'', c'') = (b <> b', c <> c') :: (b, c)\n```\né‡è¦çš„æ˜¯æˆ‘ä»¬å¯ä»¥ä½¿ç”¨a,bå’Œcæ¥æŒ‡ç¤ºç¼–è¯‘å™¨åœ¨å£°æ˜çš„å­è¡¨è¾¾å¼ä¸­(whereå­å¥ä¸­çš„å…ƒç»„å’Œæœ€ç»ˆç»“æœä¸­çš„ç¬¬ä¸€ä¸ªa),å®é™…ä¸Š,ScopedTypeVariablesæœ‰åŠ©äºå°†å¤æ‚å‡½æ•°ç¼–å†™ä¸ºéƒ¨åˆ†ä¹‹å’Œï¼Œå…è®¸ç¨‹åºå‘˜å°†ç±»å‹ç­¾åæ·»åŠ åˆ°æ²¡æœ‰å…·ä½“ç±»å‹çš„ä¸­é—´å€¼ã€‚\n\n\n### OverloadedStrings\né€šå¸¸ï¼ŒHaskellä¸­çš„å­—ç¬¦ä¸²æ–‡å­—å…·æœ‰Stringç±»å‹ï¼ˆå®ƒæ˜¯[Char]çš„ç±»å‹åˆ«åï¼‰ã€‚è™½ç„¶è¿™å¯¹äºè¾ƒå°çš„æ•™è‚²ç¨‹åºæ¥è¯´ä¸æ˜¯é—®é¢˜ï¼Œä½†å®é™…åº”ç”¨ç¨‹åºé€šå¸¸éœ€è¦æ›´é«˜æ•ˆçš„å­˜å‚¨ï¼Œä¾‹å¦‚Textæˆ–ByteString.\nOverloadedStringsåªæ˜¯å°†æ–‡å­—ç±»å‹æ›´æ”¹ä¸º:\n```\n\"test\" :: Data.String.IsString a => a\n```\nå…è®¸å®ƒä»¬ç›´æ¥ä¼ é€’ç»™æœŸæœ›è¿™ç§ç±»å‹çš„å‡½æ•°ã€‚è®¸å¤šåº“ä¸ºç±»ä¼¼å­—ç¬¦ä¸²çš„ç±»å‹å®ç°äº†è¿™ä¸ªæ¥å£ï¼ŒåŒ…æ‹¬Data.Textå’ŒData.ByteString ï¼Œå®ƒä»¬éƒ½æ¯”[Char]æä¾›äº†ä¸€å®šçš„æ—¶é—´å’Œç©ºé—´ä¼˜åŠ¿ã€‚\n\nè¿˜æœ‰ä¸€äº›åƒPostgresqlç®€å•åº“é‚£æ ·çš„OverloadedStringsç‹¬ç‰¹ç”¨é€”ï¼Œå®ƒå…è®¸ç”¨åŒå¼•å·ç¼–å†™SQLæŸ¥è¯¢ï¼Œå°±åƒæ™®é€šå­—ç¬¦ä¸²ä¸€æ ·ï¼Œä½†æä¾›äº†å¯¹ä¸æ­£ç¡®è¿æ¥çš„ä¿æŠ¤ï¼Œè¿™æ˜¯ä¸€ç§è‡­åæ˜­ç€çš„SQLæ³¨å…¥æ”»å‡»æºã€‚\nè¦åˆ›å»ºIsStringç±»çš„å®ä¾‹ï¼Œæ‚¨éœ€è¦å®ç°fromStringå‡½æ•°ã€‚ç¤ºä¾‹ï¼š\n```\ndata Foo = A | B | Other String deriving Show\n\ninstance IsString Foo where\n  fromString \"A\" = A\n  fromString \"B\" = B\n  fromString xs  = Other xs\n\ntests :: [ Foo ]\ntests = [ \"A\", \"B\", \"Testing\" ]\n```\n\n\n\n### TupleSections\nä¸€ç§è¯­æ³•æ‰©å±•ï¼Œå…è®¸ä»¥èŠ‚çš„æ–¹å¼åº”ç”¨å…ƒç»„æ„é€ å‡½æ•°(å®ƒæ˜¯ä¸€ä¸ªè¿ç®—ç¬¦):\n```\n(a,b) == (,) a b\n\n-- With TupleSections\n(a,b) == (,) a b == (a,) b == (,b) a\n```\n#### N-tuples\nå®ƒä¹Ÿé€‚ç”¨äºå…ƒç´ å¤§äº2çš„å…ƒç»„\n```\n(,2,) 1 3 == (1,2,3)\n```\n#### Mapping\nè¿™åœ¨ä½¿ç”¨éƒ¨åˆ†çš„å…¶ä»–åœ°æ–¹ä¹Ÿå¾ˆæœ‰ç”¨:\n```\nmap (,\"tag\") [1,2,3] == [(1,\"tag\"), (2, \"tag\"), (3, \"tag\")]\n```\næ²¡æœ‰æ­¤æ‰©å±•çš„ä¸Šè¿°ç¤ºä¾‹å¦‚ä¸‹æ‰€ç¤ºï¼š\n```\nmap (\\a -> (a, \"tag\")) [1,2,3]\n```\n\n\n\n","tags":["haskell"]},{"title":"wire-serverç¿»è¯‘","url":"/blog/2018/11/19/wire-serverç¿»è¯‘/","content":"\n### ä»“åº“å†…å®¹\nè¿™ä¸ªä»“åº“åŒ…å«ä¸€ä¸‹æºä»£ç ï¼š\n\n#### services(æœåŠ¡)\n* nginz: åå‘ä»£ç†å…¬å…±APIï¼ˆå¸¦æœ‰libzauthè‡ªå®šä¹‰æ¨¡å—çš„Nginxï¼‰\n* galley: ä¼šè¯å’Œå›¢é˜Ÿ\n* brig: è´¦æˆ·\n* gundeck: æ¨é€é€šçŸ¥ä¸­å¿ƒ\n* cannon: WebSocketæ¨é€é€šçŸ¥\n* cargohold: èµ„äº§(å›¾åƒï¼Œæ–‡ä»¶...)å­˜å‚¨\n* proxy: é›†æˆç¬¬ä¸‰æ–¹API\n* restund: ç”¨äºéŸ³é¢‘/è§†é¢‘é€šè¯çš„STUN/TURNæœåŠ¡å™¨\n\n#### tools(å·¥å…·)\n* api-simulations: è‡ªåŠ¨åŒ–è¿è¡Œå†’çƒŸå’Œè´Ÿè½½æµ‹è¯• \n* makedeb: åˆ›å»ºDebianè½¯ä»¶åŒ…\n* bonanza: è½¬æ¢å’Œè½¬å‘æ—¥å¿—æ•°æ®\n* db/: è¿ç§»å·¥å…·(ä¾‹å¦‚: å½“æ·»åŠ æ–°çš„è¡¨æ—¶)\n\n#### libs(åº“)\n* å…±äº«åº“\n\n#### å…¶ä»–\n* build: ä¸ºæŸäº›å¹³å°æ„å»ºè„šæœ¬å’ŒDockerfiles\n* deploy: (æ­£åœ¨è¿›è¡Œä¸­)-å¦‚ä½•åœ¨çŸ­æš‚çš„å†…å­˜æ¼”ç¤ºæ¨¡å¼ä¸‹è¿è¡Œwire-server\n* doc: æ–‡æ¡£\n\n### æ¶æ„æ¦‚è¿°\nä¸‹å›¾æä¾›äº†æ„æˆWire Serverçš„ç»„ä»¶ï¼ˆéƒ¨ç½²ï¼‰ä½“ç³»ç»“æ„çš„é«˜çº§æ¦‚è¿°ï¼Œä»¥åŠç»„ä»¶ä¹‹é—´ä¸»è¦çš„å†…éƒ¨å’Œå¤–éƒ¨ä¾èµ–å…³ç³»ã€‚\n![](img/main.png)\nå†…éƒ¨ç»„ä»¶ä¹‹é—´çš„é€šä¿¡ç›®å‰æ²¡æœ‰é€šè¿‡ä¸“ç”¨è®¤è¯æˆ–åŠ å¯†æ¥ä¿æŠ¤ï¼Œå¹¶ä¸”è¢«å‡å®šä¸ºå±€é™äºä¸“ç”¨ç½‘ç»œã€‚\n\n### Development setup(å¼€å‘è®¾ç½®)\n#### å¦‚ä½•æ„å»ºwire-serveräºŒè¿›åˆ¶æ–‡ä»¶\nä¸¤ç§æ–¹å¼ï¼š\n* æœ¬åœ°ç¼–è¯‘æºä»£ç \n  è¿™éœ€è¦ä¸€ç³»åˆ—ä¾èµ–äºæ‚¨çš„å¹³å°/æ“ä½œç³»ç»Ÿçš„ä¾èµ–å…³ç³»ï¼Œä¾‹å¦‚ï¼š\n    * Haskell å’ŒRustç¼–è¯‘å™¨å’ŒåŒ…ç®¡ç†å™¨\n    * ä¾èµ–äºä½ çš„å¹³å°/æ“ä½œç³»ç»Ÿçš„ä¸€äº›ä¾èµ–åŒ…(libsodium, openssl, protobuf, icu, geoip, snappy, cryptobox-c,)\n  æŸ¥çœ‹ä¾èµ–è¯¦æƒ…(doc/Dependencies.md)\n  è®¾ç½®å¥½æ‰€æœ‰çš„ä¾èµ–é¡¹åï¼Œä¸‹é¢çš„æ“ä½œåº”è¯¥æ˜¯æˆåŠŸçš„ï¼š\n```shell\n# build all haskell services\nmake\n# build one haskell service, e.g. brig:\ncd services/brig && make\n```\né»˜è®¤çš„make targetï¼ˆfastï¼‰ç¼–è¯‘æœªä¼˜åŒ–ï¼ˆç¼–è¯‘æ—¶é—´æ›´å¿«ï¼ŒäºŒè¿›åˆ¶æ–‡ä»¶æ›´æ…¢ï¼‰ï¼Œè¿™å¯¹äºå¼€å‘ç›®çš„æ¥è¯´åº”è¯¥æ²¡é—®é¢˜ã€‚ ä½¿ç”¨make installè·å–ä¼˜åŒ–çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚\nå¯¹äºç¼–è¯‘nginzï¼Œè¯·çœ‹(services/nginz/README.md)\n* ä½¿ç”¨Docker\nå¦‚æœæ‚¨ä¸å¸Œæœ›ä»å¤´å¼€å§‹æ„å»ºæ‰€æœ‰dockeré•œåƒ(ä¾‹å¦‚:alpine-builderéœ€è¦å¾ˆé•¿æ—¶é—´),å¯ä»¥ä»æ­¤å¤„ä¸‹è½½ç°æˆçš„é•œåƒã€‚\nå¦‚æœä½ å¸Œæœ›æ„å»ºä½ è‡ªå·±çš„Dockeré•œåƒï¼Œä½ éœ€è¦docker version >= 17.05å’Œmakeï¼Œç„¶åæ‰§è¡Œ:\n```shell\nmake docker-services\n```\næœ€ç»ˆï¼Œå®ƒå°†æ„å»ºä¸€ç³»åˆ—dockeré•œåƒï¼Œæœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·çœ‹Makefileså’ŒDockerfilesï¼Œä»¥åŠbuild/alpine/README.md\n\n#### å¦‚ä½•è¿è¡Œé›†æˆæµ‹è¯•\nè¿è¡Œé›†æˆæµ‹è¯•å‰ï¼Œè¦æ±‚æ‰€æœ‰çš„haskellæœåŠ¡((brig,galley,cannon,gundeck,proxy,cargohold)éƒ½å·²ç»æ­£ç¡®é…ç½®å¹¶ä¸”å·²å¯åŠ¨ï¼Œç„¶åæ‰èƒ½æ‰§è¡Œä¾‹å¦‚:brig-integrationäºŒè¿›åˆ¶æ–‡ä»¶ã€‚è¿™è¦æ±‚åœ¨ä½“ç³»ç»“æ„å›¾ä¸­çœ‹åˆ°çš„å¤§å¤šæ•°éƒ¨ç½²ä¾èµ–é¡¹ä¹Ÿéƒ½æ˜¯å¯ç”¨çš„ï¼š\n* å¿…é¡»çš„å†…éƒ¨ä¾èµ–é¡¹\n  * cassandra(ä½¿ç”¨æ­£ç¡®çš„schema)\n  * elasticsearch(ä½¿ç”¨æ­£ç¡®çš„schema)\n  * redis\n* å¿…é¡»çš„å¤–éƒ¨ä¾èµ–é¡¹æ˜¯ä»¥ä¸‹å·²ç»é…ç½®å¥½çš„AWSæœåŠ¡(æˆ–æä¾›ç›¸åŒAPIçš„å‡çš„é…ä»¶)\n  * SES\n  * SQS\n  * SNS\n  * S3\n  * Cloudfront\n  * DynamoDB\nä½¿ç”¨docker-composeè®¾ç½®è¿™äº›çœŸå®çš„åªæ˜¯åœ¨å†…å­˜ä¸­çš„å†…éƒ¨å’Œ\"å‡\"çš„å¤–éƒ¨ä¾èµ–æ˜¯éå¸¸å®¹æ˜“çš„ã€‚åœ¨ä¸€ä¸ªå•ç‹¬çš„ç»ˆç«¯ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤(å®ƒå°†é˜»å¡ç»ˆç«¯ï¼Œä½¿ç”¨C-cå»å…³é—­è¿™äº›æ‰€æœ‰çš„dockeré•œåƒ):\n```shell\ndeploy/docker-ephemeral/run.sh\n```\nç„¶åï¼Œè¿è¡Œæ‰€æœ‰çš„é›†æˆæµ‹è¯•:\n```shell\nmake integration\n```\næˆ–è€…ï¼Œåœ¨é¡¶çº§ç›®å½•ä¸Šè¿›è¡Œmake(ç”Ÿæˆæ‰€æœ‰æœåŠ¡çš„äºŒè¿›åˆ¶æ–‡ä»¶)ï¼Œç„¶åæ‰§è¡Œä¾‹å¦‚: cd services/brig && make integration åªè¿è¡Œä¸€ä¸ªæœåŠ¡çš„é›†æˆæµ‹è¯•ã€‚\n\næ‚¨å¯ä»¥ä½¿ç”¨$WIRE_STACK_OPTIONSé€šè¿‡Makefileså°†å‚æ•°ä¼ é€’ç»™å †æ ˆï¼Œè¿™æ˜¯å¾ˆæœ‰ç”¨çš„ï¼Œä¾‹å¦‚ï¼šä¼ é€’å‚æ•°åˆ°tastyï¼Œæˆ–è€…æš‚æ—¶ç¦ç”¨-Werrorè€Œä¸ä¼šæœ‰æ„å¤–æäº¤ä»»ä½•å†…å®¹çš„é£é™©ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n```shell\nWIRE_STACK_OPTIONS='--ghc-options=-Wwarn --test-arguments=\"--quickcheck-tests=19919 --quickcheck-replay=651712\"' make integration\n```\næç¤ºï¼šhttps://github.com/feuerbach/tasty#runtime\n#### å¦‚ä½•ä½¿ç”¨\"å‡\"çš„å¤–éƒ¨ä¾èµ–è¿è¡Œwire-server\nçœ‹https://github.com/wireapp/wire-server/blob/develop/deploy/services-demo/README.md\n#### å¦‚ä½•ä½¿ç”¨çœŸå®çš„AWSæœåŠ¡è¿è¡Œwire-server\næ–‡æ¡£ï¼Œé…ç½®å’Œä»£ç å°šæœªå®Œå…¨å‡†å¤‡å¥½ï¼ˆè¯·ä¸è¦æ‰“å¼€issueæ¥è¯¢é—®è¿™ä¸ªé—®é¢˜ï¼ï¼‰ã€‚ æœ‰å…³å¦‚ä½•è¿è¡Œæœ‰çº¿æœåŠ¡å™¨çš„æ›´å¤šä¿¡æ¯å°†åœ¨ä¸ä¹…çš„å°†æ¥æä¾›ã€‚\nä½œä¸ºç®€è¦æ¦‚è¿°ï¼Œä»–éœ€è¦è®¾ç½®:\n* æ•°æ®åº“é›†ç¾¤(cassandra, redis, elasticsearch)\n* å¤–éƒ¨ä¾èµ–\n  * æœ‰æƒè®¿é—®çš„äºšé©¬é€Šè´¦æˆ·\n     * SES\n     * SQS\n     * SNS\n     * S3\n     * Cloudfront\n     * DynamoDB\n  * Nexmo/Twilioè´¦æˆ·(å¦‚æœä½ æƒ³å‘é€çŸ­ä¿¡)\n  * Giphy/Google/Spotify/Soundcloud APIå¯†é’¥(å¦‚æœä½ å¸Œæœ›é€šè¿‡ä»£ç†è¿™äº›æœåŠ¡æ¥æ”¯æŒé¢„è§ˆ)\n  * TURNæœåŠ¡(å¦‚æœä½ å¸Œæœ›æ”¯æŒè¯­éŸ³/è§†é¢‘é€šè¯)\n* æ‰€æœ‰æœåŠ¡çš„ç”Ÿäº§é¢„å¤‡ç¯å¢ƒé…ç½®\n* å…¶ä»–åŸºç¡€æ¶æ„é…ç½®(DNS, SSL certificates, metrics, logging, etc)\n\n#### Roadmap(è·¯çº¿å›¾)\n* éƒ¨ç½²é€‰é¡¹\n"},{"title":"Redisæºç é˜…è¯»-å­—ç¬¦ä¸²","url":"/blog/2018/11/17/Redisæºç é˜…è¯»-å­—ç¬¦ä¸²/","content":">RedisåŠ¨æ€å­—ç¬¦ä¸²æ•°æ®ç»“æ„çš„å®šä¹‰åŠå®ç°åœ¨sds.hå’Œsds.cæ–‡ä»¶ä¸­ã€‚\n\n* å­—ç¬¦ä¸²å®šä¹‰\n* å­—ç¬¦ä¸²å®ç°\n* æ–¹æ³•å®ç°\n\n### å­—ç¬¦ä¸²å®šä¹‰\næˆ‘ä»¬å¹³æ—¶åœ¨ä½¿ç”¨Redisæ—¶ï¼Œç»å¸¸ä½¿ç”¨çš„æ•°æ®ç»“æ„å°±æ˜¯å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ï¼š\n```shell\n127.0.0.1:6379> set name Redis\nOK\n127.0.0.1:6379> get name\n\"Redis\"\n127.0.0.1:6379> del name\n(integer) 1\n```\né‚£ä¹ˆå­—ç¬¦ä¸²åœ¨Redisæ˜¯å¦‚ä½•å®šä¹‰çš„å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥åœ¨sds.hæ–‡ä»¶ä¸­æ‰¾åˆ°ç­”æ¡ˆã€‚\nåœ¨è¯¥æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°Rediså­—ç¬¦ä¸²æ•°æ®ç»“æ„SDSç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼ŒsdsæŒ‡é’ˆå’Œsdshdrå¤´éƒ¨ç±»å‹ï¼Œ\nå…¶ä¸­sdshdrç±»å‹å®šä¹‰äº†5ç§(sdshdr5/sdshdr8/sdshdr16/sdshdr32/sdshdr64)ï¼Œä¸»è¦æ˜¯ä¸ºäº†é’ˆå¯¹ä¸åŒé•¿åº¦çš„å­—ç¬¦ä¸²ï¼ŒèŠ‚çœå†…å­˜ï¼š\n```c\ntypedef char *sds;\n\nstruct __attribute__ ((__packed__)) sdshdr5 {\n    unsigned char flags; /* 3 lsb of type, and 5 msb of string length */\n    char buf[];\n};\nstruct __attribute__ ((__packed__)) sdshdr8 {\n    uint8_t len;\n    uint8_t alloc;\n    unsigned char flags;\n    char buf[];\n};\n\n/*flagså€¼å®šä¹‰*/\n#define SDS_TYPE_5  0\n#define SDS_TYPE_8  1\n#define SDS_TYPE_16 2\n#define SDS_TYPE_32 3\n#define SDS_TYPE_64 4\n\n//æ©ç \n#define SDS_TYPE_MASK 7\n#define SDS_TYPE_BITS 3\n\n/*é€šè¿‡bufæŒ‡é’ˆè·å–sdså¤´æŒ‡é’ˆï¼ŒTä¸ºsdså¤´ç±»å‹å€¼ï¼Œsä¸ºbufæŒ‡é’ˆ\n *è¿™é‡Œ##ä¼šå°†ä¸¤ä¸ªå­—ç¬¦ä¸²è¿æ¥èµ·æ¥ï¼Œå¦‚:Tä¸º8ï¼Œåˆ™sdshdr##Tä¸ºsdshrd8\n *sizeof(struct sdshdr##T)ä¸ºç»“æ„ä½“sdshdr8å ç”¨çš„å­—èŠ‚æ•°ï¼Œè¿™é‡Œä¸º3å­—èŠ‚\n */\n#define SDS_HDR_VAR(T,s) struct sdshdr##T *sh = (void*)((s)-(sizeof(struct sdshdr##T)));\n\n#define SDS_HDR(T,s) ((struct sdshdr##T *)((s)-(sizeof(struct sdshdr##T))))\n\n#define SDS_TYPE_5_LEN(f) ((f)>>SDS_TYPE_BITS)\n```\n![](img/sds.png)\nlen   æ ‡è¯†å½“å‰å­—èŠ‚æ•°ç»„çš„é•¿åº¦ï¼Œä¸åŒ…å«å­—ç¬¦ä¸²ç»“æŸæ ‡è¯†ã€‚\nalloc æ ‡è¯†å½“å‰å­—èŠ‚æ•°ç»„åˆ†é…çš„å†…å­˜å¤§å°ï¼Œä¸åŒ…å«å­—ç¬¦ä¸²ç»“æŸæ ‡è¯†ã€‚\nflags ä½3ä½æ ‡è¯†å½“å‰ä½¿ç”¨çš„æ˜¯å“ªä¸ªsdshdrç±»å‹ã€‚\nbuf   ä¿å­˜å­—ç¬¦ä¸²å€¼å’Œç»“æŸæ ‡è¯†ã€‚\n*sds  æŒ‡å‘bufæ•°ç»„çš„èµ·å§‹åœ°å€\nä¸ºSDSå¢åŠ ä¸€ä¸ªå¤´éƒ¨ç±»å‹å¯ä»¥æé«˜ä¸€äº›æ“ä½œçš„æ•ˆç‡ï¼Œä¾‹å¦‚ç”¨O(1)çš„å¤æ‚åº¦å°±å¯ä»¥ä»å¤´éƒ¨ä¸­å–åˆ°å­—ç¬¦ä¸²é•¿åº¦ã€‚\nsdshdrå¤´éƒ¨ç±»å‹æ˜¯é€šè¿‡ç»“æ„ä½“å®šä¹‰çš„ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¼šè¿›è¡Œå†…å­˜å¯¹é½ä¼˜åŒ–ï¼Œå³ç»“æ„ä½“åˆ†é…çš„å†…å­˜æ˜¯å†…éƒ¨æœ€å¤§å…ƒç´ çš„æ•´æ•°å€ï¼Œä¾‹å¦‚sdshdr32å°†ä¼šåˆ†é…12å­—èŠ‚ã€‚\nè¿™é‡Œä½¿ç”¨__attribute__ ((__packed__))å…³é—­å†…å­˜å¯¹é½ä¼˜åŒ–ï¼Œä»è€ŒæŒ‰ç…§å®é™…å ç”¨å­—èŠ‚æ•°æ¥å¯¹é½ï¼Œå³sdshdr32å°†ä¼šåˆ†é…9å­—èŠ‚ï¼ŒèŠ‚çœäº†3å­—èŠ‚ã€‚å†…å­˜ç´§å‡‘ï¼Œä½¿ç”¨sds-1å°±å¯ä»¥å¾—åˆ°flagså­—æ®µï¼Œè¿›è€Œå¾—åˆ°å…¶å¤´éƒ¨ç±»å‹ã€‚æ²¡æœ‰å†…å­˜å¯¹é½ï¼Œcpuå¯»å€æ•ˆç‡å°±ä¼šé™ä½ï¼ŒRedisæ˜¯åœ¨å†…å­˜åˆ†é…å‰åšäº†ä¸€äº›æ“ä½œï¼Œè§£å†³å†…å­˜å¯¹é½çš„ï¼Œåé¢ä¼šçœ‹åˆ°ã€‚\nbufæ•°ç»„åˆå§‹åŒ–æ—¶ä¸å ç”¨å†…å­˜ç©ºé—´ï¼Œä½¿å¾—å¤´éƒ¨å†…å­˜å’Œå­˜å‚¨å­—ç¬¦ä¸²çš„å†…å­˜åœ°å€è¿ç»­ï¼Œå¦å¤–ç»“å°¾éšå«ä¸€ä¸ª'\\0',è€ŒSDSæ˜¯ä»¥lenå­—æ®µæ¥åˆ¤æ–­æ˜¯å¦æ˜¯å¦åˆ°è¾¾å­—ç¬¦ä¸²æœ«å°¾çš„ï¼Œå› æ­¤åœ¨å­—ç¬¦ä¸²ä¸­é—´å¯ä»¥å‡ºç°'\\0'ï¼Œå³SDSå­—ç¬¦ä¸²æ˜¯äºŒè¿›åˆ¶å®‰å…¨çš„ã€‚\n\n### å­—ç¬¦ä¸²å®ç°\nåˆ›å»ºæ–°å­—ç¬¦ä¸²ä½¿ç”¨çš„æ˜¯sds.cä¸­çš„sdsnewlenå‡½æ•°ï¼š\n```c\n// ä½¿ç”¨initæŒ‡é’ˆæŒ‡å‘çš„å†…å®¹å’Œinitlenåˆ›å»ºä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²\nsds sdsnewlen(const void *init, size_t initlen) {\n    void *sh;\n    \n    // bufæ•°ç»„èµ·å§‹åœ°å€\n    sds s;\n    \n    // æ ¹æ®é•¿åº¦é€‰æ‹©åˆé€‚çš„sdså¤´éƒ¨ç±»å‹\n    char type = sdsReqType(initlen);\n\n    // ç”¨type 8åˆ›å»ºç©ºå­—ç¬¦ä¸²æ–¹ä¾¿è¿½åŠ \n    if (type == SDS_TYPE_5 && initlen == 0) type = SDS_TYPE_8;\n    \n    // æ ¹æ®sdså¤´éƒ¨ç±»å‹è·å–å¤´éƒ¨å¤§å°\n    int hdrlen = sdsHdrSize(type);\n    \n    // flagæŒ‡é’ˆ\n    unsigned char *fp;\n\n    // ä¸ºsdsåˆ†é…å†…å­˜ï¼ˆåé¢ä¼šåˆ†æs_mallocï¼‰\n    // å†…å­˜å¤§å°ä¸ºï¼šsdså¤´éƒ¨å¤§å° + å­˜å‚¨å­—ç¬¦ä¸²çš„é•¿åº¦initlen + æœ«å°¾ç©ºå­—ç¬¦å¤§å°1å­—èŠ‚\n    sh = s_malloc(hdrlen+initlen+1); \n\n    if (!init)\n        // å†…å­˜åˆå§‹åŒ–ä¸º0ï¼ˆåé¢ä¼šåˆ†æmemsetï¼‰\n        memset(sh, 0, hdrlen+initlen+1);\n    // å†…å­˜åˆ†é…å¤±è´¥\n    if (sh == NULL) return NULL;\n\n    // bufæ•°ç»„çš„èµ·å§‹åœ°å€\n    s = (char*)sh+hdrlen;\n    \n    // bufæ•°ç»„èµ·å§‹åœ°å€-1ï¼Œå³ä¸ºflagså­—æ®µ\n    fp = ((unsigned char*)s)-1;\n\n    // åˆå§‹åŒ–sdså¤´éƒ¨çš„len,alloc,flagså­—æ®µ\n    switch(type) {\n        case SDS_TYPE_5: {\n            *fp = type | (initlen << SDS_TYPE_BITS);\n            break;\n        }\n        case SDS_TYPE_8: {\n            //æ ¹æ®bufèµ·å§‹åœ°å€è·å–æŒ‡å‘sdså¤´éƒ¨çš„èµ·å§‹åœ°å€çš„æŒ‡é’ˆ\n            SDS_HDR_VAR(8,s);\n\t    // è®¾ç½®lenå­—æ®µå€¼ä¸ºinitlen\n            sh->len = initlen;\n\t    // è®¾ç½®allocå­—æ®µå€¼ä¸ºinitlen\n            sh->alloc = initlen;\n\t    // è®¾ç½®flagså­—æ®µç±»å‹ä¸ºtype\n            *fp = type;\n            break;\n        }\n        case SDS_TYPE_16: {\n            SDS_HDR_VAR(16,s);\n            sh->len = initlen;\n            sh->alloc = initlen;\n            *fp = type;\n            break;\n        }\n        case SDS_TYPE_32: {\n            SDS_HDR_VAR(32,s);\n            sh->len = initlen;\n            sh->alloc = initlen;\n            *fp = type;\n            break;\n        }\n        case SDS_TYPE_64: {\n            SDS_HDR_VAR(64,s);\n            sh->len = initlen;\n            sh->alloc = initlen;\n            *fp = type;\n            break;\n        }\n    }\n    // åˆå§‹åŒ–bufæ•°ç»„\n    if (initlen && init)\n        // æ‹·è´initåˆ°bufæ•°ç»„ï¼ˆåé¢ä¼šåˆ†æmemcpyï¼‰\n        memcpy(s, init, initlen);\n\n    // æ·»åŠ æœ«å°¾ç©ºå­—ç¬¦æ ‡è¯†\n    s[initlen] = '\\0';\n    return s;\n}\n\n/**\n * æ ¹æ®å­—ç¬¦ä¸²é•¿åº¦è·å–åˆé€‚çš„å¤´éƒ¨ç±»å‹\n * @param string_size å­—ç¬¦ä¸²åˆå§‹é•¿åº¦\n * @return\n */\nstatic inline char sdsReqType(size_t string_size) {\n    if (string_size < 1<<5) //32\n        return SDS_TYPE_5;\n    if (string_size < 1<<8) //256\n        return SDS_TYPE_8;\n    if (string_size < 1<<16) //65536\n        return SDS_TYPE_16;\n#if (LONG_MAX == LLONG_MAX) //ç­‰äºæœ‰ç¬¦å·longæœ€å¤§å€¼\n    if (string_size < 1ll<<32) //4gb\n        return SDS_TYPE_32;\n    return SDS_TYPE_64;\n#else\n    return SDS_TYPE_32;\n#endif\n}\n\n/**\n * é€šè¿‡å­—ç¬¦ä¸²å¤´éƒ¨ç±»å‹è·å–å…¶å¤´å¤§å°\n * @param type å­—ç¬¦ä¸²ç±»å‹ 0-4\n * @return\n */\nstatic inline int sdsHdrSize(char type) {\n    // type & SDS_TYPE_MASK = type\n    // ä¾‹å¦‚ï¼šsdshdr8ï¼Œ 1 & 7 = 1\n    switch(type&SDS_TYPE_MASK) {\n        case SDS_TYPE_5:\n            return sizeof(struct sdshdr5);\n        case SDS_TYPE_8:\n            //sizeofè®¡ç®—ç»“æ„ä½“å¤§å°ï¼Œå–æ¶ˆäº†å†…å­˜å¯¹é½\n            return sizeof(struct sdshdr8); // 3å­—èŠ‚\n        case SDS_TYPE_16:\n            return sizeof(struct sdshdr16); // 5å­—èŠ‚\n        case SDS_TYPE_32:\n            return sizeof(struct sdshdr32); // 9å­—èŠ‚\n        case SDS_TYPE_64:\n            return sizeof(struct sdshdr64); // 17å­—èŠ‚\n    }\n    return 0;\n}\n```\nå…³äºå†…å­˜æ“ä½œçš„å‡½æ•°ï¼Œå°†åœ¨å†…å­˜æ“ä½œå°èŠ‚ä»‹ç»ï¼Œè¿™é‡Œå°±ä¸åœ¨è¿›è¡Œä»‹ç»äº†ã€‚\n### æ–¹æ³•å®ç°\n","tags":["redis"]},{"title":"æ•°æ®ç»“æ„ä¸ç®—æ³•-å¤æ‚åº¦åˆ†æ","url":"/blog/2018/10/13/æ•°æ®ç»“æ„ä¸ç®—æ³•-å¤æ‚åº¦åˆ†æ/","content":">æœ¬å°èŠ‚æ€»ç»“æ—¶é—´ã€ç©ºé—´å¤æ‚åº¦åˆ†æ\n* ä»€ä¹ˆæ˜¯å¤æ‚åº¦åˆ†æï¼Ÿ\n* ä¸ºä»€ä¹ˆè¦è¿›è¡Œå¤æ‚åº¦åˆ†æï¼Ÿ\n* å¦‚ä½•è¿›è¡Œæ—¶é—´ã€ç©ºé—´å¤æ‚åº¦åˆ†æï¼Ÿ(å¤§Oè¡¨ç¤ºæ³•)\n\n### ä»€ä¹ˆæ˜¯å¤æ‚åº¦åˆ†æ\n1. æ•°æ®æœºæ„ä¸ç®—æ³•æ˜¯ä¸ºäº†è§£å†³\"å¦‚ä½•è®©è®¡ç®—æœºè¿è¡Œçš„æ›´å¿«åŒæ—¶æ›´çœå­˜å‚¨ç©ºé—´\"çš„é—®é¢˜ï¼Œå› æ­¤ï¼Œæ‰§è¡Œæ•ˆç‡æ˜¯è¯„ä¼°ä¸€ä¸ªç®—æ³•å¥½åçš„é‡è¦æŒ‡æ ‡ã€‚\n2. æˆ‘ä»¬éœ€è¦ä»ç®—æ³•æ‰§è¡Œæ—¶é—´ã€å ç”¨ç©ºé—´ä¸¤ä¸ªçº¬åº¦æ¥è¯„ä¼°æ•°æ®ç»“æ„å’Œç®—æ³•çš„æ€§èƒ½ã€‚é€šå¸¸ä½¿ç”¨æ—¶é—´å¤æ‚åº¦å’Œç©ºé—´å¤æ‚åº¦æ¥æè¿°æ€§èƒ½é—®é¢˜ã€‚\n3. å¤æ‚åº¦åˆ†ææè¿°çš„æ˜¯ç®—æ³•æ‰§è¡Œæ—¶é—´(å ç”¨ç©ºé—´)ä¸æ•°æ®è§„æ¨¡çš„å¢é•¿å…³ç³»ã€‚\n\n### ä¸ºä»€ä¹ˆè¦è¿›è¡Œå¤æ‚åº¦åˆ†æ\nå¹³æ—¶æˆ‘ä»¬ä¼šæŠŠä»£ç è¿è¡Œä¸€éï¼Œç„¶åé€šè¿‡ç»Ÿè®¡ã€ç›‘æ§å°±å¯ä»¥å¾—åˆ°ç®—æ³•æ‰§è¡Œçš„æ—¶é—´å’Œå ç”¨çš„å†…å­˜ï¼Œæ­¤æ–¹æ³•ç§°ä¸ºäº‹åç»Ÿè®¡æ³•ï¼Œå­˜åœ¨å¾ˆå¤§çš„å±€é™æ€§ã€‚\n1. æµ‹è¯•ç»“æœéå¸¸ä¾èµ–æµ‹è¯•ç¯å¢ƒ\n2. æµ‹è¯•ç»“æœå—æ•°æ®è§„æ¨¡çš„å½±å“å¾ˆå¤§ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªä¸ç”¨å…·ä½“çš„æµ‹è¯•æ•°æ®è¿›è¡Œæµ‹è¯•å°±å¯ä»¥ç²—ç•¥çš„è¯„ä¼°ç®—æ³•æ‰§è¡Œæ•ˆç‡çš„æ–¹æ³•ã€‚\n3. æŒæ¡å¤æ‚åº¦åˆ†æï¼Œå°†ä¼šç¼–å†™å‡ºæ€§èƒ½æ›´ä¼˜çš„ä»£ç ï¼Œæœ‰åˆ©äºé™ä½ç³»ç»Ÿå¼€å‘å’Œç»´æŠ¤çš„æˆæœ¬ã€‚\n\n### å¦‚ä½•è¿›è¡Œå¤æ‚åº¦åˆ†æ\n#### å¤§Oè¡¨ç¤ºæ³•çš„ç”±æ¥\næ‰€æœ‰ä»£ç çš„æ‰§è¡Œæ—¶é—´T(n)ä¸æ¯è¡Œä»£ç çš„æ‰§è¡Œæ¬¡æ•°næˆæ­£æ¯”ã€‚ç”¨å¤§Oè¡¨ç¤ºæ³•å°±æ˜¯:\n```\n\tT(n) = O(f(n))\nå…¶ä¸­:\n\tT(n) è¡¨ç¤ºä»£ç æ‰§è¡Œæ—¶é—´ã€‚\n\tf(n) è¡¨ç¤ºæ¯è¡Œä»£ç æ‰§è¡Œçš„æ¬¡æ•°æ€»å’Œã€‚\n\tå¤§0 è¡¨ç¤ºä»£ç æ‰§è¡Œæ—¶é—´ T(n) ä¸ f(n) è¡¨è¾¾å¼æˆæ­£æ¯”ã€‚\n```\nå¤§Oæ—¶é—´å¤æ‚åº¦å®é™…ä¸Šå¹¶ä¸å…·ä½“è¡¨ç¤ºä»£ç çœŸæ­£çš„æ‰§è¡Œæ—¶é—´ï¼Œè€Œæ˜¯è¡¨ç¤ºä»£ç æ‰§è¡Œæ—¶é—´éšæ•°æ®è§„æ¨¡å¢é•¿çš„å˜åŒ–è¶‹åŠ¿ã€‚å› æ­¤ä¹Ÿå«åšæ¸è¿›æ—¶é—´å¤æ‚åº¦ï¼Œç®€ç§°æ—¶é—´å¤æ‚åº¦ã€‚\n\n#### å¤§Oè¡¨ç¤ºæ³•çš„ç‰¹ç‚¹\nä»¥æ—¶é—´å¤æ‚åº¦ä¸ºä¾‹ï¼Œç”±äºæ—¶é—´å¤æ‚åº¦æè¿°çš„æ˜¯ç®—æ³•æ‰§è¡Œæ—¶é—´ä¸æ•°æ®è§„æ¨¡å¢é•¿çš„å˜åŒ–è¶‹åŠ¿ï¼Œæ‰€ä»¥å¸¸é‡é˜¶ã€ä½é˜¶ã€ä»¥åŠç³»æ•°å®é™…ä¸Šå¯¹è¿™ç§å¢é•¿è¶‹åŠ¿ä¸äº§ç”Ÿå†³å®šæ€§å½±å“ï¼Œå› æ­¤åœ¨è¿›è¡Œæ—¶é—´å¤æ‚åº¦åˆ†ææ—¶å¯ä»¥çœç•¥è¿™äº›é¡¹ã€‚\n\n#### æ—¶é—´å¤æ‚åº¦åˆ†ææ³•åˆ™\n1. åªå…³æ³¨å¾ªç¯æ¬¡æ•°æœ€å¤šçš„ä¸€æ®µä»£ç ï¼šæ¯”å¦‚å¾ªç¯æ“ä½œ\n2. åŠ æ³•æ³•åˆ™å–é‡çº§æœ€å¤§ä»£ç å¤æ‚åº¦ï¼šæ¯”å¦‚ä¸€æ®µä»£ç ä¸­æœ‰å•å¾ªç¯å’Œå¤šé‡å¾ªç¯ï¼Œåˆ™å–å¤šé‡å¾ªç¯çš„å¤æ‚åº¦ã€‚\n3. ä¹˜æ³•æ³•åˆ™åµŒå¥—ä»£ç å¤æ‚åº¦å–ä¹˜ç§¯: æ¯”å¦‚é€’å½’ã€å¤šé‡å¾ªç¯ç­‰ï¼Œå–åµŒå¥—å†…å¤–ä»£ç å¤æ‚åº¦çš„ä¹˜ç§¯ã€‚\n4. å¤šä¸ªè§„æ¨¡æ±‚åŠ æ³•ï¼šæ¯”å¦‚æ–¹æ³•æœ‰ä¸¤ä¸ªå‚æ•°åˆ†åˆ«æ§åˆ¶ä¸¤ä¸ªå¾ªç¯çš„æ¬¡æ•°ï¼Œåˆ™å°†ä¸¤è€…çš„å¤æ‚åº¦è¿›è¡Œç›¸åŠ ï¼Œå³ï¼šO(m+n)\n\n#### å¸¸è§çš„æ—¶é—´å¤æ‚åº¦çº§åˆ«\n1. å¤šé¡¹å¼é˜¶\n    éšç€æ•°æ®è§„æ¨¡çš„ä¸æ–­å¢é•¿ï¼Œç®—æ³•çš„æ‰§è¡Œæ—¶é—´å’Œç©ºé—´å ç”¨ï¼ŒæŒ‰ç…§å¤šé¡¹å¼çš„æ¯”ä¾‹å¢é•¿ã€‚ä»ä½é˜¶åˆ°é«˜é˜¶å¸¸è§çš„æœ‰(è¶Šé«˜é˜¶æ•ˆç‡è¶Šä½)ï¼š\n```perl    \n\tO(1): å¸¸æ•°é˜¶\n\n\tO(logn): å¯¹æ•°é˜¶\n\n\tO(n): çº¿æ€§é˜¶\n\n\tO(nlogn): çº¿æ€§å¯¹æ•°é˜¶\n\n\tO(n^2): å¹³æ–¹é˜¶\n\n\tO(n^3): ç«‹æ–¹é˜¶\n```\n2. éå¤šé¡¹å¼é˜¶\n    æˆ‘ä»¬æŠŠæ—¶é—´å¤æ‚åº¦ä¸ºéå¤šé¡¹å¼é‡çº§çš„ç®—æ³•é—®é¢˜å«åšNP(Non-Deterministic Ploynomialéç¡®å®šå¤šé¡¹å¼)é—®é¢˜ï¼Œéšç€æ•°æ®è§„æ¨¡çš„ä¸æ–­å¢é•¿ï¼Œç®—æ³•çš„æ‰§è¡Œæ—¶é—´å’Œç©ºé—´å ç”¨æš´å¢ï¼Œè¿™ç±»ç®—æ³•æ€§èƒ½æå·®ã€‚åŒ…æ‹¬ï¼š\n```perl\n\tO(2^n): æŒ‡æ•°é˜¶\n\n\tO(n!): é˜¶ä¹˜é˜¶\n```\n#### ç©ºé—´å¤æ‚åº¦\nç©ºé—´å¤æ‚åº¦å’Œæ—¶é—´å¤æ‚åº¦ç±»ä¼¼ï¼Œå…¨ç§°ä¸ºï¼šæ¸è¿›ç©ºé—´å¤æ‚åº¦ï¼Œè¡¨ç¤ºç®—æ³•çš„å­˜å‚¨ç©ºé—´å’Œæ•°æ®è§„æ¨¡ä¹‹é—´çš„å¢é•¿å…³ç³»ã€‚\nå¸¸è§çš„ç©ºé—´å¤æ‚åº¦çº§åˆ«æœ‰ï¼šO(1)ã€O(n)ã€O(n^2)ï¼Œè€ŒO(logn)ã€O(nlogn)è¿™æ ·çš„å¯¹æ•°é˜¶å¤æ‚åº¦å¹³æ—¶éƒ½ç”¨ä¸åˆ°ã€‚\n\n\n\n### ä¾‹å­\n#### æ—¶é—´å¤æ‚åº¦åˆ†æ\n##### O(1)\n\n##### O(logn)ã€O(nlogn)\n\n##### O(m+n)ã€O(m*n)\n \n#### ç©ºé—´å¤æ‚åº¦åˆ†æ\n\n\n","tags":["å¤æ‚åº¦åˆ†æ"]},{"title":"Dubboæºç é˜…è¯»ä¹‹ConfiguratoråŠ¨æ€é…ç½®","url":"/blog/2018/09/05/Dubboæºç é˜…è¯»ä¹‹ConfiguratoråŠ¨æ€é…ç½®/","content":">æˆ‘ä»¬å¯ä»¥ç¼–å†™åŠ¨æ€é…ç½®æ¥é…ç½®æœåŠ¡æä¾›è€…ã€‚è¿™ä¸ªæ“ä½œé€šå¸¸åœ¨ç›‘æ§ä¸­å¿ƒå®Œæˆã€‚\n\n### å®˜ç½‘æ–‡æ¡£\næˆ‘ä»¬å…ˆçœ‹ä¸‹å®˜ç½‘ç»™çš„æ–‡æ¡£è¯´æ˜\n```java\nRegistryFactory registryFactory = ExtensionLoader.getExtensionLoader(RegistryFactory.class).getAdaptiveExtension();\n//è·å–æ³¨å†Œä¸­å¿ƒ\nRegistry registry = registryFactory.getRegistry(URL.valueOf(\"zookeeper://10.20.153.10:2181\"));\n//æ³¨å†Œé…ç½®\nregistry.register(URL.valueOf(\"override://0.0.0.0/com.foo.BarService?category=configurators&dynamic=false&application=foo&timeout=1000\"));\n```\nåœ¨è¿™ä¸ªé…ç½®override urlä¸­ï¼š\n* override:// è¡¨ç¤ºæ•°æ®å°†ä¼šè¢«è¦†ç›–ï¼Œå½“å‰dubboæ”¯æŒoverrideå’Œabsentï¼Œå¯ä»¥è‡ªè¡Œæ‰©å±•ï¼Œå¿…å¡«å‚æ•°.\n* 0.0.0.0 è¡¨ç¤ºè¯¥é…ç½®å¯¹æ‰€æœ‰IPåœ°å€éƒ½æœ‰æ•ˆï¼Œå¦‚æœåªæƒ³è¦†ç›–æŒ‡å®šçš„ipæ•°æ®ï¼Œåˆ™å¯ä»¥æ›¿æ¢æŒ‡å®šçš„ipåœ°å€ï¼Œå¿…å¡«å‚æ•°.\n* com.foo.BarService è¡¨ç¤ºå¯¹æŒ‡å®šçš„æœåŠ¡æœ‰æ•ˆï¼Œå¿…å¡«å‚æ•°.\n* category=configurators è¡¨ç¤ºæ•°æ®æ˜¯åŠ¨æ€é…ç½®çš„ï¼Œå¿…å¡«å‚æ•°.\n* dynamic=false è¡¨ç¤ºæ•°æ®æ˜¯æŒä¹…åŒ–çš„ï¼Œå½“æ³¨å†Œæ–¹æ’¤é”€æ—¶ï¼Œæ•°æ®ä»å­˜å‚¨åœ¨æ³¨å†Œè¡¨ä¸­ã€‚\n* enabled=true å¯ç”¨è¦†ç›–ç­–ç•¥ï¼Œå¯ä»¥ä¸ä¼ ï¼Œä¸ä¼ çš„è¯ï¼Œé»˜è®¤å€¼ä¸ºå¯ç”¨\n* application=foo è¡¨ç¤ºå¯¹æŒ‡å®šçš„applicationæœ‰æ•ˆï¼Œå¯ä»¥ä¸ä¼ ï¼Œä¸ä¼ çš„è¯åˆ™å¯¹æ‰€æœ‰åº”ç”¨ç¨‹åºæœ‰æ•ˆã€‚\n* timeout=1000 è¡¨ç¤ºæ»¡è¶³ä¸Šè¿°æ¡ä»¶çš„timeoutå‚æ•°çš„å€¼å°†ä¼šè¢«1000è¦†ç›–ï¼Œå¦‚æœæƒ³è¦è¦†ç›–å…¶ä»–å‚æ•°ï¼Œåˆ™ç›´æ¥æ·»åŠ åˆ°override URLå‚æ•°ä¸Šã€‚\n\n#### ä¾‹å­\n* ç¦ç”¨æœåŠ¡æä¾›è€…(é€šå¸¸ç”¨äºä¸´æ—¶è¸¢æ‰æä¾›è€…æœºå™¨ï¼Œç±»ä¼¼äºç¦æ­¢æ¶ˆè´¹è€…è®¿é—®ï¼Œè¯·ä½¿ç”¨è·¯ç”±è§„åˆ™)\n```java\noverride://10.20.153.10/com.foo.BarService?category=configurators&dynamic=false&disbaled=true\n```\n\n* è°ƒæ•´æƒé‡:(é€šå¸¸ç”¨äºå®¹é‡è¯„ä¼°ï¼Œé»˜è®¤ä¸º100)\n```java\noverride://10.20.153.10/com.foo.BarService?category=configurators&dynamic=false&weight=200\n```\n\n* è°ƒæ•´è´Ÿè½½å‡è¡¡ç­–ç•¥(é»˜è®¤ç­–ç•¥ä¸ºéšæœº)\n```java\noverride://10.20.153.10/com.foo.BarService?category=configurators&dynamic=false&loadbalance=leastactive\n```\n\n* æœåŠ¡é™çº§:(é€šå¸¸ç”¨äºæš‚æ—¶å±è”½éå…³é”®æœåŠ¡çš„é”™è¯¯ï¼‰\n```java\noverride://0.0.0.0/com.foo.BarService?category=configurators&dynamic=false&application=foo&mock=force:return+null\n```\n\nç°åœ¨æˆ‘ä»¬å¼€å§‹çœ‹æºç å®ç°\n### Configuratoræ¥å£\n```java\npublic interface Configurator extends Comparable<Configurator> {\n\n    /**\n     * è·å–é…ç½®url\n     */\n    URL getUrl();\n\n    /**\n     * é…ç½®æœåŠ¡æä¾›è€…url\n     * å‘urlä¸­æ·»åŠ æ–°å±æ€§(absent) æˆ–è€… è¦†ç›–urlä¸­çš„å±æ€§(override).(æ–°å±æ€§æ¥æºäºé…ç½®url)\n     * @param url æ—§çš„æä¾›è€…url\n     * @return  æ–°çš„æä¾›è€…url\n     */\n    URL configure(URL url);\n}\n```\n\n#### AbstractConfiguratoræŠ½è±¡ç±»\nè¯¥æŠ½è±¡ç±»å®ç°äº†Configuratoræ¥å£ã€‚å¹¶å®ç°äº†configureæ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­ï¼Œä¼šåˆ¤æ–­å½“å‰urlæ˜¯å¦æ»¡è¶³è¦†ç›–urlçš„æ¡ä»¶ã€‚å¦‚æœæ»¡è¶³çš„è¯ï¼Œä¼šè°ƒç”¨æŠ½è±¡æ–¹æ³•doConfigureæ‰§è¡Œç›¸åº”çš„é…ç½®ã€‚doConfigureæŠ½è±¡æ–¹æ³•ç”±ä¸¤ä¸ªå­ç±»AbsentConfigurator(absent)å’ŒOverrideConfigurator(override)è¿›è¡Œå®ç°ã€‚\n```java\npublic abstract class AbstractConfigurator implements Configurator {\n\n    /**\n     * é…ç½®url\n     */\n    private final URL configuratorUrl;\n\n    public AbstractConfigurator(URL url) {\n        if (url == null) {\n            throw new IllegalArgumentException(\"configurator url == null\");\n        }\n        this.configuratorUrl = url;\n    }\n\n    @Override\n    public URL getUrl() {\n        return configuratorUrl;\n    }\n\n    /**\n     * @param url æ—§çš„url\n     * @return\n     */\n    @Override\n    public URL configure(URL url) {\n        if (configuratorUrl == null || configuratorUrl.getHost() == null\n                || url == null || url.getHost() == null) {\n            return url;\n        }\n        //å¦‚æœoverride urlå­˜åœ¨ç«¯å£ï¼Œåˆ™æ„å‘³ç€å®ƒæ˜¯æœåŠ¡æä¾›è€…åœ°å€\n        //æˆ‘ä»¬æƒ³è¦è¿™ä¸ªoverride urlæ§åˆ¶ä¸€ä¸ªæŒ‡å®šçš„æœåŠ¡æä¾›è€…\n        //è¯¥è¦†ç›–urlè§„åˆ™å¯èƒ½å¯¹ç‰¹å®šçš„æœåŠ¡æä¾›è€…å®ä¾‹ç”Ÿæ•ˆï¼Œæˆ–è€…å¯¹æŒæœ‰è¿™ä¸ªæœåŠ¡æä¾›è€…å®ä¾‹çš„æ¶ˆè´¹è€…ç”Ÿæ•ˆ\n        if (configuratorUrl.getPort() != 0) {\n            if (url.getPort() == configuratorUrl.getPort()) {\n                //æœåŠ¡æä¾›è€…\n                return configureIfMatch(url.getHost(), url);\n            }\n        } else {\n            //configuratorUrlæ²¡æœ‰ç«¯å£ï¼Œæ„å‘³ç€è¿™ä¸ªurlçš„ipæŒ‡å®šçš„æ˜¯ä¸€ä¸ªæ¶ˆè´¹è€…åœ°å€æˆ–è€…0.0.0.0\n            //å¦‚æœå®ƒæ˜¯ä¸€ä¸ªæ¶ˆè´¹è€…ipåœ°å€ï¼Œç›®çš„æ˜¯æ§åˆ¶ä¸€ä¸ªç‰¹å®šçš„æ¶ˆè´¹è€…å®ä¾‹ï¼Œ\n            //å®ƒå¿…é¡»åœ¨æ¶ˆè´¹è€…ç«¯ç”Ÿæ•ˆï¼Œä»»ä½•æä¾›è€…éƒ½å°†ä¼šå¿½ç•¥è¯¥url\n            //å¦‚æœipæ˜¯0.0.0.0ï¼Œåˆ™è¯¥é…ç½®urlå¯¹æ¶ˆè´¹è€…ã€ç”Ÿäº§è€…éƒ½ç”Ÿæ•ˆ\n            if (url.getParameter(Constants.SIDE_KEY, Constants.PROVIDER).equals(Constants.CONSUMER)) {\n                //æ¶ˆè´¹è€…\n                //NetUtils.getLocalHost is the ip address consumer registered to registry.\n                //NetUtils.getLocalHostæ˜¯ä¸€ä¸ªæ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒçš„æ¶ˆè´¹è€…ipåœ°å€\n                return configureIfMatch(NetUtils.getLocalHost(), url);\n            } else if (url.getParameter(Constants.SIDE_KEY, Constants.CONSUMER).equals(Constants.PROVIDER)) {\n                //ç”Ÿäº§è€…\n                // take effect on all providers, so address must be 0.0.0.0,\n                // otherwise it won't flow to this if branch\n                //å¯¹æ‰€æœ‰ç”Ÿäº§è€…ç”Ÿæ•ˆï¼Œå› æ­¤åœ°å€å¿…é¡»æ˜¯0.0.0.0ï¼Œå¦åˆ™ï¼Œå®ƒå°†ä¸ä¼šè¿›å…¥è¿™ä¸ªåˆ†æ”¯\n                return configureIfMatch(Constants.ANYHOST_VALUE, url);\n            }\n        }\n        return url;\n    }\n\n    /**\n     * @param host å—å½±å“çš„ä¸»æœºåœ°å€\n     * @param url\n     * @return\n     */\n    private URL configureIfMatch(String host, URL url) {\n        if (Constants.ANYHOST_VALUE.equals(configuratorUrl.getHost())\n                || host.equals(configuratorUrl.getHost())) {\n            //é…ç½®urlçš„hostç­‰äº0.0.0.0ï¼Œæˆ–è€…ç­‰äºhost\n            \n            //è·å–é…ç½®urlçš„applicationå‚æ•°å€¼ï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™è·å–usernameå±æ€§\n            String configApplication = configuratorUrl.getParameter(Constants.APPLICATION_KEY,configuratorUrl.getUsername());\n            //è·å–å½“å‰urlçš„applicationå‚æ•°å€¼ï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™è·å–usernameå±æ€§\n            String currentApplication = url.getParameter(Constants.APPLICATION_KEY, url.getUsername());\n\n            if (configApplication == null || Constants.ANY_VALUE.equals(configApplication)\n                    || configApplication.equals(currentApplication)) {\n                //é…ç½®urlçš„configApplication = (null || * || currentApplication)\n                Set<String> condtionKeys = new HashSet<String>();\n                \n\t\t//æ·»åŠ categoryã€checkã€dynamicã€enabledå‚æ•°\n                condtionKeys.add(Constants.CATEGORY_KEY);\n                condtionKeys.add(Constants.CHECK_KEY);\n                condtionKeys.add(Constants.DYNAMIC_KEY);\n                condtionKeys.add(Constants.ENABLED_KEY);\n                \n\t\t//éå†é…ç½®urlçš„å‚æ•°åˆ—è¡¨\n                for (Map.Entry<String, String> entry : configuratorUrl.getParameters().entrySet()) {\n                    //å‚æ•°key\n                    String key = entry.getKey();\n                    //å‚æ•°value\n                    String value = entry.getValue();\n                    \n\t\t    if (key.startsWith(\"~\") || Constants.APPLICATION_KEY.equals(key) || Constants.SIDE_KEY.equals(key)) {\n\t\t\t//å‚æ•°key = (application || side || ^~ )\n                        \n\t\t\t//æ·»åŠ è¯¥keyå‚æ•°\n                        condtionKeys.add(key);\n                        \n\t\t\tif (value != null && !Constants.ANY_VALUE.equals(value)\n                                && !value.equals(url.getParameter(key.startsWith(\"~\") ? key.substring(1) : key))) {\n                            //å¦‚æœ å½“å‰urlçš„keyå‚æ•°çš„å€¼ != * å¹¶ä¸” ä¸ç­‰äº é…ç½®urlçš„keyå‚æ•°çš„å€¼ï¼Œåˆ™ç›´æ¥è¿”å›å½“å‰url\n                            return url;\n                        }\n                    }\n                }\n                //ä»é…ç½®urlä¸­ç§»é™¤condtionKeyså‚æ•°ï¼Œç„¶åæ‰§è¡Œé…ç½®\n                return doConfigure(url, configuratorUrl.removeParameters(condtionKeys));\n            }\n        }\n        return url;\n    }\n\n    /**\n     * 1ã€å…·æœ‰ç‰¹å®šä¸»æœºIPçš„URLæ¯”0.0.0.0çš„ä¼˜å…ˆçº§é«˜\n     * 2ã€å¦‚æœä¸¤ä¸ªurlæœ‰ç›¸åŒçš„hostï¼Œæ¯”è¾ƒpriorityå­—æ®µçš„å€¼\n     */\n    @Override\n    public int compareTo(Configurator o) {\n        if (o == null) {\n            return -1;\n        }\n\n        int ipCompare = getUrl().getHost().compareTo(o.getUrl().getHost());\n        if (ipCompare == 0) {\n            int i = getUrl().getParameter(Constants.PRIORITY_KEY, 0),\n                    j = o.getUrl().getParameter(Constants.PRIORITY_KEY, 0);\n            if (i < j) {\n                return -1;\n            } else if (i > j) {\n                return 1;\n            } else {\n                return 0;\n            }\n        } else {\n            return ipCompare;\n        }\n    }\n    \n    //æŠ½è±¡æ–¹æ³•ï¼Œæ‰§è¡Œç›¸åº”é…ç½®ç­–ç•¥\n    protected abstract URL doConfigure(URL currentUrl, URL configUrl);\n\n}\n```\n#### AbsentConfiguratorå®ç°ç±»\n```java\npublic class AbsentConfigurator extends AbstractConfigurator {\n\n    public AbsentConfigurator(URL url) {\n        super(url);\n    }\n    \n    /**\n     * @currentUrl æœåŠ¡æä¾›è€…url\n     * @configUrl  é…ç½®url\n     */\n    @Override\n    public URL doConfigure(URL currentUrl, URL configUrl) {\n        //å°†é…ç½®urlä¸­çš„å‚æ•°æ·»åŠ åˆ°æœåŠ¡æä¾›è€…urlå‚æ•°ä¸­(åªä¼šæ·»åŠ ä¸å­˜åœ¨çš„ï¼Œä¸ä¼šè¦†ç›–å·²å­˜åœ¨çš„å‚æ•°)\n        return currentUrl.addParametersIfAbsent(configUrl.getParameters());\n    }\n}\n\n/**\n * åªæœ‰åŸæœåŠ¡æä¾›è€…urlä¸­ä¸åŒ…å«è¯¥å‚æ•°æ—¶ï¼Œæ‰ä¼šæ·»åŠ ï¼Œä¸ä¼šè¦†ç›–\n */\npublic URL addParametersIfAbsent(Map<String, String> parameters) {\n        if (parameters == null || parameters.size() == 0) {\n            return this;\n        }\n        //A-1,B-2,C-2 è¦†ç›–url\n        //A-2,B-2     åŸæœåŠ¡æä¾›è€…urlå‚æ•°\n        //A-2,B-2,C-2 æ–°çš„æœåŠ¡æä¾›è€…urlå‚æ•°\n        Map<String, String> map = new HashMap<String, String>(parameters);\n        map.putAll(getParameters());\n        return new URL(protocol, username, password, host, port, path, map);\n}\n```\n\n#### OverrideConfiguratorå®ç°ç±»\n```java\npublic class OverrideConfigurator extends AbstractConfigurator {\n\n    public OverrideConfigurator(URL url) {\n        super(url);\n    }\n \n    /**\n     * @currentUrl æœåŠ¡æä¾›è€…url\n     * @configUrl  é…ç½®url\n     */\n    @Override\n    public URL doConfigure(URL currentUrl, URL configUrl) {\n        //å°†é…ç½®urlä¸­çš„å‚æ•°æ·»åŠ åˆ°æœåŠ¡æä¾›è€…urlå‚æ•°ä¸­\n        return currentUrl.addParameters(configUrl.getParameters());\n    }\n}\n\n/**\n * å°†é…ç½®urlä¸­çš„å‚æ•°æ·»åŠ åˆ°æœåŠ¡æä¾›è€…urlå‚æ•°ä¸­(ä¼šè¦†ç›–)\n */\npublic URL addParameters(Map<String, String> parameters) {\n\tif (parameters == null || parameters.size() == 0) {\n\t    return this;\n\t}\n\t//å‚æ•°å€¼æ²¡æœ‰å‘ç”Ÿå˜åŒ–\n\tboolean hasAndEqual = true;\n\tfor (Map.Entry<String, String> entry : parameters.entrySet()) {\n\t    //è·å–å½“å‰æœåŠ¡æä¾›è€…urlçš„å‚æ•°å€¼\n\t    String value = getParameters().get(entry.getKey());\n\t    if (value == null) {\n\t\t//å½“å‰æœåŠ¡æä¾›è€…urlä¸­çš„å‚æ•°å€¼ä¸ºç©ºï¼Œå¹¶ä¸”è¦†ç›–urlä¸­çš„å‚æ•°å€¼ä¸ä¸ºç©º\n\t\tif (entry.getValue() != null) {\n\t\t    hasAndEqual = false;\n\t\t    break;\n\t\t}\n\t    } else {\n\t\t//å½“å‰æœåŠ¡æä¾›è€…urlä¸­çš„å‚æ•°å€¼ä¸ä¸ºç©ºï¼Œå¹¶ä¸”å’Œè¦†ç›–urlä¸­çš„å‚æ•°å€¼ä¸ç›¸ç­‰\n\t\tif (!value.equals(entry.getValue())) {\n\t\t    hasAndEqual = false;\n\t\t    break;\n\t\t}\n\t    }\n\t}\n\tif (hasAndEqual) {\n\t    //æ²¡æœ‰å‘ç”Ÿå˜åŒ–ã€‚ç«‹å³è¿”å›\n\t    return this;\n\t}\n\tMap<String, String> map = new HashMap<String, String>(getParameters());\n\t//ä½¿ç”¨é…ç½®urlä¸­çš„å‚æ•°å€¼è¦†ç›–å½“å‰æœåŠ¡æä¾›è€…urlä¸­çš„å‚æ•°å€¼\n\tmap.putAll(parameters);\n\treturn new URL(protocol, username, password, host, port, path, map);\n}\n```\n\n#### é…ç½®å·¥å‚ç±»\nå·¥å‚ç±»ç”¨æ¥åˆ›å»ºç›¸åº”çš„é…ç½®ç­–ç•¥å®ç°ç±»\n```java\npublic class AbsentConfiguratorFactory implements ConfiguratorFactory {\n    @Override\n    public Configurator getConfigurator(URL url) {\n        return new AbsentConfigurator(url);\n    }\n}\n\npublic class OverrideConfiguratorFactory implements ConfiguratorFactory {\n    @Override\n    public Configurator getConfigurator(URL url) {\n        return new OverrideConfigurator(url);\n    }\n}\n```\né…ç½®æ‰©å±•\n```java\noverride=com.alibaba.dubbo.rpc.cluster.configurator.override.OverrideConfiguratorFactory\nabsent=com.alibaba.dubbo.rpc.cluster.configurator.absent.AbsentConfiguratorFactory\n```\n\nè‡ªå®šä¹‰çš„é…ç½®ç­–ç•¥å®ç°ï¼Œå¯ä»¥è‡ªè¡Œå‚ç…§AbsentConfiguratorç±»è¿›è¡Œå®ç°ï¼Œæœ¬å°èŠ‚å°±å…ˆä»‹ç»åˆ°è¿™é‡Œäº†ã€‚","tags":["dubbo"]},{"title":"Netty4.1æºç é˜…è¯»ä¹‹commonåŒ…-001","url":"/blog/2018/09/04/Netty4-1æºç é˜…è¯»ä¹‹commonåŒ…-001/","tags":["netty"]},{"title":"Dubboæºç é˜…è¯»ä¹‹Router","url":"/blog/2018/08/30/Dubboæºç é˜…è¯»ä¹‹Router/","content":">Routerè´Ÿè´£ä»å¤šä¸ªInvokerä¸­æŒ‰è·¯ç”±è§„åˆ™é€‰å‡ºå­é›†,æ¯”å¦‚è¯»å†™åˆ†ç¦»,åº”ç”¨éš”ç¦»,ç™½åå•ç­‰\nè·¯ç”±è§„åˆ™ç¡®å®šä¸€ä¸ªæœåŠ¡è°ƒç”¨çš„ç›®æ ‡æœåŠ¡å™¨.å®ƒæœ‰ä¸¤ç§è·¯ç”±è§„åˆ™ï¼šæ¡ä»¶è·¯ç”±è§„åˆ™å’Œè„šæœ¬è·¯ç”±è§„åˆ™ã€‚åŒæ—¶ä¹Ÿæ”¯æŒæ‰©å±•ã€‚\n![](img/read-write.png)\n![](img/rule.png)\n\nRouterç›¸å…³ç±»å›¾å¦‚ä¸‹ï¼š\n![](img/router.jpg)\n\nåœ¨AbstractDirectoryæŠ½è±¡ç±»çš„listæ–¹æ³•ï¼Œä»¥åŠRegistryDirectoryç±»çš„routeæ–¹æ³•ä¸­å°†ä¼šè°ƒç”¨Routerç±»çš„routeæ–¹æ³•ç­›é€‰invokeråˆ—è¡¨ã€‚\n```java\n//AbstractDirectoryæŠ½è±¡ç±»çš„listæ–¹æ³•\n@Override\npublic List<Invoker<T>> list(Invocation invocation) throws RpcException {\n\tif (destroyed) {\n\t    throw new RpcException(\"Directory already destroyed .url: \" + getUrl());\n\t}\n\t//æ ¹æ®invocationè·å–invokersåˆ—è¡¨(æ ¹æ®æ–¹æ³•åæŸ¥è¯¢ç¼“å­˜methodInvokerMap)\n\tList<Invoker<T>> invokers = doList(invocation);\n\tList<Router> localRouters = this.routers;\n\tif (localRouters != null && !localRouters.isEmpty()) {\n\t    //éå†è·¯ç”±\n\t    for (Router router : localRouters) {\n\t\ttry {\n\t\t    if (router.getUrl() == null || router.getUrl().getParameter(Constants.RUNTIME_KEY, false)) {\n\t\t\t//å¦‚æœurlçš„runtimeé…ç½®ä¸ºtrue,åˆ™æ¯æ¬¡éƒ½ä¼šè¿›è¡Œroute\n\t\t\t//æ‰§è¡Œè·¯ç”±ï¼Œè¿›è¡Œè¿‡æ»¤\n\t\t\tinvokers = router.route(invokers, getConsumerUrl(), invocation);\n\t\t    }\n\t\t} catch (Throwable t) {\n\t\t    logger.error(\"Failed to execute router: \" + getUrl() + \", cause: \" + t.getMessage(), t);\n\t\t}\n\t    }\n\t}\n\treturn invokers;\n}\n\n//RegistryDirectoryç±»çš„routeæ–¹æ³•ä¸­\nprivate List<Invoker<T>> route(List<Invoker<T>> invokers, String method) {\n\t//åˆ›å»ºInvocationå¯¹è±¡\n\tInvocation invocation = new RpcInvocation(method, new Class<?>[0], new Object[0]);\n\t//è·å–è·¯ç”±åˆ—è¡¨\n\tList<Router> routers = getRouters();\n\tif (routers != null) {\n\t    for (Router router : routers) {\n\t\tif (router.getUrl() != null) {\n\t\t    //æ‰§è¡Œè·¯ç”±\n\t\t    invokers = router.route(invokers, getConsumerUrl(), invocation);\n\t\t}\n\t    }\n\t}\n\treturn invokers;\n}\n```\n\n### Routeræ¥å£\n```java\npublic interface Router extends Comparable<Router> {\n\n    /**\n     * è·å–è·¯ç”±url\n     * @return url\n     */\n    URL getUrl();\n\n    /**\n     * æ‰§è¡Œè·¯ç”±\n     * @param invokers\n     * @param url  refer url\n     * @param invocation\n     * @return routed invokers\n     */\n    <T> List<Invoker<T>> route(List<Invoker<T>> invokers, URL url, Invocation invocation) throws RpcException;\n}\n```\n#### ConditionRouterå®ç°ç±»\nConditionRouterï¼šåŸºäºæ¡ä»¶è¡¨è¾¾å¼çš„è·¯ç”±è§„åˆ™ï¼Œå®ƒçš„æ¡ä»¶è§„åˆ™å¦‚ä¸‹ï¼š\n* => ä¹‹å‰çš„ä¸ºæ¶ˆè´¹è€…åŒ¹é…æ¡ä»¶ï¼Œæ‰€æœ‰å‚æ•°å’Œæ¶ˆè´¹è€…çš„ URL è¿›è¡Œå¯¹æ¯”ï¼Œå½“æ¶ˆè´¹è€…æ»¡è¶³åŒ¹é…æ¡ä»¶æ—¶ï¼Œå¯¹è¯¥æ¶ˆè´¹è€…æ‰§è¡Œåé¢çš„è¿‡æ»¤è§„åˆ™ã€‚\n* => ä¹‹åä¸ºæä¾›è€…åœ°å€åˆ—è¡¨çš„è¿‡æ»¤æ¡ä»¶ï¼Œæ‰€æœ‰å‚æ•°å’Œæä¾›è€…çš„ URL è¿›è¡Œå¯¹æ¯”ï¼Œæ¶ˆè´¹è€…æœ€ç»ˆåªæ‹¿åˆ°è¿‡æ»¤åçš„åœ°å€åˆ—è¡¨ã€‚\n* å¦‚æœåŒ¹é…æ¡ä»¶ä¸ºç©ºï¼Œè¡¨ç¤ºå¯¹æ‰€æœ‰æ¶ˆè´¹æ–¹åº”ç”¨ï¼Œå¦‚ï¼š=> host != 10.20.153.11\n* å¦‚æœè¿‡æ»¤æ¡ä»¶ä¸ºç©ºï¼Œè¡¨ç¤ºç¦æ­¢è®¿é—®ï¼Œå¦‚ï¼šhost = 10.20.153.10 =>\n```java\npublic class ConditionRouter implements Router, Comparable<Router> {\n\n    private static final Logger logger = LoggerFactory.getLogger(ConditionRouter.class);\n\n    /**\n     * è·¯ç”±æ­£åˆ™\n     */\n    private static Pattern ROUTE_PATTERN = Pattern.compile(\"([&!=,]*)\\\\s*([^&!=,\\\\s]+)\");\n    /**\n     * è·¯ç”±url\n     */\n    private final URL url;\n    /**\n     * ä¼˜å…ˆçº§ ä¼˜å…ˆçº§è¶Šå¤§æ’å¾—è¶Šé å‰ï¼Œé»˜è®¤ä¸º0\n     */\n    private final int priority;\n    /**\n     * æ˜¯å¦å¼ºåˆ¶æ‰§è¡Œè·¯ç”±\n     */\n    private final boolean force;\n    /**\n     * <method,[list*,get*]>\n     */\n    private final Map<String, MatchPair> whenCondition;\n    /**\n     * <host,[192.168.99.60]>\n     */\n    private final Map<String, MatchPair> thenCondition;\n\n    public ConditionRouter(URL url) {\n        this.url = url;\n        //ä»urlä¸­è·å–priorityå‚æ•°\n        this.priority = url.getParameter(Constants.PRIORITY_KEY, 0);\n        //ä»urlä¸­è·å–forceå‚æ•°\n        this.force = url.getParameter(Constants.FORCE_KEY, false);\n        try {\n            //ä»urlä¸­è·å–ruleå‚æ•°ï¼Œå¹¶è§£ç \n            String rule = url.getParameterAndDecoded(Constants.RULE_KEY);\n            if (rule == null || rule.trim().length() == 0) {\n                //æ— æ•ˆçš„è·¯ç”±è§„åˆ™\n                throw new IllegalArgumentException(\"Illegal route rule!\");\n            }\n            //ä»è·¯ç”±è§„åˆ™ä¸­ç§»é™¤consumer.å’Œprovider.\n            rule = rule.replace(\"consumer.\", \"\").replace(\"provider.\", \"\");\n            //æŸ¥çœ‹è·¯ç”±è§„åˆ™ä¸­æ˜¯å¦å­˜åœ¨\"=>\"ç¬¦å·ï¼Œå¹¶è·å–å‡ºç°çš„ä½ç½®i\n            int i = rule.indexOf(\"=>\");\n            //å¦‚æœè·¯ç”±è§„åˆ™ä¸­ä¸å­˜åœ¨=>ç¬¦å·ï¼Œåˆ™whenä¸ºnull,å¦åˆ™=>ç¬¦å·çš„å·¦ä¾§éƒ¨åˆ†ä¸ºwhen\n            String whenRule = i < 0 ? null : rule.substring(0, i).trim();\n            //å¦‚æœè·¯ç”±è§„åˆ™ä¸­ä¸å­˜åœ¨=>ç¬¦å·ï¼Œåˆ™æ•´ä¸ªè·¯ç”±è§„åˆ™éƒ½æ˜¯thenï¼Œå¦åˆ™=>ç¬¦å·å³ä¾§éƒ¨åˆ†ä¸ºthen\n            String thenRule = i < 0 ? rule.trim() : rule.substring(i + 2).trim();\n            //è§£æè§„åˆ™\n            Map<String, MatchPair> when = StringUtils.isBlank(whenRule) || \"true\".equals(whenRule) ? new HashMap<String, MatchPair>() : parseRule(whenRule);\n            Map<String, MatchPair> then = StringUtils.isBlank(thenRule) || \"false\".equals(thenRule) ? null : parseRule(thenRule);\n            // NOTE: It should be determined on the business level whether the `When condition` can be empty or not.\n            //æç¤ºï¼šåº”è¯¥åœ¨ä¸šåŠ¡å±‚é¢æå®š`When condition` æ˜¯å¦å¯ä»¥ä¸ºempty æˆ–è€…not empty\n            this.whenCondition = when;\n            this.thenCondition = then;\n        } catch (ParseException e) {\n            throw new IllegalStateException(e.getMessage(), e);\n        }\n    }\n\n    /**\n     * è§£æè§„åˆ™\n     * @param rule\n     * @return\n     * @throws ParseException\n     */\n    private static Map<String, MatchPair> parseRule(String rule) throws ParseException {\n        Map<String, MatchPair> condition = new HashMap<String, MatchPair>();\n        if (StringUtils.isBlank(rule)) {\n            //è·¯ç”±è§„åˆ™ä¸ºç©ºï¼Œåˆ™ç›´æ¥è¿”å›\n            return condition;\n        }\n        //kvå¯¹ï¼Œå­˜å‚¨åŒ¹é…å’Œä¸åŒ¹é…çš„æ¡ä»¶\n        MatchPair pair = null;\n        // å¤šä¸ªå€¼ \n        Set<String> values = null;\n        //ä½¿ç”¨æ­£åˆ™è¿›è¡ŒåŒ¹é… method = find*,list*,get*,is*\n        final Matcher matcher = ROUTE_PATTERN.matcher(rule);\n        //å°è¯•é€ä¸€åŒ¹é…\n        while (matcher.find()) {\n            String separator = matcher.group(1);\n            String content = matcher.group(2);\n            //æ¡ä»¶è¡¨è¾¾å¼çš„å¼€å§‹éƒ¨åˆ†\n            if (separator == null || separator.length() == 0) {\n                pair = new MatchPair();\n                condition.put(content, pair);\n            }\n            //æ¡ä»¶è¡¨è¾¾å¼çš„KVéƒ¨åˆ†\n            else if (\"&\".equals(separator)) {\n                if (condition.get(content) == null) {\n                    pair = new MatchPair();\n                    condition.put(content, pair);\n                } else {\n                    pair = condition.get(content);\n                }\n            }\n            //KVéƒ¨åˆ†çš„å€¼\n            else if (\"=\".equals(separator)) {\n                if (pair == null) {\n                    throw new ParseException(\"Illegal route rule \\\"\"\n                            + rule + \"\\\", The error char '\" + separator\n                            + \"' at index \" + matcher.start() + \" before \\\"\"\n                            + content + \"\\\".\", matcher.start());\n                }\n                values = pair.matches;\n                values.add(content);\n            }\n            else if (\"!=\".equals(separator)) {\n                if (pair == null) {\n                    throw new ParseException(\"Illegal route rule \\\"\"\n                            + rule + \"\\\", The error char '\" + separator\n                            + \"' at index \" + matcher.start() + \" before \\\"\"\n                            + content + \"\\\".\", matcher.start());\n                }\n                values = pair.mismatches;\n                values.add(content);\n            }\n            // kvçš„valueéƒ¨åˆ†ï¼Œå…¶ä¸­valueæœ‰å¤šä¸ªå€¼ï¼Œä½¿ç”¨é€—å·åˆ†éš”\n            else if (\",\".equals(separator)) { // Should be seperateed by ','\n                if (values == null || values.isEmpty()) {\n                    throw new ParseException(\"Illegal route rule \\\"\"\n                            + rule + \"\\\", The error char '\" + separator\n                            + \"' at index \" + matcher.start() + \" before \\\"\"\n                            + content + \"\\\".\", matcher.start());\n                }\n                values.add(content);\n            } else {\n                throw new ParseException(\"Illegal route rule \\\"\" + rule\n                        + \"\\\", The error char '\" + separator + \"' at index \"\n                        + matcher.start() + \" before \\\"\" + content + \"\\\".\", matcher.start());\n            }\n        }\n        return condition;\n    }\n\n    @Override\n    public <T> List<Invoker<T>> route(List<Invoker<T>> invokers, URL url, Invocation invocation)\n            throws RpcException {\n        if (invokers == null || invokers.isEmpty()) {\n            return invokers;\n        }\n        try {\n            if (!matchWhen(url, invocation)) {\n\t        //ä¸åŒ¹é…whenè§„åˆ™ï¼Œç›´æ¥è¿”å›\n                return invokers;\n            }\n            List<Invoker<T>> result = new ArrayList<Invoker<T>>();\n            if (thenCondition == null) {\n\t        //å½“å‰æ¶ˆè´¹è€…åœ¨æœåŠ¡é»‘åå•é‡Œ\n                logger.warn(\"The current consumer in the service blacklist. consumer: \" + NetUtils.getLocalHost() + \", service: \" + url.getServiceKey());\n                return result;\n            }\n            for (Invoker<T> invoker : invokers) {\n                if (matchThen(invoker.getUrl(), url)) {\n\t\t    //æˆåŠŸåŒ¹é…thenè§„åˆ™ï¼Œæ·»åŠ åˆ°ç»“æœé›†\n                    result.add(invoker);\n                }\n            }\n            if (!result.isEmpty()) {\n                return result;\n            } else if (force) { \n\t        //å¼ºåˆ¶æ‰§è¡Œ \n                logger.warn(\"The route result is empty and force execute. consumer: \" + NetUtils.getLocalHost() + \", service: \" + url.getServiceKey() + \", router: \" + url.getParameterAndDecoded(Constants.RULE_KEY));\n                return result;\n            }\n        } catch (Throwable t) {\n            logger.error(\"Failed to execute condition router rule: \" + getUrl() + \", invokers: \" + invokers + \", cause: \" + t.getMessage(), t);\n        }\n\t//æ²¡æœ‰ä¸€ä¸ªç¬¦åˆè§„åˆ™çš„Provider,åˆ™ç›´æ¥è¿”å›ã€‚5\n        return invokers;\n    }\n\n    @Override\n    public URL getUrl() {\n        return url;\n    }\n\t\n    //æ˜¯å¦åŒ¹é…whenè§„åˆ™\n    boolean matchWhen(URL url, Invocation invocation) {\n        return whenCondition == null || whenCondition.isEmpty() || matchCondition(whenCondition, url, null, invocation);\n    }\n    \n    //urlå‚æ•°ä¸ºinvokerçš„urlå±æ€§\n    private boolean matchThen(URL url, URL param) {\n        //thenè§„åˆ™ä¸ä¸ºç©ºï¼Œä¸”åŒ¹é…thenè§„åˆ™ï¼Œåˆ™è¿”å›true\n        return !(thenCondition == null || thenCondition.isEmpty()) && matchCondition(thenCondition, url, param, null);\n    }\n\n    /**\n     * åŒ¹é…æ¡ä»¶\n     * @param condition\n     * @param url\n     * @param param\n     * @param invocation\n     * @return\n     */\n    private boolean matchCondition(Map<String, MatchPair> condition, URL url, URL param, Invocation invocation) {\n        //è·å–urlå‚æ•°ï¼Œå³æ¶ˆè´¹è€…çš„parametersçš„Mapé›†åˆ\n\tMap<String, String> sample = url.toMap();\n        boolean result = false;\n        for (Map.Entry<String, MatchPair> matchPair : condition.entrySet()) {\n            //ä¾‹å¦‚ï¼šmethodï¼Œæˆ–è€…urlä¸­çš„æŸä¸ªå‚æ•°\n\t    String key = matchPair.getKey();\n            String sampleValue;\n            if (invocation != null && (Constants.METHOD_KEY.equals(key) || Constants.METHODS_KEY.equals(key))) {\n                //key=methodï¼Œåˆ™ä»invocationä¸­è·å–çœŸå®æ–¹æ³•å\n\t\tsampleValue = invocation.getMethodName();\n            } else {\n\t        //ä»urlå‚æ•°ä¸­è·å–keyå¯¹åº”çš„å€¼\n                sampleValue = sample.get(key);\n                if (sampleValue == null) {\n\t\t    //æ·»åŠ å‰ç¼€default.è¿›è¡Œè·å–\n                    sampleValue = sample.get(Constants.DEFAULT_KEY_PREFIX + key);\n                }\n            }\n            if (sampleValue != null) {\n\t        //è°ƒç”¨MatchPairçš„isMatchæ–¹æ³•è¿›è¡ŒåŒ¹é…\n                if (!matchPair.getValue().isMatch(sampleValue, param)) {\n                    return false;\n                } else {\n                    result = true;\n                }\n            } else {\n                if (!matchPair.getValue().matches.isEmpty()) {\n                    return false;\n                } else {\n                    result = true;\n                }\n            }\n        }\n        return result;\n    }\n\n    /**\n     * å†…éƒ¨ç±»\n     */\n    private static final class MatchPair {\n        final Set<String> matches = new HashSet<String>();\n        final Set<String> mismatches = new HashSet<String>();\n    \n        //valueä¸ºè°ƒç”¨çš„æ–¹æ³•åï¼Œæˆ–è€…ä¸ºurlè‡ªå®šä¹‰å‚æ•°çš„å€¼\n\t//paramå‚æ•°ä¸ºrouteæ–¹æ³•çš„urlå‚æ•°ï¼Œå³ref url\n        private boolean isMatch(String value, URL param) {\n            if (!matches.isEmpty() && mismatches.isEmpty()) {\n                //å­˜åœ¨=ï¼Œä¸å­˜åœ¨!=\n                for (String match : matches) {\n                    //è¿›è¡ŒåŒ¹é…\n                    if (UrlUtils.isMatchGlobPattern(match, value, param)) {\n                        return true;\n                    }\n                }\n                return false;\n            }\n            if (!mismatches.isEmpty() && matches.isEmpty()) {\n                //å­˜åœ¨!=,ä¸å­˜åœ¨=\n                for (String mismatch : mismatches) {\n                    if (UrlUtils.isMatchGlobPattern(mismatch, value, param)) {\n                        return false;\n                    }\n                }\n                return true;\n            }\n            if (!matches.isEmpty() && !mismatches.isEmpty()) {\n                //å­˜åœ¨=ï¼Œä¹Ÿå­˜åœ¨!=,ä¼˜å…ˆä½¿ç”¨!=\n                for (String mismatch : mismatches) {\n                    if (UrlUtils.isMatchGlobPattern(mismatch, value, param)) {\n                        return false;\n                    }\n                }\n                for (String match : matches) {\n                    if (UrlUtils.isMatchGlobPattern(match, value, param)) {\n                        return true;\n                    }\n                }\n                return false;\n            }\n            return false;\n        }\n    }\n}\n\n//paramå‚æ•°ä¸ºrouteæ–¹æ³•çš„urlå‚æ•°\npublic static boolean isMatchGlobPattern(String pattern, String value, URL param) {\n\tif (param != null && pattern.startsWith(\"$\")) {\n\t    pattern = param.getRawParameter(pattern.substring(1));\n\t}\n\treturn isMatchGlobPattern(pattern, value);\n}\n\npublic static boolean isMatchGlobPattern(String pattern, String value) {\n\tif (\"*\".equals(pattern)) {\n\t    return true;\n\t}\n\tif ((pattern == null || pattern.length() == 0) && (value == null || value.length() == 0)) {\n\t    return true;\n\t}\n\tif ((pattern == null || pattern.length() == 0) || (value == null || value.length() == 0)) {\n\t    return false;\n\t}\n        //è·å–*å·æœ€åå‡ºç°çš„ä½ç½®\n\tint i = pattern.lastIndexOf('*');\n\t// æ²¡æœ‰ \"*\"\n\tif (i == -1) {\n\t    return value.equals(pattern);\n\t}\n\t// \"*\" ä¸ºæœ€å\n\telse if (i == pattern.length() - 1) {\n\t    return value.startsWith(pattern.substring(0, i));\n\t}\n\t// \"*\" åœ¨å¼€å§‹å¤„\n\telse if (i == 0) {\n\t    return value.endsWith(pattern.substring(i + 1));\n\t}\n\t// \"*\" åœ¨ä¸­é—´\n\telse {\n\t    String prefix = pattern.substring(0, i);\n\t    String suffix = pattern.substring(i + 1);\n\t    return value.startsWith(prefix) && value.endsWith(suffix);\n\t}\n}\n```\n\n##### è°ƒè¯•parseRuleæ–¹æ³•\næˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªä¾‹å­æ¥debugä¸‹parseRuleæ–¹æ³•\n```java\npublic static void main(String[] args) throws ParseException {\n        //æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªè§„åˆ™ï¼šmethod = find*,list*,get*,is* => host = 192.168.99.60,192.168.99.61\n\tString rule = \"method = find*,list*,get*,is* => host = 192.168.99.60,192.168.99.61\";\n\t\n\trule = rule.replace(\"consumer.\", \"\").replace(\"provider.\", \"\");\n\t\n\t//æŸ¥çœ‹è·¯ç”±è§„åˆ™ä¸­æ˜¯å¦å­˜åœ¨\"=>\"ç¬¦å·ï¼Œå¹¶è·å–å‡ºç°çš„ä½ç½®i\n\tint i = rule.indexOf(\"=>\");\n\tString whenRule = i < 0 ? null : rule.substring(0, i).trim();\n\t\n\t//å¦‚æœè·¯ç”±è§„åˆ™ä¸­ä¸å­˜åœ¨=>ç¬¦å·ï¼Œåˆ™æ•´ä¸ªè·¯ç”±è§„åˆ™éƒ½æ˜¯thenï¼Œå¦åˆ™=>ç¬¦å·å³ä¾§éƒ¨åˆ†ä¸ºthen\n\tString thenRule = i < 0 ? rule.trim() : rule.substring(i + 2).trim();\n\t\n\t//è§£æè§„åˆ™\n\tMap<String, MatchPair> when = StringUtils.isBlank(whenRule) || \"true\".equals(whenRule) ? new HashMap<String, MatchPair>() : parseRule(whenRule);\n\tMap<String, MatchPair> then = StringUtils.isBlank(thenRule) || \"false\".equals(thenRule) ? null : parseRule(thenRule);\n}\n\n//parseRuleæ–¹æ³•éƒ¨åˆ†æºç \nMap<String, MatchPair> condition = new HashMap<String, MatchPair>();\nfinal Matcher matcher = ROUTE_PATTERN.matcher(rule);\n//å°è¯•é€ä¸€åŒ¹é…\nwhile (matcher.find()) {\n    String separator = matcher.group(1);\n    String content = matcher.group(2);\n}\n```\nå½“è§£æwhenè§„åˆ™çš„æ—¶å€™ï¼Œåœ¨whileå¾ªç¯ä¸­å°†ä¼šä¾æ¬¡è§£æå‡ºå¦‚ä¸‹å€¼(ç¬¬äºŒä¸ªåˆ†å‰²çº¿ä»¥ä¸‹çš„å†…å®¹æ˜¯è§£æthenæ—¶çš„ç»“æœ)ï¼š\n```java\nseparator   content\n------------------------------------\n    \"\"      method(ç¬¬ä¸€æ¬¡éå†)\n    =\t    find*\n    ,       list*\n    ,       get*\n    ,       is*\n------------------------------------\n    \"\"\t    host\n    =       192.168.99.60\n    ,       192.168.99.61\n```\nå…¶ä¸­ç¬¬ä¸€æ¬¡éå†æ—¶ï¼Œseparatorä¸ºç©ºï¼Œcontentä¸ºmethodï¼Œæ­¤æ—¶å°†ä¼šæ–°å»ºä¸€ä¸ªMatchPairå¯¹è±¡ï¼Œç„¶åæ”¾å…¥åˆ°conditionå“ˆå¸Œä¸­ï¼Œåé¢çš„éå†å°†ä¼šæŒ‰ç…§separatorå€¼çš„ä¸åŒè¿›å…¥åˆ°ä¸åŒçš„åˆ†æ”¯ï¼Œç„¶åæŠŠcontentå€¼åŠ å…¥åˆ°MatchPairå¯¹è±¡çš„matchesé›†åˆä¸­(separatorä¸º=å·åˆ™æ”¾å…¥matchesé›†åˆ,ä¸º!=åˆ™æ”¾å…¥mismatchesé›†åˆä¸­)ã€‚\n```java\nif (separator == null || separator.length() == 0) {\n\tpair = new MatchPair();\n\tcondition.put(content, pair);\n}\n```\nè§£æthenè§„åˆ™çš„è¿‡ç¨‹ç±»ä¼¼ï¼Œè¿™é‡Œå°±ä¸ä»‹ç»äº†ã€‚\n\n\n#### ScriptRouterå®ç°ç±»\n![](img/ScriptRouter.png)\n```java\npublic class ScriptRouter implements Router {\n\n    /**\n     * <è„šæœ¬ç±»å‹ï¼Œè„šæœ¬å¼•æ“>\n     */\n    private static final Map<String, ScriptEngine> engines = new ConcurrentHashMap<String, ScriptEngine>();\n\n    /**\n     * å½“å‰ä½¿ç”¨çš„è„šæœ¬å¼•æ“\n     */\n    private final ScriptEngine engine;\n\n    /**\n     * ä¼˜å…ˆçº§\n     */\n    private final int priority;\n    /**\n     * è·¯ç”±è§„åˆ™\n     */\n    private final String rule;\n\n    /**\n     * è·¯ç”±url\n     */\n    private final URL url;\n\n    public ScriptRouter(URL url) {\n        this.url = url;\n        //è·å–urlçš„typeå‚æ•°ï¼Œæ ‡è¯†è„šæœ¬ç±»å‹ï¼Œå¦‚ï¼šjsã€groovy\n        String type = url.getParameter(Constants.TYPE_KEY);\n        //è·å–urlçš„priorityå‚æ•°ï¼Œæ ‡è¯†ä¼˜å…ˆçº§\n        this.priority = url.getParameter(Constants.PRIORITY_KEY, 0);\n        //è·å–urlçš„ruleå‚æ•°ï¼Œæ ‡è¯†è„šæœ¬è§„åˆ™\n        String rule = url.getParameterAndDecoded(Constants.RULE_KEY);\n        if (type == null || type.length() == 0) {\n            //é»˜è®¤è„šæœ¬ç±»å‹ï¼Œjavascript\n            type = Constants.DEFAULT_SCRIPT_TYPE_KEY;\n        }\n        if (rule == null || rule.length() == 0) {\n            //è·¯ç”±è§„åˆ™ä¸å¯ä»¥ä¸ºç©º\n            throw new IllegalStateException(new IllegalStateException(\"route rule can not be empty. rule:\" + rule));\n        }\n        //æ ¹æ®è„šæœ¬ç±»å‹,ä»ç¼“å­˜ä¸­è·å–è„šæœ¬å¼•æ“\n        ScriptEngine engine = engines.get(type);\n        if (engine == null) {\n            //æ ¹æ®è„šæœ¬ç±»å‹typeåˆ›å»ºä¸€ä¸ªè„šæœ¬å¼•æ“\n            engine = new ScriptEngineManager().getEngineByName(type);\n            if (engine == null) {\n                throw new IllegalStateException(new IllegalStateException(\"Unsupported route rule type: \" + type + \", rule: \" + rule));\n            }\n            //æ”¾å…¥ç¼“å­˜\n            engines.put(type, engine);\n        }\n        this.engine = engine;\n        this.rule = rule;\n    }\n\n    @Override\n    public URL getUrl() {\n        return url;\n    }\n\n    @Override\n    @SuppressWarnings(\"unchecked\")\n    public <T> List<Invoker<T>> route(List<Invoker<T>> invokers, URL url, Invocation invocation) throws RpcException {\n        try {\n            List<Invoker<T>> invokersCopy = new ArrayList<Invoker<T>>(invokers);\n            Compilable compilable = (Compilable) engine;\n            //å°†å‚æ•°ä¼ é€’åˆ°è„šæœ¬å¼•æ“\n            Bindings bindings = engine.createBindings();\n            bindings.put(\"invokers\", invokersCopy);\n            bindings.put(\"invocation\", invocation);\n            bindings.put(\"context\", RpcContext.getContext());\n            //ç¼–è¯‘è§„åˆ™è„šæœ¬\n            CompiledScript function = compilable.compile(rule);\n            //æ‰§è¡Œè„šæœ¬ï¼Œè¿”å›ç­›é€‰åçš„invokersåˆ—è¡¨\n            Object obj = function.eval(bindings);\n            if (obj instanceof Invoker[]) {\n                invokersCopy = Arrays.asList((Invoker<T>[]) obj);\n            } else if (obj instanceof Object[]) {\n                invokersCopy = new ArrayList<Invoker<T>>();\n                for (Object inv : (Object[]) obj) {\n                    invokersCopy.add((Invoker<T>) inv);\n                }\n            } else {\n                invokersCopy = (List<Invoker<T>>) obj;\n            }\n            return invokersCopy;\n        } catch (ScriptException e) {\n            //fail then ignore rule .invokers.\n            logger.error(\"route error , rule has been ignored. rule: \" + rule + \", method:\" + invocation.getMethodName() + \", url: \" + RpcContext.getContext().getUrl(), e);\n            return invokers;\n        }\n    }\n}\n```\n\n#### MockInvokersSelectorå®ç°ç±»\nMockInvokersSelectorï¼šå…¶å®å°±æ˜¯ç”¨äºè·¯ç”± Mock æœåŠ¡ä¸éMockæœåŠ¡ã€‚\nDubboé»˜è®¤ä¼šåœ¨AbstractDirectory#setRoutersæ–¹æ³•ä¸­è‡ªåŠ¨æ·»åŠ MockInvokersSelectorè·¯ç”±è§„åˆ™ã€‚\n```java\npublic class MockInvokersSelector implements Router{\n\n    @Override\n    public <T> List<Invoker<T>> route(final List<Invoker<T>> invokers,URL url, final Invocation invocation) throws RpcException {\n        if (invocation.getAttachments() == null) {\n            //é™„åŠ å‚æ•°ä¸ºç©º\n            //è¿”å›ä¸æ”¯æŒmockåè®®çš„invoker\n            return getNormalInvokers(invokers);\n        } else {\n            //ä»é™„åŠ å‚æ•°ä¸­è·å–invocation.need.mockå±æ€§çš„å€¼\n            String value = invocation.getAttachments().get(Constants.INVOCATION_NEED_MOCK);\n            if (value == null) {\n                //è¿”å›ä¸æ”¯æŒmockåè®®çš„invoker\n                return getNormalInvokers(invokers);\n            } else if (Boolean.TRUE.toString().equalsIgnoreCase(value)) {\n                //å¦‚æœinvocation.need.mock = true,åˆ™è¿”å›mock-Invokers\n                return getMockedInvokers(invokers);\n            }\n        }\n        return invokers;\n    }\n    ....çœç•¥å…¶ä»–æ–¹æ³•....\n}\n\npublic abstract class AbstractDirectory<T> implements Directory<T> {\n    \n    /**\n     * è®¾ç½®è·¯ç”±\n     * 1ã€æ·»åŠ ï¼šæ”¶åˆ°notifyé€šçŸ¥çš„routersã€å½“å‰urlçš„routerå‚æ•°ã€new MockInvokersSelector()\n     * 2ã€å°†routersæ’åº\n     * 3ã€ç¼“å­˜routers\n     * @param routers æ”¶åˆ°notifyé€šçŸ¥çš„routers\n     */\n    protected void setRouters(List<Router> routers) {\n        routers = routers == null ? new ArrayList<Router>() : new ArrayList<Router>(routers);\n        //è·å–è·¯ç”±å™¨å·¥å‚æ‰©å±•åç§°ï¼Œrouterå‚æ•°\n        String routerkey = url.getParameter(Constants.ROUTER_KEY);\n        if (routerkey != null && routerkey.length() > 0) {\n            //æ ¹æ®è·¯ç”±å™¨å·¥å‚æ‰©å±•åè·å–æ‰©å±•å®ä¾‹\n            RouterFactory routerFactory = ExtensionLoader.getExtensionLoader(RouterFactory.class).getExtension(routerkey);\n            //æ ¹æ®urlè·å–è·¯ç”±å™¨å®ä¾‹ï¼Œå¹¶æ”¾å…¥routers\n            routers.add(routerFactory.getRouter(url));\n        }\n        //æ·»åŠ æ”¯æŒmockåè®®çš„invokeré€‰æ‹©å™¨\n        routers.add(new MockInvokersSelector());\n        //æ’åº\n        Collections.sort(routers);\n        this.routers = routers;\n    }\n    ....çœç•¥å…¶ä»–æ–¹æ³•....\n}\n \n```\n\n#### è‡ªå®šä¹‰Router\nå‡å¦‚æˆ‘ä»¬çš„æœåŠ¡æä¾›è€…åˆ†ä¸ºå¤šä¸ªä¸åŒçš„ç»„ï¼Œæˆ‘ä»¬æƒ³è¦æ ¹æ®æŸä¸ªè°ƒç”¨å‚æ•°è°ƒç”¨ä¸åŒçš„ç»„ã€‚\næˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªCustomRouterç±»ï¼Œç„¶åå®ç°routeæ–¹æ³•ã€‚\n\n```java\npublic class CustomRouter extends ConditionRouter{\n\n    @Override\n    public <T> List<Invoker<T>> route(List<Invoker<T>> invokers, URL url, Invocation invocation)throws RpcException {\n        if (invokers == null || invokers.isEmpty()) {\n            return invokers;\n        }\n\t//è·å–è°ƒç”¨å‚æ•°\n\tObject[] arguments = invocation.getArguments();\n        if(arguments == null || arguments.length == 0){\n            logger.error(\"æ–¹æ³•: {} ç¼ºå°‘è·¯ç”±å‚æ•°routeKey\",invocation.getMethodName());\n            return null;\n        }\n\t//è·å–è·¯ç”±key\n        Object routeKey = arguments[0];\n\tString consumerGroup = getGroup(routeKey);\n\t//String consumerGroup = url.getParameter(Constants.GROUP_KEY);\n\n        List<Invoker<T>> result = new ArrayList<Invoker<T>>();\n\tfor (Invoker<T> invoker : invokers) {\n\t    //è·å–æœåŠ¡æä¾›è€…çš„groupå‚æ•°\n            String group = invoker.getUrl().getParameter(Constants.GROUP_KEY);\n            \n\t    //åˆ¤æ–­å½“å‰æœåŠ¡æä¾›è€…çš„groupæ˜¯å¦å’Œå½“å‰è°ƒç”¨å‚æ•°ä¸­çš„groupæ˜¯å¦åŒ¹é…\n\t    if (consumerGroup.equals(group)) {\n\t        //åŒ¹é…çš„è¯ï¼Œåˆ™ä¿å­˜å½“å‰æœåŠ¡æä¾›è€…\n                result.add(invoker);\n            }\n        }\n\tif(result.size() > 0){\n\t   //è¿”å›åŒ¹é…çš„æœåŠ¡æä¾›è€…ç»„\n\t   return result;\n\t}\n        return invokers;\n    }\n    \n    /**\n     * è·å–group\n     */\n    private String getGroup(String routeKey){\n\tif(routeKey.endsWith(\"1\")){\n\t   return \"v1\";\n\t}else{\n\t   return \"v2\";\n\t}\n    }\n}\n\n/**\n * å·¥å‚\n */\npublic class CustomRouterFactory implements RouterFactory {\n\n    public static final String NAME = \"custom\";\n\n    @Override\n    public Router getRouter(URL url) {\n        return new CustomRouter(url);\n    }\n\n}\n```\n\nç„¶åæˆ‘ä»¬é…ç½®æ‰©å±•ï¼Œè®©dubboå¯ä»¥è‡ªåŠ¨å‘ç°ã€‚\n```java\ncustom=com.alibaba.dubbo.rpc.cluster.router.custom.CustomRouterFactory\n```\n\nç„¶åé…ç½®è·¯ç”±è§„åˆ™ï¼Œä¾‹å¦‚å¯ä»¥åœ¨RegistryProtocolç±»çš„registeræ–¹æ³•ä¸­åŠ å…¥æ·»åŠ è·¯ç”±è§„åˆ™è¿›è¡Œæ–­ç‚¹æµ‹è¯•ã€‚\n```java\npublic void register(URL registryUrl, URL registedProviderUrl) {\n        //è·å–æ³¨å†Œä¸­å¿ƒ\n\tRegistry registry = registryFactory.getRegistry(registryUrl);\n\t//æ³¨å†ŒæœåŠ¡æä¾›è€…\n\tregistry.register(registedProviderUrl);\n\t\n\t//æµ‹è¯•ä»£ç (æ·»åŠ è·¯ç”±è§„åˆ™),group=fooæ ‡è¯†å¯¹æŒ‡å®šçš„fooç»„ç”Ÿæ•ˆ\n\t#URL routerUrl = URL.valueOf(\"routers://0.0.0.0/com.alibaba.dubbo.demo.DemoService?name=test&category=routers&router=custom&dynamic=false&version=1.0&group=foo\");\n\tURL routerUrl = URL.valueOf(\"routers://0.0.0.0/com.alibaba.dubbo.demo.DemoService?name=test&category=routers&router=custom&dynamic=false\");\n\tregistry.register(routerUrl);\n}\n```\n\næœ€åæ¨¡æ‹Ÿæ¶ˆè´¹è€…è°ƒç”¨è¿›è¡Œæµ‹è¯•å³å¯ã€‚\n\n\n\n\n\n\n\n\n\n\n\n","tags":["dubbo"]},{"title":"Dubboæºç é˜…è¯»ä¹‹æœåŠ¡å¼•ç”¨","url":"/blog/2018/08/23/Dubboæºç é˜…è¯»ä¹‹æœåŠ¡å¼•ç”¨/","content":">æœ¬å°èŠ‚è®²è§£ä¸Šå°èŠ‚é—ç•™çš„ref = createProxy(map)æ–¹æ³•ï¼Œä¸äº†è§£çš„å¯ä»¥å…ˆçœ‹ä¸‹ä¸Šç¯‡æ–‡ç« ã€ŠDubboæºç é˜…è¯»ä¹‹é›†æˆSpring-0202æ³¨è§£è§£æã€‹\n\nè¯¥æ–¹æ³•å®šä¹‰åœ¨ReferenceConfigç±»ä¸­ï¼Œåœ¨è°ƒç”¨initæ–¹æ³•è¿›è¡Œåˆå§‹åŒ–æ—¶ï¼Œä¼šè°ƒç”¨createProxyæ–¹æ³•æ¥ç”Ÿæˆä»£ç†å¯¹è±¡ã€‚\n\n### createProxyåˆ›å»ºä»£ç†\n```java\n/**\n * åˆ›å»ºä»£ç†\n */\nprivate T createProxy(Map<String, String> map) {\n\tURL tmpUrl = new URL(\"temp\", \"localhost\", 0, map);\n\tfinal boolean isJvmRefer;\n\t//æ˜¯å¦å¼•ç”¨æœ¬åœ°æœåŠ¡ï¼Œæ–°ç‰ˆä½¿ç”¨ï¼š scope=localæ¥åˆ¤æ–­\n\tif (isInjvm() == null) {\n\t    if (url != null && url.length() > 0) {\n\t\t//å¦‚æœé…ç½®ä¸­æŒ‡å®šäº†urlå±æ€§ï¼Œåˆ™ä¸ä½¿ç”¨æœ¬åœ°å¼•ç”¨\n\t\tisJvmRefer = false;\n\t    } else if (InjvmProtocol.getInjvmProtocol().isInjvmRefer(tmpUrl)) {\n\t\t//é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœæœ‰æœ¬åœ°æœåŠ¡ï¼Œåˆ™å¼•ç”¨æœ¬åœ°æœåŠ¡\n\t\tisJvmRefer = true;\n\t    } else {\n\t\tisJvmRefer = false;\n\t    }\n\t} else {\n\t    isJvmRefer = isInjvm().booleanValue();\n\t}\n\tif (isJvmRefer) {\n\t    //æ„å»ºæœ¬åœ°åè®®\n\t    URL url = new URL(Constants.LOCAL_PROTOCOL, NetUtils.LOCALHOST, 0, interfaceClass.getName()).addParameters(map);\n\t    //å¼•ç”¨æœ¬åœ°æœåŠ¡(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\t    invoker = refprotocol.refer(interfaceClass, url);\n\t    if (logger.isInfoEnabled()) {\n\t\tlogger.info(\"Using injvm service \" + interfaceClass.getName());\n\t    }\n\t} else {\n\t    if (url != null && url.length() > 0) {\n\t\t//ç”¨æˆ·æŒ‡å®šäº†URLå±æ€§ï¼Œå¯ä»¥æ˜¯p2påœ°å€æˆ–è€…æ³¨å†Œä¸­å¿ƒçš„åœ°å€ï¼Œå¤šä¸ªåœ°å€ä½¿ç”¨\";\"åˆ†éš”\n\t\tString[] us = Constants.SEMICOLON_SPLIT_PATTERN.split(url);\n\t\tif (us != null && us.length > 0) {\n\t\t    for (String u : us) {\n\t\t\tURL url = URL.valueOf(u);\n\t\t\tif (url.getPath() == null || url.getPath().length() == 0) {\n\t\t\t    //pathä¸ºç©ºæ—¶ï¼Œä½¿ç”¨æœåŠ¡æ¥å£åç§°ä½œä¸ºpath\n\t\t\t    url = url.setPath(interfaceName);\n\t\t\t}\n\t\t\tif (Constants.REGISTRY_PROTOCOL.equals(url.getProtocol())) {\n\t\t\t    //æ³¨å†Œä¸­å¿ƒåè®®ï¼Œæ·»åŠ å¼•ç”¨æ ‡è¯†referå‚æ•°\n\t\t\t    urls.add(url.addParameterAndEncoded(Constants.REFER_KEY, StringUtils.toQueryString(map)));\n\t\t\t} else {\n\t\t\t    //p2påœ°å€(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\t\t\t    urls.add(ClusterUtils.mergeUrl(url, map));\n\t\t\t}\n\t\t    }\n\t\t}\n\t    } else {\n\t\t//ä»æ³¨å†Œä¸­å¿ƒé…ç½®ä¸­ç»„è£…URL(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\t\tList<URL> us = loadRegistries(false);\n\t\tif (us != null && !us.isEmpty()) {\n\t\t    //éå†æ³¨å†Œä¸­å¿ƒus(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\t\t    for (URL u : us) {\n\t\t\t//åŠ è½½ç›‘æ§url(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\t\t\tURL monitorUrl = loadMonitor(u);\n\t\t\tif (monitorUrl != null) {\n\t\t\t    //æ·»åŠ monitorå‚æ•°\n\t\t\t    map.put(Constants.MONITOR_KEY, URL.encode(monitorUrl.toFullString()));\n\t\t\t}\n\t\t\t//æ·»åŠ referå‚æ•°\n\t\t\turls.add(u.addParameterAndEncoded(Constants.REFER_KEY, StringUtils.toQueryString(map)));\n\t\t    }\n\t\t}\n\t\tif (urls == null || urls.isEmpty()) {\n\t\t    //åœ¨æ¶ˆè´¹è€…ç«¯ï¼Œæ²¡æœ‰é…ç½®æ³¨å†Œä¸­å¿ƒï¼Œå› æ­¤æ— æ³•å¼•ç”¨ç›¸åº”æœåŠ¡æ¥å£\n\t\t    throw new IllegalStateException(\"No such any registry to reference \" + interfaceName + \" on the consumer \" + NetUtils.getLocalHost() + \" use dubbo version \" + Version.getVersion() + \", please config <dubbo:registry address=\\\"...\\\" /> to your spring config.\");\n\t\t}\n\t    }\n\t    if (urls.size() == 1) {\n\t\t//å¼•ç”¨ä¸€ä¸ªè¿œç¨‹æœåŠ¡(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\t\t//registry://172.172.172.47:2181/com.alibaba.dubbo.registry.RegistryService?application=demo-consumer&dubbo=2.0.0&pid=1172&qos.port=33333&refer=application%3Ddemo-consumer%26check%3Dfalse%26dubbo%3D2.0.0%26interface%3Dcom.alibaba.dubbo.demo.DemoService%26methods%3DsayHello%26pid%3D1172%26qos.port%3D33333%26register.ip%3D192.168.99.60%26side%3Dconsumer%26timestamp%3D1535094943004&registry=zookeeper&timestamp=1535095022853\n\t\tinvoker = refprotocol.refer(interfaceClass, urls.get(0));\n\t    } else {\n\t\t//å¦‚æœæœ‰å¤šä¸ªurl\n\t\tList<Invoker<?>> invokers = new ArrayList<Invoker<?>>();\n\t\tURL registryURL = null;\n\t\tfor (URL url : urls) {\n\t\t    //è®°å½•\"è¿œç¨‹å¼•ç”¨\"\n\t\t    invokers.add(refprotocol.refer(interfaceClass, url));\n\t\t    if (Constants.REGISTRY_PROTOCOL.equals(url.getProtocol())) {\n\t\t\t//ä½¿ç”¨æœ€åä¸€ä¸ªæ³¨å†Œä¸­å¿ƒurl\n\t\t\tregistryURL = url;\n\t\t    }\n\t\t}\n\t\tif (registryURL != null) {\n\t\t    //æœ‰æ³¨å†Œä¸­å¿ƒåè®®çš„URLï¼Œä½¿ç”¨AvailableCluster\n\t\t    URL u = registryURL.addParameter(Constants.CLUSTER_KEY, AvailableCluster.NAME);\n\t\t    invoker = cluster.join(new StaticDirectory(u, invokers));\n\t\t} else { \n\t\t    //ä¸æ˜¯æ³¨å†Œä¸­å¿ƒçš„url\n\t\t    invoker = cluster.join(new StaticDirectory(invokers));\n\t\t}\n\t    }\n\t}\n\t//æ£€æµ‹æœåŠ¡æä¾›è€…æ˜¯å¦å­˜åœ¨\n\tBoolean c = check;\n\tif (c == null && consumer != null) {\n\t    c = consumer.isCheck();\n\t}\n\tif (c == null) {\n\t    //é»˜è®¤éœ€è¦æ£€æµ‹æœåŠ¡æä¾›è€…æ˜¯å¦å­˜åœ¨\n\t    c = true;\n\t}\n\t//æ£€æµ‹æœåŠ¡æä¾›è€…æ˜¯å¦å­˜åœ¨\n\tif (c && !invoker.isAvailable()) {\n\t    throw new IllegalStateException(\"Failed to check the status of the service \" + interfaceName + \". No provider available for the service \" + (group == null ? \"\" : group + \"/\") + interfaceName + (version == null ? \"\" : \":\" + version) + \" from the url \" + invoker.getUrl() + \" to the consumer \" + NetUtils.getLocalHost() + \" use dubbo version \" + Version.getVersion());\n\t}\n\tif (logger.isInfoEnabled()) {\n\t    logger.info(\"Refer dubbo service \" + interfaceClass.getName() + \" from url \" + invoker.getUrl());\n\t}\n\t//åˆ›å»ºæœåŠ¡ä»£ç†\n\treturn (T) proxyFactory.getProxy(invoker);\n}\n\n/**\n * æ„é€ æ³¨å†Œä¸­å¿ƒURL\n * @param provider\n * @return\n */\nprotected List<URL> loadRegistries(boolean provider) {\n\t//æ£€æµ‹æ˜¯å¦é…ç½®äº†RegistryConfigï¼Œå¹¶é…ç½®\n\tcheckRegistry();\n\tList<URL> registryList = new ArrayList<URL>();\n\tif (registries != null && !registries.isEmpty()) {\n\t    //éå†æ³¨å†Œä¸­å¿ƒé…ç½®\n\t    for (RegistryConfig config : registries) {\n\t\t//è·å–å½“å‰æ³¨å†Œä¸­å¿ƒåœ°å€ï¼Œä¾‹å¦‚ï¼š zookeeper://172.172.172.47:2181\n\t\tString address = config.getAddress();\n\t\tif (address == null || address.length() == 0) {\n\t\t    //è®¾ç½®address = 0.0.0.0\n\t\t    address = Constants.ANYHOST_VALUE;\n\t\t}\n\t\t//ä»ç³»ç»Ÿé…ç½®ä¸­è·å–æ³¨å†Œä¸­å¿ƒåœ°å€\n\t\tString sysaddress = System.getProperty(\"dubbo.registry.address\");\n\t\tif (sysaddress != null && sysaddress.length() > 0) {\n\t\t    //å¦‚æœç³»ç»Ÿé…ç½®çš„æ³¨å†Œä¸­å¿ƒåœ°å€ä¸ä¸ºç©ºï¼Œåˆ™ä¼˜å…ˆä½¿ç”¨ç³»ç»Ÿé…ç½®\n\t\t    address = sysaddress;\n\t\t}\n\t\tif (address != null && address.length() > 0\n\t\t\t&& !RegistryConfig.NO_AVAILABLE.equalsIgnoreCase(address)) {\n\t\t    //æ³¨å†Œä¸­å¿ƒåœ°å€å¯ç”¨\n\t\t    Map<String, String> map = new HashMap<String, String>();\n\t\t    //é™„åŠ å‚æ•°ï¼Œå³æ‰¾åˆ°applicationã€configç±»ä¸­çš„å±æ€§ï¼Œå¹¶æ·»åŠ è¿›æ¥\n\t\t    appendParameters(map, application);\n\t\t    appendParameters(map, config);\n\t\t    map.put(\"path\", RegistryService.class.getName());\n\t\t    map.put(\"dubbo\", Version.getVersion());\n\t\t    map.put(Constants.TIMESTAMP_KEY, String.valueOf(System.currentTimeMillis()));\n\t\t    if (ConfigUtils.getPid() > 0) {\n\t\t\tmap.put(Constants.PID_KEY, String.valueOf(ConfigUtils.getPid()));\n\t\t    }\n\t\t    if (!map.containsKey(\"protocol\")) {\n\t\t\t//æ·»åŠ protocolå‚æ•°\n\t\t\tif (ExtensionLoader.getExtensionLoader(RegistryFactory.class).hasExtension(\"remote\")) {\n\t\t\t    map.put(\"protocol\", \"remote\");\n\t\t\t} else {\n\t\t\t    map.put(\"protocol\", \"dubbo\");\n\t\t\t}\n\t\t    }\n\t\t    //æ ¹æ®addresså’Œmapç”Ÿæˆæ³¨å†Œä¸­å¿ƒurl\n\t\t    List<URL> urls = UrlUtils.parseURLs(address, map);\n\t\t    \n\t\t    //éå†æ³¨å†Œä¸­å¿ƒurlï¼Œæ·»åŠ registryå‚æ•°,å¹¶è®¾ç½®protocolå±æ€§ï¼Œç„¶åä¿å­˜èµ·æ¥\n\t\t    for (URL url : urls) {\n\t\t\t//url = zookeeper://172.172.172.47:2181/com.alibaba.dubbo.registry.RegistryService?application=demo-consumer&dubbo=2.0.0&pid=1172&qos.port=33333&timestamp=1535095022853\n\t\t\t//æ·»åŠ registryå‚æ•° = zookeeper\n\t\t\turl = url.addParameter(Constants.REGISTRY_KEY, url.getProtocol());\n\t\t\t\n\t\t\t//é‡æ–°è®¾ç½®åè®®ä¸ºregistry\n\t\t\turl = url.setProtocol(Constants.REGISTRY_PROTOCOL);\n\t\t\tif ((provider && url.getParameter(Constants.REGISTER_KEY, true))\n\t\t\t\t|| (!provider && url.getParameter(Constants.SUBSCRIBE_KEY, true))) {\n\t\t\t    //registry://172.172.172.47:2181/com.alibaba.dubbo.registry.RegistryService?application=demo-consumer&dubbo=2.0.0&pid=1172&qos.port=33333&registry=zookeeper&timestamp=1535095022853\n\t\t\t    registryList.add(url);\n\t\t\t}\n\t\t    }\n\t\t}\n\t    }\n\t}\n\treturn registryList;\n}\n\n/**\n * æ£€æµ‹RegistryConfigé…ç½®\n */\nprotected void checkRegistry() {\n\t//å‘åå…¼å®¹\n\tif (registries == null || registries.isEmpty()) {\n\t    //è·å–åˆ°æ³¨å†Œä¸­å¿ƒå±æ€§é…ç½®å€¼\n\t    String address = ConfigUtils.getProperty(\"dubbo.registry.address\");\n\t    if (address != null && address.length() > 0) {\n\t\tregistries = new ArrayList<RegistryConfig>();\n\t\t//ä½¿ç”¨\"|\"åˆ†éš”æ³¨å†Œä¸­å¿ƒï¼Œç„¶åæ„é€ RegistryConfigå¯¹è±¡\n\t\tString[] as = address.split(\"\\\\s*[|]+\\\\s*\");\n\t\tfor (String a : as) {\n\t\t    RegistryConfig registryConfig = new RegistryConfig();\n\t\t    registryConfig.setAddress(a);\n\t\t    registries.add(registryConfig);\n\t\t}\n\t    }\n\t}\n\tif ((registries == null || registries.isEmpty())) {\n\t    throw new IllegalStateException((getClass().getSimpleName().startsWith(\"Reference\")\n\t\t    ? \"No such any registry to refer service in consumer \"\n\t\t    : \"No such any registry to export service in provider \")\n\t\t    + NetUtils.getLocalHost()\n\t\t    + \" use dubbo version \"\n\t\t    + Version.getVersion()\n\t\t    + \", Please add <dubbo:registry address=\\\"...\\\" /> to your spring config. If you want unregister, please set <dubbo:service registry=\\\"N/A\\\" />\");\n\t}\n\tfor (RegistryConfig registryConfig : registries) {\n\t    //æ·»åŠ å±æ€§\n\t    appendProperties(registryConfig);\n\t}\n}\n```\n\næ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸‹Protocolçš„referæ–¹æ³•ï¼Œåœ¨ã€ŠDubboæºç é˜…è¯»ä¹‹æœåŠ¡æš´éœ²ã€‹å°èŠ‚æˆ‘ä»¬ä»‹ç»è¿‡ï¼Œå°†ä¼šç”ŸæˆProtocol$Adaptiveç±»ï¼š\n```java\npublic class Protocol$Adaptive implements com.alibaba.dubbo.rpc.Protocol {\n\t/**\n\t * @param arg0 æœåŠ¡æ¥å£ç±»\n\t * @param arg1 æ³¨å†Œä¸­å¿ƒurl\n\t */\n\tpublic com.alibaba.dubbo.rpc.Invoker refer(java.lang.Class arg0, com.alibaba.dubbo.common.URL arg1) throws com.alibaba.dubbo.rpc.RpcException {\n\t\tif (arg1 == null){\n\t\t\t//urlå‚æ•°ä¸å¯ä»¥ä¸ºç©º\n\t\t\tthrow new IllegalArgumentException(\"url == null\");\n\t\t}\n\t\t\n\t\tcom.alibaba.dubbo.common.URL url = arg1;\n\t\t\n\t\t//ä½¿ç”¨urlçš„protocolå±æ€§å€¼(è¿™é‡Œä¸ºregistry)ï¼Œä½œä¸ºæ‰©å±•åç§°ï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™é»˜è®¤ä½¿ç”¨\"dubbo\"\n\t\tString extName = url.getProtocol() == null ? \"dubbo\" : url.getProtocol();\n\t\t\n\t\tif(extName == null) {\n\t\t\tthrow new IllegalStateException(\"Fail to get extension(com.alibaba.dubbo.rpc.Protocol) name from url(\" + url.toString() + \") use keys([protocol])\");\n\t\t}\n\t\t\n\t\t//è·å–æ‰©å±•åç§°ä¸ºextNameçš„Protocolæ‰©å±•å®ä¾‹(è¿™é‡Œå¯èƒ½æ˜¯è¢«åŒ…è£…è¿‡çš„ç±»)\n\t\tcom.alibaba.dubbo.rpc.Protocol extension = (com.alibaba.dubbo.rpc.Protocol)ExtensionLoader.getExtensionLoader(com.alibaba.dubbo.rpc.Protocol.class).getExtension(extName);\n\t\t\n\t\t//è°ƒç”¨è¯¥extensionå®ä¾‹çš„referæ–¹æ³•\n\t\treturn extension.refer(arg0, arg1);\n\t}\n}\n```\nè¿™é‡Œå’ŒæœåŠ¡æš´éœ²æ—¶çš„æµç¨‹ä¸€æ ·ï¼Œå°†ä¼šè°ƒç”¨ä¸¤ä¸ªåŒ…è£…ç±»ProtocolFilterWrapperå’ŒProtocolListenerWrapperçš„referæ–¹æ³•ã€‚\n```java\npublic class ProtocolFilterWrapper implements Protocol {\n\t@Override\n\tpublic <T> Invoker<T> refer(Class<T> type, URL url) throws RpcException {\n\t\tif (Constants.REGISTRY_PROTOCOL.equals(url.getProtocol())) {\n\t\t    //è¿™é‡Œå°†ä¼šè°ƒç”¨ProtocolListenerWrapperç±»çš„referæ–¹æ³•\n\t\t    return protocol.refer(type, url);\n\t\t}\n\t\treturn buildInvokerChain(protocol.refer(type, url), Constants.REFERENCE_FILTER_KEY, Constants.CONSUMER);\n\t}\n}\n\npublic class ProtocolListenerWrapper implements Protocol {\n\t/**\n\t * @param type interface com.alibaba.dubbo.demo.DemoService\n\t * @param url  registry://224.5.6.7:1234/com.alibaba.dubbo.registry.RegistryService?application=demo-consumer&dubbo=2.0.0&pid=1512&qos.port=33333&refer=application%3Ddemo-consumer%26check%3Dfalse%26dubbo%3D2.0.0%26interface%3Dcom.alibaba.dubbo.demo.DemoService%26methods%3DsayHello%26pid%3D1512%26qos.port%3D33333%26register.ip%3D192.168.99.60%26side%3Dconsumer%26timestamp%3D1528340394760&registry=multicast&timestamp=1528340417091\n\t * @param <T>\n\t * @return\n\t * @throws RpcException\n\t */\n\t@Override\n\tpublic <T> Invoker<T> refer(Class<T> type, URL url) throws RpcException {\n\t\tif (Constants.REGISTRY_PROTOCOL.equals(url.getProtocol())) {\n\t\t    //è¿™é‡Œå°†ä¼šè°ƒç”¨RegistryProtocolç±»çš„referæ–¹æ³•\n\t\t    return protocol.refer(type, url);\n\t\t}\n\t\treturn new ListenerInvokerWrapper<T>(protocol.refer(type, url),\n\t\t\tCollections.unmodifiableList(\n\t\t\t\tExtensionLoader.getExtensionLoader(InvokerListener.class)\n\t\t\t\t\t.getActivateExtension(url, Constants.INVOKER_LISTENER_KEY)));\n\t}\n}\n```\nRegistryProtocolçš„referæ–¹æ³•ï¼š\n```java\n/**\n * @param typeè¿œç¨‹æœåŠ¡æ¥å£ç±»å‹\n * @param url è¿œç¨‹æœåŠ¡çš„URLåœ°å€\n * registry://172.172.172.47:2181/com.alibaba.dubbo.registry.RegistryService?application=demo-consumer&dubbo=2.0.0&pid=1172&qos.port=33333&refer=application%3Ddemo-consumer%26check%3Dfalse%26dubbo%3D2.0.0%26interface%3Dcom.alibaba.dubbo.demo.DemoService%26methods%3DsayHello%26pid%3D1172%26qos.port%3D33333%26register.ip%3D192.168.99.60%26side%3Dconsumer%26timestamp%3D1535094943004&registry=zookeeper&timestamp=1535095022853\n * @return\n * @throws RpcException\n */\n@Override\n@SuppressWarnings(\"unchecked\")\npublic <T> Invoker<T> refer(Class<T> type, URL url) throws RpcException {\n\t//ç”Ÿæˆæ³¨å†Œä¸­å¿ƒurl\n\turl = url.setProtocol(\n\t\t//è®¾ç½®åè®®ï¼Œä»urlä¸­çš„registryå‚æ•°ä¸­è·å–æ³¨å†Œæ—¶çš„åè®®(zookeeper)ï¼Œæ²¡æœ‰è·å–åˆ°çš„è¯ï¼Œåˆ™é»˜è®¤ä¸ºdubboåè®®\n\t\turl.getParameter(Constants.REGISTRY_KEY, Constants.DEFAULT_REGISTRY)\n\t\t//ç„¶åç§»é™¤registryå‚æ•°\n\t).removeParameter(Constants.REGISTRY_KEY);\n\n\t//æ ¹æ®urlè·å–æ³¨å†Œä¸­å¿ƒ\n\t//zookeeper://172.172.172.47:2181/com.alibaba.dubbo.registry.RegistryService?application=demo-consumer&dubbo=2.0.0&pid=1172&qos.port=33333&refer=application%3Ddemo-consumer%26check%3Dfalse%26dubbo%3D2.0.0%26interface%3Dcom.alibaba.dubbo.demo.DemoService%26methods%3DsayHello%26pid%3D1172%26qos.port%3D33333%26register.ip%3D192.168.99.60%26side%3Dconsumer%26timestamp%3D1535094943004&timestamp=1535095022853\n\tRegistry registry = registryFactory.getRegistry(url);\n\tif (RegistryService.class.equals(type)) {\n\t    return proxyFactory.getInvoker((T) registry, type, url);\n\t}\n\n\t//è·å–urlä¸­çš„referå‚æ•°ï¼Œå¹¶è½¬æ¢æˆmap\n\tMap<String, String> qs = StringUtils.parseQueryString(\n\t\turl.getParameterAndDecoded(Constants.REFER_KEY)\n\t);\n\t//è·å–mapä¸­çš„groupå‚æ•°\n\tString group = qs.get(Constants.GROUP_KEY);\n\tif (group != null && group.length() > 0) {\n\t    if ((Constants.COMMA_SPLIT_PATTERN.split(group)).length > 1\n\t\t    || \"*\".equals(group)) {\n\t\t//group=\"a,b\" or group=\"*\"\n\t\treturn doRefer(getMergeableCluster(), registry, type, url);\n\t    }\n\t}\n\treturn doRefer(cluster, registry, type, url);\n}\n\n/**\n *\n * @param cluster\n * @param registry æ³¨å†Œä¸­å¿ƒ\n * @param type è¿œç¨‹æœåŠ¡æ¥å£ç±»å‹\n * @param url æ³¨å†Œä¸­å¿ƒurl\n * @return\n */\nprivate <T> Invoker<T> doRefer(Cluster cluster, Registry registry, Class<T> type, URL url) {\n\t//æ ¹æ®æœåŠ¡æ¥å£typeå’Œæ³¨å†Œä¸­å¿ƒurlåˆ›å»ºRegistryDirectoryå¯¹è±¡(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\t//Directoryä»£è¡¨å¤šä¸ªInvoker,å¯ä»¥æŠŠå®ƒçœ‹æˆList<Invoker>ï¼Œ\n        //ä½†ä¸Listä¸åŒçš„æ˜¯,å®ƒçš„å€¼å¯èƒ½æ˜¯åŠ¨æ€å˜åŒ–çš„,æ¯”å¦‚æ³¨å†Œä¸­å¿ƒæ¨é€å˜æ›´\n\tRegistryDirectory<T> directory = new RegistryDirectory<T>(type, url);\n\t//è®¾ç½®æ³¨å†Œä¸­å¿ƒå®ä¾‹\n\tdirectory.setRegistry(registry);\n\t//è®¾ç½®åè®®\n\tdirectory.setProtocol(protocol);\n\t\n\t//referå‚æ•°æŒ‡å®šçš„urlçš„æ‰€æœ‰å±æ€§\n\tMap<String, String> parameters = new HashMap<String, String>(directory.getUrl().getParameters());\n\t\n\t//ç”Ÿæˆæ¶ˆè´¹è€…url\n\t//consumer://192.168.99.60/com.alibaba.dubbo.demo.DemoService?application=demo-consumer&check=false&dubbo=2.0.0&interface=com.alibaba.dubbo.demo.DemoService&methods=sayHello&pid=1172&qos.port=33333&side=consumer&timestamp=1535094943004\n\tURL subscribeUrl = new URL(Constants.CONSUMER_PROTOCOL, parameters.remove(Constants.REGISTER_IP_KEY), 0, type.getName(), parameters);\n\t\n\tif (!Constants.ANY_VALUE.equals(url.getServiceInterface())\n\t\t&& url.getParameter(Constants.REGISTER_KEY, true)) {\n\t    //æ³¨å†Œæ¶ˆè´¹è€…ï¼Œæ·»åŠ category=consumers,check=falseå‚æ•°\n\t    registry.register(subscribeUrl.addParameters(Constants.CATEGORY_KEY, Constants.CONSUMERS_CATEGORY,\n\t\t    Constants.CHECK_KEY, String.valueOf(false)));\n\t}\n\t\n\t//è®¢é˜…æ­¤url\n\tdirectory.subscribe(subscribeUrl.addParameter(Constants.CATEGORY_KEY,\n\t\t//æä¾›è€… /dubbo/interfaceClass/providers\n\t\t//é…ç½®  /dubbo/interfaceClass/configurators\n\t\t//è·¯ç”±  /dubbo/interfaceClass/routers\n\t\tConstants.PROVIDERS_CATEGORY\n\t\t\t+ \",\" + Constants.CONFIGURATORS_CATEGORY\n\t\t\t+ \",\" + Constants.ROUTERS_CATEGORY));\n\t\n\t//Clusterå°†Directoryä¸­çš„å¤šä¸ªInvokerä¼ªè£…æˆä¸€ä¸ªInvoker,å¯¹ä¸Šå±‚é€æ˜,ä¼ªè£…è¿‡ç¨‹åŒ…å«äº†å®¹é”™é€»è¾‘,è°ƒç”¨å¤±è´¥å,é‡è¯•å¦ä¸€ä¸ª(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\tInvoker invoker = cluster.join(directory);\n\t\n\t//æ³¨å†Œæ¶ˆè´¹è€…\n\tProviderConsumerRegTable.registerConsumer(invoker, url, subscribeUrl, directory);\n\treturn invoker;\n}\n```\nè¿™é‡Œé¦–å…ˆæ³¨å†Œäº†æ¶ˆè´¹è€…ï¼Œç„¶åè®¢é˜…äº†ç›¸å…³ç›®å½•(providersã€configurationsã€routers)ï¼Œå½“æœ‰ç›¸åº”æœåŠ¡æä¾›è€…æä¾›æœåŠ¡æ—¶ï¼Œæ³¨å†Œä¸­å¿ƒä¼šé€šè¿‡notifyé€šçŸ¥åˆ°æ¶ˆè´¹è€…ï¼Œæ¥ç€æ¶ˆè´¹è€…ä¼šé€šè¿‡RegistryDirectoryç±»å¼‚æ­¥æ›´æ–°æœ¬åœ°ç¼“å­˜ã€‚\næ³¨å†Œæ¶ˆè´¹è€…æ—¶ï¼Œé¦–å…ˆä¼šè°ƒç”¨AbstractRegistryç±»çš„registeræ–¹æ³•ï¼Œå°†æ³¨å†Œurlä¿å­˜èµ·æ¥ï¼Œç„¶åä¼šè°ƒç”¨FailbackRegistryç±»çš„registeræ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­ä¼šè°ƒç”¨doRegisteræ–¹æ³•(è¯¥æ–¹æ³•è°ƒç”¨å¤±è´¥çš„è¯ï¼Œä¼šç¨åè¿›è¡Œé‡è¯•),æœ€åä¼šè°ƒç”¨ZookeeperRegistryçš„doRegisteræ–¹æ³•ï¼Œè¿›è¡Œæœ€ç»ˆçš„æ³¨å†Œã€‚\n```java\n//ZookeeperRegistryç±»çš„doRegisteræ–¹æ³•\n@Override\nprotected void doRegister(URL url) {\n\ttry {\n\t    //æ‰§è¡Œæ³¨å†Œ dubbo://192.168.99.60:20880/com.alibaba.dubbo.demo.DemoService?anyhost=true&application=demo-provider&dubbo=2.0.0&generic=false&interface=com.alibaba.dubbo.demo.DemoService&methods=sayHello&pid=5312&side=provider&timestamp=1534994264738\n\t    //æ ¹æ®urlç¡®å®šèŠ‚ç‚¹è·¯å¾„ï¼›æ ¹æ®urlçš„dynamicå‚æ•°ç¡®å®šæ˜¯å¦æ˜¯ä¸´æ—¶èŠ‚ç‚¹ /dubbo/com.alibaba.dubbo.demo.DemoService/providers/dubbo%3A%2F%2F192.168.99.60%3A20880%2Fcom.alibaba.dubbo.demo.DemoService%3Fanyhost%3Dtrue%26application%3Ddemo-provider%26dubbo%3D2.0.0%26generic%3Dfalse%26interface%3Dcom.alibaba.dubbo.demo.DemoService%26methods%3DsayHello%26pid%3D5312%26side%3Dprovider%26timestamp%3D1534994264738\n\t    zkClient.create(toUrlPath(url), url.getParameter(Constants.DYNAMIC_KEY, true));\n\t} catch (Throwable e) {\n\t    throw new RpcException(\"Failed to register \" + url + \" to zookeeper \" + getUrl() + \", cause: \" + e.getMessage(), e);\n\t}\n}\n```\nè®¢é˜…æ—¶ï¼Œä¼šè°ƒç”¨RegistryDirectoryç±»çš„subscribeæ–¹æ³•\n```java\npublic class RegistryDirectory<T> extends AbstractDirectory<T> implements NotifyListener {\n\n       /**\n\t* è®¢é˜…url\n\t* @param url æ¶ˆè´¹è€…url \n\t* consumer://192.168.99.60/com.alibaba.dubbo.demo.DemoService?application=demo-consumer&category=providers,configurators,routers&check=false&dubbo=2.0.0&interface=com.alibaba.dubbo.demo.DemoService&methods=sayHello&pid=1880&qos.port=33333&side=consumer&timestamp=1535449640995\n\t*/\n\tpublic void subscribe(URL url) {\n\t\t//è®¾ç½®æ¶ˆè´¹è€…url(å°†urlä¿å­˜åˆ°AbstractDirectoryçˆ¶ç±»ä¸­)\n\t\tsetConsumerUrl(url);\n\t\t\n\t\t//è®¢é˜…è¯¥æ¶ˆè´¹è€…url(thiså³ä¸ºå½“å‰RegistryDirectoryå¯¹è±¡,å®ƒå®ç°äº†NotifyListeneræ¥å£)\n\t\t//é¦–å…ˆè°ƒç”¨AbstractRegistryçš„subscribeæ–¹æ³•(ä¿å­˜è®¢é˜…ä¿¡æ¯)\n\t\t//æ¥ç€è°ƒç”¨FailbackRegistryçš„subscribeæ–¹æ³•(è°ƒç”¨ZookeeperRegistryçš„doSubscribeæ–¹æ³•ï¼Œå¦‚æœå‘ç”Ÿå¼‚å¸¸äº†ä¼šæ•è·åˆ°ï¼Œç„¶åä¿å­˜ä¸‹æ¥ç¨åé‡è¯•)\n\t\t//ç„¶åè°ƒç”¨ZookeeperRegistryçš„doSubscribeæ–¹æ³•(è·å–å¾…é€šçŸ¥urlsï¼Œæœ€åè°ƒç”¨notifyæ–¹æ³•è¿›è¡Œé€šçŸ¥)\n\t\tregistry.subscribe(url, this);\n\t}\n}\n```\næˆ‘ä»¬ç®€å•çœ‹ä¸‹ZookeeperRegistryç±»çš„doSubscribeæ–¹æ³•ï¼Œå…¶ä¸­çœç•¥æ‰äº†ä¸€äº›ä»£ç \n```java\n//æ­¤listenerå‚æ•°å°±æ˜¯ä¸Šæ–‡åˆ›å»ºçš„RegistryDirectoryç±»\nprotected void doSubscribe(final URL url, final NotifyListener listener) {\n\tList<URL> urls = new ArrayList<URL>();\n\t//æ ¹æ®toCategoriesPath(url)æ–¹æ³•è·å–åˆ°ç±»åˆ«åˆ—è¡¨ï¼Œç„¶åéå†è¯¥åˆ—è¡¨\n\t//å¦‚ï¼š/dubbo/com.alibaba.dubbo.demo.DemoService/providers\n\tfor (String path : toCategoriesPath(url)) {\n\t    ConcurrentMap<NotifyListener, ChildListener> listeners = zkListeners.get(url);\n\t    if (listeners == null) {\n\t\tzkListeners.putIfAbsent(url, new ConcurrentHashMap<NotifyListener, ChildListener>());\n\t\tlisteners = zkListeners.get(url);\n\t    }\n\t    //æ ¹æ®dubboçš„ç›‘å¬è·å–zkçš„ç›‘å¬\n\t    ChildListener zkListener = listeners.get(listener);\n\t    if (zkListener == null) {\n\t        //åˆ›å»ºèŠ‚ç‚¹ç›‘å¬\n\t\tlisteners.putIfAbsent(listener, new ChildListener() {\n\t\t    @Override\n\t\t    public void childChanged(String parentPath, List<String> currentChilds) {\n\t\t\t//æ‰§è¡Œé€šçŸ¥\n\t\t\tZookeeperRegistry.this.notify(url, listener, toUrlsWithEmpty(url, parentPath, currentChilds));\n\t\t    }\n\t\t});\n\t\tzkListener = listeners.get(listener);\n\t    }\n\t    //åˆ›å»ºpathèŠ‚ç‚¹,\n\t    //å³ï¼š/dubbo/com.xxx.demoService/providers\n\t    //å³ï¼š/dubbo/consumers  /dubbo/com.alibaba.dubbo.demo.DemoService/configurators\n\t    zkClient.create(path, false);\n\t    //ä¸ºpathèŠ‚ç‚¹æ·»åŠ zkListenerç›‘å¬(childrenå˜é‡å³ä¸ºè¯¥pathèŠ‚ç‚¹çš„å­èŠ‚ç‚¹æ•°æ®)\n\t    List<String> children = zkClient.addChildListener(path, zkListener);\n\t    if (children != null) {\n\t        //èŠ‚ç‚¹æ•°æ®(å¾…é€šçŸ¥åˆ—è¡¨)\n\t\t//empty://192.168.99.60:20880/com.alibaba.dubbo.demo.DemoService?anyhost=true&application=demo-provider&category=configurators&check=false&dubbo=2.0.0&generic=false&interface=com.alibaba.dubbo.demo.DemoService&methods=sayHello&pid=6504&side=provider&timestamp=1534927826842\n\t\turls.addAll(toUrlsWithEmpty(url, path, children));\n\t    }\n\t}\n\t//æ‰§è¡Œé€šçŸ¥(urlså³ä¸ºå¾…é€šçŸ¥çš„æ¶ˆæ¯åˆ—è¡¨)\n\tnotify(url, listener, urls);\n}\n```\nè°ƒç”¨notifyæ–¹æ³•è¿›è¡Œé€šçŸ¥æ—¶,ä¼šå…ˆè°ƒç”¨FailbackRegistryç±»çš„notifyæ–¹æ³•,å†…éƒ¨ä¼šè°ƒç”¨doNotifyæ–¹æ³•(è°ƒç”¨å¤±è´¥çš„è¯,ä¼šä¿å­˜å¤±è´¥ä¿¡æ¯,ç¨åé‡è¯•)\n```java\n//FailbackRegistryç±»çš„notify\n//çœç•¥äº†ä¸€äº›ä¸é‡è¦çš„ä»£ç \n@Override\nprotected void notify(URL url, NotifyListener listener, List<URL> urls) {\n\ttry {\n\t    //æ‰§è¡Œé€šçŸ¥(å°†ä¼šè°ƒç”¨çˆ¶ç±»AbstractRegistryä¸­çš„notifyæ–¹æ³•)\n\t    doNotify(url, listener, urls);\n\t} catch (Exception t) {\n\t    //é€šçŸ¥å¤±è´¥ï¼Œæ·»åŠ åˆ°å¤±è´¥åˆ—è¡¨ï¼Œå®šæœŸé‡è¯•\n\t    Map<NotifyListener, List<URL>> listeners = failedNotified.get(url);\n\t    if (listeners == null) {\n\t\tfailedNotified.putIfAbsent(url, new ConcurrentHashMap<NotifyListener, List<URL>>());\n\t\tlisteners = failedNotified.get(url);\n\t    }\n\t    listeners.put(listener, urls);\n\t    logger.error(\"Failed to notify for subscribe \" + url + \", waiting for retry, cause: \" + t.getMessage(), t);\n\t}\n}\n```\nè€ŒdoNotifyæ–¹æ³•æœ€ç»ˆä¼šè°ƒç”¨AbstractRegistryç±»çš„notifyæ–¹æ³•,åœ¨AbstractRegistryç±»çš„notifyæ–¹æ³•ä¸­,ä¼šæ ¹æ®categoryå°†å¾…é€šçŸ¥urlsè¿›è¡Œåˆ†ç»„,ç„¶åæŒ¨ä¸ªå¤„ç†æ¯ä¸€ä¸ªcategory,å¹¶æŒ‰ç…§<è®¢é˜…urlæœåŠ¡å”¯ä¸€æ ‡è¯†,ç©ºæ ¼åˆ†éš”çš„å¤šä¸ªå¾…é€šçŸ¥url>çš„å½¢å¼ï¼Œä¿å­˜åˆ°æœ¬åœ°propertiesæ–‡ä»¶ä¸­ï¼Œæœ€åè°ƒç”¨RegistryDirectoryç±»çš„notifyæ–¹æ³•å°†å¾…é€šçŸ¥åˆ—è¡¨categoryListä¸‹å‘ç»™æ¶ˆè´¹è€…ã€‚\n```java\n//AbstractRegistryç±»çš„notifyæ–¹æ³•\n//çœç•¥äº†ä¸€äº›ä¸é‡è¦çš„ä»£ç \nprotected void notify(URL url, NotifyListener listener, List<URL> urls) {\n\t//<category,List<URL>>\n\tMap<String, List<URL>> result = new HashMap<String, List<URL>>();\n\t//éå†å¾…é€šçŸ¥urlsï¼Œæ ¹æ®urlä¸­çš„categoryå‚æ•°è¿›è¡Œåˆ†ç»„ï¼Œä¿å­˜åˆ°resultä¸­\n\tfor (URL u : urls) {\n\t    //urlå’Œuæ˜¯å¦åŒ¹é…(urlçš„èŒƒå›´æ˜¯å¦æ¯”uå¤§)\n\t    if (UrlUtils.isMatch(url, u)) {\n\t\t//è·å–å¾…é€šçŸ¥urlçš„categoryï¼Œé»˜è®¤å€¼æ˜¯providers\n\t\tString category = u.getParameter(Constants.CATEGORY_KEY, Constants.DEFAULT_CATEGORY);\n\t\tList<URL> categoryList = result.get(category);\n\t\tif (categoryList == null) {\n\t\t    categoryList = new ArrayList<URL>();\n\t\t    result.put(category, categoryList);\n\t\t}\n\t\tcategoryList.add(u);\n\t    }\n\t}\n\tif (result.size() == 0) {\n\t    //ç±»åˆ«å¾…é€šçŸ¥urlåˆ—è¡¨ä¸ºç©ºï¼Œç›´æ¥è¿”å›\n\t    return;\n\t}\n\t//ä¸‹é¢ä¼šå°†notifiedä¸­çš„urlåŠå…¶values.valuesä¸­çš„URLä¿å­˜åˆ°ç¼“å­˜æ–‡ä»¶ä¸­\n\tMap<String, List<URL>> categoryNotified = notified.get(url);\n\tif (categoryNotified == null) {\n\t    notified.putIfAbsent(url, new ConcurrentHashMap<String, List<URL>>());\n\t    categoryNotified = notified.get(url);\n\t}\n\tfor (Map.Entry<String, List<URL>> entry : result.entrySet()) {\n\t    //ç±»åˆ«\n\t    String category = entry.getKey();\n\t    //ç±»åˆ«å¾…é€šçŸ¥urlåˆ—è¡¨\n\t    List<URL> categoryList = entry.getValue();\n\t    //ä¿å­˜<ç±»åˆ«,ç±»åˆ«å¾…é€šçŸ¥urlåˆ—è¡¨>\n\t    categoryNotified.put(category, categoryList);\n\t    //ä¿å­˜æ³¨å†Œä¸­å¿ƒç¼“å­˜æ–‡ä»¶(å°†è®¢é˜…urlã€å¾…é€šçŸ¥urlåˆ—è¡¨ä¿å­˜åˆ°ç¼“å­˜æ–‡ä»¶)\n\t    saveProperties(url);\n\t    //è§¦å‘é€šçŸ¥ç»™æ¶ˆè´¹è€…(ç±»åˆ«å¾…é€šçŸ¥urlåˆ—è¡¨)ï¼Œæ­¤listenerå°±æ˜¯RegistryDirectoryç±»\n\t    listener.notify(categoryList);\n\t}\n}\n```\nç„¶åæˆ‘ä»¬æ¥çœ‹RegistryDirectoryç±»çš„notifyæ–¹æ³•\n```java\npublic synchronized void notify(List<URL> urls) {\n\tList<URL> invokerUrls = new ArrayList<URL>();\n\tList<URL> routerUrls = new ArrayList<URL>();\n\tList<URL> configuratorUrls = new ArrayList<URL>();\n\t//éå†å¾…é€šçŸ¥åˆ—è¡¨ï¼Œæ ¹æ®categoryè¿›è¡Œåˆ†ç»„ï¼Œå¹¶åˆ†åˆ«ä¿å­˜åˆ°ä¸Šé¢å®šä¹‰çš„liståˆ—è¡¨ä¸­\n\tfor (URL url : urls) {\n\t    //è·å–urlåè®®\n\t    String protocol = url.getProtocol();\n\t    //è·å–urlåˆ†ç±»\n\t    String category = url.getParameter(Constants.CATEGORY_KEY, Constants.DEFAULT_CATEGORY);\n\t    if (Constants.ROUTERS_CATEGORY.equals(category)\n\t\t    || Constants.ROUTE_PROTOCOL.equals(protocol)) {\n\t\t//æ·»åŠ è·¯ç”±url\n\t\trouterUrls.add(url);\n\t    } else if (Constants.CONFIGURATORS_CATEGORY.equals(category)\n\t\t    || Constants.OVERRIDE_PROTOCOL.equals(protocol)) {\n\t\t//æ·»åŠ é…ç½®url\n\t\tconfiguratorUrls.add(url);\n\t    } else if (Constants.PROVIDERS_CATEGORY.equals(category)) {\n\t\t//æ·»åŠ æœåŠ¡æä¾›è€…url\n\t\tinvokerUrls.add(url);\n\t    } else {\n\t\t//ä¸æ”¯æŒçš„åˆ†ç±»\n\t\tlogger.warn(\"Unsupported category \" + category + \" in notified url: \" + url + \" from registry \" + getUrl().getAddress() + \" to consumer \" + NetUtils.getLocalHost());\n\t    }\n\t}\n\tif (configuratorUrls != null && !configuratorUrls.isEmpty()) {\n\t    //å°†urlè½¬æ¢æˆConfiguratorç±»å¹¶ä¿å­˜(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\t    this.configurators = toConfigurators(configuratorUrls);\n\t}\n\tif (routerUrls != null && !routerUrls.isEmpty()) {\n\t    //å°†è·¯ç”±urlè½¬æ¢æˆè·¯ç”±å¯¹è±¡(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\t    List<Router> routers = toRouters(routerUrls);\n\t    if (routers != null) {\n\t\t//ä¿å­˜è·¯ç”±(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\t\tsetRouters(routers);\n\t    }\n\t}\n\tList<Configurator> localConfigurators = this.configurators;\n\t//åˆå¹¶overrideå‚æ•°\n\tthis.overrideDirectoryUrl = directoryUrl;\n\tif (localConfigurators != null && !localConfigurators.isEmpty()) {\n\t    for (Configurator configurator : localConfigurators) {\n\t\t//æ ¹æ®configuratorè¦†ç›–overrideDirectoryUrlä¸­çš„å±æ€§ï¼Œ\n\t\t//æˆ–è€…å°†configuratorä¸­çš„å±æ€§æ·»åŠ åˆ°overrideDirectoryUrlä¸­\n\t\tthis.overrideDirectoryUrl = configurator.configure(overrideDirectoryUrl);\n\t    }\n\t}\n\t//åˆ·æ–°Invoker(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\trefreshInvoker(invokerUrls);\n}\n\n```\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥æŒ¨ä¸ªçœ‹ä¸‹ä¸Šé¢ç”¨åˆ°çš„æ–¹æ³•\n\n#### æ›´æ–°Configurator\n```java\n//å°†å¾…é€šçŸ¥urlè½¬æ¢æˆConfigurator\npublic static List<Configurator> toConfigurators(List<URL> urls) {\n\tif (urls == null || urls.isEmpty()) {\n\t    return Collections.emptyList();\n\t}\n\tList<Configurator> configurators = new ArrayList<Configurator>(urls.size());\n\t//éå†å¾…é€šçŸ¥urlåˆ—è¡¨\n\tfor (URL url : urls) {\n\t    if (Constants.EMPTY_PROTOCOL.equals(url.getProtocol())) {\n\t\t//åè®®ä¸ºemptyï¼Œåˆ™æ¸…ç©ºconfiguratorsï¼Œå¹¶è·³å‡ºå¾ªç¯\n\t\tconfigurators.clear();\n\t\tbreak;\n\t    }\n\t    //è·å–urlæ‰€æœ‰å‚æ•°\n\t    Map<String, String> override = new HashMap<String, String>(url.getParameters());\n\t    \n\t    //overrideçš„anyhostå‚æ•°å¯ä»¥è¢«è‡ªåŠ¨æ·»åŠ \n\t    //å®ƒä¸å¯ä»¥æ”¹å˜å¯¹å˜åŒ–ä¸­çš„urlçš„åˆ¤æ–­ï¼Œå› æ­¤éœ€è¦ç§»é™¤æ‰anyhostå‚æ•°\n\t    override.remove(Constants.ANYHOST_KEY);\n\t    if (override.size() == 0) {\n\t\tconfigurators.clear();\n\t\tcontinue;\n\t    }\n\t    //æ·»åŠ é…ç½®\n\t    configurators.add(configuratorFactory.getConfigurator(url));\n\t}\n\t//æ’åº\n\tCollections.sort(configurators);\n\treturn configurators;\n}\n```\n\n#### æ›´æ–°Router\n```java\n//å°†å¾…é€šçŸ¥urlè½¬æ¢æˆRouterå¯¹è±¡\nprivate List<Router> toRouters(List<URL> urls) {\n\tList<Router> routers = new ArrayList<Router>();\n\tif (urls == null || urls.isEmpty()) {\n\t    return routers;\n\t}\n\tif (urls != null && !urls.isEmpty()) {\n\t    //éå†å¾…é€šçŸ¥urlåˆ—è¡¨\n\t    for (URL url : urls) {\n\t\tif (Constants.EMPTY_PROTOCOL.equals(url.getProtocol())) {\n\t\t    //åè®®ä¸ºemptyçš„è¯ï¼Œç›´æ¥è¿”å›\n\t\t    continue;\n\t\t}\n\t\t//è·å–urlçš„routerå‚æ•°ï¼Œè¯¥å‚æ•°æ ‡è¯†äº†è·¯ç”±åè®®\n\t\tString routerType = url.getParameter(Constants.ROUTER_KEY);\n\t\tif (routerType != null && routerType.length() > 0) {\n\t\t    //è®¾ç½®è·¯ç”±åè®®\n\t\t    url = url.setProtocol(routerType);\n\t\t}\n\t\ttry {\n\t\t    //æ ¹æ®urlè·å–è·¯ç”±å®ä¾‹\n\t\t    Router router = routerFactory.getRouter(url);\n\t\t    if (!routers.contains(router)) {\n\t\t\t//æ·»åŠ è·¯ç”±\n\t\t\trouters.add(router);\n\t\t    }\n\t\t} catch (Throwable t) {\n\t\t    logger.error(\"convert router url to router error, url: \" + url, t);\n\t\t}\n\t    }\n\t}\n\treturn routers;\n}\n\nprotected void setRouters(List<Router> routers) {\n\t//å¤åˆ¶routersåˆ—è¡¨\n\trouters = routers == null ? new ArrayList<Router>() : new ArrayList<Router>(routers);\n\t\n\t//è·å–è·¯ç”±å·¥å‚çš„æ‰©å±•åç§°\n\tString routerkey = url.getParameter(Constants.ROUTER_KEY);\n\tif (routerkey != null && routerkey.length() > 0) {\n\t    //æ ¹æ® è·¯ç”±å·¥å‚æ‰©å±•å è·å– è·¯ç”±å·¥å‚æ‰©å±•å®ä¾‹\n\t    RouterFactory routerFactory = ExtensionLoader.getExtensionLoader(RouterFactory.class).getExtension(routerkey);\n\t    //æ ¹æ®urlè·å–è·¯ç”±å®ä¾‹ï¼Œå¹¶æ”¾å…¥routers\n\t    routers.add(routerFactory.getRouter(url));\n\t}\n\t//æ·»åŠ æ”¯æŒmockåè®®çš„invokeré€‰æ‹©å™¨\n\trouters.add(new MockInvokersSelector());\n\t//æ’åº\n\tCollections.sort(routers);\n\t//ä¿å­˜æœ€æ–°çš„è·¯ç”±ä¿¡æ¯\n\tthis.routers = routers;\n}\n```\n#### æ›´æ–°Invoker\nç„¶åæˆ‘ä»¬æ¥çœ‹refreshInvokeræ–¹æ³•\n```java\n/**\n * å°†å¾…é€šçŸ¥invoker urlè½¬æ¢æˆinvoker Mapï¼Œè½¬æ¢è§„åˆ™å¦‚ä¸‹ï¼š\n * 1ã€å¦‚æœurlå·²ç»è½¬æ¢æˆinvokerï¼Œåˆ™ä¸å†é‡æ–°å¼•ç”¨å¹¶ç›´æ¥ä»ç¼“å­˜ä¸­è·å–ï¼Œå¹¶æ³¨æ„urlä¸­çš„ä»»ä½•å‚æ•°æ›´æ”¹éƒ½å°†è¢«é‡æ–°å¼•ç”¨ã€‚\n * 2ã€å¦‚æœä¼ å…¥çš„invokeråˆ—è¡¨ä¸ä¸ºç©ºï¼Œåˆ™æ„å‘³ç€è¿™æ˜¯æœ€æ–°çš„è°ƒç”¨è€…åˆ—è¡¨\n * 3ã€å¦‚æœä¼ å…¥çš„invokeråˆ—è¡¨ä¸ºç©ºï¼Œåˆ™æ„å‘³ç€è¯¥è§„åˆ™åªæ˜¯ä¸€ä¸ªoverrideè§„åˆ™æˆ–è€…routeè§„åˆ™ï¼Œéœ€è¦é‡æ–°å¯¹æ¯”ä»¥å†³å®šæ˜¯å¦éœ€è¦é‡æ–°å¼•ç”¨\n */\nprivate void refreshInvoker(List<URL> invokerUrls) {\n\tif (invokerUrls != null && invokerUrls.size() == 1 && invokerUrls.get(0) != null\n\t\t&& Constants.EMPTY_PROTOCOL.equals(invokerUrls.get(0).getProtocol())) {\n\t    //emptyåè®®\n\t    //ç¦æ­¢è®¿é—®\n\t    this.forbidden = true;\n\t    this.methodInvokerMap = null;\n\t    //é”€æ¯æ‰€æœ‰çš„invokers\n\t    destroyAllInvokers();\n\t} else {\n\t    //å…è®¸è®¿é—®\n\t    this.forbidden = false;\n\t    //è®°å½•å½“å‰çš„ urlInvokerMap\n\t    Map<String, Invoker<T>> oldUrlInvokerMap = this.urlInvokerMap;\n\t    if (invokerUrls.isEmpty() && this.cachedInvokerUrls != null) {\n\t\t//æ”¶åˆ°çš„invokerUrlsä¸ºç©ºï¼Œä½†æ˜¯ç¼“å­˜ä¸­çš„ä¸ä¸ºç©ºï¼Œåˆ™ä½¿ç”¨å½“å‰ç¼“å­˜ä¸­çš„invoker\n\t\tinvokerUrls.addAll(this.cachedInvokerUrls);\n\t    } else {\n\t\tthis.cachedInvokerUrls = new HashSet<URL>();\n\t\t//ç¼“å­˜invokerUrlsåˆ—è¡¨ï¼Œæ–¹ä¾¿æ¯”è¾ƒ\n\t\tthis.cachedInvokerUrls.addAll(invokerUrls);\n\t    }\n\t    if (invokerUrls.isEmpty()) {\n\t\t//invoker urlåˆ—è¡¨ä¸ºç©ºï¼Œç›´æ¥è¿”å›\n\t\treturn;\n\t    }\n\t    //å°†invoker-urlè½¬æ¢æˆinvoker-map(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\t    Map<String, Invoker<T>> newUrlInvokerMap = toInvokers(invokerUrls);\n\t    \n\t    //å»ºç«‹ æ–¹æ³•åä¸invokerçš„æ˜ å°„(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\t    Map<String, List<Invoker<T>>> newMethodInvokerMap = toMethodInvokers(newUrlInvokerMap);\n\t   \n\t    //çŠ¶æ€æ”¹å˜\n\t    if (newUrlInvokerMap == null || newUrlInvokerMap.size() == 0) {\n\t\t//è½¬æ¢å‘ç”Ÿé”™è¯¯\n\t\tlogger.error(new IllegalStateException(\"urls to invokers error .invokerUrls.size :\" + invokerUrls.size() + \", invoker.size :0. urls :\" + invokerUrls.toString()));\n\t\treturn;\n\t    }\n\t    //ä¿å­˜æœ€æ–°çš„ methodInvokerMap(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\t    this.methodInvokerMap = multiGroup ? toMergeMethodInvokerMap(newMethodInvokerMap) : newMethodInvokerMap;\n\t    //ä¿å­˜æœ€æ–°çš„ urlInvokerMap\n\t    this.urlInvokerMap = newUrlInvokerMap;\n\t    try {\n\t\t//å…³é—­æœªä½¿ç”¨çš„invoker(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\t\tdestroyUnusedInvokers(oldUrlInvokerMap, newUrlInvokerMap);\n\t    } catch (Exception e) {\n\t\tlogger.warn(\"destroyUnusedInvokers error. \", e);\n\t    }\n\t}\n}\n```\n\n##### toInvokersæ–¹æ³•\n```java\n/**\n * å°†invoker-urlè½¬æ¢æˆinvokerï¼Œå¦‚æœurlå·²ç»è¢«å¼•ç”¨ï¼Œå°†ä¸ä¼šé‡æ–°å¼•ç”¨\n * @param urls æœåŠ¡æä¾›è€…url\n * dubbo://192.168.99.60:20880/com.alibaba.dubbo.demo.DemoService?anyhost=true&application=demo-provider&dubbo=2.0.0&generic=false&interface=com.alibaba.dubbo.demo.DemoService&methods=sayHello&pid=6640&side=provider&timestamp=1535449604077\n * @return invokers\n */\nprivate Map<String, Invoker<T>> toInvokers(List<URL> urls) {\n\tMap<String, Invoker<T>> newUrlInvokerMap = new HashMap<String, Invoker<T>>();\n\tif (urls == null || urls.isEmpty()) {\n\t    return newUrlInvokerMap;\n\t}\n\tSet<String> keys = new HashSet<String>();\n\t//è·å–å½“å‰urlæ”¯æŒçš„åè®®\n\tString queryProtocols = this.queryMap.get(Constants.PROTOCOL_KEY);\n\t//éå†urlsï¼Œæ£€æµ‹æ¯ä¸€ä¸ªproviderUrlæ˜¯å¦æ»¡è¶³å½“å‰è°ƒç”¨è€…urlçš„åè®®è¦æ±‚(queryProtocols)\n\tfor (URL providerUrl : urls) {\n\t    //å¦‚æœåœ¨referenceç«¯é…ç½®äº†åè®®protocolï¼Œåˆ™åªé€‰æ‹©åŒ¹é…çš„åè®®\n\t    if (queryProtocols != null && queryProtocols.length() > 0) {\n\t\tboolean accept = false;\n\t\t//å¯æ¥å—çš„åè®®æ•°ç»„\n\t\tString[] acceptProtocols = queryProtocols.split(\",\");\n\t\tfor (String acceptProtocol : acceptProtocols) {\n\t\t    if (providerUrl.getProtocol().equals(acceptProtocol)) {\n\t\t\t//å¦‚æœè¯¥æä¾›è€…urlçš„åè®®åœ¨å¯æ¥å—çš„åè®®èŒƒå›´å†…ï¼Œåˆ™è·³å‡ºå¾ªç¯\n\t\t\taccept = true;\n\t\t\tbreak;\n\t\t    }\n\t\t}\n\t\tif (!accept) {\n\t\t    //æ²¡æ‰¾åˆ°ï¼Œåˆ™åˆ¤æ–­ä¸‹ä¸€ä¸ªæœåŠ¡æä¾›è€…\n\t\t    continue;\n\t\t}\n\t    }\n\t    if (Constants.EMPTY_PROTOCOL.equals(providerUrl.getProtocol())) {\n\t        //æœåŠ¡æä¾›è€…åè®®ä¸ºemptyï¼Œåˆ™è¿›è¡Œä¸‹æ¬¡å¾ªç¯\n\t\tcontinue;\n\t    }\n\t    if (!ExtensionLoader.getExtensionLoader(Protocol.class).hasExtension(providerUrl.getProtocol())) {\n\t\t//ä¸æ”¯æŒçš„åè®®\n\t\tlogger.error(new IllegalStateException(\"Unsupported protocol \" + providerUrl.getProtocol() + \" in notified url: \" + providerUrl + \" from registry \" + getUrl().getAddress() + \" to consumer \" + NetUtils.getLocalHost()\n\t\t\t+ \", supported protocol: \" + ExtensionLoader.getExtensionLoader(Protocol.class).getSupportedExtensions()));\n\t\tcontinue;\n\t    }\n\t    //åˆå¹¶urlå‚æ•°(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\t    URL url = mergeUrl(providerUrl);\n\t    \n\t    //urlçš„å‚æ•°å·²ç»æ’è¿‡åº\n\t    //dubbo://192.168.99.60:20880/com.alibaba.dubbo.demo.DemoService?anyhost=true&application=demo-consumer&check=false&dubbo=2.0.0&generic=false&interface=com.alibaba.dubbo.demo.DemoService&methods=sayHello&pid=1880&qos.port=33333&register.ip=192.168.99.60&remote.timestamp=1535449604077&side=consumer&timestamp=1535449640995\n\t    String key = url.toFullString();\n\t    if (keys.contains(key)) {\n\t\t//é‡å¤çš„url\n\t\tcontinue;\n\t    }\n\t    keys.add(key);\n\t    //ç¼“å­˜keyæ˜¯urlï¼Œä¸ä¸æ¶ˆè´¹è€…ç«¯çš„å‚æ•°åˆå¹¶ï¼Œæ— è®ºæ¶ˆè´¹è€…å¦‚ä½•ç»„åˆå‚æ•°ï¼Œ\n            //å¦‚æœæœåŠ¡å™¨urlå‘ç”Ÿæ”¹å˜ï¼Œåˆ™é‡æ–°è¿›è¡Œå¼•ç”¨\n\t    Map<String, Invoker<T>> localUrlInvokerMap = this.urlInvokerMap;\n\t    //æ ¹æ®ç¼“å­˜keyè·å–invoker\n\t    Invoker<T> invoker = localUrlInvokerMap == null ? null : localUrlInvokerMap.get(key);\n\t    if (invoker == null) {\n\t\t//ä¸åœ¨ç¼“å­˜ä¸­ï¼Œé‡æ–°å¼•ç”¨\n\t\ttry {\n\t\t    boolean enabled = true;\n\t\t    //è·å–disabledå‚æ•°ã€enabledå‚æ•°ï¼Œæ¥åˆ¤æ–­æ˜¯å¦å¯ç”¨\n\t\t    if (url.hasParameter(Constants.DISABLED_KEY)) {\n\t\t\tenabled = !url.getParameter(Constants.DISABLED_KEY, false);\n\t\t    } else {\n\t\t\tenabled = url.getParameter(Constants.ENABLED_KEY, true);\n\t\t    }\n\t\t    if (enabled) {\n\t\t\t//å¯ä»¥å¼•ç”¨ï¼Œé‡æ–°å¼•ç”¨(åé¢ä¼šä»‹ç»)\n\t\t\tinvoker = new InvokerDelegate<T>(\n\t\t\t        //æ ¹æ®æœåŠ¡æ¥å£ã€è¿œç¨‹æœåŠ¡urlé‡æ–°å¼•ç”¨\n\t\t\t\tprotocol.refer(serviceType, url),\n\t\t\t\turl,\n\t\t\t\tproviderUrl\n\t\t\t);\n\t\t    }\n\t\t} catch (Throwable t) {\n\t\t    logger.error(\"Failed to refer invoker for interface:\" + serviceType + \",url:(\" + url + \")\" + t.getMessage(), t);\n\t\t}\n\t\tif (invoker != null) {\n\t\t    //ä¿å­˜æ–°çš„invokeråˆ°ç¼“å­˜\n\t\t    newUrlInvokerMap.put(key, invoker);\n\t\t}\n\t    } else {\n\t\tnewUrlInvokerMap.put(key, invoker);\n\t    }\n\t}\n\tkeys.clear();\n\treturn newUrlInvokerMap;\n}\n\n```\n##### toMethodInvokersæ–¹æ³•\n\n```java\n/**\n * è·å–Invokerå’Œmethodä¹‹é—´çš„æ˜ å°„å…³ç³»\n * @param invokersMap Invoker Map\n * @return Mapping relation between Invoker and method\n */\nprivate Map<String, List<Invoker<T>>> toMethodInvokers(Map<String, Invoker<T>> invokersMap) {\n\t//methodä¸invokeråˆ—è¡¨çš„æ˜ å°„\n\tMap<String, List<Invoker<T>>> newMethodInvokerMap = new HashMap<String, List<Invoker<T>>>();\n\t\n\t// According to the methods classification declared by the provider URL,\n\t// the methods is compatible with the registry to execute the filtered methods\n\tList<Invoker<T>> invokersList = new ArrayList<Invoker<T>>();\n\t\n\tif (invokersMap != null && invokersMap.size() > 0) {\n\t    //éå†invokers\n\t    for (Invoker<T> invoker : invokersMap.values()) {\n\t\t//è·å–æœåŠ¡æä¾›è€…æ–¹æ³•åˆ—è¡¨\n\t\tString parameter = invoker.getUrl().getParameter(Constants.METHODS_KEY);\n\t\tif (parameter != null && parameter.length() > 0) {\n\t\t    //é€—å·åˆ†éš”æ–¹æ³•\n\t\t    String[] methods = Constants.COMMA_SPLIT_PATTERN.split(parameter);\n\t\t    if (methods != null && methods.length > 0) {\n\t\t\tfor (String method : methods) {\n\t\t\t    if (method != null && method.length() > 0 && !Constants.ANY_VALUE.equals(method)) {\n\t\t\t\t//é€šè¿‡methodè·å–invokeråˆ—è¡¨\n\t\t\t\tList<Invoker<T>> methodInvokers = newMethodInvokerMap.get(method);\n\t\t\t\tif (methodInvokers == null) {\n\t\t\t\t    methodInvokers = new ArrayList<Invoker<T>>();\n\t\t\t\t    //æ·»åŠ æ–¹æ³•ã€invokeræ˜ å°„\n\t\t\t\t    newMethodInvokerMap.put(method, methodInvokers);\n\t\t\t\t}\n\t\t\t\tmethodInvokers.add(invoker);\n\t\t\t    }\n\t\t\t}\n\t\t    }\n\t\t}\n\t\t//æ·»åŠ invoker\n\t\tinvokersList.add(invoker);\n\t    }\n\t}\n\t//æ ¹æ®è·¯ç”±ç­›é€‰InvokersList(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\tList<Invoker<T>> newInvokersList = route(invokersList, null);\n\t\n\t//ä¿å­˜<*,newInvokersList>\n\tnewMethodInvokerMap.put(Constants.ANY_VALUE, newInvokersList);\n\t\n\tif (serviceMethods != null && serviceMethods.length > 0) {\n\t    //éå†æœåŠ¡methodåˆ—è¡¨,å¹¶ä»newMethodInvokerMapä¸­è·å–è¯¥methodå¯¹åº”çš„Invokeråˆ—è¡¨\n\t    //å¦‚æœæ²¡æœ‰è·å–åˆ°ï¼Œåˆ™å°†è¯¥methodæ˜ å°„åˆ°newInvokersListåˆ—è¡¨ä¸Š\n\t    for (String method : serviceMethods) {\n\t\tList<Invoker<T>> methodInvokers = newMethodInvokerMap.get(method);\n\t\tif (methodInvokers == null || methodInvokers.isEmpty()) {\n\t\t    methodInvokers = newInvokersList;\n\t\t}\n\t\t//æ ¹æ®è·¯ç”±ç­›é€‰invokeråˆ—è¡¨ï¼Œç„¶åä¿å­˜methodã€invokerListæ˜ å°„\n\t\tnewMethodInvokerMap.put(method, route(methodInvokers, method));\n\t    }\n\t}\n\tfor (String method : new HashSet<String>(newMethodInvokerMap.keySet())) {\n\t    List<Invoker<T>> methodInvokers = newMethodInvokerMap.get(method);\n\t    //æ’åºinvoker\n\t    Collections.sort(methodInvokers, InvokerComparator.getComparator());\n\t    //ä¸å¯å˜é›†åˆ\n\t    newMethodInvokerMap.put(method, Collections.unmodifiableList(methodInvokers));\n\t}\n\treturn Collections.unmodifiableMap(newMethodInvokerMap);\n}\n```\n###### routeæ–¹æ³•\n```java\n/**\n * æ ¹æ®è·¯ç”±ç­›é€‰InvokersList\n * Router è´Ÿè´£ä»å¤šä¸ª Invoker ä¸­æŒ‰è·¯ç”±è§„åˆ™é€‰å‡ºå­é›†ï¼Œæ¯”å¦‚è¯»å†™åˆ†ç¦»ï¼Œåº”ç”¨éš”ç¦»ç­‰\n * @param invokers\n * @param method\n * @return\n */\nprivate List<Invoker<T>> route(List<Invoker<T>> invokers, String method) {\n\t//åˆ›å»ºInvocationå¯¹è±¡\n\tInvocation invocation = new RpcInvocation(method, new Class<?>[0], new Object[0]);\n\t//è·å–è·¯ç”±åˆ—è¡¨\n\tList<Router> routers = getRouters();\n\tif (routers != null) {\n\t    for (Router router : routers) {\n\t\tif (router.getUrl() != null) {\n\t\t    //æ‰§è¡Œè·¯ç”±\n\t\t    invokers = router.route(invokers, getConsumerUrl(), invocation);\n\t\t}\n\t    }\n\t}\n\treturn invokers;\n}\n```\n\n##### toMergeMethodInvokerMapæ–¹æ³•\n```java\nprivate Map<String, List<Invoker<T>>> toMergeMethodInvokerMap(Map<String, List<Invoker<T>>> methodMap) {\n\tMap<String, List<Invoker<T>>> result = new HashMap<String, List<Invoker<T>>>();\n\tfor (Map.Entry<String, List<Invoker<T>>> entry : methodMap.entrySet()) {\n\t    //å½“å‰æ–¹æ³•å\n\t    String method = entry.getKey();\n\t    //å½“å‰invokers\n\t    List<Invoker<T>> invokers = entry.getValue();\n\t    //å°†invokersæŒ‰ç…§groupè¿›è¡Œåˆ†ç»„ï¼Œæ”¾å…¥åˆ°groupMapä¸­(<group,List<invokers>>)\n\t    Map<String, List<Invoker<T>>> groupMap = new HashMap<String, List<Invoker<T>>>();\n\t    for (Invoker<T> invoker : invokers) {\n\t\t//å½“å‰urlçš„group\n\t\tString group = invoker.getUrl().getParameter(Constants.GROUP_KEY, \"\");\n\t\tList<Invoker<T>> groupInvokers = groupMap.get(group);\n\t\tif (groupInvokers == null) {\n\t\t    groupInvokers = new ArrayList<Invoker<T>>();\n\t\t    groupMap.put(group, groupInvokers);\n\t\t}\n\t\tgroupInvokers.add(invoker);\n\t    }\n\t    if (groupMap.size() == 1) {\n\t\t//åªæœ‰ä¸€ä¸ªgroup\n\t\tresult.put(method, groupMap.values().iterator().next());\n\t    } else if (groupMap.size() > 1) {\n\t\t//å¤šä¸ªgroupçš„æƒ…å†µ\n\t\tList<Invoker<T>> groupInvokers = new ArrayList<Invoker<T>>();\n\t\tfor (List<Invoker<T>> groupList : groupMap.values()) {\n\t\t    //é’ˆå¯¹æ¯ä¸€ä¸ªgroupListåˆ›å»ºä¸€ä¸ªStaticDirectoryï¼Œç„¶åç”Ÿæˆä¸€ä¸ªinvokerå¹¶æ”¾å…¥groupInvokersä¸­\n\t\t    groupInvokers.add(cluster.join(new StaticDirectory<T>(groupList)));\n\t\t}\n\t\tresult.put(method, groupInvokers);\n\t    } else {\n\t\t//æ²¡æœ‰group\n\t\tresult.put(method, invokers);\n\t    }\n\t}\n\treturn result;\n}\n```\n![](img/toMergeMethodInvokerMap.png)\n\n##### é”€æ¯æ— ç”¨çš„invoker\n```java\n/**\n * æ£€æµ‹ç¼“å­˜ä¸­çš„invokeræ˜¯å¦éœ€è¦è¢«é”€æ¯\n * å¦‚æœè®¾ç½®urlå±æ€§ï¼šrefer.autodestroy=false\n * invokerså°†ä¼šåœ¨ä¸å‡å°‘çš„æƒ…å†µä¸‹å¢åŠ ï¼Œå¯èƒ½ä¼šæœ‰ä¸€ä¸ªå¼•ç”¨æ³„éœ²\n * @param oldUrlInvokerMap\n * @param newUrlInvokerMap\n */\nprivate void destroyUnusedInvokers(Map<String, Invoker<T>> oldUrlInvokerMap,Map<String, Invoker<T>> newUrlInvokerMap) {\n\tif (newUrlInvokerMap == null || newUrlInvokerMap.size() == 0) {\n\t    //å…³é—­æ‰€æœ‰çš„invoker\n\t    destroyAllInvokers();\n\t    return;\n\t}\n\tList<String> deleted = null;\n\tif (oldUrlInvokerMap != null) {\n\t    Collection<Invoker<T>> newInvokers = newUrlInvokerMap.values();\n\t    for (Map.Entry<String, Invoker<T>> entry : oldUrlInvokerMap.entrySet()) {\n\t\tif (!newInvokers.contains(entry.getValue())) {\n\t\t    //è€çš„invokeråœ¨æ–°çš„invokeråˆ—è¡¨ä¸­ä¸å­˜åœ¨\n\t\t    if (deleted == null) {\n\t\t\tdeleted = new ArrayList<String>();\n\t\t    }\n\t\t    //æ ‡è®°è¯¥è€çš„urlï¼Œåé¢ä¼šè¿›è¡Œåˆ é™¤\n\t\t    deleted.add(entry.getKey());\n\t\t}\n\t    }\n\t}\n\tif (deleted != null) {\n\t    for (String url : deleted) {\n\t\tif (url != null) {\n\t\t    //ä»è€çš„invoker-mapä¸­ç§»é™¤è¯¥urlï¼Œå¹¶å…³é—­è¯¥è€çš„invoker\n\t\t    Invoker<T> invoker = oldUrlInvokerMap.remove(url);\n\t\t    if (invoker != null) {\n\t\t\ttry {\n\t\t\t    //é”€æ¯è¯¥invoker\n\t\t\t    invoker.destroy();\n\t\t\t} catch (Exception e) {\n\t\t\t    logger.warn(\"destory invoker[\" + invoker.getUrl() + \"] faild. \" + e.getMessage(), e);\n\t\t\t}\n\t\t    }\n\t\t}\n\t    }\n\t}\n}\n```\n#### é‡æ–°å¼•ç”¨invoker\n\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ä¸Šé¢çš„toInvokersæ–¹æ³•ä¸­ï¼Œé‡æ–°å¼•ç”¨invokerçš„é€»è¾‘ï¼Œå³\n```java\nif (enabled) {\n\t//å¯ä»¥å¼•ç”¨ï¼Œé‡æ–°å¼•ç”¨\n\tinvoker = new InvokerDelegate<T>(\n\t\tprotocol.refer(serviceType, url),\n\t\turl,\n\t\tproviderUrl\n\t);\n}\n```\nè¿™é‡Œä¼šå…ˆè°ƒç”¨ProtocolListenerWrapperç±»çš„referæ–¹æ³•,ç„¶ååœ¨è¯¥æ–¹æ³•å†…ä¼šåœ¨è°ƒç”¨ProtocolFilterWrapperç±»çš„referæ–¹æ³•\n```java\npublic <T> Invoker<T> refer(Class<T> type, URL url) throws RpcException {\n\tif (Constants.REGISTRY_PROTOCOL.equals(url.getProtocol())) {\n\t    return protocol.refer(type, url);\n\t}\n\treturn new ListenerInvokerWrapper<T>(\n\t        //è°ƒç”¨ProtocolFilterWrapperç±»çš„referæ–¹æ³•è·å–åˆ°invoker\n\t\tprotocol.refer(type, url),\n\t\tCollections.unmodifiableList(\n\t\t      ExtensionLoader.getExtensionLoader(InvokerListener.class)\n\t\t\t\t     .getActivateExtension(url, Constants.INVOKER_LISTENER_KEY)\n\t));\n}\n```\næˆ‘ä»¬çœ‹ä¸‹ProtocolFilterWrapperç±»çš„referæ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•å†…éƒ¨ä¼šå»è°ƒç”¨DubboProtocolç±»çš„referæ–¹æ³•\n```java\n@Override\npublic <T> Invoker<T> refer(Class<T> type, URL url) throws RpcException {\n\tif (Constants.REGISTRY_PROTOCOL.equals(url.getProtocol())) {\n\t\treturn protocol.refer(type, url);\n\t}\n\t//æ„å»ºinvokeré“¾\n\treturn buildInvokerChain(\n\t\t//è°ƒç”¨DubboProtocolç±»çš„referæ–¹æ³•\n\t\tprotocol.refer(type, url), \n\t\t//reference.filter\n\t\tConstants.REFERENCE_FILTER_KEY, \n\t\t//consumer\n\t\tConstants.CONSUMER\n\t);\n}\n\n/**\n * æ„å»ºInvokeré“¾\n * @param invoker\n * @param key  \n * @param group \n */\nprivate static <T> Invoker<T> buildInvokerChain(final Invoker<T> invoker,String key, String group) {\n\tInvoker<T> last = invoker;\n\t//è·å–è¿‡æ»¤å™¨ï¼šConsumerContextFilterã€FutureFilterã€MonitorFilter\n\tList<Filter> filters = ExtensionLoader.getExtensionLoader(Filter.class).getActivateExtension(invoker.getUrl(), key, group);\n\tif (!filters.isEmpty()) {\n\t    for (int i = filters.size() - 1; i >= 0; i--) {\n\t\t//MonitorFilterã€FutureFilterã€ConsumerContextFilter\n\t\tfinal Filter filter = filters.get(i);\n\t\tfinal Invoker<T> next = last;\n\t\tlast = new Invoker<T>() {\n\t\t    @Override\n\t\t    public Class<T> getInterface() {\n\t\t\treturn invoker.getInterface();\n\t\t    }\n\t\t    @Override\n\t\t    public URL getUrl() {\n\t\t\treturn invoker.getUrl();\n\t\t    }\n\t\t    @Override\n\t\t    public boolean isAvailable() {\n\t\t\treturn invoker.isAvailable();\n\t\t    }\n\t\t    @Override\n\t\t    public Result invoke(Invocation invocation) throws RpcException {\n\t\t        //è°ƒç”¨filterçš„invokeæ–¹æ³•\n\t\t\treturn filter.invoke(next, invocation);\n\t\t    }\n\t\t    @Override\n\t\t    public void destroy() {\n\t\t\tinvoker.destroy();\n\t\t    }\n\t\t    @Override\n\t\t    public String toString() {\n\t\t\treturn invoker.toString();\n\t\t    }\n\t\t};\n\t    }\n\t}\n\treturn last;\n}\n```\nDubboProtocolç±»çš„referæ–¹æ³•\n```java\n/**\n * @param serviceType com.alibaba.dubbo.demo.DemoService\n * @param url \n * dubbo://192.168.99.60:20880/com.alibaba.dubbo.demo.DemoService?anyhost=true&application=demo-consumer&check=false&dubbo=2.0.0&generic=false&interface=com.alibaba.dubbo.demo.DemoService&methods=sayHello&pid=5624&qos.port=33333&register.ip=192.168.99.60&remote.timestamp=1535531661191&side=consumer&timestamp=1535531690333\n */\n@Override\npublic <T> Invoker<T> refer(Class<T> serviceType, URL url) throws RpcException {\n\t//åŠ è½½ä¼˜åŒ–åºåˆ—åŒ–ç±»\n\toptimizeSerialization(url);\n\t\n\t//åˆ›å»ºDubboInvoker\n\tDubboInvoker<T> invoker = new DubboInvoker<T>(\n\t\tserviceType,\n\t\turl,\n\t\t//åˆ›å»ºå®¢æˆ·ç«¯(åé¢å°èŠ‚ä¼šåˆ†æè¯¥æ–¹æ³•)\n\t\tgetClients(url),\n\t\t//å½“å‰å¯¹è±¡å·²åˆ›å»ºçš„invokeré›†åˆ\n\t\tinvokers\n\t);\n\t//å°†invokerä¿å­˜åˆ°invokersé›†åˆä¸­\n\tinvokers.add(invoker);\n\treturn invoker;\n}\n```\nè¯¥invokerä¸­æŒæœ‰ä¸€ä¸ªclientå¯¹è±¡ï¼Œé»˜è®¤æ˜¯NettyClientï¼Œåé¢å°èŠ‚ä¼šä»‹ç»è¯¥è¿‡ç¨‹ï¼Œæœ€ç»ˆç”Ÿæˆçš„Invokerå¦‚ä¸‹å›¾ï¼Œï¼š\n![](img/InvokerChain.png)\n\n#### registerConsumeræ³¨å†Œæ¶ˆè´¹è€…\n\næœ€åè°ƒç”¨ProviderConsumerRegTableç±»çš„registerConsumeræ–¹æ³•æ³¨å†Œæ¶ˆè´¹è€…\n```java\npublic static ConcurrentHashMap<String, Set<ConsumerInvokerWrapper>> consumerInvokers = new ConcurrentHashMap<String, Set<ConsumerInvokerWrapper>>();\n\n/**\n * æ³¨å†Œæ¶ˆè´¹è€…\n * @param invoker\n * @param registryUrl æ³¨å†Œä¸­å¿ƒurl\n * @param consumerUrl æ¶ˆè´¹è€…url\n * @param registryDirectory\n */\npublic static void registerConsumer(Invoker invoker, URL registryUrl, URL consumerUrl, RegistryDirectory registryDirectory) {\n\t//åˆ›å»ºConsumerInvokerWrapper\n\tConsumerInvokerWrapper wrapperInvoker = new ConsumerInvokerWrapper(invoker, registryUrl, consumerUrl, registryDirectory);\n\t//æœåŠ¡å”¯ä¸€æ ‡è¯†\n\tString serviceUniqueName = consumerUrl.getServiceKey();\n\t//æ ¹æ®æœåŠ¡å”¯ä¸€æ ‡è¯†è·å–invokers\n\tSet<ConsumerInvokerWrapper> invokers = consumerInvokers.get(serviceUniqueName);\n\tif (invokers == null) {\n\t    consumerInvokers.putIfAbsent(serviceUniqueName, new ConcurrentHashSet<ConsumerInvokerWrapper>());\n\t    invokers = consumerInvokers.get(serviceUniqueName);\n\t}\n\t//æ·»åŠ wrapperInvokeråˆ°ç¼“å­˜\n\tinvokers.add(wrapperInvoker);\n}\n```\n\nåˆ°æ­¤ä¸ºæ­¢ï¼Œæ•´ä¸ªæµç¨‹å°±ä»‹ç»å®Œæ¯•äº†ã€‚ä¸‹é¢å°èŠ‚å°†ä¼šä»‹ç»ä¸€ä¸‹æ³¨å†Œä¸­å¿ƒRegistryã€‚\n","tags":["dubbo"]},{"title":"Dubboæºç é˜…è¯»ä¹‹æ³¨å†Œä¸­å¿ƒ-Zookeeperæ³¨å†Œä¸­å¿ƒ","url":"/blog/2018/08/23/Dubboæºç é˜…è¯»ä¹‹æ³¨å†Œä¸­å¿ƒ-Zookeeperæ³¨å†Œä¸­å¿ƒ/","content":">æœ¬å°èŠ‚è®²è§£Zookeeperæ³¨å†Œä¸­å¿ƒçš„å®ç°\n\n\n### ZookeeperRegistryæ³¨å†Œä¸­å¿ƒ\nå…ˆæ¥çœ‹ä¸‹åé¢ä¼šç”¨åˆ°çš„æ¥å£ï¼š\n```java\n/**\n * èŠ‚ç‚¹ç›‘å¬\n */\npublic interface ChildListener {\n    /**\n     * èŠ‚ç‚¹å‘ç”Ÿæ”¹å˜\n     * @param path\n     * @param children\n     */\n    void childChanged(String path, List<String> children);\n}\n/**\n * è¿æ¥çŠ¶æ€ç›‘å¬å™¨\n */\npublic interface StateListener {\n    //æ–­å¼€è¿æ¥\n    int DISCONNECTED = 0;\n    //å·²è¿æ¥\n    int CONNECTED = 1;\n    //é‡æ–°è¿æ¥\n    int RECONNECTED = 2;\n\n    /**\n     * è¿æ¥çŠ¶æ€æ”¹å˜\n     * @param connected çŠ¶æ€å€¼\n     */\n    void stateChanged(int connected);\n}\n```\nç„¶åæˆ‘ä»¬æ¥çœ‹ZookeeperRegistryçš„å®ç°,è¯¥ç±»ç»§æ‰¿è‡ªFailbackRegistry,å› æ­¤å…·å¤‡äº†å‘ç”Ÿå¼‚å¸¸æ—¶è‡ªåŠ¨é‡è¯•çš„èƒ½åŠ›\n```java\npublic class ZookeeperRegistry extends FailbackRegistry {\n\n    private final static Logger logger = LoggerFactory.getLogger(ZookeeperRegistry.class);\n\n    /**\n     * é»˜è®¤çš„zkç«¯å£\n     */\n    private final static int DEFAULT_ZOOKEEPER_PORT = 2181;\n\n    /**\n     * é»˜è®¤çš„zkæ ¹èŠ‚ç‚¹\n     */\n    private final static String DEFAULT_ROOT = \"dubbo\";\n\n    /**\n     * zkæ ¹èŠ‚ç‚¹ï¼Œå¦‚ï¼š/dubbo\n     */\n    private final String root;\n\n    private final Set<String> anyServices = new ConcurrentHashSet<String>();\n\n    /**\n     * URLï¼šè®¢é˜…url,<èŠ‚ç‚¹ç›‘å¬äº‹ä»¶>\n     */\n    private final ConcurrentMap<URL, ConcurrentMap<NotifyListener, ChildListener>>\n            zkListeners = new ConcurrentHashMap<URL, ConcurrentMap<NotifyListener, ChildListener>>();\n\n    /**\n     * zkå®¢æˆ·ç«¯æ¥å£(æ”¯æŒå¤šç§å®¢æˆ·ç«¯å®ç°)\n     */\n    private final ZookeeperClient zkClient;\n\n    public ZookeeperRegistry(URL url, ZookeeperTransporter zookeeperTransporter) {\n        //è®¾ç½®æ³¨å†Œä¸­å¿ƒurl\n        super(url);\n        if (url.isAnyHost()) {\n            //host = 0.0.0.0 || anyhost = true\n            throw new IllegalStateException(\"registry address == null\");\n        }\n        //è·å–urlå‚æ•°group,æ ‡è¯†zkæ ¹èŠ‚ç‚¹åç§°,é»˜è®¤ä¸ºdubbo\n        String group = url.getParameter(Constants.GROUP_KEY, DEFAULT_ROOT);\n        if (!group.startsWith(Constants.PATH_SEPARATOR)) {\n            //æ·»åŠ å‰ç¼€ï¼Œå¦‚ï¼š/dubbo\n            group = Constants.PATH_SEPARATOR + group;\n        }\n        this.root = group;\n\n        //è°ƒç”¨zookeeperTransporteræ¥å£çš„connectæ–¹æ³•è¿æ¥åˆ°zkå®¢æˆ·ç«¯(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n        zkClient = zookeeperTransporter.connect(url);\n\n        //æ·»åŠ èŠ‚ç‚¹å˜æ›´äº‹ä»¶åˆ°AbstractZookeeperClientçˆ¶ç±»ä¸­çš„ç¼“å­˜é›†åˆå˜é‡ä¸­\n        zkClient.addStateListener(new StateListener() {\n            @Override\n            public void stateChanged(int state) {\n                if (state == RECONNECTED) {\n                    try {\n                        //é‡è¿äº‹ä»¶ï¼Œè¿›è¡Œæ¢å¤\n                        recover();\n                    } catch (Exception e) {\n                        logger.error(e.getMessage(), e);\n                    }\n                }\n            }\n        });\n    }\n\n    /**\n     * ç»™zkåœ°å€é™„åŠ é»˜è®¤ç«¯å£å·\n     * @param address\n     * @return\n     */\n    static String appendDefaultPort(String address) {\n        if (address != null && address.length() > 0) {\n            int i = address.indexOf(':');\n            if (i < 0) {\n                //æ·»åŠ zké»˜è®¤ç«¯å£2181ï¼Œå³ï¼šaddress:2181\n                return address + \":\" + DEFAULT_ZOOKEEPER_PORT;\n            } else if (Integer.parseInt(address.substring(i + 1)) == 0) {\n                //ç«¯å£ä¸º0çš„è¯ï¼Œåˆ™ä½¿ç”¨é»˜è®¤ç«¯å£\n                return address.substring(0, i + 1) + DEFAULT_ZOOKEEPER_PORT;\n            }\n        }\n        return address;\n    }\n\n    @Override\n    public boolean isAvailable() {\n        //è¿æ¥æ˜¯å¦å¯ç”¨\n        return zkClient.isConnected();\n    }\n\n    @Override\n    public void destroy() {\n        super.destroy();\n        try {\n            //é”€æ¯å®¢æˆ·ç«¯\n            zkClient.close();\n        } catch (Exception e) {\n            logger.warn(\"Failed to close zookeeper client \" + getUrl() + \", cause: \" + e.getMessage(), e);\n        }\n    }\n\n    @Override\n    protected void doRegister(URL url) {\n        try {\n            //æ‰§è¡Œæ³¨å†Œ dubbo://192.168.99.60:20880/com.alibaba.dubbo.demo.DemoService?anyhost=true&application=demo-provider&dubbo=2.0.0&generic=false&interface=com.alibaba.dubbo.demo.DemoService&methods=sayHello&pid=5312&side=provider&timestamp=1534994264738\n            //æ ¹æ®urlç¡®å®šèŠ‚ç‚¹è·¯å¾„ï¼›æ ¹æ®urlçš„dynamicå‚æ•°ç¡®å®šæ˜¯å¦æ˜¯ä¸´æ—¶èŠ‚ç‚¹\n\t    //å¦‚ï¼š/dubbo/com.alibaba.dubbo.demo.DemoService/providers/dubbo%3A%2F%2F192.168.99.60%3A20880%2Fcom.alibaba.dubbo.demo.DemoService%3Fanyhost%3Dtrue%26application%3Ddemo-provider%26dubbo%3D2.0.0%26generic%3Dfalse%26interface%3Dcom.alibaba.dubbo.demo.DemoService%26methods%3DsayHello%26pid%3D5312%26side%3Dprovider%26timestamp%3D1534994264738\n            //åœ¨zkä¸Šåˆ›å»ºèŠ‚ç‚¹\n\t    zkClient.create(toUrlPath(url), url.getParameter(Constants.DYNAMIC_KEY, true));\n        } catch (Throwable e) {\n            throw new RpcException(\"Failed to register \" + url + \" to zookeeper \" + getUrl() + \", cause: \" + e.getMessage(), e);\n        }\n    }\n\n    @Override\n    protected void doUnregister(URL url) {\n        try {\n            //æ‰§è¡Œå–æ¶ˆæ³¨å†Œ\n            //åˆ é™¤urlèŠ‚ç‚¹è·¯å¾„\n            zkClient.delete(toUrlPath(url));\n        } catch (Throwable e) {\n            throw new RpcException(\"Failed to unregister \" + url + \" to zookeeper \" + getUrl() + \", cause: \" + e.getMessage(), e);\n        }\n    }\n\n    @Override\n    protected void doUnsubscribe(URL url, NotifyListener listener) {\n        //æ‰§è¡Œå–æ¶ˆè®¢é˜…\n        //æ ¹æ®è®¢é˜…urlè·å–ç›‘å¬\n        ConcurrentMap<NotifyListener, ChildListener> listeners = zkListeners.get(url);\n        if (listeners != null) {\n            //æ ¹æ®NotifyListenerè·å–zkç›‘å¬\n            ChildListener zkListener = listeners.get(listener);\n            if (zkListener != null) {\n                //ä»zkä¸Šç§»é™¤èŠ‚ç‚¹ç›‘å¬\n                zkClient.removeChildListener(toUrlPath(url), zkListener);\n            }\n        }\n    }\n\n    /**\n     * æ‰§è¡Œè®¢é˜…\n     * @param url\n     * ä¾‹å¦‚ï¼š provider://192.168.99.60:20880/com.alibaba.dubbo.demo.DemoService?anyhost=true&application=demo-provider&category=configurators&check=false&dubbo=2.0.0&generic=false&interface=com.alibaba.dubbo.demo.DemoService&methods=sayHello&pid=6504&side=provider&timestamp=1534927826842\n     *       consumer://192.168.99.60/com.alibaba.dubbo.demo.DemoService?application=demo-consumer&category=providers,configurators,routers&check=false&dubbo=2.0.0&interface=com.alibaba.dubbo.demo.DemoService&methods=sayHello&pid=1880&qos.port=33333&side=consumer&timestamp=1535449640995\n     * @param listener ä¾‹å¦‚ï¼šOverrideListener\n     */\n    @Override\n    protected void doSubscribe(final URL url, final NotifyListener listener) {\n        try {\n            //æ‰§è¡Œè®¢é˜…\n            //æŸ¥çœ‹è®¢é˜…urlçš„interfaceå±æ€§æ˜¯å¦=*\n            if (Constants.ANY_VALUE.equals(url.getServiceInterface())) {\n                String root = toRootPath();\n                //è·å–è®¢é˜…urlçš„ç›‘å¬åˆ—è¡¨\n                ConcurrentMap<NotifyListener, ChildListener> listeners = zkListeners.get(url);\n                if (listeners == null) {\n                    zkListeners.putIfAbsent(url, new ConcurrentHashMap<NotifyListener, ChildListener>());\n                    listeners = zkListeners.get(url);\n                }\n                //è·å–listenerå¯¹åº”çš„zkç›‘å¬å™¨\n                ChildListener zkListener = listeners.get(listener);\n                if (zkListener == null) {\n                    //å¦‚æœzkç›‘å¬å™¨ä¸ºç©ºï¼Œåˆ™æ–°å»ºä¸€ä¸ªï¼Œå¹¶æ”¾å…¥zkListenersé›†åˆä¸­\n                    listeners.putIfAbsent(listener, new ChildListener() {\n                        @Override\n                        public void childChanged(String parentPath, List<String> currentChilds) {\n                            for (String child : currentChilds) {\n                                child = URL.decode(child);\n                                if (!anyServices.contains(child)) {\n                                    //è®°å½•èŠ‚ç‚¹child\n                                    anyServices.add(child);\n                                    //è®¢é˜…child\n                                    //æ·»åŠ interface = child\n                                    //æ·»åŠ check = false\n                                    subscribe(url.setPath(child).addParameters(Constants.INTERFACE_KEY,child,\n                                            Constants.CHECK_KEY, String.valueOf(false)), listener);\n                                }\n                            }\n                        }\n                    });\n                    zkListener = listeners.get(listener);\n                }\n                //åˆ›å»ºrootæŒä¹…åŒ–èŠ‚ç‚¹\n                zkClient.create(root, false);\n                //æ·»åŠ rootèŠ‚ç‚¹ç›‘å¬ï¼Œservicesä¸ºrootèŠ‚ç‚¹çš„å­èŠ‚ç‚¹åˆ—è¡¨\n                List<String> services = zkClient.addChildListener(root, zkListener);\n                if (services != null && !services.isEmpty()) {\n                    for (String service : services) {\n                        //å­èŠ‚ç‚¹\n                        service = URL.decode(service);\n                        anyServices.add(service);\n                        //è®¢é˜…å­èŠ‚ç‚¹\n                        subscribe(url.setPath(service).addParameters(Constants.INTERFACE_KEY, service,\n                                Constants.CHECK_KEY, String.valueOf(false)), listener);\n                    }\n                }\n            } else {\n                List<URL> urls = new ArrayList<URL>();\n                //éå†urlçš„ç±»åˆ«åˆ—è¡¨ /dubbo/com.alibaba.dubbo.demo.DemoService/configurators\n                for (String path : toCategoriesPath(url)) {\n\t\t    //æ ¹æ®è®¢é˜…urlè·å–ç›‘å¬\n                    ConcurrentMap<NotifyListener, ChildListener> listeners = zkListeners.get(url);\n                    if (listeners == null) {\n                        zkListeners.putIfAbsent(url, new ConcurrentHashMap<NotifyListener, ChildListener>());\n                        listeners = zkListeners.get(url);\n                    }\n                    ChildListener zkListener = listeners.get(listener);\n                    if (zkListener == null) {\n\t\t        //æ·»åŠ ä¸ºç©ºï¼Œåˆ™æ–°å»ºä¸€ä¸ªèŠ‚ç‚¹ç›‘å¬\n                        listeners.putIfAbsent(listener, new ChildListener() {\n                            @Override\n                            public void childChanged(String parentPath, List<String> currentChilds) {\n                                //æ‰§è¡Œé€šçŸ¥\n                                ZookeeperRegistry.this.notify(url, listener, toUrlsWithEmpty(url, parentPath, currentChilds));\n                            }\n                        });\n                        zkListener = listeners.get(listener);\n                    }\n                    //åˆ›å»ºpathèŠ‚ç‚¹,\n                    //å³ï¼š/dubbo/com.xxx.demoService/providers\n                    //å³ï¼š/dubbo/consumers  /dubbo/com.alibaba.dubbo.demo.DemoService/configurators\n                    zkClient.create(path, false);\n                    //æ·»åŠ pathèŠ‚ç‚¹ç›‘å¬zkListener\n                    List<String> children = zkClient.addChildListener(path, zkListener);\n                    if (children != null) {\n\t\t\t//empty://192.168.99.60:20880/com.alibaba.dubbo.demo.DemoService?anyhost=true&application=demo-provider&category=configurators&check=false&dubbo=2.0.0&generic=false&interface=com.alibaba.dubbo.demo.DemoService&methods=sayHello&pid=6504&side=provider&timestamp=1534927826842\n                        urls.addAll(toUrlsWithEmpty(url, path, children));\n                    }\n                }\n                //é€šçŸ¥æ¶ˆè´¹è€…(urlså³ä¸ºå¾…é€šçŸ¥çš„æ¶ˆæ¯)\n                notify(url, listener, urls);\n            }\n        } catch (Throwable e) {\n            throw new RpcException(\"Failed to subscribe \" + url + \" to zookeeper \" + getUrl() + \", cause: \" + e.getMessage(), e);\n        }\n    }\n\n    @Override\n    public List<URL> lookup(URL url) {\n        if (url == null) {\n            throw new IllegalArgumentException(\"lookup url == null\");\n        }\n        try {\n            //æ‰¾åˆ°çš„æ‰€æœ‰çš„å­èŠ‚ç‚¹\n            List<String> providers = new ArrayList<String>();\n            //éå†urlç±»åˆ«æ•°ç»„ /dubbo/com.alibaba.dubbo.demo.DemoService/providers\n            for (String path : toCategoriesPath(url)) {\n                //è·å–pathèŠ‚ç‚¹çš„å­èŠ‚ç‚¹\n                List<String> children = zkClient.getChildren(path);\n                if (children != null) {\n                    providers.addAll(children);\n                }\n            }\n            return toUrlsWithoutEmpty(url, providers);\n        } catch (Throwable e) {\n            throw new RpcException(\"Failed to lookup \" + url + \" from zookeeper \" + getUrl() + \", cause: \" + e.getMessage(), e);\n        }\n    }\n\n    /**\n     * å¦‚æœroot = /,åˆ™è¿”å› / ,å¦åˆ™è¿”å› /dubbo/\n     * @return\n     */\n    private String toRootDir() {\n        if (root.equals(Constants.PATH_SEPARATOR)) {\n            return root;\n        }\n        return root + Constants.PATH_SEPARATOR;\n    }\n\n    private String toRootPath() {\n        return root;\n    }\n\n    /**\n     * è·å–æœåŠ¡åœ°å€\n     * @param url\n     * @return  /dubbo/  æˆ–è€… /dubbo/ç¼–ç åçš„interface\n     */\n    private String toServicePath(URL url) {\n        String name = url.getServiceInterface();\n        if (Constants.ANY_VALUE.equals(name)) {\n            //interface = *ï¼Œåˆ™è¿”å›: /dubbo/\n            return toRootPath();\n        }\n        //è¿”å›ï¼š /dubbo/ç¼–ç åçš„interface\n        return toRootDir() + URL.encode(name);\n    }\n\n    /**\n     * æ ¹æ®urlè·å–ç±»åˆ«æ•°ç»„\n     * @param url\n     * @return\n     */\n    private String[] toCategoriesPath(URL url) {\n        String[] categories;\n        if (Constants.ANY_VALUE.equals(url.getParameter(Constants.CATEGORY_KEY))) {\n            //urlçš„categoryå‚æ•°=*ï¼Œåˆ™å–æ‰€æœ‰çš„ç±»åˆ«ï¼Œå³ categories = providersã€consumersã€routersã€configurators\n            categories = new String[]{\n\t\t\tConstants.PROVIDERS_CATEGORY, \n\t\t\tConstants.CONSUMERS_CATEGORY,\n\t\t\tConstants.ROUTERS_CATEGORY, \n\t\t\tConstants.CONFIGURATORS_CATEGORY\n\t    };\n        } else {\n            //å¦‚æœcategoryå‚æ•°ä¸ºç©ºï¼Œåˆ™å–é»˜è®¤ç±»åˆ«ï¼šproviders\n            categories = url.getParameter(Constants.CATEGORY_KEY, new String[]{Constants.DEFAULT_CATEGORY});\n        }\n        String[] paths = new String[categories.length];\n        for (int i = 0; i < categories.length; i++) {\n            //ä¾‹å¦‚ï¼š/dubbo/com.xxx.demoService/providers (interface != *)\n            //ä¾‹å¦‚ï¼š/dubbo/providers (interface = *)\n            paths[i] = toServicePath(url) + Constants.PATH_SEPARATOR + categories[i];\n        }\n        return paths;\n    }\n\n    /**\n     * è·å–urlå¯¹åº”çš„ç±»åˆ«åœ°å€\n     * /dubbo/com.alibaba.dubbo.demo.demoService/providers\n     * @param url\n     * @return\n     */\n    private String toCategoryPath(URL url) {\n        return toServicePath(url) + Constants.PATH_SEPARATOR + url.getParameter(Constants.CATEGORY_KEY, Constants.DEFAULT_CATEGORY);\n    }\n\n    /**\n     * è·å–urlå¯¹åº”çš„urlåœ°å€(å°†ä¼šåœ¨zkä¸Šåˆ›å»ºè¯¥åœ°å€)\n     * @param url\n     * @return /dubbo/com.alibaba.dubbo.demo.DemoService/providers/dubbo://192.168.99.60:20880/com.alibaba.dubbo.demo.DemoService?anyhost=true&application=demo-provider&dubbo=2.0.0&generic=false&interface=com.alibaba.dubbo.demo.DemoService&methods=sayHello&pid=7112&side=provider&timestamp=1534931882323\n     */\n    private String toUrlPath(URL url) {\n        return toCategoryPath(url) + Constants.PATH_SEPARATOR + URL.encode(url.toFullString());\n    }\n\n    /**\n     * è¿”å›å€¼ä¸ºç©ºçš„è¯ï¼Œä¸ä¼šè¿”å›é»˜è®¤å€¼\n     * @param consumer\n     * @param providers\n     * @return\n     */\n    private List<URL> toUrlsWithoutEmpty(URL consumer, List<String> providers) {\n        List<URL> urls = new ArrayList<URL>();\n        if (providers != null && !providers.isEmpty()) {\n            for (String provider : providers) {\n                //è§£ç \n                provider = URL.decode(provider);\n                if (provider.contains(\"://\")) {\n                    URL url = URL.valueOf(provider);\n                    //æ˜¯å¦åŒ¹é…\n                    if (UrlUtils.isMatch(consumer, url)) {\n                        urls.add(url);\n                    }\n                }\n            }\n        }\n        return urls;\n    }\n\n    /**\n     * å¦‚æœä¸ºç©ºçš„è¯ï¼Œåˆ™è¿”å›ä¸€ä¸ªé»˜è®¤å€¼\n     * @param consumer provider://192.168.99.60:20880/com.alibaba.dubbo.demo.DemoService?anyhost=true&application=demo-provider&category=configurators&check=false&dubbo=2.0.0&generic=false&interface=com.alibaba.dubbo.demo.DemoService&methods=sayHello&pid=6504&side=provider&timestamp=1534927826842\n     * @param path /dubbo/com.alibaba.dubbo.demo.DemoService/configurators\n     * @param providers\n     * @return\n     */\n    private List<URL> toUrlsWithEmpty(URL consumer, String path, List<String> providers) {\n        List<URL> urls = toUrlsWithoutEmpty(consumer, providers);\n        if (urls == null || urls.isEmpty()) {\n            int i = path.lastIndexOf('/');\n            //è·å–ç±»åˆ«\n            String category = i < 0 ? path : path.substring(i + 1);\n            //è®¾ç½®emptyåè®®ï¼Œå¹¶è®¾ç½®categoryå±æ€§\n            URL empty = consumer.setProtocol(Constants.EMPTY_PROTOCOL).addParameter(Constants.CATEGORY_KEY, category);\n            urls.add(empty);\n        }\n        return urls;\n    }\n}\n```\nå¯ä»¥çœ‹åˆ°zkæ³¨å†Œä¸­å¿ƒæ ¹æ®NotifyListeneræ¥å£ä¸RegistryDirectoryç±»è¿›è¡Œé€šä¿¡ï¼Œé€šè¿‡notifyæ–¹æ³•é€šçŸ¥æ¶ˆè´¹è€…æœ‰æ›´æ–°ã€‚é€šè¿‡ZookeeperClientä¸Zookeeperè¿›è¡Œäº¤äº’ã€‚\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹æ˜¯dubboæ˜¯å¦‚ä½•é€šè¿‡å·¥å‚åˆ›å»ºZookeeperRegistryå®ä¾‹çš„ã€‚\n\n### Zookeeperæ³¨å†Œä¸­å¿ƒå·¥å‚\nå…ˆæ¥çœ‹ä¸‹ZookeeperRegistryFactoryç±»ï¼Œè¯¥ç±»ç»§æ‰¿è‡ªAbstractRegistryFactoryï¼Œç”¨æ¥åˆ›å»ºå…·ä½“çš„ZookeeperRegistryå®ä¾‹\n```java\npublic class ZookeeperRegistryFactory extends AbstractRegistryFactory {\n\n    private ZookeeperTransporter zookeeperTransporter;\n\n    public void setZookeeperTransporter(ZookeeperTransporter zookeeperTransporter) {\n        this.zookeeperTransporter = zookeeperTransporter;\n    }\n   \n    /**\n     * @param url æ³¨å†Œä¸­å¿ƒurl\n     */\n    @Override\n    public Registry createRegistry(URL url) {\n        //åˆ›å»ºzkæ³¨å†Œä¸­å¿ƒ\n        return new ZookeeperRegistry(url, zookeeperTransporter);\n    }\n}\n```\nZookeeperTransporteræ˜¯ä¸€ä¸ªæ¥å£ï¼Œdubboæ”¯æŒå¤šä¸ªzkå®¢æˆ·ç«¯å®ç°ï¼Œä¾‹å¦‚Curatorã€ZkClientï¼Œè¯¥æ¥å£å°±æ˜¯ç”¨æ¥åˆ›å»ºå…·ä½“çš„å®¢æˆ·ç«¯å®ç°çš„ï¼Œå¯ä»¥çœ‹åˆ°é»˜è®¤æ˜¯ä½¿ç”¨curatorå®¢æˆ·ç«¯ã€‚\n```java\n@SPI(\"curator\")\npublic interface ZookeeperTransporter {\n    @Adaptive({Constants.CLIENT_KEY, Constants.TRANSPORTER_KEY})\n    ZookeeperClient connect(URL url);\n}\n\npublic class CuratorZookeeperTransporter implements ZookeeperTransporter {\n    @Override\n    public ZookeeperClient connect(URL url) {\n        //è¿”å›Curatorå®ç°\n        return new CuratorZookeeperClient(url);\n    }\n}\n\npublic class ZkclientZookeeperTransporter implements ZookeeperTransporter {\n    @Override\n    public ZookeeperClient connect(URL url) {\n        //è¿”å›Zkclientå®ç°\n        return new ZkclientZookeeperClient(url);\n    }\n}\n```\nä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹çœ‹å„ä¸ªZookeeperClientçš„å®ç°ã€‚\n\n#### ZookeeperClientæ¥å£\nè¯¥æ¥å£å®šä¹‰äº†ä¸€äº›é’ˆå¯¹zkçš„åŸºæœ¬æ“ä½œ\n```java\npublic interface ZookeeperClient {\n    /**\n     * åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹\n     * @param path èŠ‚ç‚¹è·¯å¾„\n     * @param ephemeral æ˜¯å¦ä¸´æ—¶èŠ‚ç‚¹\n     */\n    void create(String path, boolean ephemeral);\n\n    /**\n     * åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹\n     * @param path\n     */\n    void delete(String path);\n\n    /**\n     * è·å–æŸä¸ªèŠ‚ç‚¹çš„å­èŠ‚ç‚¹è·¯å¾„\n     * @param path\n     * @return\n     */\n    List<String> getChildren(String path);\n\n    /**\n     * æ·»åŠ èŠ‚ç‚¹ç›‘å¬å™¨\n     * @param path èŠ‚ç‚¹è·¯å¾„\n     * @param listener ç›‘å¬å™¨\n     * @return\n     */\n    List<String> addChildListener(String path, ChildListener listener);\n\n    /**\n     * ç§»é™¤èŠ‚ç‚¹ç›‘å¬å™¨\n     * @param path\n     * @param listener\n     */\n    void removeChildListener(String path, ChildListener listener);\n\n    /**\n     * æ·»åŠ å˜æ›´äº‹ä»¶ç›‘å¬\n     * @param listener\n     */\n    void addStateListener(StateListener listener);\n    /**\n     * ç§»é™¤å˜æ›´äº‹ä»¶ç›‘å¬\n     */\n    void removeStateListener(StateListener listener);\n    /**\n     * æ˜¯å¦å·²è¿æ¥\n     * @return\n     */\n    boolean isConnected();\n    /**\n     * å…³é—­\n     */\n    void close();\n    /**\n     * è·å–æ³¨å†Œä¸­å¿ƒurl\n     */\n    URL getUrl();\n}\n```\n##### AbstractZookeeperClientæŠ½è±¡ç±»\n```java\npublic abstract class AbstractZookeeperClient<TargetChildListener> implements ZookeeperClient {\n\n    protected static final Logger logger = LoggerFactory.getLogger(AbstractZookeeperClient.class);\n\n    /**\n     * æ³¨å†Œä¸­å¿ƒurl\n     */\n    private final URL url;\n\n    /**\n     * ç¼“å­˜ç›‘å¬\n     */\n    private final Set<StateListener> stateListeners = new CopyOnWriteArraySet<StateListener>();\n\n    /**\n     * èŠ‚ç‚¹ç›‘å¬ç¼“å­˜\n     */\n    private final ConcurrentMap<String, ConcurrentMap<ChildListener, TargetChildListener>>\n            childListeners = new ConcurrentHashMap<String, ConcurrentMap<ChildListener, TargetChildListener>>();\n\n    /**\n     * å®¢æˆ·ç«¯æ˜¯å¦å·²åœæ­¢\n     */\n    private volatile boolean closed = false;\n\n    public AbstractZookeeperClient(URL url) {\n        this.url = url;\n    }\n\n    @Override\n    public URL getUrl() {\n        return url;\n    }\n\n    @Override\n    public void create(String path, boolean ephemeral) {\n        int i = path.lastIndexOf('/');\n        if (i > 0) {\n            //è·å–åˆ°çˆ¶è·¯å¾„\n            String parentPath = path.substring(0, i);\n            if (!checkExists(parentPath)) {\n                //çˆ¶è·¯å¾„ä¸å­˜åœ¨çš„è¯ï¼Œè¿›è¡Œé€’å½’åˆ›å»º\n                create(parentPath, false);\n            }\n        }\n        if (ephemeral) {\n            //åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹\n            createEphemeral(path);\n        } else {\n            //åˆ›å»ºæŒä¹…èŠ‚ç‚¹\n            createPersistent(path);\n        }\n    }\n\n    @Override\n    public void addStateListener(StateListener listener) {\n        stateListeners.add(listener);\n    }\n    @Override\n    public void removeStateListener(StateListener listener) {\n        stateListeners.remove(listener);\n    }\n    public Set<StateListener> getSessionListeners() {\n        return stateListeners;\n    }\n    @Override\n    public List<String> addChildListener(String path, final ChildListener listener) {\n        //ä»ç¼“å­˜ä¸­è·å–pathèŠ‚ç‚¹çš„ç›‘å¬\n        ConcurrentMap<ChildListener, TargetChildListener> listeners = childListeners.get(path);\n        if (listeners == null) {\n            childListeners.putIfAbsent(path, new ConcurrentHashMap<ChildListener, TargetChildListener>());\n            listeners = childListeners.get(path);\n        }\n        TargetChildListener targetListener = listeners.get(listener);\n        if (targetListener == null) {\n            //ä¸ºèŠ‚ç‚¹pathæ–°åˆ›å»ºä¸€ä¸ªç›‘å¬ï¼Œå¹¶æ”¾å…¥listenersä¸­\n            listeners.putIfAbsent(listener, createTargetChildListener(path, listener));\n            targetListener = listeners.get(listener);\n        }\n        //æ·»åŠ ç›®æ ‡èŠ‚ç‚¹ç›‘å¬\n        return addTargetChildListener(path, targetListener);\n    }\n\n    @Override\n    public void removeChildListener(String path, ChildListener listener) {\n        //ä»ç¼“å­˜ä¸­è·å–pathèŠ‚ç‚¹çš„ç›‘å¬\n        ConcurrentMap<ChildListener, TargetChildListener> listeners = childListeners.get(path);\n        if (listeners != null) {\n            //ä»ç¼“å­˜ä¸­ç§»é™¤ç›‘å¬listener\n            TargetChildListener targetListener = listeners.remove(listener);\n            if (targetListener != null) {\n                //ç§»é™¤ç›®æ ‡èŠ‚ç‚¹çš„ç›‘å¬targetListener\n                removeTargetChildListener(path, targetListener);\n            }\n        }\n    }\n\n    /**\n     * çŠ¶æ€å˜æ›´äº‹ä»¶\n     * @param state\n     */\n    protected void stateChanged(int state) {\n        //éå†æ‰€æœ‰çš„ç›‘å¬å™¨\n        for (StateListener sessionListener : getSessionListeners()) {\n\t    //æ‰§è¡Œå˜æ›´äº‹ä»¶\n            sessionListener.stateChanged(state);\n        }\n    }\n\n    @Override\n    public void close() {\n        if (closed) {\n\t    //å·²å…³é—­\n            return;\n        }\n        closed = true;\n        try {\n            doClose();\n        } catch (Throwable t) {\n            logger.warn(t.getMessage(), t);\n        }\n    }\n    //************æ¨¡æ¿æ–¹æ³•************\n    //å…³é—­\n    protected abstract void doClose();\n    //åˆ›å»ºæŒä¹…èŠ‚ç‚¹\n    protected abstract void createPersistent(String path);\n    //åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹\n    protected abstract void createEphemeral(String path);\n    //æ£€æµ‹èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨\n    protected abstract boolean checkExists(String path);\n    //åˆ›å»ºç›®æ ‡èŠ‚ç‚¹ç›‘å¬\n    protected abstract TargetChildListener createTargetChildListener(String path, ChildListener listener);\n    //æ·»åŠ ç›®æ ‡èŠ‚ç‚¹ç›‘å¬\n    protected abstract List<String> addTargetChildListener(String path, TargetChildListener listener);\n    //ç§»é™¤ç›®æ ‡èŠ‚ç‚¹ç›‘å¬\n    protected abstract void removeTargetChildListener(String path, TargetChildListener listener);\n}\n```\n##### CuratorZookeeperClientå®ç°\n```java\npublic class CuratorZookeeperClient extends AbstractZookeeperClient<CuratorWatcher> {\n    \n    //Curatorå®¢æˆ·ç«¯ï¼Œå¯¹zkçš„æ“ä½œéƒ½æ˜¯ç”±å®ƒæ¥å®Œæˆ\n    private final CuratorFramework client;\n\n    public CuratorZookeeperClient(URL url) {\n        //è®¾ç½®æ³¨å†Œä¸­å¿ƒurl\n        super(url);\n        try {\n            CuratorFrameworkFactory.Builder builder = CuratorFrameworkFactory.builder()\n                    //æŒ‡å®šæ³¨å†Œä¸­å¿ƒurlåœ°å€,å¤šä¸ªåœ°å€ä½¿ç”¨é€—å·åˆ†éš”\n                    .connectString(url.getBackupAddress())\n                    //è®¾ç½®é‡è¯•ç­–ç•¥ï¼Œæœ€å¤§é‡è¯•1æ¬¡ï¼Œé‡è¯•é—´éš”1000æ¯«ç§’\n                    .retryPolicy(new RetryNTimes(1, 1000))\n                    //è®¾ç½®è¿æ¥è¶…æ—¶,å•ä½ms,é»˜è®¤1500ms,è¿™é‡Œè®¾ç½®5ç§’\n                    .connectionTimeoutMs(5000);\n            //è·å–urlçš„username:password\n            String authority = url.getAuthority();\n            if (authority != null && authority.length() > 0) {\n                //æ·»åŠ æˆæƒ\n                builder = builder.authorization(\"digest\", authority.getBytes());\n            }\n            //ç”Ÿæˆcuratorå®¢æˆ·ç«¯\n            client = builder.build();\n            //ç›‘å¬å®¢æˆ·ç«¯é“¾æ¥çŠ¶æ€\n            client.getConnectionStateListenable().addListener(new ConnectionStateListener() {\n                @Override\n                public void stateChanged(CuratorFramework client, ConnectionState state) {\n                    if (state == ConnectionState.LOST) {\n                        //æ–­å¼€çŠ¶æ€ï¼Œåˆ™è§¦å‘é“¾æ¥æ–­å¼€äº‹ä»¶\n                        CuratorZookeeperClient.this.stateChanged(StateListener.DISCONNECTED);\n                    } else if (state == ConnectionState.CONNECTED) {\n                        //å·²è¿æ¥çŠ¶æ€ï¼Œåˆ™è§¦å‘é“¾æ¥äº‹ä»¶\n                        CuratorZookeeperClient.this.stateChanged(StateListener.CONNECTED);\n                    } else if (state == ConnectionState.RECONNECTED) {\n                        //é‡è¿çŠ¶æ€ï¼Œåˆ™è§¦å‘é‡è¿äº‹ä»¶\n                        CuratorZookeeperClient.this.stateChanged(StateListener.RECONNECTED);\n                    }\n                }\n            });\n            //å¯åŠ¨å®¢æˆ·ç«¯\n            client.start();\n        } catch (Exception e) {\n            throw new IllegalStateException(e.getMessage(), e);\n        }\n    }\n\n    @Override\n    public void createPersistent(String path) {\n        try {\n            //åˆ›å»ºæŒä¹…åŒ–èŠ‚ç‚¹path\n            client.create().forPath(path);\n        } catch (NodeExistsException e) {\n        } catch (Exception e) {\n            throw new IllegalStateException(e.getMessage(), e);\n        }\n    }\n\n    @Override\n    public void createEphemeral(String path) {\n        try {\n            //åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹path\n            client.create().withMode(CreateMode.EPHEMERAL).forPath(path);\n        } catch (NodeExistsException e) {\n        } catch (Exception e) {\n            throw new IllegalStateException(e.getMessage(), e);\n        }\n    }\n\n    @Override\n    public void delete(String path) {\n        try {\n            //åˆ é™¤èŠ‚ç‚¹path\n            client.delete().forPath(path);\n        } catch (NoNodeException e) {\n        } catch (Exception e) {\n            throw new IllegalStateException(e.getMessage(), e);\n        }\n    }\n\n    @Override\n    public List<String> getChildren(String path) {\n        try {\n            //è·å–pathèŠ‚ç‚¹çš„å­èŠ‚ç‚¹åˆ—è¡¨\n            return client.getChildren().forPath(path);\n        } catch (NoNodeException e) {\n            return null;\n        } catch (Exception e) {\n            throw new IllegalStateException(e.getMessage(), e);\n        }\n    }\n\n    @Override\n    public boolean checkExists(String path) {\n        try {\n            //æ£€æµ‹pathèŠ‚ç‚¹æ˜¯å¦å·²å­˜åœ¨\n            if (client.checkExists().forPath(path) != null) {\n                return true;\n            }\n        } catch (Exception e) {\n        }\n        return false;\n    }\n    @Override\n    public boolean isConnected() {\n        //æ˜¯å¦å·²è¿æ¥çŠ¶æ€\n        return client.getZookeeperClient().isConnected();\n    }\n\n    @Override\n    public void doClose() {\n        //å…³é—­å®¢æˆ·ç«¯\n        client.close();\n    }\n\n    @Override\n    public CuratorWatcher createTargetChildListener(String path, ChildListener listener) {\n        //æ–°åˆ›å»ºä¸€ä¸ªç›®æ ‡èŠ‚ç‚¹ç›‘å¬\n        return new CuratorWatcherImpl(listener);\n    }\n\n    @Override\n    public List<String> addTargetChildListener(String path, CuratorWatcher listener) {\n        try {\n            //è·å–pathå­èŠ‚ç‚¹ï¼Œå¹¶æ·»åŠ ç›‘å¬\n            return client.getChildren().usingWatcher(listener).forPath(path);\n        } catch (NoNodeException e) {\n            return null;\n        } catch (Exception e) {\n            throw new IllegalStateException(e.getMessage(), e);\n        }\n    }\n\n    @Override\n    public void removeTargetChildListener(String path, CuratorWatcher listener) {\n        //ç§»é™¤ç›‘å¬\n        ((CuratorWatcherImpl) listener).unwatch();\n    }\n   \n    /**\n     * è¯¥å†…éƒ¨ç±»å®ç°äº†CuratorWatcheræ¥å£\n     */\n    private class CuratorWatcherImpl implements CuratorWatcher {\n        //ç›‘å¬\n        private volatile ChildListener listener;\n        public CuratorWatcherImpl(ChildListener listener) {\n            this.listener = listener;\n        }\n        /**\n         * å–æ¶ˆç›‘å¬\n         */\n        public void unwatch() {\n            this.listener = null;\n        }\n        @Override\n        public void process(WatchedEvent event) throws Exception {\n            if (listener != null) {\n                //å˜æ›´èŠ‚ç‚¹\n                String path = event.getPath() == null ? \"\" : event.getPath();\n                //è§¦å‘å˜æ›´äº‹ä»¶\n                listener.childChanged(path,\n                        //å¦‚æœpathä¸ºç©ºï¼Œcuratorä½¿ç”¨watcherå°†ä¼šæŠ›å‡ºå¼‚å¸¸\n                        //å¦‚æœå®¢æˆ·ç«¯è¿æ¥ã€æ–­å¼€è¿æ¥æœåŠ¡å™¨ï¼Œzookeeperå°†ä¼šæ’é˜Ÿwatched eventäº‹ä»¶\n                        StringUtils.isNotEmpty(path)\n                                //ä¸ºpathçš„å­èŠ‚ç‚¹å¢åŠ ç›‘å¬(å½“å‰CuratorWatcherImpl,åªèƒ½ä½¿ç”¨1æ¬¡)\n                                ? client.getChildren().usingWatcher(this).forPath(path)\n                                : Collections.<String>emptyList());\n            }\n        }\n    }\n}\n```\n##### ZkclientZookeeperClientå®ç°\n```java\npublic class ZkclientZookeeperClient extends AbstractZookeeperClient<IZkChildListener> {\n    /**\n     * ZkClientåŒ…è£…ç±»ï¼Œä¸‹é¢çš„æ“ä½œéƒ½ä¼šäº¤ç»™å®ƒæ¥æ‰§è¡Œ\n     */\n    private final ZkClientWrapper client;\n\n    private volatile KeeperState state = KeeperState.SyncConnected;\n\n    public ZkclientZookeeperClient(URL url) {\n        //è®¾ç½®æ³¨å†Œä¸­å¿ƒåœ°å€\n        super(url);\n        //åˆ›å»ºzkClientå®¢æˆ·ç«¯\n        client = new ZkClientWrapper(url.getBackupAddress(), 30000);\n        //æ·»åŠ ç›‘å¬\n        client.addListener(new IZkStateListener() {\n            @Override\n            public void handleStateChanged(KeeperState state) throws Exception {\n\t\t//è®¾ç½®å½“å‰çŠ¶æ€\n\t\tZkclientZookeeperClient.this.state = state;\n                if (state == KeeperState.Disconnected) {\n                    //è§¦å‘æ–­å¼€è¿æ¥äº‹ä»¶\n                    stateChanged(StateListener.DISCONNECTED);\n                } else if (state == KeeperState.SyncConnected) {\n                    //è§¦å‘è¿æ¥æˆåŠŸäº‹ä»¶\n                    stateChanged(StateListener.CONNECTED);\n                }\n            }\n            @Override\n            public void handleNewSession() throws Exception {\n                //è§¦å‘é‡æ–°è¿æ¥äº‹ä»¶\n                stateChanged(StateListener.RECONNECTED);\n            }\n        });\n        client.start();\n    }\n    @Override\n    public void createPersistent(String path) {\n        try {\n            client.createPersistent(path);\n        } catch (ZkNodeExistsException e) {\n        }\n    }\n    @Override\n    public void createEphemeral(String path) {\n        try {\n            client.createEphemeral(path);\n        } catch (ZkNodeExistsException e) {\n        }\n    }\n    @Override\n    public void delete(String path) {\n        try {\n            client.delete(path);\n        } catch (ZkNoNodeException e) {\n        }\n    }\n    @Override\n    public List<String> getChildren(String path) {\n        try {\n            return client.getChildren(path);\n        } catch (ZkNoNodeException e) {\n            return null;\n        }\n    }\n    @Override\n    public boolean checkExists(String path) {\n        try {\n            return client.exists(path);\n        } catch (Throwable t) {\n        }\n        return false;\n    }\n    @Override\n    public boolean isConnected() {\n        return state == KeeperState.SyncConnected;\n    }\n    @Override\n    public void doClose() {\n        client.close();\n    }\n    @Override\n    public IZkChildListener createTargetChildListener(String path, final ChildListener listener) {\n        return new IZkChildListener() {\n            @Override\n            public void handleChildChange(String parentPath, List<String> currentChilds) throws Exception {\n                //è§¦å‘èŠ‚ç‚¹å˜æ›´äº‹ä»¶\n                listener.childChanged(parentPath, currentChilds);\n            }\n        };\n    }\n    @Override\n    public List<String> addTargetChildListener(String path, final IZkChildListener listener) {\n        return client.subscribeChildChanges(path, listener);\n    }\n    @Override\n    public void removeTargetChildListener(String path, IZkChildListener listener) {\n        client.unsubscribeChildChanges(path, listener);\n    }\n}\n```\n###### ZkClientWrapperåŒ…è£…ç±»\nZkclientåŒ…è£…ç±»å¯ä»¥åœ¨è¿æ¥å¤±æ•ˆåè‡ªåŠ¨ç›‘æ§è¿æ¥çš„çŠ¶æ€ï¼Œä½¿ç”¨æ–¹å¼ä¸curatorä¸€è‡´\n```java\npublic class ZkClientWrapper {\n\n    /**\n     * è·å–å®¢æˆ·ç«¯è¶…æ—¶æ—¶é—´\n     */\n    private long timeout;\n    /**\n     * ZkClientå®¢æˆ·ç«¯\n     */\n    private ZkClient client;\n    /**\n     * å½“å‰çŠ¶æ€\n     */\n    private volatile KeeperState state;\n\n    /**\n     * å¯ç›‘å¬çš„FutureTask\n     */\n    private ListenableFutureTask<ZkClient> listenableFutureTask;\n    /**\n     * å®¢æˆ·ç«¯æ˜¯å¦å·²å¯åŠ¨\n     */\n    private volatile boolean started = false;\n\n    /**\n     * @param serverAddr æ³¨å†Œä¸­å¿ƒurl\n     */\n    public ZkClientWrapper(final String serverAddr, long timeout) {\n        //è®¾ç½®è¶…æ—¶\n        this.timeout = timeout;\n\n        //åˆ›å»ºä¸€ä¸ªFutureTaskï¼Œç”¨æ¥åˆ›å»ºzkClientå®¢æˆ·ç«¯\n        listenableFutureTask = ListenableFutureTask.create(new Callable<ZkClient>() {\n            @Override\n            public ZkClient call() throws Exception {\n\t        //åˆ›å»ºZkClientå®¢æˆ·ç«¯\n                return new ZkClient(serverAddr, Integer.MAX_VALUE);\n            }\n        });\n    }\n   \n    /**\n     * å¯åŠ¨zkclient\n     */\n    public void start() {\n        if (!started) {\n            //æ–°å»ºå®ˆæŠ¤çº¿ç¨‹ï¼Œåˆ›å»ºzkClientå®¢æˆ·ç«¯\n            Thread connectThread = new Thread(listenableFutureTask);\n            connectThread.setName(\"DubboZkclientConnector\");\n            connectThread.setDaemon(true);\n            connectThread.start();\n            try {\n                //è·å–æ–°åˆ›å»ºçš„å®¢æˆ·ç«¯\n                client = listenableFutureTask.get(timeout, TimeUnit.MILLISECONDS);\n            } catch (Throwable t) {\n\t        //è·å–clientè¶…æ—¶\n                logger.error(\"Timeout! zookeeper server can not be connected in : \" + timeout + \"ms!\", t);\n            }\n            started = true;\n        } else {\n            logger.warn(\"Zkclient has already been started!\");\n        }\n    }\n  \n    /**\n     * æ·»åŠ ç›‘å¬listener\n     */\n    public void addListener(final IZkStateListener listener) {\n        //ä½¿ç”¨listenableFutureTaskç›‘å¬clientçš„åˆ›å»ºï¼Œclientåˆ›å»ºæˆåŠŸååœ¨è®¢é˜…è¯¥listener\n        listenableFutureTask.addListener(new Runnable() {\n            @Override\n            public void run() {\n                try {\n                    client = listenableFutureTask.get();\n                    //è·å–åˆ°å®¢æˆ·ç«¯åï¼Œè®¢é˜…listener\n                    client.subscribeStateChanges(listener);\n                } catch (InterruptedException e) {\n                    logger.warn(Thread.currentThread().getName() + \" was interrupted unexpectedly, which may cause unpredictable exception!\");\n                } catch (ExecutionException e) {\n                    logger.error(\"Got an exception when trying to create zkclient instance, can not connect to zookeeper server, please check!\", e);\n                }\n            }\n        });\n    }\n\n    public boolean isConnected() {\n        //æ˜¯å¦å·²è¿æ¥\n        return client != null && state == KeeperState.SyncConnected;\n    }\n\n    public void createPersistent(String path) {\n        Assert.notNull(client, new IllegalStateException(\"Zookeeper is not connected yet!\"));\n        //åˆ›å»ºæŒä¹…åŒ–èŠ‚ç‚¹\n        client.createPersistent(path, true);\n    }\n\n    public void createEphemeral(String path) {\n        Assert.notNull(client, new IllegalStateException(\"Zookeeper is not connected yet!\"));\n        //åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹\n        client.createEphemeral(path);\n    }\n\n    public void delete(String path) {\n        Assert.notNull(client, new IllegalStateException(\"Zookeeper is not connected yet!\"));\n        //åˆ é™¤èŠ‚ç‚¹\n        client.delete(path);\n    }\n\n    public List<String> getChildren(String path) {\n        Assert.notNull(client, new IllegalStateException(\"Zookeeper is not connected yet!\"));\n        //è·å–pathèŠ‚ç‚¹çš„å­èŠ‚ç‚¹\n        return client.getChildren(path);\n    }\n\n    public boolean exists(String path) {\n        Assert.notNull(client, new IllegalStateException(\"Zookeeper is not connected yet!\"));\n        //åˆ¤æ–­pathèŠ‚ç‚¹æ˜¯å¦å­˜åœ¨\n        return client.exists(path);\n    }\n\n    public void close() {\n        Assert.notNull(client, new IllegalStateException(\"Zookeeper is not connected yet!\"));\n        client.close();\n    }\n\n    public List<String> subscribeChildChanges(String path, final IZkChildListener listener) {\n        Assert.notNull(client, new IllegalStateException(\"Zookeeper is not connected yet!\"));\n        //è®¢é˜…pathèŠ‚ç‚¹å˜æ›´äº‹ä»¶\n        return client.subscribeChildChanges(path, listener);\n    }\n\n    public void unsubscribeChildChanges(String path, IZkChildListener listener) {\n        Assert.notNull(client, new IllegalStateException(\"Zookeeper is not connected yet!\"));\n        //å–æ¶ˆè®¢é˜…pathèŠ‚ç‚¹å˜æ›´äº‹ä»¶\n        client.unsubscribeChildChanges(path, listener);\n    }\n}\n```\n\nå…³äºzkæ³¨å†Œä¸­å¿ƒçš„å†…å®¹å°±ä»‹ç»åˆ°è¿™é‡Œï¼Œä¸‹ä¸€å°èŠ‚ä»‹ç»å…¶ä»–æ³¨å†Œä¸­å¿ƒçš„å®ç°ã€‚\n\n","tags":["dubbo"]},{"title":"ã€Šk8sæƒå¨æŒ‡å—ã€‹- ç¬”è®°","url":"/blog/2018/08/19/k8sæƒå¨æŒ‡å—-ç¬”è®°/","content":"Kubernetesæ˜¯åŸºäºå®¹å™¨æŠ€æœ¯ï¼Œç›®çš„æ˜¯å®ç°èµ„æºåŠ¨æ€ç®¡ç†ï¼Œä»¥åŠè·¨å¤šä¸ªæ•°æ®ä¸­å¿ƒçš„èµ„æºåˆ©ç”¨ç‡çš„æœ€å¤§åŒ–çš„åˆ†å¸ƒå¼æ¶æ„æ–¹æ¡ˆã€‚å¦‚æœæˆ‘ä»¬çš„ç³»ç»Ÿè®¾è®¡éµå¾ªk8sçš„è®¾è®¡æ€æƒ³ï¼Œé‚£ä¹ˆä¼ ç»Ÿç³»ç»Ÿæ¶æ„ä¸­é‚£äº›å’Œä¸šåŠ¡æ²¡æœ‰å¤šå¤§å…³ç³»çš„åº•å±‚ä»£ç å’ŒåŠŸèƒ½æ¨¡å—ï¼Œéƒ½å¯ä»¥ç»Ÿç»Ÿä¸ç”¨è€ƒè™‘ï¼Œæˆ‘ä»¬ä¸å¿…åœ¨å¤´ç–¼äºæœåŠ¡ç›‘æ§ã€æ•…éšœå¤„ç†ç­‰æ¨¡å—çš„å¼€å‘ï¼Œä½¿ç”¨k8sæä¾›çš„è§£å†³æ–¹æ¡ˆï¼Œæˆ‘ä»¬å¯ä»¥èŠ‚çœå¤§é‡çš„å¼€å‘æˆæœ¬ï¼Œé™ä½ç³»ç»Ÿè¿ç»´çš„éš¾åº¦ã€‚\nk8så…·æœ‰å®Œå¤‡çš„é›†ç¾¤ç®¡ç†èƒ½åŠ›ï¼Œæ”¯æŒå¤šå±‚æ¬¡çš„å®‰å…¨é˜²æŠ¤å’Œå‡†å…¥æœºåˆ¶ã€å¤šç§Ÿæˆ·åº”ç”¨æ”¯æ’‘èƒ½åŠ›ã€é€æ˜çš„æœåŠ¡å‘ç°å’Œæ³¨å†Œæœºåˆ¶ã€å†…å»ºçš„è´Ÿè½½å‡è¡¡å™¨ã€æ•…éšœå‘ç°å’Œè‡ªæˆ‘ä¿®å¤ã€æœåŠ¡æ»šåŠ¨å‡çº§å’Œåœ¨çº¿è‡ªåŠ¨æ‰©å®¹ã€å¯æ‰©å±•çš„èµ„æºè‡ªåŠ¨è°ƒåº¦æœºåˆ¶ã€ä»¥åŠå¤šç²’åº¦çš„èµ„æºé…é¢ç®¡ç†èƒ½åŠ›ã€‚\n\nåœ¨ä»‹ç»k8såŸºç¡€çŸ¥è¯†å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹k8såŸºç¡€ç»„ä»¶å›¾ï¼Œç„¶åæˆ‘ä»¬å‚è€ƒç€å›¾ä¸€èµ·æ¥è®²è§£ã€‚\n![](img/k8s.png)\n\n### Master\nMasteræ˜¯æ•´ä¸ªk8sé›†ç¾¤çš„æ§åˆ¶èŠ‚ç‚¹ï¼Œè´Ÿè´£æ•´ä¸ªé›†ç¾¤çš„ç®¡ç†å’Œæ§åˆ¶ï¼ŒåŸºæœ¬ä¸Šæ‰€æœ‰çš„æ§åˆ¶å‘½ä»¤éƒ½éœ€è¦å‘ç»™å®ƒï¼Œç”±å®ƒæ¥è´Ÿè´£å…·ä½“çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œå› æ­¤MasterèŠ‚ç‚¹éå¸¸é‡è¦ï¼Œå»ºè®®ä½¿ç”¨ç‹¬ç«‹çš„æœåŠ¡å™¨æ¥éƒ¨ç½²ï¼Œé«˜å¯ç”¨éƒ¨ç½²å»ºè®®ç”¨3å°æœåŠ¡å™¨ã€‚\nMasterèŠ‚ç‚¹ä¸Šè¿è¡Œç€3ä¸ªé‡è¦çš„è¿›ç¨‹ï¼š\n* kube-apiserverï¼šæä¾›Http Restæ¥å£çš„æœåŠ¡è¿›ç¨‹ï¼Œæ˜¯k8sé‡Œæ‰€æœ‰èµ„æºå¢ã€åˆ ã€æ”¹ã€æŸ¥ç­‰æ“ä½œçš„å”¯ä¸€å…¥å£ï¼Œä¹Ÿæ˜¯é›†ç¾¤æ§åˆ¶çš„å…¥å£è¿›ç¨‹ã€‚\n* kube-controller-managerï¼šk8sé‡Œé¢æ‰€æœ‰èµ„æºå¯¹è±¡çš„è‡ªåŠ¨åŒ–æ§åˆ¶ä¸­å¿ƒã€‚\n* kube-scheduleï¼šè´Ÿè´£èµ„æºè°ƒåº¦(Podè°ƒåº¦)çš„è¿›ç¨‹ã€‚\nå¦å¤–ï¼ŒMasterèŠ‚ç‚¹ä¸Šè¿˜éœ€è¦å¯åŠ¨ä¸€ä¸ªetcdæœåŠ¡ï¼Œå› ä¸ºk8sé‡Œæ‰€æœ‰èµ„æºå¯¹è±¡çš„æ•°æ®å…¨éƒ¨éƒ½æ˜¯ä¿å­˜åœ¨etcdé‡Œé¢çš„ã€‚\n\n### Node\né™¤äº†MasterèŠ‚ç‚¹ä»¥å¤–ï¼Œk8sé›†ç¾¤é‡Œçš„å…¶ä»–æœºå™¨è¢«ç§°ä¸ºNodeèŠ‚ç‚¹ï¼Œæ¯ä¸ªNodeèŠ‚ç‚¹éƒ½ä¼šè¢«MasterèŠ‚ç‚¹åˆ†é…ä¸€äº›å·¥ä½œè´Ÿè½½(dockerå®¹å™¨),å½“æŸä¸ªNodeèŠ‚ç‚¹å®•æœºæ—¶ï¼Œå…¶ä¸Šçš„å·¥ä½œè´Ÿè½½ä¼šè¢«Masterè‡ªåŠ¨è½¬ç§»åˆ°å…¶ä»–NodeèŠ‚ç‚¹ä¸Šå»ã€‚\næ¯ä¸ªNodeèŠ‚ç‚¹ä¸ŠåŒæ ·è¿è¡Œç€ä¸€ç»„é‡è¦è¿›ç¨‹ï¼š\n* kubeletï¼šè´Ÿè´£Podå¯¹åº”çš„å®¹å™¨çš„åˆ›å»ºã€å¯åœç­‰ä»»åŠ¡ï¼ŒåŒæ—¶ä¸MasterèŠ‚ç‚¹å¯†åˆ‡åä½œï¼Œå®ç°é›†ç¾¤ç®¡ç†çš„åŸºæœ¬åŠŸèƒ½ã€‚\n* kube-proxyï¼šå®ç°k8s Serviceçš„é€šä¿¡ä¸è´Ÿè½½å‡è¡¡æœºåˆ¶çš„é‡è¦ç»„ä»¶ã€‚\n* Docker Engineï¼šdockerå¼•æ“ï¼Œè´Ÿè´£æœ¬æœºdockerå®¹å™¨çš„åˆ›å»ºå’Œç®¡ç†å·¥ä½œã€‚\nNodeèŠ‚ç‚¹å¯ä»¥åœ¨è¿è¡ŒæœŸé—´åŠ¨æ€æ·»åŠ åˆ°k8sé›†ç¾¤ä¸­ï¼Œå‰ææ˜¯è¯¥èŠ‚ç‚¹æ­£ç¡®å¯åŠ¨äº†ä¸Šè¿°è¿›ç¨‹ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œkubeletä¼šå‘MasterèŠ‚ç‚¹æ³¨å†Œè‡ªå·±ï¼Œç„¶åkubeletä¼šå®šæ—¶çš„å‘MasterèŠ‚ç‚¹æ±‡æŠ¥è‡ªèº«çš„æƒ…æŠ¥ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼šæ“ä½œç³»ç»Ÿç‰ˆæœ¬ã€dockerç‰ˆæœ¬ã€æœºå™¨CPUå†…å­˜æƒ…å†µã€ä»¥åŠå½“å‰æœ‰å“ªäº›Podåœ¨è¿è¡Œã€‚è¿™æ ·Masterä¾¿ä¼šçŸ¥é“æ¯ä¸ªNodeèŠ‚ç‚¹çš„èµ„æºä½¿ç”¨æƒ…å†µï¼Œå¹¶å®ç°é«˜æ•ˆå‡è¡¡çš„èµ„æºè°ƒåº¦ç­–ç•¥ã€‚å¦‚æœæŸä¸ªNodeèŠ‚ç‚¹è¶…è¿‡æŒ‡å®šæ—¶é—´æ²¡æœ‰ä¸ŠæŠ¥ä¿¡æ¯ï¼Œä¼šè¢«MasterèŠ‚ç‚¹åˆ¤å®šä¸º\"å¤±è”\"ï¼Œè¯¥NodeèŠ‚ç‚¹çŠ¶æ€å°†ä¼šè¢«æ ‡è®°ä¸ºä¸å¯ç”¨(Not Ready),éšåï¼ŒMasterä¼šè§¦å‘ç›¸åº”çš„è‡ªåŠ¨æµç¨‹ï¼Œå°†ä¸å¯ç”¨çš„NodeèŠ‚ç‚¹ä¸Šçš„å·¥ä½œè´Ÿè½½è½¬ç§»åˆ°å…¶ä»–NodeèŠ‚ç‚¹ä¸Šã€‚\n### Service\nServiceæ˜¯k8sçš„æ ¸å¿ƒï¼Œå®ƒå…¶å®å°±æ˜¯å¾®æœåŠ¡æ¶æ„ä¸­çš„ä¸€ä¸ª\"å¾®æœåŠ¡\"ï¼Œæ¯ä¸ªServiceå¯¹è±¡éƒ½æœ‰å¦‚ä¸‹ç‰¹å¾ï¼š\n* æ‹¥æœ‰ä¸€ä¸ªå”¯ä¸€æŒ‡å®šçš„åç§°(æ¯”å¦‚mysql-server)\n* æ‹¥æœ‰ä¸€ä¸ªè™šæ‹ŸIP(Cluster IPã€Service IP æˆ– VIPï¼Œç”±k8såˆ†é…)å’Œç«¯å£å·(æœåŠ¡çš„è®¿é—®å…¥å£åœ°å€)\n* èƒ½å¤Ÿæä¾›æŸç§è¿œç¨‹æœåŠ¡èƒ½åŠ›\n* è¢«æ˜ å°„åˆ°äº†æä¾›è¿™ç§æœåŠ¡èƒ½åŠ›çš„ä¸€ç»„å®¹å™¨åº”ç”¨ä¸Š\nServiceçš„æœåŠ¡è¿›ç¨‹ç›®å‰éƒ½åŸºäºSocketé€šä¿¡æ–¹å¼å¯¹å¤–æä¾›æœåŠ¡ï¼Œæ¯”å¦‚Redisã€Mysqlã€Tomcatï¼Œæˆ–è€…æ˜¯å®ç°äº†æŸä¸ªå…·ä½“ä¸šåŠ¡çš„ä¸€ä¸ªç‰¹å®šçš„Tcp Serverè¿›ç¨‹ï¼Œè™½ç„¶ä¸€ä¸ªServiceé€šå¸¸ç”±å¤šä¸ªç›¸å…³çš„æœåŠ¡è¿›ç¨‹æ¥æä¾›æœåŠ¡ï¼Œæ¯ä¸ªæœåŠ¡è¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªç‹¬ç«‹çš„Endpoint(IP + Port)è®¿é—®ç‚¹(ä¾‹å¦‚Tomcatæœ‰æœåŠ¡ç«¯å£å’Œç®¡ç†ç«¯å£)ï¼Œä½†k8sèƒ½å¤Ÿè®©æˆ‘ä»¬é€šè¿‡Service(Cluster IP + Service Port)è¿æ¥åˆ°æŒ‡å®šçš„Serviceä¸Šï¼Œé€šè¿‡k8så†…å»ºçš„é€æ˜è´Ÿè½½å‡è¡¡å’Œæ•…éšœæ¢å¤æœºåˆ¶ï¼Œä¸ç®¡åç«¯æœ‰å¤šå°‘æœåŠ¡è¿›ç¨‹ï¼Œä¹Ÿä¸ç®¡æŸä¸ªæœåŠ¡è¿›ç¨‹æ˜¯å¦ä¼šç”±äºå‘ç”Ÿæ•…éšœè€Œé‡æ–°éƒ¨ç½²åˆ°å…¶ä»–æœºå™¨ä¸Šï¼Œéƒ½ä¸ä¼šå½±å“åˆ°æˆ‘ä»¬å¯¹æœåŠ¡çš„æ­£å¸¸è°ƒç”¨ï¼Œæ›´é‡è¦çš„æ˜¯è¿™ä¸ªServiceä¸€æ—¦åˆ›å»ºæˆåŠŸï¼Œå°±ä¸ä¼šåœ¨å‘ç”Ÿå˜åŒ–ï¼Œè¿™æ„å‘³ç€ï¼Œåœ¨k8sé›†ç¾¤ä¸­ï¼Œæˆ‘ä»¬å†ä¹Ÿä¸ç”¨ä¸ºäº†æœåŠ¡çš„IPåœ°å€å˜æ¥å˜å»çš„é—®é¢˜è€Œå¤´ç–¼äº†ã€‚\né€šè¿‡ä¸Šå›¾ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå‰ç«¯åº”ç”¨Podé€šè¿‡Serviceçš„å…¥å£åœ°å€ï¼Œè®¿é—®åˆ°äº†è¯¥ServiceèƒŒåä¸€ç»„ç”±Podå‰¯æœ¬ç»„æˆçš„é›†ç¾¤å®ä¾‹ã€‚Serviceæ˜¯é€šè¿‡Label Selectæ ‡ç­¾é€‰æ‹©å™¨æœºåˆ¶ä¸å…¶åç«¯Podå‰¯æœ¬é›†ç¾¤å…³è”èµ·æ¥çš„ï¼Œè€ŒReplicationControllerçš„ä½œç”¨å®é™…ä¸Šæ˜¯ä¿è¯Serviceçš„æœåŠ¡èƒ½åŠ›å’ŒæœåŠ¡è´¨é‡å§‹ç»ˆå¤„äºé¢„æœŸçš„æ ‡å‡†(æ ¹æ®ReplicationControllerçš„å‰¯æœ¬æ•°é‡é…ç½®ï¼Œk8sä¼šä¿è¯å¯åŠ¨ç›¸åº”å‰¯æœ¬æ•°çš„å®¹å™¨)\n\n\n### Pod\nå®¹å™¨æä¾›äº†å¼ºå¤§éš”ç¦»åŠŸèƒ½ï¼Œk8sä¸ºäº†å®ç°ServiceæœåŠ¡éš”ç¦»è®¾è®¡äº†Podå¯¹è±¡ï¼Œå°†æ¯ä¸ªæœåŠ¡è¿›ç¨‹åŒ…è£…åˆ°ç›¸åº”çš„Podä¸­ï¼Œä½¿å…¶æˆä¸ºPodä¸­è¿è¡Œçš„ä¸€ä¸ªå®¹å™¨ï¼Œä¸ºäº†å»ºç«‹Serviceå’ŒPodçš„å…³è”å…³ç³»ï¼Œk8sé¦–å…ˆç»™æ¯ä¸ªPodè´´ä¸Šä¸€ä¸ªæ ‡ç­¾(Label),ä¾‹å¦‚ç»™è¿è¡ŒMysqlçš„Podè´´ä¸Šname=mysqlæ ‡ç­¾ï¼Œç»™è¿è¡Œredisçš„Podè´´ä¸Šname=redisçš„æ ‡ç­¾ï¼Œç„¶åç»™ç›¸åº”çš„Serviceå®šä¹‰æ ‡ç­¾é€‰æ‹©å™¨(Label Selector)ï¼Œæ¯”å¦‚Redisé›†ç¾¤Serviceçš„æ ‡ç­¾é€‰æ‹©å™¨çš„é€‰æ‹©æ¡ä»¶ä¸ºname=redisï¼Œé‚£ä¹ˆè¯¥Redisé›†ç¾¤Serviceå°†ä¼šä½œç”¨äºæ‰€æœ‰åŒ…å«name=redisæ ‡ç­¾çš„Podä¸Š,è¿™æ ·ä¸€æ¥ï¼Œå°±è§£å†³äº†Serviceå’ŒPodçš„å…³è”é—®é¢˜ã€‚\né€šè¿‡ä¸Šå›¾ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°Podè¿è¡Œåœ¨NodeèŠ‚ç‚¹ä¸Šï¼Œé€šå¸¸æ¯ä¸ªNodeèŠ‚ç‚¹ä¸Šå¯ä»¥è¿è¡Œå‡ ç™¾ä¸ªPodï¼Œè€Œä¸”è¿è¡Œä¸€ä¸ªè¢«ç§°ä¸º\"æ ¹å®¹å™¨\"çš„Pauseå®¹å™¨ã€‚å› ä¸ºåœ¨ä¸€ç»„å®¹å™¨ä½œä¸ºä¸€ä¸ªå•å…ƒçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¾ˆéš¾å¯¹ä¸€ä¸ª\"æ•´ä½“\"è¿›è¡Œç®€å•çš„åˆ¤æ–­ï¼Œä¾‹å¦‚ï¼Œä¸€ä¸ªå®¹å™¨æŒ‚æ‰äº†ï¼Œé‚£ä¹ˆæ­¤æ—¶ç®—æ˜¯æ•´ä½“æ­»äº¡å—ï¼Ÿæ˜¯N/Mçš„æ­»äº¡ç‡å—ï¼Ÿå¼•å…¥ä¸šåŠ¡æ— å…³ä¸”ä¸æ˜“æŒ‚æ‰çš„Pauseå®¹å™¨ä½œä¸ºPodçš„æ ¹å®¹å™¨ï¼Œä»¥å®ƒçš„çŠ¶æ€ä»£è¡¨æ•´ä¸ªå®¹å™¨ç»„çš„çŠ¶æ€ï¼Œå°±ç®€å•çš„è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚å¦å¤–ï¼ŒPodé‡Œçš„å¤šä¸ªä¸šåŠ¡å®¹å™¨å…±äº«Pauseå®¹å™¨çš„IPï¼Œå…±äº«Pauseå®¹å™¨æŒ‚æ¥çš„Volumeï¼Œè¿™æ ·å³ç®€åŒ–äº†å¯†åˆ‡å…³è”çš„ä¸šåŠ¡å®¹å™¨ä¹‹é—´çš„é€šä¿¡é—®é¢˜ï¼Œä¹Ÿå¾ˆå¥½çš„è§£å†³äº†å®ƒä»¬ä¹‹é—´çš„æ–‡ä»¶å…±äº«é—®é¢˜ã€‚\nk8sä¸ºæ¯ä¸ªPodéƒ½åˆ†é…äº†ä¸€ä¸ªå”¯ä¸€çš„Pod IPï¼Œä¸€ä¸ªPodé‡Œçš„å¤šä¸ªå®¹å™¨å…±äº«è¯¥Pod IPåœ°å€ï¼Œk8sè¦æ±‚åº•å±‚ç½‘ç»œæ”¯æŒé›†ç¾¤å†…ä»»æ„ä¸¤ä¸ªPodä¹‹é—´çš„TCP/IPç›´æ¥é€šä¿¡ï¼Œè¿™é€šå¸¸é‡‡ç”¨\"è™šæ‹ŸäºŒå±‚ç½‘ç»œ\"æŠ€æœ¯æ¥å®ç°ï¼Œä¾‹å¦‚ï¼šFlannelã€Open vSwitchç­‰ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ç‰¢è®°ä¸€ç‚¹ï¼šåœ¨k8sé‡Œï¼Œä¸€ä¸ªPodé‡Œçš„å®¹å™¨ä¸å¦å¤–ä¸»æœºä¸Šçš„Podå®¹å™¨èƒ½å¤Ÿç›´æ¥é€šä¿¡ã€‚\nPodåˆ†ä¸ºä¸¤ç§ç±»å‹ï¼šæ™®é€šçš„Podå’Œé™æ€çš„Podï¼Œé™æ€Podæ¯”è¾ƒç‰¹æ®Šï¼Œå®ƒå¹¶ä¸åœ¨k8sçš„etcdä¸­å­˜å‚¨ï¼Œè€Œæ˜¯å­˜åœ¨åœ¨æŸä¸ªå…·ä½“çš„Nodeä¸Šçš„ä¸€ä¸ªå…·ä½“æ–‡ä»¶ä¸­ï¼Œå¹¶ä¸”åªåœ¨æ­¤Nodeä¸Šè¿è¡Œï¼Œè€Œæ™®é€šçš„Podä¸€æ—¦åˆ›å»ºï¼Œå°±ä¼šè¢«æ”¾å…¥etcdä¸­å­˜å‚¨ï¼Œéšåä¼šè¢«k8sçš„Masterè°ƒåº¦åˆ°æŸä¸ªå…·ä½“çš„Nodeä¸Šè¿›è¡Œç»‘å®šï¼Œéšåè¯¥Podè¢«å¯¹åº”çš„Nodeä¸Šçš„kubeletè¿›ç¨‹å®ä¾‹åŒ–ä¸ºä¸€ç»„ç›¸å…³çš„Dockerå®¹å™¨å¹¶å¯åŠ¨èµ·æ¥ã€‚åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“Podé‡Œçš„æŸä¸ªå®¹å™¨åœæ­¢æ—¶ï¼Œk8sä¼šè‡ªåŠ¨æ£€æµ‹åˆ°è¿™ä¸ªé—®é¢˜å¹¶ä¸”é‡å¯è¯¥Pod(é‡å¯Podé‡Œçš„æ‰€æœ‰å®¹å™¨)ï¼Œå¦‚æœPodæ‰€åœ¨çš„Nodeå®•æœºï¼Œåˆ™ä¼šå°†è¿™ä¸ªNodeä¸Šçš„æ‰€æœ‰Podé‡æ–°è°ƒåº¦åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚\n\n\nPod IP åŠ ä¸Šå®¹å™¨çš„Portï¼Œå°±ç»„æˆäº†Endpointï¼Œå®ƒä»£è¡¨ç€æ­¤Podé‡Œçš„ä¸€ä¸ªæœåŠ¡è¿›ç¨‹çš„å¯¹å¤–é€šä¿¡åœ°å€ï¼Œä¸€ä¸ªPodä¹Ÿå­˜åœ¨ç€å…·æœ‰å¤šä¸ªEndpointçš„æƒ…å†µï¼Œæ¯”å¦‚å½“æˆ‘ä»¬æŠŠTomcatå®šä¹‰ä¸ºä¸€ä¸ªPodæ—¶ï¼Œå¯ä»¥å¯¹å¤–æš´éœ²ç®¡ç†ç«¯å£å’ŒæœåŠ¡ç«¯å£è¿™ä¸¤ä¸ªEndpoint.\n\nk8sçš„Eventæ˜¯ä¸€ä¸ªäº‹ä»¶çš„è®°å½•ï¼Œè®°å½•äº†äº‹ä»¶çš„æœ€æ—©äº§ç”Ÿæ—¶é—´ã€æœ€åé‡ç°äº‹ä»¶ã€é‡å¤æ¬¡æ•°ã€å‘èµ·è€…ã€ç±»å‹ï¼Œä»¥åŠå¯¼è‡´æ­¤äº‹ä»¶çš„åŸå› ç­‰ä¼—å¤šä¿¡æ¯ï¼ŒEventé€šå¸¸ä¼šå…³è”åˆ°æŸä¸ªå…·ä½“çš„èµ„æºå¯¹è±¡ä¸Šï¼Œæ˜¯æ’æŸ¥æ•…éšœçš„é‡è¦å‚è€ƒä¿¡æ¯ã€‚\n\n#### Service å’Œ Pod\næ—¢ç„¶æ¯ä¸ªPodéƒ½ä¼šè¢«åˆ†é…å”¯ä¸€çš„Pod IPï¼Œè€Œä¸”æ¯ä¸ªPodéƒ½æä¾›äº†ä¸€ä¸ªç‹¬ç«‹çš„Endpoint(Pod IP + å®¹å™¨Port)ä»¥è¢«å®¢æˆ·ç«¯è®¿é—®ï¼Œç°åœ¨å¤šä¸ªPodå‰¯æœ¬å°±ç»„æˆäº†ä¸€ä¸ªé›†ç¾¤æ¥æä¾›æœåŠ¡ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯è¯¥å¦‚ä½•æ¥è®¿é—®å®ƒä»¬å‘¢ï¼Ÿ\nä¸€èˆ¬çš„åšæ³•æ˜¯éƒ¨ç½²ä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨ï¼Œä¸ºè¿™ç»„Podå¼€å¯ä¸€ä¸ªå¯¹å¤–çš„æœåŠ¡ç«¯å£å¦‚8000ç«¯å£ï¼Œå¹¶ä¸”å°†è¿™äº›Podçš„Endpointåˆ—è¡¨åŠ å…¥8000ç«¯å£çš„è½¬å‘åˆ—è¡¨ä¸­ï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥é€šè¿‡è´Ÿè½½å‡è¡¡å™¨çš„å¯¹å¤–IPåœ°å€+æœåŠ¡ç«¯å£æ¥è®¿é—®æ­¤æœåŠ¡äº†ï¼Œè€Œå®¢æˆ·ç«¯çš„è¯·æ±‚æœ€åä¼šè¢«è½¬å‘åˆ°å“ªä¸ªPodï¼Œåˆ™ç”±è´Ÿè½½å‡è¡¡å™¨çš„ç®—æ³•æ¥å†³å®šã€‚\nk8sä¹Ÿéµå¾ªäº†ä¸Šè¿°å¸¸è§„åšæ³•ï¼Œè¿è¡Œåœ¨æ¯ä¸ªNodeä¸Šçš„kube-proxyè¿›ç¨‹å…¶å®å°±æ˜¯ä¸€ä¸ªæ™ºèƒ½çš„è½¯ä»¶è´Ÿè½½å‡è¡¡å™¨ï¼Œå®ƒè´Ÿè´£æŠŠå¯¹Serviceçš„è¯·æ±‚è½¬å‘åˆ°åç«¯çš„æŸä¸ªPodå®ä¾‹ä¸Šï¼Œå¹¶åœ¨å†…éƒ¨å®ç°æœåŠ¡çš„è´Ÿè½½å‡è¡¡å’Œå›è¯ä¿æŒæœºåˆ¶ã€‚ä½†k8så‘æ˜äº†ä¸€ç§å¾ˆå·§å¦™çš„è®¾è®¡ï¼šServiceä¸æ˜¯å…±ç”¨ä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨çš„IPåœ°å€ï¼Œè€Œæ˜¯æ¯ä¸ªServiceè¢«åˆ†é…äº†ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„è™šæ‹Ÿçš„Cluster IPï¼Œè¿™æ ·ä¸€æ¥ï¼Œæ¯ä¸ªæœåŠ¡å°±å˜æˆäº†å…·å¤‡å”¯ä¸€IPåœ°å€çš„\"é€šä¿¡èŠ‚ç‚¹\"ï¼ŒæœåŠ¡è°ƒç”¨å°±å˜æˆäº†æœ€åŸºç¡€çš„TCPç½‘ç»œé€šä¿¡é—®é¢˜ã€‚\næˆ‘ä»¬çŸ¥é“Podçš„Endpointåœ°å€ä¼šéšç€Podçš„é”€æ¯å’Œé‡æ–°åˆ›å»ºè€Œå‘ç”Ÿæ”¹å˜ï¼Œå› æ­¤æ–°Podçš„IPåœ°å€å’Œæ—§Podçš„IPåœ°å€ä¸åŒã€‚è€ŒServiceçš„ä¸€æ—¦è¢«åˆ›å»ºï¼Œk8så°±ä¼šè‡ªåŠ¨ä¸ºå®ƒåˆ†é…ä¸€ä¸ªå¯ç”¨çš„Cluster IPï¼Œè€Œä¸”åœ¨Serviceçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå†…ï¼Œå®ƒçš„Cluster IPéƒ½ä¸ä¼šå‘ç”Ÿæ”¹å˜ï¼Œäºæ˜¯æœåŠ¡å‘ç°è¿™ä¸ªé—®é¢˜åœ¨k8sçš„æ¶æ„é‡Œå°±å¾—ä»¥è½»æ¾è§£å†³ï¼šåªéœ€è¦ç”¨Serviceçš„Nameå’ŒServiceçš„Cluster IPåšä¸€ä¸ªDNSåŸŸåæ˜ å°„å°±å¯ä»¥å®Œç¾è§£å†³é—®é¢˜ã€‚\né‚£ä¹ˆå¦‚ä½•å®ç°é€šè¿‡Serviceçš„Nameæ¥æŸ¥æ‰¾å¯¹åº”çš„Cluster IPå‘¢ï¼Ÿ\næœ€æ—©ä»¥å‰ï¼Œk8sé‡‡ç”¨äº†Linuxç¯å¢ƒå˜é‡çš„æ–¹å¼ï¼Œä¸ºæ¯ä¸ªServiceç”Ÿæˆä¸€äº›å¯¹åº”çš„ç¯å¢ƒå˜é‡ï¼Œå¹¶åœ¨æ¯ä¸ªPodçš„å®¹å™¨å¯åŠ¨æ—¶ï¼Œè‡ªåŠ¨æ³¨å…¥è¿™äº›ç¯å¢ƒå˜é‡ï¼Œä½†æ˜¯è¿™æ ·ä½¿ç”¨èµ·æ¥ä»ç„¶ä¸å¤Ÿç›´è§‚ã€‚åæ¥k8sé€šè¿‡Add-Onå¢å€¼åŒ…çš„æ–¹å¼å¼•å…¥äº†DNSç³»ç»Ÿï¼ŒæŠŠServiceçš„Nameä½œä¸ºDNSçš„åŸŸåï¼Œè¿™æ ·ä¸€æ¥ï¼Œç¨‹åºå°±å¯ä»¥ç›´æ¥ä½¿ç”¨Serviceçš„Nameæ¥å»ºç«‹é€šä¿¡äº†ã€‚\n\n#### å¤–éƒ¨ç³»ç»Ÿè®¿é—®Serviceçš„é—®é¢˜\næˆ‘ä»¬å†æ¥çœ‹ä¸‹k8sé‡Œé¢çš„ä¸‰ç§IPï¼š\n\n* Node IP\nNodeèŠ‚ç‚¹çš„IPï¼Œæ˜¯æ¯ä¸ªNodeèŠ‚ç‚¹çš„ç‰©ç†ç½‘å¡çš„IPï¼Œè¿™æ˜¯ä¸€ä¸ªçœŸå®å­˜åœ¨çš„ç‰©ç†ç½‘ç»œï¼Œæ‰€æœ‰å±äºè¿™ä¸ªç½‘ç»œçš„æœåŠ¡å™¨ä¹‹é—´éƒ½èƒ½é€šè¿‡è¿™ä¸ªç½‘ç»œç›´æ¥é€šä¿¡ï¼Œä¸ç®¡å®ƒä»¬ä¸­æ˜¯å¦æœ‰ä¸å±äºè¯¥k8sé›†ç¾¤çš„èŠ‚ç‚¹ã€‚è¿™ä¹Ÿè¡¨æ˜ï¼Œk8sé›†ç¾¤ä¹‹å¤–çš„èŠ‚ç‚¹æƒ³è¦è®¿é—®k8sé›†ç¾¤å†…çš„æŸä¸ªèŠ‚ç‚¹æˆ–è€…TCP/IPæœåŠ¡æ—¶ï¼Œå¿…é¡»è¦é€šè¿‡Node IPè¿›è¡Œé€šä¿¡ã€‚\n* Pod IP\nPod IPæ˜¯æ¯ä¸ªPodçš„IPåœ°å€ï¼Œå®ƒæ˜¯Docker Engineæ ¹æ®docker0ç½‘æ¡¥çš„IPåœ°å€æ®µè¿›è¡Œåˆ†é…çš„ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„äºŒå±‚ç½‘ç»œï¼Œå‰é¢æˆ‘ä»¬è¯´è¿‡ï¼Œk8sè¦æ±‚ä½äºä¸åŒNodeä¸Šçš„Podèƒ½å¤Ÿå½¼æ­¤ç›´æ¥é€šä¿¡ï¼Œæ‰€ä»¥ä¸€ä¸ªPodé‡Œçš„å®¹å™¨è®¿é—®å¦ä¸€ä¸ªPodé‡Œçš„å®¹å™¨ï¼Œå°±æ˜¯é€šè¿‡Pod IPæ‰€åœ¨çš„è™šæ‹ŸäºŒå±‚ç½‘ç»œè¿›è¡Œé€šä¿¡çš„ï¼Œè€ŒçœŸå®çš„TCP/IPæµé‡åˆ™æ˜¯é€šè¿‡Node IPæ‰€åœ¨çš„ç‰©ç†ç½‘å¡æµå‡ºçš„ã€‚\n* Cluster IP\nå®ƒä¹Ÿæ˜¯ä¸€ä¸ªè™šæ‹ŸIPï¼Œä»…ä½œç”¨äºk8sçš„Serviceå¯¹è±¡ï¼Œå¹¶ç”±k8sç®¡ç†å’Œåˆ†é…IPåœ°å€(æ¥æºäºCluster IPåœ°å€æ± )ã€‚Cluster IPåªèƒ½ç»“åˆService Portç»„æˆä¸€ä¸ªå…·ä½“çš„é€šä¿¡ç«¯å£ï¼Œå•ç‹¬çš„Cluster IPä¸å…·å¤‡TCP/IPé€šä¿¡åŸºç¡€ã€‚\n\né€šè¿‡ä¸Šé¢çš„è¯´æ˜ï¼Œæˆ‘ä»¬æ˜ç™½äº†ï¼ŒServiceçš„Cluster IPå±äºk8sé›†ç¾¤å†…éƒ¨çš„åœ°å€ï¼Œæ— æ³•åœ¨é›†ç¾¤å¤–éƒ¨ç›´æ¥ä½¿ç”¨è¿™ä¸ªåœ°å€ã€‚é‚£ä¹ˆç”¨æˆ·è¯¥å¦‚ä½•è®¿é—®æˆ‘ä»¬çš„tomcat-serviceå‘¢ï¼Ÿä½¿ç”¨NodePortæ˜¯è§£å†³ä¸Šè¿°é—®é¢˜æœ€æœ‰æ•ˆçš„æ–¹æ³•ã€‚\nNodePortçš„å®ç°æ–¹å¼æ˜¯ï¼šåœ¨k8sé›†ç¾¤é‡Œçš„æ¯ä¸ªNodeä¸Šä¸ºéœ€è¦å¤–éƒ¨è®¿é—®çš„Serviceå¼€å¯ä¸€ä¸ªå¯¹åº”çš„TCPç›‘å¬ç«¯å£ï¼Œå¤–éƒ¨ç³»ç»Ÿåªéœ€è¦ç”¨ä»»æ„ä¸€ä¸ªNodeçš„IPåœ°å€+å…·ä½“çš„NodePortç«¯å£å°±å¯ä»¥è®¿é—®è¯¥æœåŠ¡ã€‚å‡å¦‚æˆ‘ä»¬é…ç½®äº†NodePort=31002ï¼Œç„¶ååœ¨ä»»æ„çš„Nodeä¸Šè¿è¡Œnetstatå‘½ä»¤ï¼Œå°±å¯ä»¥çœ‹åˆ°æœ‰NodePortç«¯å£è¢«ç›‘å¬ã€‚\n\n\n### Label\nä¸€ä¸ªLabelå°±æ˜¯ä¸€ä¸ªkey=valueçš„é”®å€¼å¯¹ï¼Œå…¶ä¸­keyå’Œvalueç”±ç”¨æˆ·è‡ªå·±å®šä¹‰ï¼ŒLabelå¯ä»¥é™„åŠ åˆ°å„ç§èµ„æºå¯¹è±¡ä¸Šï¼Œä¾‹å¦‚ï¼šNodeã€Podã€Servoceã€Replication Controllerç­‰ï¼Œä¸€ä¸ªèµ„æºå¯¹è±¡å¯ä»¥å®šä¹‰ä»»æ„æ•°é‡çš„Labelï¼ŒåŒä¸€ä¸ªLabelä¹Ÿå¯ä»¥æ·»åŠ åˆ°ä»»æ„æ•°é‡çš„èµ„æºå¯¹è±¡ä¸Šï¼ŒLabelå¯ä»¥åœ¨èµ„æºå¯¹è±¡å®šä¹‰æ—¶ç¡®å®šï¼Œä¹Ÿå¯ä»¥åœ¨èµ„æºå¯¹è±¡åˆ›å»ºååŠ¨æ€æ·»åŠ æˆ–è€…åˆ é™¤ã€‚\næˆ‘ä»¬å¯ä»¥é€šè¿‡ç»™æŒ‡å®šçš„èµ„æºå¯¹è±¡é™„åŠ å¤šä¸ªä¸åŒçš„Labelæ¥å®ç°å¤šç»´åº¦çš„èµ„æºåˆ†ç»„ç®¡ç†åŠŸèƒ½ï¼Œä»¥ä¾¿äºçµæ´»æ–¹ä¾¿çš„è¿›è¡Œèµ„æºåˆ†é…ã€è°ƒåº¦ã€é…ç½®ã€éƒ¨ç½²ç­‰ç®¡ç†å·¥ä½œã€‚ä¾‹å¦‚ï¼šéƒ¨ç½²ä¸åŒç‰ˆæœ¬çš„åº”ç”¨åˆ°ä¸åŒçš„ç¯å¢ƒä¸­ã€‚\nä¸€äº›å¸¸ç”¨çš„Labelæ ‡ç­¾ç¤ºä¾‹å¦‚ä¸‹ï¼š\n* ç‰ˆæœ¬æ ‡ç­¾ï¼š\"release\":\"stable\",\"release\":\"canary\"\n* ç¯å¢ƒæ ‡ç­¾ï¼š\"env\":\"test\",\"env\":\"uat\",\"env\":\"pro\"\nç»™æŸä¸ªèµ„æºå¯¹è±¡é™„åŠ ä¸€äº›æ ‡ç­¾ï¼Œéšåæˆ‘ä»¬å¯ä»¥é€šè¿‡Label Selector(æ ‡ç­¾é€‰æ‹©å™¨)æŸ¥è¯¢å’Œç­›é€‰æ‹¥æœ‰æŸäº›Labelæ ‡ç­¾çš„èµ„æºå¯¹è±¡ã€‚\nå½“å‰æœ‰ä¸¤ç§Lavel Selectorçš„è¡¨è¾¾å¼ï¼šåŸºäºç­‰å¼çš„å’ŒåŸºäºé›†åˆçš„ï¼Œä¾‹å¦‚ï¼š\n* name = redis-slave ï¼ŒåŒ¹é…æ‰€æœ‰æ‹¥æœ‰name = redis-slaveæ ‡ç­¾çš„èµ„æºå¯¹è±¡\n* env != proï¼ŒåŒ¹é…æ‰€æœ‰ä¸å…·æœ‰env = proæ ‡ç­¾çš„èµ„æºå¯¹è±¡\n* name in (redis-master,redis-slave)ï¼ŒåŒ¹é…æ‰€æœ‰æ‹¥æœ‰name = redis-master æˆ–è€… name = redis-slaveæ ‡ç­¾çš„èµ„æºå¯¹è±¡\n* name not in (php)ï¼ŒåŒ¹é…æ‰€æœ‰ä¸å…·æœ‰name = phpæ ‡ç­¾çš„èµ„æºå¯¹è±¡\nå¯ä»¥é€šè¿‡ä½¿ç”¨å¤šä¸ªLabel Selectorè¿›è¡Œç»„åˆæ¥å®ç°å¤æ‚çš„æ¡ä»¶é€‰æ‹©ï¼Œå¤šä¸ªLabel Selectorä½¿ç”¨é€—å·è¿›è¡Œåˆ†å‰²ï¼Œå‡ ä¸ªæ¡ä»¶ä¹‹é—´æ˜¯\"AND\"çš„å…³ç³»ï¼Œä¾‹å¦‚ï¼š\nname = redis-slave,env != pro\n\nLabel Selectoråœ¨k8sä¸­çš„æœ‰å¦‚ä¸‹é‡è¦åœºæ™¯ï¼š\n* kube-contollerè¿›ç¨‹é€šè¿‡èµ„æºå¯¹è±¡RCä¸Šå®šä¹‰çš„Label Selectoræ¥ç­›é€‰è¦ç›‘æ§çš„Podå‰¯æœ¬çš„æ•°é‡ï¼Œä»è€Œå®ç°Podå‰¯æœ¬çš„æ•°é‡å§‹ç»ˆç¬¦åˆé¢„æœŸè®¾å®šçš„å…¨è‡ªåŠ¨æ§åˆ¶æµç¨‹ã€‚\n* kube-proxyè¿›ç¨‹é€šè¿‡Serviceçš„Label Selectoræ¥é€‰æ‹©å¯¹åº”çš„Podï¼Œè‡ªåŠ¨å»ºç«‹èµ·æ¯ä¸ªServiceåˆ°å¯¹åº”Podçš„è¯·æ±‚è½¬å‘è·¯ç”±è¡¨ï¼Œä»è€Œå®ç°Serviceçš„æ™ºèƒ½è·¯ç”±è´Ÿè½½å‡è¡¡æœºåˆ¶ã€‚\n* é€šè¿‡å¯¹æŸäº›Nodeå®šä¹‰ç‰¹å®šçš„Labelï¼Œå¹¶ä¸”åœ¨Podå®šä¹‰æ–‡ä»¶ä¸­ä½¿ç”¨NodeSelectorè¿™ç§æ ‡ç­¾è°ƒåº¦ç­–ç•¥ï¼Œkube-scheduleè¿›ç¨‹å¯ä»¥å®ç°Pod\"å®šå‘è°ƒåº¦\"çš„ç‰¹æ€§ã€‚\næ€»ç»“ï¼šä½¿ç”¨Labelå¯ä»¥ç»™èµ„æºå¯¹è±¡åˆ›å»ºå¤šç»„æ ‡ç­¾ï¼ŒLabelå’ŒLabel Selectorå…±åŒæ„æˆäº†k8sç³»ç»Ÿä¸­æœ€æ ¸å¿ƒçš„åº”ç”¨æ¨¡å‹ï¼Œä½¿å¾—è¢«ç®¡ç†å¯¹è±¡èƒ½å¤Ÿè¢«ç²¾ç»†çš„åˆ†ç»„ç®¡ç†ï¼ŒåŒæ—¶å®ç°äº†æ•´ä¸ªé›†ç¾¤çš„é«˜å¯ç”¨æ€§ã€‚\n\n\n### Replication Controller\n\nRCå®šä¹‰äº†ä¸€ä¸ªæœŸæœ›çš„åœºæ™¯ï¼Œå³å£°æ˜æŸç§Podçš„å‰¯æœ¬æ•°é‡åœ¨ä»»æ„æ—¶åˆ»éƒ½ç¬¦åˆæŸä¸ªé¢„æœŸå€¼ã€‚æ‰€ä»¥RCçš„å®šä¹‰åŒ…æ‹¬å¦‚ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š\n* PodæœŸå¾…çš„å‰¯æœ¬æ•°\n* ç”¨äºç­›é€‰ç›®æ ‡Podçš„Label Selector\n* å½“Podçš„å‰¯æœ¬æ•°é‡å°äºé¢„æœŸæ•°é‡æ—¶ï¼Œç”¨æˆ·åˆ›å»ºæ–°Podçš„Podæ¨¡æ¿\n\nå½“æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªRCï¼Œå¹¶æäº¤åˆ°k8sé›†ç¾¤ä»¥åï¼ŒMasterèŠ‚ç‚¹ä¸Šçš„Controller Managerç»„ä»¶å°±ä¼šå¾—åˆ°é€šçŸ¥ï¼Œå®šæœŸå·¡æ£€ç³»ç»Ÿä¸­å½“å‰å­˜æ´»çš„ç›®æ ‡Podï¼Œå¹¶ç¡®ä¿ç›®æ ‡Podçš„å®ä¾‹çš„æ•°é‡åˆšå¥½ç­‰äºæ­¤Podçš„æœŸæœ›å€¼ï¼Œå¦‚æœæœ‰è¿‡å¤šçš„Podå‰¯æœ¬åœ¨è¿è¡Œï¼Œç³»ç»Ÿå°±ä¼šåœæ‰ä¸€äº›Podï¼Œå¦åˆ™ç³»ç»Ÿä¼šåœ¨åˆ›å»ºä¸€äº›Podï¼Œé€šè¿‡RCï¼Œk8så®ç°äº†ç”¨æˆ·åº”ç”¨é›†ç¾¤çš„é«˜å¯ç”¨æ€§ï¼Œä¹Ÿå¤§å¤§å‡å°‘äº†è¿ç»´çš„æ‰‹å·¥æ“ä½œã€‚\næ­¤å¤–ï¼Œåœ¨è¿è¡Œæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹RCçš„å‰¯æœ¬æ•°é‡ï¼Œæ¥å®ç°Podçš„åŠ¨æ€ç¼©æ”¾åŠŸèƒ½ã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåˆ é™¤RCå®šä¹‰å¹¶ä¸ä¼šå½±å“é€šè¿‡è¯¥RCå·²åˆ›å»ºå¥½çš„Podï¼Œä¸ºäº†åˆ é™¤æ‰€æœ‰çš„Podï¼Œå¯ä»¥è®¾ç½®å‰¯æœ¬æ•°ä¸º0ï¼Œç„¶åæ›´æ–°è¯¥RCï¼Œæˆ–è€…ä½¿ç”¨kubectlå·¥å…·å‘½ä»¤æ¥ä¸€æ¬¡æ€§åˆ é™¤RCåŠå…¶ç®¡ç†çš„Podã€‚\nå½“æˆ‘ä»¬çš„åº”ç”¨å‡çº§æ—¶ï¼Œé€šå¸¸ä¼šbuildä¸€ä¸ªæ–°çš„Dockeré•œåƒï¼Œå¹¶ç”¨æ–°çš„é•œåƒç‰ˆæœ¬æ¥æ›¿æ¢æ—§çš„ç‰ˆæœ¬çš„æ–¹å¼æ¥è¾¾åˆ°ç›®çš„ã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦å¹³æ»‘çš„å‡çº§ï¼Œå³åœæ­¢ä¸€å°æ—§çš„ï¼Œå¯åŠ¨ä¸€å°æ–°çš„ï¼Œåœ¨æ•´ä¸ªå‡çº§è¿‡ç¨‹ä¸­ï¼Œæ­¤æ¶ˆå½¼é•¿ï¼Œè€Œè¿è¡Œä¸­çš„Podæ•°é‡å§‹ç»ˆæ˜¯10ä¸ªï¼Œå‡ åˆ†é’Ÿè¿‡åï¼Œå½“æ‰€æœ‰çš„Podéƒ½å·²ç»æ˜¯æ–°ç‰ˆæœ¬æ—¶ï¼Œå‡çº§è¿‡ç¨‹å®Œæˆã€‚é€šè¿‡RCçš„æœºåˆ¶ï¼Œk8så¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°\"æ»šåŠ¨å‡çº§\"ã€‚\nåœ¨æ–°ç‰ˆæœ¬ä¸­k8sæ–°å¢åŠ äº†ä¸€ä¸ªReplica Setèµ„æºå¯¹è±¡ï¼Œå®ƒå’ŒRCå”¯ä¸€çš„åŒºåˆ«æ˜¯ï¼šReplica Setæ˜¯åŸºäºé›†åˆçš„Label Selectorï¼Œè€ŒRCæ˜¯åŸºäºç­‰å¼çš„Label Selector.å½“å‰æˆ‘ä»¬å¾ˆå°‘å•ç‹¬ä½¿ç”¨Replica Setï¼Œå®ƒä¸»è¦è¢«Deploymentè¿™ä¸ªæ›´é«˜å±‚æ¬¡çš„èµ„æºå¯¹è±¡æ‰€ä½¿ç”¨ï¼Œä»è€Œå½¢æˆä¸€æ•´å¥—Podåˆ›å»ºã€åˆ é™¤ã€æ›´æ–°çš„ç¼–æ’æœºåˆ¶ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨Deploymentæ—¶ï¼Œæ— éœ€å…³å¿ƒå®ƒæ˜¯å¦‚ä½•åˆ›å»ºå’Œç»´æŠ¤Replica Setçš„ï¼Œè¿™ä¸€åˆ‡éƒ½æ˜¯è‡ªåŠ¨å‘ç”Ÿçš„.\n\næœ€åï¼Œæˆ‘ä»¬æ€»ç»“ä¸‹å…³äºRCçš„ä¸€äº›ç‰¹æ€§å’Œä½œç”¨ï¼š\n* åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬é€šè¿‡å®šä¹‰ä¸€ä¸ªRCå®ç°Podçš„åˆ›å»ºè¿‡ç¨‹åŠå‰¯æœ¬æ•°é‡çš„è‡ªåŠ¨æ§åˆ¶\n* RCé‡ŒåŒ…æ‹¬å®Œæˆçš„Podå®šä¹‰æ¨¡æ¿\n* RCé€šè¿‡Label Selectoræœºåˆ¶å®ç°å¯¹Podå‰¯æœ¬çš„è‡ªåŠ¨æ§åˆ¶\n* é€šè¿‡æ”¹å˜RCé‡Œçš„Podå‰¯æœ¬æ•°é‡ï¼Œå¯ä»¥å®ç°Podçš„æ‰©å®¹å’Œç¼©å®¹åŠŸèƒ½\n* é€šè¿‡æ”¹å˜RCé‡ŒPodæ¨¡æ¿ä¸­çš„é•œåƒç‰ˆæœ¬ï¼Œå¯ä»¥å®ç°Podçš„æ»šåŠ¨å‡çº§åŠŸèƒ½\n\n\n### Deployment\nDeploymentæ˜¯åŠ å¼ºç‰ˆçš„RCï¼Œå®ƒæ˜¯ä¸ºäº†æ›´å¥½çš„è§£å†³Podçš„ç¼–æ’é—®é¢˜ï¼Œåœ¨å†…éƒ¨ä½¿ç”¨äº†Replica Setæ¥å®ç°ç›¸åº”çš„ç›®çš„ã€‚Deploymentçš„å…¸å‹ä½¿ç”¨åœºæ™¯å¦‚ä¸‹ï¼š\n* åˆ›å»ºä¸€ä¸ªDeploymentå¯¹è±¡æ¥ç”Ÿæˆå¯¹åº”çš„Replica Setå¹¶å®ŒæˆPodå‰¯æœ¬çš„åˆ›å»ºè¿‡ç¨‹ã€‚\n* æ£€æŸ¥Deploymentçš„çŠ¶æ€æ¥æŸ¥çœ‹éƒ¨ç½²åŠ¨ä½œæ˜¯å¦å®Œæˆ(Podå‰¯æœ¬çš„æ•°é‡æ˜¯å¦è¾¾åˆ°é¢„æœŸçš„å€¼)\n* æ›´æ–°Deploymentä»¥åˆ›å»ºæ–°çš„Pod(æ¯”å¦‚é•œåƒå‡çº§)\n* å¦‚æœå½“å‰Deploymentä¸ç¨³å®šï¼Œåˆ™å›æ»šåˆ°ä¸€ä¸ªæ—©å…ˆçš„Deploymentç‰ˆæœ¬\n* æš‚åœDeploymentä»¥ä¾¿äºä¸€æ¬¡æ€§ä¿®æ”¹å¤šä¸ªPodæ¨¡æ¿çš„é…ç½®é¡¹ï¼Œä¹‹ååœ¨æ¢å¤Deploymentï¼Œè¿›è¡Œæ–°çš„å‘å¸ƒ\n* æ‰©å±•Deploymentä»¥åº”å¯¹é«˜è´Ÿè½½\n* æŸ¥çœ‹Deploymentçš„çŠ¶æ€ï¼Œä»¥æ­¤ä½œä¸ºå‘å¸ƒæ˜¯å¦æˆåŠŸçš„æŒ‡æ ‡\n* æ¸…ç†ä¸å†éœ€è¦çš„æ—§ç‰ˆæœ¬çš„ReplicaSets\nå…¶ä¸­Replica Setçš„åç§°ä»¥Deploymentçš„åç§°ä¸ºå‰ç¼€ï¼ŒPodçš„å‘½åä»¥Deploymentå¯¹åº”çš„Replica Setçš„åå­—ä½œä¸ºå‰ç¼€ï¼Œè¿™ç§å‘½åå¾ˆæ¸…æ™°çš„è¡¨æ˜äº†ä¸€ä¸ªReplica Setåˆ›å»ºäº†å“ªäº›Podï¼Œå¯¹äºPodæ»šåŠ¨å‡çº§è¿™ç§å¤æ‚çš„è¿‡ç¨‹æ¥è¯´ï¼Œå¾ˆå®¹æ˜“è¿›è¡Œæ’æŸ¥é”™è¯¯ã€‚\n\n### Horizontal Pod Autoscaler\nå‰é¢æˆ‘ä»¬æåˆ°ï¼Œé€šè¿‡æ‰‹å·¥æ‰§è¡Œkubectl scaleå‘½ä»¤ï¼Œå¯ä»¥å®ç°Podçš„æ‰©å®¹å’Œç¼©å®¹ï¼Œä½†æ˜¯è¿™å¹¶ä¸ç¬¦åˆGoogleå¯¹k8sçš„å®šä½ç›®æ ‡â€”â€”â€”â€”è‡ªåŠ¨åŒ–ã€æ™ºèƒ½åŒ–ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿåº”è¯¥å¯ä»¥æ ¹æ®å½“å‰è´Ÿè½½çš„å˜åŒ–æƒ…å†µè‡ªåŠ¨è§¦å‘æ°´å¹³æ‰©å±•æˆ–ç¼©å®¹çš„è¡Œä¸ºï¼Œå› ä¸ºè¿™ä¸€è¿‡ç¨‹å¯èƒ½æ˜¯é¢‘ç¹å‘ç”Ÿçš„ã€ä¸å¯é¢„æ–™çš„ï¼Œæ‰€ä»¥æ‰‹åŠ¨æ¥æ§åˆ¶çš„æ–¹å¼ä¸ç°å®ã€‚\nHPAä¸RCã€Deploymentä¸€æ ·ï¼Œä¹Ÿå±äºä¸€ç§èµ„æºå¯¹è±¡ï¼Œé€šè¿‡è¿½è¸ªåˆ†æRCæ§åˆ¶çš„æ‰€æœ‰ç›®æ ‡Podçš„è´Ÿè½½å˜åŒ–æƒ…å†µï¼Œæ¥ç¡®å®šæ˜¯å¦éœ€è¦é’ˆå¯¹æ€§çš„è°ƒæ•´ç›®æ ‡Podçš„å‰¯æœ¬æ•°ï¼Œè¿™æ˜¯HPAçš„å®ç°åŸç†ï¼Œå½“å‰ï¼ŒHPAå¯ä»¥æœ‰å¦‚ä¸‹ä¸¤ç§æ–¹å¼ä½œä¸ºPodè´Ÿè½½çš„åº¦é‡æŒ‡æ ‡ï¼š\n* CPUUtilizationPercentage\n* åº”ç”¨ç¨‹åºè‡ªå®šä¹‰çš„åº¦é‡æŒ‡æ ‡ï¼Œæ¯”å¦‚æœåŠ¡åœ¨æ¯ç§’å†…çš„ç›¸åº”è¯·æ±‚æ•°(TPSæˆ–QPS)\nCPUUtilizationPercentageæ˜¯ä¸€ä¸ªç®—æœ¯å¹³å‡å€¼ï¼Œå³ç›®æ ‡Podæ‰€æœ‰å‰¯æœ¬è‡ªèº«çš„CPUåˆ©ç”¨ç‡çš„å¹³å‡å€¼ï¼Œä¸€ä¸ªPodè‡ªèº«çš„CPUåˆ©ç”¨ç‡æ˜¯è¯¥Podå½“å‰CPUçš„ä½¿ç”¨é‡(é€šå¸¸æ˜¯ä¸€åˆ†é’Ÿå†…çš„å¹³å‡å€¼)é™¤ä»¥å®ƒçš„Pod Requestçš„å€¼ã€‚æ¯”å¦‚ï¼šæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªPodçš„Pod Requestä¸º0.4ï¼Œè€Œå½“å‰Podçš„CPUä½¿ç”¨é‡ä¸º0.2ï¼Œåˆ™å®ƒçš„CPUä½¿ç”¨ç‡ä¸º50%ï¼Œå¦‚æ­¤ä¸€æ¥ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥ç®—å‡ºæ¥ä¸€ä¸ªRCæ§åˆ¶çš„æ‰€æœ‰Podå‰¯æœ¬çš„CPUåˆ©ç”¨ç‡çš„ç®—æœ¯å¹³å‡å€¼äº†ï¼Œå¦‚æœæŸä¸€æ—¶åˆ»CPUUtilizationPercentageçš„å€¼è¶…è¿‡äº†80%ï¼Œåˆ™æ„å‘³ç€å½“å‰Podçš„å‰¯æœ¬æ•°å¾ˆå¯èƒ½ä¸è¶³ä»¥æ”¯æ’‘æ¥ä¸‹æ¥æ›´å¤šçš„è¯·æ±‚ï¼Œéœ€è¦è¿›è¡ŒåŠ¨æ€æ‰©å®¹ï¼Œè€Œå½“è¯·æ±‚é«˜å³°æ—¶æ®µè¿‡å»åï¼ŒPodçš„CPUåˆ©ç”¨ç‡åˆä¼šé™ä¸‹æ¥ï¼Œæ­¤æ—¶å¯¹åº”çš„Podçš„å‰¯æœ¬æ•°åº”è¯¥è‡ªåŠ¨å‡å°‘åˆ°ä¸€ä¸ªåˆç†çš„æ°´å¹³ã€‚\n\n### StatefulSet\nåœ¨k8sç³»ç»Ÿä¸­ï¼ŒPodçš„ç®¡ç†å¯¹è±¡RCã€Deploymentã€DaemonSetå’ŒJobéƒ½æ˜¯æ— çŠ¶æ€çš„æœåŠ¡ã€‚ä½†ç°å®ä¸­æœ‰å¾ˆå¤šæœåŠ¡æ˜¯æœ‰çŠ¶æ€çš„ï¼Œæ¯”å¦‚Mysqlé›†ç¾¤ã€MongoDBé›†ç¾¤ã€Akkaé›†ç¾¤ã€Zookeeperé›†ç¾¤ç­‰ï¼Œè¿™äº›é›†ç¾¤æœ‰å¦‚ä¸‹å…±åŒç‚¹ï¼š\n* æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªå›ºå®šçš„èº«ä»½IDï¼Œé€šè¿‡è¿™ä¸ªIDï¼Œé›†ç¾¤ä¸­çš„æˆå‘˜å¯ä»¥äº’ç›¸å‘ç°å¹¶è¿›è¡Œé€šä¿¡\n* é›†ç¾¤çš„è§„æ¨¡æ¯”è¾ƒå›ºå®šï¼Œä¸èƒ½éšæ„å˜åŠ¨\n* å³ç¾¤é‡Œçš„æ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯æœ‰çŠ¶æ€çš„ï¼Œé€šå¸¸ä¼šæŒä¹…åŒ–æ•°æ®åˆ°æ°¸ä¹…å­˜å‚¨ä¸­\n* å¦‚æœç£ç›˜æŸåï¼Œåˆ™é›†ç¾¤é‡Œçš„æŸä¸ªèŠ‚ç‚¹æ— æ³•æ­£å¸¸è¿è¡Œï¼Œé›†ç¾¤åŠŸèƒ½å—æŸ\nå¦‚æœç”¨RC/Deploymentæ§åˆ¶çš„Podå‰¯æœ¬æ•°çš„æ–¹å¼æ¥å®ç°ä¸Šè¿°æœ‰çŠ¶æ€çš„é›†ç¾¤ï¼Œåˆ™æˆ‘ä»¬ä¼šå‘ç°ç¬¬ä¸€ç‚¹æ˜¯æ— æ³•æ»¡è¶³çš„ï¼Œå› ä¸ºPodçš„åç§°æ˜¯éšæœºäº§ç”Ÿçš„ï¼ŒPodçš„IPåœ°å€ä¹Ÿæ˜¯åœ¨è¿è¡ŒæœŸæ‰ç¡®å®šä¸”å¯èƒ½æœ‰å˜åŠ¨çš„ï¼Œæˆ‘ä»¬äº‹å…ˆæ— æ³•ä¸ºæ¯ä¸ªPodç¡®å®šå”¯ä¸€ä¸å˜çš„IDï¼Œå¦å¤–ï¼Œä¸ºäº†èƒ½å¤Ÿåœ¨å…¶ä»–èŠ‚ç‚¹ä¸Šæ¢å¤æŸä¸ªå¤±è´¥çš„èŠ‚ç‚¹ï¼Œè¿™ç§é›†ç¾¤ä¸­çš„Podéœ€è¦æŒ‚æ¥æŸç§å…±äº«å­˜å‚¨ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œk8så¼•å…¥äº†StatefulSetè¿™ä¸ªæ–°çš„èµ„æºå¯¹è±¡ï¼Œå®ƒæœ‰å¦‚ä¸‹ç‰¹æ€§ï¼š\n* StatefulSeté‡Œçš„æ¯ä¸ªPodéƒ½æœ‰ç¨³å®šã€å”¯ä¸€çš„ç½‘ç»œæ ‡è¯†ï¼Œå¯ä»¥ç”¨æ¥å‘ç°é›†ç¾¤å†…çš„å…¶ä»–æˆå‘˜ã€‚å‡è®¾StatefulSetçš„åå­—å«kafkaï¼Œé‚£ä¹ˆå®ƒçš„ç¬¬ä¸€ä¸ªPodå«kakfa-0ï¼Œç¬¬äºŒä¸ªå«kafka-1ï¼Œä»¥æ­¤ç±»æ¨\n* StatefulSetæ§åˆ¶çš„Podå‰¯æœ¬çš„å¯åœé¡ºåºæ˜¯å—æ§çš„ï¼Œæ“ä½œç¬¬nä¸ªPodæ—¶ï¼Œå‰n-1ä¸ªPodå·²ç»æ˜¯è¿è¡Œä¸”å‡†å¤‡å¥½çš„çŠ¶æ€\n* StatefulSeté‡Œçš„Podé‡‡ç”¨ç¨³å®šçš„æŒä¹…åŒ–å­˜å‚¨å·ï¼Œé€šè¿‡PV/PVCæ¥å®ç°ï¼Œä¸ºäº†ä¿æŠ¤æ•°æ®çš„å®‰å…¨ï¼Œåˆ é™¤Podæ—¶é»˜è®¤ä¸ä¼šåˆ é™¤ä¸StatefulSetç›¸å…³çš„å­˜å‚¨å·\nStatefulSeté™¤äº†è¦ä¸PVå·æ†ç»‘ä½¿ç”¨ä»¥å­˜å‚¨Podçš„çŠ¶æ€æ•°æ®ï¼Œè¿˜è¦ä¸Headless Serviceé…åˆä½¿ç”¨ï¼Œå³åœ¨æ¯ä¸ªStatefulSetçš„å®šä¹‰ä¸­è¦å£°æ˜å®ƒå±äºå“ªä¸ªHeadless Serviceã€‚Headless Serviceä¸Serviceçš„åŒºåˆ«åœ¨äºï¼Œå®ƒæ²¡æœ‰Cluster IPï¼Œå¦‚æœè§£æHeadless Serviceçš„DNSåŸŸåï¼Œåˆ™è¿”å›çš„æ˜¯è¯¥Serviceå¯¹åº”çš„å…¨éƒ¨Podçš„Endpointåˆ—è¡¨ï¼ŒStatefulSetåœ¨Headless Serviceçš„åŸºç¡€ä¸Šåˆä¸ºStatefulSetæ§åˆ¶çš„æ¯ä¸€ä¸ªPodå®ä¾‹åˆ›å»ºäº†ä¸€ä¸ªDNSåŸŸåï¼ŒåŸŸåæ ¼å¼å¦‚ä¸‹ï¼š\n```shell\n$(podname).$(headless Service name)\n```\næ¯”å¦‚ä¸€ä¸ª3èŠ‚ç‚¹çš„Kafkaçš„StatefulSeté›†ç¾¤ï¼Œå¯¹åº”çš„Headless Serviceçš„åç§°ä¸ºkafkaï¼ŒStatefulSetçš„åç§°ä¸ºkafkaï¼Œåˆ™StatefulSeté‡Œé¢çš„3ä¸ªPodçš„DNSåç§°åˆ†åˆ«ä¸ºï¼škafka-0.kafkaã€kafka-1.kafkaã€kafka-2.kafkaï¼Œè¿™äº›DNSåç§°å¯ä»¥ç›´æ¥åœ¨é›†ç¾¤çš„é…ç½®æ–‡ä»¶ä¸­å›ºå®šä¸‹æ¥ã€‚\n\n### Volume\nVolumeæ˜¯Podä¸­èƒ½å¤Ÿè¢«å¤šä¸ªå®¹å™¨è®¿é—®çš„å…±äº«ç›®å½•ï¼Œå®ƒä¸Dockerä¸­çš„Volumeæ¯”è¾ƒç±»ä¼¼ï¼Œä½†ä¸¤è€…ä¸èƒ½ç­‰ä»·ã€‚é¦–å…ˆï¼Œk8sä¸­çš„Volumeå®šä¹‰åœ¨Podä¸Šï¼Œç„¶åè¢«ä¸€ä¸ªPodé‡Œé¢çš„å¤šä¸ªå®¹å™¨æŒ‚è½½åˆ°å…·ä½“çš„æ–‡ä»¶ç›®å½•ä¸‹ï¼›å…¶æ¬¡ï¼Œk8sä¸­çš„Volumeä¸Podçš„ç”Ÿå‘½å‘¨æœŸç›¸åŒï¼Œä½†ä¸å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸæ— å…³ï¼Œå½“å®¹å™¨ç»ˆæ­¢æˆ–è€…é‡å¯æ—¶ï¼ŒVolumeä¸­çš„æ•°æ®ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚æœ€åï¼Œk8sçš„Volumeæ”¯æŒå¤šç§ç±»å‹çš„Volumeï¼Œä¾‹å¦‚ï¼šGlusterFSã€Cephç­‰å…ˆè¿›çš„åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿã€‚\nVolumeçš„ä½¿ç”¨æ¯”è¾ƒç®€å•ï¼Œåœ¨å¤§å¤šå°‘æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åªéœ€è¦å…ˆåœ¨Podä¸Šå£°æ˜ä¸€ä¸ªVolumeï¼Œç„¶ååœ¨å®¹å™¨é‡Œå¼•ç”¨è¯¥Volumeï¼Œå¹¶æŒ‚è½½åˆ°å®¹å™¨é‡Œçš„æŸä¸ªç›®å½•ä¸Šã€‚\né™¤äº†å¯ä»¥è®©ä¸€ä¸ªPodé‡Œçš„å¤šä¸ªå®¹å™¨å…±äº«æ–‡ä»¶ã€è®©å®¹å™¨çš„æ•°æ®å†™åˆ°å®¿ä¸»æœºçš„ç£ç›˜ä¸Šæˆ–è€…å†™æ–‡ä»¶åˆ°ç½‘ç»œå­˜å‚¨ä¸­ï¼Œk8sçš„Volumeè¿˜æ‰©å±•å‡ºäº†ä¸€ç§éå¸¸æœ‰å®ç”¨ä»·å€¼çš„åŠŸèƒ½ï¼Œå³å®¹å™¨é…ç½®æ–‡ä»¶é›†ä¸­åŒ–å®šä¹‰å’Œç®¡ç†ï¼Œè¿™æ˜¯é€šè¿‡ConfigMapèµ„æºå¯¹è±¡æ¥å®ç°çš„ã€‚\n### Persistent Volume\nä¹‹å‰æˆ‘ä»¬æåˆ°çš„Volumeæ˜¯å®šä¹‰åœ¨Podä¸Šçš„ï¼Œå±äºè®¡ç®—èµ„æºçš„ä¸€éƒ¨åˆ†ï¼Œè€Œç½‘ç»œå­˜å‚¨æ˜¯ç›¸å¯¹ç‹¬ç«‹äºè®¡ç®—èµ„æºè€Œå­˜åœ¨çš„ä¸€ç§å®ä½“èµ„æºï¼Œæ¯”å¦‚åœ¨ä½¿ç”¨è™šæ‹Ÿæœºçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šå…ˆå®šä¹‰ä¸€ä¸ªç½‘ç»œå­˜å‚¨ï¼Œç„¶åä»ä¸­åˆ’å‡ºä¸€ä¸ªç½‘ç›˜å¹¶æŒ‚æ¥åˆ°è™šæ‹Ÿæœºä¸Šã€‚PV(Persistent Volume)å’Œä¸ä¹‹ç›¸å…³è”çš„PVC(Persistent Volume Claim)ä¹Ÿèµ·åˆ°äº†ç±»ä¼¼çš„ä½œç”¨.\nPVå¯ä»¥ç†è§£æˆk8sé›†ç¾¤ä¸­æŸä¸ªç½‘ç»œå­˜å‚¨ä¸­å¯¹åº”çš„ä¸€å—å­˜å‚¨ï¼Œå®ƒä¸Volumeç±»ä¼¼ï¼Œä½†æ˜¯æœ‰å¦‚ä¸‹åŒºåˆ«ï¼š\n* PVåªèƒ½æ˜¯ç½‘ç»œå­˜å‚¨ï¼Œä¸å±äºä»»ä½•Nodeï¼Œä½†å¯ä»¥åœ¨æ¯ä¸ªNodeä¸Šä½¿ç”¨\n* PVå¹¶ä¸æ˜¯å®šä¹‰åœ¨Podä¸Šçš„ï¼Œè€Œæ˜¯ç‹¬ç«‹äºPodä¹‹å¤–å®šä¹‰\n* PVç›®å‰æ”¯æŒçš„ç±»å‹åŒ…æ‹¬ï¼šNFSã€gcePersistentDiskã€AWSElasticBlockStoreã€GlusterFSç­‰\nå¦‚æœæŸä¸ªPodæƒ³è¦ç”³è¯·æŸç§ç±»å‹çš„PVï¼Œåˆ™éœ€è¦å…ˆå®šä¹‰ä¸€ä¸ªPVCå¯¹è±¡ï¼Œç„¶ååœ¨Podçš„Volumeå®šä¹‰ä¸­å¼•ç”¨ä¸Šè¿°PVCå³å¯ã€‚\nå¦å¤–PVæ˜¯æœ‰çŠ¶æ€çš„å¯¹è±¡ï¼š\n* Availableï¼šç©ºé—²çŠ¶æ€\n* Bound: å·²ç»ç»‘å®šåˆ°æŸä¸ªPVCä¸Š\n* Releasedï¼šå¯¹åº”çš„PVCå·²ç»åˆ é™¤ï¼Œä½†èµ„æºè¿˜æ²¡æœ‰è¢«é›†ç¾¤å›æ”¶\n* Failedï¼šPVè‡ªåŠ¨å›æ”¶å¤±è´¥\n\n### Namespace\nNamespaceåœ¨å¾ˆå¤šæƒ…å†µä¸‹ç”¨äºå®ç°å¤šç§Ÿæˆ·çš„èµ„æºéš”ç¦»ï¼ŒNamespaceé€šè¿‡å°†é›†ç¾¤å†…éƒ¨çš„èµ„æºå¯¹è±¡\"åˆ†é…\"åˆ°ä¸åŒçš„Namespaceä¸­ï¼Œå½¢æˆé€»è¾‘ä¸Šåˆ†ç»„çš„ä¸åŒé¡¹ç›®ã€å°ç»„æˆ–ç”¨æˆ·ç»„ï¼Œä¾¿äºä¸åŒçš„åˆ†ç»„åœ¨å…±äº«ä½¿ç”¨æ•´ä¸ªé›†ç¾¤çš„èµ„æºçš„åŒæ—¶è¿˜èƒ½è¢«åˆ†åˆ«ç®¡ç†ã€‚\n\nk8sé›†ç¾¤åœ¨å¯åŠ¨åï¼Œä¼šåˆ›å»ºä¸€ä¸ªåä¸º\"default\"çš„Namespaceï¼Œå¦‚æœä¸ç‰¹åˆ«æŒ‡æ˜Namespaceï¼Œåˆ™ç”¨æˆ·åˆ›å»ºçš„Podã€RCã€Serviceéƒ½å°†è¢«ç³»ç»Ÿåˆ›å»ºåˆ°è¿™ä¸ªé»˜è®¤çš„defaultåä¸‹ã€‚\nå½“æˆ‘ä»¬ä¸ºæ¯ä¸ªç§Ÿæˆ·åˆ›å»ºä¸€ä¸ªNamespaceæ¥å®ç°å¤šç§Ÿæˆ·çš„èµ„æºéš”ç¦»æ—¶ï¼Œè¿˜èƒ½ç»“åˆk8sçš„èµ„æºé…é¢ç®¡ç†ï¼Œé™å®šä¸åŒç§Ÿæˆ·èƒ½å ç”¨çš„èµ„æºï¼Œä¾‹å¦‚CPUä½¿ç”¨é‡ã€å†…å­˜ä½¿ç”¨é‡ç­‰ã€‚\n\n### Annotation\nAnnotationå’ŒLabelç±»ä¼¼ï¼Œä¹Ÿæ˜¯ä½¿ç”¨kvå¯¹å®šä¹‰ï¼Œä¸åŒçš„æ˜¯ï¼ŒLabelæœ‰ä¸¥æ ¼çš„å‘½åè§„åˆ™ï¼Œå®ƒå®šä¹‰çš„æ˜¯k8så¯¹è±¡çš„å…ƒæ•°æ®ï¼Œå¹¶ä¸”ç”¨æˆ·Label Selectorã€‚è€ŒAnnotationåˆ™æ˜¯ç”¨æˆ·ä»»æ„å®šä¹‰çš„é™„åŠ ä¿¡æ¯ï¼Œä»¥ä¾¿äºå¤–éƒ¨å·¥å…·è¿›è¡ŒæŸ¥æ‰¾ã€‚å¾ˆå¤šæ—¶å€™ï¼Œk8sçš„æ¨¡å—è‡ªèº«ä¼šé€šè¿‡Annotationçš„æ–¹å¼æ ‡è®°èµ„æºå¯¹è±¡çš„ä¸€äº›ç‰¹æ®Šä¿¡æ¯ã€‚é€šå¸¸æ¥è¯´ï¼Œç”¨Annotationæ¥è®°å½•å¦‚ä¸‹ä¿¡æ¯ï¼š\n* buildä¿¡æ¯ã€releaseä¿¡æ¯ã€Dockeré•œåƒä¿¡æ¯ç­‰ï¼Œä¾‹å¦‚æ—¶é—´æˆ³ã€release idå·ã€PRå·ã€é•œåƒhashå€¼ã€docker registryåœ°å€ç­‰\n* æ—¥å¿—åº“ã€ç›‘æ§åº“ã€åˆ†æåº“ç­‰èµ„æºåº“çš„åœ°å€ä¿¡æ¯\n* ç¨‹åºè°ƒè¯•å·¥å…·ä¿¡æ¯ï¼Œä¾‹å¦‚å·¥å…·åç§°ã€ç‰ˆæœ¬å·ç­‰\n* å›¢é˜Ÿçš„è”ç³»ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼šæ‰‹æœºå·ã€è´Ÿè´£äººåç§°ã€ç½‘å€ç­‰\n\n","tags":["k8s"]},{"title":"ã€ŠHaskellè¶£å­¦æŒ‡å—ã€‹- ç¬”è®°","url":"/blog/2018/08/19/Haskellè¶£å­¦æŒ‡å—-ç¬”è®°/","content":"\n### æ¨¡å¼åŒ¹é…ä¸é€’å½’\n\n### ç±»å‹\n\n### ç±»å‹ç±»\n\n### å¸¸ç”¨å‡½æ•°\n\n### Functor\n\n#### Functorå®šå¾‹\n\n### Applicative\n\n#### Applicativeå®šå¾‹\n\n### Monoid\n#### Monoidå®šå¾‹\n\n### Monad\n\n#### Monadå®šå¾‹\n\n#### IO Monad\n\n#### Writer Monad\n\n#### Reader Monad\n\n#### State Monad\n\n#### Error Monad\n\n#### è‡ªå®šä¹‰Monad\n\n\n","tags":["haskell"]},{"title":"Dubboæºç é˜…è¯»ä¹‹æ³¨å†Œä¸­å¿ƒ","url":"/blog/2018/08/17/Dubboæºç é˜…è¯»ä¹‹æ³¨å†Œä¸­å¿ƒ/","content":">æ³¨å†Œä¸­å¿ƒæ˜¯Dubboå®ç°æœåŠ¡åŒ–ç®¡ç†çš„æ ¸å¿ƒç»„ä»¶,ç±»ä¼¼äºç›®å½•æœåŠ¡çš„ä½œç”¨,ä¸»è¦ç”¨æ¥å­˜å‚¨Dubboå‘å¸ƒçš„æœåŠ¡ä¿¡æ¯(è­¬å¦‚æä¾›è€…urlä¸²ã€è·¯ç”±ä¿¡æ¯ç­‰),Dubboæ¡†æ¶æ”¯æŒzookeeperã€redisã€multicastç­‰æ³¨å†Œä¸­å¿ƒ,ä¸‹é¢æˆ‘ä»¬å°±è¯¦ç»†çœ‹ä¸‹Dubboçš„æ³¨å†Œä¸­å¿ƒæ˜¯å¦‚ä½•å®ç°çš„ã€‚\n\nå…ˆæ¥çœ‹ä¸‹æ³¨å†Œä¸­å¿ƒç›¸å…³çš„ç±»å›¾\n![](img/registry.png)\n\n### Registryæ¥å£\n```java\npublic interface Registry extends Node, RegistryService {\n}\n```\n#### Nodeæ¥å£\n```java\npublic interface Node {\n    /**\n     * è·å–url\n     * @return url.\n     */\n    URL getUrl();\n\n    /**\n     * æ˜¯å¦å¯ç”¨\n     * @return available.\n     */\n    boolean isAvailable();\n\n    /**\n     * é”€æ¯\n     */\n    void destroy();\n}\n```\n\n#### RegistryServiceæ¥å£\n```java\npublic interface RegistryService {\n    /**\n     * æ³¨å†Œæ•°æ®ï¼Œä¾‹å¦‚ï¼šæä¾›è€…æœåŠ¡ï¼Œæ¶ˆè´¹è€…æœåŠ¡ï¼Œè·¯ç”±è§„åˆ™ï¼Œè¦†ç›–è§„åˆ™å’Œå…¶ä»–æ•°æ®\n     * æ³¨å†Œæ—¶éœ€è¦æ»¡è¶³ä»¥ä¸‹é‚€çº¦ï¼š\n     * 1ã€å½“Urlè®¾ç½®check = falseå‚æ•°æ—¶ï¼Œæ³¨å†Œå¤±è´¥æ—¶ï¼Œå¼‚å¸¸ä¸ä¼šæŠ›å‡ºï¼Œå¹¶ä¸”ä¼šåœ¨åå°é‡è¯•ï¼Œå¦åˆ™ï¼Œå¼‚å¸¸å°†ä¼šæŠ›å‡º\n     * 2ã€å½“urlè®¾ç½®dynamic=falseå‚æ•°æ—¶ï¼Œå®ƒéœ€è¦è¢«æ°¸ä¹…å­˜å‚¨ï¼Œå¦åˆ™ï¼Œå½“æ³¨å†Œæœ‰å¼‚å¸¸é€€å‡ºæ—¶ï¼Œå®ƒåº”è¯¥è¢«è‡ªåŠ¨åˆ é™¤æ‰\n     * 3ã€å½“urlè®¾ç½®category=routerså‚æ•°æ—¶ï¼Œè¿™æ„å‘³ç€åˆ†ç±»å­˜å‚¨ï¼Œé»˜è®¤çš„åˆ†ç±»æ˜¯æä¾›è€…ï¼Œå¹¶ä¸”æ•°æ®å¯ä»¥é€šè¿‡åˆ†ç±»éƒ¨åˆ†å¾—åˆ°é€šçŸ¥\n     * 4ã€å½“æ³¨å†Œä¸­å¿ƒé‡å¯ï¼Œç½‘ç»œæŠ–åŠ¨ï¼Œæ•°æ®ä¸å¯ä»¥ä¸¢å¤±ï¼ŒåŒ…æ‹¬è‡ªåŠ¨ä»è™šçº¿ä¸­åˆ é™¤æ•°æ®\n     * 5ã€å…è®¸å…·æœ‰ç›¸åŒURLä½†æ˜¯å‚æ•°ä¸åŒçš„URLå…±å­˜ï¼Œä»–ä»¬ä¸å¯ä»¥äº’ç›¸è¦†ç›–\n     *\n     * @param url æ³¨å†Œä¿¡æ¯ï¼Œä¸å…è®¸ä¸ºç©º\n     * ä¾‹å¦‚ï¼šdubbo://10.20.153.10/com.alibaba.foo.BarService?version=1.0.0&application=kylin\n     */\n    void register(URL url);\n\n    /**\n     * å–æ¶ˆæ³¨å†Œ\n     * 1ã€å¦‚æœå®ƒæ˜¯dynamic=falseçš„æŒä¹…åŒ–å­˜å‚¨æ•°æ®ï¼Œæ³¨å†Œä¿¡æ¯ä¸å¯ä»¥å‘ç°æ—¶ï¼Œä¼šæŠ›å‡ºIllegalStateExceptionå¼‚å¸¸ï¼Œ\n     *    å¦åˆ™å®ƒæ˜¯å¿½ç•¥çš„ã€‚\n     * 2ã€æ ¹æ®å®Œæ•´çš„urlåŒ¹é…è¿›è¡Œå–æ¶ˆæ³¨å†Œ\n     * @param url æ³¨å†Œä¿¡æ¯,ä¸å¯ä»¥ä¸ºç©º \n     * ä¾‹å¦‚ï¼š dubbo://10.20.153.10/com.alibaba.foo.BarService?version=1.0.0&application=kylin\n     */\n    void unregister(URL url);\n\n    /**\n     * è®¢é˜…ç¬¦åˆæ¡ä»¶çš„æ³¨å†Œæ•°æ®ï¼Œå¹¶åœ¨æ³¨å†Œæ•°æ®å‘ç”Ÿæ”¹å˜æ—¶è‡ªåŠ¨æ¨é€\n     *\n     * 1ã€å½“URLè®¾ç½®check=falseå‚æ•°æ—¶ï¼Œå½“æ³¨å†Œå¤±è´¥æ—¶ï¼Œå¼‚å¸¸ä¸ä¼šæŠ›å‡ºï¼Œå¹¶åœ¨åå°é‡è¯•ã€‚\n     * 2ã€å½“urlè®¾ç½®category=routersæ—¶ï¼Œå®ƒåªä¼šé€šçŸ¥æŒ‡å®šçš„åˆ†ç±»æ•°æ®ï¼Œå¤šä¸ªåˆ†ç±»ç”¨é€—å·åˆ†éš”ï¼Œ\n     *      å¹¶å…è®¸ä½¿ç”¨*å·åŒ¹é…ï¼Œè¿™è¡¨æ˜æ‰€æœ‰åˆ†ç±»æ•°æ®éƒ½å·²ç»è®¢é˜…ã€‚\n     * 3ã€å…è®¸interface, group, version,classifierä½œä¸ºä¸€ä¸ªæ¡ä»¶æŸ¥è¯¢ï¼Œ\n     *      ä¾‹å¦‚ï¼šinterface=com.alibaba.foo.BarService&version=1.0.0\n     * 4ã€æŸ¥è¯¢æ¡ä»¶å…è®¸*å·åŒ¹é…ï¼Œè®¢é˜…æ‰€æœ‰æ¥å£çš„æ‰€æœ‰æ•°æ®åŒ…çš„æ‰€æœ‰ç‰ˆæœ¬,\n     *      ä¾‹å¦‚ï¼šinterface=*&group=*&version=*&classifier=*\n     * 5ã€å½“æ³¨å†Œä¸­å¿ƒé‡å¯ã€ç½‘ç»œæŠ–åŠ¨æ—¶ï¼Œæœ‰å¿…è¦è‡ªåŠ¨æ¢å¤è®¢é˜…è¯·æ±‚ã€‚\n     * 6ã€å…è®¸å…·æœ‰ç›¸åŒçš„urlä½†æ˜¯å‚æ•°ä¸åŒçš„URLå…±å­˜,å®ƒä»¬ä¸å¯ä»¥äº’ç›¸è¦†ç›–\n     * 7ã€è®¢é˜…çš„è¿›ç¨‹å¿…é¡»æ˜¯é˜»å¡çš„ï¼Œå½“ç¬¬ä¸€æ¡é€šçŸ¥å®Œæˆåè¿”å›ã€‚\n     * @param url è®¢é˜…æ¡ä»¶ï¼Œä¸å…è®¸ä¸ºç©º\n     * ä¾‹å¦‚: consumer://10.20.153.10/com.alibaba.foo.BarService?version=1.0.0&application=kylin\n     * @param listener å˜æ›´äº‹ä»¶çš„ç›‘å¬è€…ï¼Œä¸å¯ä»¥ä¸ºç©º\n     */\n    void subscribe(URL url, NotifyListener listener);\n\n    /**\n     * å–æ¶ˆè®¢é˜…\n     *  1ã€å¦‚æœæ²¡æœ‰è®¢é˜…ï¼Œç›´æ¥å¿½ç•¥\n     *  2ã€å–æ¶ˆè®¢é˜…ï¼Œéœ€è¦URLå…¨åŒ¹é…\n     * @param url  è®¢é˜…æ¡ä»¶ï¼Œä¸å¯ä»¥ä¸ºç©º\n     * ä¾‹å¦‚ï¼š consumer://10.20.153.10/com.alibaba.foo.BarService?version=1.0.0&application=kylin\n     * @param listener å˜æ›´äº‹ä»¶çš„ç›‘å¬è€…,ä¸å…è®¸ä¸ºç©º\n     */\n    void unsubscribe(URL url, NotifyListener listener);\n\n    /**\n     * æŸ¥è¯¢ç¬¦åˆæ¡ä»¶çš„æ³¨å†Œæ•°æ®ï¼Œå¯¹åº”äºè®¢é˜…çš„pushæ¨¡å¼ï¼Œè¿™æ˜¯pullæ¨¡å¼å¹¶åªè¿”å›ä¸€ä¸ªç»“æœ\n     * @param url æŸ¥è¯¢æ¡ä»¶ï¼Œä¸å…è®¸ä¸ºç©º\n     *   e.g. consumer://10.20.153.10/com.alibaba.foo.BarService?version=1.0.0&application=kylin\n     * @return å·²æ³¨å†Œçš„ä¿¡æ¯åˆ—è¡¨, å¯èƒ½ä¸ºç©º, æ„ä¹‰ä¸{NotifyListener#notify(List<URL>)}çš„å‚æ•°ç›¸åŒ.\n     */\n    List<URL> lookup(URL url);\n}\n```\n\n### NotifyListeneræ¥å£\nç›‘å¬å™¨ï¼Œç›‘å¬æœåŠ¡çš„å˜æ›´\n```java\npublic interface NotifyListener {\n    /**\n     * å½“æ”¶åˆ°æœåŠ¡æ›´æ”¹çš„é€šçŸ¥æ—¶è§¦å‘è¯¥æ–¹æ³•\n     * 1ã€å§‹ç»ˆæ˜¯åœ¨æœåŠ¡æ¥å£å’Œæ•°æ®ç±»å‹çš„çº¬åº¦ä¸Šé€šçŸ¥ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ä¼šé€šçŸ¥å±äºä¸€ä¸ªæœåŠ¡çš„éƒ¨åˆ†ç›¸åŒç±»å‹çš„æ•°æ®ï¼Œç”¨æˆ·æ— éœ€æ¯”è¾ƒå…ˆå‰é€šçŸ¥çš„ç»“æœ\n     * 2ã€è®¢é˜…æ—¶çš„ç¬¬ä¸€ä¸ªé€šçŸ¥å¿…é¡»æ˜¯æœåŠ¡æ‰€æœ‰ç±»å‹çš„å®Œæ•´é€šçŸ¥\n     * 3ã€åœ¨å˜æ›´æ—¶ï¼Œå…è®¸å•ç‹¬é€šçŸ¥ä¸åŒç±»å‹çš„æ•°æ®ï¼Œä¾‹å¦‚ï¼šproviders, consumers, routers, overrides,å®ƒåªå…è®¸é€šçŸ¥å…¶ä¸­ä¸€ç§ç±»å‹ï¼Œ\n     *    ä½†æ­¤ç±»å‹çš„æ•°æ®å¿…é¡»æ˜¯å®Œæ•´çš„ï¼Œè€Œä¸æ˜¯å¢é‡çš„\n     * 4ã€å¦‚æœæ•°æ®ç±»å‹ä¸ºç©ºï¼Œåˆ™éœ€è¦é€šè¿‡urlæ•°æ®çš„ç±»åˆ«å‚æ•°æ ‡è¯†ç©ºåè®®\n     * 5ã€notificationsä¿è¯é€šçŸ¥çš„é¡ºåº(å³registryçš„å®ç°),ä¾‹å¦‚ï¼šå•çº¿ç¨‹æ¨é€ã€é˜Ÿåˆ—åºåˆ—åŒ–ã€ç‰ˆæœ¬æ¯”è¾ƒ\n     * @param urls å·²æ³¨å†Œçš„ä¿¡æ¯åˆ—è¡¨,éç©º,è¿™æ„å‘³ç€ï¼Œå®ƒå’ŒRegistryService#lookup(URL)æ–¹æ³•çš„è¿”å›å€¼ç›¸åŒ.\n     */\n    void notify(List<URL> urls);\n}\n```\n\n### AbstractRegistryæŠ½è±¡ç±»\n```java\npublic abstract class AbstractRegistry implements Registry {\n\n    /**\n     * URLåœ°å€åˆ†éš”ç¬¦ï¼Œç”¨æ¥æ–‡ä»¶ç¼“å­˜ï¼ŒæœåŠ¡æä¾›è€…URLåˆ†éš”\n     * URL address separator, used in file cache, service provider URL separation\n     */\n    private static final char URL_SEPARATOR = ' ';\n    /**\n     * URLåœ°å€æ­£åˆ™è¡¨è¾¾å¼åˆ†éš”å™¨ï¼Œç”¨æ¥è§£ææ–‡ä»¶ç¼“å­˜ä¸­çš„æœåŠ¡æä¾›è€…çš„URLåˆ—è¡¨\n     * è¿™é‡Œæ˜¯ç©ºæ ¼åˆ†éš”\n     * URL address separated regular expression for parsing the service provider URL list in the file cache\n     */\n    private static final String URL_SPLIT = \"\\\\s+\";\n    /**\n     * æ—¥å¿—è¾“å‡º\n     * Log output\n     */\n    protected final Logger logger = LoggerFactory.getLogger(getClass());\n    /**\n     * æœ¬åœ°ç£ç›˜ç¼“å­˜ï¼Œå…¶ä¸­keyâ€œvalue.registiesâ€ç”¨æ¥è®°å½•æ³¨å†Œä¸­å¿ƒçš„åˆ—è¡¨ã€‚\n     * å…¶ä»–çš„æ˜¯é€šçŸ¥æœåŠ¡æä¾›è€…çš„åˆ—è¡¨\n     * Local disk cache, where the special key value.registies records the list of registry centers,\n     * and the others are the list of notified service providers\n     */\n    private final Properties properties = new Properties();\n    /**\n     * æ–‡ä»¶ç¼“å­˜å®šæ—¶å†™çº¿ç¨‹\n     * File cache timing writing\n     */\n    private final ExecutorService registryCacheExecutor = Executors.newFixedThreadPool(1, new NamedThreadFactory(\"DubboSaveRegistryCache\", true));\n    /**\n     * æ˜¯å¦åŒæ­¥ä¿å­˜æ–‡ä»¶\n     * Is it synchronized to save the file\n     */\n    private final boolean syncSaveFile;\n    /**\n     * æ¯æ¬¡æ›´æ–°ç¼“å­˜æ–‡ä»¶æ—¶ï¼Œéƒ½ä¼šè‡ªå¢ï¼Œä½œä¸ºç‰ˆæœ¬å·\n     */\n    private final AtomicLong lastCacheChanged = new AtomicLong();\n    /**\n     * å·²æ³¨å†Œçš„åœ°å€\n     * æš´éœ²çš„æœåŠ¡çš„URLé›†åˆï¼Œå³exportå‚æ•°æŒ‡å®šçš„URL\n     */\n    private final Set<URL> registered = new ConcurrentHashSet<URL>();\n    /**\n     * å·²è®¢é˜…çš„è®°å½•\n     * URLå˜åŒ–æ—¶ï¼Œè§¦å‘NotifyListener\n     * ä¾‹å¦‚ï¼š<æœåŠ¡æä¾›è€…URLï¼ŒOverrideListener>\n     */\n    private final ConcurrentMap<URL, Set<NotifyListener>> subscribed = new ConcurrentHashMap<URL, Set<NotifyListener>>();\n    /**\n     * å·²é€šçŸ¥çš„url\n     * ä¼šå°† <è®¢é˜…urlçš„æœåŠ¡å”¯ä¸€åç§°,å¾…é€šçŸ¥ç±»åˆ«Urlåˆ—è¡¨>å†™å…¥æ³¨å†Œä¸­å¿ƒç¼“å­˜æ–‡ä»¶\n     * <è®¢é˜…url,<å¾…é€šçŸ¥ç±»åˆ«, å¾…é€šçŸ¥ç±»åˆ«Urlåˆ—è¡¨>>\n     */\n    private final ConcurrentMap<URL, Map<String, List<URL>>> notified = new ConcurrentHashMap<URL, Map<String, List<URL>>>();\n\n    /**\n     * æ³¨å†Œä¸­å¿ƒURL\n     */\n    private URL registryUrl;\n    /**\n     * æœ¬åœ°ç£ç›˜ç¼“å­˜æ–‡ä»¶(dubboæ³¨å†Œä¸­å¿ƒç¼“å­˜)\n     * Local disk cache file\n     */\n    private File file;\n\n    /**\n     *\n     * @param url multicast://224.5.6.7:1234/com.alibaba.dubbo.registry.RegistryService?application=demo-provider&dubbo=2.0.0&interface=com.alibaba.dubbo.registry.RegistryService&pid=3000&qos.port=22222&timestamp=1528800181027\n     */\n    public AbstractRegistry(URL url) {\n        //æ ¡éªŒurlä¸ä¸ºç©ºï¼Œå¹¶è®¾ç½®registryUrl = url\n        setUrl(url);\n        // Start file save timer\n        //æ˜¯å¦åŒæ­¥ä¿å­˜æ–‡ä»¶ï¼Œé»˜è®¤æ˜¯å¼‚æ­¥\n        syncSaveFile = url.getParameter(Constants.REGISTRY_FILESAVE_SYNC_KEY, false);\n        //æ–‡ä»¶åï¼Œé»˜è®¤å€¼æ˜¯ï¼šC:\\Users\\Administrator/.dubbo/dubbo-registry-demo-provider-224.5.6.7:1234.cache\n        String filename = url.getParameter(Constants.FILE_KEY, System.getProperty(\"user.home\") + \"/.dubbo/dubbo-registry-\" + url.getParameter(Constants.APPLICATION_KEY) + \"-\" + url.getAddress() + \".cache\");\n        File file = null;\n        if (ConfigUtils.isNotEmpty(filename)) {\n            //åˆ›å»ºæ–‡ä»¶ç›®å½•\n            file = new File(filename);\n            if (!file.exists() && file.getParentFile() != null && !file.getParentFile().exists()) {\n                if (!file.getParentFile().mkdirs()) {\n                    throw new IllegalArgumentException(\"Invalid registry store file \" + file + \", cause: Failed to create directory \" + file.getParentFile() + \"!\");\n                }\n            }\n        }\n        this.file = file;\n        //åŠ è½½æ³¨å†Œä¸­å¿ƒç¼“å­˜file\n        loadProperties();\n        //ä½¿ç”¨æ‰€æœ‰çš„urlï¼Œè¿›è¡Œé€šçŸ¥\n        notify(url.getBackupUrls());\n    }\n\n\n    /**\n     * urls ä¸ºç©ºçš„è¯ï¼Œä¼šæ ¹æ®urlç”Ÿæˆä¸€ä¸ªprotocol = emptyçš„URLæ”¾å…¥urlså¹¶è¿”å›ï¼ˆå³NotifyListeneræ¥å£çš„ç¬¬4æ¡é‚€çº¦ï¼‰\n     * @param url è®¢é˜…url\n     * @param urls æ³¨å†Œä¸­å¿ƒurlåˆ—è¡¨\n     * @return\n     */\n    protected static List<URL> filterEmpty(URL url, List<URL> urls) {\n        if (urls == null || urls.isEmpty()) {\n            //urlsä¸ºç©ºçš„è¯ï¼Œåˆ™è®¾ç½®urlçš„protocol = empty\n            List<URL> result = new ArrayList<URL>(1);\n            //è®¾ç½®protocol = empty\n            result.add(url.setProtocol(Constants.EMPTY_PROTOCOL));\n            return result;\n        }\n        return urls;\n    }\n\n    @Override\n    public URL getUrl() {\n        return registryUrl;\n    }\n\n    protected void setUrl(URL url) {\n        if (url == null) {\n            throw new IllegalArgumentException(\"registry url == null\");\n        }\n\t//è®¾ç½®æ³¨å†Œä¸­å¿ƒurl\n        this.registryUrl = url;\n    }\n\n    public Set<URL> getRegistered() {\n        return registered;\n    }\n\n    public Map<URL, Set<NotifyListener>> getSubscribed() {\n        return subscribed;\n    }\n\n    public Map<URL, Map<String, List<URL>>> getNotified() {\n        return notified;\n    }\n\n    public File getCacheFile() {\n        return file;\n    }\n\n    public Properties getCacheProperties() {\n        return properties;\n    }\n\n    public AtomicLong getLastCacheChanged() {\n        return lastCacheChanged;\n    }\n\n    /**\n     * ä¿å­˜æ³¨å†Œä¸­å¿ƒç¼“å­˜æ–‡ä»¶\n     * @param version ç‰ˆæœ¬\n     */\n    public void doSaveProperties(long version) {\n        //å¦‚æœversionå°ä¸å½“å‰çš„ç‰ˆæœ¬å·ï¼Œè¯´æ˜åœ¨æ‰§è¡Œè¯¥æ–¹æ³•æ—¶ï¼ŒlastCacheChangedåˆè¢«æ›´æ–°äº†\n        //å› æ­¤è¿™é‡Œåªéœ€è¦ç›´æ¥è¿”å›,ç­‰å¾…ä¸‹ä¸€æ¬¡æ‰§è¡Œ\n        if (version < lastCacheChanged.get()) {\n            return;\n        }\n        if (file == null) {\n            return;\n        }\n        // Save\n        try {\n            //åˆ›å»ºä¸€ä¸ªæ–‡ä»¶é”\n            File lockfile = new File(file.getAbsolutePath() + \".lock\");\n            if (!lockfile.exists()) {\n                lockfile.createNewFile();\n            }\n            RandomAccessFile raf = new RandomAccessFile(lockfile, \"rw\");\n            try {\n                FileChannel channel = raf.getChannel();\n                try {\n                    //è·å–æ’å®ƒé”\n                    FileLock lock = channel.tryLock();\n                    if (lock == null) {\n                        //ä¸å¯ä»¥é”å®šæ³¨å†Œä¸­å¿ƒç¼“å­˜æ–‡ä»¶,å¿½ç•¥å¹¶ç¨åé‡è¯•\n                        //å¯èƒ½å¤šä¸ªjavaè¿›ç¨‹ä½¿ç”¨è¯¥æ–‡ä»¶ï¼Œè¯·é…ç½®ï¼šdubbo.registry.file=xxx.properties\n                        throw new IOException(\"Can not lock the registry cache file \" + file.getAbsolutePath() + \", ignore and retry later, maybe multi java process use the file, please config: dubbo.registry.file=xxx.properties\");\n                    }\n                    // Save\n                    try {\n                        //ç¼“å­˜æ–‡ä»¶ä¸å­˜åœ¨çš„è¯ï¼Œæ–°åˆ›å»º\n                        if (!file.exists()) {\n                            file.createNewFile();\n                        }\n                        FileOutputStream outputFile = new FileOutputStream(file);\n                        try {\n                            //ä¿å­˜propertiesæ–‡ä»¶\n                            properties.store(outputFile, \"Dubbo Registry Cache\");\n                        } finally {\n                            outputFile.close();\n                        }\n                    } finally {\n                        //é‡Šæ”¾é”\n                        lock.release();\n                    }\n                } finally {\n                    channel.close();\n                }\n            } finally {\n                raf.close();\n            }\n        } catch (Throwable e) {\n            if (version < lastCacheChanged.get()) {\n                return;\n            } else {\n                //å¦‚æœversion >= å½“å‰ç‰ˆæœ¬çš„è¯ï¼Œåˆ™æ‰§è¡Œå¼‚æ­¥ä¿å­˜propertiesæ–‡ä»¶\n                registryCacheExecutor.execute(new SaveProperties(lastCacheChanged.incrementAndGet()));\n            }\n            logger.warn(\"Failed to save registry store file, cause: \" + e.getMessage(), e);\n        }\n    }\n\n    /**\n     * åŠ è½½æ³¨å†Œä¸­å¿ƒç¼“å­˜æ–‡ä»¶\n     */\n    private void loadProperties() {\n        if (file != null && file.exists()) {\n            InputStream in = null;\n            try {\n                in = new FileInputStream(file);\n                properties.load(in);\n                if (logger.isInfoEnabled()) {\n                    logger.info(\"Load registry store file \" + file + \", data: \" + properties);\n                }\n            } catch (Throwable e) {\n                logger.warn(\"Failed to load registry store file \" + file, e);\n            } finally {\n                if (in != null) {\n                    try {\n                        in.close();\n                    } catch (IOException e) {\n                        logger.warn(e.getMessage(), e);\n                    }\n                }\n            }\n        }\n    }\n\n    /**\n     * æ ¹æ®è®¢é˜…urlè·å–å·²ç¼“å­˜çš„å¾…é€šçŸ¥urlåˆ—è¡¨\n     * å³ä»é…ç½®æ–‡ä»¶ä¸­æ‰¾åˆ°å±æ€§keyç­‰äºurl.getServiceKey()çš„å±æ€§å€¼\n     * @param url\n     * @return\n     */\n    public List<URL> getCacheUrls(URL url) {\n        for (Map.Entry<Object, Object> entry : properties.entrySet()) {\n            //è®¢é˜…urlçš„æœåŠ¡å”¯ä¸€åç§°\n            String key = (String) entry.getKey();\n            //ç±»åˆ«å¾…é€šçŸ¥urlåˆ—è¡¨ï¼Œç©ºæ ¼åˆ†éš”\n            String value = (String) entry.getValue();\n\n            if (key != null && key.length() > 0 && key.equals(url.getServiceKey())\n                    //keyçš„ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯å­—æ¯æˆ–è€…æ˜¯ä¸‹åˆ’çº¿\n                    && (Character.isLetter(key.charAt(0)) || key.charAt(0) == '_')\n                    && value != null && value.length() > 0) {\n                //ä½¿ç”¨ç©ºæ ¼åˆ†éš”valueï¼Œæ‹¿åˆ°æ¯ä¸€ä¸ªurlå¹¶æ”¾åˆ°Listä¸­\n                String[] arr = value.trim().split(URL_SPLIT);\n                List<URL> urls = new ArrayList<URL>();\n                for (String u : arr) {\n                    urls.add(URL.valueOf(u));\n                }\n                return urls;\n            }\n        }\n        return null;\n    }\n\n\n    @Override\n    public List<URL> lookup(URL url) {\n        List<URL> result = new ArrayList<URL>();\n        //æ ¹æ®è®¢é˜…urlè·å–å·²é€šçŸ¥çš„urlåˆ—è¡¨\n        Map<String, List<URL>> notifiedUrls = getNotified().get(url);\n        if (notifiedUrls != null && notifiedUrls.size() > 0) {\n            //notifiedUrlsä¸ä¸ºç©º\n            for (List<URL> urls : notifiedUrls.values()) {\n                for (URL u : urls) {\n                    //è¿‡æ»¤æ‰protocol = emptyçš„url\n                    if (!Constants.EMPTY_PROTOCOL.equals(u.getProtocol())) {\n                        result.add(u);\n                    }\n                }\n            }\n        } else {\n            final AtomicReference<List<URL>> reference = new AtomicReference<List<URL>>();\n            NotifyListener listener = new NotifyListener() {\n                @Override\n                public void notify(List<URL> urls) {\n                    reference.set(urls);\n                }\n            };\n            // è®¢é˜…é€»è¾‘ä¿è¯ç¬¬ä¸€æ¬¡notifyåå†è¿”å›\n            subscribe(url, listener);\n            List<URL> urls = reference.get();\n            if (urls != null && !urls.isEmpty()) {\n                for (URL u : urls) {\n                    if (!Constants.EMPTY_PROTOCOL.equals(u.getProtocol())) {\n                        result.add(u);\n                    }\n                }\n            }\n        }\n        return result;\n    }\n\n    @Override\n    public void register(URL url) {\n        if (url == null) {\n            throw new IllegalArgumentException(\"register url == null\");\n        }\n        if (logger.isInfoEnabled()) {\n            logger.info(\"Register: \" + url);\n        }\n        //ä¿å­˜æ³¨å†Œurl\n        registered.add(url);\n    }\n\n    @Override\n    public void unregister(URL url) {\n        if (url == null) {\n            throw new IllegalArgumentException(\"unregister url == null\");\n        }\n        if (logger.isInfoEnabled()) {\n            logger.info(\"Unregister: \" + url);\n        }\n        //å–æ¶ˆæ³¨å†Œurl\n        registered.remove(url);\n    }\n\n    @Override\n    public void subscribe(URL url, NotifyListener listener) {\n        if (url == null) {\n            throw new IllegalArgumentException(\"subscribe url == null\");\n        }\n        if (listener == null) {\n            throw new IllegalArgumentException(\"subscribe listener == null\");\n        }\n        if (logger.isInfoEnabled()) {\n            logger.info(\"Subscribe: \" + url);\n        }\n        //ä¿å­˜è®¢é˜…url\n        Set<NotifyListener> listeners = subscribed.get(url);\n        if (listeners == null) {\n            subscribed.putIfAbsent(url, new ConcurrentHashSet<NotifyListener>());\n            listeners = subscribed.get(url);\n        }\n        listeners.add(listener);\n    }\n\n    @Override\n    public void unsubscribe(URL url, NotifyListener listener) {\n        if (url == null) {\n            throw new IllegalArgumentException(\"unsubscribe url == null\");\n        }\n        if (listener == null) {\n            throw new IllegalArgumentException(\"unsubscribe listener == null\");\n        }\n        if (logger.isInfoEnabled()) {\n            logger.info(\"Unsubscribe: \" + url);\n        }\n        //å–æ¶ˆè®¢é˜…urlçš„listener\n        Set<NotifyListener> listeners = subscribed.get(url);\n        if (listeners != null) {\n            listeners.remove(listener);\n        }\n    }\n\n    /**\n     * æ¢å¤æ³¨å†Œå’Œè®¢é˜…\n     * @throws Exception\n     */\n    protected void recover() throws Exception {\n        //è·å–å·²æ³¨å†Œçš„åœ°å€\n        Set<URL> recoverRegistered = new HashSet<URL>(getRegistered());\n        if (!recoverRegistered.isEmpty()) {\n            if (logger.isInfoEnabled()) {\n                logger.info(\"Recover register url \" + recoverRegistered);\n            }\n            for (URL url : recoverRegistered) {\n                //é‡æ–°æ³¨å†Œurl\n                register(url);\n            }\n        }\n        //è·å–å·²è®¢é˜…çš„è®°å½•\n        Map<URL, Set<NotifyListener>> recoverSubscribed = new HashMap<URL, Set<NotifyListener>>(getSubscribed());\n        if (!recoverSubscribed.isEmpty()) {\n            if (logger.isInfoEnabled()) {\n                logger.info(\"Recover subscribe url \" + recoverSubscribed.keySet());\n            }\n            for (Map.Entry<URL, Set<NotifyListener>> entry : recoverSubscribed.entrySet()) {\n                URL url = entry.getKey();\n                for (NotifyListener listener : entry.getValue()) {\n                    //é‡æ–°è®¢é˜…\n                    subscribe(url, listener);\n                }\n            }\n        }\n    }\n\n    /**\n     * é€šçŸ¥\n     * @param urls æ³¨å†Œä¸­å¿ƒurl\n     */\n    protected void notify(List<URL> urls) {\n        if (urls == null || urls.isEmpty()) {\n            return;\n        }\n        //éå†å·²è®¢é˜…çš„è®°å½•ï¼ˆä¾‹å¦‚æœåŠ¡æš´éœ²æ—¶é‚£é‡Œä¼šè®¢é˜…äº‹ä»¶ï¼‰\n        for (Map.Entry<URL, Set<NotifyListener>> entry : getSubscribed().entrySet()) {\n            //è®¢é˜…url\n            URL url = entry.getKey();\n            //æ£€æµ‹æ˜¯å¦åŒ¹é…\n            if (!UrlUtils.isMatch(url, urls.get(0))) {\n                continue;\n            }\n            Set<NotifyListener> listeners = entry.getValue();\n            if (listeners != null) {\n                for (NotifyListener listener : listeners) {\n                    try {\n                        //é€šçŸ¥æ³¨å†Œä¸­å¿ƒ\n                        notify(url, listener, filterEmpty(url, urls));\n                    } catch (Throwable t) {\n                        logger.error(\"Failed to notify registry event, urls: \" + urls + \", cause: \" + t.getMessage(), t);\n                    }\n                }\n            }\n        }\n    }\n\n    /**\n     * @param url è®¢é˜…url\n     * provider://192.168.99.60:20880/com.alibaba.dubbo.demo.DemoService?anyhost=true&application=demo-provider&category=configurators&check=false&dubbo=2.0.0&generic=false&interface=com.alibaba.dubbo.demo.DemoService&methods=sayHello&pid=7444&side=provider&timestamp=1528870218728\n     * @param listener\n     * @param urls å¾…é€šçŸ¥çš„urls\n     */\n    protected void notify(URL url, NotifyListener listener, List<URL> urls) {\n        if (url == null) {\n            throw new IllegalArgumentException(\"notify url == null\");\n        }\n        if (listener == null) {\n            throw new IllegalArgumentException(\"notify listener == null\");\n        }\n        if ((urls == null || urls.isEmpty()) && !Constants.ANY_VALUE.equals(url.getServiceInterface())) {\n            logger.warn(\"Ignore empty notify urls for subscribe url \" + url);\n            return;\n        }\n        if (logger.isInfoEnabled()) {\n            logger.info(\"Notify urls for subscribe url \" + url + \", urls: \" + urls);\n        }\n        //<category,List<URL>>\n        Map<String, List<URL>> result = new HashMap<String, List<URL>>();\n        //éå†å¾…é€šçŸ¥urlsï¼Œæ ¹æ®urlä¸­çš„categoryå‚æ•°è¿›è¡Œåˆ†ç»„ï¼Œä¿å­˜åˆ°resultä¸­\n        for (URL u : urls) {\n            //urlå’Œuæ˜¯å¦åŒ¹é…(urlçš„èŒƒå›´æ˜¯å¦æ¯”uå¤§)\n            if (UrlUtils.isMatch(url, u)) {\n                //è·å–å¾…é€šçŸ¥urlçš„categoryï¼Œé»˜è®¤å€¼æ˜¯providers\n                String category = u.getParameter(Constants.CATEGORY_KEY, Constants.DEFAULT_CATEGORY);\n                List<URL> categoryList = result.get(category);\n                if (categoryList == null) {\n                    categoryList = new ArrayList<URL>();\n                    result.put(category, categoryList);\n                }\n                categoryList.add(u);\n            }\n        }\n        if (result.size() == 0) {\n            //ç±»åˆ«å¾…é€šçŸ¥urlåˆ—è¡¨ä¸ºç©ºï¼Œç›´æ¥è¿”å›\n            return;\n        }\n        //ä¸‹é¢ä¼šå°†notifiedä¸­çš„urlåŠå…¶values.valuesä¸­çš„URLä¿å­˜åˆ°ç¼“å­˜æ–‡ä»¶ä¸­\n        Map<String, List<URL>> categoryNotified = notified.get(url);\n        if (categoryNotified == null) {\n            notified.putIfAbsent(url, new ConcurrentHashMap<String, List<URL>>());\n            categoryNotified = notified.get(url);\n        }\n        for (Map.Entry<String, List<URL>> entry : result.entrySet()) {\n            //ç±»åˆ«\n            String category = entry.getKey();\n            //ç±»åˆ«å¾…é€šçŸ¥urlåˆ—è¡¨\n            List<URL> categoryList = entry.getValue();\n            //ä¿å­˜<ç±»åˆ«,ç±»åˆ«å¾…é€šçŸ¥urlåˆ—è¡¨>\n            categoryNotified.put(category, categoryList);\n            //ä¿å­˜æ³¨å†Œä¸­å¿ƒç¼“å­˜æ–‡ä»¶(å°†è®¢é˜…urlã€å¾…é€šçŸ¥urlåˆ—è¡¨ä¿å­˜åˆ°ç¼“å­˜æ–‡ä»¶)\n            saveProperties(url);\n            //è§¦å‘é€šçŸ¥(ç±»åˆ«å¾…é€šçŸ¥urlåˆ—è¡¨)\n            listener.notify(categoryList);\n        }\n    }\n\n    /**\n     * ä¿å­˜æ³¨å†Œä¸­å¿ƒç¼“å­˜æ–‡ä»¶\n     * @param url è®¢é˜…url\n     */\n    private void saveProperties(URL url) {\n        if (file == null) {\n            return;\n        }\n        try {\n            //ä¿å­˜å¾…é€šçŸ¥url\n            StringBuilder buf = new StringBuilder();\n            //æ ¹æ®è®¢é˜…urlè·å–ç±»åˆ«map\n            Map<String, List<URL>> categoryNotified = notified.get(url);\n            if (categoryNotified != null) {\n                //éå†ç±»åˆ«å¾…é€šçŸ¥urlåˆ—è¡¨\n                for (List<URL> us : categoryNotified.values()) {\n                    for (URL u : us) {\n                        //å°†å¾…é€šçŸ¥urlæ·»åŠ åˆ°bufä¸­ï¼Œå¤šä¸ªåœ°å€ä½¿ç”¨ç©ºæ ¼åˆ†éš”\n                        if (buf.length() > 0) {\n                            buf.append(URL_SEPARATOR);\n                        }\n                        buf.append(u.toFullString());\n                    }\n                }\n            }\n            //ä¿å­˜é…ç½®åˆ°propertiesæ–‡ä»¶<è®¢é˜…urlçš„æœåŠ¡å”¯ä¸€åç§°æ ‡è¯†,ç±»åˆ«å¾…é€šçŸ¥urlåˆ—è¡¨>\n            properties.setProperty(url.getServiceKey(), buf.toString());\n            //è·å–ç‰ˆæœ¬å·\n            long version = lastCacheChanged.incrementAndGet();\n            if (syncSaveFile) {\n                //åŒæ­¥ä¿å­˜ç¼“å­˜æ–‡ä»¶\n                doSaveProperties(version);\n            } else {\n                //å¼‚æ­¥ä¿å­˜ç¼“å­˜æ–‡ä»¶\n                registryCacheExecutor.execute(new SaveProperties(version));\n            }\n        } catch (Throwable t) {\n            logger.warn(t.getMessage(), t);\n        }\n    }\n\n    @Override\n    public void destroy() {\n        if (logger.isInfoEnabled()) {\n            //é”€æ¯æ³¨å†Œä¸­å¿ƒ\n            logger.info(\"Destroy registry:\" + getUrl());\n        }\n        Set<URL> destroyRegistered = new HashSet<URL>(getRegistered());\n        if (!destroyRegistered.isEmpty()) {\n            //éå†å·²æ³¨å†Œçš„url\n            for (URL url : new HashSet<URL>(getRegistered())) {\n                if (url.getParameter(Constants.DYNAMIC_KEY, true)) {\n                    try {\n                        //urlçš„dynamic = trueï¼Œå–æ¶ˆæ³¨å†Œurl\n                        unregister(url);\n                        if (logger.isInfoEnabled()) {\n                            logger.info(\"Destroy unregister url \" + url);\n                        }\n                    } catch (Throwable t) {\n                        logger.warn(\"Failed to unregister url \" + url + \" to registry \" + getUrl() + \" on destroy, cause: \" + t.getMessage(), t);\n                    }\n                }\n            }\n        }\n        Map<URL, Set<NotifyListener>> destroySubscribed = new HashMap<URL, Set<NotifyListener>>(getSubscribed());\n        if (!destroySubscribed.isEmpty()) {\n            //éå†å·²è®¢é˜…çš„ï¼ŒæŒ¨ä¸ªå–æ¶ˆè®¢é˜…\n            for (Map.Entry<URL, Set<NotifyListener>> entry : destroySubscribed.entrySet()) {\n                //è®¢é˜…çš„url\n                URL url = entry.getKey();\n                for (NotifyListener listener : entry.getValue()) {\n                    try {\n                        //å–æ¶ˆè®¢é˜…url\n                        unsubscribe(url, listener);\n                        if (logger.isInfoEnabled()) {\n                            logger.info(\"Destroy unsubscribe url \" + url);\n                        }\n                    } catch (Throwable t) {\n                        logger.warn(\"Failed to unsubscribe url \" + url + \" to registry \" + getUrl() + \" on destroy, cause: \" + t.getMessage(), t);\n                    }\n                }\n            }\n        }\n    }\n\n    @Override\n    public String toString() {\n        return getUrl().toString();\n    }\n\n    /**\n     * å¼‚æ­¥ä¿å­˜ç¼“å­˜æ–‡ä»¶çš„çº¿ç¨‹\n     */\n    private class SaveProperties implements Runnable {\n        private long version;\n        private SaveProperties(long version) {\n            this.version = version;\n        }\n        @Override\n        public void run() {\n            doSaveProperties(version);\n        }\n    }\n}\n```\n\n### FailbackRegistryæŠ½è±¡ç±»\nFailbackRegistryæŠ½è±¡ç±»å¢åŠ äº†å¤±è´¥é‡è¯•åŠŸèƒ½ï¼ŒMulticastRegistryã€ZookeeperRegistryç­‰éƒ½ç»§æ‰¿è‡ªå®ƒ.\n```java\npublic abstract class FailbackRegistry extends AbstractRegistry {\n\n    /**\n     * æ³¨å†Œä¸­å¿ƒå¤±è´¥é‡è¯•çº¿ç¨‹\n     */\n    private final ScheduledExecutorService retryExecutor =\n            Executors.newScheduledThreadPool(1,\n                    new NamedThreadFactory(\"DubboRegistryFailedRetryTimer\", true));\n\n    /**\n     * ç”¨äºå¤±è´¥é‡è¯•çš„å®šæ—¶å™¨ï¼Œå®šæœŸæ£€æŸ¥æ˜¯æœ‰å¤±è´¥çš„è¯·æ±‚ï¼Œå¦‚æœæœ‰ï¼Œåˆ™æ— é™é‡è¯•\n     */\n    private final ScheduledFuture<?> retryFuture;\n\n    /**\n     * æ³¨å†Œå¤±è´¥çš„URLåˆ—è¡¨\n     */\n    private final Set<URL> failedRegistered = new ConcurrentHashSet<URL>();\n\n    /**\n     * å–æ¶ˆæ³¨å†Œå¤±è´¥çš„URLåˆ—è¡¨\n     */\n    private final Set<URL> failedUnregistered = new ConcurrentHashSet<URL>();\n\n    /**\n     * è®¢é˜…å¤±è´¥çš„è®°å½•\n     * <è®¢é˜…urlï¼Œç›‘å¬>\n     */\n    private final ConcurrentMap<URL, Set<NotifyListener>> failedSubscribed = new ConcurrentHashMap<URL, Set<NotifyListener>>();\n\n    /**\n     * å–æ¶ˆè®¢é˜…å¤±è´¥çš„è®°å½•\n     * <è®¢é˜…urlï¼Œç›‘å¬>\n     */\n    private final ConcurrentMap<URL, Set<NotifyListener>> failedUnsubscribed = new ConcurrentHashMap<URL, Set<NotifyListener>>();\n\n    /**\n     * é€šçŸ¥å¤±è´¥çš„URL\n     */\n    private final ConcurrentMap<URL, Map<NotifyListener, List<URL>>> failedNotified = new ConcurrentHashMap<URL, Map<NotifyListener, List<URL>>>();\n\n    public FailbackRegistry(URL url) {\n        //è®¾ç½®æ³¨å†Œä¸­å¿ƒurl\n        super(url);\n        //è·å–urlå¯¹åº”çš„é‡è¯•é—´éš”æ—¶é—´ï¼Œé»˜è®¤å€¼æ˜¯5ç§’\n        int retryPeriod = url.getParameter(Constants.REGISTRY_RETRY_PERIOD_KEY, Constants.DEFAULT_REGISTRY_RETRY_PERIOD);\n        this.retryFuture = retryExecutor.scheduleWithFixedDelay(new Runnable() {\n            @Override\n            public void run() {\n                //æ£€æµ‹å¹¶è¿æ¥åˆ°æ³¨å†Œä¸­å¿ƒ\n                try {\n\t\t    //æ‰§è¡Œé‡è¯•\n                    retry();\n                } catch (Throwable t) {\n                    logger.error(\"Unexpected error occur at failed retry, cause: \" + t.getMessage(), t);\n                }\n            }\n        }, retryPeriod, retryPeriod, TimeUnit.MILLISECONDS);\n    }\n\n    public Future<?> getRetryFuture() {\n        return retryFuture;\n    }\n\n    public Set<URL> getFailedRegistered() {\n        return failedRegistered;\n    }\n\n    public Set<URL> getFailedUnregistered() {\n        return failedUnregistered;\n    }\n\n    public Map<URL, Set<NotifyListener>> getFailedSubscribed() {\n        return failedSubscribed;\n    }\n\n    public Map<URL, Set<NotifyListener>> getFailedUnsubscribed() {\n        return failedUnsubscribed;\n    }\n\n    public Map<URL, Map<NotifyListener, List<URL>>> getFailedNotified() {\n        return failedNotified;\n    }\n\n    /**\n     * æ·»åŠ è®¢é˜…å¤±è´¥çš„è®°å½•\n     * @param url è®¢é˜…url\n     * @param listener\n     */\n    private void addFailedSubscribed(URL url, NotifyListener listener) {\n        Set<NotifyListener> listeners = failedSubscribed.get(url);\n        if (listeners == null) {\n            failedSubscribed.putIfAbsent(url, new ConcurrentHashSet<NotifyListener>());\n            listeners = failedSubscribed.get(url);\n        }\n        listeners.add(listener);\n    }\n\n    /**\n     * ç§»é™¤è®¢é˜…å¤±è´¥çš„è®°å½•ï¼ˆä»ä¸‰ä¸ªåˆ—è¡¨ä¸­éƒ½ç§»é™¤ï¼‰\n     * @param url è®¢é˜…url\n     * @param listener\n     */\n    private void removeFailedSubscribed(URL url, NotifyListener listener) {\n        //è®¢é˜…å¤±è´¥çš„è®°å½•\n        Set<NotifyListener> listeners = failedSubscribed.get(url);\n        if (listeners != null) {\n            listeners.remove(listener);\n        }\n        //å–æ¶ˆè®¢é˜…å¤±è´¥çš„è®°å½•\n        listeners = failedUnsubscribed.get(url);\n        if (listeners != null) {\n            listeners.remove(listener);\n        }\n        //é€šçŸ¥å¤±è´¥çš„è®°å½•\n        Map<NotifyListener, List<URL>> notified = failedNotified.get(url);\n        if (notified != null) {\n            notified.remove(listener);\n        }\n    }\n\n    @Override\n    public void register(URL url) {\n        //ä¿å­˜urlåˆ°é›†åˆç¼“å­˜ä¸­\n        super.register(url);\n        //ä»å·²å¤±è´¥çš„è®°å½•ä¸­ç§»é™¤è¯¥url\n        failedRegistered.remove(url);\n        failedUnregistered.remove(url);\n        try {\n            //å‘æœåŠ¡ç«¯å‘é€æ³¨å†Œè¯·æ±‚\n            doRegister(url);\n        } catch (Exception e) {\n            Throwable t = e;\n\n            //æ³¨å†Œä¸­å¿ƒurlä»¥åŠæœåŠ¡æä¾›è€…urlä¸­çš„check = trueä¸”urlä¸æ˜¯æ¶ˆè´¹ç«¯\n            boolean check = getUrl().getParameter(Constants.CHECK_KEY, true)\n                    && url.getParameter(Constants.CHECK_KEY, true)\n                    && !Constants.CONSUMER_PROTOCOL.equals(url.getProtocol());\n            //åˆ¤æ–­æ˜¯å¦éœ€è¦è·³è¿‡æ•…éšœæ¢å¤(SkipFailbackWrapperExceptionå¼‚å¸¸åªæ˜¯ä½œä¸ºæ ‡è®°)\n            boolean skipFailback = t instanceof SkipFailbackWrapperException;\n            if (check || skipFailback) {\n                //å¦‚æœå¯åŠ¨æ£€æµ‹æˆ–è€…è·³è¿‡æ•…éšœæ¢å¤çš„è¯ï¼Œåˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸\n                if (skipFailback) {\n                    t = t.getCause();\n                }\n                //æ³¨å†Œurlåˆ°æ³¨å†Œä¸­å¿ƒå‘ç”Ÿå¤±è´¥\n                throw new IllegalStateException(\"Failed to register \" + url + \" to registry \" + getUrl().getAddress() + \", cause: \" + t.getMessage(), t);\n            } else {\n                logger.error(\"Failed to register \" + url + \", waiting for retry, cause: \" + t.getMessage(), t);\n            }\n            //æ³¨å†Œå¤±è´¥çš„è¯ï¼Œå°†urlä¿å­˜åˆ°æ³¨å†Œå¤±è´¥åˆ—è¡¨ä¸­ï¼Œå®šæœŸé‡è¯•\n            failedRegistered.add(url);\n        }\n    }\n\n    @Override\n    public void unregister(URL url) {\n        //ä»ç¼“å­˜é›†åˆä¸­ç§»é™¤è¯¥url\n        super.unregister(url);\n        //ä»å¤±è´¥åˆ—è¡¨ä¸­ç§»é™¤è¯¥url\n        failedRegistered.remove(url);\n        failedUnregistered.remove(url);\n        try {\n            //å‘æœåŠ¡ç«¯å‘é€å–æ¶ˆæ³¨å†Œè¯·æ±‚\n            doUnregister(url);\n        } catch (Exception e) {\n            Throwable t = e;\n            //åˆ¤æ–­æ˜¯å¦å¯åŠ¨æ£€æµ‹\n            boolean check = getUrl().getParameter(Constants.CHECK_KEY, true)\n                    && url.getParameter(Constants.CHECK_KEY, true)\n                    //éæ¶ˆè´¹è€…\n                    && !Constants.CONSUMER_PROTOCOL.equals(url.getProtocol());\n            //æ˜¯å¦è·³è¿‡æ•…éšœæ¢å¤\n            boolean skipFailback = t instanceof SkipFailbackWrapperException;\n            if (check || skipFailback) {\n                if (skipFailback) {\n                    t = t.getCause();\n                }\n                //ç›´æ¥æŠ›å‡ºå¼‚å¸¸\n                throw new IllegalStateException(\"Failed to unregister \" + url + \" to registry \" + getUrl().getAddress() + \", cause: \" + t.getMessage(), t);\n            } else {\n                //å–æ¶ˆæ³¨å†Œurlæ‰§è¡Œå¤±è´¥ï¼Œç­‰å¾…é‡è¯•\n                logger.error(\"Failed to unregister \" + url + \", waiting for retry, cause: \" + t.getMessage(), t);\n            }\n            //å°†å¤±è´¥çš„urlä¿å­˜åˆ°å¤±è´¥åˆ—è¡¨ï¼Œç­‰å¾…å®šæœŸé‡è¯•\n            failedUnregistered.add(url);\n        }\n    }\n\n    @Override\n    public void subscribe(URL url, NotifyListener listener) {\n        //å°†è®¢é˜…ä¿å­˜åˆ°é›†åˆç¼“å­˜\n        super.subscribe(url, listener);\n        //ä»å¤±è´¥åˆ—è¡¨ä¸­ç§»é™¤è¯¥è®¢é˜…è®°å½•\n        removeFailedSubscribed(url, listener);\n        try {\n            //å‘æœåŠ¡ç«¯å‘é€è®¢é˜…è¯·æ±‚\n            doSubscribe(url, listener);\n        } catch (Exception e) {\n            Throwable t = e;\n            //è®¢é˜…å¤±è´¥çš„è¯ï¼Œåˆ™ä»ç¼“å­˜æ–‡ä»¶ä¸­è·å–è¯¥è®¢é˜…urlå¯¹åº”çš„æ³¨å†Œä¸­å¿ƒurlåˆ—è¡¨(å³ç±»åˆ«å¾…é€šçŸ¥urlåˆ—è¡¨)\n            List<URL> urls = getCacheUrls(url);\n            if (urls != null && !urls.isEmpty()) {\n                //è§¦å‘é€šçŸ¥\n                notify(url, listener, urls);\n                //è®¢é˜…å¤±è´¥ï¼Œå°†ä½¿ç”¨ç¼“å­˜åˆ—è¡¨\n                logger.error(\"Failed to subscribe \" + url + \", Using cached list: \" + urls + \" from cache file: \" + getUrl().getParameter(Constants.FILE_KEY, System.getProperty(\"user.home\") + \"/dubbo-registry-\" + url.getHost() + \".cache\") + \", cause: \" + t.getMessage(), t);\n            } else {\n                //æ˜¯å¦å¯åŠ¨æ£€æµ‹\n                boolean check = getUrl().getParameter(Constants.CHECK_KEY, true)\n                        && url.getParameter(Constants.CHECK_KEY, true);\n                //æ˜¯å¦è·³è¿‡æ•…éšœæ¢å¤\n                boolean skipFailback = t instanceof SkipFailbackWrapperException;\n                if (check || skipFailback) {\n                    if (skipFailback) {\n                        t = t.getCause();\n                    }\n                    throw new IllegalStateException(\"Failed to subscribe \" + url + \", cause: \" + t.getMessage(), t);\n                } else {\n                    //è®¢é˜…å¤±è´¥ï¼Œç­‰å¾…é‡è¯•\n                    logger.error(\"Failed to subscribe \" + url + \", waiting for retry, cause: \" + t.getMessage(), t);\n                }\n            }\n            //æ·»åŠ åˆ°è®¢é˜…å¤±è´¥åˆ—è¡¨ï¼Œè¯·æ±‚é‡è¯•\n            addFailedSubscribed(url, listener);\n        }\n    }\n\n    @Override\n    public void unsubscribe(URL url, NotifyListener listener) {\n        //å°†è®¢é˜…ä»é›†åˆç¼“å­˜ä¸­ç§»é™¤\n        super.unsubscribe(url, listener);\n        //ä»å¤±è´¥åˆ—è¡¨ä¸­ç§»é™¤è®¢é˜…\n        removeFailedSubscribed(url, listener);\n        try {\n            //å‘æœåŠ¡ç«¯å‘é€å–æ¶ˆè®¢é˜…è¯·æ±‚\n            doUnsubscribe(url, listener);\n        } catch (Exception e) {\n            Throwable t = e;\n            //æ˜¯å¦å¯åŠ¨æ£€æµ‹\n            boolean check = getUrl().getParameter(Constants.CHECK_KEY, true)\n                    && url.getParameter(Constants.CHECK_KEY, true);\n            //æ˜¯å¦è·³è¿‡æ•…éšœæ¢å¤\n            boolean skipFailback = t instanceof SkipFailbackWrapperException;\n            if (check || skipFailback) {\n                if (skipFailback) {\n                    t = t.getCause();\n                }\n                throw new IllegalStateException(\"Failed to unsubscribe \" + url + \" to registry \" + getUrl().getAddress() + \", cause: \" + t.getMessage(), t);\n            } else {\n                //å–æ¶ˆè®¢é˜…å¤±è´¥ï¼Œç­‰å¾…é‡è¯•\n                logger.error(\"Failed to unsubscribe \" + url + \", waiting for retry, cause: \" + t.getMessage(), t);\n            }\n            //æ·»åŠ åˆ°å¤±è´¥åˆ—è¡¨ä¸­ï¼Œå®šæœŸé‡è¯•\n            Set<NotifyListener> listeners = failedUnsubscribed.get(url);\n            if (listeners == null) {\n                failedUnsubscribed.putIfAbsent(url, new ConcurrentHashSet<NotifyListener>());\n                listeners = failedUnsubscribed.get(url);\n            }\n            listeners.add(listener);\n        }\n    }\n\n    @Override\n    protected void notify(URL url, NotifyListener listener, List<URL> urls) {\n        if (url == null) {\n            throw new IllegalArgumentException(\"notify url == null\");\n        }\n        if (listener == null) {\n            throw new IllegalArgumentException(\"notify listener == null\");\n        }\n        try {\n            //æ‰§è¡Œé€šçŸ¥(è°ƒç”¨çˆ¶ç±»ä¸­çš„notifyæ–¹æ³•)\n            doNotify(url, listener, urls);\n        } catch (Exception t) {\n            //é€šçŸ¥å¤±è´¥ï¼Œæ·»åŠ åˆ°å¤±è´¥åˆ—è¡¨ï¼Œå®šæœŸé‡è¯•\n            Map<NotifyListener, List<URL>> listeners = failedNotified.get(url);\n            if (listeners == null) {\n                failedNotified.putIfAbsent(url, new ConcurrentHashMap<NotifyListener, List<URL>>());\n                listeners = failedNotified.get(url);\n            }\n            listeners.put(listener, urls);\n            logger.error(\"Failed to notify for subscribe \" + url + \", waiting for retry, cause: \" + t.getMessage(), t);\n        }\n    }\n\n    protected void doNotify(URL url, NotifyListener listener, List<URL> urls) {\n        super.notify(url, listener, urls);\n    }\n\n    @Override\n    protected void recover() throws Exception {\n        //è·å–å·²æ³¨å†Œåˆ—è¡¨\n        Set<URL> recoverRegistered = new HashSet<URL>(getRegistered());\n        if (!recoverRegistered.isEmpty()) {\n            if (logger.isInfoEnabled()) {\n                logger.info(\"Recover register url \" + recoverRegistered);\n            }\n            //å°†å·²æ³¨å†Œçš„æ·»åŠ åˆ°å¤±è´¥åˆ—è¡¨ä¸­ï¼Œç­‰å¾…æ¢å¤\n            for (URL url : recoverRegistered) {\n                failedRegistered.add(url);\n            }\n        }\n        //è·å–å·²è®¢é˜…çš„åˆ—è¡¨\n        Map<URL, Set<NotifyListener>> recoverSubscribed = new HashMap<URL, Set<NotifyListener>>(getSubscribed());\n        if (!recoverSubscribed.isEmpty()) {\n            if (logger.isInfoEnabled()) {\n                logger.info(\"Recover subscribe url \" + recoverSubscribed.keySet());\n            }\n            for (Map.Entry<URL, Set<NotifyListener>> entry : recoverSubscribed.entrySet()) {\n                URL url = entry.getKey();\n                for (NotifyListener listener : entry.getValue()) {\n                    //å°†å·²è®¢é˜…çš„æ·»åŠ åˆ°å¤±è´¥åˆ—è¡¨ä¸­ï¼Œç­‰å¾…æ¢å¤\n                    addFailedSubscribed(url, listener);\n                }\n            }\n        }\n    }\n\n    /**\n     * é‡è¯• ä¹‹å‰æ“ä½œå¤±è´¥çš„ è®°å½•\n     */\n    protected void retry() {\n        if (!failedRegistered.isEmpty()) {\n            //å¤„ç†æ³¨å†Œå¤±è´¥çš„æ•°æ®(é‡æ–°æ³¨å†Œ)\n            Set<URL> failed = new HashSet<URL>(failedRegistered);\n            if (failed.size() > 0) {\n                if (logger.isInfoEnabled()) {\n                    logger.info(\"Retry register \" + failed);\n                }\n                try {\n                    for (URL url : failed) {\n                        try {\n                            //é‡è¯•æ³¨å†Œ\n                            doRegister(url);\n                            //é‡æ–°æ³¨å†ŒæˆåŠŸï¼Œåˆ™å°†å…¶ä»å¤±è´¥åˆ—è¡¨ä¸­ç§»é™¤\n                            failedRegistered.remove(url);\n                        } catch (Throwable t) {\n                            // Ignore all the exceptions and wait for the next retry\n                            //å¿½ç•¥æ‰€æœ‰çš„å¼‚å¸¸ï¼Œç­‰å¾…ä¸‹æ¬¡é‡è¯•\n                            logger.warn(\"Failed to retry register \" + failed + \", waiting for again, cause: \" + t.getMessage(), t);\n                        }\n                    }\n                } catch (Throwable t) {\n                    logger.warn(\"Failed to retry register \" + failed + \", waiting for again, cause: \" + t.getMessage(), t);\n                }\n            }\n        }\n        if (!failedUnregistered.isEmpty()) {\n            //å¤„ç†å–æ¶ˆæ³¨å†Œå¤±è´¥çš„æ•°æ®(é‡æ–°æ‰§è¡Œå–æ¶ˆæ³¨å†Œ)\n            Set<URL> failed = new HashSet<URL>(failedUnregistered);\n            if (!failed.isEmpty()) {\n                if (logger.isInfoEnabled()) {\n                    logger.info(\"Retry unregister \" + failed);\n                }\n                try {\n                    for (URL url : failed) {\n                        try {\n                            //é‡è¯•å–æ¶ˆæ³¨å†Œ\n                            doUnregister(url);\n                            //é‡è¯•æˆåŠŸï¼Œåˆ™ä»å¤±è´¥åˆ—è¡¨ä¸­ç§»é™¤å‡ºå»\n                            failedUnregistered.remove(url);\n                        } catch (Throwable t) { // Ignore all the exceptions and wait for the next retry\n                            logger.warn(\"Failed to retry unregister  \" + failed + \", waiting for again, cause: \" + t.getMessage(), t);\n                        }\n                    }\n                } catch (Throwable t) { // Ignore all the exceptions and wait for the next retry\n                    logger.warn(\"Failed to retry unregister  \" + failed + \", waiting for again, cause: \" + t.getMessage(), t);\n                }\n            }\n        }\n        if (!failedSubscribed.isEmpty()) {\n            //å¤„ç†è®¢é˜…å¤±è´¥çš„æ•°æ®\n            Map<URL, Set<NotifyListener>> failed = new HashMap<URL, Set<NotifyListener>>(failedSubscribed);\n            for (Map.Entry<URL, Set<NotifyListener>> entry : new HashMap<URL, Set<NotifyListener>>(failed).entrySet()) {\n                if (entry.getValue() == null || entry.getValue().size() == 0) {\n                    //å°†å¾…é€šçŸ¥urlåˆ—è¡¨ä¸ºç©ºçš„æ•°æ®ç§»é™¤å‡ºå»\n                    failed.remove(entry.getKey());\n                }\n            }\n            if (failed.size() > 0) {\n                if (logger.isInfoEnabled()) {\n                    logger.info(\"Retry subscribe \" + failed);\n                }\n                try {\n                    for (Map.Entry<URL, Set<NotifyListener>> entry : failed.entrySet()) {\n                        URL url = entry.getKey();\n                        Set<NotifyListener> listeners = entry.getValue();\n                        for (NotifyListener listener : listeners) {\n                            try {\n                                //é‡è¯•è®¢é˜…\n                                doSubscribe(url, listener);\n                                //è®¢é˜…æˆåŠŸï¼Œä»å¤±è´¥åˆ—è¡¨ä¸­ç§»é™¤å‡ºå»\n                                listeners.remove(listener);\n                            } catch (Throwable t) {\n                                logger.warn(\"Failed to retry subscribe \" + failed + \", waiting for again, cause: \" + t.getMessage(), t);\n                            }\n                        }\n                    }\n                } catch (Throwable t) { // Ignore all the exceptions and wait for the next retry\n                    logger.warn(\"Failed to retry subscribe \" + failed + \", waiting for again, cause: \" + t.getMessage(), t);\n                }\n            }\n        }\n        if (!failedUnsubscribed.isEmpty()) {\n            //å¤„ç†å–æ¶ˆè®¢é˜…å¤±è´¥çš„æ•°æ®\n            Map<URL, Set<NotifyListener>> failed = new HashMap<URL, Set<NotifyListener>>(failedUnsubscribed);\n            for (Map.Entry<URL, Set<NotifyListener>> entry : new HashMap<URL, Set<NotifyListener>>(failed).entrySet()) {\n                if (entry.getValue() == null || entry.getValue().isEmpty()) {\n                    //å°†å¾…é€šçŸ¥urlåˆ—è¡¨ä¸ºç©ºçš„æ•°æ®ç§»é™¤å‡ºå»\n                    failed.remove(entry.getKey());\n                }\n            }\n            if (failed.size() > 0) {\n                if (logger.isInfoEnabled()) {\n                    logger.info(\"Retry unsubscribe \" + failed);\n                }\n                try {\n                    for (Map.Entry<URL, Set<NotifyListener>> entry : failed.entrySet()) {\n                        URL url = entry.getKey();\n                        Set<NotifyListener> listeners = entry.getValue();\n                        for (NotifyListener listener : listeners) {\n                            try {\n                                //é‡è¯•å–æ¶ˆè®¢é˜…\n                                doUnsubscribe(url, listener);\n                                //é‡è¯•æˆåŠŸï¼Œä»å¤±è´¥åˆ—è¡¨ä¸­ç§»é™¤\n                                listeners.remove(listener);\n                            } catch (Throwable t) { // Ignore all the exceptions and wait for the next retry\n                                logger.warn(\"Failed to retry unsubscribe \" + failed + \", waiting for again, cause: \" + t.getMessage(), t);\n                            }\n                        }\n                    }\n                } catch (Throwable t) { // Ignore all the exceptions and wait for the next retry\n                    logger.warn(\"Failed to retry unsubscribe \" + failed + \", waiting for again, cause: \" + t.getMessage(), t);\n                }\n            }\n        }\n        if (!failedNotified.isEmpty()) {\n            //å¤„ç†é€šçŸ¥å¤±è´¥çš„æ•°æ®\n            Map<URL, Map<NotifyListener, List<URL>>> failed = new HashMap<URL, Map<NotifyListener, List<URL>>>(failedNotified);\n            for (Map.Entry<URL, Map<NotifyListener, List<URL>>> entry : new HashMap<URL, Map<NotifyListener, List<URL>>>(failed).entrySet()) {\n                if (entry.getValue() == null || entry.getValue().size() == 0) {\n                    failed.remove(entry.getKey());\n                }\n            }\n            if (failed.size() > 0) {\n                if (logger.isInfoEnabled()) {\n                    logger.info(\"Retry notify \" + failed);\n                }\n                try {\n                    for (Map<NotifyListener, List<URL>> values : failed.values()) {\n                        for (Map.Entry<NotifyListener, List<URL>> entry : values.entrySet()) {\n                            try {\n                                NotifyListener listener = entry.getKey();\n                                List<URL> urls = entry.getValue();\n                                //é‡è¯•é€šçŸ¥\n                                listener.notify(urls);\n                                //é‡è¯•æˆåŠŸï¼Œä»å¤±è´¥åˆ—è¡¨ä¸­ç§»é™¤\n                                values.remove(listener);\n                            } catch (Throwable t) { // Ignore all the exceptions and wait for the next retry\n                                logger.warn(\"Failed to retry notify \" + failed + \", waiting for again, cause: \" + t.getMessage(), t);\n                            }\n                        }\n                    }\n                } catch (Throwable t) { // Ignore all the exceptions and wait for the next retry\n                    logger.warn(\"Failed to retry notify \" + failed + \", waiting for again, cause: \" + t.getMessage(), t);\n                }\n            }\n        }\n    }\n\n    @Override\n    public void destroy() {\n        //è°ƒç”¨çˆ¶ç±»çš„é”€æ¯é€»è¾‘,å–æ¶ˆæ³¨å†Œç­‰\n        super.destroy();\n        try {\n            //åœæ­¢å®šæ—¶é‡è¯•çº¿ç¨‹\n            retryFuture.cancel(true);\n        } catch (Throwable t) {\n            logger.warn(t.getMessage(), t);\n        }\n    }\n\n    // ==== Template method ====\n\n    /**\n     * æ³¨å†Œ\n     * @param url\n     */\n    protected abstract void doRegister(URL url);\n\n    /**\n     * å–æ¶ˆæ³¨å†Œ\n     * @param url\n     */\n    protected abstract void doUnregister(URL url);\n\n    /**\n     * è®¢é˜…\n     * @param url\n     * @param listener\n     */\n    protected abstract void doSubscribe(URL url, NotifyListener listener);\n\n    /**\n     * å–æ¶ˆè®¢é˜…\n     * @param url\n     * @param listener\n     */\n    protected abstract void doUnsubscribe(URL url, NotifyListener listener);\n}\n```\n\n#### DubboRegistryç±»\n```java\npublic class DubboRegistry extends FailbackRegistry {\n\n    private final static Logger logger = LoggerFactory.getLogger(DubboRegistry.class);\n\n    /**\n     * é‡æ–°è¿æ¥æ£€æµ‹å‘¨æœŸï¼š3ç§’\n     */\n    private static final int RECONNECT_PERIOD_DEFAULT = 3 * 1000;\n\n    /**\n     * é‡æ–°è¿æ¥å®šæ—¶çº¿ç¨‹\n     */\n    private final ScheduledExecutorService scheduledExecutorService =\n            Executors.newScheduledThreadPool(1, new NamedThreadFactory(\"DubboRegistryReconnectTimer\", true));\n\n    /**\n     * é‡æ–°è¿æ¥å®šæ—¶å™¨ï¼Œå®šæœŸæ£€æŸ¥è¿æ¥æ˜¯å¦å¯ç”¨ï¼Œå¦‚æœä¸å¯ç”¨ï¼Œæ— é™é‡è¿\n     */\n    private final ScheduledFuture<?> reconnectFuture;\n\n    /**\n     * å®¢æˆ·ç«¯è·å–å¤„ç†çš„é”\n     * é”å®šå®¢æˆ·ç«¯å®ä¾‹çš„åˆ›å»ºè¿‡ç¨‹ï¼Œé˜²æ­¢é‡å¤å®¢æˆ·ç«¯\n     */\n    private final ReentrantLock clientLock = new ReentrantLock();\n\n    private final Invoker<RegistryService> registryInvoker;\n    \n    /**\n     * æ³¨å†Œä¸­å¿ƒ\n     */\n    private final RegistryService registryService;\n\n    public DubboRegistry(Invoker<RegistryService> registryInvoker, RegistryService registryService) {\n        //è®¾ç½®æ³¨å†Œä¸­å¿ƒurlï¼ˆregistryInvoker.getUrl()ï¼‰\n        super(registryInvoker.getUrl());\n        this.registryInvoker = registryInvoker;\n        this.registryService = registryService;\n        // å¯åŠ¨é‡è¿çº¿ç¨‹\n        int reconnectPeriod = registryInvoker.getUrl()\n                .getParameter(Constants.REGISTRY_RECONNECT_PERIOD_KEY, RECONNECT_PERIOD_DEFAULT);\n        reconnectFuture = scheduledExecutorService.scheduleWithFixedDelay(new Runnable() {\n            @Override\n            public void run() {\n                //æ£€æµ‹å¹¶è¿æ¥åˆ°æ³¨å†Œä¸­å¿ƒ\n                try {\n                    connect();\n                } catch (Throwable t) { \n                    logger.error(\"Unexpected error occur at reconnect, cause: \" + t.getMessage(), t);\n                }\n            }\n        }, reconnectPeriod, reconnectPeriod, TimeUnit.MILLISECONDS);\n    }\n    \n    /**\n     * è¿æ¥åˆ°æ³¨å†Œä¸­å¿ƒ\n     */\n    protected final void connect() {\n        try {\n            //æ£€æµ‹æ˜¯å¦æ˜¯å·²è¿æ¥çš„\n            if (isAvailable()) {\n                return;\n            }\n            if (logger.isInfoEnabled()) {\n                logger.info(\"Reconnect to registry \" + getUrl());\n            }\n            //è¿æ¥å‰å…ˆä¸Šé”\n            clientLock.lock();\n            try {\n                // Double check whether or not it is connected\n                //å†æ¬¡æ£€æµ‹æ˜¯å¦å·²è¿æ¥\n                if (isAvailable()) {\n                    return;\n                }\n                //æ‰§è¡Œæ¢å¤\n                recover();\n            } finally {\n                //é‡Šæ”¾é”\n                clientLock.unlock();\n            }\n        } catch (Throwable t) {\n            // å¦‚æœè®¾ç½®äº†check = trueï¼Œåˆ™ç›´æ¥æŠ›å¼‚å¸¸ï¼Œå¦åˆ™å¿½ç•¥å¼‚å¸¸ï¼Œç­‰å¾…ä¸‹æ¬¡é‡è¯•\n            if (getUrl().getParameter(Constants.CHECK_KEY, true)) {\n                if (t instanceof RuntimeException) {\n                    throw (RuntimeException) t;\n                }\n                throw new RuntimeException(t.getMessage(), t);\n            }\n            logger.error(\"Failed to connect to registry \" + getUrl().getAddress() + \" from provider/consumer \" + NetUtils.getLocalHost() + \" use dubbo \" + Version.getVersion() + \", cause: \" + t.getMessage(), t);\n        }\n    }\n\n    @Override\n    public boolean isAvailable() {\n        //registryInvokerä¸ºç©ºçš„è¯è¯´æ˜ä¸å¯ç”¨ï¼Œç›´æ¥è¿”å›\n        if (registryInvoker == null) {\n            return false;\n        }\n        return registryInvoker.isAvailable();\n    }\n\n    @Override\n    public void destroy() {\n        super.destroy();\n        try {\n            if (!reconnectFuture.isCancelled()) {\n                //å–æ¶ˆé‡è¿å®šæ—¶å™¨\n                reconnectFuture.cancel(true);\n            }\n        } catch (Throwable t) {\n            logger.warn(\"Failed to cancel reconnect timer\", t);\n        }\n        //é”€æ¯registryInvoker\n        registryInvoker.destroy();\n    }\n\n    @Override\n    protected void doRegister(URL url) {\n        //äº¤ç”±registryServiceæ¥å®Œæˆ\n        registryService.register(url);\n    }\n\n    @Override\n    protected void doUnregister(URL url) {\n        registryService.unregister(url);\n    }\n\n    @Override\n    protected void doSubscribe(URL url, NotifyListener listener) {\n        registryService.subscribe(url, listener);\n    }\n\n    @Override\n    protected void doUnsubscribe(URL url, NotifyListener listener) {\n        registryService.unsubscribe(url, listener);\n    }\n\n    @Override\n    public List<URL> lookup(URL url) {\n        return registryService.lookup(url);\n    }\n}\n```\nFailbackRegistryçš„æ³¨å†Œä¸­å¿ƒå®ç°ç±»ï¼Œå¦‚ZookeeperRegistryç±»ç­‰ï¼Œå°†ä¼šåœ¨å•ç‹¬çš„å°èŠ‚è¿›è¡Œè¯¦ç»†è®²è§£ï¼Œè¿™é‡Œå°±å…ˆä¸ä»‹ç»äº†ã€‚\n\n### RegistryFactoryæ¥å£\n```java\n@SPI(\"dubbo\")\npublic interface RegistryFactory {\n    /**\n     * æ ¹æ®urlè·å–æ³¨å†Œä¸­å¿ƒå®ä¾‹\n     *\n     * 1ã€å½“è®¾ç½®check=falseæ—¶ï¼Œé“¾æ¥ä¸ä¼šæ£€æµ‹ï¼Œé™¤æ­¤ä¹‹å¤–å½“æ–­å¼€è¿æ¥æ—¶å°†ä¼šæŠ›å¼‚å¸¸\n     * 2ã€æ”¯æŒURLä¸Šçš„username:passwordæˆæƒè®¤è¯\n     * 3ã€æ”¯æŒbackup=10.20.153.10é…ç½®å€™é€‰æ³¨å†Œä¸­å¿ƒé›†ç¾¤åœ°å€\n     * 4ã€æ”¯æŒfile=registry.cacheæœ¬åœ°ç£ç›˜æ–‡ä»¶ç¼“å­˜\n     * 5ã€æ”¯æŒtimeout=1000è¯·æ±‚è¶…æ—¶é…ç½®\n     * 6ã€æ”¯æŒsession=60000é…ç½®sessionè¶…æ—¶æˆ–è€…åˆ°æœŸè®¾ç½®\n     * @param url æ³¨å†Œä¸­å¿ƒåœ°å€ï¼Œä¸å…è®¸ä¸ºç©º\n     * @return æ³¨å†Œä¸­å¿ƒå¼•ç”¨ï¼Œæ°¸ä¸è¿”å›ç©ºå€¼\n     */\n    @Adaptive({\"protocol\"})\n    Registry getRegistry(URL url);\n}\n```\n#### AbstractRegistryFactoryæŠ½è±¡ç±»\n```java\npublic abstract class AbstractRegistryFactory implements RegistryFactory {\n\n    private static final Logger LOGGER = LoggerFactory.getLogger(AbstractRegistryFactory.class);\n\n    /**\n     * ç”¨æ¥é”å®šè·å–æ³¨å†Œä¸­å¿ƒå®ä¾‹æ—¶çš„è¿‡ç¨‹\n     */\n    private static final ReentrantLock LOCK = new ReentrantLock();\n\n    /**\n     * æ³¨å†Œä¸­å¿ƒé›†åˆ\n     * Map<RegistryAddress, Registry>\n     * key = multicast://224.5.6.7:1234/com.alibaba.dubbo.registry.RegistryService\n     */\n    private static final Map<String, Registry> REGISTRIES = new ConcurrentHashMap<String, Registry>();\n\n    /**\n     * è·å–æ‰€æœ‰æ³¨å†Œä¸­å¿ƒ\n     * @return all registries\n     */\n    public static Collection<Registry> getRegistries() {\n        return Collections.unmodifiableCollection(REGISTRIES.values());\n    }\n\n    /**\n     * å…³é—­æ‰€æœ‰åˆ›å»ºçš„æ³¨å†Œä¸­å¿ƒ\n     */\n    public static void destroyAll() {\n        //é”å®šæ³¨å†Œä¸­å¿ƒå…³é—­è¿‡ç¨‹\n        LOCK.lock();\n        try {\n            for (Registry registry : getRegistries()) {\n                try {\n                    //è°ƒç”¨destroy()æ–¹æ³•è¿›è¡Œé”€æ¯\n                    registry.destroy();\n                } catch (Throwable e) {\n                    LOGGER.error(e.getMessage(), e);\n                }\n            }\n            //æ¸…ç†ç¼“å­˜\n            REGISTRIES.clear();\n        } finally {\n            //é‡Šæ”¾é”\n            LOCK.unlock();\n        }\n    }\n\n    @Override\n    public Registry getRegistry(URL url) {\n        //è®¾ç½®pathå±æ€§\n        url = url.setPath(RegistryService.class.getName())\n                //æ·»åŠ interface = com.alibaba.dubbo.registry.RegistryService\n                .addParameter(Constants.INTERFACE_KEY, RegistryService.class.getName())\n                //ç§»é™¤exportã€referå‚æ•°\n                .removeParameters(Constants.EXPORT_KEY, Constants.REFER_KEY);\n        //key = multicast://224.5.6.7:1234/com.alibaba.dubbo.registry.RegistryService\n        String key = url.toServiceString();\n        // Lock the registry access process to ensure a single instance of the registry\n        //åŠ é”,ç¡®ä¿è¯¥keyå¯¹åº”çš„æ³¨å†Œä¸­å¿ƒä¸ºå•ä¾‹\n        LOCK.lock();\n        try {\n            Registry registry = REGISTRIES.get(key);\n            if (registry != null) {\n                //ç¼“å­˜ä¸­å­˜åœ¨ï¼Œç›´æ¥è¿”å›\n                return registry;\n            }\n            //æ ¹æ®urlåˆ›å»ºæ³¨å†Œä¸­å¿ƒå®ä¾‹ï¼Œè¿™é‡Œç”±å­ç±»æ¥å®ç°\n            registry = createRegistry(url);\n            if (registry == null) {\n\t        //åˆ›å»ºå¤±è´¥\n                throw new IllegalStateException(\"Can not create registry \" + url);\n            }\n            //æ”¾å…¥ç¼“å­˜ï¼Œå¹¶è¿”å›\n            REGISTRIES.put(key, registry);\n            return registry;\n        } finally {\n            // é‡Šæ”¾é”\n            LOCK.unlock();\n        }\n    }\n\n    /**\n     * åˆ›å»ºæ³¨å†Œä¸­å¿ƒå®ä¾‹\n     * @param url æ³¨å†Œä¸­å¿ƒurl\n     * @return\n     */\n    protected abstract Registry createRegistry(URL url);\n}\n```\nAbstractRegistryFactoryçš„å®ç°ç±»ï¼Œå¦‚ZookeeperRegistryFactoryç­‰ç±»ï¼Œå°†åœ¨ç›¸å…³çš„å°èŠ‚å•ç‹¬ä»‹ç»ï¼Œè¿™é‡Œå°±ä¸å¤šä»‹ç»äº†ã€‚\n\n### Directoryæ¥å£\næ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹é‚£Directoryæ¥å£ç›¸å…³çš„å†…å®¹\n```java\npublic interface Directory<T> extends Node {\n\n    /**\n     * è·å–æœåŠ¡ç±»å‹\n     */\n    Class<T> getInterface();\n\n    /**\n     * è·å–invokersåˆ—è¡¨\n     */\n    List<Invoker<T>> list(Invocation invocation) throws RpcException;\n}\n```\n\n#### AbstractDirectoryæŠ½è±¡ç±»\n```java\npublic abstract class AbstractDirectory<T> implements Directory<T> {\n    \n    /**\n     * æ³¨å†Œä¸­å¿ƒurl\n     */\n    private final URL url;\n\n    /**\n     * Directoryæ˜¯å¦å·²é”€æ¯\n     */\n    private volatile boolean destroyed = false;\n\n    /**\n     * æ¶ˆè´¹è€…url\n     */\n    private volatile URL consumerUrl;\n\n    /**\n     * è·¯ç”±åˆ—è¡¨\n     */\n    private volatile List<Router> routers;\n\n    public AbstractDirectory(URL url, URL consumerUrl, List<Router> routers) {\n        if (url == null) {\n            throw new IllegalArgumentException(\"url == null\");\n        }\n        this.url = url;\n        this.consumerUrl = consumerUrl;\n        //è®¾ç½®è·¯ç”±\n        setRouters(routers);\n    }\n\t\n    /**\n     * ä»æ­¤listæ–¹æ³•è¿”å›çš„InvokerListï¼Œå·²ç»è¢«Routersè¿‡æ»¤\n     */\n    @Override\n    public List<Invoker<T>> list(Invocation invocation) throws RpcException {\n        if (destroyed) {\n            throw new RpcException(\"Directory already destroyed .url: \" + getUrl());\n        }\n        //æ ¹æ®invocationè·å–invokersåˆ—è¡¨(æ ¹æ®æ–¹æ³•åæŸ¥è¯¢ç¼“å­˜methodInvokerMap)\n        List<Invoker<T>> invokers = doList(invocation);\n        List<Router> localRouters = this.routers;\n        if (localRouters != null && !localRouters.isEmpty()) {\n\t    //éå†è·¯ç”±\n            for (Router router : localRouters) {\n                try {\n                    if (router.getUrl() == null || router.getUrl().getParameter(Constants.RUNTIME_KEY, false)) {\n\t\t\t//å¦‚æœurlçš„runtimeé…ç½®ä¸ºtrue,åˆ™æ¯æ¬¡éƒ½ä¼šè¿›è¡Œroute\n\t\t\t//æ‰§è¡Œè·¯ç”±ï¼Œè¿›è¡Œè¿‡æ»¤\n                        invokers = router.route(invokers, getConsumerUrl(), invocation);\n                    }\n                } catch (Throwable t) {\n                    logger.error(\"Failed to execute router: \" + getUrl() + \", cause: \" + t.getMessage(), t);\n                }\n            }\n        }\n        return invokers;\n    }\n\n    /**\n     * è®¾ç½®è·¯ç”±\n     * 1ã€æ·»åŠ ï¼šæ”¶åˆ°notifyé€šçŸ¥çš„routersã€å½“å‰urlçš„routerå‚æ•°ã€new MockInvokersSelector()\n     * 2ã€å°†routersæ’åº\n     * 3ã€ç¼“å­˜routers\n     * @param routers æ”¶åˆ°notifyé€šçŸ¥çš„routers\n     */\n    protected void setRouters(List<Router> routers) {\n        routers = routers == null ? new ArrayList<Router>() : new ArrayList<Router>(routers);\n        //è·å–è·¯ç”±å·¥å‚æ‰©å±•åç§°\n        String routerkey = url.getParameter(Constants.ROUTER_KEY);\n        if (routerkey != null && routerkey.length() > 0) {\n            //æ ¹æ®è·¯ç”±å·¥å‚æ‰©å±•åè·å–æ‰©å±•å®ä¾‹\n            RouterFactory routerFactory = ExtensionLoader.getExtensionLoader(RouterFactory.class).getExtension(routerkey);\n            //æ ¹æ®urlè·å–è·¯ç”±å®ä¾‹ï¼Œå¹¶æ”¾å…¥routers\n            routers.add(routerFactory.getRouter(url));\n        }\n        //æ·»åŠ æ”¯æŒmockåè®®çš„invokeré€‰æ‹©å™¨\n        routers.add(new MockInvokersSelector());\n        //æ’åº\n        Collections.sort(routers);\n        this.routers = routers;\n    }\n    /**\n     * æ ¹æ®invocationè·å–invokersåˆ—è¡¨\n     * @param invocation\n     * @return\n     * @throws RpcException\n     */\n    protected abstract List<Invoker<T>> doList(Invocation invocation) throws RpcException;\n}\n```\n#### RegistryDirectoryå®ç°ç±»\nè¯¥å®ç°ç±»ï¼Œæˆ‘ä»¬åœ¨ä¸Šä¸€å°èŠ‚ã€ŠDubboæºç é˜…è¯»ä¹‹æœåŠ¡å¼•ç”¨ã€‹ä¸­å·²ç»è¯¦ç»†ä»‹ç»è¿‡ï¼Œè¿™é‡Œåªç®€å•çœ‹ä¸‹å‰©ä½™çš„æ–¹æ³•\n```java\npublic class RegistryDirectory<T> extends AbstractDirectory<T> implements NotifyListener {\n\n    //ç¼“å­˜ <æœåŠ¡url, Invoker>\n    private volatile Map<String, Invoker<T>> urlInvokerMap;\n\n    //ç¼“å­˜ <æœåŠ¡æ–¹æ³•åç§°,List<Invoker>>\n    private volatile Map<String, List<Invoker<T>>> methodInvokerMap;\n\n    /**\n     * é€šè¿‡è°ƒç”¨æ–¹æ³•åä»æœ¬åœ°ç¼“å­˜ä¸­æ‰¾åˆ°invokers\n     * @param invocation\n     * @return\n     */\n    @Override\n    public List<Invoker<T>> doList(Invocation invocation) {\n        if (forbidden) {\n            //1ã€æ²¡æœ‰æœåŠ¡æä¾›è€…ã€‚ 2ã€æœåŠ¡æä¾›è€…è¢«ç¦ç”¨\n            throw new RpcException(RpcException.FORBIDDEN_EXCEPTION,\n                \"No provider available from registry \" + getUrl().getAddress() + \" for service \" + getConsumerUrl().getServiceKey() + \" on consumer \" +  NetUtils.getLocalHost()\n                        + \" use dubbo version \" + Version.getVersion() + \", please check status of providers(disabled, not registered or in blacklist).\");\n        }\n        List<Invoker<T>> invokers = null;\n        Map<String, List<Invoker<T>>> localMethodInvokerMap = this.methodInvokerMap;\n        if (localMethodInvokerMap != null && localMethodInvokerMap.size() > 0) {\n            //è·å–è°ƒç”¨çš„æ–¹æ³•åç§°\n            String methodName = RpcUtils.getMethodName(invocation);\n            //è·å–è°ƒç”¨çš„æ–¹æ³•å‚æ•°\n            Object[] args = RpcUtils.getArguments(invocation);\n            if (args != null && args.length > 0 && args[0] != null \n\t\t\t&& (args[0] instanceof String || args[0].getClass().isEnum())) {\n                //ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å­—ç¬¦ä¸²ç±»å‹æˆ–è€…æšä¸¾ç±»å‹\n                //å¯ä»¥æ ¹æ®ç¬¬ä¸€ä¸ªå‚æ•°æšä¸¾è·¯ç”±\n                invokers = localMethodInvokerMap.get(methodName + \".\" + args[0]);\n            }\n            if (invokers == null) {\n                //é€šè¿‡æ–¹æ³•åç§°æŸ¥è¯¢\n                invokers = localMethodInvokerMap.get(methodName);\n            }\n            if (invokers == null) {\n                //é€šè¿‡*æŸ¥è¯¢\n                invokers = localMethodInvokerMap.get(Constants.ANY_VALUE);\n            }\n            if (invokers == null) {\n                //éå†æœ¬åœ°ç¼“å­˜ï¼Œæ‰¾åˆ°æœ€åä¸€ä¸ªinvokers\n                Iterator<List<Invoker<T>>> iterator = localMethodInvokerMap.values().iterator();\n                if (iterator.hasNext()) {\n                    invokers = iterator.next();\n                }\n            }\n        }\n        return invokers == null ? new ArrayList<Invoker<T>>(0) : invokers;\n    }\n\n    @Override\n    public boolean isAvailable() {\n        if (isDestroyed()) {\n            return false;\n        }\n        Map<String, Invoker<T>> localUrlInvokerMap = urlInvokerMap;\n        if (localUrlInvokerMap != null && localUrlInvokerMap.size() > 0) {\n            for (Invoker<T> invoker : new ArrayList<Invoker<T>>(localUrlInvokerMap.values())) {\n                if (invoker.isAvailable()) {\n                    //æœ¬åœ°ç¼“å­˜ä¸­çš„invokerï¼Œå¦‚æœæœ‰ä¸€ä¸ªå¯ç”¨ï¼Œå°±è¿”å›å¯ç”¨\n                    return true;\n                }\n            }\n        }\n        return false;\n    }\n\n    /**\n     * å…³é—­æ‰€æœ‰çš„invokers\n     */\n    private void destroyAllInvokers() {\n        Map<String, Invoker<T>> localUrlInvokerMap = this.urlInvokerMap;\n        if (localUrlInvokerMap != null) {\n            for (Invoker<T> invoker : new ArrayList<Invoker<T>>(localUrlInvokerMap.values())) {\n                try {\n\t\t    //é”€æ¯invoker\n                    invoker.destroy();\n                } catch (Throwable t) {\n                    logger.warn(\"Failed to destroy service \" + serviceKey + \" to provider \" + invoker.getUrl(), t);\n                }\n            }\n            //æ¸…ç©ºç¼“å­˜\n            localUrlInvokerMap.clear();\n        }\n        methodInvokerMap = null;\n    }\n}\n\n````\n#### StaticDirectoryå®ç°ç±»\né™æ€ç›®å½•æœåŠ¡,å®ƒçš„æ‰€æœ‰Invokeré€šè¿‡æ„é€ å‡½æ•°ä¼ å…¥,åœ¨æœåŠ¡æ¶ˆè´¹æ–¹å¼•ç”¨æœåŠ¡çš„æ—¶å€™,æœåŠ¡å¯¹å¤šæ³¨å†Œä¸­å¿ƒè¿›è¡Œå¼•ç”¨æ—¶,å°†Invokersé›†åˆç›´æ¥ä¼ å…¥StaticDirectoryæ„é€ å™¨,å†ç”±Clusterä¼ªè£…æˆä¸€ä¸ªInvoker\n```java\npublic class ReferenceConfig<T> extends AbstractReferenceConfig {\n\n\tprivate T createProxy(Map<String, String> map) {\n\t\t// çœç•¥å…¶ä»–ä»£ç .....\n\t\tfor (URL url : urls) {\n\t\t    //è®°å½•\"è¿œç¨‹å¼•ç”¨\"\n\t\t    invokers.add(refprotocol.refer(interfaceClass, url));\n\t\t    if (Constants.REGISTRY_PROTOCOL.equals(url.getProtocol())) {\n\t\t\t// use last registry url\n\t\t\t//ä½¿ç”¨æœ€åæ³¨å†Œçš„url\n\t\t\tregistryURL = url;\n\t\t    }\n\t\t}\n\t\tif (registryURL != null) {\n\t\t    //æœ‰æ³¨å†Œä¸­å¿ƒåè®®çš„URL\n\t\t    //ä½¿ç”¨AvailableCluster\n\t\t    URL u = registryURL.addParameter(Constants.CLUSTER_KEY, AvailableCluster.NAME);\n\t\t    invoker = cluster.join(new StaticDirectory(u, invokers));\n\t\t} else { \n\t\t    //ä¸æ˜¯æ³¨å†Œä¸­å¿ƒçš„url\n\t\t    invoker = cluster.join(new StaticDirectory(invokers));\n\t\t}\n\t}\n}\n```\næ¥çœ‹çœ‹å®ç°\n```java\npublic class StaticDirectory<T> extends AbstractDirectory<T> {\n\n    private final List<Invoker<T>> invokers;\n\n    public StaticDirectory(URL url, List<Invoker<T>> invokers, List<Router> routers) {\n        \n\tsuper(url == null && invokers != null && !invokers.isEmpty() ? invokers.get(0).getUrl() : url, routers);\n        \n\tif (invokers == null || invokers.isEmpty()) {\n            throw new IllegalArgumentException(\"invokers == null\");\n        }\n        \n\tthis.invokers = invokers;\n    }\n\n    @Override\n    public Class<T> getInterface() {\n        return invokers.get(0).getInterface();\n    }\n\n    @Override\n    public boolean isAvailable() {\n        if (isDestroyed()) {\n            return false;\n        }\n        for (Invoker<T> invoker : invokers) {\n            //æ˜¯å¦å¯ç”¨\n            if (invoker.isAvailable()) {\n                return true;\n            }\n        }\n        return false;\n    }\n\n    @Override\n    public void destroy() {\n        if (isDestroyed()) {\n\t    //å·²ç»é”€æ¯ï¼Œç›´æ¥è¿”å›\n            return;\n        }\n        super.destroy();\n        for (Invoker<T> invoker : invokers) {\n            //é”€æ¯\n            invoker.destroy();\n        }\n        invokers.clear();\n    }\n\n    @Override\n    protected List<Invoker<T>> doList(Invocation invocation) throws RpcException {\n        //è¿”å›æ„é€ æ–¹æ³•ä¼ å…¥çš„invokersé›†åˆ\n        return invokers;\n    }\n\n}\n```\nè¿™ä¸€å°èŠ‚å°±å…ˆä»‹ç»åˆ°è¿™é‡Œï¼Œåé¢æˆ‘ä»¬è¯¦ç»†ä»‹ç»å„ä¸ªæ³¨å†Œä¸­å¿ƒå®ç°ã€‚\n\n","tags":["dubbo"]},{"title":"Dubboæºç é˜…è¯»ä¹‹æœåŠ¡æš´éœ²","url":"/blog/2018/08/16/Dubboæºç é˜…è¯»ä¹‹æœåŠ¡æš´éœ²/","content":">æœ¬å°èŠ‚è¯¦ç»†ä»‹ç»dubboæœåŠ¡çš„æš´éœ²ï¼Œå¯ä»¥å…ˆçœ‹ä¸‹ä¹‹å‰çš„æ–‡ç« ã€ŠDubboæºç é˜…è¯»ä¹‹é›†æˆSpring(0201)ã€‹\n\n### ServiceConfigç±»å˜é‡\nåœ¨ServiceConfigç±»ä¸­å®šä¹‰äº†å¦‚ä¸‹å˜é‡ï¼Œä¸‹æ–‡ä¸­ä¼šç”¨åˆ°ï¼Œæˆ‘ä»¬å…ˆç®€å•çœ‹ä¸‹ï¼š\n```java\n//ä»£ç†å·¥å‚\nprivate static final ProxyFactory proxyFactory = ExtensionLoader.getExtensionLoader(ProxyFactory.class).getAdaptiveExtension();\n\n//Protocolå®ä¾‹\nprivate static final Protocol protocol = ExtensionLoader.getExtensionLoader(Protocol.class).getAdaptiveExtension();\n\n/**\n * dubboåè®®æœåŠ¡URL\n * è®°å½•æš´éœ²çš„æœåŠ¡URL\n * dubbo://192.168.99.60:20880/com.alibaba.dubbo.demo.DemoService?anyhost=true&application=demo-provider&bind.ip=192.168.99.60&bind.port=20880&dubbo=2.0.0&generic=false&interface=com.alibaba.dubbo.demo.DemoService&methods=sayHello&pid=4328&qos.port=22222&side=provider&timestamp=1528278313225\n */\nprivate final List<URL> urls = new ArrayList<URL>();\n\n/**\n * è®°å½•æš´éœ²çš„æœåŠ¡ç«¯ç‚¹\n * subscribeUrl = provider://192.168.99.60:20880/com.alibaba.dubbo.demo.DemoService?anyhost=true&application=demo-provider&category=configurators&check=false&dubbo=2.0.0&generic=false&interface=com.alibaba.dubbo.demo.DemoService&methods=sayHello&pid=4328&side=provider&timestamp=1528278313225\n * registerUrl = dubbo://192.168.99.60:20880/com.alibaba.dubbo.demo.DemoService?anyhost=true&application=demo-provider&bind.ip=192.168.99.60&bind.port=20880&dubbo=2.0.0&generic=false&interface=com.alibaba.dubbo.demo.DemoService&methods=sayHello&pid=4328&qos.port=22222&side=provider&timestamp=1528278313225\n */\nprivate final List<Exporter<?>> exporters = new ArrayList<Exporter<?>>();\n```\n\n\né¦–å…ˆæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸‹ProxyFactoryæ¥å£\n\n### ProxyFactoryæ¥å£\n\n#### getInvokeræ–¹æ³•\n\ngetInvokeræ–¹æ³•æ˜¯åœ¨ProxyFactoryæ¥å£ä¸­å®šä¹‰çš„ã€‚ProxyFactoryæ¥å£ç›¸å…³ç±»å›¾å¦‚ä¸‹ï¼š\n![](img/ProxyFactory.png)\n\n```java\n/**\n * ä»£ç†å·¥å‚\n */\n@SPI(\"javassist\")\npublic interface ProxyFactory {\n    /**\n     * åˆ›å»ºä»£ç†\n     * @param invoker\n     * @return proxy\n     */\n    @Adaptive({Constants.PROXY_KEY})\n    <T> T getProxy(Invoker<T> invoker) throws RpcException;\n\n    /**\n     * åˆ›å»ºinvoker\n     * @param <T>\n     * @param proxy æ¥å£å®ç°ç±»æˆ–è€…ä»£ç†ç±»\n     * @param type æ¥å£ç±»å‹\n     * @param url æ³¨å†Œä¸­å¿ƒurlï¼Œæœ¬åœ°ä¸ºinjvm\n     * @return invoker\n     */\n    @Adaptive({Constants.PROXY_KEY})\n    <T> Invoker<T> getInvoker(T proxy, Class<T> type, URL url) throws RpcException;\n}\n\n/**\n * æŠ½è±¡ProxyFactory\n */\npublic abstract class AbstractProxyFactory implements ProxyFactory {\n    @Override\n    public <T> T getProxy(Invoker<T> invoker) throws RpcException {\n        //æ¥å£æ•°ç»„\n        Class<?>[] interfaces = null;\n        //è·å–urlçš„interfaceså‚æ•°çš„å€¼\n        String config = invoker.getUrl().getParameter(\"interfaces\");\n        if (config != null && config.length() > 0) {\n            //ä½¿ç”¨é€—å·\",\"åˆ†éš”interfaceså‚æ•°å€¼\n            String[] types = Constants.COMMA_SPLIT_PATTERN.split(config);\n            if (types != null && types.length > 0) {\n                //è¿™é‡Œä¼šå°†\"è¿œç¨‹æœåŠ¡æ¥å£ç±»ã€EchoServiceç±»\"æ”¾å…¥åˆ°æ¥å£æ•°ç»„ä¸­\n                interfaces = new Class<?>[types.length + 2];\n                interfaces[0] = invoker.getInterface();\n                interfaces[1] = EchoService.class;\n                //ç„¶åå°†\"interfaceså‚æ•°çš„å€¼\"æ”¾å…¥åˆ°æ¥å£æ•°ç»„\n                for (int i = 0; i < types.length; i++) {\n                    interfaces[i + 1] = ReflectUtils.forName(types[i]);\n                }\n            }\n        }\n        if (interfaces == null) {\n            //interfacesæ•°ç»„ä¸ºç©ºçš„è¯ï¼Œåˆ™å°†è¿œç¨‹æœåŠ¡æ¥å£ç±»ã€EchoServiceç±»æ”¾å…¥åˆ°æ¥å£æ•°ç»„ä¸­\n            interfaces = new Class<?>[]{invoker.getInterface(), EchoService.class};\n        }\n        //ç„¶åè°ƒç”¨å­ç±»ä½“å®ç°æ¥è·å–ä»£ç†ç±»\n        return getProxy(invoker, interfaces);\n    }\n\n    /**\n     * è·å–ä»£ç†ç±»\n     * @param invoker\n     * @param types  è¿œç¨‹æœåŠ¡æ¥å£ç±»æ•°ç»„ï¼š\n     *               invoker.getInterface()ã€\n     *               EchoService.classã€\n     *               invoker.getUrl().getParameter(\"interfaces\")\n     * @param <T>\n     * @return\n     */\n    public abstract <T> T getProxy(Invoker<T> invoker, Class<?>[] types);\n}\n\n/**\n * jdkåŠ¨æ€ä»£ç†\n */\npublic class JdkProxyFactory extends AbstractProxyFactory {\n\n    @Override\n    public <T> T getProxy(Invoker<T> invoker, Class<?>[] interfaces) {\n        //ä¸ºinterfacesè¿™äº›æ¥å£ç”Ÿæˆä»£ç†ç±»\n        return (T) Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(),\n                interfaces, new InvokerInvocationHandler(invoker));\n    }\n\n    @Override\n    public <T> Invoker<T> getInvoker(T proxy, Class<T> type, URL url) {\n\t//è¿”å›AbstractProxyInvokeræŠ½è±¡ç±»ï¼ˆè¯¥ç±»åé¢çš„å°èŠ‚ä¼šè¯¦ç»†ä»‹ç»ï¼‰\n        return new AbstractProxyInvoker<T>(proxy, type, url) {\n\n            @Override\n            protected Object doInvoke(T proxy, String methodName,\n                                      Class<?>[] parameterTypes,\n                                      Object[] arguments) throws Throwable {\n\n                //æ ¹æ®æ–¹æ³•åç§°methodNameå’Œå‚æ•°ç±»å‹parameterTypesè·å–åˆ°æŒ‡å®šæ–¹æ³•\n                Method method = proxy.getClass().getMethod(methodName, parameterTypes);\n\n                //ä½¿ç”¨å‚æ•°argumentsè°ƒç”¨è¯¥ä»£ç†ç±»çš„methodæ–¹æ³•\n                return method.invoke(proxy, arguments);\n            }\n        };\n    }\n}\n\n/**\n * ä½¿ç”¨Javassist\n */\npublic class JavassistProxyFactory extends AbstractProxyFactory {\n\n    @Override\n    public <T> T getProxy(Invoker<T> invoker, Class<?>[] interfaces) {\n        //ä¸ºinterfacesè¿™äº›æ¥å£ç”Ÿæˆä»£ç†ç±»(åé¢ä¼šåˆ†æProxyç±»ï¼Œè¿™æ˜¯dubboè‡ªå·±å®šä¹‰çš„ç±»)\n        return (T) Proxy.getProxy(interfaces).newInstance(new InvokerInvocationHandler(invoker));\n    }\n\n    @Override\n    public <T> Invoker<T> getInvoker(T proxy, Class<T> type, URL url) {\n        \n\t// TODO Wrapperç±»ä¸èƒ½æ­£ç¡®å¤„ç†å¸¦$çš„ç±»å\n        final Wrapper wrapper = Wrapper.getWrapper(proxy.getClass().getName().indexOf('$') < 0 ? proxy.getClass() : type);\n        \n\t//è¿”å›AbstractProxyInvokeræŠ½è±¡ç±»ï¼ˆè¯¥ç±»åé¢çš„å°èŠ‚ä¼šè¯¦ç»†ä»‹ç»ï¼‰\n        return new AbstractProxyInvoker<T>(proxy, type, url) {\n            @Override\n            protected Object doInvoke(T proxy, String methodName,\n                                      Class<?>[] parameterTypes,\n                                      Object[] arguments) throws Throwable {\n\n                //ä½¿ç”¨WrapperåŒ…è£…ç±»ç±»è°ƒç”¨è¿œç¨‹æœåŠ¡æ–¹æ³•\n                return wrapper.invokeMethod(proxy, methodName, parameterTypes, arguments);\n            }\n        };\n    }\n}\n```\nåœ¨JavassistProxyFactoryç±»çš„getInvokeræ–¹æ³•å®ç°ä¸­ï¼Œä¼šä¸ºç›¸åº”çš„æ¥å£ç±»(ä¾‹å¦‚ï¼šcom.alibaba.dubbo.demo.DemoService)ç”ŸæˆåŒ…è£…ç±»ï¼Œç”Ÿæˆçš„é€»è¾‘ä¼šåœ¨å•ç‹¬çš„å°èŠ‚ä»‹ç»ï¼Œè¿™é‡Œåªç®€å•çœ‹ä¸‹å¤§æ¦‚ç”Ÿæˆçš„ç±»ã€‚\n#### WrapperåŒ…è£…ç±»\n```java\npublic class com.alibaba.dubbo.common.bytecode.Wrapper0 extends Wrapper{\n\tpublic Wrapper0(){}\n\t//å±æ€§åç§°æ•°ç»„\n\tpublic static String[] pns;\n\n\t//<å±æ€§åç§°ï¼Œå±æ€§ç±»å‹>\n\tpublic static java.util.Map pts;\n\t\n\t//æ‰€æœ‰æ–¹æ³•åç§°æ•°ç»„\n\tpublic static String[] mns;\n\t\n\t//å·²å£°æ˜çš„æ–¹æ³•åç§°æ•°ç»„\n\tpublic static String[] dmns;\n\t\n\t//é’ˆå¯¹æ¯ä¸ªæ–¹æ³•éƒ½ä¼šå®šä¹‰ä¸€ä¸ªmtsæ•°ç»„å˜é‡\n\tpublic static Class[] mts0;\n\n\tpublic String[] getPropertyNames(){ \n\t\treturn pns; \n\t}\n\tpublic boolean hasProperty(String n){\n\t\treturn pts.containsKey($1); \n\t}\n\tpublic Class getPropertyType(String n){ \n\t\treturn (Class)pts.get($1); \n\t}\n\tpublic String[] getMethodNames(){ \n\t\treturn mns; \n\t}\n\tpublic String[] getDeclaredMethodNames(){ \n\t\treturn dmns; \n\t}\n\tpublic void setPropertyValue(Object o, String n, Object v){ \n\t\tcom.alibaba.dubbo.demo.DemoService w; \n\t\ttry{ \n\t\t\tw = ((com.alibaba.dubbo.demo.DemoService)$1); \n\t\t}catch(Throwable e){ \n\t\t\tthrow new IllegalArgumentException(e); \n\t\t} \n\t\tthrow new com.alibaba.dubbo.common.bytecode.NoSuchPropertyException(\"Not found property \\\"\"+$2+\"\\\" filed or setter method in class com.alibaba.dubbo.demo.DemoService.\"); \n\t}\n\tpublic Object getPropertyValue(Object o, String n){ \n\t\tcom.alibaba.dubbo.demo.DemoService w; \n\t\ttry{ \n\t\t\tw = ((com.alibaba.dubbo.demo.DemoService)$1); \n\t\t}catch(Throwable e){ \n\t\t\tthrow new IllegalArgumentException(e); \n\t\t} \n\t\tthrow new com.alibaba.dubbo.common.bytecode.NoSuchPropertyException(\"Not found property \\\"\"+$2+\"\\\" filed or setter method in class com.alibaba.dubbo.demo.DemoService.\"); \n\t}\n\t/**\n\t * æ‰§è¡ŒæœåŠ¡æ¥å£çš„æ–¹æ³•\n\t * $1/$2/$3/$4åˆ†åˆ«å¯¹åº”ç›¸åº”ä¸‹æ ‡çš„å‚æ•°\n\t * @param o æœåŠ¡æ¥å£å®ä¾‹\n\t * @param n æœåŠ¡æ¥å£æ–¹æ³•å\n\t * @param p æœåŠ¡æ¥å£æ–¹æ³•å‚æ•°\n\t * @param v æœåŠ¡æ¥å£æ–¹æ³•å‚æ•°å€¼\n\t * @return æœåŠ¡æ¥å£è°ƒç”¨è¿”å›å€¼\n\t */\n\tpublic Object invokeMethod(Object o, String n, Class[] p, Object[] v) throws java.lang.reflect.InvocationTargetException{\n\t\tcom.alibaba.dubbo.demo.DemoService w; \n\t\ttry{ \n\t\t\tw = ((com.alibaba.dubbo.demo.DemoService)$1); \n\t\t}catch(Throwable e){ \n\t\t\tthrow new IllegalArgumentException(e); \n\t\t} \n\t\ttry{ \n\t\t\t//æ–¹æ³•åç§°ä¸ºsayHello å¹¶ä¸” åªæœ‰ä¸€ä¸ªå‚æ•°\n\t\t\tif(\"sayHello\".equals($2) && $3.length == 1){  \n\t\t\t\t//è°ƒç”¨æ¥å£æ–¹æ³•sayHello\n\t\t\t\treturn ($w)w.sayHello((java.lang.String)$4[0]);\n\t\t\t} \n\t\t} catch(Throwable e) {      \n\t\t\tthrow new java.lang.reflect.InvocationTargetException(e);  \n\t\t} \n\t\tthrow new com.alibaba.dubbo.common.bytecode.NoSuchMethodException(\"Not found method \\\"\"+$2+\"\\\" in class com.alibaba.dubbo.demo.DemoService.\"); \n\t}\n}\n```\n\n### æš´éœ²åˆ°æ³¨å†Œä¸­å¿ƒ\n\næˆ‘ä»¬å…ˆçœ‹ä¸‹DelegateProviderMetaDataInvokerç±»ã€‚\n```java\n/**\n * DelegateProviderMetaDataInvokerç±»å®ç°äº†invokeræ¥å£\n * å¹¶ä¸”æŒæœ‰ä¸€ä¸ªInvokerå˜é‡ï¼Œæ“ä½œéƒ½ä¼šå§”æ‰˜ç»™è¯¥å˜é‡\n */\npublic class DelegateProviderMetaDataInvoker<T> implements Invoker {\n    protected final Invoker<T> invoker;\n    private ServiceConfig metadata;\n\n    public DelegateProviderMetaDataInvoker(Invoker<T> invoker,ServiceConfig metadata) {\n        this.invoker = invoker;\n        this.metadata = metadata;\n    }\n\n    @Override\n    public Class<T> getInterface() {\n        return invoker.getInterface();\n    }\n\n    @Override\n    public URL getUrl() {\n        return invoker.getUrl();\n    }\n\n    @Override\n    public boolean isAvailable() {\n        return invoker.isAvailable();\n    }\n\n    @Override\n    public Result invoke(Invocation invocation) throws RpcException {\n        return invoker.invoke(invocation);\n    }\n\n    @Override\n    public void destroy() {\n        invoker.destroy();\n    }\n\n    public ServiceConfig getMetadata() {\n        return metadata;\n    }\n}\n```\n#### Protocolæ¥å£çš„exportæ–¹æ³•\n\nå…ˆæ¥çœ‹ä¸‹Protocolæ¥å£çš„å®šä¹‰ï¼Œå…¶exportæ–¹æ³•å’Œreferæ–¹æ³•å­˜åœ¨@Adaptiveæ³¨è§£ã€‚\n```java\n/**\n * åè®®\n * Protocol. (API/SPI, Singleton, ThreadSafe)\n */\n@SPI(\"dubbo\")\npublic interface Protocol {\n\n    /**\n     * å½“ç”¨æˆ·æ²¡æœ‰é…ç½®ç«¯å£æ—¶ï¼Œè·å–é»˜è®¤ç«¯å£\n     * @return default port\n     */\n    int getDefaultPort();\n\n    /**\n     * ä¸ºè¿œç¨‹è°ƒç”¨æš´éœ²æœåŠ¡\n     * 1ã€æ¥æ”¶åˆ°è¯·æ±‚ååè®®åº”è¯¥è®°å½•è¯·æ±‚æºåœ°å€ï¼Œé€šè¿‡: RpcContext.getContext().setRemoteAddress()\n     * 2ã€export()æ–¹æ³•å¿…é¡»æ˜¯å¹‚ç­‰çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæš´éœ²åŒä¸€ä¸ªURLçš„invokerä¸¤æ¬¡æ—¶ï¼Œè°ƒç”¨1æ¬¡å’Œ2æ¬¡æ²¡æœ‰ä»€ä¹ˆä¸åŒ\n     * 3ã€ä¼ å…¥çš„Invokerå®ä¾‹ç”±æ¡†æ¶å®ç°å¹¶ä¼ å…¥ï¼Œåè®®ä¸éœ€è¦å…³å¿ƒ\n     *\n     * @param <T>     æœåŠ¡ç±»å‹\n     * @param invoker æœåŠ¡invoker\n     * @return æš´éœ²æœåŠ¡çš„exporterå¼•ç”¨ï¼Œç”¨æ¥ä»¥åå–æ¶ˆæš´éœ²æœåŠ¡\n     * @throws RpcException å½“æš´éœ²æœåŠ¡å‡ºé”™æ—¶æŠ›å‡ºï¼Œæ¯”å¦‚ç«¯å£å·²å ç”¨\n     */\n    @Adaptive\n    <T> Exporter<T> export(Invoker<T> invoker) throws RpcException;\n\n    /**\n     * å¼•ç”¨ä¸€ä¸ªè¿œç¨‹æœåŠ¡\n     * 1ã€å½“ç”¨æˆ·è°ƒç”¨ refer()æ‰€è¿”å›çš„ Invokerå¯¹è±¡çš„invoke()æ—¶ï¼Œåè®®éœ€ç›¸åº”æ‰§è¡ŒåŒURLè¿œç«¯export()ä¼ å…¥çš„Invokerå¯¹è±¡çš„invoke()æ–¹æ³•.\n     * 2ã€refer()è¿”å›çš„Invokerç”±åè®®å®ç°ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œåè®®éœ€è¦åœ¨æ­¤Invokerä¸­å‘é€è¿œç¨‹è¯·æ±‚ã€‚\n     * 3ã€å½“URLä¸­è®¾ç½®äº†check=falseæ—¶ï¼Œè¿™ä¸ªå®ç°ä¸å¯ä»¥æŠ›å‡ºå¼‚å¸¸ï¼Œè€Œæ˜¯å°è¯•ç€ä»è¿æ¥å¤±è´¥ä¸­æ¢å¤\n     * @param T è¿œç¨‹æœåŠ¡ç±»å‹\n     * @param type è¿œç¨‹æœåŠ¡æ¥å£ç±»å‹\n     * @param url è¿œç¨‹æœåŠ¡çš„URLåœ°å€\n     * @return æ‰§è¡ŒæœåŠ¡çš„æœ¬åœ°ä»£ç†\n     * @throws RpcException when there's any error while connecting to the service provider\n     */\n    @Adaptive\n    <T> Invoker<T> refer(Class<T> type, URL url) throws RpcException;\n\n    /**\n     * é”€æ¯åè®®\n     * 1ã€å–æ¶ˆè¯¥åè®®æ‰€æœ‰å·²ç»æš´éœ²å’Œå¼•ç”¨çš„æœåŠ¡\n     * 2ã€é‡Šæ”¾åè®®æ‰€æœ‰å ç”¨çš„èµ„æºï¼Œå¦‚ï¼šé“¾æ¥ã€ç«¯å£ç­‰\n     * 3ã€åè®®åœ¨é‡Šæ”¾åï¼Œä¾ç„¶èƒ½æš´éœ²å’Œå¼•ç”¨æ–°çš„æœåŠ¡\n     */\n    void destroy();\n}\n\nå¯ä»¥çœ‹åˆ°exportæ–¹æ³•æ˜¯å®šä¹‰åœ¨Protocolæ¥å£ä¸­çš„ï¼Œæˆ‘ä»¬æ˜¯é€šè¿‡ExtensionLoaderç±»è·å–åˆ°Protocolçš„è‡ªé€‚åº”æ‰©å±•å®ä¾‹çš„ï¼Œå› æ­¤æˆ‘ä»¬åœ¨è°ƒç”¨exportæ–¹æ³•è¿›è¡ŒæœåŠ¡æš´éœ²æ—¶ï¼Œå®é™…ä¸Šè°ƒç”¨çš„æ˜¯è‡ªé€‚åº”æ‰©å±•å®ä¾‹çš„exportæ–¹æ³•ï¼š\n```java\n//è‡ªé€‚åº”æ‰©å±•å®ç°ç±»\nProtocol protocol = ExtensionLoader.getExtensionLoader(Protocol.class).getAdaptiveExtension();\n\n//è·å–invokerå¯¹è±¡\nInvoker<?> invoker = proxyFactory.getInvoker(ref, (Class) interfaceClass, registryURL.addParameterAndEncoded(Constants.EXPORT_KEY, url.toFullString()));\n//å°†invokerå’Œå½“å‰å¯¹è±¡(ServiceBean)åŒ…è£…æˆDelegateProviderMetaDataInvokerå¯¹è±¡\nDelegateProviderMetaDataInvoker wrapperInvoker = new DelegateProviderMetaDataInvoker(invoker, this);\n\n//è°ƒç”¨è‡ªé€‚åº”æ‰©å±•å®ç°ç±»çš„exportæ–¹æ³•\nExporter<?> exporter = protocol.export(wrapperInvoker);\n```\né‚£ä¹ˆï¼Œåœ¨è·å–è‡ªé€‚åº”æ‰©å±•å®ä¾‹æ—¶éƒ½è¿›è¡Œäº†å“ªäº›æ“ä½œå‘¢ï¼Ÿæˆ‘ä»¬åœ¨ã€ŠDubboæºç é˜…è¯»ä¹‹SPIæ‰©å±•æœºåˆ¶ã€‹æ–‡ç« ä¸­ä»‹ç»è¿‡Dubboçš„SPIæœºåˆ¶ï¼Œè¿™é‡Œå°±ä¸å†è¯¦ç»†ä»‹ç»äº†ï¼Œåªç®€å•è¯´æ˜ä¸‹æ˜¯å¦‚ä½•è·å–åˆ°Protocolå®ä¾‹çš„ã€‚\né¦–å…ˆæˆ‘ä»¬æˆ‘ä»¬é€šè¿‡ExtensionLoader.getExtensionLoader(Protocol.class)è°ƒç”¨ï¼Œè·å–åˆ°äº†Protocolçš„æ‰©å±•åŠ è½½å™¨ï¼Œç„¶åè°ƒç”¨å®ƒçš„getAdaptiveExtension()æ–¹æ³•æ‹¿åˆ°è‡ªé€‚åº”æ‰©å±•å®ä¾‹(Dubboä¸ºå®ƒè‡ªåŠ¨ç”Ÿæˆçš„ä¸€ä¸ªç±»ï¼Œåé¢ä»‹ç»)ï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­ï¼Œä¼šå…ˆå»æ‰«æ3ä¸ªç›¸å…³è·¯å¾„æ‰¾åˆ°æ‰€æœ‰çš„Protocolæ‰©å±•å®ç°ç±»å®šä¹‰ï¼Œ\næœ€ç»ˆä¼šæ‰¾åˆ°å¦‚ä¸‹å®šä¹‰ï¼š\n```java\n#æ‰©å±•åç§°=æ‰©å±•å®ç°ç±»\nregistry=com.alibaba.dubbo.registry.integration.RegistryProtocol\nmock=com.alibaba.dubbo.rpc.support.MockProtocol\ninjvm=com.alibaba.dubbo.rpc.protocol.injvm.InjvmProtocol\ndubbo=com.alibaba.dubbo.rpc.protocol.dubbo.DubboProtocol\n#ProtocolåŒ…è£…ç±»\nfilter=com.alibaba.dubbo.rpc.protocol.ProtocolFilterWrapper\nlistener=com.alibaba.dubbo.rpc.protocol.ProtocolListenerWrapper\n```\n\nç„¶åæ£€æŸ¥æ¯ä¸ªæ‰©å±•å®ç°ç±»ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°å­˜åœ¨@Adaptiveæ³¨è§£çš„æ‰©å±•ç±»ï¼Œåˆ™Dubboä¼šä¸ºå…¶ç”Ÿæˆä¸€ä¸ªè‡ªé€‚åº”æ‰©å±•ç±»ï¼Œç”Ÿæˆçš„å®ç°ç±»å¦‚ä¸‹ï¼š\n```java\n/**\n * ç”Ÿæˆçš„å®ç°ç±»åä¸ºï¼šProtocol$Adaptiveï¼Œå®ç°äº†Protocolæ¥å£\n * åªæœ‰æ¥å£æ–¹æ³•ä¸Šæ ‡æœ‰@Adaptiveæ³¨è§£ï¼Œæ‰ä¼šä¸ºå…¶ç”Ÿæˆå®ç°ï¼Œ\n * ä¾‹å¦‚ï¼ŒProtocolæ¥å£çš„destroy()æ–¹æ³•æ²¡æœ‰@Adaptiveæ³¨è§£ï¼Œå› æ­¤ä¸‹é¢çš„æ–¹æ³•å®ç°ä¸­ç›´æ¥æŠ›äº†å¼‚å¸¸\n */\npublic class Protocol$Adaptive implements com.alibaba.dubbo.rpc.Protocol {\n\t\n\tpublic void destroy() {\n\t\t//æç¤º Protocolæ¥å£çš„destroy()æ–¹æ³•æ²¡æœ‰@Adaptiveæ³¨è§£ï¼Œå› æ­¤ä¸æ”¯æŒ\n\t\tthrow new UnsupportedOperationException(\"method public abstract void com.alibaba.dubbo.rpc.Protocol.destroy() of interface com.alibaba.dubbo.rpc.Protocol is not adaptive method!\");\n\t}\n\t\n\tpublic int getDefaultPort() {\n\t\t//æç¤º Protocolæ¥å£çš„getDefaultPort()æ–¹æ³•æ²¡æœ‰@Adaptiveæ³¨è§£ï¼Œå› æ­¤ä¸æ”¯æŒ\n\t\tthrow new UnsupportedOperationException(\"method public abstract int com.alibaba.dubbo.rpc.Protocol.getDefaultPort() of interface com.alibaba.dubbo.rpc.Protocol is not adaptive method!\");\n\t}\n\t\n\t/**\n\t * @param arg0 æœåŠ¡æ¥å£ç±»\n\t * @param arg1 æ³¨å†Œä¸­å¿ƒurl\n\t */\n\tpublic com.alibaba.dubbo.rpc.Invoker refer(java.lang.Class arg0, com.alibaba.dubbo.common.URL arg1) throws com.alibaba.dubbo.rpc.RpcException {\n\t\tif (arg1 == null){\n\t\t\t//urlå‚æ•°ä¸å¯ä»¥ä¸ºç©º\n\t\t\tthrow new IllegalArgumentException(\"url == null\");\n\t\t}\n\t\t\n\t\tcom.alibaba.dubbo.common.URL url = arg1;\n\t\t\n\t\t//ä½¿ç”¨urlçš„protocolå±æ€§å€¼(è¿™é‡Œä¸ºregistry)ï¼Œä½œä¸ºæ‰©å±•åç§°ï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™é»˜è®¤ä½¿ç”¨\"dubbo\"\n\t\tString extName = url.getProtocol() == null ? \"dubbo\" : url.getProtocol();\n\t\t\n\t\tif(extName == null) {\n\t\t\tthrow new IllegalStateException(\"Fail to get extension(com.alibaba.dubbo.rpc.Protocol) name from url(\" + url.toString() + \") use keys([protocol])\");\n\t\t}\n\t\t\n\t\t//è·å–æ‰©å±•åç§°ä¸ºextNameçš„Protocolæ‰©å±•å®ä¾‹\n\t\tcom.alibaba.dubbo.rpc.Protocol extension = (com.alibaba.dubbo.rpc.Protocol)ExtensionLoader.getExtensionLoader(com.alibaba.dubbo.rpc.Protocol.class).getExtension(extName);\n\t\t\n\t\t//è°ƒç”¨è¯¥extensionå®ä¾‹çš„referæ–¹æ³•\n\t\treturn extension.refer(arg0, arg1);\n\t}\n\t\t\n\tpublic com.alibaba.dubbo.rpc.Exporter export(com.alibaba.dubbo.rpc.Invoker arg0) throws com.alibaba.dubbo.rpc.RpcException {\n\t\tif (arg0 == null){\n\t\t    throw new IllegalArgumentException(\"com.alibaba.dubbo.rpc.Invoker argument == null\");\n\t\t} \n\t\t\n\t\tif (arg0.getUrl() == null) {\n\t\t    throw new IllegalArgumentException(\"com.alibaba.dubbo.rpc.Invoker argument getUrl() == null\");\n\t\t}\n\t\t\n\t\tcom.alibaba.dubbo.common.URL url = arg0.getUrl();\n\t\t\n\t\t//ä½¿ç”¨urlçš„protocolå±æ€§å€¼(è¿™é‡Œä¸ºregistry)ï¼Œä½œä¸ºæ‰©å±•åç§°ï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™é»˜è®¤ä½¿ç”¨\"dubbo\"\n\t\tString extName = ( url.getProtocol() == null ? \"dubbo\" : url.getProtocol() );\n\t\t\n\t\tif(extName == null) {\n\t\t\tthrow new IllegalStateException(\"Fail to get extension(com.alibaba.dubbo.rpc.Protocol) name from url(\" + url.toString() + \") use keys([protocol])\");\n\t\t}\n\t\t\n\t\t//è·å–æ‰©å±•åç§°ä¸ºextNameçš„Protocolæ‰©å±•å®ä¾‹ï¼ˆæ­¤æ‰©å±•å®ä¾‹å·²ç»è¢«åŒ…è£…ç±»åŒ…è£…è¿‡ï¼‰\n\t\tcom.alibaba.dubbo.rpc.Protocol extension = (com.alibaba.dubbo.rpc.Protocol)ExtensionLoader.getExtensionLoader(com.alibaba.dubbo.rpc.Protocol.class).getExtension(extName);\n\t\t\n\t\t//è°ƒç”¨è¯¥extensionå®ä¾‹çš„exportæ–¹æ³•(åŒ…è£…ç±»çš„exportæ–¹æ³•)\n\t\treturn extension.export(arg0);\n\t}\n}\n```\nåœ¨ä¸Šé¢æˆ‘ä»¬è¯´åˆ°ï¼Œè°ƒç”¨exportæ–¹æ³•å®é™…ä¸Šæ˜¯è°ƒç”¨è‡ªé€‚åº”æ‰©å±•å®ç°ç±»çš„exportæ–¹æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹å…¶å®ç°ã€‚\né¦–å…ˆæ ¡éªŒinvokerå‚æ•°ä¸å¯ä»¥ä¸ºç©ºï¼Œç„¶åæ ¡éªŒinvokerå¯¹è±¡çš„getUrl()æ–¹æ³•è¿”å›çš„URLå¯¹è±¡ä¸å¯ä»¥ä¸ºç©ºï¼Œç„¶åæˆ‘ä»¬ä½¿ç”¨URLå¯¹è±¡çš„protocolå±æ€§ä½œä¸ºæ‰©å±•åç§°extName(æç¤ºï¼šåœ¨ä¸Šä¸€èŠ‚çš„loadRegistries(boolean provider)åŠ è½½æ³¨å†Œä¸­å¿ƒurlåˆ—è¡¨æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬è®¾ç½®äº†æ³¨å†Œä¸­å¿ƒurlçš„protocolå±æ€§å€¼ä¸º\"registry\")ï¼Œç„¶åæ ¹æ®æ‰©å±•åç§°extNameè·å–åˆ°çœŸæ­£çš„Protocolæ‰©å±•å®ä¾‹(RegistryProtocol,ç„¶åRegistryProtocolä¼šè¢«åŒ…è£…)ï¼Œæœ€åè°ƒç”¨è¯¥Protocolæ‰©å±•å®ä¾‹çš„exportæ–¹æ³•ã€‚\né€šè¿‡ç”Ÿæˆçš„è‡ªé€‚åº”æ‰©å±•å®ç°ç±»ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®ä¸åŒçš„æ‰©å±•åç§°è°ƒç”¨ä¸åŒçš„æ‰©å±•å®ä¾‹ã€‚\nåœ¨getExtension(extName)æ–¹æ³•ä¸­ï¼Œè·å–åˆ°ç›¸åº”çš„æ‰©å±•å®ä¾‹å(RegistryProtocol)ï¼ŒDubboä¼šå†å»æŸ¥çœ‹ä¸‹è¯¥æ‰©å±•æ˜¯å¦å­˜åœ¨ç›¸åº”çš„åŒ…è£…ç±»ï¼Œåœ¨ä¸Šé¢æˆ‘ä»¬æ‰«æå‡ºæ¥Protocolæ¥å£å­˜åœ¨2ä¸ªåŒ…è£…ç±»ï¼ŒProtocolFilterWrapperå’ŒProtocolListenerWrapperï¼Œæ¥ç€Dubboä¼šåˆ›å»ºåŒ…è£…ç±»çš„å®ä¾‹ï¼Œå¹¶å°†åˆšæ‰ç”ŸæˆRegistryProtocolæ‰©å±•å®ä¾‹é€šè¿‡æ„é€ å‡½æ•°å‚æ•°ä¼ é€’åˆ°åŒ…è£…ç±»ä¸­ï¼Œé€šè¿‡åŒ…è£…ç±»ï¼ŒDubboå°±å®ç°äº†åŠŸèƒ½å¢å¼ºã€‚\nå› æ­¤ï¼Œç°åœ¨æˆ‘ä»¬å†å›è¿‡å¤´æ¥çœ‹ä¸‹exportæ–¹æ³•çš„è°ƒç”¨ï¼šé¦–å…ˆæ˜¯è°ƒç”¨è‡ªé€‚åº”æ‰©å±•å®ç°ç±»çš„exportæ–¹æ³•ï¼Œåœ¨exportæ–¹æ³•å†…éƒ¨ï¼Œæ ¹æ®æ‰©å±•åç§°è·å–åˆ°çœŸå®çš„æ‰©å±•å®ä¾‹RegistryProtocolï¼Œç„¶ååˆé€šè¿‡ä¸¤ä¸ªåŒ…è£…ç±»å°†çœŸå®çš„æ‰©å±•å®ä¾‹è¿›è¡Œäº†åŒ…è£…ï¼Œæœ€åè°ƒç”¨çš„æ˜¯åŒ…è£…ç±»çš„exportæ–¹æ³•ã€‚\nå…·ä½“çš„è°ƒç”¨é“¾æˆ‘ä»¬å·²ç»åˆ†æå®Œäº†ï¼Œç°åœ¨æˆ‘ä»¬æ¥çœ‹ä¸‹å¯¹åº”çš„ä»£ç ã€‚\n```java\n/**\n * æ ¹æ®æ‰©å±•åç§°åˆ›å»ºæ‰©å±•å®ä¾‹åï¼Œä¼šè·å–åŒ…è£…ç±»ï¼Œå°†æ‰©å±•å®ä¾‹è¿›è¡ŒåŒ…è£…\n */\nprivate T createExtension(String name) {\n\t//æ ¹æ®æ‰©å±•åç§°nameè·å–æ‰©å±•å®ç°ç±»clazz\n\tClass<?> clazz = getExtensionClasses().get(name);\n\tif (clazz == null) {\n\t    //æ‰©å±•å®ç°ç±»ä¸ºç©ºï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸\n\t    throw findException(name);\n\t}\n\ttry {\n\t    //å…ˆä»ç¼“å­˜ä¸­è·å–æ‰©å±•å®ç°ç±»çš„å®ä¾‹ï¼Œå¦‚æœæ²¡æœ‰è·å–åˆ°ï¼Œåˆ™æ–°å»ºä¸€ä¸ªå¹¶æ”¾å…¥ç¼“å­˜ã€‚\n\t    T instance = (T) EXTENSION_INSTANCES.get(clazz);\n\t    if (instance == null) {\n\t\tEXTENSION_INSTANCES.putIfAbsent(clazz, clazz.newInstance());\n\t\tinstance = (T) EXTENSION_INSTANCES.get(clazz);\n\t    }\n\t    //å¤„ç†æ‰©å±•å®ç°ç±»å®ä¾‹çš„ä¾èµ–æ³¨å…¥\n\t    injectExtension(instance);\n\n\t    //è·å–åˆ°typeæ¥å£çš„æ‰€æœ‰åŒ…è£…ç±»\n\t    Set<Class<?>> wrapperClasses = cachedWrapperClasses;\n\t    if (wrapperClasses != null && !wrapperClasses.isEmpty()) {\n\t\t//éå†åŒ…è£…ç±»\n\t\tfor (Class<?> wrapperClass : wrapperClasses) {\n\t\t    //åŒ…è£…ç±»é€šè¿‡æ„é€ æ–¹æ³•åˆ›å»ºå®ä¾‹ï¼Œç„¶åè¿›è¡Œä¾èµ–æ³¨å…¥\n\t\t    instance = injectExtension((T) wrapperClass.getConstructor(type).newInstance(instance));\n\t\t}\n\t    }\n\t    return instance;\n\t} catch (Throwable t) {\n\t    throw new IllegalStateException(\"Extension instance(name: \" + name + \", class: \" +\n\t\t    type + \")  could not be instantiated: \" + t.getMessage(), t);\n\t}\n}\n\npublic class ProtocolFilterWrapper implements Protocol {\n\t\n    //æ ¹æ®ä¸Šé¢çš„åˆ†æï¼Œè¿™é‡Œçš„protocolæ˜¯ProtocolListenerWrapper\n    private final Protocol protocol;\n\n    public ProtocolFilterWrapper(Protocol protocol) {\n        if (protocol == null) {\n            throw new IllegalArgumentException(\"protocol == null\");\n        }\n        this.protocol = protocol;\n    }\n    \n    @Override\n    public <T> Exporter<T> export(Invoker<T> invoker) throws RpcException {\n        \n        if (Constants.REGISTRY_PROTOCOL.equals(invoker.getUrl().getProtocol())) {\n\t    //å¦‚æœurlçš„protocolå±æ€§ä¸ºregistryï¼Œåˆ™è°ƒç”¨protocolçš„exportæ–¹æ³•\n            return protocol.export(invoker);\n        }\n        return protocol.export(buildInvokerChain(invoker, Constants.SERVICE_FILTER_KEY, Constants.PROVIDER));\n    }\n    //.....çœç•¥å…¶ä»–æ–¹æ³•....\n}\n\n\npublic class ProtocolListenerWrapper implements Protocol{\n\t\n    //æ ¹æ®ä¸Šé¢çš„åˆ†æï¼Œè¿™é‡Œçš„protocolæ˜¯RegistryProtocol\n    private final Protocol protocol;\n\n    public ProtocolListenerWrapper(Protocol protocol) {\n        if (protocol == null) {\n            throw new IllegalArgumentException(\"protocol == null\");\n        }\n        this.protocol = protocol;\n    }\n    \n     @Override\n    public <T> Exporter<T> export(Invoker<T> invoker) throws RpcException {\n        if (Constants.REGISTRY_PROTOCOL.equals(invoker.getUrl().getProtocol())) {\n\t    //å¦‚æœurlçš„protocolå±æ€§ä¸ºregistryï¼Œåˆ™è°ƒç”¨protocolçš„exportæ–¹æ³•\n            return protocol.export(invoker);\n        }\n        return new ListenerExporterWrapper<T>(protocol.export(invoker),\n                Collections.unmodifiableList(ExtensionLoader.getExtensionLoader(ExporterListener.class)\n                        .getActivateExtension(invoker.getUrl(), Constants.EXPORTER_LISTENER_KEY)));\n    }\n}\n```\nç»è¿‡æˆ‘ä»¬çš„åˆ†æï¼Œæœ€ç»ˆä¼šè°ƒç”¨RegistryProtocolçš„exportæ–¹æ³•è¿›è¡ŒæœåŠ¡æš´éœ²ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥åˆ†æä¸‹è¯¥æ–¹æ³•ã€‚\n```java\n\n//è·å–invokerå¯¹è±¡\nInvoker<?> invoker = proxyFactory.getInvoker(ref, (Class) interfaceClass, registryURL.addParameterAndEncoded(Constants.EXPORT_KEY, url.toFullString()));\n\n//å°†invokerå’Œå½“å‰å¯¹è±¡(ServiceBean)åŒ…è£…æˆDelegateProviderMetaDataInvokerå¯¹è±¡\nDelegateProviderMetaDataInvoker wrapperInvoker = new DelegateProviderMetaDataInvoker(invoker, this);\n\n\n\n/**\n * é€šè¿‡invokerçš„url(å³æ³¨å†Œä¸­å¿ƒurl)è·å–providerUrlçš„åœ°å€ï¼ˆå³æœåŠ¡æš´éœ²çš„urlï¼‰\n * @param origininvoker\n * @return\n */\nprivate URL getProviderUrl(final Invoker<?> origininvoker) {\n\t//è·å–å‚æ•°exportæŒ‡å®šçš„æœåŠ¡åœ°å€\n\tString export = origininvoker.getUrl().getParameterAndDecoded(Constants.EXPORT_KEY);\n\tif (export == null || export.length() == 0) {\n\t    //æ³¨å†Œä¸­å¿ƒæœåŠ¡æš´éœ²urlä¸ºç©º\n\t    throw new IllegalArgumentException(\"The registry export url is null! registry: \" + origininvoker.getUrl());\n\t}\n\t//æ ¹æ®urlå­—ç¬¦ä¸²ç”ŸæˆURLå¯¹è±¡\n\tURL providerUrl = URL.valueOf(export);\n\treturn providerUrl;\n}\n\n/**\n * è·å–originInvokerå¯¹è±¡å¯¹åº”çš„ç¼“å­˜keyï¼ˆç§»é™¤äº†dynamicã€enabledå±æ€§çš„æœåŠ¡æä¾›è€…urlï¼‰\n */\nprivate String getCacheKey(final Invoker<?> originInvoker) {\n\t//è·å–æœåŠ¡æš´éœ²çš„urlï¼Œå³exportå‚æ•°å¯¹åº”çš„url\n\tURL providerUrl = getProviderUrl(originInvoker);\n\t//ç§»é™¤dynamicã€enabledå‚æ•°ï¼Œå‰©ä¸‹çš„urlä½œä¸ºç¼“å­˜key\n\tString key = providerUrl.removeParameters(\"dynamic\", \"enabled\").toFullString();\n\treturn key;\n}\n\n/**\n * è·å–æ³¨å†Œä¸­å¿ƒurl(å¦‚æœæ˜¯æ³¨å†Œä¸­å¿ƒåè®®ï¼Œåˆ™ä¿®æ”¹äº†protocolå±æ€§å€¼ï¼Œå±æ€§å€¼ä¸ºurlçš„registryå‚æ•°å€¼ï¼Œå¹¶ç§»é™¤urlçš„registryå‚æ•°)\n * @param originInvoker\n * @return\n */\nprivate URL getRegistryUrl(Invoker<?> originInvoker) {\n\t//æ³¨å†Œä¸­å¿ƒurl\n\tURL registryUrl = originInvoker.getUrl();\n\t\n\tif (Constants.REGISTRY_PROTOCOL.equals(registryUrl.getProtocol())) {\n\t    //å¦‚æœregistryUrlçš„protocolå±æ€§ä¸º\"registry\"ï¼Œåˆ™è·å–registryUrlçš„registryå‚æ•°å€¼ï¼Œå¦‚æœæ²¡æœ‰è·å–åˆ°ï¼Œåˆ™é»˜è®¤protocol = dubbo\n\t    //è¿™é‡Œè·å–åˆ°protocol = multicast\n\t    String protocol = registryUrl.getParameter(Constants.REGISTRY_KEY, Constants.DEFAULT_DIRECTORY);\n\t    //è®¾ç½®registryUrlçš„protocolå±æ€§å€¼ï¼Œå¹¶ç§»é™¤registryå‚æ•°\n\t    registryUrl = registryUrl.setProtocol(protocol).removeParameter(Constants.REGISTRY_KEY);\n\t}\n\treturn registryUrl;\n}\n\n/**\n *\n * åŸºäºinvokerçš„åœ°å€è·å–ä¸€ä¸ªæ³¨å†Œä¸­å¿ƒçš„å®ä¾‹\n * @param originInvoker\n * @return\n */\nprivate Registry getRegistry(final Invoker<?> originInvoker) {\n\tURL registryUrl = getRegistryUrl(originInvoker);\n\t//è·å–å®ä¾‹\n\treturn registryFactory.getRegistry(registryUrl);\n}\n\n/**\n * è¿”å›æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒçš„åœ°å€å¹¶è¿‡æ»¤ä¸€æ¬¡urlå‚æ•°(å³æœåŠ¡æä¾›è€…url)\n * @param originInvoker\n * @return\n */\nprivate URL getRegistedProviderUrl(final Invoker<?> originInvoker) {\n\t//æœåŠ¡æš´éœ²çš„urlï¼Œå³exportå‚æ•°æŒ‡å®šçš„url\n\tURL providerUrl = getProviderUrl(originInvoker);\n\n\t//åœ¨æ³¨å†Œä¸­å¿ƒä¸­çœ‹åˆ°çš„æœåŠ¡åœ°å€\n\tfinal URL registedProviderUrl = providerUrl.removeParameters(\n\t\t\t//åˆ é™¤ä¸éœ€è¦è¾“å‡ºçš„å‚æ•°key\n\t\t\tgetFilteredKeys(providerUrl)\n\t\t)\n\t\t//ç§»é™¤ç›‘æ§\n\t\t.removeParameter(Constants.MONITOR_KEY)\n\t\t//ç§»é™¤ç»‘å®šipã€port\n\t\t.removeParameter(Constants.BIND_IP_KEY)\n\t\t.removeParameter(Constants.BIND_PORT_KEY)\n\t\t//ç§»é™¤qos\n\t\t.removeParameter(QOS_ENABLE)\n\t\t.removeParameter(QOS_PORT)\n\t\t.removeParameter(ACCEPT_FOREIGN_IP);\n\t\n\treturn registedProviderUrl;\n}\n\n/**\n * æœåŠ¡æš´éœ²\n * originInvokerå‚æ•°å°±æ˜¯ä¸Šé¢æˆ‘ä»¬åˆ›å»ºçš„wrapperInvoker\n */\n@Override\npublic <T> Exporter<T> export(final Invoker<T> originInvoker) throws RpcException {\n\t//æš´éœ²invoker(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\tfinal ExporterChangeableWrapper<T> exporter = doLocalExport(originInvoker);\n\t\n\t//è·å–æ³¨å†Œä¸­å¿ƒåœ°å€,å¦‚ï¼šmulticast://224.5.6.7:1234/com.alibaba.dubbo.registry.RegistryService?application=demo-provider&dubbo=2.0.0&export=dubbo%3A%2F%2F192.168.99.60%3A20880%2Fcom.alibaba.dubbo.demo.DemoService%3Fanyhost%3Dtrue%26application%3Ddemo-provider%26bind.ip%3D192.168.99.60%26bind.port%3D20880%26dubbo%3D2.0.0%26generic%3Dfalse%26interface%3Dcom.alibaba.dubbo.demo.DemoService%26methods%3DsayHello%26pid%3D7520%26qos.port%3D22222%26side%3Dprovider%26timestamp%3D1528784828723&pid=7520&qos.port=22222&timestamp=1528784779675\n\tURL registryUrl = getRegistryUrl(originInvoker);\n\n\t//è·å–æ³¨å†Œä¸­å¿ƒå®ä¾‹\n\tfinal Registry registry = getRegistry(originInvoker);\n\t\n\t//æ³¨å†Œä¸­å¿ƒurlçš„exportå‚æ•°æŒ‡å®šçš„url(æœåŠ¡æä¾›è€…url)ï¼Œå»æ‰äº†ä¸€äº›key\n\tfinal URL registedProviderUrl = getRegistedProviderUrl(originInvoker);\n\t\n\t//åˆ¤æ–­æ˜¯å¦å»¶è¿Ÿå‘å¸ƒï¼Œé»˜è®¤æ˜¯true\n\tboolean register = registedProviderUrl.getParameter(\"register\", true);\n\t\n\t//æ³¨å†ŒæœåŠ¡æä¾›è€…(ä¿å­˜åˆ°mapç¼“å­˜ä¸­)\n\tProviderConsumerRegTable.registerProvider(originInvoker, registryUrl, registedProviderUrl);\n\n\tif (register) {\n\t    //registryUrlæ³¨å†Œä¸­å¿ƒurlï¼ŒregistedProviderUrlæœåŠ¡æä¾›è€…url\n\t    //è·å–æ³¨å†Œä¸­å¿ƒï¼Œå¹¶å°†æœåŠ¡æä¾›è€…æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒ\n\t    register(registryUrl, registedProviderUrl);\n\t    \n\t    //æ ¹æ®originInvokerè·å–åˆ°ProviderInvokerWrapperå¹¶æ ‡è¯†isReg = true\n\t    ProviderConsumerRegTable.getProviderWrapper(originInvoker).setReg(true);\n\t}\n\n\t// å½“æä¾›è€…è®¢é˜…æ—¶ï¼Œä¼šå½±å“ä¸€ä¸ªåœºæ™¯ï¼Œå³åŒä¸€JVMå³æš´éœ²æœåŠ¡ï¼Œåˆå¼•ç”¨åŒä¸€æœåŠ¡ã€‚\n\t// å› ä¸ºsubscribedä½¿ç”¨æœåŠ¡çš„åç§°ä½œä¸ºç¼“å­˜keyï¼Œå®ƒä¼šå¯¼è‡´è®¢é˜…ä¿¡æ¯è¢«è¦†ç›–\n\t//å¦‚ï¼šprovider://192.168.99.60:20880/com.alibaba.dubbo.demo.DemoService?anyhost=true&application=demo-provider&category=configurators&check=false&dubbo=2.0.0&generic=false&interface=com.alibaba.dubbo.demo.DemoService&methods=sayHello&pid=5452&side=provider&timestamp=1528789631708\n\tfinal URL overrideSubscribeUrl = getSubscribedOverrideUrl(registedProviderUrl);\n\t\n\t//åˆ›å»ºOverrideListenerå¯¹è±¡(åé¢å°èŠ‚ä¼šä»‹ç»)\n\tfinal OverrideListener overrideSubscribeListener = new OverrideListener(overrideSubscribeUrl, originInvoker);\n\t\n\t//ä¿å­˜overrideSubscribeUrlå’ŒoverrideSubscribeListener\n\toverrideListeners.put(overrideSubscribeUrl, overrideSubscribeListener);\n\t\n\t//è®¢é˜…æœåŠ¡(åé¢æ³¨å†Œä¸­å¿ƒå°èŠ‚ä¼šä»‹ç»)\n\tregistry.subscribe(overrideSubscribeUrl, overrideSubscribeListener);\n\t\n\t//ç¡®ä¿æ¯æ¬¡å‘å¸ƒæ—¶éƒ½è¿”å›ä¸€ä¸ªæ–°çš„exporterå®ä¾‹\n\treturn new DestroyableExporter<T>(exporter, originInvoker, overrideSubscribeUrl, registedProviderUrl);\n}\n\n/**\n * subscribedOverrideUrl\n * @param registedProviderUrl æœåŠ¡æä¾›è€…url\n * @return\n */\nprivate URL getSubscribedOverrideUrl(URL registedProviderUrl) {\n\t//è®¾ç½®protocol = provider,ä¿®æ”¹å‰ protocol = dubbo\n\t//è®¾ç½®category = configurators\n\t//è®¾ç½®check = false\n\treturn registedProviderUrl.setProtocol(Constants.PROVIDER_PROTOCOL)\n\t\t.addParameters(Constants.CATEGORY_KEY, Constants.CONFIGURATORS_CATEGORY,\n\t\t\tConstants.CHECK_KEY, String.valueOf(false));\n}\n\n/**\n * é€šè¿‡registryUrlè·å–æ³¨å†Œä¸­å¿ƒï¼Œç„¶åå°†æœåŠ¡æä¾›è€…urlæ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒ\n * @param registryUrl æ³¨å†Œä¸­å¿ƒurl\n * @param registedProviderUrl æœåŠ¡æä¾›è€…url\n */\npublic void register(URL registryUrl, URL registedProviderUrl) {\n\t//æ ¹æ®æ³¨å†Œä¸­å¿ƒurl è·å–æ³¨å†Œä¸­å¿ƒå®ä¾‹\n\tRegistry registry = registryFactory.getRegistry(registryUrl);\n\t//æ³¨å†Œ æœåŠ¡æä¾›è€… åˆ°æ³¨å†Œä¸­å¿ƒ\n\tregistry.register(registedProviderUrl);\n}\n\n/**\n * ä¸ºäº†è§£å†³RMIåå¤æš´éœ²ç«¯å£å†²çªçš„é—®é¢˜ï¼Œå·²ç»æš´éœ²çš„æœåŠ¡ä¸éœ€è¦å†æ¬¡æš´éœ²\n * <providerurl,exporter>\n */\nprivate final Map<String, ExporterChangeableWrapper<?>> bounds = new ConcurrentHashMap<String, ExporterChangeableWrapper<?>>();\n\n/**\n * <æœåŠ¡æä¾›è€…url,NotifyListener>\n */\nprivate final Map<URL, NotifyListener> overrideListeners = new ConcurrentHashMap<URL, NotifyListener>();\n\n/**\n * æš´éœ²originInvoker\n */\nprivate <T> ExporterChangeableWrapper<T> doLocalExport(final Invoker<T> originInvoker) {\n\t//è·å–ç¼“å­˜key\n\tString key = getCacheKey(originInvoker);\n\t\n\t//å…ˆæ£€æŸ¥æ˜¯å¦æš´éœ²è¿‡ï¼Œæ²¡æœ‰æš´éœ²è¿‡çš„è¯ï¼Œåˆ™è¿›è¡Œæš´éœ²\n\tExporterChangeableWrapper<T> exporter = (ExporterChangeableWrapper<T>) bounds.get(key);\n\tif (exporter == null) {\n\t    synchronized (bounds) {\n\t\texporter = (ExporterChangeableWrapper<T>) bounds.get(key);\n\t\tif (exporter == null) {\n\t\t    //æ ¹æ®originInvokerï¼ŒåŠå…¶æœåŠ¡æä¾›è€…urlï¼Œåˆ›å»ºInvokerDelegeteå¯¹è±¡\n\t\t    final Invoker<?> invokerDelegete = new InvokerDelegete<T>(originInvoker, getProviderUrl(originInvoker));\n\t\t   \n\t\t    //1ã€å› ä¸ºinvokerDelegeteå¯¹è±¡çš„getUrlæ–¹æ³•å°†ä¼šè¿”å›æœåŠ¡æä¾›è€…urlï¼Œå…¶protocolå±æ€§å°†ä¼šè¿”å›æ‰©å±•åç§°dubboï¼Œå› æ­¤è¿™é‡Œä¼šè°ƒç”¨DubboProtocolçš„exportæ–¹æ³•è¿›è¡Œæš´éœ²\n\t\t    //2ã€åˆ›å»ºExporterChangeableWrapperå¯¹è±¡\n\t\t    exporter = new ExporterChangeableWrapper<T>((Exporter<T>) protocol.export(invokerDelegete), originInvoker);\n\t\t    \n\t\t    //dubbo://192.168.99.60:20880/com.alibaba.dubbo.demo.DemoService?anyhost=true&application=demo-provider&bind.ip=192.168.99.60&bind.port=20880&dubbo=2.0.0&generic=false&interface=com.alibaba.dubbo.demo.DemoService&methods=sayHello&pid=6440&qos.port=22222&side=provider&timestamp=1528789363848\n\t\t    //URL url = exporter.getInvoker().getUrl();\n\t\t    //æ”¾å…¥ç¼“å­˜\n\t\t    bounds.put(key, exporter);\n\t\t}\n\t    }\n\t}\n\treturn exporter;\n}\n\n/**\n * Invokerå§”æ‰˜ç±»\n */\npublic static class InvokerDelegete<T> extends InvokerWrapper<T> {\n\n\tprivate final Invoker<T> invoker;\n\n\t/**\n\t * @param invoker\n\t * @param url   æœåŠ¡æä¾›è€…url\n\t */\n\tpublic InvokerDelegete(Invoker<T> invoker, URL url) {\n\t    super(invoker, url);\n\t    this.invoker = invoker;\n\t}\n\n\tpublic Invoker<T> getInvoker() {\n\t    if (invoker instanceof InvokerDelegete) {\n\t\treturn ((InvokerDelegete<T>) invoker).getInvoker();\n\t    } else {\n\t\treturn invoker;\n\t    }\n\t}\n}\n\n/**\n * exporterä»£ç†\n * å»ºç«‹é€šè¿‡protocolå·²æš´éœ²çš„exporterå’Œå·²è¿”å›çš„exporterçš„å¯¹åº”å…³ç³»\n * å¹¶ä¸”å¯ä»¥åœ¨è¦†ç›–æ—¶ä¿®æ”¹å…³ç³»\n */\nprivate class ExporterChangeableWrapper<T> implements Exporter<T> {\n\n\tprivate final Invoker<T> originInvoker;\n\n\t//protocol.export(invokerDelegete)è¿”å›çš„Exporter\n\tprivate Exporter<T> exporter;\n\n\tpublic ExporterChangeableWrapper(Exporter<T> exporter, Invoker<T> originInvoker) {\n\t    this.exporter = exporter;\n\t    this.originInvoker = originInvoker;\n\t}\n\n\tpublic Invoker<T> getOriginInvoker() {\n\t    return originInvoker;\n\t}\n\n\t@Override\n\tpublic Invoker<T> getInvoker() {\n\t    return exporter.getInvoker();\n\t}\n\n\tpublic void setExporter(Exporter<T> exporter) {\n\t    this.exporter = exporter;\n\t}\n\n\t@Override\n\tpublic void unexport() {\n\t    String key = getCacheKey(this.originInvoker);\n\t    bounds.remove(key);\n\t    exporter.unexport();\n\t}\n}\n\n/**\n * å¯é”€æ¯çš„Exporter\n */\nstatic private class DestroyableExporter<T> implements Exporter<T> {\n\t\n\tpublic static final ExecutorService executor = Executors.newSingleThreadExecutor(new NamedThreadFactory(\"Exporter-Unexport\", true));\n\n\tprivate Exporter<T> exporter;\n\tprivate Invoker<T> originInvoker;\n\n\t//overrideSubscribeUrl è®¢é˜…çš„url\n\tprivate URL subscribeUrl; \n\t\n\t//registedProviderUrl æ³¨å†Œçš„æœåŠ¡æä¾›è€…url\n\tprivate URL registerUrl;\n\n\tpublic DestroyableExporter(Exporter<T> exporter, Invoker<T> originInvoker, URL subscribeUrl, URL registerUrl) {\n\t    this.exporter = exporter;\n\t    this.originInvoker = originInvoker;\n\t    this.subscribeUrl = subscribeUrl;\n\t    this.registerUrl = registerUrl;\n\t}\n\n\t@Override\n\tpublic Invoker<T> getInvoker() {\n\t    return exporter.getInvoker();\n\t}\n\n\t@Override\n\tpublic void unexport() {\n\t    //è·å–æ³¨å†Œä¸­å¿ƒå®ä¾‹\n\t    Registry registry = RegistryProtocol.INSTANCE.getRegistry(originInvoker);\n\t    try {\n\t        //å–æ¶ˆæ³¨å†ŒregisterUrl\n\t\tregistry.unregister(registerUrl);\n\t    } catch (Throwable t) {\n\t\tlogger.warn(t.getMessage(), t);\n\t    }\n\t    try {\n\t        //ç§»é™¤ç›‘å¬\n\t\tNotifyListener listener = RegistryProtocol.INSTANCE.overrideListeners.remove(subscribeUrl);\n\t\t//å–æ¶ˆè®¢é˜…subscribeUrl\n\t\tregistry.unsubscribe(subscribeUrl, listener);\n\t    } catch (Throwable t) {\n\t\tlogger.warn(t.getMessage(), t);\n\t    }\n\t    //æäº¤çº¿ç¨‹ï¼Œå–æ¶ˆæš´éœ²æœåŠ¡\n\t    executor.submit(new Runnable() {\n\t\t@Override\n\t\tpublic void run() {\n\t\t    try {\n\t\t        //å–æ¶ˆæš´éœ²æœåŠ¡æ—¶ï¼Œç­‰å¾…æ³¨å†Œä¸­å¿ƒé€šçŸ¥æ‰€æœ‰çš„æ¶ˆè´¹è€…çš„è¶…æ—¶æ—¶é—´\n\t\t\tint timeout = ConfigUtils.getServerShutdownTimeout();\n\t\t\tif (timeout > 0) {\n\t\t\t    logger.info(\"Waiting \" + timeout + \"ms for registry to notify all consumers before unexport. Usually, this is called when you use dubbo API\");\n\t\t\t    Thread.sleep(timeout);\n\t\t\t}\n\t\t\t//å–æ¶ˆæš´éœ²æœåŠ¡\n\t\t\texporter.unexport();\n\t\t    } catch (Throwable t) {\n\t\t\tlogger.warn(t.getMessage(), t);\n\t\t    }\n\t\t}\n\t    });\n\t}\n}\n```\n\nProviderConsumerRegTableç±»ç”¨æ¥ä¿å­˜æ³¨å†Œçš„æœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…\n```java\npublic class ProviderConsumerRegTable {\n    /**\n     * <æœåŠ¡å”¯ä¸€åç§°,Set<æœåŠ¡æä¾›è€…æ‰§è¡Œå™¨>>\n     */\n    public static ConcurrentHashMap<String, Set<ProviderInvokerWrapper>> providerInvokers = new ConcurrentHashMap<String, Set<ProviderInvokerWrapper>>();\n    public static ConcurrentHashMap<String, Set<ConsumerInvokerWrapper>> consumerInvokers = new ConcurrentHashMap<String, Set<ConsumerInvokerWrapper>>();\n\n    /**\n     * æ³¨å†ŒæœåŠ¡æä¾›è€…\n     * @param invoker\n     * @param registryUrl æ³¨å†Œä¸­å¿ƒåœ°å€\n     * @param providerUrl æœåŠ¡æä¾›è€…url\n     */\n    public static void registerProvider(Invoker invoker, URL registryUrl, URL providerUrl) {\n\t//åˆ›å»ºProviderInvokerWrapperå®ä¾‹\n        ProviderInvokerWrapper wrapperInvoker = new ProviderInvokerWrapper(invoker, registryUrl, providerUrl);\n        \n\t//è·å–æœåŠ¡å”¯ä¸€åç§°æ ‡è¯†\n        String serviceUniqueName = providerUrl.getServiceKey();\n\t\n\t//æ ¹æ®serviceUniqueNameä»ç¼“å­˜ä¸­è·å–\n\tSet<ProviderInvokerWrapper> invokers = providerInvokers.get(serviceUniqueName);\n        \n\tif (invokers == null) {\n            providerInvokers.putIfAbsent(serviceUniqueName, new ConcurrentHashSet<ProviderInvokerWrapper>());\n            invokers = providerInvokers.get(serviceUniqueName);\n        }\n        invokers.add(wrapperInvoker);\n    }\n}\n\n/**\n * é€šè¿‡invoker è·å–ç›¸åº”çš„ProviderInvokerWrapper\n * @param invoker\n * @return\n */\npublic static ProviderInvokerWrapper getProviderWrapper(Invoker invoker) {\n\t//è·å–æœåŠ¡æä¾›è€…url\n\tURL providerUrl = invoker.getUrl();\n\tif (Constants.REGISTRY_PROTOCOL.equals(providerUrl.getProtocol())) {\n\t    //è·å–exportå‚æ•°çš„å€¼ï¼Œå³(æœåŠ¡æä¾›è€…url)\n\t    providerUrl = URL.valueOf(providerUrl.getParameterAndDecoded(Constants.EXPORT_KEY));\n\t}\n\t//è·å–æœåŠ¡å”¯ä¸€æ ‡è¯†\n\tString serviceUniqueName = providerUrl.getServiceKey();\n\t//æ ¹æ®æœåŠ¡å”¯ä¸€æ ‡è¯†è·å–invokers\n\tSet<ProviderInvokerWrapper> invokers = providerInvokers.get(serviceUniqueName);\n\tif (invokers == null) {\n\t    return null;\n\t}\n\tfor (ProviderInvokerWrapper providerWrapper : invokers) {\n\t    Invoker providerInvoker = providerWrapper.getInvoker();\n\t    //é€šè¿‡invokerè·å–providerWrapper\n\t    if (providerInvoker == invoker) {\n\t\treturn providerWrapper;\n\t    }\n\t}\n\treturn null;\n}\n\n\n/**\n * é‡æ–°æš´éœ²ä¿®æ”¹äº†urlçš„invoker\n * @param originInvoker\n * @param newInvokerUrl\n */\n@SuppressWarnings(\"unchecked\")\nprivate <T> void doChangeLocalExport(final Invoker<T> originInvoker, URL newInvokerUrl) {\n        //è·å–originInvokerå¯¹åº”çš„ç¼“å­˜key\n\tString key = getCacheKey(originInvoker);\n\n\t//ä»ç¼“å­˜ä¸­è·å–è¯¥exporter\n\tfinal ExporterChangeableWrapper<T> exporter = (ExporterChangeableWrapper<T>) bounds.get(key);\n\t\n\tif (exporter == null) {\n\t    logger.warn(new IllegalStateException(\"error state, exporter should not be null\"));\n\t} else {\n\t    //é‡æ–°ç”ŸæˆinvokerDelegete\n\t    final Invoker<T> invokerDelegete = new InvokerDelegete<T>(originInvoker, newInvokerUrl);\n\t    //é‡æ–°æš´éœ²æœåŠ¡\n\t    exporter.setExporter(protocol.export(invokerDelegete));\n\t}\n}\n```\n\næ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸‹OverrideListenerç±»\n```java\n/**\n * 1ã€ç¡®ä¿ç”±registryProtocolè¿”å›çš„exporterå¯ä»¥è¢«æ­£å¸¸é”€æ¯\n * 2ã€é€šçŸ¥åï¼Œæ— éœ€é‡æ–°æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒ\n * 3ã€é€šè¿‡æš´éœ²æ–¹æ³•ä¼ é€’invokerï¼Œæœ€å¥½æ˜¯exporterçš„invoker\n */\nprivate class OverrideListener implements NotifyListener {\n\t/**\n\t * å·²è®¢é˜…çš„url\n\t * protocol = provider\n\t */\n\tprivate final URL subscribeUrl;\n\n\tprivate final Invoker originInvoker;\n\n\tpublic OverrideListener(URL subscribeUrl, Invoker originalInvoker) {\n\t    this.subscribeUrl = subscribeUrl;\n\t    this.originInvoker = originalInvoker;\n\t}\n\n\t/**\n\t * é€šçŸ¥\n\t * @param urls å·²æ³¨å†Œçš„ä¿¡æ¯åˆ—è¡¨ï¼Œå®ƒæ€»æ˜¯éç©ºã€‚è¿™æ„å‘³ç€ä¸RegistryService#lookup(URL)æœ‰ç›¸åŒçš„è¿”å›å€¼\n\t */\n\t@Override\n\tpublic synchronized void notify(List<URL> urls) {\n\t    logger.debug(\"original override urls: \" + urls);\n\t    \n\t    //è·å–åŒ¹é…åˆ°çš„url\n\t    List<URL> matchedUrls = getMatchedUrls(urls, subscribeUrl);\n\t    logger.debug(\"subscribe url: \" + subscribeUrl + \", override urls: \" + matchedUrls);\n\n\t    //æ²¡æœ‰åŒ¹é…åˆ°ç»“æœï¼Œç›´æ¥è¿”å›\n\t    if (matchedUrls.isEmpty()) {\n\t\treturn;\n\t    }\n\t\t\n\t    //æ ¹æ®åŒ¹é…çš„urlç”Ÿæˆconfiguratorsåˆ—è¡¨(åé¢å°èŠ‚ä¼šåˆ†æè¯¥æ–¹æ³•)\n\t    List<Configurator> configurators = RegistryDirectory.toConfigurators(matchedUrls);\n\n\t    final Invoker<?> invoker;\n\t    if (originInvoker instanceof InvokerDelegete) {\n\t        //å§”æ‰˜ç±»ï¼Œè°ƒç”¨getInvoker()æ–¹æ³•è·å–invoker\n\t\tinvoker = ((InvokerDelegete<?>) originInvoker).getInvoker();\n\t    } else {\n\t\tinvoker = originInvoker;\n\t    }\n\n\t    //originUrlå³exportå‚æ•°å¯¹åº”çš„url(åŸå§‹æœåŠ¡æä¾›è€…url)\n\t    URL originUrl = RegistryProtocol.this.getProviderUrl(invoker);\n\t    \n\t    //è¿™é‡Œçš„exporterå°±æ˜¯åœ¨ä¸Šæ­¥çš„doLocalExport()æ–¹æ³•ä¸­ç”Ÿæˆçš„\n\t    String key = getCacheKey(originInvoker);\n\n\t    //æ ¹æ®ç¼“å­˜keyä»ç¼“å­˜ä¸­è·å–exporter\n\t    ExporterChangeableWrapper<?> exporter = bounds.get(key);\n\t    if (exporter == null) {\n\t\tlogger.warn(new IllegalStateException(\"error state, exporter should not be null\"));\n\t\treturn;\n\t    }\n\t    \n\t    //å½“å‰çš„url(æ—§çš„æœåŠ¡æš´éœ²çš„url)ï¼Œå¯èƒ½å·²ç»åˆå¹¶äº†å¾ˆå¤šæ¬¡\n\t    URL currentUrl = exporter.getInvoker().getUrl();\n\t   \n\t    //åˆå¹¶é…ç½®ï¼Œç”Ÿæˆæ–°çš„æœåŠ¡æš´éœ²url\n\t    URL newUrl = getConfigedInvokerUrl(configurators, originUrl);\n\t    \n\t    if (!currentUrl.equals(newUrl)) {\n\t\t//å·²æš´éœ²çš„æœåŠ¡æä¾›è€…urlå·²ç»å‘ç”Ÿæ”¹å˜ï¼Œé‡æ–°æš´éœ²\n\t\tRegistryProtocol.this.doChangeLocalExport(originInvoker, newUrl);\n\n\t\tlogger.info(\"exported provider url changed, origin url: \" + originUrl + \", old export url: \" + currentUrl + \", new export url: \" + newUrl);\n\t    }\n\t}\n\t\n\t/**\n\t * è·å–åŒ¹é…çš„url\n\t * @param configuratorUrls\n\t * @param currentSubscribe å½“å‰å·²è®¢é˜…çš„url\n\t */\n\tprivate List<URL> getMatchedUrls(List<URL> configuratorUrls, URL currentSubscribe) {\n\t    List<URL> result = new ArrayList<URL>();\n\t    \n\t    for (URL url : configuratorUrls) {\n\t\tURL overrideUrl = url;\n\t\t//ä¸æ—§ç‰ˆæœ¬å…¼å®¹\n\t\tif (url.getParameter(Constants.CATEGORY_KEY) == null && Constants.OVERRIDE_PROTOCOL.equals(url.getProtocol())) {\n\t\t    //urlçš„categoryå‚æ•°ä¸ºç©ºï¼Œå¹¶ä¸”urlåè®®ä¸ºoverrideæ—¶ï¼Œåˆ™æ–°å¢urlçš„categoryå‚æ•° = configurators\n\t\t    overrideUrl = url.addParameter(Constants.CATEGORY_KEY, Constants.CONFIGURATORS_CATEGORY);\n\t\t}\n\n\t\t//æ£€æµ‹urlæ˜¯å¦å¯ä»¥åº”ç”¨åˆ°å½“å‰æœåŠ¡\n\t\t//consumerUrl,providerUrl\n\t\tif (UrlUtils.isMatch(currentSubscribe, overrideUrl)) {\n\t\t    //åŒ¹é…ï¼Œåˆ™å°†è¯¥urlä¿å­˜\n\t\t    result.add(url);\n\t\t}\n\t    }\n\t    return result;\n\t}\n\n\t/**\n\t * åˆå¹¶configuratorsçš„urlï¼Œè¿”å›æ–°çš„url\n\t * @param configurators\n\t * @param url åŸå§‹æœåŠ¡æä¾›è€…url\n\t * @return\n\t */\n\tprivate URL getConfigedInvokerUrl(List<Configurator> configurators, URL url) {\n\t    for (Configurator configurator : configurators) {\n\t        //é…ç½®url\n\t\turl = configurator.configure(url);\n\t    }\n\t    return url;\n\t}\n}\n```\n\næœ€åæˆ‘ä»¬æ¥çœ‹ä¸‹DubboProtocolçš„exportæ–¹æ³•\n\n```java\n/**\n * ä¿å­˜å‘å¸ƒçš„æœåŠ¡\n * <URLçš„serviceKey,Exporter>\n * é€šè¿‡keyå¯ä»¥è·å–åˆ°æœåŠ¡å‘å¸ƒå¯¹è±¡DubboExporterï¼Œ\n * ç„¶åé€šè¿‡DubboExporterçš„getInvokeræ–¹æ³•å¾—åˆ°æœåŠ¡è°ƒç”¨å¯¹è±¡Invoker,ä»è€Œè°ƒç”¨æœåŠ¡\n */\nprotected final Map<String, Exporter<?>> exporterMap = new ConcurrentHashMap<String, Exporter<?>>();\n\n/**\n * æ¶ˆè´¹è€…ç«¯ä¸ºè°ƒåº¦äº‹ä»¶æš´éœ²ä¸€ä¸ªå­˜æ ¹æœåŠ¡\n * <servicekey,stubmethods>\n */\nprivate final ConcurrentMap<String, String> stubServiceMethodsMap = new ConcurrentHashMap<String, String>();\n\n\n/**\n *\n * @param invoker å³æ–°åˆ›å»ºçš„InvokerDelegeteå¯¹è±¡\n */\n@Override\npublic <T> Exporter<T> export(Invoker<T> invoker) throws RpcException {\n\t\n\t//æœåŠ¡æä¾›è€…url\n\t//dubbo://192.168.99.60:20880/com.alibaba.dubbo.demo.DemoService?anyhost=true&application=demo-provider&bind.ip=192.168.99.60&bind.port=20880&dubbo=2.0.0&generic=false&interface=com.alibaba.dubbo.demo.DemoService&methods=sayHello&pid=7520&qos.port=22222&side=provider&timestamp=1528784828723\n\tURL url = invoker.getUrl();\n\n\t// è·å–æœåŠ¡åç§°ï¼Œæ ¼å¼ä¸ºï¼šgroup/ServiceName:version:port\n\t// è¿™é‡Œgroupå’Œversionæ²¡æœ‰è®¾ç½®ï¼Œå› æ­¤key = com.alibaba.dubbo.demo.DemoService:20880\n\tString key = serviceKey(url);\n\t\n\t//ç”Ÿæˆkeyå€¼ä¹‹åï¼Œç»“åˆInvokerå’ŒexportMapç”ŸæˆæœåŠ¡æš´éœ²å¯¹è±¡exporterï¼Œ\n\t//ç„¶åå°†ç”Ÿæˆçš„æœåŠ¡æš´éœ²å¯¹è±¡exporterä½œä¸ºvalueå€¼æ”¾å…¥mapä¸­ï¼Œä»è€Œå®ç°æœåŠ¡å‘å¸ƒ\n\tDubboExporter<T> exporter = new DubboExporter<T>(invoker, key, exporterMap);\n\texporterMap.put(key, exporter);\n\n\t//ä¸ºè°ƒåº¦äº‹ä»¶æš´éœ²ä¸€ä¸ªå­˜æ ¹æœåŠ¡ï¼Œé»˜è®¤false\n\tBoolean isStubSupportEvent = url.getParameter(Constants.STUB_EVENT_KEY, Constants.DEFAULT_STUB_EVENT);\n\t\n\t//æ˜¯å¦æ˜¯å›è°ƒæœåŠ¡\n\tBoolean isCallbackservice = url.getParameter(Constants.IS_CALLBACK_SERVICE, false);\n\tif (isStubSupportEvent && !isCallbackservice) {\n\t    //å­˜æ ¹æœåŠ¡æ–¹æ³•\n\t    String stubServiceMethods = url.getParameter(Constants.STUB_EVENT_METHODS_KEY);\n\t    if (stubServiceMethods == null || stubServiceMethods.length() == 0) {\n\t\tif (logger.isWarnEnabled()) {\n\t\t    //è®¾ç½®äº†å­˜æ ¹ä»£ç†æ”¯æŒäº‹ä»¶ï¼Œä½†æ˜¯æ²¡æœ‰å‘ç°å­˜æ ¹æ–¹æ³•\n\t\t    logger.warn(new IllegalStateException(\"consumer [\" + url.getParameter(Constants.INTERFACE_KEY) +\n\t\t\t    \"], has set stubproxy support event ,but no stub methods founded.\"));\n\t\t}\n\t    } else {\n\t\t//ä¿å­˜å­˜æ ¹æ–¹æ³•\n\t\tstubServiceMethodsMap.put(url.getServiceKey(), stubServiceMethods);\n\t    }\n\t}\n\t//å¼€å¯æœåŠ¡\n\topenServer(url);\n\t//ä¼˜åŒ–åºåˆ—åŒ–(åŠ è½½ä¼˜åŒ–åºåˆ—åŒ–ç±»,åé¢å°èŠ‚ä¼šè¯¦ç»†ä»‹ç»)\n\toptimizeSerialization(url);\n\t//è¿”å›exporter\n\treturn exporter;\n}\n\n/**\n * ä¿å­˜å·²åˆ›å»ºçš„æœåŠ¡å™¨\n * <åœ°å€addressï¼ŒExchangeServer>\n */\nprivate final Map<String, ExchangeServer> serverMap = new ConcurrentHashMap<String, ExchangeServer>();\n\n/**\n * å¼€å¯æœåŠ¡(åé¢ä¼šå°èŠ‚ä¼šè¯¦è§£è®²è§£)\n * @param url\n */\nprivate void openServer(URL url) {\n\t//è·å–æœåŠ¡åœ°å€\n\tString key = url.getAddress();\n\t\n\t//å®¢æˆ·ç«¯å¯ä»¥æš´éœ²ä¸€ä¸ªåªèƒ½æœåŠ¡ç«¯è°ƒç”¨çš„æœåŠ¡\n\tboolean isServer = url.getParameter(Constants.IS_SERVER_KEY, true);\n\t\n\tif (isServer) {\n\t    //å…ˆä»ç¼“å­˜ä¸­è·å–ä¸‹è¯¥æœåŠ¡åœ°å€keyå¯¹åº”çš„æœåŠ¡å™¨\n\t    ExchangeServer server = serverMap.get(key);\n\t    if (server == null) {\n\t\t//åˆ›å»ºæœåŠ¡å™¨ï¼Œå¹¶æ”¾å…¥ç¼“å­˜\n\t\tserverMap.put(key, createServer(url));\n\t    } else {\n\t\t//æœåŠ¡å™¨æ”¯æŒé‡ç½®ï¼Œä¸overrideä¸€èµ·ä½¿ç”¨\n\t\t//é‡ç½®æœåŠ¡å™¨\n\t\tserver.reset(url);\n\t    }\n\t}\n}\n\n\n/**\n * åˆ›å»ºæœåŠ¡å™¨\n * @param url æœåŠ¡æä¾›è€…url\n * @return\n */\nprivate ExchangeServer createServer(URL url) {\n\t//å½“æœåŠ¡å™¨å…³é—­æ—¶ï¼Œå‘é€readonlyäº‹ä»¶ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œæ˜¯å¯ç”¨çš„ã€‚\n\turl = url.addParameterIfAbsent(Constants.CHANNEL_READONLYEVENT_SENT_KEY, Boolean.TRUE.toString());\n\t\n\t//é»˜è®¤æƒ…å†µä¸‹ï¼Œå¯ç”¨å¿ƒè·³\n\turl = url.addParameterIfAbsent(Constants.HEARTBEAT_KEY, String.valueOf(Constants.DEFAULT_HEARTBEAT));\n\t\n\t//è·å–Transporteræ‰©å±•ï¼Œé»˜è®¤ä½¿ç”¨netty\n\tString str = url.getParameter(Constants.SERVER_KEY, Constants.DEFAULT_REMOTING_SERVER);\n\n\tif (str != null && str.length() > 0 && !ExtensionLoader.getExtensionLoader(Transporter.class).hasExtension(str)) {\n\t    //ä¸æ”¯æŒçš„æœåŠ¡å™¨ç±»å‹\n\t    throw new RpcException(\"Unsupported server type: \" + str + \", url: \" + url);\n\t}\n\t//åœ¨urlä¸­æ·»åŠ codec=dubbo\n\turl = url.addParameter(Constants.CODEC_KEY, DubboCodec.NAME);\n\t\n\tExchangeServer server;\n\ttry {\n\t    //Exchangersé—¨é¢ ç»‘å®šåˆ°æœåŠ¡å™¨\n\t    server = Exchangers.bind(url, requestHandler);\n\t} catch (RemotingException e) {\n\t    throw new RpcException(\"Fail to start server(url: \" + url + \") \" + e.getMessage(), e);\n\t}\n\t\n\t//è·å–å®¢æˆ·ç«¯æ‰©å±•åç§°\n\tstr = url.getParameter(Constants.CLIENT_KEY);\n\t\n\tif (str != null && str.length() > 0) {\n\t    //è·å–æ”¯æŒçš„Transporteræ‰©å±•åç§°åˆ—è¡¨\n\t    Set<String> supportedTypes = ExtensionLoader.getExtensionLoader(Transporter.class).getSupportedExtensions();\n\t    if (!supportedTypes.contains(str)) {\n\t\t//ä¸æ”¯æŒçš„å®¢æˆ·ç«¯ç±»å‹\n\t\tthrow new RpcException(\"Unsupported client type: \" + str);\n\t    }\n\t}\n\treturn server;\n}\n```\n\n\n### æš´éœ²åˆ°æœ¬åœ°\n\nä¸»è¦çš„æ–¹æ³•è°ƒç”¨protocol.exportä¸Šæ–‡æˆ‘ä»¬å·²ç»ä»‹ç»è¿‡äº†ï¼Œè¿™é‡Œå°±ä¸å†ä»‹ç»äº†ã€‚\n\n```java\n/**\n * æš´éœ²æœåŠ¡åˆ°æœ¬åœ°æ³¨å†Œä¸­å¿ƒ\n * @param url æœåŠ¡æš´éœ²çš„url\n */\nprivate void exportLocal(URL url) {\n\tif (!Constants.LOCAL_PROTOCOL.equalsIgnoreCase(url.getProtocol())) {\n\t    //ä¾‹å¦‚ï¼šinjvm://127.0.0.1/com.alibaba.dubbo.demo.DemoService?anyhost=true&application=demo-provider&bind.ip=192.168.99.60&bind.port=20880&dubbo=2.0.0&generic=false&interface=com.alibaba.dubbo.demo.DemoService&methods=sayHello&pid=4328&qos.port=22222&side=provider&timestamp=1528278313225\n\t    URL local = URL.valueOf(url.toFullString())\n\t\t    //è®¾ç½®injvmåè®®\n\t\t    .setProtocol(Constants.LOCAL_PROTOCOL)\n\t\t    //è®¾ç½®æœ¬åœ°åœ°å€\n\t\t    .setHost(LOCALHOST)\n\t\t    //è®¾ç½®ç«¯å£\n\t\t    .setPort(0);\n\n\t    //è·å–åˆ°å®ç°ç±»refçš„Classå¯¹è±¡ï¼Œç„¶åå°†å®ƒæ”¾å…¥åˆ°ThreadLocalä¸­\n\t    ServiceClassHolder.getInstance().pushServiceClass(getServiceClass(ref));\n\n\t    //æš´éœ²æœåŠ¡(åé¢ä¼šåˆ†æexportæ–¹æ³•)\n\t    Exporter<?> exporter = protocol.export(\n\t\t    proxyFactory.getInvoker(ref, (Class) interfaceClass, local)\n\t    );\n\n\t    //ä¿å­˜æš´éœ²çš„æœåŠ¡åˆ°æœ¬åœ°å˜é‡ä¸­\n\t    exporters.add(exporter);\n\t    logger.info(\"Export dubbo service \" + interfaceClass.getName() + \" to local registry\");\n\t}\n}\n```\n\nåˆ°æ­¤ï¼Œå…³äºæœåŠ¡æš´éœ²çš„å†…å®¹ï¼Œæˆ‘ä»¬å°±ä»‹ç»å®Œæ¯•äº†ï¼Œä¸‹ä¸€å°èŠ‚ï¼Œä»‹ç»å¦‚æœå¼•ç”¨æœåŠ¡.\n","tags":["dubbo"]},{"title":"Dubboæºç é˜…è¯»ä¹‹é›†æˆSpringå¤–éƒ¨åŒ–é…ç½®(03)","url":"/blog/2018/08/08/Dubboæºç é˜…è¯»ä¹‹é›†æˆSpring-03å¤–éƒ¨åŒ–é…ç½®/","content":">è¿™ä¸€å°èŠ‚ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹æ”¯æŒå¤–éƒ¨åŒ–é…ç½®çš„ç›¸å…³ç±»ï¼Œå› ä¸ºæœ¬ç³»åˆ—æ–‡ç« ä¸»è¦å…³æ³¨æºç ï¼Œå…·ä½“çš„æ˜ å°„è§„åˆ™å°±ä¸åœ¨ä»‹ç»äº†ï¼Œå¯ä»¥å‚è€ƒ: https://zhuanlan.zhihu.com/p/32557951\n\n### æ”¯æŒçš„æ³¨è§£\n\n#### DubboComponentScanæ³¨è§£\n@Importæ˜¯Springæä¾›çš„æ³¨è§£ï¼Œå¯ä»¥é€šè¿‡å¯¼å…¥çš„æ–¹å¼å°†å®ä¾‹æ·»åŠ åˆ°BeanFactoryä¸­ï¼Œä¸äº†è§£çš„ç«¥é‹å¯ä»¥å»æˆ‘çš„åšå®¢é‡Œé¢æ‰¾ä¸€ä¸‹ï¼Œæœ‰å•ç‹¬çš„æ–‡ç« ä»‹ç»ã€‚\n```java\n@Target(ElementType.TYPE)\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\n@Import(DubboComponentScanRegistrar.class)\npublic @interface DubboComponentScan {\n\n    /**\n     * basePackages() åˆ«åï¼Œä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨ @DubboComponentScan(\"org.my.pkg\") æ›¿ä»£ @DubboComponentScan(basePackages=\"org.my.pkg\")\n     * Alias for the {@link #basePackages()} attribute. Allows for more concise annotation\n     * declarations e.g.: {@code @DubboComponentScan(\"org.my.pkg\")} instead of\n     * {@code @DubboComponentScan(basePackages=\"org.my.pkg\")}.\n     *\n     * @return the base packages to scan\n     */\n    String[] value() default {};\n\n    /**\n     * è¢«æ ‡æ³¨@Serviceæ³¨è§£çš„ç±»æ‰€åœ¨åŸºç¡€åŒ…è·¯å¾„\n     * @return the base packages to scan\n     */\n    String[] basePackages() default {};\n\n    /**\n     * ç±»å‹å®‰å…¨ï¼Œç”¨æ¥æ›¿ä»£ basePackages()\n     * @return the base packages to scan\n     */\n    Class<?>[] basePackageClasses() default {};\n}\n```\nç„¶åæˆ‘ä»¬çœ‹ä¸‹DubboComponentScanRegistrarç±»ï¼Œè¯¥ç±»è´Ÿè´£æ³¨å†ŒServiceAnnotationBeanPostProcessorå’ŒReferenceAnnotationBeanPostProcessoråˆ°BeanFactory\n```java\n/**\n * å®ç°äº†ImportBeanDefinitionRegistraræ¥å£ï¼Œå…è®¸æˆ‘ä»¬æ³¨å†Œç‰¹å®šçš„beanåˆ°Springä¸­\n * Dubbo {@link DubboComponentScan} Bean Registrar\n *\n * @see Service\n * @see DubboComponentScan\n * @see ImportBeanDefinitionRegistrar\n * @see ServiceAnnotationBeanPostProcessor\n * @see ReferenceAnnotationBeanPostProcessor\n * @since 2.5.7\n */\npublic class DubboComponentScanRegistrar implements ImportBeanDefinitionRegistrar {\n\n    @Override\n    public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) {\n\n        //è·å–å¾…æ‰«æçš„åŸºç¡€åŒ…è·¯å¾„\n        Set<String> packagesToScan = getPackagesToScan(importingClassMetadata);\n\n        //æ³¨å†ŒServiceAnnotationBeanPostProcessor\n        registerServiceAnnotationBeanPostProcessor(packagesToScan, registry);\n        //æ³¨å†ŒReferenceAnnotationBeanPostProcessor\n        registerReferenceAnnotationBeanPostProcessor(registry);\n\n    }\n\n    /**\n     * æ³¨å†ŒServiceAnnotationBeanPostProcessorç±»\n     *\n     * @param packagesToScan å¾…æ‰«æçš„åŒ…è·¯å¾„ï¼Œæ²¡æœ‰å¤„ç†placeholders\n     * @param registry       {@link BeanDefinitionRegistry}\n     * @since 2.5.8\n     */\n    private void registerServiceAnnotationBeanPostProcessor(Set<String> packagesToScan,\n                                                            BeanDefinitionRegistry registry) {\n\n        BeanDefinitionBuilder builder = rootBeanDefinition(ServiceAnnotationBeanPostProcessor.class);\n        builder.addConstructorArgValue(packagesToScan);\n        builder.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);\n        AbstractBeanDefinition beanDefinition = builder.getBeanDefinition();\n        //ç”ŸæˆbeanNameå¹¶æ‰§è¡Œæ³¨å†Œ\n        BeanDefinitionReaderUtils.registerWithGeneratedName(beanDefinition, registry);\n\n    }\n\n    /**\n     * æ³¨å†ŒReferenceAnnotationBeanPostProcessorç±»\n     * @param registry {@link BeanDefinitionRegistry}\n     */\n    private void registerReferenceAnnotationBeanPostProcessor(BeanDefinitionRegistry registry) {\n\n        // Register @Reference Annotation Bean Processor\n        BeanRegistrar.registerInfrastructureBean(registry,\n                ReferenceAnnotationBeanPostProcessor.BEAN_NAME,\n                ReferenceAnnotationBeanPostProcessor.class);\n\n    }\n\n    /**\n     * è·å–å¾…æ‰«æçš„åŸºç¡€åŒ…è·¯å¾„\n     * @param metadata\n     * @return\n     */\n    private Set<String> getPackagesToScan(AnnotationMetadata metadata) {\n        //è·å–@DubboComponentScanæ³¨è§£å±æ€§\n        AnnotationAttributes attributes = AnnotationAttributes.fromMap(\n                metadata.getAnnotationAttributes(DubboComponentScan.class.getName())\n        );\n        String[] basePackages = attributes.getStringArray(\"basePackages\");\n        Class<?>[] basePackageClasses = attributes.getClassArray(\"basePackageClasses\");\n        String[] value = attributes.getStringArray(\"value\");\n        //å°†basePackagesã€basePackageClassesã€valueå±æ€§æŒ‡å®šçš„å€¼åˆå¹¶èµ·æ¥\n        Set<String> packagesToScan = new LinkedHashSet<String>(Arrays.asList(value));\n        packagesToScan.addAll(Arrays.asList(basePackages));\n        for (Class<?> basePackageClass : basePackageClasses) {\n            //é€šè¿‡basePackageClassè·å–åŒ…å\n            packagesToScan.add(ClassUtils.getPackageName(basePackageClass));\n        }\n        if (packagesToScan.isEmpty()) {\n            //å¦‚æœæ²¡æœ‰é…ç½®åŸºç¡€åŒ…è·¯å¾„çš„è¯ï¼Œåˆ™å–åŒ…åä½œä¸ºåŸºç¡€åŒ…è·¯å¾„\n            return Collections.singleton(ClassUtils.getPackageName(metadata.getClassName()));\n        }\n        return packagesToScan;\n    }\n}\n```\n\n#### EnableDubboConfigæ³¨è§£\n```java\n@Target({ElementType.TYPE})\n@Retention(RetentionPolicy.RUNTIME)\n@Inherited\n@Documented\n@Import(DubboConfigConfigurationSelector.class)\npublic @interface EnableDubboConfig {\n    /**\n     * è¡¨æ˜æ˜¯å¦ç»‘å®šåˆ°å¤šä¸ªSpring-Bean,é»˜è®¤æ˜¯false\n     */\n    boolean multiple() default false;\n}\n\n/**\n * è¯¥ç±»å®ç°äº†ImportSelectoræ¥å£ï¼Œæ­¤æ¥å£æ˜¯Springä¸­å¯¼å…¥å¤–éƒ¨é…ç½®çš„æ ¸å¿ƒæ¥å£ï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥å»äº†è§£ä¸‹ï¼Œè¿™é‡Œå°±ä¸å¤šåšä»‹ç»äº†ã€‚\n * Dubbo {@link AbstractConfig Config} Registrar\n * @see EnableDubboConfig\n * @see DubboConfigConfiguration\n * @since 2.5.8\n */\npublic class DubboConfigConfigurationSelector implements ImportSelector, Ordered {\n\n    /**\n     * è¦å¯¼å…¥åˆ°Springå®¹å™¨ä¸­çš„ç»„ä»¶å…¨ç±»å\n     * @param importingClassMetadata\n     * @return\n     */\n    @Override\n    public String[] selectImports(AnnotationMetadata importingClassMetadata) {\n\n        AnnotationAttributes attributes = AnnotationAttributes.fromMap(\n                importingClassMetadata\n                        .getAnnotationAttributes(EnableDubboConfig.class.getName())\n        );\n\n        //æ˜¯å¦ç»‘å®šåˆ°å¤šä¸ªSpring-Bean\n        boolean multiple = attributes.getBoolean(\"multiple\");\n\n        if (multiple) {\n            //è¿”å›å¤šdubboé…ç½®beanç»‘å®š\n            return of(DubboConfigConfiguration.Multiple.class.getName());\n        } else {\n            return of(DubboConfigConfiguration.Single.class.getName());\n        }\n    }\n\n    private static <T> T[] of(T... values) {\n        return values;\n    }\n\n    @Override\n    public int getOrder() {\n        return HIGHEST_PRECEDENCE;\n    }\n}\n\n\npublic class DubboConfigConfiguration {\n\n    /**\n     * å•Dubboé…ç½®Beanç»‘å®š\n     * Single Dubbo {@link AbstractConfig Config} Bean Binding\n     */\n    @EnableDubboConfigBindings({\n            @EnableDubboConfigBinding(prefix = \"dubbo.application\", type = ApplicationConfig.class),\n            @EnableDubboConfigBinding(prefix = \"dubbo.module\", type = ModuleConfig.class),\n            @EnableDubboConfigBinding(prefix = \"dubbo.registry\", type = RegistryConfig.class),\n            @EnableDubboConfigBinding(prefix = \"dubbo.protocol\", type = ProtocolConfig.class),\n            @EnableDubboConfigBinding(prefix = \"dubbo.monitor\", type = MonitorConfig.class),\n            @EnableDubboConfigBinding(prefix = \"dubbo.provider\", type = ProviderConfig.class),\n            @EnableDubboConfigBinding(prefix = \"dubbo.consumer\", type = ConsumerConfig.class)\n    })\n    public static class Single {\n\n    }\n\n    /**\n     * å¤šDubboé…ç½®Beanç»‘å®š\n     * Multiple Dubbo {@link AbstractConfig Config} Bean Binding\n     */\n    @EnableDubboConfigBindings({\n            @EnableDubboConfigBinding(prefix = \"dubbo.applications\", type = ApplicationConfig.class, multiple = true),\n            @EnableDubboConfigBinding(prefix = \"dubbo.modules\", type = ModuleConfig.class, multiple = true),\n            @EnableDubboConfigBinding(prefix = \"dubbo.registries\", type = RegistryConfig.class, multiple = true),\n            @EnableDubboConfigBinding(prefix = \"dubbo.protocols\", type = ProtocolConfig.class, multiple = true),\n            @EnableDubboConfigBinding(prefix = \"dubbo.monitors\", type = MonitorConfig.class, multiple = true),\n            @EnableDubboConfigBinding(prefix = \"dubbo.providers\", type = ProviderConfig.class, multiple = true),\n            @EnableDubboConfigBinding(prefix = \"dubbo.consumers\", type = ConsumerConfig.class, multiple = true)\n    })\n    public static class Multiple {\n\n    }\n}\n```\nä½¿ç”¨æ–¹å¼:\n```java\n//å°†ä»¥ä¸‹å†…å®¹çš„å¤–éƒ¨åŒ–é…ç½®æ–‡ä»¶ç‰©ç†è·¯å¾„ä¸ºï¼šclasspath:/META-INF/multiple-config.properties:\n#å¤šDubboé…ç½®Beanç»‘å®š\n## dubbo.applications\ndubbo.applications.applicationBean.name = dubbo-demo-application\ndubbo.applications.applicationBean2.name = dubbo-demo-application2\ndubbo.applications.applicationBean3.name = dubbo-demo-application3\n\n//æ–°å»ºé…ç½®ç±»DubboMultipleConfiguration\n@EnableDubboConfig(multiple = true)\n@PropertySource(\"META-INF/multiple-config.properties\")\nprivate static class DubboMultipleConfiguration {\n\n} \n\n\n//æµ‹è¯•ç±»\npublic class DubboConfigurationBootstrap {\n\tpublic static void main(String[] args) {\n\t\t//åˆ›å»ºé…ç½®ä¸Šä¸‹æ–‡\n\t\tAnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext();\n\t\t//æ³¨å†Œå½“å‰é…ç½® Bean\n       \t\tcontext.register(DubboMultipleConfiguration.class);\n       \t\tcontext.refresh();\n\n\t\t//è·å–ApplicationConfig Beanï¼š\"applicationBean\"ã€\"applicationBean2\" å’Œ \"applicationBean3\"\n\t\tApplicationConfig applicationBean = context.getBean(\"applicationBean\", ApplicationConfig.class);\n\t\tApplicationConfig applicationBean2 = context.getBean(\"applicationBean2\", ApplicationConfig.class);\n\t\tApplicationConfig applicationBean3 = context.getBean(\"applicationBean3\", ApplicationConfig.class);\n\n\t\tSystem.out.printf(\"applicationBean.name = %s \\n\", applicationBean.getName());\n\t\tSystem.out.printf(\"applicationBean2.name = %s \\n\", applicationBean2.getName());\n\t\tSystem.out.printf(\"applicationBean3.name = %s \\n\", applicationBean3.getName());\n\t}\n}\n```\n\n#### @EnableDubboConfigBinding/@EnableDubboConfigBindingsæ³¨è§£\n@EnableDubboConfigé€‚åˆç»å¤§å¤šæ•°å¤–éƒ¨åŒ–é…ç½®åœºæ™¯,ç„¶è€Œæ— è®ºæ˜¯å•Beanç»‘å®š,è¿˜æ˜¯å¤šBeanç»‘å®š,å…¶å¤–éƒ¨åŒ–é…ç½®å±æ€§å‰ç¼€æ˜¯å›ºåŒ–çš„,å¦‚dubbo.applicationä»¥åŠdubbo.applications.\nå½“åº”ç”¨éœ€è¦è‡ªå®šä¹‰å¤–éƒ¨åŒ–é…ç½®å±æ€§å‰ç¼€,@EnableDubboConfigBindingèƒ½æä¾›æ›´å¤§çš„å¼¹æ€§ï¼Œæ”¯æŒå•ä¸ªå¤–éƒ¨åŒ–é…ç½®å±æ€§å‰ç¼€(prefix)ä¸Dubboé…ç½®Beanç±»å‹(AbstractConfigå­ç±»)ç»‘å®š,å¦‚æœéœ€è¦å¤šæ¬¡ç»‘å®šæ—¶,å¯ä½¿ç”¨@EnableDubboConfigBindings.\n@EnableDubboConfigBindingåœ¨æ”¯æŒå¤–éƒ¨åŒ–é…ç½®å±æ€§ä¸Dubboé…ç½®ç±»ç»‘å®šæ—¶,ä¸Dubboè¿‡å»çš„æ˜ å°„è¡Œä¸ºä¸åŒ,è¢«ç»‘å®šçš„Dubboé…ç½®ç±»å°†ä¼šæå‡ä¸ºSpring Bean,æ— éœ€æå‰è£…é…Dubboé…ç½®ç±».åŒæ—¶,æ”¯æŒå¤šDubboé…ç½®Beanè£…é….å…¶Beançš„ç»‘å®šè§„åˆ™ä¸@EnableDubboConfigä¸€è‡´.\n\n##### @EnableDubboConfigBindingæ³¨è§£\n\n```java\n@Target({ElementType.TYPE, ElementType.ANNOTATION_TYPE})\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\n@Import(DubboConfigBindingRegistrar.class)\npublic @interface EnableDubboConfigBinding {\n\n    /**\n     * æŒ‡å®šå¾…ç»‘å®šDubboé…ç½®ç±»çš„å¤–éƒ¨åŒ–é…ç½®å±æ€§çš„å‰ç¼€,æ¯”å¦‚dubbo.applicationä¸º ApplicationConfigçš„å¤–éƒ¨åŒ–é…ç½®å±æ€§çš„å‰ç¼€.\n     * prefix()æ”¯æŒå ä½ç¬¦(Placeholder),\n     * å¹¶ä¸”å…¶å…³è”å‰ç¼€å€¼æ˜¯å¦ä»¥\".\"ä½œä¸ºç»“å°¾å­—ç¬¦æ˜¯å¯é€‰çš„,å³\"dubbo.application\"ä¸\"dubbo.application.\"æ•ˆæœç›¸åŒ\n     * ä¾‹å¦‚ï¼š\"dubbo.application.\" æˆ– \"dubbo.application\"\n     * The name prefix of the properties that are valid to bind to {@link AbstractConfig Dubbo Config}.\n     *\n     * @return the name prefix of the properties to bind\n     */\n    String prefix();\n\n    /**\n     * ç»‘å®šçš„Dubboé…ç½®ç±»å‹,å³Dubboé…ç½®ç±»,æ‰€æœ‰AbstractConfigçš„å­ç±»éƒ½å¯ä»¥\n     * @return The binding type of {@link AbstractConfig Dubbo Config}.\n     * @see AbstractConfig\n     * @see ApplicationConfig\n     * @see ModuleConfig\n     * @see RegistryConfig\n     */\n    Class<? extends AbstractConfig> type();\n\n    /**\n     * æ˜¯å¦éœ€è¦å°†prefix()ä½œä¸ºå¤šä¸ªtype()ç±»å‹çš„Spring Beanå¤–éƒ¨åŒ–é…ç½®å±æ€§,é»˜è®¤å€¼ä¸ºfalse\n     * It indicates whether {@link #prefix()} binding to multiple Spring Beans.\n     *\n     * @return the default value is <code>false</code>\n     */\n    boolean multiple() default false;\n}\n\n\n/**\n * å®ç°äº†ImportBeanDefinitionRegistraræ¥å£ï¼Œå…è®¸æˆ‘ä»¬æ³¨å†Œç‰¹å®šçš„beanåˆ°Springä¸­\n * {@link AbstractConfig Dubbo Config} binding Bean registrar\n *\n * @see EnableDubboConfigBinding\n * @see DubboConfigBindingBeanPostProcessor\n * @since 2.5.8\n */\npublic class DubboConfigBindingRegistrar implements ImportBeanDefinitionRegistrar, EnvironmentAware {\n\n    private final Log log = LogFactory.getLog(getClass());\n\n    private ConfigurableEnvironment environment;\n\n    @Override\n    public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) {\n\n        //è·å–@EnableDubboConfigBindingæ³¨è§£\n        AnnotationAttributes attributes = AnnotationAttributes.fromMap(\n                importingClassMetadata.getAnnotationAttributes(EnableDubboConfigBinding.class.getName()));\n        //å¤„ç†@EnableDubboConfigBindingæ³¨è§£å±æ€§å¹¶æ³¨å†Œbean\n        registerBeanDefinitions(attributes, registry);\n    }\n\n    /**\n     * è¯»å–@EnableDubboConfigBindingæ³¨è§£å±æ€§å€¼ï¼Œç„¶åæ³¨å†Œbean\n     * @param attributes\n     * @param registry\n     */\n    protected void registerBeanDefinitions(AnnotationAttributes attributes, BeanDefinitionRegistry registry) {\n\n        //è·å–@EnableDubboConfigBindingæ³¨è§£çš„prefixå±æ€§ï¼Œå¹¶å¤„ç†å ä½ç¬¦\n        String prefix = environment.resolvePlaceholders(attributes.getString(\"prefix\"));\n        //è·å–@EnableDubboConfigBindingæ³¨è§£çš„typeå±æ€§\n        Class<? extends AbstractConfig> configClass = attributes.getClass(\"type\");\n        //è·å–@EnableDubboConfigBindingæ³¨è§£çš„multipleå±æ€§\n        boolean multiple = attributes.getBoolean(\"multiple\");\n        //æ³¨å†ŒDubboé…ç½®bean\n        registerDubboConfigBeans(prefix, configClass, multiple, registry);\n    }\n\n    /**\n     * æ³¨å†Œbean\n     * @param prefix å±æ€§å‰ç¼€\n     * @param configClass å¾…é…ç½®çš„configç±»\n     * @param multiple\n     * @param registry\n     */\n    private void registerDubboConfigBeans(String prefix,\n                                          Class<? extends AbstractConfig> configClass,\n                                          boolean multiple,\n                                          BeanDefinitionRegistry registry) {\n\n        /**\n         * @Configuration\n           @PropertySource(value = \"classpath:resources.properties\", ignoreResourceNotFound = false)\n           public class AppConfig { }\n         */\n        //æ ¹æ®prefixä»é…ç½®æ–‡ä»¶ä¸­æ‰¾åˆ°ç›¸å…³çš„å±æ€§å€¼\n        //å¤šbeanç»‘å®šï¼š\n        //prefix:\n        //  applications.prefix = dubbo.apps.\n        //properties:\n        //  applicationBean.name = dubbo-demo-application\n        //  applicationBean2.name = dubbo-demo-application2\n        //å•beanç»‘å®šï¼šprefix = dubbo.module.\n        //  dubbo.module.id = moduleBean  =>  id = moduleBean\n        //  dubbo.module.name = dubbo-demo-module => name = dubbo-demo-module\n        Map<String, String> properties = getSubProperties(environment.getPropertySources(), prefix);\n\n        //å¦‚æœæ²¡æœ‰é…ç½®å±æ€§çš„è¯ï¼Œåˆ™ç›´æ¥è¿”å›\n        if (CollectionUtils.isEmpty(properties)) {\n            if (log.isDebugEnabled()) {\n                log.debug(\"There is no property for binding to dubbo config class [\" + configClass.getName()\n                        + \"] within prefix [\" + prefix + \"]\");\n            }\n            return;\n        }\n\n        //è·å–beanåç§°åˆ—è¡¨(å³å¤–éƒ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®çš„)\n        Set<String> beanNames = multiple ? resolveMultipleBeanNames(properties) :\n                Collections.singleton(resolveSingleBeanName(properties, configClass, registry));\n        //éå†beanåç§°åˆ—è¡¨\n        for (String beanName : beanNames) {\n            //æœ€ç»ˆæ³¨å†Œbeançš„åœ°æ–¹\n            registerDubboConfigBean(beanName, configClass, registry);\n            //æ³¨å†ŒDubboConfigBindingBeanPostProcessorç±»\n            registerDubboConfigBindingBeanPostProcessor(prefix, beanName, multiple, registry);\n        }\n    }\n\n    /**\n     * ä½¿ç”¨beanNameæ³¨å†Œbeanï¼šconfigClass\n     * @param beanName\n     * @param configClass é…ç½®ç±»\n     * @param registry\n     */\n    private void registerDubboConfigBean(String beanName, Class<? extends AbstractConfig> configClass,\n                                         BeanDefinitionRegistry registry) {\n\n        BeanDefinitionBuilder builder = rootBeanDefinition(configClass);\n        AbstractBeanDefinition beanDefinition = builder.getBeanDefinition();\n        //ä½¿ç”¨beanNameæ³¨å†Œbeanï¼šconfigClass\n        registry.registerBeanDefinition(beanName, beanDefinition);\n        if (log.isInfoEnabled()) {\n            log.info(\"The dubbo config bean definition [name : \" + beanName + \", class : \" + configClass.getName() +\n                    \"] has been registered.\");\n        }\n    }\n\n    /**\n     * æ³¨å†ŒDubboConfigBindingBeanPostProcessorç±»\n     * ç”¨æ¥å¤„ç†dubbo config bean\n     * @param prefix  å±æ€§å‰ç¼€\n     * @param beanName å·²æ³¨å†Œçš„configé…ç½®ç±»çš„beanName\n     * @param multiple \n     * @param registry\n     */\n    private void registerDubboConfigBindingBeanPostProcessor(String prefix, String beanName, boolean multiple,\n                                                             BeanDefinitionRegistry registry) {\n\n        Class<?> processorClass = DubboConfigBindingBeanPostProcessor.class;\n        \n        BeanDefinitionBuilder builder = rootBeanDefinition(processorClass);\n        \n        //å¦‚æœæ˜¯multipleçš„è¯ï¼Œåˆ™æœ€ç»ˆå‰ç¼€ï¼šprefix+\".\"+beanName\n        //å¦åˆ™çš„è¯ï¼Œæœ€ç»ˆå‰ç¼€ï¼šprefix\n        String actualPrefix = multiple ? normalizePrefix(prefix) + beanName : prefix;\n        \n        //é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥å±æ€§ï¼šprefixã€beanName\n        builder.addConstructorArgValue(actualPrefix).addConstructorArgValue(beanName);\n        //è·å–beanDefinition\n        AbstractBeanDefinition beanDefinition = builder.getBeanDefinition();\n        //è®¾ç½®ä¸å¯ä»£ç†\n        beanDefinition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);\n        //æ³¨å†ŒDubboConfigBindingBeanPostProcessor\n        registerWithGeneratedName(beanDefinition, registry);\n\n        if (log.isInfoEnabled()) {\n            log.info(\"The BeanPostProcessor bean definition [\" + processorClass.getName()\n                    + \"] for dubbo config bean [name : \" + beanName + \"] has been registered.\");\n        }\n    }\n\n    @Override\n    public void setEnvironment(Environment environment) {\n        Assert.isInstanceOf(ConfigurableEnvironment.class, environment);\n        this.environment = (ConfigurableEnvironment) environment;\n    }\n\n    /**\n     * å¤„ç†å¤šä¸ªbeanåç§°\n     * @param properties å¦‚ï¼š\n     *          applicationBean.name = dubbo-demo-application\n     *          applicationBean2.name = dubbo-demo-application2\n     * @return applicationBeanã€applicationBean2\n     */\n    private Set<String> resolveMultipleBeanNames(Map<String, String> properties) {\n        //ä¿å­˜å·²è§£å†³çš„beanNames\n        Set<String> beanNames = new LinkedHashSet<String>();\n        //éå†æ‰€æœ‰çš„å±æ€§åï¼šapplicationBean.nameã€applicationBean2.name\n        for (String propertyName : properties.keySet()) {\n            //è·å–\".\"ç¬¦å·åœ¨å±æ€§åä¸­ç¬¬ä¸€æ¬¡å‡ºç°çš„ä½ç½®\n            //å³åˆ¤æ–­æ˜¯å¦å­˜åœ¨\".\"\n            int index = propertyName.indexOf(\".\");\n            if (index > 0) {\n                //è·å–beanåç§°ï¼šapplicationBeanã€applicationBean2\n                String beanName = propertyName.substring(0, index);\n                //ä¿å­˜beanåç§°\n                beanNames.add(beanName);\n            }\n        }\n        return beanNames;\n    }\n\n    /**\n     * å¤„ç†å•ä¸ªbeanåç§°\n     * @param properties å¦‚ï¼š\n     *      dubbo.module.id = moduleBean  =>  id = moduleBean\n     *      dubbo.module.name = dubbo-demo-module => name = dubbo-demo-module\n     * @param configClass dubboé…ç½®ç±»\n     * @param registry\n     * @return\n     */\n    private String resolveSingleBeanName(Map<String, String> properties,\n                                         Class<? extends AbstractConfig> configClass,\n                                         BeanDefinitionRegistry registry) {\n        //è·å–idå±æ€§ä½œä¸ºbeançš„åç§°\n        String beanName = properties.get(\"id\");\n        if (!StringUtils.hasText(beanName)) {\n            //idå±æ€§ä¸ºç©ºçš„è¯\n            BeanDefinitionBuilder builder = rootBeanDefinition(configClass);\n            //åˆ™ä½¿ç”¨å·¥å…·ç±»ç”Ÿæˆbeanåç§°\n            beanName = BeanDefinitionReaderUtils.generateBeanName(\n                    builder.getRawBeanDefinition(), registry\n            );\n        }\n        return beanName;\n    }\n}\n```\nå¯ä»¥çœ‹åˆ°ï¼Œä¸ºæ¯ä¸ªæ³¨å†Œçš„Config-beanéƒ½æ³¨å†Œäº†ä¸€ä¸ªDubboConfigBindingBeanPostProcessorç±»ï¼Œç°åœ¨æˆ‘ä»¬çœ‹ä¸‹DubboConfigBindingBeanPostProcessorç±»ï¼Œè¯¥ç±»å®ç°äº†BeanPostProcessoræ¥å£,\nå®ç°è¯¥æ¥å£ï¼Œå¯ä»¥åœ¨beanå®ä¾‹åŒ–å‰åï¼Œå¢åŠ ä¸€äº›è‡ªå·±çš„é€»è¾‘å¤„ç†ï¼ŒåŒæ—¶ä¹Ÿå®ç°äº†InitializingBeanæ¥å£.\n```java\n/**\n * Dubbo Config Binding {@link BeanPostProcessor}\n *\n * @see EnableDubboConfigBinding\n * @see DubboConfigBindingRegistrar\n * @since 2.5.8\n */\npublic class DubboConfigBindingBeanPostProcessor implements BeanPostProcessor, ApplicationContextAware, InitializingBean {\n\n    /**\n     * é…ç½®å±æ€§çš„å‰ç¼€\n     */\n    private final String prefix;\n\n    /**\n     * ç»‘å®šçš„Configé…ç½®ç±»çš„beanName\n     */\n    private final String beanName;\n\n    private DubboConfigBinder dubboConfigBinder;\n\n    private ApplicationContext applicationContext;\n\n    /**\n     * æ˜¯å¦å¿½ç•¥æœªçŸ¥å­—æ®µ\n     */\n    private boolean ignoreUnknownFields = true;\n\n    /**\n     * æ˜¯å¦å¿½ç•¥æ— æ•ˆå­—æ®µ\n     */\n    private boolean ignoreInvalidFields = true;\n\n    /**\n     * @param prefix   é…ç½®å±æ€§çš„å‰ç¼€\n     * @param beanName ç»‘å®šçš„Configé…ç½®ç±»çš„beanName\n     */\n    public DubboConfigBindingBeanPostProcessor(String prefix, String beanName) {\n        Assert.notNull(prefix, \"The prefix of Configuration Properties must not be null\");\n        Assert.notNull(beanName, \"The name of bean must not be null\");\n        this.prefix = prefix;\n        this.beanName = beanName;\n    }\n\n    @Override\n    public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException {\n        //å¦‚æœå½“å‰å®ä¾‹åŒ–çš„beançš„beanNameå’Œè¯¥å¤„ç†å™¨ä¿å­˜çš„beanNameç›¸åŒçš„è¯,è¯´æ˜æ˜¯è¯¥å®ä¾‹åŒ–beanå¯¹åº”çš„å¤„ç†å™¨\n        //è¿™ä¸ªåœ¨ä¹‹å‰ä»‹ç»DubboConfigBindingRegistrarç±»æ—¶æœ‰ä»‹ç»\n        if (beanName.equals(this.beanName) && bean instanceof AbstractConfig) {\n            AbstractConfig dubboConfig = (AbstractConfig) bean;\n            //é€šè¿‡prefixç»‘å®šbeanNameçš„å±æ€§\n            dubboConfigBinder.bind(prefix, dubboConfig);\n            if (log.isInfoEnabled()) {\n                log.info(\"The properties of bean [name : \" + beanName + \"] have been binding by prefix of \" +\n                        \"configuration properties : \" + prefix);\n            }\n        }\n        return bean;\n    }\n\n    @Override\n    public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {\n        return bean;\n    }\n\n    @Override\n    public void afterPropertiesSet() throws Exception {\n        if (dubboConfigBinder == null) {\n            try {\n                //å…ˆä»BeanFactoryä¸­è·å–DubboConfigBinderå®ä¾‹\n                dubboConfigBinder = applicationContext.getBean(DubboConfigBinder.class);\n            } catch (BeansException ignored) {\n                if (log.isDebugEnabled()) {\n                    log.debug(\"DubboConfigBinder Bean can't be found in ApplicationContext.\");\n                }\n                //ä½¿ç”¨é»˜è®¤å®ç°\n                dubboConfigBinder = createDubboConfigBinder(applicationContext.getEnvironment());\n            }\n        }\n        //è®¾ç½®æ˜¯å¦å¿½ç•¥æœªçŸ¥å­—æ®µã€æ— æ•ˆå­—æ®µ\n        dubboConfigBinder.setIgnoreUnknownFields(ignoreUnknownFields);\n        dubboConfigBinder.setIgnoreInvalidFields(ignoreInvalidFields);\n    }\n\n    /**\n     * åˆ›å»ºDubboConfigBinderå®ä¾‹(é»˜è®¤å®ç°)\n     * @param environment\n     * @return {@link DefaultDubboConfigBinder}\n     */\n    protected DubboConfigBinder createDubboConfigBinder(Environment environment) {\n        DefaultDubboConfigBinder defaultDubboConfigBinder = new DefaultDubboConfigBinder();\n        defaultDubboConfigBinder.setEnvironment(environment);\n        return defaultDubboConfigBinder;\n    }\n\n    @Override\n    public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {\n        this.applicationContext = applicationContext;\n    }\n}\n```\nç„¶åæˆ‘ä»¬çœ‹ä¸‹ä½¿ç”¨åˆ°çš„DubboConfigBinderæ¥å£\n```java\npublic interface DubboConfigBinder extends EnvironmentAware {\n    /**\n     * è®¾ç½®æ˜¯å¦å¿½ç•¥æœªçŸ¥å­—æ®µï¼Œå³æ˜¯å¦å¿½ç•¥åœ¨ç›®æ ‡å¯¹è±¡ä¸­æ²¡æœ‰ç›¸åº”å­—æ®µçš„ç»‘å®šå‚æ•°ã€‚é»˜è®¤å€¼æ˜¯â€œtrueâ€\n     * è®¾ç½®ä¸ºfalseï¼Œå¯ä»¥å¼ºåˆ¶æ‰€æœ‰çš„ç»‘å®šçš„å‚æ•°åœ¨ç›®æ ‡å¯¹è±¡ä¸­å¿…é¡»æœ‰ä¸€ä¸ªç›¸åº”çš„å­—æ®µ\n     *\n     * Set whether to ignore unknown fields, that is, whether to ignore bind\n     * parameters that do not have corresponding fields in the target object.\n     * <p>Default is \"true\". Turn this off to enforce that all bind parameters\n     * must have a matching field in the target object.\n     * @see #bind\n     */\n    void setIgnoreUnknownFields(boolean ignoreUnknownFields);\n\n    /**\n     * æ˜¯å¦å¿½ç•¥æ— æ•ˆå­—æ®µï¼Œå³æ˜¯å¦å¿½ç•¥åœ¨ç›®æ ‡å¯¹è±¡ä¸­å­˜åœ¨ç›¸åº”å­—æ®µï¼Œä½†æ˜¯ä¸å¯è®¿é—®çš„ç»‘å®šå‚æ•°\n     * é»˜è®¤ä¸ºâ€œfalseâ€\n     * Set whether to ignore invalid fields, that is, whether to ignore bind\n     * parameters that have corresponding fields in the target object which are\n     * not accessible (for example because of null values in the nested path).\n     * <p>Default is \"false\".\n     *\n     * @see #bind\n     */\n    void setIgnoreInvalidFields(boolean ignoreInvalidFields);\n\n    /**\n     * ä»¥æŒ‡å®šçš„å‰ç¼€ç»‘å®šç›¸å…³å±æ€§åˆ°Dubboé…ç½®å¯¹è±¡ä¸­\n     * Bind the properties to Dubbo Config Object under specified prefix.\n     *\n     * @param prefix å±æ€§å‰ç¼€\n     * @param dubboConfig dubboConfigé…ç½®ç±»å®ä¾‹\n     */\n    <C extends AbstractConfig> void bind(String prefix, C dubboConfig);\n}\n\n//æŠ½è±¡ç±»\npublic abstract class AbstractDubboConfigBinder implements DubboConfigBinder {\n\n    /**\n     * å±æ€§é…ç½®\n     */\n    private Iterable<PropertySource<?>> propertySources;\n\n    private boolean ignoreUnknownFields = true;\n\n    private boolean ignoreInvalidFields = false;\n\n    /**\n     * è·å–å¤šä¸ªPropertySource\n     */\n    protected Iterable<PropertySource<?>> getPropertySources() {\n        return propertySources;\n    }\n\n    public boolean isIgnoreUnknownFields() {\n        return ignoreUnknownFields;\n    }\n\n    @Override\n    public void setIgnoreUnknownFields(boolean ignoreUnknownFields) {\n        this.ignoreUnknownFields = ignoreUnknownFields;\n    }\n\n    public boolean isIgnoreInvalidFields() {\n        return ignoreInvalidFields;\n    }\n\n    @Override\n    public void setIgnoreInvalidFields(boolean ignoreInvalidFields) {\n        this.ignoreInvalidFields = ignoreInvalidFields;\n    }\n\n    @Override\n    public final void setEnvironment(Environment environment) {\n        if (environment instanceof ConfigurableEnvironment) {\n            //ä»environmentä¸­è·å–propertySources\n            this.propertySources = ((ConfigurableEnvironment) environment).getPropertySources();\n        }\n    }\n}\n\n\n/**\n * é»˜è®¤å®ç° åŸºäºSpringçš„DataBinder\n */\npublic class DefaultDubboConfigBinder extends AbstractDubboConfigBinder {\n\n    @Override\n    public <C extends AbstractConfig> void bind(String prefix, C dubboConfig) {\n        //åˆ›å»ºDataBinderå®ä¾‹ï¼Œç»‘å®šdubboConfigé…ç½®ç±»\n        DataBinder dataBinder = new DataBinder(dubboConfig);\n        // Set ignored*\n        //è®¾ç½®æ˜¯å¦å¿½ç•¥æ— æ•ˆå­—æ®µã€æœªçŸ¥å­—æ®µ\n        dataBinder.setIgnoreInvalidFields(isIgnoreInvalidFields());\n        dataBinder.setIgnoreUnknownFields(isIgnoreUnknownFields());\n        //ä»PropertySourcesä¸­è·å–æŒ‡å®šå‰ç¼€çš„å±æ€§\n        Map<String, String> properties = getSubProperties(getPropertySources(), prefix);\n        //å°†Mapè½¬æ¢æˆMutablePropertyValueså¯¹è±¡\n        MutablePropertyValues propertyValues = new MutablePropertyValues(properties);\n        // è¿›è¡Œç»‘å®š\n        dataBinder.bind(propertyValues);\n    }\n}\n```\nç„¶åçœ‹ä¸‹å·¥å…·ç±»PropertySourcesUtilsä¸­çš„getSubPropertiesæ–¹æ³•ï¼š\n```java\n/**\n * æ ¹æ®å±æ€§å‰ç¼€ï¼Œè·å–æ‰€æœ‰ç›¸å…³çš„å±æ€§å’Œå±æ€§å€¼\n * Get Sub {@link Properties}\n * @param propertySources {@link PropertySource} Iterable\n * @param prefix          the prefix of property name\n * @return Map<String,String>\n * @see Properties\n*/\npublic static Map<String, String> getSubProperties(Iterable<PropertySource<?>> propertySources, String prefix) {\n\tMap<String, String> subProperties = new LinkedHashMap<String, String>();\n\t//è§„èŒƒåŒ–å‰ç¼€,å³å‰ç¼€ç»“å°¾å¤„è¡¥ä¸Š\".\"ç¬¦å·\n\tString normalizedPrefix = normalizePrefix(prefix);\n\t//éå†æ¯ä¸€ä¸ªPropertySource\n\tfor (PropertySource<?> source : propertySources) {\n\t    if (source instanceof EnumerablePropertySource) {\n\t\t//éå†å±æ€§åç§°åˆ—è¡¨ï¼Œæ‰¾åˆ°ä»¥normalizedPrefixå¼€å¤´çš„å±æ€§åç§°\n\t\t//applications.prefix = dubbo.apps.\n\t\t//dubbo.apps.applicationBean.name = dubbo-demo-application\n\t\t//dubbo.apps.applicationBean2.name = dubbo-demo-application2\n\n\t\tfor (String name : ((EnumerablePropertySource<?>) source).getPropertyNames()) {\n\t\t    if (name.startsWith(normalizedPrefix)) {\n\t\t\t//æˆªå–å­åç§°ï¼Œå¦‚ï¼šsubName = applicationBean.name/applicationBean2.name\n\t\t\tString subName = name.substring(normalizedPrefix.length());\n\t\t\t//æ›´åŠ å±æ€§åç§°nameè·å–å±æ€§å€¼value\n\t\t\tObject value = source.getProperty(name);\n\t\t\t//ä¿å­˜applicationBean.name = dubbo-demo-application\n\t\t\t//ä¿å­˜applicationBean2.name = dubbo-demo-application2\n\t\t\tsubProperties.put(subName, String.valueOf(value));\n\t\t    }\n\t\t}\n\t    }\n\t}\n\treturn subProperties;\n}\n```\n\n##### @EnableDubboConfigBindingsæ³¨è§£\nè¯¥æ³¨è§£æ”¯æŒé…ç½®å¤šä¸ª@EnableDubboConfigBindingæ³¨è§£\n```java\n@Target({ElementType.TYPE})\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\n@Import(DubboConfigBindingsRegistrar.class)\npublic @interface EnableDubboConfigBindings {\n    /**\n     * The value of {@link EnableDubboConfigBindings}\n     * @return non-null\n     */\n    EnableDubboConfigBinding[] value();\n}\n\n\npublic class DubboConfigBindingsRegistrar implements ImportBeanDefinitionRegistrar, EnvironmentAware {\n\n    private ConfigurableEnvironment environment;\n\n    @Override\n    public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) {\n\n        //è·å–@EnableDubboConfigBindingsæ³¨è§£çš„å±æ€§å€¼\n        AnnotationAttributes attributes = AnnotationAttributes.fromMap(\n                importingClassMetadata.getAnnotationAttributes(EnableDubboConfigBindings.class.getName()));\n\n        AnnotationAttributes[] annotationAttributes = attributes.getAnnotationArray(\"value\");\n\n        //æ„é€ DubboConfigBindingRegistrarå¯¹è±¡\n        DubboConfigBindingRegistrar registrar = new DubboConfigBindingRegistrar();\n        registrar.setEnvironment(environment);\n        //éå†@EnableDubboConfigBindingåˆ—è¡¨,å¤„ç†æ¯ä¸€ä¸ª@EnableDubboConfigBindingæ³¨è§£\n        for (AnnotationAttributes element : annotationAttributes) {\n            //æ³¨å†ŒDubboConfigBindingRegistrarç±»\n            registrar.registerBeanDefinitions(element, registry);\n        }\n    }\n\n    @Override\n    public void setEnvironment(Environment environment) {\n        Assert.isInstanceOf(ConfigurableEnvironment.class, environment);\n        this.environment = (ConfigurableEnvironment) environment;\n    }\n}\n```\nç®€å•çœ‹ä¸‹ä½¿ç”¨:\n```java\n//å°†ä»¥ä¸‹å†…å®¹çš„å¤–éƒ¨åŒ–é…ç½®æ–‡ä»¶ç‰©ç†è·¯å¾„ä¸ºï¼šclasspath:/META-INF/bindings.properties\n# classpath:/META-INF/bindings.properties\n## å ä½ç¬¦å€¼ : ApplicationConfig å¤–éƒ¨é…ç½®å±æ€§å‰ç¼€\napplications.prefix = dubbo.apps.\n\n## å¤š ApplicationConfig Bean ç»‘å®š\ndubbo.apps.applicationBean.name = dubbo-demo-application\ndubbo.apps.applicationBean2.name = dubbo-demo-application2\ndubbo.apps.applicationBean3.name = dubbo-demo-application3\n\n## å• ModuleConfig Bean ç»‘å®š\ndubbo.module.id = moduleBean\ndubbo.module.name = dubbo-demo-module\n\n## å• RegistryConfig Bean ç»‘å®š\ndubbo.registry.address = zookeeper://192.168.99.100:32770\n\n\n/**\n * æ–°å»ºä¸€ä¸ªDubboConfigurationç±»ä½œä¸ºDubboé…ç½®Beanï¼Œæ·»åŠ @EnableDubboConfigBindingæ³¨è§£è¿›è¡Œç»‘å®š\n * ç„¶åé…ç½®@PropertySourceæ³¨è§£æŒ‡å®šå¤–éƒ¨é…ç½®æ–‡ä»¶\n */\n@EnableDubboConfigBindings({\n@EnableDubboConfigBinding(prefix = \"${applications.prefix}\",\n               type = ApplicationConfig.class, multiple = true), //å¤šApplicationConfig Beanç»‘å®š\n@EnableDubboConfigBinding(prefix = \"dubbo.module\", //ä¸å¸¦\".\"åç¼€\n               type = ModuleConfig.class), //å•ModuleConfig Beanç»‘å®š\n@EnableDubboConfigBinding(prefix = \"dubbo.registry.\", //å¸¦\".\"åç¼€\n               type = RegistryConfig.class) //å•RegistryConfig Beanç»‘å®š\n})\n@PropertySource(\"META-INF/bindings.properties\")\n@Configuration\npublic class DubboConfiguration {\n\n}\n\n//æ–°å»ºæµ‹è¯•ç±»\npublic class DubboConfigurationBootstrap {\n\n\tpublic static void main(String[] args) {\n\t\t//åˆ›å»ºé…ç½®ä¸Šä¸‹æ–‡\n\t\tAnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext();\n\t\t//æ³¨å†Œå½“å‰é…ç½® Bean\n\t\tcontext.register(DubboConfiguration.class);\n\t\tcontext.refresh();\n\n\t\t//è·å–ApplicationConfig Beanï¼š\"applicationBean\"ã€\"applicationBean2\" å’Œ \"applicationBean3\"\n\t\tApplicationConfig applicationBean = context.getBean(\"applicationBean\", ApplicationConfig.class);\n\t\tApplicationConfig applicationBean2 = context.getBean(\"applicationBean2\", ApplicationConfig.class);\n\t\tApplicationConfig applicationBean3 = context.getBean(\"applicationBean3\", ApplicationConfig.class);\n\t\t\n\t\t//applicationBean.name = dubbo-demo-application \n\t\t//applicationBean2.name = dubbo-demo-application2 \n\t\tcapplicationBean3.name = dubbo-demo-application3 \n\t\tSystem.out.printf(\"applicationBean.name = %s \\n\", applicationBean.getName());\n\t\tSystem.out.printf(\"applicationBean2.name = %s \\n\", applicationBean2.getName());\n\t\tSystem.out.printf(\"applicationBean3.name = %s \\n\", applicationBean3.getName());\n\n\t\t//è·å–ModuleConfig Beanï¼š\"moduleBean\"\n\t\tModuleConfig moduleBean = context.getBean(\"moduleBean\", ModuleConfig.class);\n\t\t//moduleBean.name = dubbo-demo-module \n\t\tSystem.out.printf(\"moduleBean.name = %s \\n\", moduleBean.getName()); \n\n\t\t//è·å–RegistryConfig Bean\n\t\tRegistryConfig registry = context.getBean(RegistryConfig.class);\n\t\t//registry.address = zookeeper://192.168.99.100:32770 \n\t\tSystem.out.printf(\"registry.address = %s \\n\", registry.getAddress());\n\t}\n}\n```\n\n#### @EnableDubboæ³¨è§£\nè¯¥æ³¨è§£ç­‰åŒäºç»„åˆä½¿ç”¨@DubboComponentScanå’Œ@EnableDubboConfigï¼Œä¸Šæ–‡å·²ç»ä»‹ç»è¿‡ï¼Œè¿™é‡Œå°±ä¸å¤šä»‹ç»äº†ã€‚\n```java\n/**\n * å¯ç”¨Dubboç»„ä»¶ä½œä¸ºSpringBean\n * ç­‰åŒäºç»„åˆä½¿ç”¨@DubboComponentScanå’Œ@EnableDubboConfig\n */\n@Target({ElementType.TYPE})\n@Retention(RetentionPolicy.RUNTIME)\n@Inherited\n@Documented\n@EnableDubboConfig\n@DubboComponentScan\npublic @interface EnableDubbo {\n\n    /**\n     * æ‰«æ@ServiceåŸºç¡€åŒ…è·¯å¾„\n     * Base packages to scan for annotated @Service classes.\n     * <p>\n     * Use {@link #scanBasePackageClasses()} for a type-safe alternative to String-based\n     * package names.\n     *\n     * @return the base packages to scan\n     * @see DubboComponentScan#basePackages()\n     */\n    @AliasFor(annotation = DubboComponentScan.class, attribute = \"basePackages\")\n    String[] scanBasePackages() default {};\n\n    /**\n     * Type-safe alternative to {@link #scanBasePackages()} for specifying the packages to\n     * scan for annotated @Service classes. The package of each class specified will be\n     * scanned.\n     *\n     * @return classes from the base packages to scan\n     * @see DubboComponentScan#basePackageClasses\n     */\n    @AliasFor(annotation = DubboComponentScan.class, attribute = \"basePackageClasses\")\n    Class<?>[] scanBasePackageClasses() default {};\n\n\n    /**\n     *\n     * It indicates whether {@link AbstractConfig} binding to multiple Spring Beans.\n     *\n     * @return the default value is <code>false</code>\n     * @see EnableDubboConfig#multiple()\n     */\n    @AliasFor(annotation = EnableDubboConfig.class, attribute = \"multiple\")\n    boolean multipleConfig() default false;\n}\n```\n\n","tags":["dubbo"]},{"title":"Dubboæºç é˜…è¯»ä¹‹é›†æˆSpringæ³¨è§£è§£æ(0202)","url":"/blog/2018/08/07/Dubboæºç é˜…è¯»ä¹‹é›†æˆSpring-0202æ³¨è§£è§£æ/","content":">æœ¬å°èŠ‚å°†ä¼šä»‹ç»ReferenceAnnotationBeanPostProcessorç±»çš„å®ç°\n\n### ReferenceAnnotationBeanPostProcessorç±»\nè¯¥ç±»ç”¨æ¥å¤„ç†@Referenceæ³¨è§£ï¼Œå®ƒå®ç°äº†BeanPostProcessoræ¥å£,å®ç°postProcessPropertyValuesæ–¹æ³•å¯ä»¥å¤„ç†æ¯ä¸€ä¸ªå±æ€§\n```java\npublic class ReferenceAnnotationBeanPostProcessor extends InstantiationAwareBeanPostProcessorAdapter\n        implements MergedBeanDefinitionPostProcessor, PriorityOrdered, ApplicationContextAware,BeanClassLoaderAware, DisposableBean {\n\n    /**\n     * ReferenceAnnotationBeanPostProcessorçš„bean-name\n     */\n    public static final String BEAN_NAME = \"referenceAnnotationBeanPostProcessor\";\n\n    private ApplicationContext applicationContext;\n\n    private ClassLoader classLoader;\n\n    /**\n     * beanName/className,ReferenceInjectionMetadata\n     */\n    private final ConcurrentMap<String, ReferenceInjectionMetadata> injectionMetadataCache =\n            new ConcurrentHashMap<String, ReferenceInjectionMetadata>(256);\n\n    /**\n     * cacheKey,referenceBean\n     */\n    private final ConcurrentMap<String, ReferenceBean<?>> referenceBeansCache =\n            new ConcurrentHashMap<String, ReferenceBean<?>>();\n\n    /**\n     * è®¾ç½®æŸä¸ªå±æ€§æ—¶è°ƒç”¨\n     * @param pvs\n     * @param pds\n     * @param bean\n     * @param beanName\n     * @return\n     * @throws BeanCreationException\n     */\n    @Override\n    public PropertyValues postProcessPropertyValues(\n            PropertyValues pvs, PropertyDescriptor[] pds, Object bean, String beanName) throws BeanCreationException {\n        //è·å–beançš„@Referenceå…ƒæ•°æ®ä¿¡æ¯\n        InjectionMetadata metadata = findReferenceMetadata(beanName, bean.getClass(), pvs);\n        try {\n            //å¯¹Beançš„å±æ€§è¿›è¡Œè‡ªåŠ¨æ³¨å…¥\n            //æœ€ç»ˆä¼šè°ƒç”¨å†…éƒ¨ç±»ReferenceFieldElementå’ŒReferenceMethodElementçš„injectæ–¹æ³•(åé¢ä¼šä»‹ç»)\n            metadata.inject(bean, beanName, pvs);\n        } catch (BeanCreationException ex) {\n            throw ex;\n        } catch (Throwable ex) {\n            throw new BeanCreationException(beanName, \"Injection of @Reference dependencies failed\", ex);\n        }\n        return pvs;\n    }\n\n    /**\n     * è·å–clazzçš„@Referenceå…ƒæ•°æ®ä¿¡æ¯\n     * @param beanName å½“å‰beançš„åç§°\n     * @param clazz    å½“å‰beançš„class\n     * @param pvs      å½“å‰beançš„å±æ€§\n     * @return\n     */\n    private InjectionMetadata findReferenceMetadata(String beanName, Class<?> clazz, PropertyValues pvs) {\n        // Fall back to class name as cache key, for backwards compatibility with custom callers.\n        //ä½¿ç”¨beanNameæˆ–è€…å½“å‰beançš„ç±»åç§°ä½œä¸ºcacheKey\n        String cacheKey = (StringUtils.hasLength(beanName) ? beanName : clazz.getName());\n        // å…ˆä»ç¼“å­˜ä¸­æŸ¥è¯¢è¯¥cacheKey\n        ReferenceInjectionMetadata metadata = this.injectionMetadataCache.get(cacheKey);\n        //æ˜¯å¦éœ€è¦åˆ·æ–°(metadata == null || metadata.targetClass != clazz;åˆ™éœ€è¦åˆ·æ–°)\n        if (InjectionMetadata.needsRefresh(metadata, clazz)) {\n            synchronized (this.injectionMetadataCache) {\n                metadata = this.injectionMetadataCache.get(cacheKey);\n                if (InjectionMetadata.needsRefresh(metadata, clazz)) {\n                    if (metadata != null) {\n                        metadata.clear(pvs);\n                    }\n                    try {\n                        //è·å–clazzä¸­è¢«@Referenceæ³¨è§£æ ‡æ³¨çš„å…ƒæ•°æ®ä¿¡æ¯(å­—æ®µã€æ–¹æ³•)\n                        metadata = buildReferenceMetadata(clazz);\n                        //æ”¾å…¥ç¼“å­˜\n                        this.injectionMetadataCache.put(cacheKey, metadata);\n                    } catch (NoClassDefFoundError err) {\n                        throw new IllegalStateException(\"Failed to introspect bean class [\" + clazz.getName() +\n                                \"] for reference metadata: could not find class that it depends on\", err);\n                    }\n                }\n            }\n        }\n        return metadata;\n    }\n\n    /**\n     * è·å–beanClassç±»ä¸­è¢«@Referenceæ³¨è§£æ ‡æ³¨çš„æ–¹æ³•å’Œå­—æ®µ\n     * @param beanClass\n     * @return\n     */\n    private ReferenceInjectionMetadata buildReferenceMetadata(final Class<?> beanClass) {\n        //æŸ¥åˆ°beanClassä¸­å­˜åœ¨@Referenceæ³¨è§£çš„å­—æ®µ\n        Collection<ReferenceFieldElement> fieldElements = findFieldReferenceMetadata(beanClass);\n        //æŸ¥åˆ°beanClassä¸­å­˜åœ¨@Referenceæ³¨è§£çš„æ–¹æ³•\n        Collection<ReferenceMethodElement> methodElements = findMethodReferenceMetadata(beanClass);\n        //åˆ›å»ºæ–°çš„å…ƒæ•°æ®ä¿¡æ¯\n        return new ReferenceInjectionMetadata(beanClass, fieldElements, methodElements);\n    }\n\n\n    /**\n     * ä»ç»™å®šçš„ç±»ä¸­æŸ¥è¯¢åˆ°æ‰€æœ‰æ ‡æ³¨@Referenceæ³¨è§£çš„å­—æ®µ\n     * ç„¶åæ ¹æ®è¯¥å­—æ®µå’Œ@Referenceæ³¨è§£\n     * åˆ›å»ºReferenceFieldElementç±»(InjectionMetadata.InjectedElementçš„å­ç±»)\n     * @param beanClass å½“å‰beançš„class\n     * @return non-null\n     */\n    private List<ReferenceFieldElement> findFieldReferenceMetadata(final Class<?> beanClass) {\n\n        final List<ReferenceFieldElement> elements = new LinkedList<ReferenceFieldElement>();\n        //æ“ä½œå­—æ®µæ—¶æ‰§è¡Œçš„å›è°ƒ\n        ReflectionUtils.doWithFields(beanClass, new ReflectionUtils.FieldCallback() {\n            @Override\n            public void doWith(Field field) throws IllegalArgumentException, IllegalAccessException {\n                //è·å–å­—æ®µä¸Šçš„@Referenceæ³¨è§£\n                Reference reference = getAnnotation(field, Reference.class);\n                //æ˜¯å¦å­˜åœ¨@Referenceæ³¨è§£\n                if (reference != null) {\n                    if (Modifier.isStatic(field.getModifiers())) {\n                        if (logger.isWarnEnabled()) {\n                            //@Referenceä¸æ”¯æŒé™æ€å­—æ®µå­—æ®µ\n                            logger.warn(\"@Reference annotation is not supported on static fields: \" + field);\n                        }\n                        return;\n                    }\n                    //æ ¹æ®å­—æ®µå’Œ@Referenceæ³¨è§£åˆ›å»ºReferenceFieldElementå¯¹è±¡,å¹¶ä¿å­˜\n                    elements.add(new ReferenceFieldElement(field, reference));\n                }\n            }\n        });\n        return elements;\n    }\n\n    /**\n     * ä»æ ‡æ³¨@Referenceæ³¨è§£çš„æ–¹æ³•ä¸Šæ‰¾åˆ°ï¼ˆInjectionMetadata.InjectedElementï¼‰å…ƒæ•°æ®\n     * @param beanClass ç›®æ ‡beançš„class\n     * @return non-null {@link List}\n     */\n    private List<ReferenceMethodElement> findMethodReferenceMetadata(final Class<?> beanClass) {\n\n        final List<ReferenceMethodElement> elements = new LinkedList<ReferenceMethodElement>();\n\n        //æ“ä½œæ–¹æ³•æ—¶è°ƒç”¨\n        ReflectionUtils.doWithMethods(beanClass, new ReflectionUtils.MethodCallback() {\n            @Override\n            public void doWith(Method method) throws IllegalArgumentException, IllegalAccessException {\n\n                //è·å–æ¡¥æ¥æ–¹æ³•(https://blog.csdn.net/mhmyqn/article/details/47342577)\n                Method bridgedMethod = findBridgedMethod(method);\n\n                //å‚æ•°å’Œè¿”å›ç±»å‹ç­¾åç›¸åŒè¿”å›true\n                if (!isVisibilityBridgeMethodPair(method, bridgedMethod)) {\n                    return;\n                }\n                //ä»æ¡¥æ¥æ–¹æ³•ä¸Šæ‰¾åˆ°@Referenceæ³¨è§£\n                Reference reference = findAnnotation(bridgedMethod, Reference.class);\n\n                //ClassUtils.getMostSpecificMethod\n                //é€šè¿‡ç»™å®šçš„æ–¹æ³•(å¯èƒ½æ¥è‡ªæ¥å£)å’Œå½“å‰åå°„è°ƒç”¨ä¸­ä½¿ç”¨çš„ç›®æ ‡ç±»,æ‰¾åˆ°ç›¸åº”çš„ç›®æ ‡æ–¹æ³•\n                if (reference != null && method.equals(ClassUtils.getMostSpecificMethod(method, beanClass))) {\n                    if (Modifier.isStatic(method.getModifiers())) {\n                        if (logger.isWarnEnabled()) {\n                            //@Referenceä¸æ”¯æŒstaticæ–¹æ³•\n                            logger.warn(\"@Reference annotation is not supported on static methods: \" + method);\n                        }\n                        return;\n                    }\n                    if (method.getParameterTypes().length == 0) {\n                        //@Referenceæ³¨è§£åªèƒ½ç”¨äºå¸¦å‚æ•°çš„æ–¹æ³•\n                        if (logger.isWarnEnabled()) {\n                            logger.warn(\"@Reference  annotation should only be used on methods with parameters: \" +\n                                    method);\n                        }\n                    }\n                    //è·å–bridgedMethodæ–¹æ³•çš„å±æ€§æè¿°\n                    PropertyDescriptor pd = BeanUtils.findPropertyForMethod(bridgedMethod, beanClass);\n                    //åˆ›å»ºReferenceMethodElementå¯¹è±¡ï¼Œå¹¶ä¿å­˜\n                    elements.add(new ReferenceMethodElement(method, pd, reference));\n                }\n            }\n        });\n        return elements;\n    }\n\n\n    @Override\n    public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {\n        this.applicationContext = applicationContext;\n    }\n\n    @Override\n    public void postProcessMergedBeanDefinition(RootBeanDefinition beanDefinition, Class<?> beanType, String beanName) {\n        if (beanType != null) {\n            InjectionMetadata metadata = findReferenceMetadata(beanName, beanType, null);\n            metadata.checkConfigMembers(beanDefinition);\n        }\n    }\n\n    @Override\n    public int getOrder() {\n        return LOWEST_PRECEDENCE;\n    }\n\n    @Override\n    public void destroy() throws Exception {\n\n        for (ReferenceBean referenceBean : referenceBeansCache.values()) {\n            if (logger.isInfoEnabled()) {\n                logger.info(referenceBean + \" was destroying!\");\n            }\n            //é”€æ¯referenceBean\n            referenceBean.destroy();\n        }\n        //æ¸…ç©ºinjectionMetadataCache/referenceBeansCache\n        injectionMetadataCache.clear();\n        referenceBeansCache.clear();\n\n        if (logger.isInfoEnabled()) {\n            logger.info(getClass() + \" was destroying!\");\n        }\n    }\n\n    @Override\n    public void setBeanClassLoader(ClassLoader classLoader) {\n        this.classLoader = classLoader;\n    }\n\n    /**\n     * è·å–æ‰€æœ‰çš„ReferenceBean\n     * @return non-null {@link Collection}\n     * @since 2.5.9\n     */\n    public Collection<ReferenceBean<?>> getReferenceBeans() {\n        return this.referenceBeansCache.values();\n    }\n```\n##### ReferenceInjectionMetadataå†…éƒ¨ç±»\n```java\n    /**\n     * {@link Reference} {@link InjectionMetadata} implementation\n     *\n     * @since 2.5.11\n     */\n    private static class ReferenceInjectionMetadata extends InjectionMetadata {\n\n        private final Collection<ReferenceFieldElement> fieldElements;\n\n        private final Collection<ReferenceMethodElement> methodElements;\n\n        /**\n         * @param targetClass ç›®æ ‡ç±»\n         * @param fieldElements å­˜åœ¨@Referenceæ³¨è§£çš„å­—æ®µ\n         * @param methodElements å­˜åœ¨@Referenceæ³¨è§£çš„æ–¹æ³•\n         */\n        public ReferenceInjectionMetadata(Class<?> targetClass, Collection<ReferenceFieldElement> fieldElements,\n                                          Collection<ReferenceMethodElement> methodElements) {\n            super(targetClass, combine(fieldElements, methodElements));\n            this.fieldElements = fieldElements;\n            this.methodElements = methodElements;\n        }\n\n        /**\n         * å°†fieldElementså’ŒmethodElementsè¿›è¡Œåˆå¹¶\n         * @param elements\n         * @param <T>\n         * @return\n         */\n        private static <T> Collection<T> combine(Collection<? extends T>... elements) {\n            List<T> allElements = new ArrayList<T>();\n            for (Collection<? extends T> e : elements) {\n                allElements.addAll(e);\n            }\n            return allElements;\n        }\n\n        public Collection<ReferenceFieldElement> getFieldElements() {\n            return fieldElements;\n        }\n\n        public Collection<ReferenceMethodElement> getMethodElements() {\n            return methodElements;\n        }\n    }\n```\n\n##### ReferenceMethodElementå†…éƒ¨ç±»\n```java\n   /**\n     * å†…éƒ¨ç±»ï¼Œæ–¹æ³•å…ƒæ•°æ®ï¼Œæœ€ç»ˆä¼šè°ƒç”¨è¯¥ç±»çš„injectæ–¹æ³•è¿›è¡Œæ³¨å…¥\n     */\n    private class ReferenceMethodElement extends InjectionMetadata.InjectedElement {\n\n        /**\n         * æ ‡æ³¨@Referenceæ³¨è§£çš„æ–¹æ³•\n         */\n        private final Method method;\n\n        private final Reference reference;\n\t\n\t/**\n\t * æ–°ç”Ÿæˆçš„referenceBean\n\t */\n        private volatile ReferenceBean<?> referenceBean;\n\n        /**\n         * @param method\n         * @param pd æ–¹æ³•å±æ€§æè¿°ç¬¦\n         * @param reference\n         */\n        protected ReferenceMethodElement(Method method, PropertyDescriptor pd, Reference reference) {\n            super(method, pd);\n            this.method = method;\n            this.reference = reference;\n        }\n\n        @Override\n        protected void inject(Object bean, String beanName, PropertyValues pvs) throws Throwable {\n            //è·å–referenceClass\n            Class<?> referenceClass = pd.getPropertyType();\n            //è·å–referenceClasså¯¹åº”çš„referenceBean\n            referenceBean = buildReferenceBean(reference, referenceClass);\n\n            ReflectionUtils.makeAccessible(method);\n            //è°ƒç”¨beançš„methodï¼Œæ³¨å…¥ä¾èµ–\n            method.invoke(bean, referenceBean.getObject());\n        }\n    }\n```\n##### ReferenceFieldElementå†…éƒ¨ç±»\n```java\n    /**\n     * å†…éƒ¨ç±»ï¼Œå­—æ®µå…ƒæ•°æ®ï¼Œæœ€ç»ˆä¼šè°ƒç”¨è¯¥ç±»çš„injectæ–¹æ³•è¿›è¡Œæ³¨å…¥\n     */\n    private class ReferenceFieldElement extends InjectionMetadata.InjectedElement {\n        /**\n         * æ ‡æ³¨@Referenceæ³¨è§£çš„å­—æ®µ\n         */\n        private final Field field;\n\n        private final Reference reference;\n\n        private volatile ReferenceBean<?> referenceBean;\n\n        protected ReferenceFieldElement(Field field, Reference reference) {\n            super(field, null);\n            this.field = field;\n            this.reference = reference;\n        }\n\n        /**\n         * æ³¨å…¥\n         * @param bean  ç›®æ ‡bean\n         * @param beanName ç›®æ ‡bean-name\n         * @param pvs\n         * @throws Throwable\n         */\n        @Override\n        protected void inject(Object bean, String beanName, PropertyValues pvs) throws Throwable {\n\n            //è¢«@Referenceæ³¨è§£æ ‡è¯†çš„å­—æ®µçš„ç±»å‹\n            Class<?> referenceClass = field.getType();\n            //è·å–referenceClasså¯¹åº”çš„referenceBean\n            referenceBean = buildReferenceBean(reference, referenceClass);\n\n            ReflectionUtils.makeAccessible(field);\n            //æ³¨å…¥ä¾èµ–åˆ°ç›®æ ‡beanä¸­\n            field.set(bean, referenceBean.getObject());\n        }\n    }\n```\n##### buildReferenceBeanæ–¹æ³•\n```java\n    /**\n     * æ ¹æ®@Referenceæ³¨è§£å’ŒreferenceClassç”ŸæˆReferenceBean\n     * @param reference\n     * @param referenceClass è¢«@Referenceæ³¨è§£æ ‡æ³¨çš„å­—æ®µç±»å‹\n     * @return\n     * @throws Exception\n     */\n    private ReferenceBean<?> buildReferenceBean(Reference reference, Class<?> referenceClass) throws Exception {\n\n        //æ ¹æ®@Referenceæ³¨è§£å’ŒreferenceClass ç”Ÿæˆç¼“å­˜key\n        String referenceBeanCacheKey = generateReferenceBeanCacheKey(reference, referenceClass);\n\n        //å…ˆä»ç¼“å­˜ä¸­è·å–ReferenceBean\n        ReferenceBean<?> referenceBean = referenceBeansCache.get(referenceBeanCacheKey);\n\n        if (referenceBean == null) {\n            //ç”Ÿæˆä¸€ä¸ªreferenceBeanå¹¶æ”¾å…¥ç¼“å­˜(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n            ReferenceBeanBuilder beanBuilder = ReferenceBeanBuilder\n                    .create(reference, classLoader, applicationContext)\n                    .interfaceClass(referenceClass);\n            referenceBean = beanBuilder.build();\n            referenceBeansCache.putIfAbsent(referenceBeanCacheKey, referenceBean);\n        }\n        return referenceBean;\n\n    }\n```\n```java\n    /**\n     * ä¸ºReferenceBeanåˆ›å»ºä¸€ä¸ªç¼“å­˜key\n     * @param reference {@link Reference}\n     * @param beanClass {@link Class}\n     * @return\n     */\n    private String generateReferenceBeanCacheKey(Reference reference, Class<?> beanClass) {\n        //è·å–æ¥å£åç§°(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n        String interfaceName = resolveInterfaceName(reference, beanClass);\n        //ç”Ÿæˆç¼“å­˜key\n        String key = reference.url() + \"/\" + interfaceName +\n                \"/\" + reference.version() +\n                \"/\" + reference.group();\n\n        Environment environment = applicationContext.getEnvironment();\n        //å¤„ç†å ä½ç¬¦\n        key = environment.resolvePlaceholders(key);\n        return key;\n    }\n\n    /**\n     * è·å–æ¥å£åç§°interfaceName\n     * å…ˆä»@Referenceæ³¨è§£å±æ€§æ‰¾ï¼Œæ‰¾ä¸åˆ°åˆ™å–è¢«æ³¨è§£çš„æ¥å£å˜é‡åç§°\n     * @param reference @Referenceæ³¨è§£\n     * @param beanClass è¢«@Referenceæ³¨è§£æ ‡æ³¨çš„ç±»\n     * @return\n     * @throws IllegalStateException\n     */\n    private static String resolveInterfaceName(Reference reference, Class<?> beanClass)\n            throws IllegalStateException {\n\n        String interfaceName;\n        if (!\"\".equals(reference.interfaceName())) {\n            // @Referenceæ³¨è§£çš„interfaceNameå±æ€§ä¸ä¸ºç©º\n            interfaceName = reference.interfaceName();\n        } else if (!void.class.equals(reference.interfaceClass())) {\n            // @Referenceæ³¨è§£çš„interfaceClasså±æ€§ä¸ä¸ºvoid\n            interfaceName = reference.interfaceClass().getName();\n        } else if (beanClass.isInterface()) {\n            // è¢«@Referenceæ³¨è§£æ ‡æ³¨çš„ç±»æ˜¯æ¥å£ç±»å‹\n            interfaceName = beanClass.getName();\n        } else {\n            //@Referenceæ²¡æœ‰å®šä¹‰interfaceClass/interfaceNameå±æ€§ï¼ŒbeanClassä¸æ˜¯ä¸€ä¸ªæ¥å£\n            throw new IllegalStateException(\n                    \"The @Reference undefined interfaceClass or interfaceName, and the property type \"\n                            + beanClass.getName() + \" is not a interface.\");\n        }\n        return interfaceName;\n    }\n\n\n    /**\n     * è·å–<field,ReferenceBean>\n     *\n     * @return non-null {@link Map}\n     * @since 2.5.11\n     */\n    public Map<InjectionMetadata.InjectedElement, ReferenceBean<?>> getInjectedFieldReferenceBeanMap() {\n\n        Map<InjectionMetadata.InjectedElement, ReferenceBean<?>> injectedElementReferenceBeanMap =\n                new LinkedHashMap<InjectionMetadata.InjectedElement, ReferenceBean<?>>();\n        for (ReferenceInjectionMetadata metadata : injectionMetadataCache.values()) {\n            Collection<ReferenceFieldElement> fieldElements = metadata.getFieldElements();\n            for (ReferenceFieldElement fieldElement : fieldElements) {\n                injectedElementReferenceBeanMap.put(fieldElement, fieldElement.referenceBean);\n            }\n        }\n        return injectedElementReferenceBeanMap;\n    }\n\n    /**\n     * è·å–<æ–¹æ³•ï¼ŒReferenceBean>\n     * @return non-null {@link Map}\n     * @since 2.5.11\n     */\n    public Map<InjectionMetadata.InjectedElement, ReferenceBean<?>> getInjectedMethodReferenceBeanMap() {\n\n        Map<InjectionMetadata.InjectedElement, ReferenceBean<?>> injectedElementReferenceBeanMap =\n                new LinkedHashMap<InjectionMetadata.InjectedElement, ReferenceBean<?>>();\n\n        for (ReferenceInjectionMetadata metadata : injectionMetadataCache.values()) {\n            Collection<ReferenceMethodElement> methodElements = metadata.getMethodElements();\n            for (ReferenceMethodElement methodElement : methodElements) {\n                injectedElementReferenceBeanMap.put(methodElement, methodElement.referenceBean);\n            }\n        }\n        return injectedElementReferenceBeanMap;\n    }\n}\n```\n\n##### AbstractAnnotationConfigBeanBuilderç±»\næ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸‹ReferenceBeançš„åˆ›å»º\n\n```java\n//åˆ›å»ºReferenceBean\nReferenceBeanBuilder beanBuilder = ReferenceBeanBuilder\n          //createæ–¹æ³•åˆ›å»ºäº†ReferenceBeanBuilderå®ä¾‹\n\t  .create(reference, classLoader, applicationContext)\n\t  //è®¾ç½®referenceClass\n          .interfaceClass(referenceClass);\n//buildæ–¹æ³•åˆ›å»ºReferenceBeanç±»\nReferenceBean<?> referenceBean = beanBuilder.build();\n```\n\næˆ‘ä»¬æ˜¯é€šè¿‡ReferenceBeanBuilderç±»åˆ›å»ºReferenceBeançš„ï¼Œè€ŒReferenceBeanBuilderç»§æ‰¿è‡ªAbstractAnnotationConfigBeanBuilder,\nAbstractAnnotationConfigBeanBuilderå®šä¹‰äº†åˆ›å»ºé…ç½®beançš„ç®—æ³•éª¨æ¶(å³buildæ¨¡æ¿æ–¹æ³•)ï¼Œå…¶ä»–æ­¥éª¤éƒ½ç”±å­ç±»ReferenceBeanBuilderè´Ÿè´£å®ç°ã€‚\n```java\n/**\n * Annotation beané…ç½®æ„é€ å™¨\n * Abstract Configurable {@link Annotation} Bean Builder\n * @since 2.5.7\n */\nabstract class AbstractAnnotationConfigBeanBuilder<A extends Annotation, B extends AbstractInterfaceConfig> {\n\n    protected final Log logger = LogFactory.getLog(getClass());\n\n    /**\n     * æ³¨è§£\n     */\n    protected final A annotation;\n\n    protected final ApplicationContext applicationContext;\n\n    protected final ClassLoader classLoader;\n\n    protected Object bean;\n\n    /**\n     * æ¥å£ç±»\n     */\n    protected Class<?> interfaceClass;\n\n    protected AbstractAnnotationConfigBeanBuilder(A annotation, ClassLoader classLoader,\n                                                  ApplicationContext applicationContext) {\n        Assert.notNull(annotation, \"The Annotation must not be null!\");\n        Assert.notNull(classLoader, \"The ClassLoader must not be null!\");\n        Assert.notNull(applicationContext, \"The ApplicationContext must not be null!\");\n        this.annotation = annotation;\n        this.applicationContext = applicationContext;\n        this.classLoader = classLoader;\n    }\n\n    /**\n     * Build {@link B}\n     * @return non-null\n     * @throws Exception\n     */\n    public final B build() throws Exception {\n        //æ£€æµ‹ä¾èµ–\n        checkDependencies();\n        //æ„å»ºBï¼ˆå­ç±»å®ç°ï¼‰\n        B bean = doBuild();\n        //é…ç½®B\n        configureBean(bean);\n\n        if (logger.isInfoEnabled()) {\n            logger.info(bean + \" has been built.\");\n        }\n        return bean;\n\n    }\n\n    private void checkDependencies() {\n\n    }\n\n    /**\n     * Builds {@link B Bean}\n     *\n     * @return {@link B Bean}\n     */\n    protected abstract B doBuild();\n\n\n    protected void configureBean(B bean) throws Exception {\n\n        //å­ç±»å®ç°\n        preConfigureBean(annotation, bean);\n\n        //é…ç½®RegistryConfig(å³å°†RegistryConfigå®ä¾‹æ³¨å…¥åˆ°Bå¯¹è±¡ä¸­)\n        configureRegistryConfigs(bean);\n\n        //é…ç½®MonitorConfig\n        configureMonitorConfig(bean);\n\n        //é…ç½®ApplicationConfig\n        configureApplicationConfig(bean);\n\n        //é…ç½®ModuleConfig\n        configureModuleConfig(bean);\n\n        //å­ç±»å®ç°\n        postConfigureBean(annotation, bean);\n    }\n\n    protected abstract void preConfigureBean(A annotation, B bean) throws Exception;\n\n\n    /**\n     * é…ç½®RegistryConfig\n     * @param bean\n     */\n    private void configureRegistryConfigs(B bean) {\n        //è·å–RegistryConfigçš„bean-names\n        String[] registryConfigBeanIds = resolveRegistryConfigBeanNames(annotation);\n        //æ ¹æ®bean-namesä»å·¥å‚ä¸­è·å–RegistryConfigå®ä¾‹\n        List<RegistryConfig> registryConfigs = getBeans(applicationContext, registryConfigBeanIds, RegistryConfig.class);\n        //å°†registryConfigsæ³¨å…¥åˆ°Bä¸­\n        bean.setRegistries(registryConfigs);\n    }\n\n    /**\n     * é…ç½®MonitorConfig\n     * @param bean\n     */\n    private void configureMonitorConfig(B bean) {\n        //è·å–MonitorConfigçš„bean-names\n        String monitorBeanName = resolveMonitorConfigBeanName(annotation);\n        //è·å–monitorConfigå®ä¾‹\n        MonitorConfig monitorConfig = getOptionalBean(applicationContext, monitorBeanName, MonitorConfig.class);\n        //å°†registryConfigsæ³¨å…¥åˆ°Bä¸­\n        bean.setMonitor(monitorConfig);\n\n    }\n\n    /**\n     * é…ç½®ApplicationConfig\n     * @param bean\n     */\n    private void configureApplicationConfig(B bean) {\n        //è·å–ApplicationConfigçš„bean-names\n        String applicationConfigBeanName = resolveApplicationConfigBeanName(annotation);\n\n        ApplicationConfig applicationConfig =\n                getOptionalBean(applicationContext, applicationConfigBeanName, ApplicationConfig.class);\n\n        bean.setApplication(applicationConfig);\n    }\n\n    /**\n     * é…ç½®ModuleConfig\n     * @param bean\n     */\n    private void configureModuleConfig(B bean) {\n        //è·å–ModuleConfigçš„bean-names\n        String moduleConfigBeanName = resolveModuleConfigBeanName(annotation);\n\n        ModuleConfig moduleConfig =\n                getOptionalBean(applicationContext, moduleConfigBeanName, ModuleConfig.class);\n\n        bean.setModule(moduleConfig);\n\n    }\n\n    /**\n     * Resolves the bean name of {@link ModuleConfig}\n     *\n     * @param annotation {@link A}\n     * @return\n     */\n    protected abstract String resolveModuleConfigBeanName(A annotation);\n\n    /**\n     * Resolves the bean name of {@link ApplicationConfig}\n     *\n     * @param annotation {@link A}\n     * @return\n     */\n    protected abstract String resolveApplicationConfigBeanName(A annotation);\n\n\n    /**\n     * Resolves the bean ids of {@link com.alibaba.dubbo.config.RegistryConfig}\n     *\n     * @param annotation {@link A}\n     * @return non-empty array\n     */\n    protected abstract String[] resolveRegistryConfigBeanNames(A annotation);\n\n    /**\n     * Resolves the bean name of {@link MonitorConfig}\n     *\n     * @param annotation {@link A}\n     * @return\n     */\n    protected abstract String resolveMonitorConfigBeanName(A annotation);\n\n    /**\n     * Configures Bean\n     *\n     * @param annotation\n     * @param bean\n     */\n    protected abstract void postConfigureBean(A annotation, B bean) throws Exception;\n\n\n    public <T extends AbstractAnnotationConfigBeanBuilder<A, B>> T bean(Object bean) {\n        this.bean = bean;\n        return (T) this;\n    }\n\n    public <T extends AbstractAnnotationConfigBeanBuilder<A, B>> T interfaceClass(Class<?> interfaceClass) {\n        this.interfaceClass = interfaceClass;\n        return (T) this;\n    }\n}\n```\n##### ReferenceBeanBuilderå®ç°ç±»\n\næˆ‘ä»¬æ¥ä¸‹æ¥çœ‹ReferenceBeanBuilderå®ç°ç±»\n```java\n/**\n * ReferenceBean æ„é€ å™¨\n */\nclass ReferenceBeanBuilder extends AbstractAnnotationConfigBeanBuilder<Reference, ReferenceBean> {\n\t\n    private ReferenceBeanBuilder(Reference annotation, ClassLoader classLoader, ApplicationContext applicationContext) {\n        super(annotation, classLoader, applicationContext);\n    }\n\n    /**\n     * è®¾ç½®referenceBeanå®ä¾‹çš„interfaceClasså±æ€§\n     * @param reference\n     * @param referenceBean\n     */\n    private void configureInterface(Reference reference, ReferenceBean referenceBean) {\n\n        //è·å–@Referenceæ³¨è§£çš„interfaceClasså±æ€§\n        Class<?> interfaceClass = reference.interfaceClass();\n\n        if (void.class.equals(interfaceClass)) {\n            interfaceClass = null;\n            //interfaceClasså±æ€§æ²¡æœ‰é…ç½®,åˆ™å–interfaceNameå±æ€§\n            String interfaceClassName = reference.interfaceName();\n            if (StringUtils.hasText(interfaceClassName)) {\n                if (ClassUtils.isPresent(interfaceClassName, classLoader)) {\n                    //åŠ è½½interfaceClassNameç±»ï¼Œä½œä¸ºinterfaceClass\n                    interfaceClass = ClassUtils.resolveClassName(interfaceClassName, classLoader);\n                }\n            }\n        }\n        if (interfaceClass == null) {\n            //å¦‚æœ@Referenceæ³¨è§£æ²¡æœ‰é…ç½®interfaceClasså±æ€§å’ŒinterfaceNameå±æ€§\n            //åˆ™ä½¿ç”¨åˆ›å»ºå¯¹è±¡æ—¶ä½¿ç”¨çš„interfaceClass\n            interfaceClass = this.interfaceClass;\n        }\n        //æ ¡éªŒinterfaceClassæ˜¯æ¥å£ç±»å‹\n        Assert.isTrue(interfaceClass.isInterface(),\n                \"The class of field or method that was annotated @Reference is not an interface!\");\n        //è®¾ç½®referenceBeanå¯¹è±¡çš„interfaceClass\n        referenceBean.setInterface(interfaceClass);\n    }\n\n\n    /**\n     * è®¾ç½®referenceBeanå®ä¾‹çš„consumerå±æ€§\n     * @param reference\n     * @param referenceBean\n     */\n    private void configureConsumerConfig(Reference reference, ReferenceBean<?> referenceBean) {\n        //è·å–@Referenceæ³¨è§£çš„consumerå±æ€§\n        String consumerBeanName = reference.consumer();\n        //ä»å·¥å‚ä¸­è·å–ConsumerConfigå®ä¾‹\n        ConsumerConfig consumerConfig = getOptionalBean(applicationContext, consumerBeanName, ConsumerConfig.class);\n        //è®¾ç½®referenceBeanå®ä¾‹çš„consumerå±æ€§\n        referenceBean.setConsumer(consumerConfig);\n    }\n\n    @Override\n    protected ReferenceBean doBuild() {\n        //åˆ›å»ºReferenceBeanå¯¹è±¡\n        return new ReferenceBean<Object>();\n    }\n\n    @Override\n    protected void preConfigureBean(Reference reference, ReferenceBean referenceBean) {\n        Assert.notNull(interfaceClass, \"The interface class must set first!\");\n\n        //æ ¹æ®referenceBeanåˆ›å»ºæ•°æ®ç»‘å®šå¯¹è±¡\n        DataBinder dataBinder = new DataBinder(referenceBean);\n        //è®¾ç½®è½¬æ¢å™¨\n        dataBinder.setConversionService(getConversionService());\n        //å¿½ç•¥çš„å±æ€§åç§°\n        String[] ignoreAttributeNames = of(\"application\", \"module\", \"consumer\", \"monitor\", \"registry\");\n        //dataBinder.setDisallowedFields(ignoreAttributeNames)\n        //ç»‘å®šæ³¨è§£å±æ€§\n        dataBinder.bind(new AnnotationPropertyValuesAdapter(reference, applicationContext.getEnvironment(), ignoreAttributeNames));\n    }\n\n    /**\n     * è·å–ConversionService\n     * @return\n     */\n    private ConversionService getConversionService() {\n        //åˆ›å»ºé»˜è®¤è½¬æ¢å™¨\n        DefaultConversionService conversionService = new DefaultConversionService();\n        //æ·»åŠ StringArrayåˆ°Stringçš„è½¬æ¢\n        conversionService.addConverter(new StringArrayToStringConverter());\n        //æ·»åŠ StringArrayåˆ°Mapçš„è½¬æ¢\n        conversionService.addConverter(new StringArrayToMapConverter());\n        return conversionService;\n    }\n\n\n    @Override\n    protected String resolveModuleConfigBeanName(Reference annotation) {\n        //è·å–@Referenceæ³¨è§£çš„moduleå±æ€§\n        return annotation.module();\n    }\n\n    @Override\n    protected String resolveApplicationConfigBeanName(Reference annotation) {\n        //è·å–@Referenceæ³¨è§£çš„applicationå±æ€§\n        return annotation.application();\n    }\n\n    @Override\n    protected String[] resolveRegistryConfigBeanNames(Reference annotation) {\n        //è·å–@Referenceæ³¨è§£çš„registryå±æ€§\n        return annotation.registry();\n    }\n\n    @Override\n    protected String resolveMonitorConfigBeanName(Reference annotation) {\n        //è·å–@Referenceæ³¨è§£çš„monitorå±æ€§\n        return annotation.monitor();\n    }\n\n    @Override\n    protected void postConfigureBean(Reference annotation, ReferenceBean bean) throws Exception {\n\n        //è®¾ç½®applicationContextå±æ€§\n        bean.setApplicationContext(applicationContext);\n        //è®¾ç½®interfaceClasså±æ€§\n        configureInterface(annotation, bean);\n        //è®¾ç½®consumerå±æ€§\n        configureConsumerConfig(annotation, bean);\n        //å±æ€§éƒ½è®¾ç½®å®Œäº†ï¼Œå¼€å§‹è°ƒç”¨beançš„afterPropertiesSetæ–¹æ³•(å¯è§ReferenceBeanå®ç°äº†InitializingBeanæ¥å£)\n        //åœ¨afterPropertiesSet()æ–¹æ³•ä¸­ä¼šæ ¡éªŒconsumer/application/module/registry/monitorç­‰å±æ€§æ˜¯å¦ä¸ºç©ºï¼Œ\n\t//ä¸ºç©ºçš„è¯,ä¼šä»Springå®¹å™¨ä¸­å†æ¬¡è·å–ä¸‹,å¹¶é‡æ–°èµ‹å€¼,ç„¶åä¼šæ ¹æ®é…ç½®æ˜¯å¦ç«‹å³åˆå§‹åŒ–è¯¥bean\n\tbean.afterPropertiesSet();\n    }\n\n    /**\n     * åˆ›å»ºReferenceBeanBuilderå®ä¾‹\n     * @param annotation\n     * @param classLoader\n     * @param applicationContext\n     * @return\n     */\n    public static ReferenceBeanBuilder create(Reference annotation, ClassLoader classLoader,\n                                              ApplicationContext applicationContext) {\n        return new ReferenceBeanBuilder(annotation, classLoader, applicationContext);\n    }\n}\n```\n\n##### ReferenceBeanç±»\n\næ¥ä¸‹æ¥æ¥çœ‹ReferenceBeanç±»,è¯¥ç±»ç»§æ‰¿è‡ªReferenceConfigç±»,å¹¶å®ç°äº†FactoryBeanæ¥å£ã€‚\n```java\n/**\n * ReferenceFactoryBean\n * @export\n */\npublic class ReferenceBean<T> extends ReferenceConfig<T> implements FactoryBean,\n        ApplicationContextAware, InitializingBean, DisposableBean {\n\n    private transient ApplicationContext applicationContext;\n\n    public ReferenceBean() {\n        super();\n    }\n\n    public ReferenceBean(Reference reference) {\n        //è°ƒç”¨çˆ¶ç±»æ„é€ æ–¹æ³•ï¼Œåœ¨çˆ¶ç±»æ„é€ æ–¹æ³•ä¸­ä¼šè°ƒç”¨appendAnnotationæ–¹æ³•å¤„ç†@Referenceæ³¨è§£çš„å±æ€§\n        super(reference);\n    }\n\n    @Override\n    public void setApplicationContext(ApplicationContext applicationContext) {\n        this.applicationContext = applicationContext;\n        //å°†applicationContextæ·»åŠ åˆ°SpringExtensionFactoryä¸­\n        //SPIé‚£ä¸€ç« èŠ‚ï¼Œæˆ‘ä»¬ä»‹ç»è¿‡SpringExtensionFactoryç±»\n        SpringExtensionFactory.addApplicationContext(applicationContext);\n    }\n\n    @Override\n    public Object getObject() throws Exception {\n        //è·å–å¯¹è±¡å®ä¾‹ï¼Œè°ƒç”¨çˆ¶ç±»ä¸­çš„getæ–¹æ³•è¿›è¡Œåˆå§‹åŒ–\n        return get();\n    }\n\n    @Override\n    public Class<?> getObjectType() {\n        //è°ƒç”¨çˆ¶ç±»ä¸­çš„getInterfaceClassæ–¹æ³•è·å–å¯¹è±¡ç±»å‹(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n        return getInterfaceClass();\n    }\n\n    @Override\n    @Parameter(excluded = true)\n    public boolean isSingleton() {\n        return true;\n    }\n\n    @Override\n    @SuppressWarnings({\"unchecked\"})\n    public void afterPropertiesSet() throws Exception {\n        //å¦‚æœæ²¡æœ‰é…ç½®Consumer\n        if (getConsumer() == null) {\n            //è·å–IOCå®¹å™¨ä¸­çš„ConsumerConfigï¼ˆåªè·å–å•ä¾‹ç±»å‹çš„ï¼‰\n            Map<String, ConsumerConfig> consumerConfigMap = applicationContext == null ? null : BeanFactoryUtils.beansOfTypeIncludingAncestors(applicationContext, ConsumerConfig.class, false, false);\n            if (consumerConfigMap != null && consumerConfigMap.size() > 0) {\n                ConsumerConfig consumerConfig = null;\n                for (ConsumerConfig config : consumerConfigMap.values()) {\n                    //æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤çš„consumeré…ç½®(defaultå±æ€§)\n                    if (config.isDefault() == null || config.isDefault().booleanValue()) {\n                        if (consumerConfig != null) {\n                            throw new IllegalStateException(\"Duplicate consumer configs: \" + consumerConfig + \" and \" + config);\n                        }\n                        consumerConfig = config;\n                    }\n                }\n                if (consumerConfig != null) {\n                    //é…ç½®beançš„consumerå±æ€§\n                    setConsumer(consumerConfig);\n                }\n            }\n        }\n        if (getApplication() == null\n                && (getConsumer() == null || getConsumer().getApplication() == null)) {\n            //ä»IOCå®¹å™¨ä¸­è·å–ApplicationConfig\n            Map<String, ApplicationConfig> applicationConfigMap = applicationContext == null ? null : BeanFactoryUtils.beansOfTypeIncludingAncestors(applicationContext, ApplicationConfig.class, false, false);\n            if (applicationConfigMap != null && applicationConfigMap.size() > 0) {\n                ApplicationConfig applicationConfig = null;\n                for (ApplicationConfig config : applicationConfigMap.values()) {\n                    //æ£€æµ‹æ˜¯å¦æœ‰é‡å¤çš„é…ç½®(defaultå±æ€§)\n                    if (config.isDefault() == null || config.isDefault().booleanValue()) {\n                        if (applicationConfig != null) {\n                            throw new IllegalStateException(\"Duplicate application configs: \" + applicationConfig + \" and \" + config);\n                        }\n                        applicationConfig = config;\n                    }\n                }\n                if (applicationConfig != null) {\n                    //è®¾ç½®beançš„ApplicationConfigå±æ€§\n                    setApplication(applicationConfig);\n                }\n            }\n        }\n        if (getModule() == null\n                && (getConsumer() == null || getConsumer().getModule() == null)) {\n            //ä»IOCå®¹å™¨ä¸­è·å–ModuleConfig\n            Map<String, ModuleConfig> moduleConfigMap = applicationContext == null ? null : BeanFactoryUtils.beansOfTypeIncludingAncestors(applicationContext, ModuleConfig.class, false, false);\n            if (moduleConfigMap != null && moduleConfigMap.size() > 0) {\n                ModuleConfig moduleConfig = null;\n                for (ModuleConfig config : moduleConfigMap.values()) {\n                    //æ£€æµ‹æ˜¯å¦æœ‰é‡å¤çš„moduleConfig\n                    if (config.isDefault() == null || config.isDefault().booleanValue()) {\n                        if (moduleConfig != null) {\n                            throw new IllegalStateException(\"Duplicate module configs: \" + moduleConfig + \" and \" + config);\n                        }\n                        moduleConfig = config;\n                    }\n                }\n                if (moduleConfig != null) {\n                    //è®¾ç½®moduleå±æ€§\n                    setModule(moduleConfig);\n                }\n            }\n        }\n        if ((getRegistries() == null || getRegistries().isEmpty())\n                && (getConsumer() == null || getConsumer().getRegistries() == null || getConsumer().getRegistries().isEmpty())\n                && (getApplication() == null || getApplication().getRegistries() == null || getApplication().getRegistries().isEmpty())) {\n            //ä»IOCå®¹å™¨ä¸­è·å–RegistryConfig\n            Map<String, RegistryConfig> registryConfigMap = applicationContext == null ? null : BeanFactoryUtils.beansOfTypeIncludingAncestors(applicationContext, RegistryConfig.class, false, false);\n            if (registryConfigMap != null && registryConfigMap.size() > 0) {\n                List<RegistryConfig> registryConfigs = new ArrayList<RegistryConfig>();\n                        registryConfigs.add(config);\n                    }\n                }\n                if (registryConfigs != null && !registryConfigs.isEmpty()) {\n                    //è®¾ç½®registrieså±æ€§\n                    super.setRegistries(registryConfigs);\n                }\n            }\n        }\n        if (getMonitor() == null\n                && (getConsumer() == null || getConsumer().getMonitor() == null)\n                && (getApplication() == null || getApplication().getMonitor() == null)) {\n            //ä»IOCå®¹å™¨ä¸­è·å–MonitorConfig\n            Map<String, MonitorConfig> monitorConfigMap = applicationContext == null ? null : BeanFactoryUtils.beansOfTypeIncludingAncestors(applicationContext, MonitorConfig.class, false, false);\n            if (monitorConfigMap != null && monitorConfigMap.size() > 0) {\n                MonitorConfig monitorConfig = null;\n                for (MonitorConfig config : monitorConfigMap.values()) {\n                    //æ£€æµ‹æ˜¯å¦æœ‰é‡å¤çš„MonitorConfig\n                    if (config.isDefault() == null || config.isDefault().booleanValue()) {\n                        if (monitorConfig != null) {\n                            throw new IllegalStateException(\"Duplicate monitor configs: \" + monitorConfig + \" and \" + config);\n                        }\n                        monitorConfig = config;\n                    }\n                }\n                if (monitorConfig != null) {\n                    //è®¾ç½®MonitorConfigå±æ€§\n                    setMonitor(monitorConfig);\n                }\n            }\n        }\n        //è·å–æ˜¯å¦ ç«‹å³åˆå§‹åŒ– å±æ€§init\n        Boolean b = isInit();\n        if (b == null && getConsumer() != null) {\n            //ä»ConsumerConfigå±æ€§ä¸­è·å–init\n            b = getConsumer().isInit();\n        }\n        if (b != null && b.booleanValue()) {\n            //æ‰§è¡Œåˆå§‹åŒ–\n            getObject();\n        }\n    }\n\n    @Override\n    public void destroy() {\n        // do nothing\n    }\n}\n```\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹çˆ¶ç±»ReferenceConfigä¸­çš„æ–¹æ³•\n```java\n/**\n* è·å–æœåŠ¡æ¥å£ç±»\n* interfaceClass > GenericService.class > interfaceName\n* @return\n*/\npublic Class<?> getInterfaceClass() {\n\t//interfaceClasså±æ€§ä¸ä¸ºç©ºï¼Œç›´æ¥è¿”å›\n\tif (interfaceClass != null) {\n\t    return interfaceClass;\n\t}\n\t//Referenceæˆ–è€…Consumerçš„genericå±æ€§ä¸ºtrueï¼Œåˆ™ä½¿ç”¨GenericServiceç±»\n\tif (isGeneric()\n\t\t|| (getConsumer() != null && getConsumer().isGeneric())) {\n\t    return GenericService.class;\n\t}\n\ttry {\n\t    if (interfaceName != null && interfaceName.length() > 0) {\n\t\t//interfaceNameå±æ€§ä¸ä¸ºç©ºï¼ŒåŠ è½½è¯¥ç±»\n\t\tthis.interfaceClass = Class.forName(interfaceName, true, Thread.currentThread()\n\t\t\t.getContextClassLoader());\n\t    }\n\t} catch (ClassNotFoundException t) {\n\t    throw new IllegalStateException(t.getMessage(), t);\n\t}\n\treturn interfaceClass;\n}\n\n\n/**\n * æ˜¯å¦å·²é”€æ¯\n */\nprivate transient volatile boolean destroyed;\n\n/**\n * æ¥å£ä»£ç†å¼•ç”¨\n * interface proxy reference\n */\nprivate transient volatile T ref;\n\n\n/**\n * è·å–æ¥å£ä»£ç†å¼•ç”¨\n */\npublic synchronized T get() {\n        //åˆ¤æ–­æ˜¯å¦å·²ç»é”€æ¯\n        if (destroyed) {\n            throw new IllegalStateException(\"Already destroyed!\");\n        }\n        if (ref == null) {\n            //åˆå§‹åŒ–\n            init();\n        }\n        return ref;\n}\n```\n\n#### initæ–¹æ³•\nè¯¥initæ–¹æ³•ä¼šç”Ÿæˆæ¥å£ä»£ç†å¼•ç”¨refã€‚\n```java\npublic synchronized T get() {\n        //åˆ¤æ–­æ˜¯å¦å·²ç»é”€æ¯\n        if (destroyed) {\n            throw new IllegalStateException(\"Already destroyed!\");\n        }\n        if (ref == null) {\n            //åˆå§‹åŒ–\n            init();\n        }\n        return ref;\n}\n\nprivate void init() {\n\t//å·²ç»åˆå§‹åŒ–è¿‡çš„è¯ï¼Œåˆ™è¿”å›\n\tif (initialized) {\n\t    return;\n\t}\n\tinitialized = true;\n\t//æ£€æµ‹æ˜¯å¦é…ç½®äº†interfaceå±æ€§\n\tif (interfaceName == null || interfaceName.length() == 0) {\n\t    throw new IllegalStateException(\"<dubbo:reference interface=\\\"\\\" /> interface not allow null!\");\n\t}\n\t//è·å–Consumerçš„å…¨å±€é…ç½®(è®¾ç½®ConsumerConfigå¯¹è±¡çš„å±æ€§)(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\tcheckDefault();\n\t//åŠ è½½å½“å‰ReferenceConfigå¯¹è±¡(å³ReferenceBean)çš„å±æ€§ä¿¡æ¯(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\tappendProperties(this);\n\t//å½“å‰ReferenceConfigæ²¡æœ‰é…ç½®genericå±æ€§çš„è¯ï¼Œåˆ™ä½¿ç”¨Consumerçš„genericå±æ€§é…ç½®\n\tif (getGeneric() == null && getConsumer() != null) {\n\t    //è®¾ç½®genericå±æ€§\n\t    setGeneric(getConsumer().getGeneric());\n\t}\n\t//(generic ï¼= null) && (generic = â€œtrueâ€ || \"nativejava\" || \"bean\") ProtocolUtils.isGenericè¿”å›true\n\tif (ProtocolUtils.isGeneric(getGeneric())) {\n\t    //å¦‚æœé…ç½®äº†ä½¿ç”¨é€šç”¨æ¥å£ï¼Œåˆ™è®¾ç½®æœåŠ¡æ¥å£ç±»ä¸ºGenericServiceç±»\n\t    interfaceClass = GenericService.class;\n\t} else {\n\t    //å¦åˆ™æ ¹æ®interfaceNameåŠ è½½æœåŠ¡æ¥å£ç±»\n\t    try {\n\t\tinterfaceClass = Class.forName(interfaceName, true, Thread.currentThread()\n\t\t\t.getContextClassLoader());\n\t    } catch (ClassNotFoundException e) {\n\t\tthrow new IllegalStateException(e.getMessage(), e);\n\t    }\n\t    //æ£€æµ‹methodsæ–¹æ³•æ˜¯å¦éƒ½å­˜åœ¨äºæ¥å£æœåŠ¡ç±»interfaceClassä¸­(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\t    checkInterfaceAndMethods(interfaceClass, methods);\n\t}\n\t//1ã€æ ¹æ®æœåŠ¡æ¥å£åç§°ä»ç³»ç»Ÿé…ç½®ä¸­æŸ¥æ‰¾resolveï¼šå³é€šè¿‡-DinterfaceName=resolveé…ç½®\n\t//2ã€resolveä¸ºç©ºï¼Œåˆ™åŠ è½½dubbo.resolve.fileæ–‡ä»¶,ä»resolveFileä¸­åŠ è½½resolve\n\t//   aã€ä»ç³»ç»Ÿé…ç½®æ–‡ä»¶ä¸­åŠ è½½resolveæ–‡ä»¶ï¼šå³-Ddubbo.resolve.file=xxxé…ç½®\n\t//   bã€ä½¿ç”¨dubboçš„é»˜è®¤resolveæ–‡ä»¶ï¼š${user.home}/dubbo-resolve.properties\n\tString resolve = System.getProperty(interfaceName);\n\tString resolveFile = null;\n\tif (resolve == null || resolve.length() == 0) {\n\t    resolveFile = System.getProperty(\"dubbo.resolve.file\");\n\t    if (resolveFile == null || resolveFile.length() == 0) {\n\t\t//æ²¡æœ‰é…ç½®resolveFileçš„è¯ï¼Œåˆ™ä½¿ç”¨dubboé»˜è®¤çš„resolveæ–‡ä»¶\n\t\t//å¦‚ï¼šSystem.getProperty(\"user.home\") = C:\\Users\\Administrator\n\t\t//resolveFile = userResolveFile = C:\\Users\\Administrator\\dubbo-resolve.properties\n\t\tFile userResolveFile = new File(new File(System.getProperty(\"user.home\")), \"dubbo-resolve.properties\");\n\t\tif (userResolveFile.exists()) {\n\t\t    resolveFile = userResolveFile.getAbsolutePath();\n\t\t}\n\t    }\n\t    //åŠ è½½resolveFileæ–‡ä»¶\n\t    if (resolveFile != null && resolveFile.length() > 0) {\n\t\tProperties properties = new Properties();\n\t\tFileInputStream fis = null;\n\t\ttry {\n\t\t    fis = new FileInputStream(new File(resolveFile));\n\t\t    properties.load(fis);\n\t\t} catch (IOException e) {\n\t\t    throw new IllegalStateException(\"Unload \" + resolveFile + \", cause: \" + e.getMessage(), e);\n\t\t} finally {\n\t\t    try {\n\t\t\tif (null != fis) {\n\t\t\t    fis.close();\n\t\t\t}\n\t\t    } catch (IOException e) {\n\t\t\tlogger.warn(e.getMessage(), e);\n\t\t    }\n\t\t}\n\t\t//ä»resolveFileé…ç½®æ–‡ä»¶ä¸­åŠ è½½resolve\n\t\tresolve = properties.getProperty(interfaceName);\n\t    }\n\t}\n\tif (resolve != null && resolve.length() > 0) {\n\t    url = resolve;\n\t    if (logger.isWarnEnabled()) {\n\t\tif (resolveFile != null && resolveFile.length() > 0) {\n\t\t    //ä½¿ç”¨é»˜è®¤dubbo resolve file\n\t\t    logger.warn(\"Using default dubbo resolve file \" + resolveFile + \" replace \" + interfaceName + \"\" + resolve + \" to p2p invoke remote service.\");\n\t\t} else {\n\t\t    //å¯ä»¥ä½¿ç”¨-DinterfaceName=resolveé…ç½®p2p\n\t\t    logger.warn(\"Using -D\" + interfaceName + \"=\" + resolve + \" to p2p invoke remote service.\");\n\t\t}\n\t    }\n\t}\n\t//åŠ è½½æ³¨å†Œä¸­å¿ƒã€ç›‘æ§ä¸­å¿ƒä¼˜å…ˆçº§\n\t//consumer > module > application\n\tif (consumer != null) {\n\t    if (application == null) {\n\t\tapplication = consumer.getApplication();\n\t    }\n\t    if (module == null) {\n\t\tmodule = consumer.getModule();\n\t    }\n\t    if (registries == null) {\n\t\tregistries = consumer.getRegistries();\n\t    }\n\t    if (monitor == null) {\n\t\tmonitor = consumer.getMonitor();\n\t    }\n\t}\n\tif (module != null) {\n\t    if (registries == null) {\n\t\tregistries = module.getRegistries();\n\t    }\n\t    if (monitor == null) {\n\t\tmonitor = module.getMonitor();\n\t    }\n\t}\n\tif (application != null) {\n\t    //<dubbo:application name=\"demo-consumer\" qosPort=\"33333\" id=\"demo-consumer\" />\n\t    if (registries == null) {\n\t\tregistries = application.getRegistries();\n\t    }\n\t    if (monitor == null) {\n\t\tmonitor = application.getMonitor();\n\t    }\n\t}\n\t//æ£€æµ‹Applicationé…ç½®(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\tcheckApplication();\n\t//æ£€æµ‹Stubå’ŒMock(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\tcheckStubAndMock(interfaceClass);\n\n\t//è®°å½•Consumerç«¯çš„æœåŠ¡æ¥å£ç›¸å…³ä¿¡æ¯\n\tMap<String, String> map = new HashMap<String, String>();\n\t//ä¿å­˜æ–¹æ³•å±æ€§çš„attributes\n\tMap<Object, Object> attributes = new HashMap<Object, Object>();\n\t//è®¾ç½®æ¶ˆè´¹è€…ç«¯\n\tmap.put(Constants.SIDE_KEY, Constants.CONSUMER_SIDE);\n\t//è®¾ç½®dubboç‰ˆæœ¬\n\tmap.put(Constants.DUBBO_VERSION_KEY, Version.getVersion());\n\t//è®¾ç½®æ—¶é—´æˆ³\n\tmap.put(Constants.TIMESTAMP_KEY, String.valueOf(System.currentTimeMillis()));\n\tif (ConfigUtils.getPid() > 0) {\n\t    //è®¾ç½®çˆ¶è¿›ç¨‹id\n\t    map.put(Constants.PID_KEY, String.valueOf(ConfigUtils.getPid()));\n\t}\n\tif (!isGeneric()) {\n\t    //ä¸æ˜¯é€šç”¨æ³›å‹æ¥å£ï¼Œåˆ™è·å–revisionå±æ€§,é»˜è®¤ç­‰äºversionå±æ€§\n\t    String revision = Version.getVersion(interfaceClass, version);\n\t    if (revision != null && revision.length() > 0) {\n\t\tmap.put(\"revision\", revision);\n\t    }\n\t    //è·å–åŒ…è£…ç±»ï¼Œç„¶åè·å–æœåŠ¡æ¥å£ä¸­çš„æ–¹æ³•åç§°æ•°ç»„(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\t    String[] methods = Wrapper.getWrapper(interfaceClass).getMethodNames();\n\t    if (methods.length == 0) {\n\t\t//åœ¨æœåŠ¡æ¥å£ä¸­ï¼Œæ²¡æœ‰æ‰¾åˆ°æ–¹æ³•ï¼Œåˆ™è®¾ç½®å±æ€§ï¼šmethods = *\n\t\tlogger.warn(\"NO method found in service interface \" + interfaceClass.getName());\n\t\tmap.put(\"methods\", Constants.ANY_VALUE);\n\t    } else {\n\t\t//è®¾ç½®methods=é€—å·åˆ†éš”çš„æ–¹æ³•name\n\t\tmap.put(\"methods\", StringUtils.join(new HashSet<String>(Arrays.asList(methods)), \",\"));\n\t    }\n\t}\n\t//è®¾ç½®interfaceå±æ€§\n\tmap.put(Constants.INTERFACE_KEY, interfaceName);\n\t//æ·»åŠ é™„åŠ å‚æ•°(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\tappendParameters(map, application);\n\tappendParameters(map, module);\n\tappendParameters(map, consumer, Constants.DEFAULT_KEY);\n\tappendParameters(map, this);\n\t//è·å–æœåŠ¡å‰ç¼€ï¼šgroup/interface:version\n\tString prefix = StringUtils.getServiceKey(map);\n\t//å¤„ç†å¼•ç”¨çš„æ–¹æ³•åˆ—è¡¨\n\tif (methods != null && !methods.isEmpty()) {\n\t    for (MethodConfig method : methods) {\n\t\t//é™„åŠ å‚æ•°(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\t\tappendParameters(map, method, method.getName());\n\t\t//å¤„ç†æ–¹æ³•é‡è¯•\n\t\tString retryKey = method.getName() + \".retry\";\n\t\tif (map.containsKey(retryKey)) {\n\t\t    //å°†å±æ€§retryKeyä»mapä¸­ç§»é™¤\n\t\t    String retryValue = map.remove(retryKey);\n\t\t    if (\"false\".equals(retryValue)) {\n\t\t\t//å±æ€§retryKeyçš„å€¼ä¸ºfalse,åˆ™æ·»åŠ æ–°çš„å±æ€§åˆ°mapä¸­(å³ç¦ç”¨æ–¹æ³•é‡è¯•)\n\t\t\tmap.put(method.getName() + \".retries\", \"0\");\n\t\t    }\n\t\t}\n\t\t//é™„åŠ å±æ€§(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\t\tappendAttributes(attributes, method, prefix + \".\" + method.getName());\n\t\t//attributesä¿å­˜çš„æ˜¯æ–¹æ³•åï¼Œè°ƒç”¨checkAndConvertImplicitConfigæ–¹æ³•åå°†ä¼šä¿å­˜Methodå®ä¾‹\n\t\tcheckAndConvertImplicitConfig(method, map, attributes);\n\t    }\n\t}\n\t//ä»ç³»ç»Ÿé…ç½®å±æ€§ä¸­è·å–ï¼šæ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒçš„ip\n\tString hostToRegistry = ConfigUtils.getSystemProperty(Constants.DUBBO_IP_TO_REGISTRY);\n\tif (hostToRegistry == null || hostToRegistry.length() == 0) {\n\t    //è·å–æœ¬åœ°åœ°å€,å¦‚ï¼š192.168.99.60\n\t    hostToRegistry = NetUtils.getLocalHost();\n\t} else if (isInvalidLocalHost(hostToRegistry)) {\n\t    //æ— æ•ˆçš„åœ°å€\n\t    throw new IllegalArgumentException(\"Specified invalid registry ip from property:\" + Constants.DUBBO_IP_TO_REGISTRY + \", value:\" + hostToRegistry);\n\t}\n\t//è®¾ç½®å±æ€§ï¼šæ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒçš„ip\n\tmap.put(Constants.REGISTER_IP_KEY, hostToRegistry);\n\n\t//ä¿å­˜æ–¹æ³•å±æ€§åˆ°ç³»ç»Ÿä¸Šä¸‹æ–‡ä¸­\n\tStaticContext.getSystemContext().putAll(attributes);\n\t\n\t//æ ¹æ®æœåŠ¡æ¥å£åŠå…¶å±æ€§åˆ›å»ºä»£ç†(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\tref = createProxy(map);\n\t\n\t//æ„é€ ConsumerModelå¯¹è±¡,getUniqueServiceName()ç”Ÿæˆå”¯ä¸€æœåŠ¡åç§°\n\tConsumerModel consumerModel = new ConsumerModel(getUniqueServiceName(), this, ref, interfaceClass.getMethods());\n\t\n\t//æ ¹æ®æœåŠ¡åç§°æ³¨å†Œæ¶ˆè´¹è€…(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\tApplicationModel.initConsumerModel(getUniqueServiceName(), consumerModel);\n}\n```\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹ä¸Šé¢ä½¿ç”¨åˆ°çš„æ–¹æ³•\n\n##### checkDefaultæ–¹æ³•\nè·å–Consumerçš„å…¨å±€é…ç½®\n```java\nprivate void checkDefault() {\n        if (consumer == null) {\n\t    //consumerä¸ºç©ºï¼Œä¼šæ–°åˆ›å»ºä¸€ä¸ªConsumerConfigå¯¹è±¡\n            consumer = new ConsumerConfig();\n        }\n\t//è°ƒç”¨appendPropertiesæ–¹æ³•\n        appendProperties(consumer);\n}\n```\n##### appendPropertiesæ–¹æ³•\nè¯¥æ–¹æ³•åœ¨initæ–¹æ³•ä¸­å¤§é‡å‡ºç°ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸‹å®ƒçš„å®ç°ï¼Œå®ƒæ˜¯å®šä¹‰åœ¨AbstractConfigæŠ½è±¡ç±»ä¸­çš„é™æ€æ–¹æ³•ï¼Œå‚æ•°æ˜¯AbstractConfigç±»å‹ã€‚\n```java\n/**\n * é™„åŠ å±æ€§\n * æ‰¾åˆ°configçš„æ‰€æœ‰çš„setXXXæ–¹æ³•ï¼Œç„¶ååˆ‡å‰²å‡ºå±æ€§XXXï¼Œç„¶åä»ç³»ç»Ÿé…ç½®/dubboé…ç½®æ–‡ä»¶ä¸­è·å–åˆ°å±æ€§çš„å€¼ï¼Œ\n * ç„¶åæ‰§è¡ŒsetXXXæ–¹æ³•æŠŠå±æ€§å€¼è®¾ç½®åˆ°configå¯¹è±¡ä¸­\n * @param config\n */\nprotected static void appendProperties(AbstractConfig config) {\n\tif (config == null) {\n\t   //configä¸ºç©ºï¼Œç›´æ¥è¿”å›\n\t   return;\n\t}\n\t//ç”Ÿæˆå‰ç¼€ï¼Œå¦‚ï¼š dubbo.monitor.\n\tString prefix = \"dubbo.\" + getTagName(config.getClass()) + \".\";\n\t//è·å–configç±»çš„æ‰€æœ‰æ–¹æ³•\n\tMethod[] methods = config.getClass().getMethods();\n\t//éå†æ–¹æ³•åˆ—è¡¨\n\tfor (Method method : methods) {\n\t    try {\n\t\tString name = method.getName();\n\t\t//æ–¹æ³•åé•¿åº¦>3ï¼Œä»¥setå¼€å¤´ï¼Œä¿®é¥°ç¬¦æ˜¯publicï¼Œå‚æ•°ä¸ªæ•°=1ï¼Œå‚æ•°ç±»å‹æ˜¯åŸå§‹ç±»å‹\n\t\tif (name.length() > 3 && name.startsWith(\"set\") && Modifier.isPublic(method.getModifiers())\n\t\t\t&& method.getParameterTypes().length == 1 && isPrimitive(method.getParameterTypes()[0])) {\n\t\t    //è½¬æ¢æ–¹æ³•åç§°ä¸ºå±æ€§åç§°ï¼Œå¦‚ï¼šsetFirstNameå°†ä¼šè½¬æ¢æˆfirst.name\n\t\t    //ä¾‹å¦‚ï¼šproperty = default\n\t\t    String property = StringUtils.camelToSplitName(name.substring(3, 4).toLowerCase() + name.substring(4), \".\");\n\n\t\t    //1ã€ä»ç³»ç»Ÿé…ç½®ä¸­è·å–ï¼šprefix + id + property\n\t\t    //2ã€ä»ç³»ç»Ÿé…ç½®ä¸­è·å–ï¼šprefix + property\n\t\t    //3ã€ä»configç±»ä¸­æ‰¾åˆ°å±æ€§getæ–¹æ³•æˆ–è€…isæ–¹æ³•ï¼Œç„¶åæ‰§è¡Œè¯¥æ–¹æ³•\n\t\t\t//3.1ã€ä»configé…ç½®ä¸­è·å– prefix + id + propertyå±æ€§\n\t\t\t//3.2ã€ä»configé…ç½®ä¸­è·å– prefix + propertyå±æ€§\n\t\t\t//3.3ã€æ ¹æ®prefix + propertyè·å–æ—§ç‰ˆå±æ€§legacyKey,ç„¶åæ ¹æ®legacyKeyä»configé…ç½®ä¸­è·å–\n\t\t    //ConfigUtils.getProperty(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\t\t    //å¦‚æœå±æ€§å€¼valueä¸ä¸ºç©ºçš„è¯ï¼Œåˆ™è°ƒç”¨è¯¥setæ–¹æ³•ï¼Œå°†å±æ€§è®¾ç½®åˆ°configå¯¹è±¡ä¸­ï¼Œæ•´ä¸ªæ–¹æ³•æµç¨‹æ‰§è¡Œç»“æŸ\n\t\t\t\n\t\t    String value = null;\n\t\t    if (config.getId() != null && config.getId().length() > 0) {\n\t\t\t//å¦‚æœidå±æ€§ä¸ä¸ºç©ºï¼Œåˆ™å±æ€§åç§°ä¸ºï¼šprefix + id + property\n\t\t\t//ä¾‹å¦‚ï¼špn = dubbo.monitor.\"id\".default\n\t\t\tString pn = prefix + config.getId() + \".\" + property;\n\t\t\t//ä»ç³»ç»Ÿé…ç½®ä¸­è·å–å±æ€§pnçš„å€¼value\n\t\t\tvalue = System.getProperty(pn);\n\t\t\tif (!StringUtils.isBlank(value)) {\n\t\t\t    //å¦‚æœç³»ç»Ÿä¸­è®¾ç½®äº†pnå±æ€§ï¼Œåˆ™ä½¿ç”¨è¯¥å±æ€§å€¼\n\t\t\t    logger.info(\"Use System Property \" + pn + \" to config dubbo\");\n\t\t\t}\n\t\t    }\n\t\t    if (value == null || value.length() == 0) {\n\t\t\t//å±æ€§åç§°ä¸ºï¼šprefix + property\n\t\t\t//ä¾‹å¦‚ï¼šdubbo.monitor.default\n\t\t\tString pn = prefix + property;\n\t\t\t//è·å–å±æ€§pnçš„ç³»ç»Ÿå±æ€§å€¼value\n\t\t\tvalue = System.getProperty(pn);\n\t\t\tif (!StringUtils.isBlank(value)) {\n\t\t\t    logger.info(\"Use System Property \" + pn + \" to config dubbo\");\n\t\t\t}\n\t\t    }\n\t\t    if (value == null || value.length() == 0) {\n\t\t\tMethod getter;\n\t\t\ttry {\n\t\t\t    //è·å–å½“å‰å±æ€§çš„getæ–¹æ³•\n\t\t\t    getter = config.getClass().getMethod(\"get\" + name.substring(3), new Class<?>[0]);\n\t\t\t} catch (NoSuchMethodException e) {\n\t\t\t    try {\n\t\t\t\t//getæ–¹æ³•ä¸å­˜åœ¨çš„è¯ï¼Œåˆ™è·å–ä¸‹isæ–¹æ³•\n\t\t\t\tgetter = config.getClass().getMethod(\"is\" + name.substring(3), new Class<?>[0]);\n\t\t\t    } catch (NoSuchMethodException e2) {\n\t\t\t\tgetter = null;\n\t\t\t    }\n\t\t\t}\n\t\t\tif (getter != null) {\n\t\t\t    //æ‰§è¡Œconfigå¯¹è±¡çš„å±æ€§çš„getteræ–¹æ³•ï¼Œç»“æœä¸ºç©ºçš„è¯\n\t\t\t    if (getter.invoke(config, new Object[0]) == null) {\n\t\t\t\tif (config.getId() != null && config.getId().length() > 0) {\n\t\t\t\t    //idå±æ€§ä¸ä¸ºç©º\n\t\t\t\t    //å¦‚ï¼šdubbo.monitor.\"id\".default\n\t\t\t\t    value = ConfigUtils.getProperty(prefix + config.getId() + \".\" + property);\n\t\t\t\t}\n\t\t\t\tif (value == null || value.length() == 0) {\n\t\t\t\t    //å¦‚ï¼šdubbo.monitor.default\n\t\t\t\t    value = ConfigUtils.getProperty(prefix + property);\n\t\t\t\t}\n\t\t\t\tif (value == null || value.length() == 0) {\n\t\t\t\t    //ä»æ—§ç‰ˆå±æ€§ä¸­è·å–(å¦‚ï¼šdubbo.monitor.default)\n\t\t\t\t    String legacyKey = legacyProperties.get(prefix + property);\n\t\t\t\t    if (legacyKey != null && legacyKey.length() > 0) {\n\t\t\t\t\t//è½¬æ¢æ—§ç‰ˆå±æ€§å€¼\n\t\t\t\t\tvalue = convertLegacyValue(legacyKey, ConfigUtils.getProperty(legacyKey));\n\t\t\t\t    }\n\t\t\t\t}\n\n\t\t\t    }\n\t\t\t}\n\t\t    }\n\t\t    if (value != null && value.length() > 0) {\n\t\t\t//å¦‚æœå±æ€§å€¼ä¸ä¸ºç©ºçš„è¯ï¼Œåˆ™ä½¿ç”¨å±æ€§å€¼ä½œä¸ºå‚æ•°æ‰§è¡Œconfigç±»çš„methodæ–¹æ³•\n\t\t\tmethod.invoke(\n\t\t\t\tconfig,\n\t\t\t\tnew Object[]{\n\t\t\t\t\t//è½¬æ¢åŸå§‹ç±»å‹\n\t\t\t\t\tconvertPrimitive(method.getParameterTypes()[0], value)\n\t\t\t\t}\n\n\t\t\t);\n\t\t    }\n\t\t}\n\t    } catch (Exception e) {\n\t\tlogger.error(e.getMessage(), e);\n\t    }\n\t}\n}\n```\n\n##### checkInterfaceAndMethodsæ–¹æ³•\n```java\n/**\n* åˆ¤æ–­æ–¹æ³•methodsæ˜¯å¦éƒ½åœ¨æœåŠ¡æ¥å£ç±»ä¸­å­˜åœ¨\n* @param interfaceClass æœåŠ¡æ¥å£ç±»\n* @param methods å¼•ç”¨çš„æœåŠ¡æ¥å£æ–¹æ³•\n*/\nprotected void checkInterfaceAndMethods(Class<?> interfaceClass, List<MethodConfig> methods) {\n\tif (interfaceClass == null) {\n\t    //æœåŠ¡æ¥å£ä¸å¯ä»¥ä¸ºç©º\n\t    throw new IllegalStateException(\"interface not allow null!\");\n\t}\n\tif (!interfaceClass.isInterface()) {\n\t    // interfaceClasså¿…é¡»ä¸ºæ¥å£ç±»å‹\n\t    throw new IllegalStateException(\"The interface class \" + interfaceClass + \" is not a interface!\");\n\t}\n\t// æ£€æŸ¥methodsæ–¹æ³•æ˜¯å¦å­˜åœ¨äºinterfaceClassæ¥å£ä¸­\n\tif (methods != null && !methods.isEmpty()) {\n\t    //éå†å¼•ç”¨çš„æ–¹æ³•\n\t    for (MethodConfig methodBean : methods) {\n\t\t//æ–¹æ³•å\n\t\tString methodName = methodBean.getName();\n\t\tif (methodName == null || methodName.length() == 0) {\n\t\t    //<dubbo:method>æ ‡ç­¾çš„nameå±æ€§å¿…é¡»è®¾ç½®\n\t\t    throw new IllegalStateException(\"<dubbo:method> name attribute is required! Please check: <dubbo:service interface=\\\"\" + interfaceClass.getName() + \"\\\" ... ><dubbo:method name=\\\"\\\" ... /></<dubbo:reference>\");\n\t\t}\n\t\tboolean hasMethod = false;\n\t\tfor (java.lang.reflect.Method method : interfaceClass.getMethods()) {\n\t\t    //æ–¹æ³•åä¸€æ ·ï¼Œåˆ™è®¤ä¸ºå­˜åœ¨è¯¥æ–¹æ³•\n\t\t    if (method.getName().equals(methodName)) {\n\t\t\thasMethod = true;\n\t\t\tbreak;\n\t\t    }\n\t\t}\n\t\tif (!hasMethod) {\n\t\t    //å¼•ç”¨çš„æ–¹æ³•åœ¨æœåŠ¡æ¥å£ä¸­ä¸å­˜åœ¨\n\t\t    throw new IllegalStateException(\"The interface \" + interfaceClass.getName()\n\t\t\t    + \" not found method \" + methodName);\n\t\t}\n\t    }\n\t}\n}\n```\n##### checkApplicationæ–¹æ³•\nè¯¥æ–¹æ³•ç”¨æ¥éªŒè¯application,applicationä¸ºç©ºçš„è¯ï¼Œä¼šæ–°å»ºApplicationConfigå¯¹è±¡\n```java\nprotected void checkApplication() {\n\t// å¤„ç†å…¼å®¹\n\tif (application == null) {\n\t    //ä»é…ç½®æ–‡ä»¶ä¸­åŠ è½½application.nameå±æ€§\n\t    String applicationName = ConfigUtils.getProperty(\"dubbo.application.name\");\n\t    if (applicationName != null && applicationName.length() > 0) {\n\t\t//æ–°åˆ›å»ºä¸€ä¸ªApplicationConfigå¯¹è±¡\n\t\tapplication = new ApplicationConfig();\n\t    }\n\t}\n\tif (application == null) {\n\t    //éœ€è¦é…ç½® <dubbo:application name=\\\"...\\\" />\n\t    throw new IllegalStateException(\n\t\t    \"No such application config! Please add <dubbo:application name=\\\"...\\\" /> to your spring config.\");\n\t}\n\t//æ·»åŠ applicationçš„å±æ€§\n\tappendProperties(application);\n\t//è·å–é…ç½®: æœåŠ¡åœæ­¢æ—¶çš„ç­‰å¾…æ—¶é—´(ä¼˜å…ˆè·å–SHUTDOWN_WAIT_KEYå±æ€§ï¼Œåœ¨è·å–SHUTDOWN_WAIT_SECONDS_KEY(åºŸå¼ƒ))\n\tString wait = ConfigUtils.getProperty(Constants.SHUTDOWN_WAIT_KEY);\n\tif (wait != null && wait.trim().length() > 0) {\n\t    //è®¾ç½®åˆ°ç³»ç»Ÿé…ç½®ä¸­\n\t    System.setProperty(Constants.SHUTDOWN_WAIT_KEY, wait.trim());\n\t} else {\n\t    wait = ConfigUtils.getProperty(Constants.SHUTDOWN_WAIT_SECONDS_KEY);\n\t    if (wait != null && wait.trim().length() > 0) {\n\t\tSystem.setProperty(Constants.SHUTDOWN_WAIT_SECONDS_KEY, wait.trim());\n\t    }\n\t}\n}\n```\n\n##### checkStubAndMockæ–¹æ³•\nè¯¥æ–¹æ³•ç”¨æ¥æ£€æµ‹: æœåŠ¡æ¥å£æœ¬åœ°å®ç°ç±»ã€æœåŠ¡æ¥å£æœ¬åœ°å­˜æ ¹ç±»ã€mock\n```java\n/**\n* æ£€æµ‹local/stub/mockçš„é…ç½®æ˜¯å¦æ­£ç¡®\n* local/stub/mock(mock å¯é…ç½®ä¸º\"return \")åº”è¯¥ä¸ºinterfaceClassæˆ–è€…ä¸ºinterfaceClasså­ç±»\n* @param interfaceClass æœåŠ¡æ¥å£ç±»\n*/\nprotected void checkStubAndMock(Class<?> interfaceClass) {\n\t//å¤„ç†æœåŠ¡æ¥å£æœ¬åœ°å®ç°ç±»\n\tif (ConfigUtils.isNotEmpty(local)) {\n\t    //å¦‚æœlocal = trueæˆ–è€…local = default(å³localå±æ€§é…ç½®),åˆ™æœ¬åœ°å®ç°ç±»åä¸ºï¼šæ¥å£åç§°+Local,å¦åˆ™æœ¬åœ°å®ç°ç±»åä¸ºï¼šlocalå±æ€§\n\t    //åŠ è½½æœ¬åœ°å®ç°ç±»\n\t    Class<?> localClass = ConfigUtils.isDefault(local) ? ReflectUtils.forName(interfaceClass.getName() + \"Local\") : ReflectUtils.forName(local);\n\t    //æ£€æŸ¥æœ¬åœ°å®ç°ç±»æ˜¯å¦å®ç°äº†æœåŠ¡æ¥å£\n\t    if (!interfaceClass.isAssignableFrom(localClass)) {\n\t\tthrow new IllegalStateException(\"The local implementation class \" + localClass.getName() + \" not implement interface \" + interfaceClass.getName());\n\t    }\n\t    try {\n\t\t//æ£€æµ‹æœ¬åœ°å®ç°ç±»ä¸­æ˜¯å¦å­˜åœ¨ç›¸åº”çš„æ„é€ æ–¹æ³•ï¼Œå³ï¼špublic æœ¬åœ°å®ç°ç±»å (æœåŠ¡æ¥å£å){}\n\t\tReflectUtils.findConstructor(localClass, interfaceClass);\n\t    } catch (NoSuchMethodException e) {\n\t\tthrow new IllegalStateException(\"No such constructor \\\"public \" + localClass.getSimpleName() + \"(\" + interfaceClass.getName() + \")\\\" in local implementation class \" + localClass.getName());\n\t    }\n\t}\n\t//å¤„ç†æœåŠ¡æ¥å£æœ¬åœ°å­˜æ ¹ç±»\n\tif (ConfigUtils.isNotEmpty(stub)) {\n\t    //å¦‚æœstub = trueæˆ–è€…stub = default(å³stubå±æ€§)ï¼Œåˆ™æœ¬åœ°å­˜æ ¹ç±»åä¸ºï¼šæ¥å£åç§°+Stub,å¦åˆ™æœ¬åœ°å­˜æ ¹ç±»åä¸ºï¼šstubå±æ€§\n\t    //åŠ è½½æœ¬åœ°å­˜æ ¹ç±»\n\t    Class<?> localClass = ConfigUtils.isDefault(stub) ? ReflectUtils.forName(interfaceClass.getName() + \"Stub\") : ReflectUtils.forName(stub);\n\t    //æ£€æµ‹æœ¬åœ°å­˜æ ¹ç±»æ˜¯å¦å®ç°äº†æœåŠ¡æ¥å£\n\t    if (!interfaceClass.isAssignableFrom(localClass)) {\n\t\tthrow new IllegalStateException(\"The local implementation class \" + localClass.getName() + \" not implement interface \" + interfaceClass.getName());\n\t    }\n\t    try {\n\t\t//æ£€æµ‹æœ¬åœ°å­˜æ ¹ç±»æ˜¯å¦å­˜åœ¨ç›¸åº”çš„æ„é€ æ–¹æ³•, å³ï¼špublic æœ¬åœ°å­˜æ ¹ç±»å (æœåŠ¡æ¥å£å){}\n\t\tReflectUtils.findConstructor(localClass, interfaceClass);\n\t    } catch (NoSuchMethodException e) {\n\t\tthrow new IllegalStateException(\"No such constructor \\\"public \" + localClass.getSimpleName() + \"(\" + interfaceClass.getName() + \")\\\" in local implementation class \" + localClass.getName());\n\t    }\n\t}\n\t//å¤„ç†mock\n\tif (ConfigUtils.isNotEmpty(mock)) {\n\t    //åˆ¤æ–­mockå±æ€§æ˜¯å¦ä»¥\"return \"å¼€å¤´\n\t    if (mock.startsWith(Constants.RETURN_PREFIX)) {\n\t\t//è·å–åˆ°\"return \"ä¹‹åçš„å€¼\n\t\tString value = mock.substring(Constants.RETURN_PREFIX.length());\n\t\ttry {\n\t\t    //è§£æmockå€¼\n\t\t    MockInvoker.parseMockValue(value);\n\t\t} catch (Exception e) {\n\t\t    throw new IllegalStateException(\"Illegal mock json value in <dubbo:service ... mock=\\\"\" + mock + \"\\\" />\");\n\t\t}\n\t    } else {\n\t\t//è·å–mockç±»\n\t\t//å¦‚æœmock = trueæˆ–è€…mock = default(å³mockå±æ€§)ï¼Œåˆ™æœ¬åœ°å­˜æ ¹ç±»åä¸ºï¼šæ¥å£åç§°+Mock,å¦åˆ™æœ¬åœ°å­˜æ ¹ç±»åä¸ºï¼šmockå±æ€§\n\t\tClass<?> mockClass = ConfigUtils.isDefault(mock) ? ReflectUtils.forName(interfaceClass.getName() + \"Mock\") : ReflectUtils.forName(mock);\n\t\t//æ£€æµ‹mockç±»æ˜¯å¦å®ç°äº†æœåŠ¡æ¥å£\n\t\tif (!interfaceClass.isAssignableFrom(mockClass)) {\n\t\t    throw new IllegalStateException(\"The mock implementation class \" + mockClass.getName() + \" not implement interface \" + interfaceClass.getName());\n\t\t}\n\t\ttry {\n\t\t    //æ£€æµ‹é»˜è®¤æ„é€ æ–¹æ³•ï¼Œå³ï¼špulic mockç±»å () {}\n\t\t    mockClass.getConstructor(new Class<?>[0]);\n\t\t} catch (NoSuchMethodException e) {\n\t\t    throw new IllegalStateException(\"No such empty constructor \\\"public \" + mockClass.getSimpleName() + \"()\\\" in mock implementation class \" + mockClass.getName());\n\t\t}\n\t    }\n\t}\n}\n```\n##### appendParametersæ–¹æ³•\n```java\n/**\n* é™„åŠ å‚æ•°\n* 1ã€è·å–configå¯¹è±¡çš„æ–¹æ³•åˆ—è¡¨ï¼Œ\n* 2ã€æ‰¾åˆ°getXXXæˆ–è€…isXXXæ–¹æ³•æˆ–è€…getParametersæ–¹æ³•(ä¼šé€šè¿‡æ–¹æ³•ä¸Šçš„@Parameteræ³¨è§£åˆ¤æ–­æ˜¯å¦éœ€è¦è¿‡æ»¤è¯¥å±æ€§)\n* 3ã€ç„¶åæ‰§è¡Œè¯¥æ–¹æ³•ï¼Œæ‹¿åˆ°æ–¹æ³•è¿”å›å€¼(ä¼šé€šè¿‡æ–¹æ³•ä¸Šçš„@Parameteræ³¨è§£åˆ¤æ–­æ˜¯å¦éœ€è¦ç¼–ç åŠè¿½åŠ )ã€‚\n* ç„¶åå°†å±æ€§(@Parameteræ³¨è§£é…ç½®æˆ–è€…é€šè¿‡getXXXè·å–ï¼Œå¦‚æœé…ç½®äº†prefixï¼Œåˆ™å±æ€§ä¸º: prefix.å±æ€§)\n* ä»¥åŠå€¼ä¿å­˜åˆ°parametersä¸­\n*\n* @param parameters å½“å‰å‚æ•°Map\n* @param config  ç›®æ ‡é…ç½®å¯¹è±¡\n* @param prefix å±æ€§é…ç½®å‰ç¼€\n*/\nprotected static void appendParameters(Map<String, String> parameters, Object config, String prefix) {\n\tif (config == null) {\n\t    return;\n\t}\n\t//è·å–é…ç½®ç±»configçš„æ‰€æœ‰æ–¹æ³•\n\tMethod[] methods = config.getClass().getMethods();\n\tfor (Method method : methods) {\n\t    try {\n\t\tString name = method.getName();\n\t\t//æ–¹æ³•åä»¥getæˆ–è€…iså¼€å¤´ï¼Œå¹¶ä¸”æ–¹æ³•åä¸ä¸ºgetClassï¼Œå¹¶ä¸”å­˜åœ¨publicä¿®é¥°ç¬¦\n\t\t//å¹¶ä¸”ä¸å­˜åœ¨å‚æ•°ï¼Œå¹¶ä¸”æ–¹æ³•è¿”å›ç±»å‹ä¸ºåŸå§‹ç±»å‹\n\t\tif ((name.startsWith(\"get\") || name.startsWith(\"is\"))\n\t\t\t&& !\"getClass\".equals(name)\n\t\t\t&& Modifier.isPublic(method.getModifiers())\n\t\t\t&& method.getParameterTypes().length == 0\n\t\t\t&& isPrimitive(method.getReturnType())) {\n\t\t    //è·å–æ–¹æ³•ä¸Šçš„@Parameteræ³¨è§£\n\t\t    Parameter parameter = method.getAnnotation(Parameter.class);\n\t\t    if (method.getReturnType() == Object.class || parameter != null && parameter.excluded()) {\n\t\t\t//å¦‚æœå½“å‰æ–¹æ³•çš„è¿”å›ç±»å‹ä¸ºObjectï¼Œæˆ–è€…è¯¥æ–¹æ³•å­˜åœ¨@Parameteræ³¨è§£ä¸”excludedå±æ€§å€¼ä¸ºtrue\n\t\t\t//åˆ™è·³è¿‡è¯¥æ–¹æ³•ï¼Œå³å¿½ç•¥è¯¥å±æ€§\n\t\t\tcontinue;\n\t\t    }\n\t\t    int i = name.startsWith(\"get\") ? 3 : 2;\n\t\t    //æ ¹æ®æ–¹æ³•åè·å–åˆ°å±æ€§åï¼Œå¦‚ï¼šgetFirstNameè¢«è½¬æ¢æˆï¼šfirst.name\n\t\t    String prop = StringUtils.camelToSplitName(name.substring(i, i + 1).toLowerCase() + name.substring(i + 1), \".\");\n\t\t    //keyä¸º@Parameteræ³¨è§£çš„keyå±æ€§æˆ–è€…ä¸ºæ ¹æ®å½“å‰æ–¹æ³•åæˆªå–åˆ°çš„å±æ€§å\n\t\t    String key;\n\t\t    if (parameter != null && parameter.key() != null && parameter.key().length() > 0) {\n\t\t\t//å¦‚æœ@Parameteræ³¨è§£çš„keyå±æ€§ä¸ä¸ºç©ºï¼Œåˆ™ä½¿ç”¨keyå±æ€§\n\t\t\tkey = parameter.key();\n\t\t    } else {\n\t\t\t//å¦åˆ™ä½¿ç”¨propä½œä¸ºkey\n\t\t\tkey = prop;\n\t\t    }\n\t\t    //æ‰§è¡Œconfigå¯¹è±¡çš„methodæ–¹æ³•ï¼Œè·å–åˆ°æ–¹æ³•è¿”å›å€¼\n\t\t    Object value = method.invoke(config, new Object[0]);\n\t\t    //å°†æ–¹æ³•è¿”å›å€¼è½¬æ¢æˆå­—ç¬¦ä¸²ï¼Œå¹¶å»æ‰ç©ºæ ¼\n\t\t    String str = String.valueOf(value).trim();\n\t\t    if (value != null && str.length() > 0) {\n\t\t\t//æ–¹æ³•è¿”å›å€¼ä¸ä¸ºç©º\n\t\t\tif (parameter != null && parameter.escaped()) {\n\t\t\t    //æ ¹æ®@Parameteræ³¨è§£çš„escapedå±æ€§æ¥å†³å®šæ˜¯å¦éœ€è¦å¯¹å±æ€§å€¼è¿›è¡Œç¼–ç \n\t\t\t    str = URL.encode(str);\n\t\t\t}\n\t\t\tif (parameter != null && parameter.append()) {\n\t\t\t    //å¦‚æœé…ç½®äº†@Parameteræ³¨è§£çš„appendå±æ€§ä¸ºtrue\n\t\t\t    //åˆ™ä»å‚æ•°Mapä¸­è·å–keyå¯¹åº”çš„å€¼pre\n\t\t\t    String pre = parameters.get(Constants.DEFAULT_KEY + \".\" + key);\n\t\t\t    if (pre != null && pre.length() > 0) {\n\t\t\t\t//è¿½åŠ æ–¹æ³•è¿”å›å€¼\n\t\t\t\tstr = pre + \",\" + str;\n\t\t\t    }\n\t\t\t    pre = parameters.get(key);\n\t\t\t    if (pre != null && pre.length() > 0) {\n\t\t\t\t//è¿½åŠ æ–¹æ³•è¿”å›å€¼\n\t\t\t\tstr = pre + \",\" + str;\n\t\t\t    }\n\t\t\t}\n\t\t\tif (prefix != null && prefix.length() > 0) {\n\t\t\t    //å¦‚æœå‰ç¼€ä¸ä¸ºç©ºï¼Œåˆ™æ‹¼æ¥key\n\t\t\t    key = prefix + \".\" + key;\n\t\t\t}\n\t\t\t//å°†keyã€valueä¿å­˜åˆ°å‚æ•°Mapä¸­\n\t\t\tparameters.put(key, str);\n\t\t    } else if (parameter != null && parameter.required()) {\n\t\t\t//å¦‚æœæ–¹æ³•è¿”å›å€¼ä¸ºç©ºï¼Œä¸”@Parameteræ³¨è§£çš„requiredå±æ€§ä¸ºtrue\n\t\t\t//åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œæç¤ºconfigç±»çš„keyå±æ€§çš„å€¼ä¸ºç©º\n\t\t\tthrow new IllegalStateException(config.getClass().getSimpleName() + \".\" + key + \" == null\");\n\t\t    }\n\t\t} else if (\"getParameters\".equals(name)\n\t\t\t&& Modifier.isPublic(method.getModifiers())\n\t\t\t&& method.getParameterTypes().length == 0\n\t\t\t&& method.getReturnType() == Map.class) {\n\t\t    //æ–¹æ³•åç§°ä¸ºgetParametersï¼Œä¸”æ–¹æ³•æœ‰publicä¿®é¥°ç¬¦ï¼Œä¸”å‚æ•°ä¸ºç©ºï¼Œä¸”æ–¹æ³•è¿”å›å€¼ä¸ºMap\n\t\t    //åˆ™æ‰§è¡Œconfigå¯¹è±¡çš„getParametersæ–¹æ³•ï¼Œè·å–åˆ°è¿”å›å€¼Map\n\t\t    Map<String, String> map = (Map<String, String>) method.invoke(config, new Object[0]);\n\t\t    if (map != null && map.size() > 0) {\n\t\t\t//æ ¼å¼åŒ–å‰ç¼€ï¼Œå‰ç¼€ä»¥â€œ.â€ç»“å°¾\n\t\t\tString pre = (prefix != null && prefix.length() > 0 ? prefix + \".\" : \"\");\n\t\t\t//éå†getParametersæ–¹æ³•è¿”å›å€¼\n\t\t\tfor (Map.Entry<String, String> entry : map.entrySet()) {\n\t\t\t    //å°†å±æ€§ä»¥åŠå±æ€§å€¼ä¿å­˜åˆ°parametersä¸­\n\t\t\t    parameters.put(pre + entry.getKey().replace('-', '.'), entry.getValue());\n\t\t\t}\n\t\t    }\n\t\t}\n\t    } catch (Exception e) {\n\t\tthrow new IllegalStateException(e.getMessage(), e);\n\t    }\n\t}\n}\n```\n\n##### appendAttributesæ–¹æ³•\n```java\n/**\n* é™„åŠ å±æ€§\n* 1ã€è·å–configå¯¹è±¡çš„getXXXæˆ–è€…isXXXæ–¹æ³•(ä¼šé€šè¿‡æ–¹æ³•ä¸Šçš„@Parameteræ³¨è§£åˆ¤æ–­æ˜¯å¦éœ€è¦è¿‡æ»¤è¯¥å±æ€§)ï¼Œ\n* ç„¶åè°ƒç”¨è¯¥æ–¹æ³•è·å–è¿”å›å€¼valueã€‚\n* 2ã€ç„¶åæ ¹æ®@Parameteræ³¨è§£çš„keyå±æ€§æˆ–è€…å½“å‰æ–¹æ³•åç§°(å–æ¶ˆget/iså‰ç¼€)ä½œä¸ºkeyï¼ˆprefix+\".\"+keyï¼‰ï¼Œ\n* 3ã€æœ€ç»ˆå°†keyå’Œvalueä¿å­˜åˆ°parametersä¸­\n* @param parameters ä¿å­˜æ–¹æ³•å±æ€§\n* @param config MethodConfigç­‰å¯¹è±¡\n* @param prefix\n*/\nprotected static void appendAttributes(Map<Object, Object> parameters, Object config, String prefix) {\n\tif (config == null) {\n\t    return;\n\t}\n\tMethod[] methods = config.getClass().getMethods();\n\t//éå†configå¯¹è±¡çš„æ–¹æ³•\n\tfor (Method method : methods) {\n\t    try {\n\t\t//æ–¹æ³•å\n\t\tString name = method.getName();\n\t\t//æ‰¾åˆ°getæ–¹æ³•æˆ–è€…isæ–¹æ³•\n\t\tif ((name.startsWith(\"get\") || name.startsWith(\"is\"))\n\t\t\t&& !\"getClass\".equals(name)\n\t\t\t&& Modifier.isPublic(method.getModifiers())\n\t\t\t&& method.getParameterTypes().length == 0\n\t\t\t&& isPrimitive(method.getReturnType())) {\n\t\t    //è·å–æ–¹æ³•ä¸Šçš„@Parameteræ³¨è§£\n\t\t    Parameter parameter = method.getAnnotation(Parameter.class);\n\t\t    if (parameter == null || !parameter.attribute()) {\n\t\t\t//å¦‚æœè¯¥æ–¹æ³•æ²¡æœ‰@Parameteræ³¨è§£ï¼Œæˆ–è€…@Parameteræ³¨è§£çš„attributeå±æ€§ä¸ºfalse\n\t\t\t//åˆ™è·³è¿‡è¯¥æ–¹æ³•\n\t\t\tcontinue;\n\t\t    }\n\t\t    //ä¼˜å…ˆè·å–@Parameteræ³¨è§£çš„keyå±æ€§ï¼Œå¦åˆ™è·å–å½“å‰æ–¹æ³•å(å»æ‰getæˆ–è€…iså‰ç¼€)\n\t\t    String key;\n\t\t    if (parameter.key() != null && parameter.key().length() > 0) {\n\t\t\tkey = parameter.key();\n\t\t    } else {\n\t\t\tint i = name.startsWith(\"get\") ? 3 : 2;\n\t\t\tkey = name.substring(i, i + 1).toLowerCase() + name.substring(i + 1);\n\t\t    }\n\t\t    //æ‰§è¡Œconfigå¯¹è±¡çš„å½“å‰æ–¹æ³•ï¼Œè·å–æ–¹æ³•è¿”å›å€¼\n\t\t    Object value = method.invoke(config, new Object[0]);\n\t\t    if (value != null) {\n\t\t\tif (prefix != null && prefix.length() > 0) {\n\t\t\t    //å‰ç¼€ä¸ä¸ºç©ºçš„è¯ï¼Œæ‹¼æ¥ä¸Šå‰ç¼€\n\t\t\t    key = prefix + \".\" + key;\n\t\t\t}\n\t\t\t//å°†å±æ€§å’Œå±æ€§å€¼æ”¾åˆ°parametersä¸­\n\t\t\tparameters.put(key, value);\n\t\t    }\n\t\t}\n\t    } catch (Exception e) {\n\t\tthrow new IllegalStateException(e.getMessage(), e);\n\t    }\n\t}\n}\n```\n##### checkAndConvertImplicitConfigæ–¹æ³•\n```java\n/**\n* å¤„ç†onreturnã€onthrowã€oninvokeå±æ€§ï¼Œå°†attributesä¸­çš„valueï¼Œä»\"æ–¹æ³•åç§°\"è½¬æ¢æˆ\"æ–¹æ³•å¯¹è±¡\"\n* å¦‚ï¼šå°†<onReturnMethodKey,onReturnMethodæ–¹æ³•å>è½¬æ¢ä¸º<onReturnMethodKey,onReturnMethodæ–¹æ³•å¯¹è±¡>\n* @param method å½“å‰æ–¹æ³•é…ç½®\n* @param map å½“å‰æ‰€æœ‰å±æ€§map\n* @param attributes å½“å‰æ–¹æ³•çš„å±æ€§map\n*/\nprivate static void checkAndConvertImplicitConfig(MethodConfig method, Map<String, String> map, Map<Object, Object> attributes) {\n\t//æ£€æµ‹é…ç½®å†²çª\n\tif (Boolean.FALSE.equals(method.isReturn()) && (method.getOnreturn() != null || method.getOnthrow() != null)) {\n\t    //å½“è®¾ç½®äº†onreturnæˆ–è€…onthrowæ—¶ï¼Œå¿…é¡»åŒæ—¶è®¾ç½®isReturnä¸ºtrue\n\t    throw new IllegalStateException(\"method config error : return attribute must be set true when onreturn or onthrow has been setted.\");\n\t}\n\n\t//attributeså­˜çš„æ˜¯<onReturnMethodKey,onReturnMethodæ–¹æ³•å>\n\t//ç»è¿‡è½¬æ¢åå­˜çš„æ˜¯<onReturnMethodKey,onReturnMethodæ–¹æ³•ç±»>\n\n\t//onReturnMethodKeyæ˜¯å±æ€§key\n\tString onReturnMethodKey = StaticContext.getKey(map, method.getName(), Constants.ON_RETURN_METHOD_KEY);\n\t//ä»attributesä¸­è·å–å±æ€§onReturnMethodKeyå¯¹åº”çš„å€¼(æ–¹æ³•å)\n\tObject onReturnMethod = attributes.get(onReturnMethodKey);\n\tif (onReturnMethod != null && onReturnMethod instanceof String) {\n\t    //getMethodByNameæ–¹æ³•æ ¹æ®æ–¹æ³•åonReturnMethodä»ç±»method.getOnreturn().getClass()ä¸­æ‰¾åˆ°ç›¸åº”çš„æ–¹æ³•\n\t    attributes.put(onReturnMethodKey, getMethodByName(method.getOnreturn().getClass(), onReturnMethod.toString()));\n\t}\n\t//ä¸‹é¢çš„ç±»ä¼¼\n\t//convert onthrow methodName to Method\n\tString onThrowMethodKey = StaticContext.getKey(map, method.getName(), Constants.ON_THROW_METHOD_KEY);\n\tObject onThrowMethod = attributes.get(onThrowMethodKey);\n\tif (onThrowMethod != null && onThrowMethod instanceof String) {\n\t    attributes.put(onThrowMethodKey, getMethodByName(method.getOnthrow().getClass(), onThrowMethod.toString()));\n\t}\n\t//convert oninvoke methodName to Method\n\tString onInvokeMethodKey = StaticContext.getKey(map, method.getName(), Constants.ON_INVOKE_METHOD_KEY);\n\tObject onInvokeMethod = attributes.get(onInvokeMethodKey);\n\tif (onInvokeMethod != null && onInvokeMethod instanceof String) {\n\t    attributes.put(onInvokeMethodKey, getMethodByName(method.getOninvoke().getClass(), onInvokeMethod.toString()));\n\t}\n}\n```\n\n##### StaticContextç±»\ninitæ–¹æ³•ä¸­ï¼Œæœ€ç»ˆä¼šå°†æ–¹æ³•çš„å±æ€§æ·»åŠ åˆ°StaticContextä¸­\n```java\nStaticContext.getSystemContext().putAll(attributes);\n\n\n/**\n * ç³»ç»Ÿä¸Šä¸‹æ–‡ï¼Œåªæ˜¯æ¡†æ¶å†…éƒ¨ä½¿ç”¨\n * System context, for internal use only\n */\npublic class StaticContext extends ConcurrentHashMap<Object, Object> {\n    private static final long serialVersionUID = 1L;\n    private static final String SYSTEMNAME = \"system\";\n    private static final ConcurrentMap<String, StaticContext> context_map = new ConcurrentHashMap<String, StaticContext>();\n    private String name;\n\n    private StaticContext(String name) {\n        super();\n        this.name = name;\n    }\n\n    /**\n     * è·å–ç³»ç»Ÿä¸Šä¸‹æ–‡,å³keyä¸ºsystem\n     * @return\n     */\n    public static StaticContext getSystemContext() {\n        return getContext(SYSTEMNAME);\n    }\n\n    /**\n     * æ ¹æ®nameè·å–ä¸Šä¸‹æ–‡\n     * @param name\n     * @return\n     */\n    public static StaticContext getContext(String name) {\n        //é€šè¿‡nameä»context_mapä¸­è·å–StaticContext\n        StaticContext appContext = context_map.get(name);\n        if (appContext == null) {\n            //æ²¡æœ‰è·å–åˆ°StaticContextï¼Œåˆ™ä¸ºnameæ–°å»ºä¸€ä¸ªStaticContextï¼Œç„¶åæ”¾å…¥context_mapä¸­\n            appContext = context_map.putIfAbsent(name, new StaticContext(name));\n            if (appContext == null) {\n                appContext = context_map.get(name);\n            }\n        }\n        return appContext;\n    }\n\n    /**\n     * ä»context_mapä¸­ç§»é™¤nameå¯¹åº”çš„ä¸Šä¸‹æ–‡\n     * @param name\n     * @return\n     */\n    public static StaticContext remove(String name) {\n        return context_map.remove(name);\n    }\n\n    public static String getKey(URL url, String methodName, String suffix) {\n        return getKey(url.getServiceKey(), methodName, suffix);\n    }\n\n    public static String getKey(Map<String, String> paras, String methodName, String suffix) {\n        return getKey(StringUtils.getServiceKey(paras), methodName, suffix);\n    }\n\n    /**\n     * è·å–å”¯ä¸€æ ‡è¯†\n     * @param servicekey æœåŠ¡å”¯ä¸€æ ‡è¯†\n     * @param methodName æ–¹æ³•å\n     * @param suffix  å‰ç¼€\n     * @return\n     */\n    private static String getKey(String servicekey, String methodName, String suffix) {\n        StringBuffer sb = new StringBuffer().append(servicekey).append(\".\").append(methodName).append(\".\").append(suffix);\n        return sb.toString();\n    }\n\n    public String getName() {\n        return name;\n    }\n}\n```\n\n##### getUniqueServiceNameæ–¹æ³•\n```java\n/**\n* è·å–å”¯ä¸€æœåŠ¡åç§°ï¼ˆgroupå’Œversionå¯ä»¥ä¸ºç©ºï¼‰\n* group/interfaceName:version\n* @return\n*/\n@Parameter(excluded = true)\npublic String getUniqueServiceName() {\n\tStringBuilder buf = new StringBuilder();\n\tif (group != null && group.length() > 0) {\n\t    buf.append(group).append(\"/\");\n\t}\n\tbuf.append(interfaceName);\n\tif (version != null && version.length() > 0) {\n\t    buf.append(\":\").append(version);\n\t}\n\treturn buf.toString();\n}\n```\n##### ConsumerModelç±»\n```java\npublic class ConsumerModel {\n    /**\n     * å…ƒæ•°æ®(å³ReferenceBeanå®ä¾‹)\n     */\n    private ReferenceConfig metadata;\n    /**\n     * ä»£ç†å¯¹è±¡\n     */\n    private Object proxyObject;\n    /**\n     * å”¯ä¸€çš„æœåŠ¡æ¥å£åç§°\n     */\n    private String serviceName;\n\n    private final Map<Method, ConsumerMethodModel> methodModels = new IdentityHashMap<Method, ConsumerMethodModel>();\n\n    public ConsumerModel(String serviceName,ReferenceConfig metadata, Object proxyObject, Method[] methods) {\n        this.serviceName = serviceName;\n        this.metadata = metadata;\n        this.proxyObject = proxyObject;\n\n        if (proxyObject != null) {\n            //ä»£ç†å¯¹è±¡ä¸ä¸ºç©º,éå†æœåŠ¡æ¥å£æ–¹æ³•åˆ—è¡¨ï¼Œåˆ›å»ºConsumerMethodModelç±»\n            for (Method method : methods) {\n                //<æœåŠ¡æ¥å£æ–¹æ³•ï¼ŒConsumerMethodModel<æœåŠ¡æ¥å£æ–¹æ³•,metadataå®ä¾‹>>\n                methodModels.put(method, new ConsumerMethodModel(method, metadata));\n            }\n        }\n    }\n\n    /**\n     * Return service metadata for consumer\n     * @return service metadata\n     */\n    public ReferenceConfig getMetadata() {\n        return metadata;\n    }\n\n    public Object getProxyObject() {\n        return proxyObject;\n    }\n\n    /**\n     * è·å–æ¶ˆè´¹è€…ç«¯çš„ç»™å®šæ–¹æ³•çš„MethodModel\n     * Return method model for the given method on consumer side\n     *\n     * @param method method object\n     * @return method model\n     */\n    public ConsumerMethodModel getMethodModel(Method method) {\n        return methodModels.get(method);\n    }\n\n    /**\n     * è·å–å½“å‰æœåŠ¡çš„æ‰€æœ‰æ–¹æ³•MethodModel\n     * Return all method models for the current service\n     *\n     * @return method model list\n     */\n    public List<ConsumerMethodModel> getAllMethods() {\n        return new ArrayList<ConsumerMethodModel>(methodModels.values());\n    }\n\n    public String getServiceName() {\n        return serviceName;\n    }\n}\n```\n\n##### ApplicationModelç±»\næ¥ä¸‹æ¥æˆ‘ä»¬ç®€å•çœ‹ä¸‹ApplicationModel.initConsumerModel(getUniqueServiceName(), consumerModel);\n```java\n/**\n* å°†æœåŠ¡çš„ConsumerModelæ–¹æ³•ä¿å­˜åˆ°æœ¬åœ°Mapä¸­\n* @param serviceName\n* @param consumerModel\n* @return\n*/\npublic static boolean initConsumerModel(String serviceName, ConsumerModel consumerModel) {\n\tif (consumedServices.putIfAbsent(serviceName, consumerModel) != null) {\n\t    logger.warn(\"Already register the same consumer:\" + serviceName);\n\t    return false;\n\t}\n\treturn true;\n}\n```\n\ninitæ–¹æ³•æˆ‘ä»¬è¿˜å‰©ä¸‹ä¸¤ä¸ªæ–¹æ³•æ²¡æœ‰è®²è§£ï¼š\n1ã€ ref = createProxy(map); å³åˆ›å»ºä»£ç†å¯¹è±¡\n2ã€String[] methods = Wrapper.getWrapper(interfaceClass).getMethodNames(); å³åŒ…è£…ç±»\n\nè®¡åˆ’è¿™ä¸¤ä¸ªæ–¹æ³•ç•™ç€åé¢çš„ç« èŠ‚(è®²å®Œæ³¨å†Œä¸­å¿ƒç­‰ç« èŠ‚å)åœ¨è®²è§£ã€‚\n\n","tags":["dubbo"]},{"title":"Dubboæºç é˜…è¯»ä¹‹é›†æˆSpringæ³¨è§£è§£æ(0201)","url":"/blog/2018/08/05/Dubboæºç é˜…è¯»ä¹‹é›†æˆSpring-0201æ³¨è§£è§£æ/","content":">æœ¬å°èŠ‚ä»‹ç»Annotationçš„è§£æ\n\n### AnnotationBeanDefinitionParserè§£æç±»\n\n```java\nè¯¥ç±»ç»§æ‰¿è‡ªAbstractSingleBeanDefinitionParseræŠ½è±¡ç±»ï¼Œè¯¥æŠ½è±¡ç±»è§„èŒƒäº†æ³¨å†Œbeançš„éª¨æ¶(å³æ¨¡æ¿æ–¹æ³•)ï¼Œæˆ‘ä»¬åªéœ€è¦å®ç°getBeanClassæ–¹æ³•æŒ‡å®šå¾…æ³¨å†Œçš„beanï¼Œä»¥åŠå®ç°doParseæ–¹æ³•è¡¨æ˜å¦‚ä½•è§£æç±»ã€‚\npublic class AnnotationBeanDefinitionParser extends AbstractSingleBeanDefinitionParser {\n\n    /**\n     * è§£æï¼š<dubbo:annotation package=\"\"/>\n     * @param element\n     * @param parserContext\n     * @param builder\n     */\n    @Override\n    protected void doParse(Element element, ParserContext parserContext, BeanDefinitionBuilder builder) {\n        //è·å–é…ç½®çš„packageå±æ€§\n        String packageToScan = element.getAttribute(\"package\");\n        //é€—å·åˆ†éš”package\n        String[] packagesToScan = trimArrayElements(commaDelimitedListToStringArray(packageToScan));\n\n        //é€šè¿‡æ„é€ å‡½æ•°è®¾ç½®ServiceAnnotationBeanPostProcessorç±»çš„packagesToScanå±æ€§\n        builder.addConstructorArgValue(packagesToScan);\n        //æ ‡è¯†ä¸ºåŸºç¡€è®¾æ–½ç±»ï¼Œé˜²æ­¢è¯¥beanè¢«ä»£ç†\n        builder.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);\n\n        //æ³¨å†Œ@ReferenceAnnotationBeanPostProcessor\n        registerReferenceAnnotationBeanPostProcessor(parserContext.getRegistry());\n\n    }\n\n    @Override\n    protected boolean shouldGenerateIdAsFallback() {\n        return true;\n    }\n\n    /**\n     * æ³¨å†ŒReferenceAnnotationBeanPostProcessorç±»\n     * è¯¥ç±»ç”¨æ¥å¤„ç†@Reference\n     * Registers {@link ReferenceAnnotationBeanPostProcessor} into {@link BeanFactory}\n     * @param registry {@link BeanDefinitionRegistry}\n     */\n    private void registerReferenceAnnotationBeanPostProcessor(BeanDefinitionRegistry registry) {\n        // Register @Reference Annotation Bean Processor\n        BeanRegistrar.registerInfrastructureBean(registry,\n                ReferenceAnnotationBeanPostProcessor.BEAN_NAME,\n                ReferenceAnnotationBeanPostProcessor.class);\n    }\n\n    @Override\n    protected Class<?> getBeanClass(Element element) {\n        //è§£ææ³¨å†ŒServiceAnnotationBeanPostProcessorç±»\n        return ServiceAnnotationBeanPostProcessor.class;\n    }\n}\n```\næˆ‘ä»¬å°†ServiceAnnotationBeanPostProcessorç±»å’ŒReferenceAnnotationBeanPostProcessorç±»æ³¨å†Œåˆ°äº†Beanå·¥å‚ä¸­äº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†ç”¨ä¸¤å°èŠ‚(0201/0202)æ¥ä»‹ç»è¿™ä¸¤ä¸ªç±»çš„å®ç°ï¼Œå…ˆæ¥çœ‹ServiceAnnotationBeanPostProcessorç±»çš„å®ç°(0201)ï¼ŒReferenceAnnotationBeanPostProcessorç±»æ”¾åˆ°(0202)å°èŠ‚ä»‹ç»\n\n\n#### ServiceAnnotationBeanPostProcessorç±»å®ç°\næ¥ä¸‹æ¥æˆ‘ä»¬æ¥åˆ†æä¸‹ServiceAnnotationBeanPostProcessorç±»,è¯¥ç±»ç”¨æ¥å¤„ç†@Serviceæ³¨è§£ï¼Œå®ƒå®ç°äº†BeanDefinitionRegistryPostProcessoræ¥å£,å®ç°å®ƒçš„postProcessBeanDefinitionRegistryæ–¹æ³•å…è®¸æˆ‘ä»¬å®ç°è‡ªå®šä¹‰çš„æ³¨å†Œbeanå®šä¹‰çš„é€»è¾‘ã€‚åŒæ—¶ä¹Ÿå®ç°äº†å‡ ä¸ªä»¥Awareä¸ºç»“å°¾çš„æ¥å£ï¼Œä¾‹å¦‚BeanClassLoaderAwareï¼Œå®ç°äº†è¿™äº›æ¥å£åï¼Œåˆ™ServiceAnnotationBeanPostProcessorç±»è¢«å®ä¾‹åŒ–åå°†ä¼šè·å–ç›¸å¯¹åº”çš„èµ„æºã€‚\n```java\npublic class ServiceAnnotationBeanPostProcessor implements BeanDefinitionRegistryPostProcessor, EnvironmentAware,\n        ResourceLoaderAware, BeanClassLoaderAware {\n\n    //åˆ†éš”ç¬¦\t\n    private static final String SEPARATOR = \":\";\n\n    //æ‰«æçš„åŒ…è·¯å¾„(ä¸Šé¢çš„å°èŠ‚ä»‹ç»è¿‡ï¼Œæ³¨å†Œè¯¥beanæ—¶ï¼Œä¼šæ‰«æåŒ…è·¯å¾„)\n    private final Set<String> packagesToScan;\n    \n    //å®ç°EnvironmentAwareæ¥å£ï¼Œå®ä¾‹åŒ–åä¼šè‡ªåŠ¨æ³¨å…¥\n    private Environment environment;\n\n    private ResourceLoader resourceLoader;\n\n    private ClassLoader classLoader;\n \n    //æ„é€ æ–¹æ³•ï¼Œå‚æ•°æ˜¯éœ€è¦æ‰«æçš„åŒ…è·¯å¾„\n    public ServiceAnnotationBeanPostProcessor(String... packagesToScan) {\n        this(Arrays.asList(packagesToScan));\n    }\n\n    public ServiceAnnotationBeanPostProcessor(Collection<String> packagesToScan) {\n        this(new LinkedHashSet<String>(packagesToScan));\n    }\n\n    public ServiceAnnotationBeanPostProcessor(Set<String> packagesToScan) {\n        //ä¿å­˜åŒ…è·¯å¾„\n\tthis.packagesToScan = packagesToScan;\n    }\n\t\n    @Override\n    public void postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry) throws BeansException {\n\t//å¤„ç†å¾…æ‰«æåŒ…é‡Œé¢çš„å ä½ç¬¦(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n        Set<String> resolvedPackagesToScan = resolvePackagesToScan(packagesToScan);\n        \n        if (!CollectionUtils.isEmpty(resolvedPackagesToScan)) {\n            //æ‰«æåŒ…ï¼Œæ‰¾åˆ°å­˜åœ¨@Serviceæ³¨è§£çš„ç±»ï¼Œç„¶åæ³¨å†Œå®ƒ(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\t    registerServiceBeans(resolvedPackagesToScan, registry);\n        } else {\n            if (logger.isWarnEnabled()) {\n                //æ²¡æœ‰é…ç½®å¸¦æ‰«æçš„åŒ…è·¯å¾„ï¼Œå°†ä¼šå¿½ç•¥ServiceBeançš„æ³¨å†Œ\n                logger.warn(\"packagesToScan is empty , ServiceBean registry will be ignored!\");\n            }\n        }\n    }\n   \n    /**\n     * å¤„ç†å¸¦æ‰«æåŒ…é‡Œé¢çš„å ä½ç¬¦\n     * @param packagesToScan\n     * @return\n     */\n    private Set<String> resolvePackagesToScan(Set<String> packagesToScan) {\n        Set<String> resolvedPackagesToScan = new LinkedHashSet<String>(packagesToScan.size());\n        //éå†å¸¦æ‰«æçš„åŒ…\n        for (String packageToScan : packagesToScan) {\n            if (StringUtils.hasText(packageToScan)) {\n                //é€šè¿‡environmentè§£å†³å ä½ç¬¦\n                String resolvedPackageToScan = environment.resolvePlaceholders(packageToScan.trim());\n                resolvedPackagesToScan.add(resolvedPackageToScan);\n            }\n        }\n        return resolvedPackagesToScan;\n    }\n   \n    /**\n     * æ³¨å†Œå­˜åœ¨@Serviceæ³¨è§£çš„ç±»\n     * @param packagesToScan å¾…æ‰«æçš„åŸºç¡€åŒ…è·¯å¾„\n     * @param registry       {@link BeanDefinitionRegistry}\n     */\n    private void registerServiceBeans(Set<String> packagesToScan, BeanDefinitionRegistry registry) {\n\n\t//åˆ›å»ºæ‰«æå™¨ï¼Œç”¨æ¥æ‰«ææŒ‡å®šçš„åŒ…è·¯å¾„(åé¢ä¼šä»‹ç»è¯¥ç±»)\n        DubboClassPathBeanDefinitionScanner scanner =\n                new DubboClassPathBeanDefinitionScanner(registry, environment, resourceLoader);\n\n\t//è·å–BeanNameGeneratorå®ä¾‹ç”¨æ¥ç”Ÿæˆbean name(åé¢ä¼šä»‹ç»è¯¥æ–¹æ³•)\n        BeanNameGenerator beanNameGenerator = resolveBeanNameGenerator(registry);\n        \n\t//å°†BeanNameGeneratorè®¾ç½®åˆ°æ‰«æå™¨\n        scanner.setBeanNameGenerator(beanNameGenerator);\n        \n        //è®¾ç½®è¿‡æ»¤å™¨ï¼Œåªæ‰«æå­˜åœ¨@Serviceæ³¨è§£çš„\n        scanner.addIncludeFilter(new AnnotationTypeFilter(Service.class));\n\n\t//éå†åŸºç¡€åŒ…\n        for (String packageToScan : packagesToScan) {\n\n            // é¦–å…ˆæ³¨å†Œ@Service bean\n            scanner.scan(packageToScan);\n\n            // æ‰¾åˆ°è¯¥åŒ…ä¸‹æ‰€æœ‰å­˜åœ¨@Serviceçš„BeanDefinition(ä¸è®ºæ˜¯å¦æ˜¯@ComponentScanæ‰«æçš„)ï¼Œ\n\t    //ç„¶åä¸ºè¯¥beanç”ŸæˆbeanNameï¼Œå¹¶å°†è¯¥beanNameå’ŒBeanDefinitionåŒ…è£…æˆBeanDefinitionHolderï¼ˆåé¢ä¼šåˆ†æè¯¥æ–¹æ³•ï¼‰\n            Set<BeanDefinitionHolder> beanDefinitionHolders =\n                    findServiceBeanDefinitionHolders(scanner, packageToScan, registry, beanNameGenerator);\n\n            if (!CollectionUtils.isEmpty(beanDefinitionHolders)) {\n                \n\t\t//éå†beanDefinitionHolders\n                for (BeanDefinitionHolder beanDefinitionHolder : beanDefinitionHolders) {\n\t\t    //æ ¹æ®@Serviceæ³¨è§£ å’Œ beanDefinition  æ³¨å†ŒServiceBeanç±»(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n                    registerServiceBean(beanDefinitionHolder, registry, scanner);\n                }\n\n                if (logger.isInfoEnabled()) {\n\t\t    //è¾“å‡ºæ‰«æå‡ºæ¥çš„@Service beançš„æ•°é‡ï¼Œä»¥åŠæ‰«æçš„åŒ…è·¯å¾„\n                    logger.info(beanDefinitionHolders.size() + \" annotated Dubbo's @Service Components { \" +\n                            beanDefinitionHolders +\n                            \" } were scanned under package[\" + packageToScan + \"]\");\n                }\n            } else {\n                //æ²¡æœ‰æ‰«æåˆ°\n                if (logger.isWarnEnabled()) {\n                    logger.warn(\"No Spring Bean annotating Dubbo's @Service was found under package[\"\n                            + packageToScan + \"]\");\n                }\n            }\n        }\n    }\n\n    /**\n     * è·å–BeanNameGenerator\n     * @since 2.5.8\n     */\n    private BeanNameGenerator resolveBeanNameGenerator(BeanDefinitionRegistry registry) {\n\n        BeanNameGenerator beanNameGenerator = null;\n\n        if (registry instanceof SingletonBeanRegistry) {\n\t    //å•ä¾‹bean\n            SingletonBeanRegistry singletonBeanRegistry = SingletonBeanRegistry.class.cast(registry);\n\t    //è·å–beanNameç”Ÿæˆå™¨\n            beanNameGenerator = (BeanNameGenerator) singletonBeanRegistry.getSingleton(CONFIGURATION_BEAN_NAME_GENERATOR);\n        }\n        if (beanNameGenerator == null) {\n            if (logger.isInfoEnabled()) {\n\n                logger.info(\"BeanNameGenerator bean can't be found in BeanFactory with name [\"\n                        + CONFIGURATION_BEAN_NAME_GENERATOR + \"]\");\n                logger.info(\"BeanNameGenerator will be a instance of \" +\n                        AnnotationBeanNameGenerator.class.getName() +\n                        \" , it maybe a potential problem on bean name generation.\");\n            }\n\t    //ä½¿ç”¨AnnotationBeanNameGenerator\n            beanNameGenerator = new AnnotationBeanNameGenerator();\n        }\n        return beanNameGenerator;\n    }\n\n    /**\n     * æ‰«æåŒ…è·¯å¾„ï¼Œé€šè¿‡è¿‡æ»¤å™¨æ‰¾åˆ°å­˜åœ¨@Serviceæ³¨è§£çš„beanï¼Œç„¶åä¸ºè¯¥beanç”ŸæˆbeanNameï¼Œ\n     * ç„¶åå°†è¯¥beanNameå’ŒbeanDefinitionå°è£…æˆBeanDefinitionHolderå¯¹è±¡ï¼Œè¿”å›BeanDefinitionHolderåˆ—è¡¨\n     */\n    private Set<BeanDefinitionHolder> findServiceBeanDefinitionHolders(\n            ClassPathBeanDefinitionScanner scanner, String packageToScan, BeanDefinitionRegistry registry,\n            BeanNameGenerator beanNameGenerator) {\n \t\n\t//æ‰«æåŸºç¡€åŒ…ï¼ŒæŸ¥è¯¢å€™é€‰ç»„ä»¶ï¼ˆé€šè¿‡è¿‡æ»¤å™¨è¿‡æ»¤å‡ºæ¥çš„ï¼Œå³å­˜åœ¨@Serviceæ³¨è§£çš„beanï¼‰\n        Set<BeanDefinition> beanDefinitions = scanner.findCandidateComponents(packageToScan);\n\n        Set<BeanDefinitionHolder> beanDefinitionHolders = new LinkedHashSet<BeanDefinitionHolder>(beanDefinitions.size());\n\n        for (BeanDefinition beanDefinition : beanDefinitions) {\n\t    //æ ¹æ®beanDefinitionç”Ÿæˆbeanåç§°\n            String beanName = beanNameGenerator.generateBeanName(beanDefinition, registry);\n           \n\t    //æ ¹æ®beanNameå’ŒbeanDefinitionåˆ›å»ºBeanDefinitionHolderå¯¹è±¡\n\t    BeanDefinitionHolder beanDefinitionHolder = new BeanDefinitionHolder(beanDefinition, beanName);\n           \n\t    //ä¿å­˜åˆ°åˆ—è¡¨\t\n\t    beanDefinitionHolders.add(beanDefinitionHolder);\n        }\n        return beanDefinitionHolders;\n    }\n\n    /**\n     * æ ¹æ®@Serviceæ³¨è§£ å’Œ beanDefinition  æ³¨å†ŒServiceBeanç±»\n     * Registers {@link ServiceBean} from new annotated {@link Service} {@link BeanDefinition}\n     */\n    private void registerServiceBean(BeanDefinitionHolder beanDefinitionHolder, BeanDefinitionRegistry registry,\n                                     DubboClassPathBeanDefinitionScanner scanner) {\n\t\n\t//ä»beanDefinitionHolderä¸­è·å–beanNameï¼Œç„¶ååŠ è½½è¯¥ç±»(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n        Class<?> beanClass = resolveClass(beanDefinitionHolder);\n\n\t//æŸ¥è¯¢è¯¥beançš„@Serviceæ³¨è§£(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n        Service service = findAnnotation(beanClass, Service.class);\n\t\t\n\t//è·å–interfaceClassæ¥å£(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n        Class<?> interfaceClass = resolveServiceInterfaceClass(beanClass, service);\n\t\n\t//è·å–beançš„åç§°\n        String annotatedServiceBeanName = beanDefinitionHolder.getBeanName();\n\t\n\t//æ„å»ºServiceBeanå®šä¹‰(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n        AbstractBeanDefinition serviceBeanDefinition =\n                buildServiceBeanDefinition(service, interfaceClass, annotatedServiceBeanName);\n\t\n        //ç”ŸæˆServiceBeançš„beanName(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n        String beanName = generateServiceBeanName(service, interfaceClass, annotatedServiceBeanName);\n\n\t//æ£€æµ‹é‡å¤çš„å€™é€‰bean\n        if (scanner.checkCandidate(beanName, serviceBeanDefinition)) {\n\t    //æ³¨è§£ServiceBean\n            registry.registerBeanDefinition(beanName, serviceBeanDefinition);\n\n            if (logger.isInfoEnabled()) {\n                logger.warn(\"The BeanDefinition[\" + serviceBeanDefinition +\n                        \"] of ServiceBean has been registered with name : \" + beanName);\n            }\n        } else {\n\t    //å‘ç°é‡å¤çš„beanå®šä¹‰ï¼Œ@DubboComponentScanå¤šæ¬¡æ‰«æåˆ°åŒä¸€ä¸ªåŒ…ï¼Ÿ\n            if (logger.isWarnEnabled()) {\n                logger.warn(\"The Duplicated BeanDefinition[\" + serviceBeanDefinition +\n                        \"] of ServiceBean[ bean name : \" + beanName +\n                        \"] was be found , Did @DubboComponentScan scan to same package in many times?\");\n            }\n        }\n    }\n\n    /**\n     * ç”ŸæˆServiceBeançš„bean name\n     *\n     * @param service  @Serviceæ³¨è§£\n     * @param interfaceClass å­˜åœ¨@Serviceæ³¨è§£çš„ç±»çš„æ¥å£\n     * @param annotatedServiceBeanName å­˜åœ¨@Serviceæ³¨è§£çš„Bean name\n     * @return ServiceBean@interfaceClassName#annotatedServiceBeanName\n     * @since 2.5.9\n     */\n    private String generateServiceBeanName(Service service, Class<?> interfaceClass, String annotatedServiceBeanName) {\n\t//æ·»åŠ \"ServiceBean\"\n        StringBuilder beanNameBuilder = new StringBuilder(ServiceBean.class.getSimpleName());\n\n\t//æ·»åŠ åˆ†éš”ç¬¦\":\" å’Œ annotatedServiceBeanName \n        beanNameBuilder.append(SEPARATOR).append(annotatedServiceBeanName);\n\n        //è·å–æ¥å£çš„å…¨é™å®šå\n        String interfaceClassName = interfaceClass.getName();\n  \n        //æ·»åŠ åˆ†éš”ç¬¦\":\" å’Œ interfaceClassName\n        beanNameBuilder.append(SEPARATOR).append(interfaceClassName);\n       \n  \t//è·å–@Serviceæ³¨è§£çš„versionå±æ€§\n        String version = service.version();\n\t\n        if (StringUtils.hasText(version)) {\n            //æ·»åŠ åˆ†éš”ç¬¦\":\" å’Œ version\n\t    beanNameBuilder.append(SEPARATOR).append(version);\n        }\n\t\n\t//è·å–Serviceçš„groupå±æ€§\n        String group = service.group();\n        if (StringUtils.hasText(group)) {\n\t    //æ·»åŠ åˆ†éš”ç¬¦\":\" å’Œ group\n            beanNameBuilder.append(SEPARATOR).append(group);\n        }\n\t//è¿”å›ç”Ÿæˆçš„beanåç§°\n        return beanNameBuilder.toString();\n    }\n\n    /**\n     * å¤„ç†@Serviceæ³¨è§£é‡Œçš„interfaceClass()ï¼Œè¯¥interfaceClassä¸å¯ä»¥ä¸ºç©ºï¼Œå¹¶ä¸”å¿…é¡»æ˜¯æ¥å£ç±»å‹\n     * 1ã€è·å–@Serviceæ³¨è§£ä¸­çš„interfaceClass()\n     * 2ã€è·å–@Serviceæ³¨è§£ä¸­çš„interfaceName()ï¼Œå¹¶åŠ è½½\n     * 3ã€è·å–@Serviceæ³¨è§£ç±»çš„ç¬¬1ä¸ªæ¥å£\n     * @param annotatedServiceBeanClass å­˜åœ¨@Serviceæ³¨è§£çš„ç±»\n     * @param service @Serviceæ³¨è§£\n     * @return\n     */\n    private Class<?> resolveServiceInterfaceClass(Class<?> annotatedServiceBeanClass, Service service) {\n        \n\t//interfaceClassé»˜è®¤ä¸º@Serviceæ³¨è§£çš„interfaceClasså±æ€§\n        Class<?> interfaceClass = service.interfaceClass();\n\t\n\t\n        if (void.class.equals(interfaceClass)) {\n\t    //@Serviceæ³¨è§£çš„interfaceClasså±æ€§ä¸ºç©º\n            interfaceClass = null;\n\t\t\n\t    //è·å–@Serviceæ³¨è§£çš„interfaceNameå±æ€§\n            String interfaceClassName = service.interfaceName();\n            if (StringUtils.hasText(interfaceClassName)) {\n\t\t//åˆ¤æ–­æ˜¯å¦å­˜åœ¨interfaceClassNameç±»\n                if (ClassUtils.isPresent(interfaceClassName, classLoader)) {\n\t\t    //åŠ è½½interfaceClassNameç±»ï¼Œå¹¶èµ‹å€¼ç»™interfaceClass\n                    interfaceClass = resolveClassName(interfaceClassName, classLoader);\n                }\n            }\n        }\n\n        if (interfaceClass == null) {\n\t    //è·å–è¯¥ç±»çš„æ‰€æœ‰æ¥å£\n            Class<?>[] allInterfaces = annotatedServiceBeanClass.getInterfaces();\n            if (allInterfaces.length > 0) {\n\t\t//å–ç¬¬ä¸€ä¸ªæ¥å£ï¼Œèµ‹å€¼ç»™interfaceClass\n                interfaceClass = allInterfaces[0];\n            }\n\n        }\n\t//éªŒè¯ä¸ä¸ºç©ºï¼Œä¸”interfaceClassä¸ºæ¥å£\n        Assert.notNull(interfaceClass,\n                \"@Service interfaceClass() or interfaceName() or interface class must be present!\");\n\n        Assert.isTrue(interfaceClass.isInterface(),\n                \"The type that was annotated @Service is not an interface!\");\n\n        return interfaceClass;\n    }\n\t\n    private Class<?> resolveClass(BeanDefinitionHolder beanDefinitionHolder) {\n\t//è·å–beanå®šä¹‰\n        BeanDefinition beanDefinition = beanDefinitionHolder.getBeanDefinition();\n        return resolveClass(beanDefinition);\n\n    }\n\t\n    /**\n     * åŠ è½½ç±»\n     */\n    private Class<?> resolveClass(BeanDefinition beanDefinition) {\n\t//è·å–beançš„ç±»å\n        String beanClassName = beanDefinition.getBeanClassName();\n \t//åŠ è½½è¯¥ç±»\t\n        return resolveClassName(beanClassName, classLoader);\n    }\n\n    /**\n     * æ„å»ºServiceBeanå®šä¹‰\n     * @param service  @Serviceæ³¨è§£\n     * @param interfaceClass æ¥å£ç±»\n     * @param annotatedServiceBeanName å­˜åœ¨@Serviceæ³¨è§£çš„ç±»çš„bean name\n     */\n    private AbstractBeanDefinition buildServiceBeanDefinition(Service service, Class<?> interfaceClass,\n                                                              String annotatedServiceBeanName) {\n\t\n\t//è·å–ServiceBeançš„BeanDefinitionæ„é€ å™¨\n        BeanDefinitionBuilder builder = rootBeanDefinition(ServiceBean.class);\n\t\n\t//è·å–BeanDefinition\n        AbstractBeanDefinition beanDefinition = builder.getBeanDefinition();\n\t\n\t//è·å–ServiceBeançš„å±æ€§\n        MutablePropertyValues propertyValues = beanDefinition.getPropertyValues();\n\n\t//å¿½ç•¥çš„å±æ€§åç§°,è¿™äº›å±æ€§çš„å€¼åé¢ä¼šè®¾ç½®ï¼Œä»@Serviceæ³¨è§£ä¸­è·å–\n        String[] ignoreAttributeNames = of(\"provider\", \"monitor\", \"application\", \"module\", \"registry\", \"protocol\", \"interface\");\n\t\n\t//æ·»åŠ å±æ€§å€¼(åé¢ä¼šä»‹ç»è¯¥ç±»)\n        propertyValues.addPropertyValues(new AnnotationPropertyValuesAdapter(service, environment, ignoreAttributeNames));\n\n        //ä¸ºServiceBeanæ·»åŠ refå±æ€§ï¼Œå±æ€§å€¼ä¸ºannotatedServiceBeanName(å³å­˜åœ¨@Serviceæ³¨è§£çš„bean name)(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\t\n        addPropertyReference(builder, \"ref\", annotatedServiceBeanName);\n        //ä¸ºServiceBeanæ·»åŠ interfaceå±æ€§ï¼Œå±æ€§å€¼ä¸ºinterfaceClassæ¥å£çš„åç§°\n        builder.addPropertyValue(\"interface\", interfaceClass.getName());\n\n\t//è·å–@Serviceæ³¨è§£çš„providerå±æ€§(å³com.alibaba.dubbo.config.ProviderConfig)\n        String providerConfigBeanName = service.provider();\n        if (StringUtils.hasText(providerConfigBeanName)) {\n\t    //ä¸ºServiceBeanæ·»åŠ providerå±æ€§ï¼Œå±æ€§å€¼ä¸ºproviderConfigBeanName\n            addPropertyReference(builder, \"provider\", providerConfigBeanName);\n        }\n\n        //è·å–@Serviceæ³¨è§£çš„monitorå±æ€§(å³com.alibaba.dubbo.config.MonitorConfig)\n\tString monitorConfigBeanName = service.monitor();\n        if (StringUtils.hasText(monitorConfigBeanName)) {\n\t    //ä¸ºServiceBeanæ·»åŠ monitorå±æ€§ï¼Œå±æ€§å€¼ä¸ºmonitorConfigBeanName\n            addPropertyReference(builder, \"monitor\", monitorConfigBeanName);\n        }\n\n\t//è·å–@Serviceæ³¨è§£çš„applicationå±æ€§(å³com.alibaba.dubbo.config.ApplicationConfig)\n        String applicationConfigBeanName = service.application();\n        if (StringUtils.hasText(applicationConfigBeanName)) {\n\t    //ä¸ºServiceBeanæ·»åŠ applicationå±æ€§ï¼Œå±æ€§å€¼ä¸ºapplicationConfigBeanName\n            addPropertyReference(builder, \"application\", applicationConfigBeanName);\n        }\n\n\t//è·å–@Serviceæ³¨è§£çš„moduleå±æ€§(å³com.alibaba.dubbo.config.ModuleConfig)\n\tString moduleConfigBeanName = service.module();\n        if (StringUtils.hasText(moduleConfigBeanName)) {\n\t    //ä¸ºServiceBeanæ·»åŠ moduleå±æ€§ï¼Œå±æ€§å€¼ä¸ºmoduleConfigBeanName\n            addPropertyReference(builder, \"module\", moduleConfigBeanName);\n        }\n\n\n\t//è·å–@Serviceæ³¨è§£çš„registryå±æ€§(å³com.alibaba.dubbo.config.RegistryConfig)\n        String[] registryConfigBeanNames = service.registry();\n\t//éå†registryConfigBeanNamesï¼Œå¤„ç†å ä½ç¬¦ï¼Œç„¶ååŒ…è£…æˆRuntimeBeanReferenceå¹¶è¿”å›(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n        List<RuntimeBeanReference> registryRuntimeBeanReferences = toRuntimeBeanReferences(registryConfigBeanNames);\n\n        if (!registryRuntimeBeanReferences.isEmpty()) {\n            //ä¸ºServiceBeanæ·»åŠ registrieså±æ€§\n\t    builder.addPropertyValue(\"registries\", registryRuntimeBeanReferences);\n        }\n\n        //è·å–@Serviceçš„protocolå±æ€§(å³com.alibaba.dubbo.config.ProtocolConfig)\n\tString[] protocolConfigBeanNames = service.protocol();\n\t//å¤„ç†å ä½ç¬¦\n        List<RuntimeBeanReference> protocolRuntimeBeanReferences = toRuntimeBeanReferences(protocolConfigBeanNames);\n\n        if (!protocolRuntimeBeanReferences.isEmpty()) {\n            //ä¸ºServiceBeanæ·»åŠ protocolså±æ€§\n\t    builder.addPropertyValue(\"protocols\", protocolRuntimeBeanReferences);\n        }\n\t//è¿”å›@ServiceBeanå®šä¹‰\n        return builder.getBeanDefinition();\n    }\n\n\t\n    /**\n     * å¤„ç†å ä½ç¬¦ï¼Œå¹¶åŒ…è£…æˆåŒ…è£…æˆRuntimeBeanReferenceå¯¹è±¡\n     * @param beanNames\n     * @return\n     */\n    private ManagedList<RuntimeBeanReference> toRuntimeBeanReferences(String... beanNames) {\n        ManagedList<RuntimeBeanReference> runtimeBeanReferences = new ManagedList<RuntimeBeanReference>();\n        if (!ObjectUtils.isEmpty(beanNames)) {\n            //éå†bean names\n            for (String beanName : beanNames) {\n\t\t//è§£å†³å ä½ç¬¦\n                String resolvedBeanName = environment.resolvePlaceholders(beanName);\n\t\t//å°†beanNameåŒ…è£…æˆRuntimeBeanReferenceå¯¹è±¡\n                runtimeBeanReferences.add(new RuntimeBeanReference(resolvedBeanName));\n            }\n        }\n        return runtimeBeanReferences;\n    }\n    \n    /**\n     * ä¸ºServiceBeanæ·»åŠ propertyNameå±æ€§ï¼Œå±æ€§å€¼ä¸ºbeanName\n     * @param builder ServiceBeanå®šä¹‰æ„é€ å™¨\n     * @param propertyName å±æ€§åç§°\n     * @param beanName å­˜åœ¨@Serviceç›´æ¥çš„bean name\n     */\n    private void addPropertyReference(BeanDefinitionBuilder builder, String propertyName, String beanName) {\n        //å¤„ç†å ä½ç¬¦\n\tString resolvedBeanName = environment.resolvePlaceholders(beanName);\n        //ä¸ºServiceBeanæ·»åŠ propertyNameå±æ€§ï¼Œå±æ€§å€¼ä¸ºresolvedBeanName\n\tbuilder.addPropertyReference(propertyName, resolvedBeanName);\n    }\n\n    @Override\n    public void setEnvironment(Environment environment) {\n        this.environment = environment;\n    }\n\n    @Override\n    public void setResourceLoader(ResourceLoader resourceLoader) {\n        this.resourceLoader = resourceLoader;\n    }\n\n    @Override\n    public void setBeanClassLoader(ClassLoader classLoader) {\n        this.classLoader = classLoader;\n    }\n}\n```\næˆ‘ä»¬å†çœ‹ä¸‹ç”¨åˆ°çš„å…¶ä»–ç±»\n##### DubboClassPathBeanDefinitionScanner\nè¯¥ç±»ç»§æ‰¿è‡ªClassPathBeanDefinitionScanner,å®ƒæä¾›è‡ªåŠ¨æ‰«æåŠŸèƒ½,æ ¹æ®æä¾›çš„åŸºç¡€åŒ…è·¯å¾„,æ‰«æclasspathä¸‹è¯¥åŸºç¡€åŒ…è·¯å¾„,æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ç±»å¹¶æ³¨å†Œä¸ºSpringçš„ä¸€ä¸ªBean,\né»˜è®¤æƒ…å†µä¸‹,ClassPathBeanDefinitionScannerå°†ä¼šæ‰«ææ‰€æœ‰ç”¨SpringæŒ‡å®šäº†çš„æ³¨è§£æ ‡è¯†çš„ç±»,åŒ…æ‹¬@Componentã€@Serviceã€@Repositoryã€@Controller,\nä¹Ÿå¯ä»¥å¯¹æ‰«æçš„æœºåˆ¶è¿›è¡Œé…ç½®,è®¾ç½®ä¸€äº›Filter,åªæœ‰æ»¡è¶³Filterçš„ç±»æ‰èƒ½è¢«æ³¨å†Œä¸ºBean.\n```java\npublic class DubboClassPathBeanDefinitionScanner extends ClassPathBeanDefinitionScanner {\n\n    public DubboClassPathBeanDefinitionScanner(BeanDefinitionRegistry registry,\n                                               boolean useDefaultFilters,\n                                               Environment environment,\n                                               ResourceLoader resourceLoader) {\n        super(registry, useDefaultFilters);\n        \n\tsetEnvironment(environment);\n\n        setResourceLoader(resourceLoader);\n\n\t//ä¼šè°ƒç”¨AnnotationConfigUtilsç±»çš„registerAnnotationConfigProcessorsæ–¹æ³•\n        registerAnnotationConfigProcessors(registry);\n    }\n    public DubboClassPathBeanDefinitionScanner(BeanDefinitionRegistry registry,\n                                               Environment environment,\n                                               ResourceLoader resourceLoader) {\n        this(registry, false, environment, resourceLoader);\n    }\n\n    @Override\n    public Set<BeanDefinitionHolder> doScan(String... basePackages) {\n        return super.doScan(basePackages);\n    }\n\n    @Override\n    public boolean checkCandidate(String beanName, BeanDefinition beanDefinition) throws IllegalStateException {\n        //æ£€æµ‹beanNameæ˜¯å¦å·²ç»å­˜åœ¨\n        return super.checkCandidate(beanName, beanDefinition);\n    }\n}\n```\næ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸‹AnnotationConfigUtilsç±»çš„registerAnnotationConfigProcessorsæ–¹æ³•\n```java\npublic static Set<BeanDefinitionHolder> registerAnnotationConfigProcessors(\n\t\t\tBeanDefinitionRegistry registry, Object source) {\n\n\t//Â·Â·Â·çœç•¥Â·Â·Â·\n\tSet<BeanDefinitionHolder> beanDefs = new LinkedHashSet(4);\n\tRootBeanDefinition def;\n\n\t//æ³¨å†ŒConfigurationClassPostProcessor\n\tif (!registry.containsBeanDefinition(\"org.springframework.context.annotation.internalConfigurationAnnotationProcessor\")) {\n\t    //1.åœ¨springä½¿ç”¨AnnotationConfigBeanDefinitionParserè§£æxmlæ–‡ä»¶çš„æ—¶å€™  ä¹Ÿå°±æ˜¯é…ç½®annotation-configçš„æ—¶å€™\n            //2.å¯åŠ¨åœ¨AnnotationConfigApplicationContextå®¹å™¨çš„æ—¶å€™\n\t    def = new RootBeanDefinition(ConfigurationClassPostProcessor.class);\n\t    def.setSource(source);\n\t    beanDefs.add(registerPostProcessor(registry, def, \"org.springframework.context.annotation.internalConfigurationAnnotationProcessor\"));\n\t}\n\t\n\t//æ³¨å†ŒAutowiredAnnotationBeanPostProcessor \n\tif (!registry.containsBeanDefinition(\"org.springframework.context.annotation.internalAutowiredAnnotationProcessor\")) {\n\t    def = new RootBeanDefinition(AutowiredAnnotationBeanPostProcessor.class);\n\t    def.setSource(source);\n\t    beanDefs.add(registerPostProcessor(registry, def, \"org.springframework.context.annotation.internalAutowiredAnnotationProcessor\"));\n\t}\n\n\t//Â·Â·Â·çœç•¥Â·Â·Â·\n\treturn beanDefs;\n}\n```\n##### AnnotationPropertyValuesAdapter\nè¯¥ç±»å®ç°äº†Springçš„PropertyValuesæ¥å£ï¼Œæ­¤æ¥å£æ˜¯PropertyValueçš„é›†åˆç®¡ç†ç±»,ç”¨æ¥å‚¨å­˜é”®å€¼å¯¹.MutablePropertyValuesæ˜¯å…¶å¸¸ç”¨å®ç°ç±»\nåœ¨è¯¥é€‚é…å™¨å†…éƒ¨å°±æ˜¯ç”¨äº†MutablePropertyValueså®ç°ç±»æ¥è¿›è¡Œæ“ä½œã€‚\n```java\n//æˆ‘ä»¬åœ¨ä¸Šæ–‡æ„å»ºServiceBeanå®šä¹‰çš„æ—¶å€™ä¼šåˆ›å»ºAnnotationPropertyValuesAdapterç±»ï¼Œç›¸å…³ä»£ç å¦‚ä¸‹ï¼š\n//String[] ignoreAttributeNames = of(\"provider\", \"monitor\", \"application\", \"module\", \"registry\", \"protocol\", \"interface\");\n//propertyValues.addPropertyValues(new AnnotationPropertyValuesAdapter(service, environment, ignoreAttributeNames));\n//å…¶ä¸­serviceå‚æ•°æ˜¯@Serviceæ³¨è§£ï¼Œè€Œenvironmentå‚æ•°ç±»å®ç°äº†PropertyResolveræ¥å£\n\n\nclass AnnotationPropertyValuesAdapter implements PropertyValues {\n     \n    //ä¼ è¿‡æ¥çš„æ³¨è§£\n    private final Annotation annotation;\n    \n    //å±æ€§è§£å†³å™¨,è§„èŒƒäº†è§£æåº•å±‚ä»»æ„propertyèµ„æºçš„æ¥å£\n    private final PropertyResolver propertyResolver;\n\n    //æ˜¯å¦å¿½ç•¥é»˜è®¤å€¼\n    private final boolean ignoreDefaultValue;\n\t\n    //å§”æ‰˜ç±»,å³MutablePropertyValues\n    private final PropertyValues delegate;\n\n    public AnnotationPropertyValuesAdapter(Annotation annotation, PropertyResolver propertyResolver, boolean ignoreDefaultValue, String... ignoreAttributeNames) {\n        this.annotation = annotation;\n        this.propertyResolver = propertyResolver;\n        this.ignoreDefaultValue = ignoreDefaultValue;\n        //ç”ŸæˆMutablePropertyValues\n        this.delegate = adapt(annotation, ignoreDefaultValue, ignoreAttributeNames);\n    }\n\n    public AnnotationPropertyValuesAdapter(Annotation annotation, PropertyResolver propertyResolver, String... ignoreAttributeNames) {\n        this(annotation, propertyResolver, true, ignoreAttributeNames);\n    }\n\n    private PropertyValues adapt(Annotation annotation, boolean ignoreDefaultValue, String... ignoreAttributeNames) {\n        //åˆ›å»ºMutablePropertyValuesç±»(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•getAttributes()\n\treturn new MutablePropertyValues(getAttributes(annotation, propertyResolver, ignoreDefaultValue, ignoreAttributeNames));\n    }\n\n    public Annotation getAnnotation() {\n        return annotation;\n    }\n\n    public boolean isIgnoreDefaultValue() {\n        return ignoreDefaultValue;\n    }\n\n    @Override\n    public PropertyValue[] getPropertyValues() {\n\t//è°ƒç”¨å§”æ‰˜ç±»çš„æ–¹æ³•\n        return delegate.getPropertyValues();\n    }\n\n    @Override\n    public PropertyValue getPropertyValue(String propertyName) {\n        //è°ƒç”¨å§”æ‰˜ç±»çš„æ–¹æ³•è·å–å±æ€§å€¼\n        return delegate.getPropertyValue(propertyName);\n    }\n\n    @Override\n    public PropertyValues changesSince(PropertyValues old) {\n        return delegate.changesSince(old);\n    }\n\n    @Override\n    public boolean contains(String propertyName) {\n        return delegate.contains(propertyName);\n    }\n\n    @Override\n    public boolean isEmpty() {\n        return delegate.isEmpty();\n    }\n}\n```\nä¸‹é¢æˆ‘ä»¬çœ‹ä¸‹AnnotationUtils.getAttributesæ–¹æ³•\n```java\n/**\n * è·å–æ³¨è§£çš„å±æ€§é›†åˆ\n * @param annotation   æ³¨è§£\n * @param propertyResolver å±æ€§è§£å†³å™¨\n *    1ã€æ ¹æ®å±æ€§åç§°è·å–å±æ€§å€¼ï¼ˆæ›¿æ¢åçš„ï¼‰\n *    2ã€æ›¿æ¢${propertyName:defaultValue}æ ¼å¼çš„å ä½ç¬¦ä¸ºå®é™…å€¼\n * @param ignoreDefaultValue æ˜¯å¦å¿½ç•¥é»˜è®¤å€¼\n * @param ignoreAttributeNames éœ€è¦å¿½ç•¥çš„å±æ€§å\n * @return <å±æ€§åï¼Œå±æ€§å€¼>\n */\npublic static Map<String, Object> getAttributes(Annotation annotation,\n\t\t\t\t\t    PropertyResolver propertyResolver,\n\t\t\t\t\t    boolean ignoreDefaultValue,\n\t\t\t\t\t    String... ignoreAttributeNames) {\n\t\n\t//éœ€è¦å¿½ç•¥çš„å±æ€§å\n\tSet<String> ignoreAttributeNamesSet = new HashSet<String>(arrayToList(ignoreAttributeNames));\n\n\t//è·å–annotationæ³¨è§£çš„å±æ€§map(è°ƒç”¨çš„Springçš„AnnotationUtils.getAnnotationAttributesæ–¹æ³•)\n\tMap<String, Object> attributes = getAnnotationAttributes(annotation);\n\t//å±æ€§å,çœŸå®å±æ€§å€¼\n\tMap<String, Object> actualAttributes = new LinkedHashMap<String, Object>();\n\t\n\t//æ˜¯å¦éœ€è¦å¤„ç†å ä½ç¬¦\n\tboolean requiredResolve = propertyResolver != null;\n\n\tfor (Map.Entry<String, Object> entry : attributes.entrySet()) {\n\t    //å±æ€§åç§°\n\t    String attributeName = entry.getKey();\n\t    //å±æ€§å€¼\n\t    Object attributeValue = entry.getValue();\n\n\t    //å¿½ç•¥é»˜è®¤å±æ€§å€¼\n\t    if (ignoreDefaultValue && nullSafeEquals(attributeValue, getDefaultValue(annotation, attributeName))) {\n\t\t//å±æ€§å€¼å’Œé»˜è®¤å€¼ç›¸ç­‰ï¼Œåˆ™è·³è¿‡è¯¥å±æ€§\n\t\tcontinue;\n\t    }\n\n\t    //å¿½ç•¥å±æ€§å\n\t    if (ignoreAttributeNamesSet.contains(attributeName)) {\n\t\t//å¦‚æœå¾…å¿½ç•¥çš„å±æ€§ååˆ—è¡¨åŒ…å«è¯¥å±æ€§åï¼Œåˆ™è·³è¿‡è¯¥å±æ€§\n\t\tcontinue;\n\t    }\n\n\t    // å¤„ç†å ä½ç¬¦,å±æ€§å€¼ä¸ºå­—ç¬¦ä¸²ç±»å‹\n\t    if (requiredResolve && attributeValue instanceof String) {\n\t\t//è·å–çœŸå®å±æ€§å€¼\n\t\tString resolvedValue = propertyResolver.resolvePlaceholders(valueOf(attributeValue));\n\t\t//æ ¼å¼åŒ–çœŸå®å±æ€§å€¼\n\t\tattributeValue = trimAllWhitespace(resolvedValue);\n\t    }\n\t    //ä¿å­˜å±æ€§åå’ŒçœŸå®å±æ€§å€¼\n\t    actualAttributes.put(attributeName, attributeValue);\n\t}\n\treturn actualAttributes;\n}\n```\n\n##### ServiceBeanç±»\nåœ¨ä¸Šé¢çš„å†…å®¹ä¸­ï¼Œæˆ‘ä»¬å®Œæˆäº†ServiceBeanç±»çš„æ³¨å†Œï¼Œç°åœ¨æˆ‘ä»¬è¯¦ç»†çœ‹çœ‹ServiceBeanç±».è¯¥ç±»ç»§æ‰¿è‡ªServiceConfigç±»ï¼Œå¹¶ä¸”å®ç°äº†ä¼—å¤šSpringæ¥å£\n```java\n/**\n * ServiceFactoryBean\n * InitializingBeanæ¥å£åœ¨beanå®ä¾‹åŒ–å®Œæˆåå°†ä¼šè‡ªåŠ¨è°ƒç”¨afterPropertiesSetæ–¹æ³•\n * DisposableBeanæ¥å£åœ¨beané”€æ¯ä¹‹å‰è°ƒç”¨destroyæ–¹æ³•\n * ApplicationContextAwareæ¥å£åœ¨beanå®ä¾‹åŒ–å®Œæˆåå°†ä¼šæ³¨å…¥ApplicationContextå±æ€§\n * ApplicationListeneræ¥å£Springå®¹å™¨åˆå§‹åŒ–å®Œæˆåä¼šå›è°ƒonApplicationEventæ–¹æ³•\n * BeanNameAwareæ¥å£æ³¨å…¥beanåç§°\n *\n * @export\n */\npublic class ServiceBean<T> extends ServiceConfig<T> implements InitializingBean, DisposableBean, ApplicationContextAware, ApplicationListener<ContextRefreshedEvent>, BeanNameAware {\n\n    private static final long serialVersionUID = 213195494150089726L;\n\n\n    private static transient ApplicationContext SPRING_CONTEXT;\n\n    /**\n     * @Serviceæ³¨è§£\n     */\n    private final transient Service service;\n\n    private transient ApplicationContext applicationContext;\n\n    private transient String beanName;\n\n    /**\n     * æ˜¯å¦æ”¯æŒApplicationListener\n     */\n    private transient boolean supportedApplicationListener;\n\n    public ServiceBean() {\n        super();\n        this.service = null;\n    }\n\n    public ServiceBean(Service service) {\n        super(service);\n        this.service = service;\n    }\n\n    /**\n     * è·å–Spring ApplicationContext\n     * @return\n     */\n    public static ApplicationContext getSpringContext() {\n        return SPRING_CONTEXT;\n    }\n\n    @Override\n    public void setApplicationContext(ApplicationContext applicationContext) {\n        //è®¾ç½®ApplicationContext\n        this.applicationContext = applicationContext;\n        SpringExtensionFactory.addApplicationContext(applicationContext);\n        if (applicationContext != null) {\n            SPRING_CONTEXT = applicationContext;\n            try {\n                //backward compatibility to spring 2.0.1\n                //ä»applicationContextä¸­è·å–åˆ°addApplicationListeneræ–¹æ³•\n                Method method = applicationContext.getClass().getMethod(\"addApplicationListener\", new Class<?>[]{ApplicationListener.class});\n                //è°ƒç”¨applicationContextçš„addApplicationListeneræ–¹æ³•ï¼Œå°†å½“å‰å¯¹è±¡æ·»åŠ è¿›å»\n                method.invoke(applicationContext, new Object[]{this});\n                //è®¾ç½®æ”¯æŒApplicationListener\n                supportedApplicationListener = true;\n            } catch (Throwable t) {\n                if (applicationContext instanceof AbstractApplicationContext) {\n                    try {\n                        // å‘åå…¼å®¹\n                        // backward compatibility to spring 2.0.1\n                        Method method = AbstractApplicationContext.class.getDeclaredMethod(\"addListener\", new Class<?>[]{ApplicationListener.class});\n                        if (!method.isAccessible()) {\n                            method.setAccessible(true);\n                        }\n                        method.invoke(applicationContext, new Object[]{this});\n                        supportedApplicationListener = true;\n                    } catch (Throwable t2) {\n                    }\n                }\n            }\n        }\n    }\n\n    @Override\n    public void setBeanName(String name) {\n        this.beanName = name;\n    }\n\n    public Service getService() {\n        return service;\n    }\n\n    @Override\n    public void onApplicationEvent(ContextRefreshedEvent event) {\n\t//æ²¡æœ‰é…ç½®delayï¼Œæˆ–è€…delay = -1\n        if (isDelay() && !isExported() && !isUnexported()) {\n            if (logger.isInfoEnabled()) {\n                logger.info(\"The service ready on spring started. service: \" + getInterface());\n            }\n            //æš´éœ²æœåŠ¡(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n            export();\n        }\n    }\n\n    /**\n     * ä¸¤ç§æƒ…å†µï¼š\n     * 1ã€è®¾ç½®äº†å»¶è¿Ÿæš´éœ²(delay != null && delay != -1)ï¼Œdubboåœ¨Springå®ä¾‹åŒ–beançš„æ—¶å€™ä¼šå¯¹å®ç°äº†InitializingBeançš„ç±»è¿›è¡Œå›è°ƒï¼Œ\n     * å›è°ƒæ–¹æ³•æ˜¯afterPropertySet()ï¼Œå¦‚æœè®¾ç½®äº†å»¶è¿Ÿæš´éœ²ï¼Œdubboåœ¨è¿™ä¸ªæ–¹æ³•ä¸­è¿›è¡ŒæœåŠ¡çš„å‘å¸ƒã€‚\n     * 2ã€æ²¡æœ‰è®¾ç½®å»¶è¿Ÿæˆ–è€…å»¶è¿Ÿä¸º-1ï¼Œdubboä¼šåœ¨Springå®ä¾‹åŒ–å®Œbeanä¹‹åï¼Œ\n     * åœ¨åˆ·æ–°å®¹å™¨æœ€åä¸€æ­¥å‘å¸ƒContextRefreshEventäº‹ä»¶çš„æ—¶å€™ï¼Œ\n     * é€šçŸ¥å®ç°äº†ApplicationListenerçš„ç±»è¿›è¡Œå›è°ƒonApplicationEventï¼Œdubboä¼šåœ¨è¿™ä¸ªæ–¹æ³•ä¸­å‘å¸ƒæœåŠ¡\n     * @return\n     */\n    private boolean isDelay() {\n        //è·å–delayå±æ€§\n        Integer delay = getDelay();\n        //è·å–æœåŠ¡æä¾›è€…\n        ProviderConfig provider = getProvider();\n        if (delay == null && provider != null) {\n            //delayå±æ€§ä¸ºç©ºï¼Œåˆ™å–æœåŠ¡æä¾›è€…çš„delayå±æ€§\n            delay = provider.getDelay();\n        }\n        //(æ”¯æŒspringç›‘å¬äº‹ä»¶ && æ²¡æœ‰è®¾ç½®å»¶è¿Ÿæˆ–è€…å»¶è¿Ÿä¸º-1) åˆ™è¿”å›true\n        return supportedApplicationListener && (delay == null || delay == -1);\n    }\n\n\t\n    /**\n     * 1ã€ä¼šåˆ¤æ–­ServiceBeançš„ProviderConfigã€ApplicationConfigã€ModuleConfigã€List<RegistryConfig>ã€MonitorConfigã€List<ProtocolConfig>å±æ€§æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºçš„è¯ï¼Œä»Springå®¹å™¨ä¸­è·å–ï¼Œç„¶åè¿›è¡Œèµ‹å€¼ï¼Œå…¶ä¸­è¿˜ä¼šæ£€æµ‹æ˜¯å¦å­˜åœ¨é‡å¤çš„é…ç½®(defaultå±æ€§)\n     * 2ã€æ¥ç€ä¼šåˆ¤æ–­å¹¶è®¾ç½®pathå±æ€§(ä½¿ç”¨beanName)\n     * 3ã€æ ¹æ®delayå±æ€§åˆ¤æ–­æ˜¯å¦éœ€è¦æš´éœ²æœåŠ¡\n     */\n    @Override\n    @SuppressWarnings({\"unchecked\", \"deprecation\"})\n    public void afterPropertiesSet() throws Exception {\n        //æ²¡æœ‰é…ç½®Provider\n        if (getProvider() == null) {\n            //ä»IOCå®¹å™¨ä¸­è·å–åˆ°æ‰€æœ‰çš„Provider\n            Map<String, ProviderConfig> providerConfigMap = applicationContext == null ? null : BeanFactoryUtils.beansOfTypeIncludingAncestors(applicationContext, ProviderConfig.class, false, false);\n            if (providerConfigMap != null && providerConfigMap.size() > 0) {\n                //ä»IOCå®¹å™¨ä¸­è·å–åˆ°æ‰€æœ‰çš„Protocol\n                Map<String, ProtocolConfig> protocolConfigMap = applicationContext == null ? null : BeanFactoryUtils.beansOfTypeIncludingAncestors(applicationContext, ProtocolConfig.class, false, false);\n                if ((protocolConfigMap == null || protocolConfigMap.size() == 0)\n                        && providerConfigMap.size() > 1) {\n                    // backward compatibility\n                    //å¦‚æœæ²¡æœ‰é…ç½®Protocolï¼Œä½†æ˜¯å­˜åœ¨Providerçš„è¯ï¼Œéå†Provideråˆ—è¡¨\n                    //ä»Provideråˆ—è¡¨ä¸­æ‰¾åˆ°isDefaultå±æ€§ä¸ºtrueçš„Providerï¼Œå¹¶ä¿å­˜èµ·æ¥\n                    List<ProviderConfig> providerConfigs = new ArrayList<ProviderConfig>();\n                    for (ProviderConfig config : providerConfigMap.values()) {\n                        if (config.isDefault() != null && config.isDefault().booleanValue()) {\n                            //æ‰¾åˆ°defaultä¸ºtrueçš„Provider\n                            providerConfigs.add(config);\n                        }\n                    }\n                    if (!providerConfigs.isEmpty()) {\n                        //æ ¹æ®Provideræ„é€ Protocol(åºŸå¼ƒæ–¹æ³•)\n                        setProviders(providerConfigs);\n                    }\n                } else {\n                    ProviderConfig providerConfig = null;\n                    //ä»provideråˆ—è¡¨ä¸­æ‰¾åˆ°defaultå±æ€§ä¸ºnullæˆ–è€…ä¸ºtrueçš„providerï¼Œå¦‚æœæ‰¾åˆ°å¤šä¸ªåˆ™æŠ›å¼‚å¸¸\n                    for (ProviderConfig config : providerConfigMap.values()) {\n                        //æ²¡æœ‰é…ç½®isDefaultå±æ€§æˆ–è€…isDefault = true\n                        //æ£€æµ‹æ˜¯å¦å­˜åœ¨é‡å¤çš„Provideré…ç½®\n                        if (config.isDefault() == null || config.isDefault().booleanValue()) {\n                            if (providerConfig != null) {\n                                throw new IllegalStateException(\"Duplicate provider configs: \" + providerConfig + \" and \" + config);\n                            }\n                            providerConfig = config;\n                        }\n                    }\n                    if (providerConfig != null) {\n                        //è®¾ç½®Provider\n                        setProvider(providerConfig);\n                    }\n                }\n            }\n        }\n        if (getApplication() == null\n                && (getProvider() == null || getProvider().getApplication() == null)) {\n            //ä»IOCå®¹å™¨ä¸­æ‰¾åˆ°æ‰€æœ‰çš„ApplicationConfig\n            Map<String, ApplicationConfig> applicationConfigMap = applicationContext == null ? null : BeanFactoryUtils.beansOfTypeIncludingAncestors(applicationContext, ApplicationConfig.class, false, false);\n            if (applicationConfigMap != null && applicationConfigMap.size() > 0) {\n                ApplicationConfig applicationConfig = null;\n                //æ£€æµ‹æ˜¯å¦å­˜åœ¨é‡å¤çš„Applicationé…ç½®(defaultå±æ€§ä¸ºnullæˆ–è€…ä¸ºtrue)\n                for (ApplicationConfig config : applicationConfigMap.values()) {\n                    if (config.isDefault() == null || config.isDefault().booleanValue()) {\n                        if (applicationConfig != null) {\n                            throw new IllegalStateException(\"Duplicate application configs: \" + applicationConfig + \" and \" + config);\n                        }\n                        applicationConfig = config;\n                    }\n                }\n                if (applicationConfig != null) {\n                    setApplication(applicationConfig);\n                }\n            }\n        }\n        if (getModule() == null\n                && (getProvider() == null || getProvider().getModule() == null)) {\n            //ä»IOCå®¹å™¨ä¸­æ‰¾åˆ°æ‰€æœ‰çš„ModuleConfig\n            Map<String, ModuleConfig> moduleConfigMap = applicationContext == null ? null : BeanFactoryUtils.beansOfTypeIncludingAncestors(applicationContext, ModuleConfig.class, false, false);\n            if (moduleConfigMap != null && moduleConfigMap.size() > 0) {\n                ModuleConfig moduleConfig = null;\n                //æ£€æµ‹æ˜¯å¦å­˜åœ¨é‡å¤çš„Moduleé…ç½®(defaultå±æ€§ä¸ºnullæˆ–è€…ä¸ºtrue)\n                for (ModuleConfig config : moduleConfigMap.values()) {\n                    if (config.isDefault() == null || config.isDefault().booleanValue()) {\n                        if (moduleConfig != null) {\n                            throw new IllegalStateException(\"Duplicate module configs: \" + moduleConfig + \" and \" + config);\n                        }\n                        moduleConfig = config;\n                    }\n                }\n                if (moduleConfig != null) {\n                    setModule(moduleConfig);\n                }\n            }\n        }\n        //registerä¸ºç©ºæˆ–è€…Providerä¸­çš„registerä¸ºç©ºæˆ–è€…Applicationä¸­çš„registerä¸ºç©º\n        if ((getRegistries() == null || getRegistries().isEmpty())\n                && (getProvider() == null || getProvider().getRegistries() == null || getProvider().getRegistries().isEmpty())\n                && (getApplication() == null || getApplication().getRegistries() == null || getApplication().getRegistries().isEmpty())) {\n            //ä»IOCå®¹å™¨ä¸­è·å–RegistryConfig\n            Map<String, RegistryConfig> registryConfigMap = applicationContext == null ? null : BeanFactoryUtils.beansOfTypeIncludingAncestors(applicationContext, RegistryConfig.class, false, false);\n            if (registryConfigMap != null && registryConfigMap.size() > 0) {\n                List<RegistryConfig> registryConfigs = new ArrayList<RegistryConfig>();\n                //éå†registryåˆ—è¡¨ï¼Œä»ä¸­æ‰¾åˆ°defaultå±æ€§ä¸ºnullæˆ–è€…ä¸ºtrueçš„registryï¼Œå¹¶ä¿å­˜èµ·æ¥\n                for (RegistryConfig config : registryConfigMap.values()) {\n                    if (config.isDefault() == null || config.isDefault().booleanValue()) {\n                        registryConfigs.add(config);\n                    }\n                }\n                if (registryConfigs != null && !registryConfigs.isEmpty()) {\n                    super.setRegistries(registryConfigs);\n                }\n            }\n        }\n        if (getMonitor() == null\n                && (getProvider() == null || getProvider().getMonitor() == null)\n                && (getApplication() == null || getApplication().getMonitor() == null)) {\n            Map<String, MonitorConfig> monitorConfigMap = applicationContext == null ? null : BeanFactoryUtils.beansOfTypeIncludingAncestors(applicationContext, MonitorConfig.class, false, false);\n            if (monitorConfigMap != null && monitorConfigMap.size() > 0) {\n                MonitorConfig monitorConfig = null;\n                //æ£€æµ‹æ˜¯å¦å­˜åœ¨é‡å¤çš„monitoré…ç½®(defaultå±æ€§ä¸ºç©ºæˆ–è€…ä¸ºtrue)\n                for (MonitorConfig config : monitorConfigMap.values()) {\n                    if (config.isDefault() == null || config.isDefault().booleanValue()) {\n                        if (monitorConfig != null) {\n                            throw new IllegalStateException(\"Duplicate monitor configs: \" + monitorConfig + \" and \" + config);\n                        }\n                        monitorConfig = config;\n                    }\n                }\n                if (monitorConfig != null) {\n\t\t    //è®¾ç½®monitor\n                    setMonitor(monitorConfig);\n                }\n            }\n        }\n        if ((getProtocols() == null || getProtocols().isEmpty())\n                && (getProvider() == null || getProvider().getProtocols() == null || getProvider().getProtocols().isEmpty())) {\n            //ä»IOCå®¹å™¨ä¸­è·å–ProtocolConfig\n            Map<String, ProtocolConfig> protocolConfigMap = applicationContext == null ? null : BeanFactoryUtils.beansOfTypeIncludingAncestors(applicationContext, ProtocolConfig.class, false, false);\n            if (protocolConfigMap != null && protocolConfigMap.size() > 0) {\n                List<ProtocolConfig> protocolConfigs = new ArrayList<ProtocolConfig>();\n                //éå†Protocolåˆ—è¡¨ï¼Œä»ä¸­æ‰¾åˆ°defaultå±æ€§ä¸ºç©ºï¼Œæˆ–è€…ä¸ºtrueçš„Protocolï¼Œå¹¶ä¿å­˜èµ·æ¥\n                for (ProtocolConfig config : protocolConfigMap.values()) {\n                    if (config.isDefault() == null || config.isDefault().booleanValue()) {\n                        protocolConfigs.add(config);\n                    }\n                }\n                if (protocolConfigs != null && !protocolConfigs.isEmpty()) {\n                    super.setProtocols(protocolConfigs);\n                }\n            }\n        }\n        if (getPath() == null || getPath().length() == 0) {\n            //pathæœåŠ¡åç§°ä¸ºç©ºçš„è¯\n            if (beanName != null && beanName.length() > 0\n                    && getInterface() != null && getInterface().length() > 0\n                    && beanName.startsWith(getInterface())) {\n                //ä½¿ç”¨beanNameä½œä¸ºæœåŠ¡åç§°\n                setPath(beanName);\n            }\n        }\n        if (!isDelay()) {\n            //é…ç½®äº†delayå±æ€§ï¼Œæš´éœ²æœåŠ¡(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n            export();\n        }\n    }\n\n    @Override\n    public void destroy() throws Exception {\n        // This will only be called for singleton scope bean, and expected to be called by spring shutdown hook when BeanFactory/ApplicationContext destroys.\n        // We will guarantee dubbo related resources being released with dubbo shutdown hook.\n        //unexport();\n    }\n\n    // merged from dubbox\n    @Override\n    protected Class getServiceClass(T ref) {\n        if (AopUtils.isAopProxy(ref)) {\n            //ä»Aopä»£ç†ç±»ä¸­è·å–åˆ°ç›®æ ‡å¯¹è±¡\n            return AopUtils.getTargetClass(ref);\n        }\n        return super.getServiceClass(ref);\n    }\n}\n```\n###### exportæ–¹æ³•\nexportæ–¹æ³•æ˜¯å®šä¹‰åœ¨ServiceBeançš„çˆ¶ç±»ServiceConfigä¸­çš„\n```java\npublic synchronized void export() {\n\tif (provider != null) {\n\t    if (export == null) {\n\t\t//exportå±æ€§ä¸ºç©ºçš„è¯ï¼Œåˆ™è·å–providerä¸­çš„exportå±æ€§\n\t\texport = provider.getExport();\n\t    }\n\t    if (delay == null) {\n\t\t//delayå±æ€§ä¸ºç©ºçš„è¯ï¼Œåˆ™è·å–providerä¸­çš„delayå±æ€§\n\t\tdelay = provider.getDelay();\n\t    }\n\t}\n\tif (export != null && !export) {\n\t    //å¦‚æœä¸æš´éœ²æœåŠ¡ï¼Œç›´æ¥è¿”å›\n\t    return;\n\t}\n\n\tif (delay != null && delay > 0) {\n\t    //delayå¤§äº0çš„è¯ï¼Œä¼šå¯åŠ¨çº¿ç¨‹ï¼Œå»¶è¿Ÿæš´éœ²æœåŠ¡\n\t    delayExportExecutor.schedule(new Runnable() {\n\t\t@Override\n\t\tpublic void run() {\n\t\t    doExport();\n\t\t}\n\t    }, delay, TimeUnit.MILLISECONDS);\n\t} else {\n\t    //ç›´æ¥æš´éœ²æœåŠ¡\n\t    doExport();\n\t}\n}\n```\nå¯ä»¥çœ‹åˆ°æœ€ç»ˆä¼šè°ƒç”¨doExportæ–¹æ³•è¿›è¡ŒæœåŠ¡æš´éœ²\n```java\nprotected synchronized void doExport() {\n\tif (unexported) {\n\t    //æ£€æµ‹æ˜¯å¦å·²ç»å–æ¶ˆæœåŠ¡æš´éœ²\n\t    throw new IllegalStateException(\"Already unexported!\");\n\t}\n\tif (exported) {\n\t    //å·²ç»æš´éœ²è¿‡æœåŠ¡ï¼Œç›´æ¥è¿”å›\n\t    return;\n\t}\n\texported = true;\n\t//æ£€æŸ¥æœåŠ¡æ¥å£interfaceå±æ€§æ˜¯å¦é…ç½®\n\tif (interfaceName == null || interfaceName.length() == 0) {\n\t    throw new IllegalStateException(\"<dubbo:service interface=\\\"\\\" /> interface not allow null!\");\n\t}\n\t//æ£€æµ‹ProviderConfigæ˜¯å¦å·²é…ç½®ï¼Œæ²¡æœ‰é…ç½®åˆ™è¿›è¡Œé…ç½®(æ­¤æ–¹æ³•åœ¨\"Dubboæºç é˜…è¯»ä¹‹é›†æˆSpring(03)\"ä¸­ä»‹ç»è¿‡)\n\tcheckDefault();\n\tif (provider != null) {\n\t    //ä»providerä¸­è·å–ç¼ºå¤±çš„é…ç½®\n\t    if (application == null) {\n\t\tapplication = provider.getApplication();\n\t    }\n\t    if (module == null) {\n\t\tmodule = provider.getModule();\n\t    }\n\t    if (registries == null) {\n\t\tregistries = provider.getRegistries();\n\t    }\n\t    if (monitor == null) {\n\t\tmonitor = provider.getMonitor();\n\t    }\n\t    if (protocols == null) {\n\t\tprotocols = provider.getProtocols();\n\t    }\n\t}\n\tif (module != null) {\n\t    //ä»moduleä¸­è·å–æ³¨å†Œä¸­å¿ƒå’Œç›‘æ§ä¸­å¿ƒ\n\t    if (registries == null) {\n\t\tregistries = module.getRegistries();\n\t    }\n\t    if (monitor == null) {\n\t\tmonitor = module.getMonitor();\n\t    }\n\t}\n\tif (application != null) {\n\t    //ä»applicationä¸­è·å–æ³¨å†Œä¸­å¿ƒå’Œç›‘æ§ä¸­å¿ƒ\n\t    if (registries == null) {\n\t\tregistries = application.getRegistries();\n\t    }\n\t    if (monitor == null) {\n\t\tmonitor = application.getMonitor();\n\t    }\n\t}\n\t//è·å–æœåŠ¡æ¥å£ç±»interfaceClass\n\tif (ref instanceof GenericService) {\n\t    //æœåŠ¡æ¥å£ä¸ºGenericServiceç±»å‹\n\t    interfaceClass = GenericService.class;\n\t    if (StringUtils.isEmpty(generic)) {\n\t\t//genericå±æ€§ä¸ºç©ºçš„è¯ï¼Œåˆ™è®¾ç½®ä¸ºtrue\n\t\tgeneric = Boolean.TRUE.toString();\n\t    }\n\t} else {\n\t    try {\n\t\t//åŠ è½½interfaceNameç±»\n\t\tinterfaceClass = Class.forName(interfaceName, true, Thread.currentThread()\n\t\t\t.getContextClassLoader());\n\t    } catch (ClassNotFoundException e) {\n\t\tthrow new IllegalStateException(e.getMessage(), e);\n\t    }\n\t    //æ£€æµ‹æ–¹æ³•åˆ—è¡¨methodsæ˜¯å¦éƒ½åœ¨æ¥å£interfaceClassä¸­å­˜åœ¨\n\t    checkInterfaceAndMethods(interfaceClass, methods);\n\t    //æ ¡éªŒrefç±»(refä¸å¯ä»¥ä¸ºç©ºï¼Œå¹¶ä¸”å®ç°äº†interfaceClassæ¥å£)\n\t    checkRef();\n\t    //å°†genericå±æ€§è®¾ç½®æˆfalse\n\t    generic = Boolean.FALSE.toString();\n\t}\n\t//å¤„ç†æœåŠ¡æ¥å£æœ¬åœ°å®ç°ç±»\n\tif (local != null) {\n\t    if (\"true\".equals(local)) {\n\t\t//é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ç°ç±»åç§°ä¸ºï¼šinterfaceName + \"Local\"\n\t\tlocal = interfaceName + \"Local\";\n\t    }\n\t    Class<?> localClass;\n\t    try {\n\t\t//åŠ è½½å®ç°ç±»\n\t\tlocalClass = ClassHelper.forNameWithThreadContextClassLoader(local);\n\t    } catch (ClassNotFoundException e) {\t\n\t\t//æ²¡æœ‰æ‰¾åˆ°è¯¥å®ç°ç±»\n\t\tthrow new IllegalStateException(e.getMessage(), e);\n\t    }\n\t    //æ ¡éªŒæœåŠ¡æ¥å£æœ¬åœ°å®ç°ç±»æ˜¯å¦å®ç°äº†interfaceClassæ¥å£\n\t    if (!interfaceClass.isAssignableFrom(localClass)) {\n\t\tthrow new IllegalStateException(\"The local implementation class \" + localClass.getName() + \" not implement interface \" + interfaceName);\n\t    }\n\t}\n\t//å¤„ç†æœåŠ¡æ¥å£æœ¬åœ°å­˜æ ¹å®ç°ç±»\n\tif (stub != null) {\n\t    if (\"true\".equals(stub)) {\n\t\t//é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ç°ç±»åç§°ä¸ºï¼šinterfaceName + \"Stub\"\n\t\tstub = interfaceName + \"Stub\";\n\t    }\n\t    Class<?> stubClass;\n\t    try {\n\t\t//åŠ è½½å®ç°ç±»\n\t\tstubClass = ClassHelper.forNameWithThreadContextClassLoader(stub);\n\t    } catch (ClassNotFoundException e) {\n\t\tthrow new IllegalStateException(e.getMessage(), e);\n\t    }\n\t    //æ ¡éªŒè¯¥å­˜æ ¹ç±»æ˜¯å¦å®ç°äº†interfaceClassæ¥å£\n\t    if (!interfaceClass.isAssignableFrom(stubClass)) {\n\t\tthrow new IllegalStateException(\"The stub implementation class \" + stubClass.getName() + \" not implement interface \" + interfaceName);\n\t    }\n\t}\n\t//æ£€æµ‹ApplicationConfigæ˜¯å¦ä¸ºç©º(ä¼šè°ƒç”¨appendPropertiesæ–¹æ³•æ·»åŠ å±æ€§ï¼Œè¯¥æ–¹æ³•åœ¨ä¹‹å‰åšæ–‡ä»‹ç»è¿‡)\n\tcheckApplication();\n\t//æ£€æµ‹æ³¨å†Œä¸­å¿ƒlistæ˜¯å¦ä¸ºç©º(ä»é…ç½®æ–‡ä»¶ä¸­è·å–dubbo.registry.addresså±æ€§ï¼Œç„¶ååˆ›å»ºRegistryConfigå¯¹è±¡ï¼Œæ·»åŠ å±æ€§ï¼Œæ”¾å…¥åˆ°listä¸­)\n\tcheckRegistry();\n\t//æ£€æµ‹åè®®protocolsæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºä¸”providerä¸ä¸ºç©ºï¼Œåˆ™å…ˆä»providerå¯¹è±¡ä¸­è·å–\n\t//ç„¶åéå†protocolsï¼Œå¤„ç†name(nameä¸ºç©ºï¼Œåˆ™è®¾ç½®ä¸ºdubbo)å¹¶æ·»åŠ å±æ€§ã€‚\n\tcheckProtocol();\n\t//ä¸ºServiceBeanå¯¹è±¡æ·»åŠ å±æ€§\n\tappendProperties(this);\n\t//æ£€æµ‹local/stub/mocké…ç½®æ˜¯å¦æ­£ç¡®\n\t//local/stub/mock(mock å¯é…ç½®ä¸º\"return \")åº”è¯¥ä¸ºinterfaceClassæˆ–è€…ä¸ºinterfaceClasså­ç±»\n\tcheckStubAndMock(interfaceClass);\n\t//æœåŠ¡åç§°pathä¸ºç©ºçš„è¯ï¼Œåˆ™è®¾ç½®ä¸ºinterfaceName\n\tif (path == null || path.length() == 0) {\n\t    path = interfaceName;\n\t}\n\t//æš´éœ²url(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\tdoExportUrls();\n\t//æ ¹æ®æœåŠ¡å”¯ä¸€åç§°ã€å½“å‰ServiceBeanå®ä¾‹ã€ref åˆ›å»ºProviderModelå®ä¾‹(åé¢ä¼šåˆ†æ)\n\tProviderModel providerModel = new ProviderModel(getUniqueServiceName(), this, ref);\n\t//æ ¹æ®æœåŠ¡å”¯ä¸€åç§°ï¼Œæ³¨å†Œæä¾›è€…æœåŠ¡ï¼Œå³æ”¾åˆ°ç±»ApplicationModelä¸­çš„å˜é‡åä¸ºprovidedServicesçš„mapä¸­\n\tApplicationModel.initProviderModel(getUniqueServiceName(), providerModel);\n}\n```\n\n###### doExportUrlsæ–¹æ³•\nè¯¥æ–¹æ³•å†…éƒ¨ä¼šè°ƒç”¨loadRegistriesæ–¹æ³•æ„é€ æ³¨å†Œä¸­å¿ƒurlåœ°å€ï¼Œç„¶åè°ƒç”¨doExportUrlsFor1Protocolæ–¹æ³•è¿›è¡ŒæœåŠ¡urlçš„æš´éœ²ã€‚\n```java\n/**\n * æš´éœ²url\n *\nprivate void doExportUrls() {\n\t//æ„é€ æ³¨å†Œä¸­å¿ƒåœ°å€(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\t//ä¾‹å¦‚ï¼šregistry://224.5.6.7:1234/com.alibaba.dubbo.registry.RegistryService?application=demo-provider&dubbo=2.0.0&pid=6384&qos.port=22222&registry=multicast&timestamp=1528347455956\n\tList<URL> registryURLs = loadRegistries(true);\n\t\n\t//ä¾‹å¦‚ï¼š<dubbo:protocol name=\"dubbo\" port=\"20880\" id=\"dubbo\" />\n\tfor (ProtocolConfig protocolConfig : protocols) {\n\t    //æš´éœ²æœåŠ¡url\t\n\t    doExportUrlsFor1Protocol(protocolConfig, registryURLs);\n\t}\n}\n\n/**\n * æ„é€ æ³¨å†Œä¸­å¿ƒURL\n * ä¼˜å…ˆä½¿ç”¨ç³»ç»Ÿé…ç½®ä¸­çš„æ³¨å†Œä¸­å¿ƒåˆ—è¡¨ï¼Œå¦‚æœæ²¡æœ‰é…ç½®ï¼Œåˆ™ä½¿ç”¨RegistryConfigä¸­é…ç½®çš„\n * @param provider æ˜¯å¦æ˜¯æä¾›è€…\n * @return\n */\nprotected List<URL> loadRegistries(boolean provider) {\n\t//æ£€æµ‹registrieså˜é‡(å³ArrayList<RegistryConfig>ã€‚<dubbo:registry address=\"...\" />ï¼‰\n\tcheckRegistry();\n\tList<URL> registryList = new ArrayList<URL>();\n\t//éå†registries\n\tif (registries != null && !registries.isEmpty()) {\n\t    for (RegistryConfig config : registries) {\n\t\t//è·å–å½“å‰æ³¨å†Œä¸­å¿ƒåœ°å€\n\t\tString address = config.getAddress();\n\t\tif (address == null || address.length() == 0) {\n\t\t    //å°†addressè®¾ç½®ä¸º*\n\t\t    address = Constants.ANYHOST_VALUE;\n\t\t}\n\t\t//ä»ç³»ç»Ÿå±æ€§ä¸­è·å–æ³¨å†Œä¸­å¿ƒåœ°å€\n\t\tString sysaddress = System.getProperty(\"dubbo.registry.address\");\n\t\tif (sysaddress != null && sysaddress.length() > 0) {\n\t\t    //å¦‚æœç³»ç»Ÿæ³¨å†Œä¸­å¿ƒåœ°å€ä¸ä¸ºç©ºï¼Œåˆ™ä¼˜å…ˆä½¿ç”¨ç³»ç»Ÿæ³¨å†Œä¸­å¿ƒåœ°å€\n\t\t    address = sysaddress;\n\t\t}\n\t\tif (address != null && address.length() > 0\n\t\t\t&& !RegistryConfig.NO_AVAILABLE.equalsIgnoreCase(address)) {\n\t\t    //åœ°å€å¯ç”¨\n\n\t\t    Map<String, String> map = new HashMap<String, String>();\n\t\t    //é™„åŠ å‚æ•°ï¼Œå³æ‰¾åˆ°applicationã€configç±»ä¸­çš„å±æ€§ï¼Œå¹¶æ·»åŠ åˆ°mapä¸­\n\t\t    appendParameters(map, application);\n\t\t    appendParameters(map, config);\n\t\t    //æ·»åŠ æœåŠ¡åç§°\n\t\t    map.put(\"path\", RegistryService.class.getName());\n\t\t    //æ·»åŠ dubboç‰ˆæœ¬\n\t\t    map.put(\"dubbo\", Version.getVersion());\n\t\t    //æ·»åŠ æ—¶é—´æˆ³\n\t\t    map.put(Constants.TIMESTAMP_KEY, String.valueOf(System.currentTimeMillis()));\n\t\t    if (ConfigUtils.getPid() > 0) {\n\t\t\t//æ·»åŠ pid\n\t\t\tmap.put(Constants.PID_KEY, String.valueOf(ConfigUtils.getPid()));\n\t\t    }\n\t\t    //æ·»åŠ protocol\n\t\t    if (!map.containsKey(\"protocol\")) {\n\t\t\t//å­˜åœ¨æ‰©å±•åç§°ä¸ºremoteçš„RegistryFactoryï¼Œåˆ™è®¾ç½®protocolå±æ€§ä¸ºremoteï¼Œå¦åˆ™è®¾ç½®ä¸ºdubbo\n\t\t\tif (ExtensionLoader.getExtensionLoader(RegistryFactory.class).hasExtension(\"remote\")) {\n\t\t\t    map.put(\"protocol\", \"remote\");\n\t\t\t} else {\n\t\t\t    map.put(\"protocol\", \"dubbo\");\n\t\t\t}\n\t\t    }\n\t\t    //æ ¹æ®å½“å‰æ³¨å†Œä¸­å¿ƒåœ°å€å’Œmapç”Ÿäº§urlåˆ—è¡¨ï¼ˆåé¢ä¼šåˆ†æè¯¥æ–¹æ³•ï¼‰\n\t\t    List<URL> urls = UrlUtils.parseURLs(address, map);\n\t\t    for (URL url : urls) {\n\t\t\t//å‘urlä¸­æ·»åŠ registryå‚æ•°ï¼Œå‚æ•°å€¼ä¸ºurlçš„protocolå±æ€§(ä¾‹å¦‚ï¼šregistry=multicast)\n\t\t\turl = url.addParameter(Constants.REGISTRY_KEY, url.getProtocol());\n\t\t\t//é‡æ–°è®¾ç½®urlçš„protocolå±æ€§å€¼ä¸ºâ€œregistryâ€(åé¢æš´éœ²æœåŠ¡æ—¶ï¼Œå°†ä¼šä½¿ç”¨è¯¥protocolå±æ€§å€¼ä½œä¸ºæ‰©å±•åç§°ï¼Œè·å–å¯¹åº”çš„Protocolå®ä¾‹ï¼Œå› æ­¤å°†ä¼šä½¿ç”¨RegistryProtocolå®ä¾‹ï¼Œä¸‹ä¸€èŠ‚ä¼šè¯¦ç»†åˆ†æ)\n\t\t\turl = url.setProtocol(Constants.REGISTRY_PROTOCOL);\n\t\t\tif ((provider && url.getParameter(Constants.REGISTER_KEY, true))\n\t\t\t\t|| (!provider && url.getParameter(Constants.SUBSCRIBE_KEY, true))) {\n\t\t\t    //æä¾›è€… && urlä¸­çš„registerå‚æ•°å€¼ä¸ºtrue\n\t\t\t    //ä¸æ˜¯æä¾›è€… && urlä¸­çš„subscribeå‚æ•°å€¼ä¸ºtrue\n\t\t\t    //åˆ™å°†è¯¥urlæ·»åŠ åˆ°registryListåˆ—è¡¨ä¸­\n\t\t\t    registryList.add(url);\n\t\t\t}\n\t\t    }\n\t\t}\n\t    }\n\t}\n\treturn registryList;\n}\n\n/**\n * @param address æ³¨å†Œä¸­å¿ƒåœ°å€åˆ—è¡¨(\"|\"æˆ–è€…\";\"åˆ†éš”)\n * @param defaults mapå‚æ•°\n * @return\n */\npublic static List<URL> parseURLs(String address, Map<String, String> defaults) {\n        if (address == null || address.length() == 0) {\n\t    //æ³¨å†Œä¸­å¿ƒåœ°å€ä¸ºç©ºï¼Œè¿”å›null\n            return null;\n        }\n        //é€šè¿‡â€œ|â€æˆ–è€…â€œ;â€åˆ†éš”æ³¨å†Œä¸­å¿ƒåœ°å€\n        String[] addresses = Constants.REGISTRY_SPLIT_PATTERN.split(address);\n        if (addresses == null || addresses.length == 0) {\n            return null;\n        }\n        List<URL> registries = new ArrayList<URL>();\n\t//éå†æ¯ä¸€ä¸ªæ³¨å†Œä¸­å¿ƒåœ°å€\n        for (String addr : addresses) {\n            //é€šè¿‡æ³¨å†Œä¸­å¿ƒåœ°å€addrå’Œmapå‚æ•°æ„é€ æ³¨å†Œä¸­å¿ƒURLå¯¹è±¡ï¼ˆåé¢ä¼šåˆ†ææ–¹æ³•ï¼‰\n            registries.add(parseURL(addr, defaults));\n        }\n\t//è¿”å›æ³¨å†Œä¸­å¿ƒåœ°å€urlåˆ—è¡¨\n        return registries;\n}\n\n/**\n * ç”Ÿæˆæ³¨å†Œä¸­å¿ƒURL\n * 1ã€æ ¹æ®æ³¨å†Œä¸­å¿ƒåœ°å€addressç”Ÿæˆurlå­—ç¬¦ä¸²(å¤„ç†å¤‡ç”¨åœ°å€)\n * 2ã€ä»defaultsé›†åˆä¸­è·å–å±æ€§(protocolã€usernameã€passwordã€portã€path)é»˜è®¤å€¼\n * 3ã€æ ¹æ®defaultsæ–°ç”Ÿæˆé›†åˆdefaultParametersï¼Œå¹¶ç§»é™¤(protocolã€usernameã€passwordã€portã€path)å±æ€§\n * 4ã€æ ¹æ®urlå­—ç¬¦ä¸²ç”ŸæˆURLå¯¹è±¡ï¼Œå¹¶è·å–è¯¥URLå¯¹è±¡çš„å±æ€§å€¼(protocolã€usernameã€passwordã€portã€pathã€parameters),\n *    å…¶ä¸­parameterså±æ€§å€¼æ˜¯æ–°ç”Ÿæˆçš„ä¸€ä¸ªmapã€‚\n * 5ã€åˆ¤æ–­URLå¯¹è±¡çš„è¿™äº›å±æ€§å€¼(protocolã€usernameã€passwordã€portã€pathã€parameters)æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™ä½¿ç”¨å±æ€§é»˜è®¤å€¼ï¼Œå¹¶æ ‡è¯†å‘ç”Ÿäº†æ”¹å˜ã€‚\n * 6ã€å¦‚æœå‘ç”Ÿäº†æ”¹å˜ã€‚åˆ™æ ¹æ®æ–°çš„å±æ€§å€¼é‡æ–°ç”Ÿæˆä¸€ä¸ªURLå¯¹è±¡å¹¶è¿”å›ã€‚\n * @param address æ³¨å†Œä¸­å¿ƒåœ°å€(å¯èƒ½æ˜¯å¤šä¸ªï¼Œä½¿ç”¨\",\"åˆ†éš”)\n * @param defaults mapå‚æ•°\n * @return\n */\npublic static URL parseURL(String address, Map<String, String> defaults) {\n\tif (address == null || address.length() == 0) {\n\t    return null;\n\t}\n\t//è¯¥urlæœ€ç»ˆä¼šè¢«è§£ææˆURLå¯¹è±¡\n\tString url;\n\tif (address.indexOf(\"://\") >= 0) {\n\t    //è¯¥æ³¨å†Œä¸­å¿ƒåœ°å€åŒ…å«\"://\"\n\t    url = address;\n\t} else {\n\t    //ä½¿ç”¨é€—å·\",\"åˆ†éš”addressåœ°å€\n\t    String[] addresses = Constants.COMMA_SPLIT_PATTERN.split(address);\n\t    //å°†addressesæ•°ç»„ç¬¬1ä¸ªå…ƒç´ èµ‹å€¼ç»™url\n\t    url = addresses[0];\n\t    if (addresses.length > 1) {\n\t\t//éå†addressesæ•°ç»„åé¢çš„å…ƒç´ (å³æŸ¥çœ‹æ˜¯å¦å­˜åœ¨å¤‡ç”¨çš„æ³¨å†Œä¸­å¿ƒåœ°å€)\n\t\t//backupè®°å½•æ³¨å†Œä¸­å¿ƒå¤‡ç”¨åœ°å€\n\t\tStringBuilder backup = new StringBuilder();\n\t\tfor (int i = 1; i < addresses.length; i++) {\n\t\t    if (i > 1) {\n\t\t\tbackup.append(\",\");\n\t\t    }\n\t\t    backup.append(addresses[i]);\n\t\t}\n\t\t//å°†æ³¨å†Œä¸­å¿ƒå¤‡ç”¨åœ°å€æ·»åŠ åˆ°urlçš„backupå‚æ•°ä¸­\n\t\turl += \"?\" + Constants.BACKUP_KEY + \"=\" + backup.toString();\n\t    }\n\t}\n\t//ä»defaultsä¸­è·å–protocolå±æ€§\n\tString defaultProtocol = defaults == null ? null : defaults.get(\"protocol\");\n\tif (defaultProtocol == null || defaultProtocol.length() == 0) {\n\t    //å¦‚æœprotocolå±æ€§å€¼ä¸ºç©ºï¼Œåˆ™è®¾ç½®ä¸ºdubbo\n\t    defaultProtocol = \"dubbo\";\n\t}\n\t//ä»defaultsä¸­è·å–usernameå±æ€§å’Œpasswordå±æ€§\n\tString defaultUsername = defaults == null ? null : defaults.get(\"username\");\n\tString defaultPassword = defaults == null ? null : defaults.get(\"password\");\n\t//ä»defaultsä¸­è·å–portå±æ€§\n\tint defaultPort = StringUtils.parseInteger(defaults == null ? null : defaults.get(\"port\"));\n\t//ä»defaultsä¸­è·å–pathå±æ€§\n\tString defaultPath = defaults == null ? null : defaults.get(\"path\");\n\t//æ ¹æ®defaultsæ–°ç”Ÿæˆä¸€ä¸ªmapé›†åˆdefaultParameters\n\tMap<String, String> defaultParameters = defaults == null ? null : new HashMap<String, String>(defaults);\n\tif (defaultParameters != null) {\n\t    //ç§»é™¤defaultParametersé›†åˆä¸­çš„ä»¥ä¸‹å±æ€§\n\t    defaultParameters.remove(\"protocol\");\n\t    defaultParameters.remove(\"username\");\n\t    defaultParameters.remove(\"password\");\n\t    defaultParameters.remove(\"host\");\n\t    defaultParameters.remove(\"port\");\n\t    defaultParameters.remove(\"path\");\n\t}\n\t//æ ¹æ®urlå­—ç¬¦ä¸²ç”ŸæˆURLå¯¹è±¡\n\tURL u = URL.valueOf(url);\n\t//å¦‚æœæ–°ç”Ÿæˆçš„URLä¸­çš„æŸå±æ€§å€¼ä¸ºç©ºï¼Œä¸”è¯¥å±æ€§çš„é»˜è®¤å€¼ä¸ä¸ºç©ºï¼Œåˆ™æ„å‘³ç€å‘ç”Ÿäº†æ”¹å˜ï¼Œchangedä¼šè¢«è®¾ç½®ä¸ºtrue\n\tboolean changed = false;\n\t\n\t//è·å–URLå¯¹è±¡ä¸­çš„protocolã€usernameã€passwordã€hostã€portã€pathå±æ€§\n\tString protocol = u.getProtocol();\n\tString username = u.getUsername();\n\tString password = u.getPassword();\n\tString host = u.getHost();\n\tint port = u.getPort();\n\tString path = u.getPath();\n\t\n\t//è·å–URLå¯¹è±¡çš„å‚æ•°map\n\tMap<String, String> parameters = new HashMap<String, String>(u.getParameters());\n\tif ((protocol == null || protocol.length() == 0) && defaultProtocol != null && defaultProtocol.length() > 0) {\n\t    changed = true;\n\t    //ä½¿ç”¨protocolé»˜è®¤å€¼è®¾ç½®URLçš„protocolå±æ€§\n\t    protocol = defaultProtocol;\n\t}\n\tif ((username == null || username.length() == 0) && defaultUsername != null && defaultUsername.length() > 0) {\n\t    changed = true;\n\t    //ä½¿ç”¨usernameé»˜è®¤å€¼è®¾ç½®URLçš„usernameå±æ€§\n\t    username = defaultUsername;\n\t}\n\tif ((password == null || password.length() == 0) && defaultPassword != null && defaultPassword.length() > 0) {\n\t    changed = true;\n\t    //ä½¿ç”¨passwordé»˜è®¤å€¼è®¾ç½®URLçš„passwordå±æ€§\n\t    password = defaultPassword;\n\t}\n\t/*if (u.isAnyHost() || u.isLocalHost()) {\n\t    changed = true;\n\t    host = NetUtils.getLocalHost();\n\t}*/\n\tif (port <= 0) {\n\t    //URLçš„portå±æ€§å€¼å°äº0ï¼Œä¸”é»˜è®¤çš„portå€¼å¤§äº0ï¼Œåˆ™ä½¿ç”¨defaultPortè®¾ç½®URLçš„portå±æ€§\n\t    if (defaultPort > 0) {\n\t\tchanged = true;\n\t\tport = defaultPort;\n\t    } else {\n\t\t//é»˜è®¤portå¦‚æœä¹Ÿå°äº0çš„è¯ï¼Œåˆ™è®¾ç½®URLçš„portå±æ€§ä¸º9090\n\t\tchanged = true;\n\t\tport = 9090;\n\t    }\n\t}\n\tif (path == null || path.length() == 0) {\n\t    //ä½¿ç”¨é»˜è®¤æœåŠ¡åç§°è®¾ç½®URLçš„pathå±æ€§\n\t    if (defaultPath != null && defaultPath.length() > 0) {\n\t\tchanged = true;\n\t\tpath = defaultPath;\n\t    }\n\t}\n\t//éå†é»˜è®¤å‚æ•°é›†åˆ\n\tif (defaultParameters != null && defaultParameters.size() > 0) {\n\t    for (Map.Entry<String, String> entry : defaultParameters.entrySet()) {\n\t\t//é»˜è®¤å‚æ•°key\n\t\tString key = entry.getKey();\n\t\t//é»˜è®¤å‚æ•°å€¼defaultValue\n\t\tString defaultValue = entry.getValue();\n\t\tif (defaultValue != null && defaultValue.length() > 0) {\n\t\t    //æŸ¥çœ‹URLå‚æ•°é›†åˆä¸­è¯¥å‚æ•°keyå¯¹åº”çš„å€¼\n\t\t    String value = parameters.get(key);\n\t\t    if (value == null || value.length() == 0) {\n\t\t\t//å¦‚æœURLä¸­çš„å‚æ•°å€¼ä¸ºç©ºï¼Œåˆ™ä½¿ç”¨è¯¥å‚æ•°keyçš„é»˜è®¤å€¼defaultValue\n\t\t\tchanged = true;\n\t\t\tparameters.put(key, defaultValue);\n\t\t    }\n\t\t}\n\t    }\n\t}\n\tif (changed) {\n\t    //å½“å‰URLçš„å±æ€§å€¼å‘é€æ”¹å˜äº†ï¼Œåˆ™é‡æ–°ç”Ÿæˆä¸€ä¸ªURLå¯¹è±¡\n\t    u = new URL(protocol, username, password, host, port, path, parameters);\n\t}\n\treturn u;\n}\n```\nåŠ è½½æ³¨å†Œä¸­å¿ƒURLåœ°å€çš„æ–¹æ³•åˆ†æå®Œäº†ï¼Œæˆ‘ä»¬å†æ¥çœ‹doExportUrlsFor1Protocolæ–¹æ³•\n```java\n/**\n * æš´éœ²æœåŠ¡Urlåˆ°å„ä¸ªæ³¨å†Œä¸­å¿ƒ\n * 1ã€mapè£…é…å‚æ•°\n * 2ã€åˆ©ç”¨mapä¸­çš„å‚æ•°æ„å»ºURLï¼Œä¸ºæš´éœ²æœåŠ¡åšå‡†å¤‡\n * 3ã€æ ¹æ®èŒƒå›´é€‰æ‹©æ˜¯æš´éœ²æœ¬åœ°æœåŠ¡ï¼Œè¿˜æ˜¯æš´éœ²è¿œç¨‹æœåŠ¡\n * 4ã€æ ¹æ®ä»£ç†å·¥å‚ç”ŸæˆæœåŠ¡ä»£ç†å¯¹è±¡invoker\n * 5ã€æ ¹æ®é…ç½®çš„åè®®ï¼Œæš´éœ²æœåŠ¡ä»£ç†\n * @param protocolConfig ä¾‹å¦‚: <dubbo:protocol name=\"dubbo\" port=\"20880\" id=\"dubbo\" />\n * @param registryURLs ä¾‹å¦‚: registry://224.5.6.7:1234/com.alibaba.dubbo.registry.RegistryService?application=demo-provider&dubbo=2.0.0&pid=4328&qos.port=22222&registry=multicast&timestamp=1528278313174\n */\nprivate void doExportUrlsFor1Protocol(ProtocolConfig protocolConfig, List<URL> registryURLs) {\n\t//è·å–åè®®åç§°\n\tString name = protocolConfig.getName();\n\tif (name == null || name.length() == 0) {\n\t    name = \"dubbo\";\n\t}\n\tMap<String, String> map = new HashMap<String, String>();\n\t//æ·»åŠ sideå‚æ•°ï¼Œå€¼ä¸ºproviderï¼Œæ ‡è¯†æœåŠ¡æä¾›ç«¯\n\tmap.put(Constants.SIDE_KEY, Constants.PROVIDER_SIDE);\n\t//æ·»åŠ dubboç‰ˆæœ¬\n\tmap.put(Constants.DUBBO_VERSION_KEY, Version.getVersion());\n\t//æ·»åŠ æ—¶é—´æˆ³\n\tmap.put(Constants.TIMESTAMP_KEY, String.valueOf(System.currentTimeMillis()));\n\tif (ConfigUtils.getPid() > 0) {\n\t    //æ·»åŠ pid\n\t    map.put(Constants.PID_KEY, String.valueOf(ConfigUtils.getPid()));\n\t}\n\t//æ·»åŠ å‚æ•°åˆ°map\n\tappendParameters(map, application);\n\tappendParameters(map, module);\n\tappendParameters(map, provider, Constants.DEFAULT_KEY);\n\tappendParameters(map, protocolConfig);\n\t//å½“å‰ServiceConfig(ServiceBean)\n\tappendParameters(map, this);\n\n\tif (methods != null && !methods.isEmpty()) {\n\t    //éå†æœåŠ¡æ–¹æ³•\n\t    for (MethodConfig method : methods) {\n\t\t//å°†methodçš„å±æ€§æ·»åŠ åˆ°mapä¸­\n\t\tappendParameters(map, method, method.getName());\n\t\t//è®¾ç½®æ–¹æ³•é‡è¯•æ¬¡æ•°(retryKeyæ˜¯mapçš„key)\n\t\tString retryKey = method.getName() + \".retry\";\n\t\tif (map.containsKey(retryKey)) {\n\t\t    String retryValue = map.remove(retryKey);\n\t\t    if (\"false\".equals(retryValue)) {\n\t\t        //retryValueå€¼ä¸ºfalseçš„è¯ï¼Œè¯´æ˜ä¸å¯ç”¨é‡è¯•\n\t\t\tmap.put(method.getName() + \".retries\", \"0\");\n\t\t    }\n\t\t}\n\t\t//è·å–å½“å‰æœåŠ¡æ–¹æ³•çš„å‚æ•°\n\t\tList<ArgumentConfig> arguments = method.getArguments();\n\t\tif (arguments != null && !arguments.isEmpty()) {\n\t\t    //éå†å½“å‰æœåŠ¡æ–¹æ³•çš„å‚æ•°é…ç½®\n\t\t    for (ArgumentConfig argument : arguments) {\n\t\t\tif (argument.getType() != null && argument.getType().length() > 0) {\n\t\t\t    //éå†æœåŠ¡æ¥å£çš„æ–¹æ³•åˆ—è¡¨\n\t\t\t    Method[] methods = interfaceClass.getMethods();\n\t\t\t    if (methods != null && methods.length > 0) {\n\t\t\t\tfor (int i = 0; i < methods.length; i++) {\n\t\t\t\t    //æ–¹æ³•å\n\t\t\t\t    String methodName = methods[i].getName();\n\t\t\t\t    if (methodName.equals(method.getName())) {\n\t\t\t\t\t//æ–¹æ³•åç§°ä¸€æ ·,è·å–æ–¹æ³•å‚æ•°ç±»å‹æ•°ç»„\n\t\t\t\t\tClass<?>[] argtypes = methods[i].getParameterTypes();\n\t\t\t\t\t// one callback in the method\n\t\t\t\t\tif (argument.getIndex() != -1) {\n\t\t\t\t\t    //æ ¡éªŒå‚æ•°çš„ç±»å‹æ˜¯å¦åŒ¹é…\n\t\t\t\t\t    if (argtypes[argument.getIndex()].getName().equals(argument.getType())) {\n\t\t\t\t\t\t//å°†æ–¹æ³•çš„å‚æ•°çš„å±æ€§æ·»åŠ åˆ°mapï¼Œå‰ç¼€ä¸ºï¼šæ–¹æ³•å.å‚æ•°ç´¢å¼•\n\t\t\t\t\t\tappendParameters(map, argument, method.getName() + \".\" + argument.getIndex());\n\t\t\t\t\t    } else {\n\t\t\t\t\t\t//å‚æ•°é…ç½®é”™è¯¯ï¼Œç´¢å¼•å’Œç±»å‹ä¸åŒ¹é…\n\t\t\t\t\t\tthrow new IllegalArgumentException(\"argument config error : the index attribute and type attribute not match :index :\" + argument.getIndex() + \", type:\" + argument.getType());\n\t\t\t\t\t    }\n\t\t\t\t\t} else {\n\t\t\t\t\t    // multiple callbacks in the method\n\t\t\t\t\t    for (int j = 0; j < argtypes.length; j++) {\n\t\t\t\t\t\t//å½“å‰å‚æ•°ç±»å‹\n\t\t\t\t\t\tClass<?> argclazz = argtypes[j];\n\t\t\t\t\t\t//å‚æ•°ç±»å‹åç§°åŒ¹é…\n\t\t\t\t\t\tif (argclazz.getName().equals(argument.getType())) {\n\t\t\t\t\t\t    appendParameters(map, argument, method.getName() + \".\" + j);\n\t\t\t\t\t\t    if (argument.getIndex() != -1 && argument.getIndex() != j) {\n\t\t\t\t\t\t\tthrow new IllegalArgumentException(\"argument config error : the index attribute and type attribute not match :index :\" + argument.getIndex() + \", type:\" + argument.getType());\n\t\t\t\t\t\t    }\n\t\t\t\t\t\t}\n\t\t\t\t\t    }\n\t\t\t\t\t}\n\t\t\t\t    }\n\t\t\t\t}\n\t\t\t    }\n\t\t\t} else if (argument.getIndex() != -1) {\n\t\t\t    appendParameters(map, argument, method.getName() + \".\" + argument.getIndex());\n\t\t\t} else {\n\t\t\t    //<dubbo:argument index='0' .../> or <dubbo:argument type=xxx .../>\n\t\t\t    throw new IllegalArgumentException(\"argument config must set index or type attribute.eg: <dubbo:argument index='0' .../> or <dubbo:argument type=xxx .../>\");\n\t\t\t}\n\n\t\t    }\n\t\t}\n\t    } // end of methods for\n\t}\n\t//(generic ï¼= null) && (generic = â€œtrueâ€ || \"nativejava\" || \"bean\") è¿”å› true\n\tif (ProtocolUtils.isGeneric(generic)) {\n\t    //æ·»åŠ genericå‚æ•°\n\t    map.put(Constants.GENERIC_KEY, generic);\n\t    //æ·»åŠ methodså‚æ•°ï¼Œå€¼ä¸º\"*\"\n\t    map.put(Constants.METHODS_KEY, Constants.ANY_VALUE);\n\t} else {\n\t    String revision = Version.getVersion(interfaceClass, version);\n\t    if (revision != null && revision.length() > 0) {\n\t        //æ·»åŠ ç‰ˆæœ¬\n\t\tmap.put(\"revision\", revision);\n\t    }\n\t    //ç”ŸæˆinterfaceClassç±»çš„åŒ…è£…ç±»ï¼Œè·å–æ–¹æ³•åç§°\n\t    String[] methods = Wrapper.getWrapper(interfaceClass).getMethodNames();\n\t    if (methods.length == 0) {\n\t\t//æœåŠ¡æ¥å£ä¸­æ²¡æœ‰å‘ç°æ–¹æ³•å®šä¹‰\n\t\tlogger.warn(\"NO method found in service interface \" + interfaceClass.getName());\n\t\t//æ·»åŠ methodså‚æ•°ï¼Œå€¼ä¸º\"*\"\n\t\tmap.put(Constants.METHODS_KEY, Constants.ANY_VALUE);\n\t    } else {\n\t\t//æ·»åŠ methodså‚æ•°ï¼Œå€¼ä¸ºé€—å·åˆ†éš”çš„æ–¹æ³•åç§°\n\t\tmap.put(Constants.METHODS_KEY, StringUtils.join(new HashSet<String>(Arrays.asList(methods)), \",\"));\n\t    }\n\t}\n\tif (!ConfigUtils.isEmpty(token)) {\n\t    //tokenä¸ºtrueæˆ–è€…tokenä¸ºdefaultï¼Œåˆ™isDefaultæ–¹æ³•è¿”å›true\n\t    if (ConfigUtils.isDefault(token)) {\n\t\t//æ·»åŠ tokenå‚æ•°ï¼Œå€¼ä¸ºuuid\n\t\tmap.put(Constants.TOKEN_KEY, UUID.randomUUID().toString());\n\t    } else {\n\t\t//æ·»åŠ tokenå‚æ•°\n\t\tmap.put(Constants.TOKEN_KEY, token);\n\t    }\n\t}\n\t//åˆ¤æ–­åè®®åç§°æ˜¯å¦ä¸º\"injvm\"\n\tif (Constants.LOCAL_PROTOCOL.equals(protocolConfig.getName())) {\n\t    //æœ¬åœ°åè®®ï¼Œä¸æ³¨å†Œ\n\t    protocolConfig.setRegister(false);\n\t    //æ·»åŠ notifyå‚æ•°ï¼Œå€¼ä¸ºfalse\n\t    map.put(\"notify\", \"false\");\n\t}\n\t//æš´éœ²æœåŠ¡\n\t//è·å–ä¸Šä¸‹æ–‡åœ°å€\n\tString contextPath = protocolConfig.getContextpath();\n\tif ((contextPath == null || contextPath.length() == 0) && provider != null) {\n\t    //è·å–providerå¯¹è±¡é…ç½®çš„ä¸Šä¸‹æ–‡åœ°å€\n\t    contextPath = provider.getContextpath();\n\t}\n\t//è·å–æ³¨å†Œip(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\tString host = this.findConfigedHosts(protocolConfig, registryURLs, map);\n\t//è·å–æ³¨å†Œç«¯å£(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\tInteger port = this.findConfigedPorts(protocolConfig, name, map);\n\t//æ ¹æ®åè®®åç§°nameã€ä¸»æœºhostã€ç«¯å£portã€ä¸Šä¸‹æ–‡ã€mapå‚æ•°æ„å»ºURLå¯¹è±¡(æœåŠ¡æš´éœ²çš„urlåœ°å€)\n\t//ä¾‹å¦‚urlï¼šdubbo://192.168.99.60:20880/com.alibaba.dubbo.demo.DemoService?anyhost=true&application=demo-provider&bind.ip=192.168.99.60&bind.port=20880&dubbo=2.0.0&generic=false&interface=com.alibaba.dubbo.demo.DemoService&methods=sayHello&pid=7184&qos.port=22222&side=provider&timestamp=1528347825839\n\tURL url = new URL(name, host, port, (contextPath == null || contextPath.length() == 0 ? \"\" : contextPath + \"/\") + path, map);\n\t//æŸ¥çœ‹ConfiguratorFactory(override/absent)æ˜¯å¦å­˜åœ¨url.getProtocol()æ‰©å±•ï¼Œå­˜åœ¨çš„è¯ï¼Œåˆ™é…ç½®è¯¥urlå¯¹è±¡\n\t//overrideä¼šè¦†ç›–å‚æ•°é…ç½®ï¼Œabsentåªæœ‰å‚æ•°ä¸å­˜åœ¨æ—¶æ‰ä¼šæ·»åŠ (åé¢çš„ç« èŠ‚ä¼šä»‹ç»è¯¥æ‰©å±•)\n\tif (ExtensionLoader.getExtensionLoader(ConfiguratorFactory.class).hasExtension(url.getProtocol())) {\n\t    url = ExtensionLoader.getExtensionLoader(ConfiguratorFactory.class)\n\t\t    .getExtension(url.getProtocol()).getConfigurator(url).configure(url);\n\t}\n\t//è·å–urlçš„scopeå‚æ•°\n\tString scope = url.getParameter(Constants.SCOPE_KEY);\n\t\n\t//åªæœ‰scope != none æ—¶æ‰ä¼šæš´éœ²æœåŠ¡ï¼Œscope = nullæ—¶ä¼šåŒæ—¶æš´éœ²æœ¬åœ°æœåŠ¡å’Œè¿œç¨‹æœåŠ¡\n\tif (!Constants.SCOPE_NONE.toString().equalsIgnoreCase(scope)) {\n\t    //scope != remote æš´éœ²æœ¬åœ°æœåŠ¡\n\t    if (!Constants.SCOPE_REMOTE.toString().equalsIgnoreCase(scope)) {\n\t\t//æœ¬åœ°æš´éœ²(åé¢å°èŠ‚ä¼šåˆ†æè¯¥æ–¹æ³•)\n\t\texportLocal(url);\n\t    }\n\t    if (!Constants.SCOPE_LOCAL.toString().equalsIgnoreCase(scope)) {\n\t         //scope != local æš´éœ²åˆ°è¿œç¨‹\n\t\tif (logger.isInfoEnabled()) {\n\t\t    //æš´éœ²dubboæœåŠ¡interfaceClassåˆ°url\n\t\t    logger.info(\"Export dubbo service \" + interfaceClass.getName() + \" to url \" + url);\n\t\t}\n\t\tif (registryURLs != null && !registryURLs.isEmpty()) {\n\t\t    //æ³¨å†Œä¸­å¿ƒåœ°å€registryURLsä¸ä¸ºç©ºï¼Œåˆ™éå†æ³¨å†Œä¸­å¿ƒåœ°å€ï¼Œå°†æœåŠ¡æš´éœ²åˆ°å„ä¸ªæ³¨å†Œä¸­å¿ƒ\n\t\t    for (URL registryURL : registryURLs) {\n\t\t\t\n\t\t\t//æ·»åŠ dynamicå‚æ•°åˆ°urlä¸­ï¼Œå‚æ•°å€¼ä»å½“å‰æ³¨å†Œä¸­å¿ƒçš„å‚æ•°ä¸­è·å–\n\t\t\turl = url.addParameterIfAbsent(Constants.DYNAMIC_KEY, registryURL.getParameter(Constants.DYNAMIC_KEY));\n\t\t\t\n\t\t\t//æ„é€ ç›‘æ§url(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\t\t\tURL monitorUrl = loadMonitor(registryURL);\n\t\t\tif (monitorUrl != null) {\n\t\t\t    //æ·»åŠ monitorå‚æ•°(ç¼–ç )åˆ°urlä¸­\n\t\t\t    url = url.addParameterAndEncoded(Constants.MONITOR_KEY, monitorUrl.toFullString());\n\t\t\t}\n\t\t\t\n\t\t\tif (logger.isInfoEnabled()) {\n\t\t\t    //æ³¨å†ŒdubboæœåŠ¡ interfaceClassçš„url åˆ°æ³¨å†Œä¸­å¿ƒregistryURLä¸Š\n\t\t\t    logger.info(\"Register dubbo service \" + interfaceClass.getName() + \" url \" + url + \" to registry \" + registryURL);\n\t\t\t}\n\t\t\t\n\t\t\t//registryURLåœ°å€ä¸Šæ·»åŠ exportå‚æ•°ï¼Œå‚æ•°å€¼ä¸ºæœåŠ¡æš´éœ²çš„url(å³interfaceClassçš„url)\n\t\t\t//æ ¹æ®refã€interfaceClassã€registryURLåˆ›å»ºæœåŠ¡ä»£ç†å¯¹è±¡Invoker(åé¢å°èŠ‚ä¼šåˆ†æè¯¥æ–¹æ³•)\n\t\t\tInvoker<?> invoker = proxyFactory.getInvoker(ref, (Class) interfaceClass, registryURL.addParameterAndEncoded(Constants.EXPORT_KEY, url.toFullString()));\n\t\t\t\n\t\t\t//å°†invokerå’Œå½“å‰å¯¹è±¡thisåŒ…è£…æˆDelegateProviderMetaDataInvokerå¯¹è±¡(åé¢å°èŠ‚ä¼šåˆ†æè¯¥æ–¹æ³•)\n\t\t\tDelegateProviderMetaDataInvoker wrapperInvoker = new DelegateProviderMetaDataInvoker(invoker, this);\n\t\t\t\n\t\t\t//åœ¨æ­¤å¤„å¼€å§‹æš´éœ²æœåŠ¡\n\t\t\t//è°ƒç”¨exportæ–¹æ³•æš´éœ²æœåŠ¡ï¼Œå¾—åˆ°exporterå¯¹è±¡(åé¢å°èŠ‚ä¼šåˆ†æè¯¥æ–¹æ³•)\n\t\t\tExporter<?> exporter = protocol.export(wrapperInvoker);\n\t\t\t//ä¿å­˜æš´éœ²çš„æœåŠ¡åˆ°æœ¬åœ°å˜é‡exportersä¸­\n\t\t\texporters.add(exporter);\n\t\t    }\n\t\t} else {\n\t\t    //æ³¨å†Œä¸­å¿ƒåœ°å€registryURLsä¸ºç©º\n\t\t    Invoker<?> invoker = proxyFactory.getInvoker(ref, (Class) interfaceClass, url);\n\t\t    DelegateProviderMetaDataInvoker wrapperInvoker = new DelegateProviderMetaDataInvoker(invoker, this);\n\t\t    Exporter<?> exporter = protocol.export(wrapperInvoker);\n\t\t    exporters.add(exporter);\n\t\t}\n\t    }\n\t}\n\t//ä¿å­˜æš´éœ²çš„æœåŠ¡url\n\tthis.urls.add(url);\n}\n```\næˆ‘ä»¬ä¾æ¬¡çœ‹ä¸‹ä¸Šé¢ç”¨åˆ°çš„æ–¹æ³•: findConfigedHostsã€findConfigedPortsã€loadMonitor\nexportLocalã€getInvokerã€exportæ–¹æ³•å°†åœ¨åé¢çš„ç« èŠ‚(Dubboæºç é˜…è¯»ä¹‹æœåŠ¡æš´éœ²)è¿›è¡Œè¯¦ç»†ä»‹ç»ã€‚\n```java\n/**\n * ä¸ºæœåŠ¡æä¾›è€… è·å–æ³¨å†Œipå’Œç»‘å®šipï¼Œå¯ä»¥å•ç‹¬é…ç½®\n * Register & bind IP address for service provider, can be configured separately.\n * Configuration priority:\n * environment variables -> java system properties -> host property in config file ->\n * /etc/hosts -> default network address -> first available network address\n * @param protocolConfig\n * @param registryURLs\n * @param map\n * @return æ³¨å†Œip\n */\nprivate String findConfigedHosts(ProtocolConfig protocolConfig, List<URL> registryURLs, Map<String, String> map) {\n\tboolean anyhost = false;\n\t//ä»ç³»ç»Ÿé…ç½®ä¸­è·å–è·å–ç»‘å®šip\n\tString hostToBind = getValueFromConfig(protocolConfig, Constants.DUBBO_IP_TO_BIND);\n\tif (hostToBind != null && hostToBind.length() > 0 && isInvalidLocalHost(hostToBind)) {\n\t    //æ— æ•ˆçš„ip\n\t    throw new IllegalArgumentException(\"Specified invalid bind ip from property:\" + Constants.DUBBO_IP_TO_BIND + \", value:\" + hostToBind);\n\t}\n\tif (hostToBind == null || hostToBind.length() == 0) {\n\t    //ä»åè®®é…ç½®ä¸­è·å–æœåŠ¡ipåœ°å€\n\t    hostToBind = protocolConfig.getHost();\n\t    if (provider != null && (hostToBind == null || hostToBind.length() == 0)) {\n\t\t//ä»æœåŠ¡æä¾›è€…ä¸­è·å–æœåŠ¡ipåœ°å€\n\t\thostToBind = provider.getHost();\n\t    }\n\t    if (isInvalidLocalHost(hostToBind)) {\n\t\t//ä»ç„¶æ˜¯æ— æ•ˆçš„åœ°å€ï¼Œåˆ™è®¾ç½®anyhost=true\n\t\tanyhost = true;\n\t\ttry {\n\t\t    //è·å–æœ¬åœ°åœ°å€\n\t\t    hostToBind = InetAddress.getLocalHost().getHostAddress();\n\t\t} catch (UnknownHostException e) {\n\t\t    logger.warn(e.getMessage(), e);\n\t\t}\n\t\tif (isInvalidLocalHost(hostToBind)) {\n\t\t    //ä»ç„¶æ˜¯æ— æ•ˆçš„åœ°å€ï¼Œéå†æ³¨å†Œä¸­å¿ƒurlåˆ—è¡¨\n\t\t    if (registryURLs != null && !registryURLs.isEmpty()) {\n\t\t\tfor (URL registryURL : registryURLs) {\n\t\t\t    if (Constants.MULTICAST.equalsIgnoreCase(registryURL.getParameter(\"registry\"))) {\n\t\t\t\t// è·³è¿‡ç»„æ’­registryï¼Œå› ä¸ºæˆ‘ä»¬ä¸å¯ä»¥é€šè¿‡Socketè¿æ¥åˆ°å®ƒ\n\t\t\t\tcontinue;\n\t\t\t    }\n\t\t\t    try {\n\t\t\t\tSocket socket = new Socket();\n\t\t\t\ttry {\n\t\t\t\t    //æ ¹æ®æ³¨å†Œä¸­å¿ƒhostå’Œportæ„å»ºSocketAddress\n\t\t\t\t    SocketAddress addr = new InetSocketAddress(registryURL.getHost(), registryURL.getPort());\n\t\t\t\t    //è¿æ¥åˆ°è¯¥åœ°å€\n\t\t\t\t    socket.connect(addr, 1000);\n\t\t\t\t    //è¿æ¥æˆåŠŸçš„è¯ï¼Œåˆ™è·å–åˆ°ç»‘å®šåœ°å€ï¼Œå¹¶è·³å‡ºå¾ªç¯\n\t\t\t\t    hostToBind = socket.getLocalAddress().getHostAddress();\n\t\t\t\t    break;\n\t\t\t\t} finally {\n\t\t\t\t    try {\n\t\t\t\t\tsocket.close();\n\t\t\t\t    } catch (Throwable e) {\n\t\t\t\t    }\n\t\t\t\t}\n\t\t\t    } catch (Exception e) {\n\t\t\t\tlogger.warn(e.getMessage(), e);\n\t\t\t    }\n\t\t\t}\n\t\t    }\n\t\t    if (isInvalidLocalHost(hostToBind)) {\n\t\t\t//ä»ç„¶ä¸ºæ— æ•ˆæœ¬åœ°åœ°å€çš„è¯ï¼Œåˆ™ä½¿ç”¨æœ¬åœ°åœ°å€\n\t\t\thostToBind = getLocalHost();\n\t\t    }\n\t\t}\n\t    }\n\t}\n\t//æ·»åŠ bind.ipå‚æ•°\n\tmap.put(Constants.BIND_IP_KEY, hostToBind);\n\t// é»˜è®¤æƒ…å†µä¸‹ï¼Œæ³¨å†Œipä¸ç”¨äºç»‘å®šip\n\t// è·å–æ³¨å†Œip\n\tString hostToRegistry = getValueFromConfig(protocolConfig, Constants.DUBBO_IP_TO_REGISTRY);\n\tif (hostToRegistry != null && hostToRegistry.length() > 0 && isInvalidLocalHost(hostToRegistry)) {\n\t    throw new IllegalArgumentException(\"Specified invalid registry ip from property:\" + Constants.DUBBO_IP_TO_REGISTRY + \", value:\" + hostToRegistry);\n\t} else if (hostToRegistry == null || hostToRegistry.length() == 0) {\n\t    //é»˜è®¤æƒ…å†µä¸‹ï¼Œç»‘å®šipç”¨äºæ³¨å†Œip\n\t    hostToRegistry = hostToBind;\n\t}\n\t//æ·»åŠ anyhostå‚æ•°\n\tmap.put(Constants.ANYHOST_KEY, String.valueOf(anyhost));\n\treturn hostToRegistry;\n}\n\n/**\n * ä¸ºæœåŠ¡æä¾›è€… è·å–æ³¨å†Œç«¯å£å’Œç»‘å®šç«¯å£\n * Register port and bind port for the provider, can be configured separately\n * Configuration priority:\n * environment variable -> java system properties -> port property in protocol config file\n * -> protocol default port\n * @param protocolConfig\n * @param name\n * @return æ³¨å†Œç«¯å£\n */\nprivate Integer findConfigedPorts(ProtocolConfig protocolConfig, String name, Map<String, String> map) {\n\tInteger portToBind = null;\n\n\t//ä»ç³»ç»Ÿé…ç½®ä¸­è·å–ç»‘å®šç«¯å£\n\tString port = getValueFromConfig(protocolConfig, Constants.DUBBO_PORT_TO_BIND);\n\tportToBind = parsePort(port);\n\n\tif (portToBind == null) {\n\t    //ä»åè®®é…ç½®ä¸­è·å–ç»‘å®šç«¯å£\n\t    portToBind = protocolConfig.getPort();\n\t    if (provider != null && (portToBind == null || portToBind == 0)) {\n\t\t//ä»æœåŠ¡æä¾›è€…ä¸­è·å–ç»‘å®šç«¯å£\n\t\tportToBind = provider.getPort();\n\t    }\n\t    //æ ¹æ®åè®®åç§°è·å–é»˜è®¤ç»‘å®šç«¯å£\n\t    final int defaultPort = ExtensionLoader.getExtensionLoader(Protocol.class).getExtension(name).getDefaultPort();\n\t    if (portToBind == null || portToBind == 0) {\n\t\tportToBind = defaultPort;\n\t    }\n\t    if (portToBind == null || portToBind <= 0) {\n\t\t//è·å–éšæœºç«¯å£\n\t\tportToBind = getRandomPort(name);\n\t\tif (portToBind == null || portToBind < 0) {\n\t\t    //è·å–å¯ç”¨ç«¯å£\n\t\t    portToBind = getAvailablePort(defaultPort);\n\t\t    //è®¾ç½®éšæœºç«¯å£(æ”¾å…¥mapç¼“å­˜)\n\t\t    putRandomPort(name, portToBind);\n\t\t}\n\t\tlogger.warn(\"Use random available port(\" + portToBind + \") for protocol \" + name);\n\t    }\n\t}\n\t//ä¿å­˜ç»‘å®šç«¯å£ï¼Œç¨åç”¨ä½œurlçš„key\n\tmap.put(Constants.BIND_PORT_KEY, String.valueOf(portToBind));\n\t// registry port, not used as bind port by default\n\tString portToRegistryStr = getValueFromConfig(protocolConfig, Constants.DUBBO_PORT_TO_REGISTRY);\n\tInteger portToRegistry = parsePort(portToRegistryStr);\n\tif (portToRegistry == null) {\n\t    //æ³¨å†Œç«¯å£ä½¿ç”¨ç»‘å®šç«¯å£\n\t    portToRegistry = portToBind;\n\t}\n\treturn portToRegistry;\n}\n\n/**\n * æ„é€ ç›‘æ§URL\n * @param registryURL æ³¨å†Œä¸­å¿ƒURL\n * @return\n */\nprotected URL loadMonitor(URL registryURL) {\n\tif (monitor == null) {\n\t    //è·å–ç›‘æ§åœ°å€ã€ç›‘æ§åè®®é…ç½®\n\t    String monitorAddress = ConfigUtils.getProperty(\"dubbo.monitor.address\");\n\t    String monitorProtocol = ConfigUtils.getProperty(\"dubbo.monitor.protocol\");\n\t    if ((monitorAddress == null || monitorAddress.length() == 0) && (monitorProtocol == null || monitorProtocol.length() == 0)) {\n\t\t//å¦‚æœç›‘æ§åœ°å€å’Œç›‘æ§åè®®ä¸ºç©ºï¼Œåˆ™è¿”å›Null\n\t\treturn null;\n\t    }\n\t    //æ„é€ ç›‘æ§é…ç½®å¯¹è±¡(åœ°å€ã€åè®®)\n\t    monitor = new MonitorConfig();\n\t    if (monitorAddress != null && monitorAddress.length() > 0) {\n\t\tmonitor.setAddress(monitorAddress);\n\t    }\n\t    if (monitorProtocol != null && monitorProtocol.length() > 0) {\n\t\tmonitor.setProtocol(monitorProtocol);\n\t    }\n\t}\n\t//æ·»åŠ å±æ€§\n\tappendProperties(monitor);\n\t//å‚æ•°\n\tMap<String, String> map = new HashMap<String, String>();\n\t//æ·»åŠ interfaceå‚æ•°\n\tmap.put(Constants.INTERFACE_KEY, MonitorService.class.getName());\n\t//æ·»åŠ dubboç‰ˆæœ¬\n\tmap.put(\"dubbo\", Version.getVersion());\n\t//æ·»åŠ æ—¶é—´æˆ³\n\tmap.put(Constants.TIMESTAMP_KEY, String.valueOf(System.currentTimeMillis()));\n\tif (ConfigUtils.getPid() > 0) {\n\t    //æ·»åŠ pid\n\t    map.put(Constants.PID_KEY, String.valueOf(ConfigUtils.getPid()));\n\t}\n\t//æ·»åŠ monitorå±æ€§\n\tappendParameters(map, monitor);\n\t//è·å–monitoråœ°å€ï¼Œä¼˜å…ˆä½¿ç”¨ç³»ç»Ÿé…ç½®å€¼\n\tString address = monitor.getAddress();\n\tString sysaddress = System.getProperty(\"dubbo.monitor.address\");\n\tif (sysaddress != null && sysaddress.length() > 0) {\n\t    address = sysaddress;\n\t}\n\tif (ConfigUtils.isNotEmpty(address)) {\n\t    if (!map.containsKey(Constants.PROTOCOL_KEY)) {\n\t\t//åè®®åœ°å€ä¸ä¸ºç©ºï¼Œä¸”mapä¸­ä¸åŒ…å«protocolå±æ€§æ—¶ï¼Œåˆ™è®¾ç½®protocol\n\t\tif (ExtensionLoader.getExtensionLoader(MonitorFactory.class).hasExtension(\"logstat\")) {\n\t\t    //åŒ…å«logstatæ‰©å±•\n\t\t    map.put(Constants.PROTOCOL_KEY, \"logstat\");\n\t\t} else {\n\t\t    //æ·»åŠ protocolå±æ€§\n\t\t    map.put(Constants.PROTOCOL_KEY, \"dubbo\");\n\t\t}\n\t    }\n\t    //ç”ŸæˆURLå¯¹è±¡\n\t    return UrlUtils.parseURL(address, map);\n\t} else if (Constants.REGISTRY_PROTOCOL.equals(monitor.getProtocol()) && registryURL != null) {\n\t    //ç›‘æ§addressä¸ºç©º\n\t    //registryURLä¸ä¸ºç©ºï¼Œä¸”monitorçš„åè®®ä¸ºregistryæ³¨å†Œä¸­å¿ƒåè®®\n\t    return registryURL.setProtocol(\"dubbo\")\n\t\t    //æ·»åŠ protocolå±æ€§ä¸ºregistry\n\t\t    .addParameter(Constants.PROTOCOL_KEY, \"registry\")\n\t\t    //æ·»åŠ referå±æ€§ï¼Œå±æ€§å€¼ä¸ºmapå‚æ•°\n\t\t    .addParameterAndEncoded(Constants.REFER_KEY, StringUtils.toQueryString(map));\n\t}\n\treturn null;\n}\n```\n\nç”±äºæœ¬å°èŠ‚ä¸»è¦æ˜¯è®²ServiceAnnotationBeanPostProcessorç±»å®ç°ï¼Œå…³äºæœåŠ¡æš´éœ²çš„å†…å®¹å°†ä¼šæ”¾åˆ°ä¸‹ä¸€å°èŠ‚ä»‹ç»ã€‚\n","tags":["dubbo"]},{"title":"Dubboæºç é˜…è¯»ä¹‹é›†æˆSpring-æ ‡ç­¾è§£æ(02)","url":"/blog/2018/08/04/Dubboæºç é˜…è¯»ä¹‹é›†æˆSpring-02æ ‡ç­¾è§£æ/","content":">æœ¬å°èŠ‚å°†ä¼šä»‹ç»dubboæ ‡ç­¾çš„è§£æ.\n\nä¸ŠèŠ‚è®²åˆ°Dubboè§£ææ ‡ç­¾çš„ç±»æ˜¯DubboBeanDefinitionParser,ç°åœ¨æˆ‘ä»¬å°±æ¥åˆ†æä¸‹è¯¥ç±»,è¯¥ç±»å®ç°äº†Springçš„BeanDefinitionParseræ¥å£ï¼Œæˆ‘ä»¬éœ€è¦å®ç°å®ƒçš„parseæ–¹æ³•:\n\n### DubboBeanDefinitionParserè§£æç±»\n```java\npublic class DubboBeanDefinitionParser implements BeanDefinitionParser{\n \n    private static final Pattern GROUP_AND_VERION = Pattern.compile(\"^[\\\\-.0-9_a-zA-Z]+(\\\\:[\\\\-.0-9_a-zA-Z]+)?$\");\n    \n    //å¸¦è§£æå®ä¾‹åŒ–çš„beanç±»\n    private final Class<?> beanClass;\n    \n    //æ˜¯å¦å¿…å¡«\n    private final boolean required;\n\n    public DubboBeanDefinitionParser(Class<?> beanClass, boolean required) {\n        this.beanClass = beanClass;\n        this.required = required;\n    }\n\n    @Override\n    public BeanDefinition parse(Element element, ParserContext parserContext) {\n        //è°ƒç”¨äº†å†…éƒ¨çš„parseæ–¹æ³•\n        return parse(element, parserContext, beanClass, required);\n    }\n   \n    private static BeanDefinition parse(Element element, ParserContext parserContext,\n                                        Class<?> beanClass, boolean required) {\n        //åˆ›å»ºRootBeanDefinitionå®ä¾‹\n        RootBeanDefinition beanDefinition = new RootBeanDefinition();\n        //è®¾ç½®è¦å®ä¾‹åŒ–çš„ç±»\n        beanDefinition.setBeanClass(beanClass);\n        //æ˜¯å¦å»¶è¿Ÿåˆå§‹åŒ–\n        beanDefinition.setLazyInit(false);\n        \n        //è·å–å…ƒç´ çš„idå±æ€§ä½œä¸ºbeançš„id\n        String id = element.getAttribute(\"id\");\n        if ((id == null || id.length() == 0) && required) {\n            //å¦‚æœidå±æ€§ä¸ºç©ºï¼Œå¹¶ä¸”æ˜¯å¿…å¡«çš„ï¼Œåˆ™å–å…ƒç´ çš„nameå±æ€§\n            String generatedBeanName = element.getAttribute(\"name\");\n            if (generatedBeanName == null || generatedBeanName.length() == 0) {\n                //å¦‚æœnameå±æ€§ä¸ºç©ºï¼Œåˆ™ç”Ÿæˆä¸€ä¸ªbeanåç§°\n                //åˆ¤æ–­å½“å‰è¦å®ä¾‹åŒ–çš„beanç±»æ˜¯å¦æ˜¯ProtocolConfigç±»ï¼ˆå³å½“å‰æ˜¯å¦ä¸º<dubbo:protocol>æ ‡ç­¾ï¼‰\n                if (ProtocolConfig.class.equals(beanClass)) {\n                    //å½“å‰æ˜¯ProtocolConfigç±»ï¼Œåˆ™è®¾ç½®beanåç§°ä¸ºdubbo\n                    generatedBeanName = \"dubbo\";\n                } else {\n                    //ä¸æ˜¯ProtocolConfigç±»,åˆ™ä½¿ç”¨interfaceå±æ€§åšä¸ºbeançš„åç§°\n                    generatedBeanName = element.getAttribute(\"interface\");\n                }\n            }\n            //å¦‚æœbeanåç§°ä¸ºç©ºï¼Œåˆ™ä½¿ç”¨å½“å‰å®ä¾‹åŒ–çš„ç±»çš„åç§°\n            if (generatedBeanName == null || generatedBeanName.length() == 0) {\n                generatedBeanName = beanClass.getName();\n            }\n            //åŒæ—¶å°†beançš„idå±æ€§è®¾ç½®ä¸ºbeançš„åç§°\n            id = generatedBeanName;\n            int counter = 2;\n            //å¦‚æœä¸Šä¸‹æ–‡ä¸­å·²ç»å­˜åœ¨è¯¥idï¼Œåˆ™å¯¹è¯¥beançš„idåšé˜²é‡å¤„ç†\n            while (parserContext.getRegistry().containsBeanDefinition(id)) {\n                id = generatedBeanName + (counter++);\n            }\n        }\n        if (id != null && id.length() > 0) {\n            //å¦‚æœidå±æ€§ä¸ä¸ºç©ºï¼Œåˆ™æ ¡éªŒSpringä¸­æ˜¯å¦å·²å­˜åœ¨è¯¥id\n            if (parserContext.getRegistry().containsBeanDefinition(id)) {\n                throw new IllegalStateException(\"Duplicate spring bean id \" + id);\n            }\n            //é€šè¿‡idæ³¨å†Œè¯¥bean\n            parserContext.getRegistry().registerBeanDefinition(id, beanDefinition);\n            //è®¾ç½®beançš„idå±æ€§å€¼\n            beanDefinition.getPropertyValues().addPropertyValue(\"id\", id);\n        }\n        //è¿›ä¸€æ­¥è§£æ<dubbo:protocol/>æ ‡ç­¾\n        //å¦‚ï¼š<dubbo:protocol name=\"dubbo\" port=\"20880\"/>\n        if (ProtocolConfig.class.equals(beanClass)) {\n            //å¦‚æœå½“å‰è¦å®ä¾‹åŒ–çš„beanæ˜¯ProtocolConfigç±»ï¼Œåˆ™éå†Springæ‰€æœ‰å·²ç»æ³¨å†Œçš„beançš„åç§°\n            for (String name : parserContext.getRegistry().getBeanDefinitionNames()) {\n                //æ ¹æ®beanåç§°è·å–å·²æ³¨å†Œçš„beanå®šä¹‰\n                BeanDefinition definition = parserContext.getRegistry().getBeanDefinition(name);\n                //æŸ¥çœ‹å·²æ³¨å†Œçš„beanå®šä¹‰ä¸­æ˜¯å¦å­˜åœ¨protocolå±æ€§\n                PropertyValue property = definition.getPropertyValues().getPropertyValue(\"protocol\");\n                if (property != null) {\n                    //å­˜åœ¨protocolå±æ€§ï¼Œåˆ™è·å–protocolå±æ€§å€¼\n                    Object value = property.getValue();\n                    //å¦‚æœprotocolå±æ€§å€¼ä¸ºProtocolConfigç±»å‹ï¼Œå¹¶ä¸”å½“å‰å®ä¾‹åŒ–çš„beançš„idç­‰äºprotocolå±æ€§å€¼çš„nameå±æ€§å€¼çš„è¯ï¼Œ\n                    //åˆ™å°†å½“å‰å®ä¾‹åŒ–çš„beanåŒ…è£…æˆRuntimeBeanReferenceç±»å‹\n                    //ç„¶åå°†å·²æ³¨å†Œçš„beançš„protocolå±æ€§çš„å€¼è®¾ä¸ºåˆšæ‰æ–°åˆ›å»ºçš„RuntimeBeanReference\n                    //ä¹Ÿå°±æ˜¯è¯´å°†å½“å‰è§£æçš„beanï¼ˆProtocolConfigï¼‰è®¾ç½®åˆ°å…¶ä»–å·²æ³¨å†Œçš„beançš„protocolå±æ€§ä¸­\n                    if (value instanceof ProtocolConfig && id.equals(((ProtocolConfig) value).getName())) {\n                        definition.getPropertyValues().addPropertyValue(\"protocol\", new RuntimeBeanReference(id));\n                    }\n                }\n            }\n        } else if (ServiceBean.class.equals(beanClass)) {\n            //è¿›ä¸€æ­¥è§£æ<dubbo:service/>æ ‡ç­¾ï¼Œè¿™é‡Œçš„é€»è¾‘å°±æ˜¯å¤„ç†ä¸‹é¢çš„ç¬¬äºŒç§é…ç½®\n            //å¦‚ï¼š<dubbo:service protocol=\"dubbo\" ref=\"userService\" interface=\"org.dubbo.service.UserInterface\" retries=\"0\" />\n            //   <bean id=\"userService\" class=\"org.dubbo.service.impl.UserServiceImpl\" />\n            //å’Œå¦‚ä¸‹é…ç½®ç›¸åŒ\n            //<dubbo:service interface=\"org.dubbo.service.UserInterface\" class=\"org.dubbo.service.impl.UserServiceImpl\" protocol=\"dubbo\" retries=\"0\">\n            //   <property name=\"name\" value=\"dubbo\" ref=\"\"/>\n            //   <property name=\"age\" value=\"5\" ref=\"\"/>\n            //</dubbo:service>\n\n            //å¦‚æœå½“å‰è¦å®ä¾‹åŒ–çš„beanæ˜¯ServiceBeanç±»,åˆ™è·å–classå±æ€§å¹¶è§£æ\n            String className = element.getAttribute(\"class\");\n            if (className != null && className.length() > 0) {\n                //å¦‚æœclasså±æ€§ä¸ä¸ºç©ºï¼Œåˆ™å®ä¾‹åŒ–è¯¥classå±æ€§æŒ‡å®šçš„ç±»\n                RootBeanDefinition classDefinition = new RootBeanDefinition();\n                classDefinition.setBeanClass(ReflectUtils.forName(className));\n                classDefinition.setLazyInit(false);\n                //è§£æå­æ ‡ç­¾å…ƒç´ (å³ä¸Šé¢ä¾‹å­ä¸­çš„propertyå±æ€§)(åé¢ä¼šä»‹ç»parsePropertiesæ–¹æ³•)\n                parseProperties(element.getChildNodes(), classDefinition);\n                //ä¸ºå½“å‰å¾…å®ä¾‹åŒ–çš„beanå®šä¹‰å¢åŠ refå±æ€§å€¼ï¼ˆå³classå±æ€§å¯¹åº”çš„beanï¼Œidä¸º beanId + implï¼‰\n                beanDefinition.getPropertyValues().addPropertyValue(\"ref\", new BeanDefinitionHolder(classDefinition, id + \"Impl\"));\n            }\n        } else if (ProviderConfig.class.equals(beanClass)) {\n            //è¿›ä¸€æ­¥å¤„ç†<dubbo:provider/>æ ‡ç­¾(åé¢ä¼šåˆ†æparseNestedæ–¹æ³•)\n            parseNested(element, parserContext, ServiceBean.class, true, \"service\", \"provider\", id, beanDefinition);\n        } else if (ConsumerConfig.class.equals(beanClass)) {\n            //è¿›ä¸€æ­¥å¤„ç†<dubbo:consumer/>æ ‡ç­¾çš„å­æ ‡ç­¾<dubbo:reference/>\n            parseNested(element, parserContext, ReferenceBean.class, false, \"reference\", \"consumer\", id, beanDefinition);\n        }\n        \n\t//å½“å‰å¾…å®ä¾‹åŒ–çš„beançš„æ‰€æœ‰çš„å±æ€§(é€šè¿‡setæ–¹æ³•è·å–åˆ°)\n        Set<String> props = new HashSet<String>();\n        ManagedMap parameters = null;\n        //éå†å¾…å®ä¾‹åŒ–ç±»çš„æ‰€æœ‰æ–¹æ³•,æ‰¾åˆ°setæ–¹æ³•\n        for (Method setter : beanClass.getMethods()) {\n            \n            String name = setter.getName();\n            \n            //æ‰¾åˆ°setæ–¹æ³•ï¼Œæ¡ä»¶å¦‚ä¸‹ï¼šæ–¹æ³•åé•¿åº¦å¤§äº3ï¼Œä»¥setå¼€å¤´ï¼Œæ˜¯publicä¿®é¥°ç¬¦ï¼Œå‚æ•°ç±»å‹é•¿åº¦ä¸º1\n            if (name.length() > 3 && name.startsWith(\"set\")\n                    && Modifier.isPublic(setter.getModifiers())\n                    && setter.getParameterTypes().length == 1) {\n               \n                 //è·å–å‚æ•°ç±»å‹\n                Class<?> type = setter.getParameterTypes()[0];\n\n                //å¦‚setFirstName(String firstName)æ–¹æ³•\n                //å°†ä¼šå¾—åˆ°property=first-name\n                String property = StringUtils.camelToSplitName(name.substring(3, 4).toLowerCase() + name.substring(4), \"-\");\n          \n\t        //å°†å±æ€§åç§°æ·»åŠ åˆ°propsé›†åˆä¸­\n                props.add(property);\n               \n                //è·å–åˆ°å±æ€§çš„getæ–¹æ³•\n                Method getter = null;\n               \n                try {\n                    getter = beanClass.getMethod(\"get\" + name.substring(3), new Class<?>[0]);\n                } catch (NoSuchMethodException e) {\n                    try {\n                        //å¦‚æœæ²¡æœ‰æ‰¾åˆ°getæ–¹æ³•ï¼Œåˆ™å°è¯•æ‰¾åˆ°isXXXæ–¹æ³•\n                        getter = beanClass.getMethod(\"is\" + name.substring(3), new Class<?>[0]);\n                    } catch (NoSuchMethodException e2) {\n                    }\n                }\n                if (getter == null\n                        || !Modifier.isPublic(getter.getModifiers())\n                        || !type.equals(getter.getReturnType())) {\n                    //å¦‚æœgetæ–¹æ³•ä¸ºç©ºã€ä¸æ˜¯publicé™å®šç¬¦ã€æˆ–è€…getæ–¹æ³•è¿”å›å€¼å’Œsetæ–¹æ³•å‚æ•°ç±»å‹ä¸ä¸€è‡´çš„è¯ï¼Œ\n                    //åˆ™è·³è¿‡è¯¥propertyçš„å¤„ç†ï¼Œè¿›è¡Œä¸‹ä¸€ä¸ªpropertyçš„å¤„ç†\n                    continue;\n                }\n                if (\"parameters\".equals(property)) {\n                    //å¦‚æœå½“å‰propertyä¸ºparametersï¼Œåˆ™è§£æå½“å‰å…ƒç´ çš„å­å…ƒç´ (<dubbo:parameter>æ ‡ç­¾)(åé¢ä¼šåˆ†æparseParametersæ–¹æ³•)\n                    parameters = parseParameters(element.getChildNodes(), beanDefinition);\n                } else if (\"methods\".equals(property)) {\n                    //å¦‚æœå½“å‰propertyä¸ºmethodsï¼Œåˆ™è§£æå½“å‰å…ƒç´ çš„å­å…ƒç´ (<dubbo:method>æ ‡ç­¾)(åé¢ä¼šåˆ†æparseMethodsæ–¹æ³•)\n                    parseMethods(id, element.getChildNodes(), beanDefinition, parserContext);\n                } else if (\"arguments\".equals(property)) {\n                    //å¦‚æœå½“å‰propertyä¸ºargumentsï¼Œåˆ™è§£æå½“å‰å…ƒç´ çš„å­å…ƒç´ (<dubbo:argument>æ ‡ç­¾)(åé¢ä¼šåˆ†æparseArgumentsæ–¹æ³•)\n                    parseArguments(id, element.getChildNodes(), beanDefinition, parserContext);\n                } else {\n                    //ä»xmlå®šä¹‰ä¸­è·å–propertyå±æ€§å€¼\n                    String value = element.getAttribute(property);\n                    if (value != null) {\n                        value = value.trim();\n                        if (value.length() > 0) {\n                            if (\"registry\".equals(property) && RegistryConfig.NO_AVAILABLE.equalsIgnoreCase(value)) {\n                                //å¦‚æœå½“å‰å±æ€§ä¸ºregistryï¼Œå¹¶ä¸”å±æ€§å€¼ä¸ºN/A\n                                //åˆ™ä¸ºå½“å‰beanå®šä¹‰æ·»åŠ å±æ€§registryï¼Œå¹¶ä¸”å±æ€§å€¼ä¸ºRegistryConfigå¯¹è±¡(è¯¥å¯¹è±¡çš„addresså±æ€§å€¼ä¸ºä¸å¯ç”¨)\n                                RegistryConfig registryConfig = new RegistryConfig();\n                                registryConfig.setAddress(RegistryConfig.NO_AVAILABLE);\n                                beanDefinition.getPropertyValues().addPropertyValue(property, registryConfig);\n                            } else if (\"registry\".equals(property) && value.indexOf(',') != -1) {\n                                //å¦‚æœå½“å‰å±æ€§ä¸ºregistryï¼Œå¹¶ä¸”å±æ€§å€¼åŒ…å«é€—å·\",\",å³æœ‰å¤šä¸ªå€¼ï¼Œåˆ™è¿›ä¸€æ­¥è§£æ(åé¢ä¼šåˆ†æparseMultiRefæ–¹æ³•)\n                                parseMultiRef(\"registries\", value, beanDefinition, parserContext);\n                            } else if (\"provider\".equals(property) && value.indexOf(',') != -1) {\n                                //å¦‚æœå½“å‰å±æ€§ä¸ºprovidersï¼Œå¹¶ä¸”å±æ€§å€¼åŒ…å«é€—å·\",\",å³æœ‰å¤šä¸ªå€¼ï¼Œåˆ™è¿›ä¸€æ­¥è§£æ\n                                parseMultiRef(\"providers\", value, beanDefinition, parserContext);\n                            } else if (\"protocol\".equals(property) && value.indexOf(',') != -1) {\n                                //å¦‚æœå½“å‰å±æ€§ä¸ºprotocolï¼Œå¹¶ä¸”å±æ€§å€¼åŒ…å«é€—å·\",\",å³æœ‰å¤šä¸ªå€¼ï¼Œåˆ™è¿›ä¸€æ­¥è§£æ\n                                parseMultiRef(\"protocols\", value, beanDefinition, parserContext);\n                            } else {\n                                Object reference;\n                                //åˆ¤æ–­setæ–¹æ³•çš„å‚æ•°ç±»å‹æ˜¯å¦æ˜¯åŸå§‹ç±»å‹\n                                if (isPrimitive(type)) {\n                                     if (\"async\".equals(property) && \"false\".equals(value)\n                                            || \"timeout\".equals(property) && \"0\".equals(value)\n                                            || \"delay\".equals(property) && \"0\".equals(value)\n                                            || \"version\".equals(property) && \"0.0.0\".equals(value)\n                                            || \"stat\".equals(property) && \"-1\".equals(value)\n                                            || \"reliable\".equals(property) && \"false\".equals(value)) {\n                                        // backward compatibility for the default value in old version's xsd\n                                        //å…¼å®¹è€ç‰ˆæœ¬\n\t\t\t\t\tvalue = null;\n                                    }\n\t\t\t\t    //åŸå§‹ç±»å‹ï¼Œç›´æ¥åªç”¨xmlä¸­é…ç½®çš„å±æ€§å€¼\n                                    reference = value;\n                                } else if (\"protocol\".equals(property)\n                                        //å±æ€§åä¸ºprotocolï¼Œå¹¶ä¸”å½“å‰å­˜åœ¨è¯¥å±æ€§å€¼å¯¹åº”çš„æ‰©å±•\n                                        && ExtensionLoader.getExtensionLoader(Protocol.class).hasExtension(value)\n                                        //å½“å‰ä¸Šä¸‹æ–‡ä¸åŒ…å«æ‰©å±•çš„beanå®šä¹‰\n                                        //è¯¥æ‰©å±•beançš„ç±»åç§°ä¸ç­‰äºProtocolConfigç±»åç§°\n                                        && (!parserContext.getRegistry().containsBeanDefinition(value)\n                                        || !ProtocolConfig.class.getName().equals(parserContext.getRegistry().getBeanDefinition(value).getBeanClassName()))) {\n                                    //å¦‚æœå…ƒç´ æ ‡ç­¾åç§°ä¸ºdubbo:providerï¼Œåˆ™æç¤ºä½¿ç”¨dubbo:protocolè¿›è¡Œæ›¿æ¢\n                                    if (\"dubbo:provider\".equals(element.getTagName())) {\n                                        logger.warn(\"Recommended replace <dubbo:provider protocol=\\\"\" + value + \"\\\" ... /> to <dubbo:protocol name=\\\"\" + value + \"\\\" ... />\");\n                                    }\n                                    // backward compatibility å‘åå…¼å®¹\n                                    // è®¾ç½®åè®®åç§°ä¸ºvalue\n                                    ProtocolConfig protocol = new ProtocolConfig();\n                                    protocol.setName(value);\n                                    //è®¾ç½®referenceå€¼ä¸ºprotocol\n                                    reference = protocol;\n                                } else if (\"onreturn\".equals(property)) {\n                                    //è·å–\".\"åœ¨å±æ€§å€¼ä¸­æœ€åå‡ºç°çš„ä½ç½®\n                                    int index = value.lastIndexOf(\".\");\n                                    \n \t\t\t\t     //æˆªå–valueä»é¦–å­—ç¬¦åˆ°indexå­—ç¬¦\n                                    String returnRef = value.substring(0, index);\n                                    \n\t\t\t\t    //ä»index+1å­—ç¬¦å¼€å§‹è¿›è¡Œæˆªå–\n                                    String returnMethod = value.substring(index + 1);\n\t\t\t\t\t\n\t\t\t\t    //åŒ…è£…æˆRuntimeBeanReference\n                                    reference = new RuntimeBeanReference(returnRef);\n                                    \n \t\t\t\t    //ä¸ºå½“å‰beanå®šä¹‰å¢åŠ å±æ€§onreturnMethod\n                                    beanDefinition.getPropertyValues().addPropertyValue(\"onreturnMethod\", returnMethod);\n                                } else if (\"onthrow\".equals(property)) {\n                                   //å¤„ç†onthrowå±æ€§ \n\t\t\t\t   int index = value.lastIndexOf(\".\");\n                                   String throwRef = value.substring(0, index);\n                                   String throwMethod = value.substring(index + 1);\n                                    \n\t\t\t\t   reference = new RuntimeBeanReference(throwRef);\n                                   \n\t\t\t\t    //ä¸ºå½“å‰beanå®šä¹‰å¢åŠ å±æ€§onthrowMethod\n                                    beanDefinition.getPropertyValues().addPropertyValue(\"onthrowMethod\", throwMethod);\n                                } else if (\"oninvoke\".equals(property)) {\n                                    int index = value.lastIndexOf(\".\");\n                                    String invokeRef = value.substring(0, index);\n                                    String invokeRefMethod = value.substring(index + 1);\n                                    \n\t\t\t\t    reference = new RuntimeBeanReference(invokeRef);\n                                    //ä¸ºå½“å‰beanå®šä¹‰å¢åŠ å±æ€§oninvokeMethod\n                                    beanDefinition.getPropertyValues().addPropertyValue(\"oninvokeMethod\", invokeRefMethod);\n                                }else {\n                                    //å¦‚æœå½“å‰å±æ€§ä¸ºrefï¼Œå¹¶ä¸”å½“å‰ä¸Šä¸‹æ–‡ä¸­åŒ…å«å±æ€§å€¼valueå¯¹åº”çš„beanå®šä¹‰\n                                    if (\"ref\".equals(property) && parserContext.getRegistry().containsBeanDefinition(value)) {\n                                        //è·å–å±æ€§å€¼valueå¯¹åº”çš„beanå®šä¹‰\n                                        BeanDefinition refBean = parserContext.getRegistry().getBeanDefinition(value);\n                                        //æ£€æµ‹æ˜¯å¦æ˜¯å•ä¾‹\n                                        if (!refBean.isSingleton()) {\n                                            //æš´éœ²çš„æœåŠ¡refå€¼å¿…é¡»æ˜¯å•ä¾‹\n                                            throw new IllegalStateException(\"The exported service ref \" + value + \" must be singleton! Please set the \" + value + \" bean scope to singleton, eg: <bean id=\\\"\" + value + \"\\\" scope=\\\"singleton\\\" ...>\");\n                                        }\n                                    }\n                                    reference = new RuntimeBeanReference(value);\n                                }\n                                //ä¸ºå½“å‰beanå®šä¹‰æ·»åŠ å±æ€§propertyï¼Œå±æ€§å€¼ä¸ºreference\n                                beanDefinition.getPropertyValues().addPropertyValue(property, reference);\n                            }\n                        }\n                    }\n                }\n            }\n        }\n        //è·å–å…ƒç´ çš„æ‰€æœ‰å±æ€§\n        NamedNodeMap attributes = element.getAttributes();\n\t//å±æ€§æ•°é‡\n        int len = attributes.getLength();\n        //éå†æ‰€æœ‰å±æ€§ï¼Œçœ‹çœ‹æ˜¯å¦æœ‰ä¸å†setå±æ€§é›†åˆä¸­çš„å…ƒç´ ï¼Œå¦‚æœæœ‰ï¼Œåˆ™å°†ä»–ä»¬æ·»åŠ åˆ°è‡ªå®šä¹‰å‚æ•°mapä¸­ï¼Œç„¶åè®¾ç½®å½“å‰å¾…å®ä¾‹åŒ–beançš„parameterså‚æ•°\n        for (int i = 0; i < len; i++) {\n            Node node = attributes.item(i);\n            String name = node.getLocalName();\n            //å¦‚æœå½“å‰setå±æ€§é›†åˆä¸­ä¸åŒ…å«è¯¥å±æ€§ï¼Œåˆ™å°†è¯¥å±æ€§ä»¥åŠå±æ€§å€¼æ·»åŠ åˆ°è‡ªå®šä¹‰parametersä¸­\n            if (!props.contains(name)) {\n                if (parameters == null) {\n                    parameters = new ManagedMap();\n                }\n                //è·å–è¯¥èŠ‚ç‚¹å±æ€§å€¼\n                String value = node.getNodeValue();\n                //å°†å€¼åŒ…è£…æˆTypedStringValueç±»å‹ï¼Œå¹¶æ”¾å…¥è‡ªå®šä¹‰å‚æ•°mapä¸­\n                parameters.put(name, new TypedStringValue(value, String.class));\n            }\n        }\n        if (parameters != null) {\n            //ä¸ºå½“å‰beanå®šä¹‰æ·»åŠ å±æ€§parameters\n            beanDefinition.getPropertyValues().addPropertyValue(\"parameters\", parameters);\n        }\n\t//è¿”å›beanå®šä¹‰\n        return beanDefinition;\n    }\n\n}\n```\n#### parsePropertiesæ–¹æ³•\n\n```java\n/**\n* è§£æå­æ ‡ç­¾å…ƒç´ \n* @param nodeList\n* @param beanDefinition å¾…å®ä¾‹åŒ–çš„bean\n*/\nprivate static void parseProperties(NodeList nodeList, RootBeanDefinition beanDefinition) {\n\t\n\t//<dubbo:service interface=\"org.dubbo.service.UserInterface\" class=\"org.dubbo.service.impl.UserService\" protocol=\"dubbo\" retries=\"0\">\n   \t//\t<property name=\"name\" value=\"dubbo\" ref=\"\"/>\n   \t//\t<property name=\"age\" value=\"5\" ref=\"\"/>\n\t//</dubbo:service>\n\tif (nodeList != null && nodeList.getLength() > 0) {\n\t   //éå†æ‰€æœ‰propertyèŠ‚ç‚¹ \n\t   for (int i = 0; i < nodeList.getLength(); i++) {\n\t\t//å½“å‰èŠ‚ç‚¹\n\t\tNode node = nodeList.item(i);\n\t\tif (node instanceof Element) {\n\t\t    //å¦‚æœèŠ‚ç‚¹åç§°ä¸ºpropertyæˆ–è€…èŠ‚ç‚¹é™å®šåç§°ä¸ºproperty\n\t\t    if (\"property\".equals(node.getNodeName())\n\t\t\t    || \"property\".equals(node.getLocalName())) {\n\t\t\t\n\t\t\t//è·å–propertyèŠ‚ç‚¹çš„nameå±æ€§\n\t\t\tString name = ((Element) node).getAttribute(\"name\");\n\t\t\tif (name != null && name.length() > 0) {\n\t\t\t    //è·å–propertyèŠ‚ç‚¹çš„valueå±æ€§\n\t\t\t    String value = ((Element) node).getAttribute(\"value\");\n\t\t\t   \n\t\t\t    //è·å–propertyèŠ‚ç‚¹çš„refå±æ€§\n\t\t\t    String ref = ((Element) node).getAttribute(\"ref\");\n\t\t\t    \n\t\t\t    if (value != null && value.length() > 0) {\n\t\t\t\t//ä¸ºbeanå®šä¹‰è®¾ç½®å±æ€§ä»¥åŠå±æ€§å€¼\n\t\t\t\tbeanDefinition.getPropertyValues().addPropertyValue(name, value);\n\t\t\t    } else if (ref != null && ref.length() > 0) {\n\t\t\t\t//ä¸ºbeanå®šä¹‰è®¾ç½®å±æ€§ä»¥åŠå±æ€§å€¼ï¼ˆå¼•ç”¨ï¼‰\n\t\t\t\tbeanDefinition.getPropertyValues().addPropertyValue(name, new RuntimeBeanReference(ref));\n\t\t\t    } else {\n\t\t\t\t//ä¸æ”¯æŒçš„å­æ ‡ç­¾\n\t\t\t\tthrow new UnsupportedOperationException(\"Unsupported <property name=\\\"\" + name + \"\\\"> sub tag, Only supported <property name=\\\"\" + name + \"\\\" ref=\\\"...\\\" /> or <property name=\\\"\" + name + \"\\\" value=\\\"...\\\" />\");\n\t\t\t    }\n\t\t\t}\n\t\t    }\n\t\t}\n\t    }\n\t}\n}\n```\n\n#### parseNestedæ–¹æ³•\n\n```java\nparseNested(element, parserContext, ServiceBean.class, true, \"service\", \"provider\", id, beanDefinition);\nparseNested(element, parserContext, ReferenceBean.class, false, \"reference\", \"consumer\", id, beanDefinition);\n\n\n\n/**\n* è§£æåµŒå¥—æ ‡ç­¾\n* å³ï¼š\n*   <dubbo:provider>\n*        <dubbo:service interface=\"\">\n*            <dubbo:method name=\"\"></dubbo:method>\n*        </dubbo:service>\n*        <dubbo:service interface=\"\">\n*            <dubbo:method name=\"\"></dubbo:method>\n*        </dubbo:service>\n*   </dubbo:provider>\n* @param element  å½“å‰å…ƒç´ ï¼š<dubbo:provider>\n* @param parserContext ä¸Šä¸‹æ–‡\n* @param beanClass  ServiceBean.class/ReferenceBean.class\n* @param required   true/false\n* @param tag   æ ‡ç­¾      service/reference\n* @param property å±æ€§   provider/consumer\n* @param ref   å¾…å®ä¾‹åŒ–beançš„Id\n* @param beanDefinition å¾…å®ä¾‹åŒ–beanå®šä¹‰\n*/\nprivate static void parseNested(Element element, ParserContext parserContext, Class<?> beanClass,\n\t\t\t    boolean required, String tag, String property, \n\t\t\t    String ref,BeanDefinition beanDefinition) {\n        //è·å–å½“å‰å…ƒç´ çš„å­èŠ‚ç‚¹\n\tNodeList nodeList = element.getChildNodes();\n\tif (nodeList != null && nodeList.getLength() > 0) {\n\t    boolean first = true;\n\t    //éå†å­èŠ‚ç‚¹\n\t    for (int i = 0; i < nodeList.getLength(); i++) {\n\t\t//å½“å‰å­èŠ‚ç‚¹\n\t\tNode node = nodeList.item(i);\n\t\tif (node instanceof Element) {\n\t\t    //å¦‚æœå½“å‰å­èŠ‚ç‚¹çš„åç§°ç­‰äºtag\n\t\t    if (tag.equals(node.getNodeName())\n\t\t\t    || tag.equals(node.getLocalName())) {\n\t\t\t//æ˜¯å¦ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹\n\t\t\tif (first) {\n\t\t\t    first = false;\n\t\t\t    //è·å–å½“å‰å…ƒç´ defaultå±æ€§\n\t\t\t    String isDefault = element.getAttribute(\"default\");\n\t\t\t    if (isDefault == null || isDefault.length() == 0) {\n\t\t\t\t//å¦‚æœdefaultå±æ€§ä¸ºç©ºï¼Œåˆ™ä¸ºbeanå®šä¹‰å¢åŠ defaultå±æ€§ï¼Œå¹¶å°†å±æ€§å€¼è®¾ç½®æˆfalse\n\t\t\t\tbeanDefinition.getPropertyValues().addPropertyValue(\"default\", \"false\");\n\t\t\t    }\n\t\t\t}\n\t\t\t\n\t\t        //è°ƒç”¨parseæ–¹æ³•é€’å½’è§£æbeanClassï¼ˆå³ServiceBean.class/ReferenceBean.classï¼‰\n\t\t\tBeanDefinition subDefinition = parse((Element) node, parserContext, beanClass, required);\n\t\t\t\n\t\t\t//å¦‚æœå­beanä¸ä¸ºç©ºï¼Œä¸”refä¸ä¸ºç©ºï¼Œåˆ™ä¸ºå­beanå¢åŠ propertyå±æ€§(provider/consumer)(å³å°†çˆ¶beanè®¾ç½®è¿›å»,refå‚æ•°)\n\t\t\tif (subDefinition != null && ref != null && ref.length() > 0) {\n\t\t\t    subDefinition.getPropertyValues().addPropertyValue(property, new RuntimeBeanReference(ref));\n\t\t\t}\n\t\t    }\n\t\t}\n\t    }\n\t}\n}\n```\n#### parseParametersæ–¹æ³•\n```java\n/**\n* å½“å‰propertyä¸ºparametersï¼Œè§£æå‚æ•°æ ‡ç­¾ <dubbo:parameter>\n* @param nodeList æ‰€æœ‰å­èŠ‚ç‚¹åˆ—è¡¨\n* @param beanDefinition å½“å‰å¾…å®ä¾‹åŒ–çš„bean\n* @return è‡ªå®šä¹‰å‚æ•°é›†åˆ\n*/\nprivate static ManagedMap parseParameters(NodeList nodeList, RootBeanDefinition beanDefinition) {\n\tif (nodeList != null && nodeList.getLength() > 0) {\n\t    \n\t    ManagedMap parameters = null;\n            \n\t    //éå†å­èŠ‚ç‚¹\n\t    for (int i = 0; i < nodeList.getLength(); i++) {\n\t\t\n\t\tNode node = nodeList.item(i);\n\t\t\n\t\tif (node instanceof Element) {\n\t\t    \n\t\t    //å¦‚æœå­èŠ‚ç‚¹åç§°æ˜¯parameter\n\t\t    if (\"parameter\".equals(node.getNodeName())\n\t\t\t    || \"parameter\".equals(node.getLocalName())) {\n\t\t\t\n\t\t\tif (parameters == null) {\n\t\t\t    parameters = new ManagedMap();\n\t\t\t}\n\t\t\t\n\t\t\t//è·å–å­èŠ‚ç‚¹çš„keyå±æ€§ã€valueå±æ€§ã€hideå±æ€§\n\t\t\tString key = ((Element) node).getAttribute(\"key\");\n\t\t\tString value = ((Element) node).getAttribute(\"value\");\n\t\t\tboolean hide = \"true\".equals(((Element) node).getAttribute(\"hide\"));\n\t\t\t\n\t\t\tif (hide) {\n\t\t\t    //å¦‚æœéœ€è¦éšè—çš„è¯ï¼Œåˆ™ä¿®æ”¹keyå±æ€§çš„å€¼\n\t\t\t    key = Constants.HIDE_KEY_PREFIX + key;\n\t\t\t}\n\t\t\t\n\t\t\t//ä¿å­˜å‚æ•°ä¿¡æ¯\n\t\t\tparameters.put(key, new TypedStringValue(value, String.class));\n\t\t    }\n\t\t}\n\t    }\n\t    return parameters;\n\t}\n\treturn null;\n}\n```\n\n#### parseMethodsæ–¹æ³•\n```java\n\n/**\n *\n * å½“å‰propertyä¸ºmethodsï¼Œè§£æ<dubbo:method>æ ‡ç­¾\n * @param id å½“å‰å¾…å®ä¾‹åŒ–çš„bean-id\n * @param nodeList æ‰€æœ‰å­èŠ‚ç‚¹åˆ—è¡¨\n * @param beanDefinition å¾…å®ä¾‹åŒ–bean\n * @param parserContext\n */\nprivate static void parseMethods(String id, NodeList nodeList, \n\t\t\t\tRootBeanDefinition beanDefinition,\n\t\t\t\tParserContext parserContext) {\n\n\tif (nodeList != null && nodeList.getLength() > 0) {\n\t    ManagedList methods = null;\n\t    \n\t    //éå†å­èŠ‚ç‚¹åˆ—è¡¨\n\t    for (int i = 0; i < nodeList.getLength(); i++) {\n\t\t\n\t\tNode node = nodeList.item(i);\n\t\t\n\t\tif (node instanceof Element) {\n        if (ProtocolConfig.class.equals(beanClass)) {\n            //å¦‚æœå½“å‰è¦å®ä¾‹åŒ–çš„beanæ˜¯ProtocolConfigç±»ï¼Œåˆ™éå†Springæ‰€æœ‰å·²ç»æ³¨å†Œçš„beançš„åç§°\n            for (String name : parserContext.getRegistry().getBeanDefinitionNames()) {\n                //æ ¹æ®beanåç§°è·å–å·²æ³¨å†Œçš„beanå®šä¹‰\n                BeanDefinition definition = parserContext.getRegistry().getBeanDefinition(name);\n                //æŸ¥çœ‹å·²æ³¨å†Œçš„beanå®šä¹‰ä¸­æ˜¯å¦å­˜åœ¨protocolå±æ€§\n                PropertyValue property = definition.getPropertyValues().getPropertyValue(\"protocol\");\n                if (property != null) {\n                    //å­˜åœ¨protocolå±æ€§ï¼Œåˆ™è·å–protocolå±æ€§å€¼\n                    Object value = property.getValue();\n                    //å¦‚æœprotocolå±æ€§å€¼ä¸ºProtocolConfigç±»å‹ï¼Œå¹¶ä¸”å½“å‰å®ä¾‹åŒ–çš„beançš„idç­‰äºprotocolå±æ€§å€¼çš„nameå±æ€§å€¼çš„è¯ï¼Œ\n                    //åˆ™å°†å½“å‰å®ä¾‹åŒ–çš„beanåŒ…è£…æˆRuntimeBeanReferenceç±»å‹\n                    //ç„¶åå°†å·²æ³¨å†Œçš„beançš„protocolå±æ€§çš„å€¼è®¾ä¸ºåˆšæ‰æ–°åˆ›å»ºçš„RuntimeBeanReference\n                    //ä¹Ÿå°±æ˜¯è¯´å°†å½“å‰è§£æçš„beanï¼ˆProtocolConfigï¼‰è®¾ç½®åˆ°å…¶ä»–å·²æ³¨å†Œçš„beançš„protocolå±æ€§ä¸­\n                    if (value instanceof ProtocolConfig && id.equals(((ProtocolConfig) value).getName())) {\n                        definition.getPropertyValues().addPropertyValue(\"protocol\", new RuntimeBeanReference(id));\n                    }\n                }\n            }\n        } else if (ServiceBean.class.equals(beanClass)) {\n            //è¿›ä¸€æ­¥è§£æ<dubbo:service/>æ ‡ç­¾ï¼Œè¿™é‡Œçš„é€»è¾‘å°±æ˜¯å¤„ç†ä¸‹é¢çš„ç¬¬äºŒç§é…ç½®\n            //å¦‚ï¼š<dubbo:service protocol=\"dubbo\" ref=\"userService\" interface=\"org.dubbo.service.UserInterface\" retries=\"0\" />\n            //   <bean id=\"userService\" class=\"org.dubbo.service.impl.UserServiceImpl\" />\n            //å’Œå¦‚ä¸‹é…ç½®ç›¸åŒ\n            //<dubbo:service interface=\"org.dubbo.service.UserInterface\" class=\"org.dubbo.service.impl.UserServiceImpl\" protocol=\"dubbo\" retries=\"0\">\n            //   <property name=\"name\" value=\"dubbo\" ref=\"\"/>\n            //   <property name=\"age\" value=\"5\" ref=\"\"/>\n            //</dubbo:service>\n\n            //å¦‚æœå½“å‰è¦å®ä¾‹åŒ–çš„beanæ˜¯ServiceBeanç±»,åˆ™è·å–classå±æ€§å¹¶è§£æ\n            String className = element.getAttribute(\"class\");\n            if (className != null && className.length() > 0) {\n                //å¦‚æœclasså±æ€§ä¸ä¸ºç©ºï¼Œåˆ™å®ä¾‹åŒ–è¯¥classå±æ€§æŒ‡å®šçš„ç±»\n                RootBeanDefinition classDefinition = new RootBeanDefinition();\n                classDefinition.setBeanClass(ReflectUtils.forName(className));\n                classDefinition.setLazyInit(false);\n                //è§£æå­æ ‡ç­¾å…ƒç´ (å³ä¸Šé¢ä¾‹å­ä¸­çš„propertyå±æ€§)(åé¢ä¼šä»‹ç»parsePropertiesæ–¹æ³•)\n                parseProperties(element.getChildNodes(), classDefinition);\n                //ä¸ºå½“å‰å¾…å®ä¾‹åŒ–çš„beanå®šä¹‰å¢åŠ refå±æ€§å€¼ï¼ˆå³classå±æ€§å¯¹åº”çš„beanï¼Œidä¸º beanId + implï¼‰\n                beanDefinition.getPropertyValues().addPropertyValue(\"ref\", new BeanDefinitionHolder(classDefinition, id + \"Impl\"));\n            }\n        } else if (ProviderConfig.class.equals(beanClass)) {\n            //è¿›ä¸€æ­¥å¤„ç†<dubbo:provider/>æ ‡ç­¾(åé¢ä¼šåˆ†æparseNestedæ–¹æ³•)\n            parseNested(element, parserContext, ServiceBean.class, true, \"service\", \"provider\", id, beanDefinition);\n        } else if (ConsumerConfig.class.equals(beanClass)) {\n            //è¿›ä¸€æ­¥å¤„ç†<dubbo:consumer/>æ ‡ç­¾çš„å­æ ‡ç­¾<dubbo:reference/>\n            parseNested(element, parserContext, ReferenceBean.class, false, \"reference\", \"consumer\", id, beanDefinition);\n        }\n        \n\t//å½“å‰å¾…å®ä¾‹åŒ–çš„beançš„æ‰€æœ‰çš„å±æ€§(é€šè¿‡setæ–¹æ³•è·å–åˆ°)\n        Set<String> props = new HashSet<String>();\n        ManagedMap parameters = null;\n        //éå†å¾…å®ä¾‹åŒ–ç±»çš„æ‰€æœ‰æ–¹æ³•,æ‰¾åˆ°setæ–¹æ³•\n        for (Method setter : beanClass.getMethods()) {\n            \n            String name = setter.getName();\n            \n            //æ‰¾åˆ°setæ–¹æ³•ï¼Œæ¡ä»¶å¦‚ä¸‹ï¼šæ–¹æ³•åé•¿åº¦å¤§äº3ï¼Œä»¥setå¼€å¤´ï¼Œæ˜¯publicä¿®é¥°ç¬¦ï¼Œå‚æ•°ç±»å‹é•¿åº¦ä¸º1\n            if (name.length() > 3 && name.startsWith(\"set\")\n                    && Modifier.isPublic(setter.getModifiers())\n                    && setter.getParameterTypes().length == 1) {\n               \n                 //è·å–å‚æ•°ç±»å‹\n                Class<?> type = setter.getParameterTypes()[0];\n\n                //å¦‚setFirstName(String firstName)æ–¹æ³•\n                //å°†ä¼šå¾—åˆ°property=first-name\n                String property = StringUtils.camelToSplitName(name.substring(3, 4).toLowerCase() + name.substring(4), \"-\");\n          \n\t        //å°†å±æ€§åç§°æ·»åŠ åˆ°propsé›†åˆä¸­\n                props.add(property);\n               \n                //è·å–åˆ°å±æ€§çš„getæ–¹æ³•\n                Method getter = null;\n               \n                try {\n                    getter = beanClass.getMethod(\"get\" + name.substring(3), new Class<?>[0]);\n                } catch (NoSuchMethodException e) {\n                    try {\n                        //å¦‚æœæ²¡æœ‰æ‰¾åˆ°getæ–¹æ³•ï¼Œåˆ™å°è¯•æ‰¾åˆ°isXXXæ–¹æ³•\n                        getter = beanClass.getMethod(\"is\" + name.substring(3), new Class<?>[0]);\n                    } catch (NoSuchMethodException e2) {\n                    }\n                }\n                if (getter == null\n                        || !Modifier.isPublic(getter.getModifiers())\n                        || !type.equals(getter.getReturnType())) {\n                    //å¦‚æœgetæ–¹æ³•ä¸ºç©ºã€ä¸æ˜¯publicé™å®šç¬¦ã€æˆ–è€…getæ–¹æ³•è¿”å›å€¼å’Œsetæ–¹æ³•å‚æ•°ç±»å‹ä¸ä¸€è‡´çš„è¯ï¼Œ\n                    //åˆ™è·³è¿‡è¯¥propertyçš„å¤„ç†ï¼Œè¿›è¡Œä¸‹ä¸€ä¸ªpropertyçš„å¤„ç†\n                    continue;\n                }\n                if (\"parameters\".equals(property)) {\n                    //å¦‚æœå½“å‰propertyä¸ºparametersï¼Œåˆ™è§£æå½“å‰å…ƒç´ çš„å­å…ƒç´ (<dubbo:parameter>æ ‡ç­¾)(åé¢ä¼šåˆ†æparseParametersæ–¹æ³•)\n                    parameters = parseParameters(element.getChildNodes(), beanDefinition);\n                } else if (\"methods\".equals(property)) {\n                    //å¦‚æœå½“å‰propertyä¸ºmethodsï¼Œåˆ™è§£æå½“å‰å…ƒç´ çš„å­å…ƒç´ (<dubbo:method>æ ‡ç­¾)(åé¢ä¼šåˆ†æparseMethodsæ–¹æ³•)\n                    parseMethods(id, element.getChildNodes(), beanDefinition, parserContext);\n                } else if (\"arguments\".equals(property)) {\n                    //å¦‚æœå½“å‰propertyä¸ºargumentsï¼Œåˆ™è§£æå½“å‰å…ƒç´ çš„å­å…ƒç´ (<dubbo:argument>æ ‡ç­¾)(åé¢ä¼šåˆ†æparseArgumentsæ–¹æ³•)\n                    parseArguments(id, element.getChildNodes(), beanDefinition, parserContext);\n                } else {\n                    //ä»xmlå®šä¹‰ä¸­è·å–propertyå±æ€§å€¼\n                    String value = element.getAttribute(property);\n                    if (value != null) {\n                        value = value.trim();\n                        if (value.length() > 0) {\n                            if (\"registry\".equals(property) && RegistryConfig.NO_AVAILABLE.equalsIgnoreCase(value)) {\n                                //å¦‚æœå½“å‰å±æ€§ä¸ºregistryï¼Œå¹¶ä¸”å±æ€§å€¼ä¸ºN/A\n                                //åˆ™ä¸ºå½“å‰beanå®šä¹‰æ·»åŠ å±æ€§registryï¼Œå¹¶ä¸”å±æ€§å€¼ä¸ºRegistryConfigå¯¹è±¡(è¯¥å¯¹è±¡çš„addresså±æ€§å€¼ä¸ºä¸å¯ç”¨)\n                                RegistryConfig registryConfig = new RegistryConfig();\n                                registryConfig.setAddress(RegistryConfig.NO_AVAILABLE);\n                                beanDefinition.getPropertyValues().addPropertyValue(property, registryConfig);\n                            } else if (\"registry\".equals(property) && value.indexOf(',') != -1) {\n                                //å¦‚æœå½“å‰å±æ€§ä¸ºregistryï¼Œå¹¶ä¸”å±æ€§å€¼åŒ…å«é€—å·\",\",å³æœ‰å¤šä¸ªå€¼ï¼Œåˆ™è¿›ä¸€æ­¥è§£æ(åé¢ä¼šåˆ†æparseMultiRefæ–¹æ³•)\n                                parseMultiRef(\"registries\", value, beanDefinition, parserContext);\n                            } else if (\"provider\".equals(property) && value.indexOf(',') != -1) {\n                                //å¦‚æœå½“å‰å±æ€§ä¸ºprovidersï¼Œå¹¶ä¸”å±æ€§å€¼åŒ…å«é€—å·\",\",å³æœ‰å¤šä¸ªå€¼ï¼Œåˆ™è¿›ä¸€æ­¥è§£æ\n                                parseMultiRef(\"providers\", value, beanDefinition, parserContext);\n                            } else if (\"protocol\".equals(property) && value.indexOf(',') != -1) {\n                                //å¦‚æœå½“å‰å±æ€§ä¸ºprotocolï¼Œå¹¶ä¸”å±æ€§å€¼åŒ…å«é€—å·\",\",å³æœ‰å¤šä¸ªå€¼ï¼Œåˆ™è¿›ä¸€æ­¥è§£æ\n                                parseMultiRef(\"protocols\", value, beanDefinition, parserContext);\n                            } else {\n                                Object reference;\n                                //åˆ¤æ–­setæ–¹æ³•çš„å‚æ•°ç±»å‹æ˜¯å¦æ˜¯åŸå§‹ç±»å‹\n                                if (isPrimitive(type)) {\n                                     if (\"async\".equals(property) && \"false\".equals(value)\n                                            || \"timeout\".equals(property) && \"0\".equals(value)\n\t\t\t    \n\t\t    //å½“å‰èŠ‚ç‚¹çš„åç§°ä¸º\"method\"\n\t\t    if (\"method\".equals(node.getNodeName()) || \"method\".equals(node.getLocalName())) {\n\t\t\t\n\t\t\t//è·å–å½“å‰èŠ‚ç‚¹çš„nameå±æ€§\n\t\t\tString methodName = element.getAttribute(\"name\");\n\t\t\t\n\t\t\tif (methodName == null || methodName.length() == 0) {\n\t\t\t    //nameå±æ€§ä¸å¯ä»¥ä¸ºç©º\n\t\t\t    throw new IllegalStateException(\"<dubbo:method> name attribute == null\");\n\t\t\t}\n\t\t\t\n\t\t\tif (methods == null) {\n\t\t\t    methods = new ManagedList();\n\t\t\t}\n\t\t\t\n\t\t\t//è°ƒç”¨parseæ–¹æ³•é€’å½’è§£æMethodConfig.class\n\t\t\tBeanDefinition methodBeanDefinition = parse(((Element) node),\n\t\t\t\tparserContext, \n\t\t\t\tMethodConfig.class, \n\t\t\t\tfalse\n\t\t\t);\n\t\t\t\n\t\t\t//æ–°ç”Ÿæˆçš„beançš„åç§°\n\t\t\tString name = id + \".\" + methodName;\n\t\t\t\n\t\t\t//å°†beanåç§°å’Œbeanå®šä¹‰å…³è”èµ·æ¥\n\t\t\tBeanDefinitionHolder methodBeanDefinitionHolder = new BeanDefinitionHolder(\n\t\t\t\tmethodBeanDefinition, name);\n\t\t\t//ä¿å­˜æ–°ç”Ÿæˆçš„bean\n\t\t\tmethods.add(methodBeanDefinitionHolder);\n\t\t    }\n\t\t}\n\t    }\n\t    if (methods != null) {\n\t\t//ä¸ºå¾…å®ä¾‹åŒ–çš„beanæ·»åŠ methodså±æ€§\n\t\tbeanDefinition.getPropertyValues().addPropertyValue(\"methods\", methods);\n\t    }\n\t}\n}\n\n```\n\n#### parseArgumentsæ–¹æ³•\n```java\n/**\n* å½“å‰propertyä¸ºargumentsï¼Œè§£æ<dubbo:argument>æ ‡ç­¾\n* @param id  å½“å‰å¾…å®ä¾‹åŒ–çš„bean-id\n* @param nodeList å­èŠ‚ç‚¹åˆ—è¡¨\n* @param beanDefinition å½“å‰å¾…å®ä¾‹åŒ–çš„bean\n* @param parserContext\n*/\nprivate static void parseArguments(String id, NodeList nodeList, RootBeanDefinition beanDefinition,\n\t\t\t       ParserContext parserContext) {\n\n\tif (nodeList != null && nodeList.getLength() > 0) {\n\t    \n\t    ManagedList arguments = null;\n\n\t    //éå†å­èŠ‚ç‚¹\n\t    for (int i = 0; i < nodeList.getLength(); i++) {\n\t\t\n\t\tNode node = nodeList.item(i);\n\n\t\tif (node instanceof Element) {\n\t\t    \n\t\t    Element element = (Element) node;\n\n\t\t    //å½“å‰å­èŠ‚ç‚¹åç§°ä¸ºargument\n\t\t    if (\"argument\".equals(node.getNodeName()) || \"argument\".equals(node.getLocalName())) {\n\t\t\t\n\t\t\t//è·å–å½“å‰å­èŠ‚ç‚¹çš„indexå±æ€§\n\t\t\tString argumentIndex = element.getAttribute(\"index\");\n\t\t\t\n\t\t\tif (arguments == null) {\n\t\t\t    arguments = new ManagedList();\n\t\t\t}\n\n\t\t\t//è°ƒç”¨parseæ–¹æ³•é€’å½’è§£æArgumentConfig.class\n\t\t\tBeanDefinition argumentBeanDefinition = parse(((Element) node),\n\t\t\t\tparserContext, \n\t\t\t\tArgumentConfig.class, \n\t\t\t\tfalse\n\t\t\t);\n\n\t\t\t//æ–°ç”Ÿæˆçš„beançš„åç§°\n\t\t\tString name = id + \".\" + argumentIndex;\n\n\t\t\t//å°†æ–°ç”Ÿæˆçš„beanåç§°å’Œbeanå®šä¹‰å…³è”èµ·æ¥\n\t\t\tBeanDefinitionHolder argumentBeanDefinitionHolder = new BeanDefinitionHolder(\n\t\t\t\targumentBeanDefinition, name);\n        if (!beanDefinitionRegistry.containsBeanDefinition(beanName)) {\n            //è¯¥beanè¿˜æ²¡æœ‰æ³¨å†Œçš„è¯ï¼Œåˆ™è¿›è¡Œæ³¨å†Œ\n\t    RootBeanDefinition beanDefinition = new RootBeanDefinition(beanType);\n            \n\t    beanDefinition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);\n            \n\t    beanDefinitionRegistry.registerBeanDefinition(beanName, beanDefinition);\n        }\n    }\n}\n```\n\nDubboBeanDefinitionParserè§£æç±»å°±ä»‹ç»å®Œæ¯•äº†ï¼Œæœ€åç»™ä¸€ä¸ªçš„parseæ–¹æ³•çš„å¤„ç†æµç¨‹å›¾.\n![](img/DubboBeanDefinitionParser.png)\n\n\n\n\n\n","tags":["dubbo"]},{"title":"Dubboæºç é˜…è¯»ä¹‹é›†æˆSpringæ ‡ç­¾é…ç½®ç±»(01)","url":"/blog/2018/08/04/Dubboæºç é˜…è¯»ä¹‹é›†æˆSpring-01æ ‡ç­¾é…ç½®ç±»/","content":"\n>æœ¬å°èŠ‚å°†ä¼šä»‹ç»ä¸‹å¦‚ä½•åœ¨Springç¯å¢ƒä¸­ä½¿ç”¨Dubboï¼Œä»¥åŠDubboæ ‡ç­¾å®ä½“ç±»\n\n* Springä¸­ä½¿ç”¨Dubboçš„Demo\n* Dubboæ ‡ç­¾è§£æ\n\n\n### Springä¸­ä½¿ç”¨Dubboçš„Demo\næˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹Dubboæºç ä¸­dubbo-demoåŒ…ä¸­çš„ä¾‹å­ã€‚\n\n#### dubbo-demo-api\né¦–å…ˆåœ¨dubbo-demo-apiæ¨¡å—ä¸­å®šä¹‰äº†ä¸€ä¸ªæ¥å£ï¼š\n```java\npublic interface DemoService {\n    String sayHello(String name);\n}\n```\n\nç„¶ååœ¨dubbo-demo-provideræ¨¡å—å’Œdubbo-demo-consumeræ¨¡å—ä¸­åˆ†åˆ«å¼•å…¥dubbo-demo-apiæ¨¡å—ã€‚\n\n#### dubbo-demo-provider\næˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹dubbo-demo-provideræœåŠ¡æä¾›ç«¯,æ–°å»ºä¸€ä¸ªDemoServiceæ¥å£çš„å®ç°ç±»DemoServiceImplï¼š\n```java\npublic class DemoServiceImpl implements DemoService {\n    @Override\n    public String sayHello(String name) {\n        System.out.println(\"[\" + new SimpleDateFormat(\"HH:mm:ss\").format(new Date()) + \"] Hello \" + name + \", request from consumer: \" + RpcContext.getContext().getRemoteAddress());\n        return \"Hello \" + name + \", response from provider: \" + RpcContext.getContext().getLocalAddress();\n    }\n}\n```\nç„¶ååœ¨Springé…ç½®æ–‡ä»¶ä¸­è¿›è¡Œé…ç½®ï¼š\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<beans xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n       xmlns:dubbo=\"http://dubbo.apache.org/schema/dubbo\"\n       xmlns=\"http://www.springframework.org/schema/beans\"\n       xsi:schemaLocation=\"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.3.xsd\n       http://dubbo.apache.org/schema/dubbo http://dubbo.apache.org/schema/dubbo/dubbo.xsd\">\n    \n    <dubbo:application name=\"demo-provider\"/>\n    \n    <dubbo:registry address=\"multicast://224.5.6.7:1234\"/>\n    \n    <dubbo:protocol name=\"dubbo\" port=\"20880\"/>\n    \n    <bean id=\"demoService\" class=\"com.alibaba.dubbo.demo.provider.DemoServiceImpl\"/>\n    \n    <!--æš´éœ²æœåŠ¡-->\n    <dubbo:service interface=\"com.alibaba.dubbo.demo.DemoService\" ref=\"demoService\"/>\n</beans>\n```\nå¯ä»¥çœ‹åˆ°æˆ‘ä»¬é¦–å…ˆåœ¨é…ç½®æ–‡ä»¶ä¸­å¼•å…¥äº†dubboè‡ªå®šä¹‰çš„schemaæ–‡ä»¶ï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨dubboè‡ªå®šä¹‰çš„æ ‡ç­¾äº†ã€‚è¿™äº›æ ‡ç­¾æˆ‘ä»¬åé¢ä¼šè®²è§£ã€‚\næ¥ä¸‹æ¥æˆ‘ä»¬æ–°å»ºä¸€ä¸ªProviderç±»ï¼Œè¯¥ç±»ç”¨æ¥åŠ è½½Springé…ç½®æ–‡ä»¶ï¼ŒåŒæ—¶ä¹Ÿå¯åŠ¨äº†æˆ‘ä»¬çš„æœåŠ¡å™¨ï¼š\n```java\npublic class Provider {\n\n    public static void main(String[] args) throws Exception {\n        System.setProperty(\"java.net.preferIPv4Stack\", \"true\");\n        //åŠ è½½Springé…ç½®\n        ClassPathXmlApplicationContext context = new ClassPathXmlApplicationContext(new String[]{\"META-INF/spring/dubbo-demo-provider.xml\"});\n        context.start();\n        System.in.read(); // press any key to exit\n    }\n}\n```\n\n#### dubbo-demo-consumer\n\næˆ‘ä»¬åœ¨æ¶ˆè´¹è€…ç«¯åŒæ ·éœ€è¦é…ç½®Springé…ç½®æ–‡ä»¶ï¼š\n```xml\n<beans xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n       xmlns:dubbo=\"http://dubbo.apache.org/schema/dubbo\"\n       xmlns=\"http://www.springframework.org/schema/beans\"\n       xsi:schemaLocation=\"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.3.xsd\n       http://dubbo.apache.org/schema/dubbo http://dubbo.apache.org/schema/dubbo/dubbo.xsd\">\n\n    <dubbo:application name=\"demo-consumer\"/>\n\n    <dubbo:registry address=\"multicast://224.5.6.7:1234\"/>\n    \n    <!--å¼•ç”¨DemoServiceæœåŠ¡-->\n    <dubbo:reference id=\"demoService\" check=\"false\" interface=\"com.alibaba.dubbo.demo.DemoService\"/>\n\n</beans>\n```\næ¥ç€æˆ‘ä»¬æ–°å»ºä¸€ä¸ªConsumerç±»ï¼š\n```java\npublic class Consumer {\n\n    public static void main(String[] args) {\n        System.setProperty(\"java.net.preferIPv4Stack\", \"true\");\n        ClassPathXmlApplicationContext context = new ClassPathXmlApplicationContext(new String[]{\"META-INF/spring/dubbo-demo-consumer.xml\"});\n        context.start();\n\n        //è·å–è¿œç¨‹æœåŠ¡ä»£ç†\n        DemoService demoService = (DemoService) context.getBean(\"demoService\");\n       \n        while (true) {\n            try {\n                Thread.sleep(1000);\n                //è°ƒç”¨è¿œç¨‹æœåŠ¡æ–¹æ³•\n                String hello = demoService.sayHello(\"world\");\n                //è¾“å‡ºè°ƒç”¨ç»“æœ\n                System.out.println(hello);\n            } catch (Throwable throwable) {\n                throwable.printStackTrace();\n            }\n        }\n    }\n}\n```\nå¯åŠ¨èµ·æ¥æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°è¾“å‡ºç»“æœäº†ã€‚ç»è¿‡ä¸Šé¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä½¿ç”¨Dubboè°ƒç”¨è¿œç¨‹æœåŠ¡å°±åƒè°ƒç”¨æœ¬åœ°çš„æœåŠ¡ä¸€æ ·ç®€å•ã€‚åé¢æˆ‘ä»¬å°†è¯¦ç»†ä»‹ç»Dubboæ˜¯å¦‚ä½•åšåˆ°è¿™äº›çš„ã€‚\n\n\n### Dubboæ ‡ç­¾è§£æ\n\næ€»ä½“ä¸ŠDubboæ˜¯é€šè¿‡è‡ªå®šä¹‰Springæ ‡ç­¾ï¼Œç„¶åè§£æè¿™äº›æ ‡ç­¾ï¼Œå°†è¿™äº›æ ‡ç­¾å±æ€§æ˜ å°„æˆä¸€ä¸ªä¸ªé…ç½®ç±»ï¼Œæ¥ç€å°†è¿™äº›ç±»é…ç½®åˆ°Springå·¥å‚ï¼Œäº¤ç»™Springå®¹å™¨æ¥ç®¡ç†çš„æ–¹å¼æ¥å’ŒSpringæ•´åˆåˆ°ä¸€èµ·çš„ã€‚\nè¿™éƒ¨åˆ†æºç ä¸»è¦åœ¨dubbo-configåŒ…ä¸­ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸‹Springè‡ªå®šä¹‰æ ‡ç­¾çš„æœºåˆ¶ä»¥åŠDubboæ ‡ç­¾å¯¹åº”çš„å®ä½“ç±»ï¼Œä¸‹ä¸€å°èŠ‚åœ¨å…·ä½“åˆ†æå¦‚ä½•è§£ææ ‡ç­¾ã€‚\n\n#### Springè‡ªå®šä¹‰æ ‡ç­¾\nåœ¨dubbo-config-springæ¨¡å—çš„resourcesç›®å½•ä¸‹æœ‰ä¸‰ä¸ªæ–‡ä»¶ï¼Œåˆ†åˆ«ä¸ºï¼šdubbo.xsdã€spring.handlersã€spring.schemasã€‚\ndubbo.xsdæ–‡ä»¶ä¸­å®šä¹‰äº†æ‰€æœ‰æ”¯æŒçš„dubboæ ‡ç­¾ï¼Œspring.schemasæ–‡ä»¶ä¸­åˆ™æŒ‡å®šäº†dubbo.xsdæ–‡ä»¶ï¼š\n```java\nhttp\\://dubbo.apache.org/schema/dubbo/dubbo.xsd=META-INF/dubbo.xsd\n```\nå› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦åˆ†åˆ«åœ¨æœåŠ¡å™¨ã€å®¢æˆ·ç«¯çš„springé…ç½®æ–‡ä»¶ä¸­å¼•å…¥è¯¥xsdæ–‡ä»¶ï¼Œæ‰å¯ä»¥ä½¿ç”¨dubboæ ‡ç­¾ã€‚\nè€Œspring.handlersæ–‡ä»¶ä¸­åˆ™æŒ‡å®šäº†è§£ædubboæ ‡ç­¾çš„ç±»:\n```java\nhttp\\://dubbo.apache.org/schema/dubbo=com.alibaba.dubbo.config.spring.schema.DubboNamespaceHandler\n```\næˆ‘ä»¬å°±ä»¥com.alibaba.dubbo.config.spring.schema.DubboNamespaceHandlerç±»ä½œä¸ºå…¥å£ï¼Œçœ‹çœ‹dubboæ˜¯å¦‚ä½•è§£ææ ‡ç­¾çš„ã€‚\n\næˆ‘ä»¬æ¥çœ‹ä¸‹DubboNamespaceHandlerç±»ï¼Œè¯¥ç±»ç»§æ‰¿è‡ªSpringçš„NamespaceHandlerSupportç±»ï¼Œé€šè¿‡å®ç°initæ–¹æ³•æ¥å°†dubboæ ‡ç­¾èŠ‚ç‚¹å’Œè§£æç±»è¿›è¡Œå…³è”ï¼š\n```java\npublic class DubboNamespaceHandler extends NamespaceHandlerSupport {\n    static {\n        //æ£€æµ‹æ˜¯å¦æœ‰é‡å¤çš„DubboNamespaceHandlerç±»ï¼Œè¿™é‡Œä¸ä¼šæŠ›å¼‚å¸¸ï¼Œåªä¼šæ‰“å°é”™è¯¯æ—¥å¿—\n        Version.checkDuplicate(DubboNamespaceHandler.class);\n    }\n\n    /**\n     * å°†èŠ‚ç‚¹åå’Œè§£æç±»å…³è”èµ·æ¥ï¼ŒNamespaceHandleré€šè¿‡èŠ‚ç‚¹åä¼šæ‰¾åˆ°ç›¸åº”çš„è§£æç±»\n     */\n    @Override\n    public void init() {\n        registerBeanDefinitionParser(\"application\", new DubboBeanDefinitionParser(ApplicationConfig.class, true));\n        registerBeanDefinitionParser(\"module\", new DubboBeanDefinitionParser(ModuleConfig.class, true));\n        registerBeanDefinitionParser(\"registry\", new DubboBeanDefinitionParser(RegistryConfig.class, true));\n        registerBeanDefinitionParser(\"monitor\", new DubboBeanDefinitionParser(MonitorConfig.class, true));\n        registerBeanDefinitionParser(\"provider\", new DubboBeanDefinitionParser(ProviderConfig.class, true));\n        registerBeanDefinitionParser(\"consumer\", new DubboBeanDefinitionParser(ConsumerConfig.class, true));\n        registerBeanDefinitionParser(\"protocol\", new DubboBeanDefinitionParser(ProtocolConfig.class, true));\n        registerBeanDefinitionParser(\"service\", new DubboBeanDefinitionParser(ServiceBean.class, true));\n        registerBeanDefinitionParser(\"reference\", new DubboBeanDefinitionParser(ReferenceBean.class, false));\n        registerBeanDefinitionParser(\"annotation\", new AnnotationBeanDefinitionParser());\n    }\n}\n```\nå¯ä»¥çœ‹åˆ°è¿™é‡Œå®šä¹‰äº†dubboæ ‡ç­¾çš„è§£æç±»DubboBeanDefinitionParserï¼ŒåŒæ—¶ä¹Ÿå®šä¹‰äº†è¯¥æ ‡ç­¾å¯¹åº”çš„bean(å³xxxConfigç±»ã€xxxBeanç±»)ï¼Œè¿™äº›beanæœ€ç»ˆäº¤ç”±Springå®¹å™¨æ¥ç®¡ç†ã€‚åœ¨ä»‹ç»å®ƒä»¬ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€äº›é€šç”¨çš„æ³¨è§£ç±»,è¿™äº›æ³¨è§£å¯ä»¥æ·»åŠ åœ¨beanç±»ä¸­çš„æ–¹æ³•ä¸Šï¼Œåœ¨è§£ææ ‡ç­¾çš„æ—¶å€™ä¼šç”¨ä¸Šè¿™äº›æ³¨è§£ã€‚\n```java\n@Documented\n@Retention(RetentionPolicy.RUNTIME)\n@Target({ElementType.METHOD})\npublic @interface Parameter {\n\n    String key() default \"\";\n\n    boolean required() default false;\n\n    /**\n     * æ˜¯å¦æ’é™¤è¯¥æ–¹æ³•\n     * @return\n     */\n    boolean excluded() default false;\n\n    /**\n     * æ˜¯å¦ç¼–ç \n     * @return\n     */\n    boolean escaped() default false;\n\n    /**\n     * å±æ€§ä¸ºfalseçš„è¯ï¼Œåˆ™ä¸æ‰§è¡Œé™„åŠ å±æ€§æ–¹æ³•\n     * @return\n     */\n    boolean attribute() default false;\n\n    boolean append() default false;\n}\n```\n\n#### Dubboæ ‡ç­¾å¯¹åº”çš„å®ä½“ç±»\nåœ¨dubbo-config-apiæ¨¡å—ä¸‹çš„com.alibaba.dubbo.configåŒ…ä¸­å®šä¹‰äº†dubboæ ‡ç­¾å¯¹åº”çš„å®ä½“ç±»ï¼Œæˆ‘ä»¬å…ˆäº†è§£ä¸‹è¿™äº›å®ä½“ç±»ï¼Œç„¶åå†çœ‹å¦‚ä½•è§£æå®ƒä»¬ã€‚\n\n##### ApplicationConfig\næˆ‘ä»¬å¯¹ç…§ç€ä½¿ç”¨æ–¹æ³•ä¸€èµ·çœ‹ä¸‹ï¼š\n```xml\n <!--dubbo:applicationä¸­å¯é…ç½®çš„å±æ€§éƒ½å®šä¹‰åœ¨ApplicationConfigå®ä½“ç±»ä¸­-->\n <dubbo:application name=\"demo-provider\"/>\n```\nApplicationConfigç±»ç»§æ‰¿è‡ªAbstractConfigæŠ½è±¡ç±»ï¼Œè¯¥æŠ½è±¡ç±»æä¾›äº†ä¸€äº›è§£æé…ç½®çš„å…¬å…±æ–¹æ³•ã€‚\n```java\npublic class ApplicationConfig extends AbstractConfig {\n\n    private static final long serialVersionUID = 5508512956753757169L;\n\n    /**\n     * æœåŠ¡æ²»ç†ï¼ˆå¿…å¡«ï¼‰\n     * å½“å‰åº”ç”¨åç§°ï¼Œç”¨äºæ³¨å†Œä¸­å¿ƒè®¡ç®—åº”ç”¨é—´ä¾èµ–å…³ç³»ï¼Œæ³¨æ„ï¼šæ¶ˆè´¹è€…å’Œæä¾›è€…åº”ç”¨åä¸è¦ä¸€æ ·ï¼Œ\n     * æ­¤å‚æ•°ä¸æ˜¯åŒ¹é…æ¡ä»¶ï¼Œä½ å½“å‰é¡¹ç›®å«ä»€ä¹ˆåå­—å°±å¡«ä»€ä¹ˆï¼Œå’Œæä¾›è€…æ¶ˆè´¹è€…è§’è‰²æ— å…³\n     * application\n     */\n    private String name;\n\n    /**\n     * æœåŠ¡æ²»ç†\n     * å½“å‰åº”ç”¨æ¨¡å—ç‰ˆæœ¬\n     * application.version\n     */\n    private String version;\n\n    /**\n     * æœåŠ¡æ²»ç†\n     * åº”ç”¨è´Ÿè´£äººï¼Œç”¨äºæœåŠ¡æ²»ç†ï¼Œè¯·å¡«å†™è´Ÿè´£äººå…¬å¸é‚®ç®±å‰ç¼€\n     * owner\n     */\n    private String owner;\n\n    /**\n     * æœåŠ¡æ²»ç†\n     * ç»„ç»‡åç§°(BUæˆ–éƒ¨é—¨)ï¼Œç”¨äºæ³¨å†Œä¸­å¿ƒåŒºåˆ†æœåŠ¡æ¥æºï¼Œæ­¤é…ç½®é¡¹å»ºè®®ä¸è¦ä½¿ç”¨autoconfigï¼Œç›´æ¥å†™æ­»åœ¨é… ç½®ä¸­ï¼Œæ¯”å¦‚ china,intl,itu,crm,asc,dw,aliexpress ç­‰\n     * organization\n     */\n    private String organization;\n\n    /**\n     * æœåŠ¡æ²»ç†\n     * ç”¨äºæœåŠ¡åˆ†å±‚å¯¹åº”çš„æ¶æ„ã€‚å¦‚ï¼Œintlã€chinaã€‚ä¸åŒçš„æ¶æ„ä½¿ç”¨ä¸åŒçš„åˆ†å±‚\n     * architecture\n     */\n    private String architecture;\n\n    /**\n     * æœåŠ¡æ²»ç†\n     * ç¯å¢ƒï¼Œä¾‹å¦‚ï¼šdevã€testã€production\n     * environment\n     */\n    private String environment;\n\n    /**\n     * æ€§èƒ½ä¼˜åŒ–ï¼ˆjavassistï¼‰\n     * Javaå­—èŠ‚ç ç¼–è¯‘å™¨ï¼Œç”¨äºåŠ¨æ€ç±»çš„ç”Ÿæˆï¼Œå¯é€‰ï¼šjdkæˆ–javassist\n     * compiler \n     */\n    private String compiler;\n\n    /**\n     * æ€§èƒ½ä¼˜åŒ–ï¼ˆslf4jï¼‰\n     * æ—¥å¿—è¾“å‡ºæ–¹å¼ï¼Œå¯é€‰ï¼š slf4j,jcl,log4j,jdk\n     * logger\n     */\n    private String logger;\n\n    /**\n     * æ³¨å†Œä¸­å¿ƒåˆ—è¡¨\n     */\n    private List<RegistryConfig> registries;\n\n    /**\n     * ç›‘æ§ä¸­å¿ƒ\n     */\n    private MonitorConfig monitor;\n\n    /**\n     * æ˜¯å¦æ˜¯é»˜è®¤çš„\n     */\n    private Boolean isDefault;\n\n    /**\n     * ä¿å­˜çº¿ç¨‹è½¬å‚¨çš„ç›®å½•\n     */\n    private String dumpDirectory;\n\n    /**\n     * æ˜¯å¦å¯ç”¨qos\n     */\n    private Boolean qosEnable;\n\n    /**\n     * qosç«¯å£\n     */\n    private Integer qosPort;\n    /**\n     * æ˜¯å¦å¯ä»¥æ¥å—å›½å¤–ip\n     */\n    private Boolean qosAcceptForeignIp;\n\n    /**\n     *  è‡ªå®šä¹‰å‚æ•°\n     */\n    private Map<String, String> parameters;\n\n    public ApplicationConfig() {\n    }\n\n    public ApplicationConfig(String name) {\n        setName(name);\n    }\n\n    @Parameter(key = Constants.APPLICATION_KEY, required = true)\n    public String getName() {\n        return name;\n    }\n\n    public void setName(String name) {\n        checkName(\"name\", name);\n        this.name = name;\n        if (id == null || id.length() == 0) {\n            id = name;\n        }\n    }\n\n    @Parameter(key = \"application.version\")\n    public String getVersion() {\n        return version;\n    }\n    public void setCompiler(String compiler) {\n        this.compiler = compiler;\n        AdaptiveCompiler.setDefaultCompiler(compiler);\n    }\n    public void setLogger(String logger) {\n        this.logger = logger;\n        LoggerFactory.setLoggerAdapter(logger);\n    }\n    // ...çœç•¥å…¶ä»–ç›¸ä¼¼æ–¹æ³•\n}\n```\n##### ModuleConfig\n```java\npublic class ModuleConfig extends AbstractConfig {\n\n    private static final long serialVersionUID = 5508512956753757169L;\n\n    /**\n     * æœåŠ¡æ²»ç†ï¼ˆå¿…å¡«ï¼‰\n     * å½“å‰æ¨¡å—åç§°ï¼Œç”¨äºæ³¨å†Œä¸­å¿ƒè®¡ç®—æ¨¡å—é—´ä¾èµ–å…³ç³»\n     * module\n     */\n    private String name;\n\n    /**\n     * æœåŠ¡æ²»ç†\n     * å½“å‰æ¨¡å—çš„ç‰ˆæœ¬\n     * module.version\n     */\n    private String version;\n\n    /**\n     * æœåŠ¡æ²»ç†\n     * æ¨¡å—è´Ÿè´£äººï¼Œç”¨äºæœåŠ¡æ²»ç†ï¼Œè¯·å¡« å†™è´Ÿè´£äººå…¬å¸é‚®ç®±å‰ç¼€\n     * owner\n     */\n    private String owner;\n\n    /**\n     * æœåŠ¡æ²»ç†\n     * ç»„ç»‡åç§°(BUæˆ–éƒ¨é—¨)ï¼Œç”¨äºæ³¨å†Œä¸­å¿ƒåŒºåˆ†æœåŠ¡æ¥æºï¼Œæ­¤é…ç½®é¡¹å»ºè®®ä¸è¦ä½¿ç”¨autoconfigï¼Œç›´æ¥å†™æ­»åœ¨é… ç½®ä¸­ï¼Œæ¯”å¦‚ china,intl,itu,crm,asc,dw,aliexpress ç­‰\n     * organization\n     */\n    private String organization;\n\n    /**\n     * æ³¨å†Œä¸­å¿ƒåˆ—è¡¨\n     * registry centers\n     */\n    private List<RegistryConfig> registries;\n\n    /**\n     * ç›‘æ§ä¸­å¿ƒ\n     * monitor center\n     */\n    private MonitorConfig monitor;\n\n    /**\n     * æ˜¯å¦æ˜¯é»˜è®¤\n     */\n    private Boolean isDefault;\n\n    public ModuleConfig(String name) {\n        setName(name);\n    }\n\n    @Parameter(key = \"module\", required = true)\n    public String getName() {\n        return name;\n    }\n\n    public void setName(String name) {\n        checkName(\"name\", name);\n        this.name = name;\n        //idä¸ºç©ºçš„è¯ï¼Œä½¿ç”¨nameçš„å€¼\n        if (id == null || id.length() == 0) {\n            id = name;\n        }\n    }\n\n    @Parameter(key = \"module.version\")\n    public String getVersion() {\n        return version;\n    }\n    \n    public void setOwner(String owner) {\n        checkName(\"owner\", owner);\n        this.owner = owner;\n    }\n    \n    public void setOrganization(String organization) {\n        checkName(\"organization\", organization);\n        this.organization = organization;\n    }\n\n    public RegistryConfig getRegistry() {\n        return registries == null || registries.isEmpty() ? null : registries.get(0);\n    }\n\n    public void setRegistry(RegistryConfig registry) {\n        List<RegistryConfig> registries = new ArrayList<RegistryConfig>(1);\n        registries.add(registry);\n        this.registries = registries;\n    }\n\n    @SuppressWarnings({\"unchecked\"})\n    public void setRegistries(List<? extends RegistryConfig> registries) {\n        this.registries = (List<RegistryConfig>) registries;\n    }\n    // ...çœç•¥å…¶ä»–ç±»ä¼¼getã€setæ–¹æ³•\n}\n```\n\n##### RegistryConfig\næ³¨å†Œä¸­å¿ƒé…ç½®ï¼Œå¦‚æœæœ‰å¤šä¸ªä¸åŒçš„æ³¨å†Œä¸­å¿ƒï¼Œå¯ä»¥å£°æ˜å¤šä¸ª <dubbo:registry> æ ‡ç­¾ï¼Œå¹¶åœ¨ <dubbo:service> æˆ– <dubbo:reference> çš„ registry å±æ€§æŒ‡å®šä½¿ç”¨çš„æ³¨å†Œä¸­å¿ƒ.\n```java\npublic class RegistryConfig extends AbstractConfig {\n\n    /**\n     * ä¸å¯ç”¨æ ‡è¯†\n     */\n    public static final String NO_AVAILABLE = \"N/A\";\n\n    /**\n     * æœåŠ¡å‘ç°ï¼ˆå¿…å¡«ï¼‰\n     * æ³¨å†Œä¸­å¿ƒæœåŠ¡å™¨åœ°å€ï¼Œå¦‚æœåœ°å€æ²¡æœ‰ç«¯å£ç¼ºçœä¸º9090ï¼ŒåŒä¸€é›†ç¾¤å†…çš„å¤šä¸ªåœ°å€ç”¨é€—å·åˆ†éš”ï¼Œå¦‚ï¼šip:port,ip:port\n     * ä¸åŒé›†ç¾¤çš„æ³¨å†Œä¸­å¿ƒï¼Œè¯·é…ç½®å¤šä¸ª <dubbo:registry> æ ‡ç­¾\n     * <host:port>\n     */\n    private String address;\n\n    /**\n     * æœåŠ¡æ²»ç†\n     * ç™»å½•æ³¨å†Œä¸­å¿ƒç”¨æˆ·åï¼Œå¦‚æœæ³¨å†Œä¸­å¿ƒä¸éœ€è¦éªŒè¯å¯ä¸å¡«\n     * <username>\n     */\n    private String username;\n\n    /**\n     * æœåŠ¡æ²»ç†\n     * ç™»å½•æ³¨å†Œä¸­å¿ƒå¯†ç ï¼Œå¦‚æœæ³¨å†Œä¸­å¿ƒä¸éœ€è¦éªŒè¯å¯ä¸å¡«\n     * <password>\n     */\n    private String password;\n\n    /**\n     * æœåŠ¡å‘ç°\n     * æ³¨å†Œä¸­å¿ƒé»˜è®¤ç«¯å£,å½“addressæ²¡æœ‰å¸¦ç«¯å£æ—¶ä½¿ç”¨æ­¤ç«¯å£åšä¸ºç¼ºçœå€¼\n     * <port>\n     */\n    private Integer port;\n\n    /**\n     * æœåŠ¡å‘ç°(dubbo)\n     * æ³¨å†Œä¸­å¿ƒåœ°å€åè®®,æ”¯æŒdubbo,http,localä¸‰ç§åè®®,åˆ†åˆ«è¡¨ç¤º: dubboåœ°å€,httpåœ°å€,æœ¬åœ°æ³¨å†Œä¸­å¿ƒ\n     * <protocol>\n     */\n    private String protocol;\n\n    /**\n     * æ€§èƒ½è°ƒä¼˜(netty)\n     * ç½‘ç»œä¼ è¾“æ–¹å¼ï¼Œå¯é€‰mina,netty\n     * registry.transporter\n     */\n    private String transporter;\n\n    private String server;\n\n    private String client;\n    \n    private String cluster;\n\n    private String group;\n\n    private String version;\n\n    /**\n     * æ€§èƒ½è°ƒä¼˜(5000)\n     * æ³¨å†Œä¸­å¿ƒè¯·æ±‚è¶…æ—¶æ—¶é—´(æ¯«ç§’)\n     * registry.timeout\t\n     */\n    private Integer timeout;\n\n    /** \n     * æ€§èƒ½è°ƒä¼˜(60000)\n     * æ³¨å†Œä¸­å¿ƒä¼šè¯è¶…æ—¶æ—¶é—´(æ¯«ç§’)ï¼Œç”¨äºæ£€æµ‹æä¾›è€…éæ­£å¸¸æ–­çº¿åçš„è„æ•°æ®ï¼Œæ¯”å¦‚ç”¨å¿ƒè·³æ£€æµ‹çš„å®ç°ï¼Œæ­¤æ—¶é—´å°±æ˜¯å¿ƒè·³é—´éš”ï¼Œä¸åŒæ³¨å†Œä¸­å¿ƒå®ç°ä¸ä¸€æ ·\n     * registry.session\n     */\n    private Integer session;\n\n    /**\n     * æœåŠ¡æ²»ç†\n     * ä½¿ç”¨æ–‡ä»¶ç¼“å­˜æ³¨ å†Œä¸­å¿ƒåœ°å€åˆ—è¡¨åŠæœåŠ¡æä¾›è€…åˆ—è¡¨ï¼Œåº”ç”¨é‡å¯æ—¶å°†åŸºäºæ­¤æ–‡ä»¶æ¢å¤ï¼Œæ³¨æ„ï¼šä¸¤ä¸ªæ³¨å†Œä¸­å¿ƒä¸èƒ½ä½¿ç”¨åŒä¸€æ–‡ä»¶å­˜å‚¨\n     * registry.file\n     */\n    private String file;\n\n    /**\n     * æ€§èƒ½è°ƒä¼˜(0)\n     * åœæ­¢æ—¶ç­‰å¾…é€šçŸ¥å®Œæˆæ—¶é—´(æ¯«ç§’)\n     * registry.wait\n     */\n    private Integer wait;\n\n    /**\n     * æœåŠ¡æ²»ç†(true)\n     * åœ¨å¯åŠ¨æ—¶ï¼Œæ˜¯å¦æ£€æµ‹æ³¨å†Œä¸­å¿ƒæ˜¯å¦å¯ç”¨\n     * check\n     */\n    private Boolean check;\n\n    /**\n     * æœåŠ¡æ²»ç†(true)\n     * æœåŠ¡æ˜¯å¦åŠ¨æ€æ³¨å†Œï¼Œå¦‚æœè®¾ä¸º falseï¼Œæ³¨å†Œåå°†æ˜¾ç¤ºådisableçŠ¶æ€ï¼Œéœ€äººå·¥å¯ç”¨ï¼Œå¹¶ä¸”æœåŠ¡æä¾›è€…åœæ­¢æ—¶ï¼Œä¹Ÿä¸ä¼šè‡ªåŠ¨å–æ¶ˆå†Œï¼Œéœ€äººå·¥ç¦ç”¨\n     * dynamic\n     */\n    private Boolean dynamic;\n\n    /**\n     * æœåŠ¡æ²»ç†ï¼ˆtrueï¼‰\n     * æ˜¯å¦å‘æ­¤æ³¨å†Œä¸­å¿ƒæ³¨å†ŒæœåŠ¡ï¼Œå¦‚æœè®¾ä¸ºfalseï¼Œå°†åªè®¢é˜…ï¼Œä¸æ³¨å†Œ\n     * register\n     */\n    private Boolean register;\n\n    /**\n     * æœåŠ¡æ²»ç†ï¼ˆtrueï¼‰\n     * æ˜¯å¦å‘æ­¤æ³¨å†Œä¸­å¿ƒè®¢é˜…æœåŠ¡ï¼Œå¦‚æœè®¾ä¸ºfalseï¼Œå°†åªæ³¨å†Œï¼Œä¸è®¢é˜…\n     * subscribe \n     */\n    private Boolean subscribe;\n\n    /**\n     * è‡ªå®šä¹‰å‚æ•°\n     */\n    private Map<String, String> parameters;\n\n    /**\n     * æ˜¯å¦æ˜¯é»˜è®¤\n     */\n    private Boolean isDefault;\n\n    public RegistryConfig() {\n    }\n\n    public static void destroyAll() {\n        AbstractRegistryFactory.destroyAll();\n    }\n\n    public void setProtocol(String protocol) {\n        checkName(\"protocol\", protocol);\n        this.protocol = protocol;\n    }\n\n    @Parameter(excluded = true)\n    public String getAddress() {\n        return address;\n    }\n\n    public void setUsername(String username) {\n        checkName(\"username\", username);\n        this.username = username;\n    }\n\n    public void setFile(String file) {\n        checkPathLength(\"file\", file);\n        this.file = file;\n    }\n\n    public void setTransporter(String transporter) { \n        checkName(\"transporter\", transporter);\n        this.transporter = transporter;\n    }\n\n    public void setServer(String server) {\n        checkName(\"server\", server);\n        this.server = server;\n    }\n\n    public void setClient(String client) {\n        checkName(\"client\", client);\n        this.client = client;\n    }\n\n}\n```\n##### MonitorConfig\n```java\npublic class MonitorConfig extends AbstractConfig {\n\n    /**\n     * æœåŠ¡æ²»ç†(dubbo)\n     * ç›‘æ§ä¸­å¿ƒåè®®ï¼Œå¦‚æœä¸ºprotocol=â€registryâ€ï¼Œè¡¨ç¤ºä»æ³¨å†Œä¸­å¿ƒå‘ç°ç›‘æ§ä¸­å¿ƒåœ°å€ï¼Œå¦åˆ™ç›´è¿ç›‘æ§ä¸­å¿ƒ\n     * protocol\n     */\n    private String protocol;\n    \n    /**\n     * æœåŠ¡æ²»ç†(N/A)\n     * ç›´è¿ç›‘æ§ä¸­å¿ƒæœåŠ¡å™¨åœ°å€ï¼Œaddress=â€10.20.130.230:12080â€\n     * <url>\n     */\n    private String address;\n\n    private String username;\n\n    private String password;\n\n    private String group;\n\n    private String version;\n\n    private String interval;\n\n    private Map<String, String> parameters;\n\n    private Boolean isDefault;\n\n    public MonitorConfig(String address) {\n        this.address = address;\n    }\n\n    @Parameter(excluded = true)\n    public String getAddress() {\n        return address;\n    }\n\n    @Parameter(excluded = true)\n    public String getProtocol() {\n        return protocol;\n    }\n\n    @Parameter(excluded = true)\n    public String getUsername() {\n        return username;\n    }\n    @Parameter(excluded = true)\n    public String getPassword() {\n        return password;\n    }\n\n    public void setParameters(Map<String, String> parameters) {\n        checkParameterName(parameters);\n        this.parameters = parameters;\n    }\n\n}\n```\n##### ProviderConfig\nè¯¥ç±»ç»§æ‰¿è‡ªAbstractServiceConfigç±»\n```java\npublic class ProviderConfig extends AbstractServiceConfig {\n\n    //å¦‚æœæ²¡æœ‰è®¾ç½®åè®®çš„å±æ€§å€¼ï¼Œé‚£ä¹ˆé»˜è®¤å€¼å°†ä¼šç”Ÿæ•ˆ\n    /**\n     * æœåŠ¡ipåœ°å€ï¼ˆå½“æœ‰å¤šä¸ªç½‘å¡å¯ç”¨æ—¶ä½¿ç”¨ï¼‰(è‡ªåŠ¨æŸ¥æ‰¾æœ¬æœºIP)\n     * <host>\n     */\n    private String host;\n\n    /**\n     * æœåŠ¡ç«¯å£\n     * port\n     */\n    private Integer port;\n\n    /**\n     * ä¸Šä¸‹æ–‡è·¯å¾„\n     * contextpath\n     */\n    private String contextpath;\n\n    /**\n     * çº¿ç¨‹æ± (fixed)\n     * threadpool\n     */\n    private String threadpool;\n\n    /**\n     * çº¿ç¨‹æ± å¤§å°ï¼ˆå›ºå®šå¤§å°ï¼‰\n     */\n    private Integer threads;\n\n    /**\n     * IOçº¿ç¨‹æ± å¤§å°ï¼ˆCPUæ•°+1ï¼‰\n     * iothreads\n     */\n    private Integer iothreads;\n\n    /**\n     * çº¿ç¨‹æ± é˜Ÿåˆ—é•¿åº¦(0)\n     * queues\n     */\n    private Integer queues;\n\n    /**\n     * æœ€å¤§å¯æ¥å—çš„è¿æ¥(0)\n     * accepts\n     */\n    private Integer accepts;\n\n    /**\n     * åè®®ç¼–è§£ç å™¨ï¼ˆdubboï¼‰\n     * codec\n     */\n    private String codec;\n\n    /**\n     * ç¼–ç ï¼ˆUTF-8ï¼‰\n     * charset\n     */\n    private String charset;\n\n    /**\n     * payloadæœ€å¤§é•¿åº¦(88388608(=8M))\n     * payload\n     */\n    private Integer payload;\n\n    /**\n     * bufferå¤§å°(8192)\n     * buffer\n     */\n    private Integer buffer;\n\n    /**\n     * transporter\n     */\n    private String transporter;\n\n    /**\n     * how information gets exchanged\n     */\n    private String exchanger;\n\n    /**\n     * æ€§èƒ½è°ƒä¼˜\n     * çº¿ç¨‹è°ƒåº¦æ¨¡å¼\n     * åè®®çš„æ¶ˆæ¯æ´¾å‘æ–¹å¼ï¼Œç”¨äºæŒ‡å®šçº¿ç¨‹æ¨¡å‹ï¼Œæ¯”å¦‚ï¼šdubboåè®®çš„all,direct,message,execution,connectionç­‰\n     */\n    private String dispatcher;\n\n    /**\n     * networker\n     */\n    private String networker;\n\n    /**\n     * æœåŠ¡å™¨å®ç°\n     * dubboåè®®ç¼ºçœ ä¸ºnettyï¼Œhttpåè®®ç¼ºçœä¸ºservlet\n     * server\n     */\n    private String server;\n\n    /**\n     * å®¢æˆ·ç«¯å®ç°\n     * dubboåè®®ç¼ºçœ ä¸ºnetty\n     * client\n     */\n    private String client;\n\n    /**\n     * æ”¯æŒtelnetå‘½ä»¤,é€—å·åˆ†å‰²\n     */\n    private String telnet;\n\n    /**\n     * å‘½ä»¤è¡Œæç¤ºç¬¦\n     */\n    private String prompt;\n\n    /**\n     * çŠ¶æ€æ£€æµ‹\n     */\n    private String status;\n\n    /**\n     * åœæ­¢çš„æ—¶å€™ç­‰å¾…å¤šä¹…\n     */\n    private Integer wait;\n\n    private Boolean isDefault;\n\n    @Parameter(excluded = true)\n    public Boolean isDefault() {\n        return isDefault;\n    }\n\n    @Parameter(excluded = true)\n    public String getHost() {\n        return host;\n    }\n\n    @Parameter(excluded = true)\n    public Integer getPort() {\n        return port;\n    }\n\n    @Parameter(excluded = true)\n    public String getContextpath() {\n        return contextpath;\n    }\n\n    public void setContextpath(String contextpath) {\n        checkPathName(\"contextpath\", contextpath);\n        this.contextpath = contextpath;\n    }\n\n    public void setThreadpool(String threadpool) {\n        checkExtension(ThreadPool.class, \"threadpool\", threadpool);\n        this.threadpool = threadpool;\n    }\n\n    public void setTelnet(String telnet) {\n        checkMultiExtension(TelnetHandler.class, \"telnet\", telnet);\n        this.telnet = telnet;\n    }\n\n    @Parameter(escaped = true)\n    public String getPrompt() {\n        return prompt;\n    }\n    public void setStatus(String status) {\n        checkMultiExtension(StatusChecker.class, \"status\", status);\n        this.status = status;\n    }\n\n    @Override\n    public String getCluster() {\n        return super.getCluster();\n    }\n\n    @Override\n    public Integer getConnections() {\n        return super.getConnections();\n    }\n\n    @Override\n    public Integer getTimeout() {\n        return super.getTimeout();\n    }\n\n    @Override\n    public Integer getRetries() {\n        return super.getRetries();\n    }\n\n    @Override\n    public String getLoadbalance() {\n        return super.getLoadbalance();\n    }\n\n    @Override\n    public Boolean isAsync() {\n        return super.isAsync();\n    }\n\n    @Override\n    public Integer getActives() {\n        return super.getActives();\n    }\n\n    public void setTransporter(String transporter) {\n        checkExtension(Transporter.class, \"transporter\", transporter);\n        this.transporter = transporter;\n    }\n\n    public void setExchanger(String exchanger) {\n        checkExtension(Exchanger.class, \"exchanger\", exchanger);\n        this.exchanger = exchanger;\n    }\n\n    public void setDispatcher(String dispatcher) {\n        checkExtension(Dispatcher.class, Constants.DISPATCHER_KEY, exchanger);\n        checkExtension(Dispatcher.class, \"dispather\", exchanger);\n        this.dispatcher = dispatcher;\n    }\n}\n```\n##### AbstractMethodConfig\nè¯¥æŠ½è±¡ç±»ç»§æ‰¿è‡ªAbstractConfig\n```java\npublic abstract class AbstractMethodConfig extends AbstractConfig {\n\n    /**\n     * è¿œç¨‹è°ƒç”¨è¶…æ—¶(1000æ¯«ç§’)\n     * timeout for remote invocation in milliseconds\n     */\n    protected Integer timeout;\n\n    /**\n     * é‡è¯•æ¬¡æ•°ï¼ˆ2ï¼‰\n     */\n    protected Integer retries;\n\n    /**\n     * æœ€å¤§å¹¶å‘è°ƒç”¨(0)\n     * max concurrent invocations\n     */\n    protected Integer actives;\n\n    /**\n     * è´Ÿè½½å‡è¡¡ï¼ˆrandomï¼‰\n     */\n    protected String loadbalance;\n\n    /**\n     * æ˜¯å¦å¼‚æ­¥\n     */\n    protected Boolean async;\n\n    /**\n     * æ˜¯å¦ç¡®è®¤å¼‚æ­¥å‘é€\n     */\n    protected Boolean sent;\n\n    /**\n     * å½“æœåŠ¡è°ƒç”¨å¤±è´¥æ—¶ï¼Œè¢«è°ƒç”¨çš„mackç±»çš„åå­—\n     * mock\n     */\n    protected String mock;\n\n    /**\n     * åˆå¹¶\n     */\n    protected String merger;\n\n    /**\n     * ç¼“å­˜\n     */\n    protected String cache;\n\n    /**\n     * éªŒè¯\n     */\n    protected String validation;\n\n    /**\n     * è‡ªå®šä¹‰å‚æ•°\n     */\n    protected Map<String, String> parameters;\n\n    public void setLoadbalance(String loadbalance) {\n        checkExtension(LoadBalance.class, \"loadbalance\", loadbalance);\n        this.loadbalance = loadbalance;\n    }\n\n    @Parameter(escaped = true)\n    public String getMock() {\n        return mock;\n    }\n\n    public void setMock(Boolean mock) {\n        if (mock == null) {\n            setMock((String) null);\n        } else {\n            setMock(String.valueOf(mock));\n        }\n    }\n\n    public void setMock(String mock) {\n        if (mock != null && mock.startsWith(Constants.RETURN_PREFIX)) {\n            checkLength(\"mock\", mock);\n        } else {\n            checkName(\"mock\", mock);\n        }\n        this.mock = mock;\n    }\n}\n```\n\n##### AbstractInterfaceConfig\nè¯¥ç±»ç»§æ‰¿è‡ªAbstractMethodConfig\n```java\npublic abstract class AbstractInterfaceConfig extends AbstractMethodConfig {\n\n    /**\n     * æœåŠ¡æ¥å£çš„æœ¬åœ°å®ç°ç±»åç§°\n     */\n    protected String local;\n\n    /**\n     * æœåŠ¡æ¥å£çš„æœ¬åœ°å­˜æ ¹ç±»åç§°\n     */\n    protected String stub;\n\n    /**\n     * æœåŠ¡ç›‘æ§\n     */\n    protected MonitorConfig monitor;\n\n    /**\n     * ä»£ç†ç±»å‹\n     */\n    protected String proxy;\n\n    /**\n     * æ€§èƒ½è°ƒä¼˜ï¼ˆfailoverï¼‰\n     * é›†ç¾¤æ–¹å¼ï¼Œå¯é€‰ï¼šfailover/failfast/failsafe/failback/forking\n     * default.cluster\n     */\n    protected String cluster;\n\n    /**\n     * è¿‡æ»¤å™¨\n     */\n    protected String filter;\n\n    /**\n     * ç›‘å¬å™¨\n     */\n    protected String listener;\n\n    /**\n     * æ‰€æœ‰è€…\n     */\n    protected String owner;\n\n    /**\n     * è¿æ¥é™åˆ¶ï¼Œ0æ ‡è¯†å…±äº«è¿æ¥ï¼ˆ0ï¼‰\n     * å¦åˆ™å®ƒå®šä¹‰å§”æ‰˜ç»™å½“å‰æœåŠ¡çš„è¿æ¥\n     * default.connections\t\n     */\n    protected Integer connections;\n\n    protected String layer;\n\n    /**\n     * applicationé…ç½®\n     */\n    protected ApplicationConfig application;\n\n    /**\n     *  moduleé…ç½®\n     */\n    protected ModuleConfig module;\n\n    /**\n     * æ³¨å†Œä¸­å¿ƒå†…åœ°å€\n     * <dubbo:registry address=\"multicast://224.5.6.7:1234\" id=\"com.alibaba.dubbo.config.RegistryConfig\" />\n     */\n    protected List<RegistryConfig> registries;\n\n    /**\n     * è¿æ¥äº‹ä»¶\n     * connection events\n     */\n    protected String onconnect;\n\n    /**\n     * æ–­å¼€è¿æ¥äº‹ä»¶\n     * disconnection events\n     */\n    protected String ondisconnect;\n\n    /**\n     * å›è°ƒé™åˆ¶\n     * callback limits\n     */\n    private Integer callbacks;\n\n    /**\n     * å¼•ç”¨/æš´éœ²æœåŠ¡çš„ä½œç”¨åŸŸ\n     * å¦‚æœå®ƒæ˜¯localï¼Œåˆ™æ„å‘³ç€åªåœ¨å½“å‰è™šæ‹Ÿæœºä¸­è¿›è¡Œæœç´¢\n     */\n    private String scope;\n\n    public void setStub(Boolean stub) {\n        if (stub == null) {\n            setStub((String) null);\n        } else {\n            setStub(String.valueOf(stub));\n        }\n    }\n\n    public void setStub(String stub) {\n        checkName(\"stub\", stub);\n        this.stub = stub;\n    }\n\n    public void setCluster(String cluster) {\n        checkExtension(Cluster.class, \"cluster\", cluster);\n        this.cluster = cluster;\n    }\n\n    public void setProxy(String proxy) {\n        checkExtension(ProxyFactory.class, \"proxy\", proxy);\n        this.proxy = proxy;\n    }\n\n    @Parameter(key = Constants.REFERENCE_FILTER_KEY, append = true)\n    public String getFilter() {\n        return filter;\n    }\n\n    public void setFilter(String filter) {\n        checkMultiExtension(Filter.class, \"filter\", filter);\n        this.filter = filter;\n    }\n\n    @Parameter(key = Constants.INVOKER_LISTENER_KEY, append = true)\n    public String getListener() {\n        return listener;\n    }\n\n    public void setListener(String listener) {\n        checkMultiExtension(InvokerListener.class, \"listener\", listener);\n        this.listener = listener;\n    }\n    public void setLayer(String layer) {\n        checkNameHasSymbol(\"layer\", layer);\n        this.layer = layer;\n    }\n\n    public RegistryConfig getRegistry() {\n        return registries == null || registries.isEmpty() ? null : registries.get(0);\n    }\n\n    public void setRegistry(RegistryConfig registry) {\n        List<RegistryConfig> registries = new ArrayList<RegistryConfig>(1);\n        registries.add(registry);\n        this.registries = registries;\n    }\n    //çœç•¥å…¶ä»–æ–¹æ³•...åé¢ä¼šä»‹ç»\n}\n```\n##### AbstractServiceConfig\nè¯¥æŠ½è±¡ç±»ç»§æ‰¿è‡ªAbstractInterfaceConfig\n```java\npublic abstract class AbstractServiceConfig extends AbstractInterfaceConfig {\n\n\n    /**\n     * ç‰ˆæœ¬(0.0.0)\n     */\n    protected String version;\n\n    /**\n     * ç»„\n     */\n    protected String group;\n\n    /**\n     * æœåŠ¡æ˜¯å¦è¢«å¼ƒç”¨\n     */\n    protected Boolean deprecated;\n\n    /**\n     * å»¶è¿Ÿæš´éœ²\n     */\n    protected Integer delay;\n\n    /**\n     * æ˜¯å¦æš´éœ²æœåŠ¡\n     */\n    protected Boolean export;\n\n    /**\n     * æƒé‡\n     */\n    protected Integer weight;\n\n    /**\n     * æ–‡æ¡£ä¸­å¿ƒ\n     */\n    protected String document;\n\n    /**\n     * æ˜¯å¦åœ¨æ³¨å†Œä¸­å¿ƒæ³¨å†Œä¸ºåŠ¨æ€æœåŠ¡(true)\n     */\n    protected Boolean dynamic;\n\n    /**\n     * æ˜¯å¦ä½¿ç”¨token\n     */\n    protected String token;\n\n    /**\n     * è®¿é—®æ—¥å¿—\n     * access log\n     */\n    protected String accesslog;\n    protected List<ProtocolConfig> protocols;\n    /**\n     * å…è®¸æœ€å¤§æ‰§è¡Œæ—¶é—´\n     * max allowed execute times\n     */\n    private Integer executes;\n    /**\n     * æ˜¯å¦æ³¨å†Œ\n     * whether to register\n     */\n    private Boolean register;\n\n    /**\n     * æ ¹æ®æŒ‡å®šçš„ç¨³å®šååç‡å’Œé¢„çƒ­æœŸæ¥åˆ›å»ºRateLimiter\n     * warm up period\n     */\n    private Integer warmup;\n\n    /**\n     * dubboåè®®ç¼ºçœä¸ºhessian2ï¼Œ rmiåè®®ç¼ºçœä¸ºjavaï¼Œhttpåè®®ç¼ºçœä¸ºjson\n     * serialization\n     */\n    private String serialization;\n\n\n    public void setVersion(String version) {\n        checkKey(\"version\", version);\n        this.version = version;\n    }\n\n    public void setGroup(String group) {\n        checkKey(\"group\", group);\n        this.group = group;\n    }\n\n    @Parameter(escaped = true)\n    public String getDocument() {\n        return document;\n    }\n\n    public void setToken(String token) {\n        checkName(\"token\", token);\n        this.token = token;\n    }\n\n    public void setToken(Boolean token) {\n        if (token == null) {\n            setToken((String) null);\n        } else {\n            setToken(String.valueOf(token));\n        }\n    }\n\n    @SuppressWarnings({\"unchecked\"})\n    public void setProtocols(List<? extends ProtocolConfig> protocols) {\n        this.protocols = (List<ProtocolConfig>) protocols;\n    }\n\n    public ProtocolConfig getProtocol() {\n        return protocols == null || protocols.isEmpty() ? null : protocols.get(0);\n    }\n\n    public void setProtocol(ProtocolConfig protocol) {\n        this.protocols = Arrays.asList(new ProtocolConfig[]{protocol});\n    }\n\n    public void setAccesslog(Boolean accesslog) {\n        if (accesslog == null) {\n            setAccesslog((String) null);\n        } else {\n            setAccesslog(String.valueOf(accesslog));\n        }\n    }\n\n    @Override\n    @Parameter(key = Constants.SERVICE_FILTER_KEY, append = true)\n    public String getFilter() {\n        return super.getFilter();\n    }\n\n    @Override\n    @Parameter(key = Constants.EXPORTER_LISTENER_KEY, append = true)\n    public String getListener() {\n        return super.getListener();\n    }\n\n    @Override\n    public void setListener(String listener) {\n        checkMultiExtension(ExporterListener.class, \"listener\", listener);\n        super.setListener(listener);\n    }\n}\n\n```\n##### ConsumerConfig\n```java\npublic class ConsumerConfig extends AbstractReferenceConfig {\n\n    private Boolean isDefault;\n\n    /**\n     * ä½¿ç”¨çš„ç½‘ç»œæ¡†æ¶å®¢æˆ·ç«¯ï¼šnetty, mina, etc\n     */\n    private String client;\n\n    @Override\n    public void setTimeout(Integer timeout) {\n        super.setTimeout(timeout);\n        //è®¾ç½®rmiè¶…æ—¶æ—¶é—´\n        String rmiTimeout = System.getProperty(\"sun.rmi.transport.tcp.responseTimeout\");\n        if (timeout != null && timeout > 0\n                && (rmiTimeout == null || rmiTimeout.length() == 0)) {\n            System.setProperty(\"sun.rmi.transport.tcp.responseTimeout\", String.valueOf(timeout));\n        }\n    }\n}\n```\n##### AbstractReferenceConfig\n```java\npublic abstract class AbstractReferenceConfig extends AbstractInterfaceConfig {\n\n    //å¦‚æœReferenceçš„å±æ€§æ²¡æœ‰é…ç½®ï¼Œåˆ™é»˜è®¤å€¼å°†ä¼šç”Ÿæ•ˆ\n\n    /**\n     * æ£€æµ‹æœåŠ¡æä¾›è€…æ˜¯å¦å­˜åœ¨\n     */\n    protected Boolean check;\n\n    /**\n     * 1ã€æ˜¯å¦ç«‹å³åˆå§‹åŒ–ï¼Œå¦‚æœä¸ºtrue,beanåŠ è½½æ—¶ä¼šç«‹å³è°ƒç”¨æ¶ˆè´¹è€…åˆå§‹åŒ–\n     * 2ã€æ¶ˆè´¹è€…beanè¢«ä½¿ç”¨è€…è°ƒç”¨æ—¶ï¼Œè°ƒç”¨getObject->get->init\n     */\n    protected Boolean init;\n\n    /**\n     * æ˜¯å¦ä½¿ç”¨ç¼ºçœæ³›åŒ–æ¥å£\n     */\n    protected String generic;\n\n    /**\n     * scope = local\n     * æ˜¯å¦ä»å½“å‰è™šæ‹Ÿæœºä¸­æŸ¥æ‰¾referenceçš„å®ä¾‹\n     * whether to find reference's instance from the current JVM\n     */\n    protected Boolean injvm;\n\n    /**\n     * æƒ°æ€§åˆ›å»ºè¿æ¥\n     * lazy create connection\n     */\n    protected Boolean lazy;\n\n    /**\n     * é‡è¿\n     */\n    protected String reconnect;\n\t\n    protected Boolean sticky;\n\n    /**\n     * stubä¸­æ˜¯å¦æ”¯æŒäº‹ä»¶\n     * Constants.DEFAULT_STUB_EVENT\n     */\n    protected Boolean stubevent;\n\n    /**\n     * é»˜è®¤ç‰ˆæœ¬\n     */\n    protected String version;\n\n    protected String group;\n\n    @Parameter(excluded = true)\n    public Boolean isGeneric() {\n        return ProtocolUtils.isGeneric(generic);\n    }\n\n    public void setGeneric(Boolean generic) {\n        if (generic != null) {\n            this.generic = generic.toString();\n        }\n    }\n\n    @Override\n    @Parameter(key = Constants.REFERENCE_FILTER_KEY, append = true)\n    public String getFilter() {\n        return super.getFilter();\n    }\n\n    @Override\n    @Parameter(key = Constants.INVOKER_LISTENER_KEY, append = true)\n    public String getListener() {\n        return super.getListener();\n    }\n\n    @Override\n    public void setListener(String listener) {\n        checkMultiExtension(InvokerListener.class, \"listener\", listener);\n        super.setListener(listener);\n    }\n\n    @Parameter(key = Constants.LAZY_CONNECT_KEY)\n    public Boolean getLazy() {\n        return lazy;\n    }\n\n    @Override\n    public void setOnconnect(String onconnect) {\n        if (onconnect != null && onconnect.length() > 0) {\n            this.stubevent = true;\n        }\n        super.setOnconnect(onconnect);\n    }\n\n    @Override\n    public void setOndisconnect(String ondisconnect) {\n        if (ondisconnect != null && ondisconnect.length() > 0) {\n            this.stubevent = true;\n        }\n        super.setOndisconnect(ondisconnect);\n    }\n\n    @Parameter(key = Constants.STUB_EVENT_KEY)\n    public Boolean getStubevent() {\n        return stubevent;\n    }\n\n    @Parameter(key = Constants.RECONNECT_KEY)\n    public String getReconnect() {\n        return reconnect;\n    }\n\n    @Parameter(key = Constants.CLUSTER_STICKY_KEY)\n    public Boolean getSticky() {\n        return sticky;\n    }\n}\n```\n\n##### ProtocolConfig\n```java\npublic class ProtocolConfig extends AbstractConfig {\n\n    private static final long serialVersionUID = 6913423882496634749L;\n\n    /**\n     * æ€§èƒ½è°ƒä¼˜(å¿…å¡«dubbo)\n     * åè®®åç§°\n     * \t<protocol>\n     */\n    private String name;\n\n    /**\n     * æœåŠ¡å‘ç°(è‡ªåŠ¨æŸ¥æ‰¾æœ¬æœºIP)\n     * æœåŠ¡ä¸»æœºåï¼Œå¤šç½‘å¡é€‰æ‹©æˆ–æŒ‡å®šVIPåŠåŸŸåæ—¶ä½¿ç”¨ï¼Œä¸ºç©ºåˆ™è‡ªåŠ¨æŸ¥æ‰¾æœ¬æœºIPï¼Œ-å»ºè®®ä¸è¦é…ç½®ï¼Œè®©Dubboè‡ªåŠ¨è·å–æœ¬æœºIP\n     * host\n     */\n    private String host;\n\n    /**\n     * æœåŠ¡ç«¯å£\n     * dubboåè®®ç¼ºçœç«¯å£ä¸º20880,rmiåè®®ç¼ºçœç«¯å£ä¸º1099,http å’Œhessianåè®®ç¼ºçœç«¯å£ä¸º80\n     * å¦‚æœé…ç½®ä¸º-1 æˆ–è€…æ²¡æœ‰é…ç½®portï¼Œåˆ™ä¼šåˆ†é…ä¸€ä¸ªæ²¡æœ‰è¢«å ç”¨çš„ç«¯å£\n     * Dubbo 2.4.0+ï¼Œåˆ†é…çš„ç«¯å£åœ¨åè®®ç¼ºçœç«¯å£çš„åŸºç¡€ä¸Šå¢é•¿ï¼Œç¡®ä¿ç«¯å£æ®µå¯æ§\n     * <port>\n     */\n    private Integer port;\n\n    /**\n     * æœåŠ¡å‘ç°\n     * æä¾›è€…ä¸Šä¸‹æ–‡è·¯å¾„ï¼Œä¸ºæœåŠ¡pathçš„å‰ç¼€\n     * <path>\n     */\n    private String contextpath;\n\n    /**\n     * æ€§èƒ½è°ƒä¼˜ï¼ˆfixedï¼‰\n     * çº¿ç¨‹æ± ç±»å‹ï¼Œå¯é€‰ï¼šfixed/cached\n     * threadpool\n     */\n    private String threadpool;\n\n    /**\n     * æ€§èƒ½è°ƒä¼˜(100)\n     * æœåŠ¡çº¿ç¨‹æ± å¤§å°(å›ºå®šå¤§å°)\n     * threads\n     */\n    private Integer threads;\n\n    /**\n     * æ€§èƒ½è°ƒä¼˜(cpuä¸ªæ•°+1)\n     * IOçº¿ç¨‹æ± å¤§å°ï¼ˆå›ºå®šå¤§å°ï¼‰\n     */\n    private Integer iothreads;\n\n    /**\n     * æ€§èƒ½è°ƒä¼˜(0)\n     * çº¿ç¨‹æ± é˜Ÿåˆ—å¤§å°ï¼Œå½“çº¿ç¨‹æ± æ»¡æ—¶ï¼Œæ’é˜Ÿç­‰å¾…æ‰§è¡Œçš„é˜Ÿåˆ—å¤§å°ï¼Œ\n     * å»ºè®®ä¸è¦è®¾ç½®ï¼Œå½“çº¿ç¨‹ç¨‹æ± æ—¶åº”ç«‹å³å¤±è´¥ï¼Œé‡è¯•å…¶å®ƒæœåŠ¡æä¾›æœºå™¨ï¼Œè€Œä¸æ˜¯æ’é˜Ÿï¼Œé™¤éæœ‰ç‰¹æ®Šéœ€æ±‚\n     * queues\n     */\n    private Integer queues;\n\n    /**\n     * æ€§èƒ½è°ƒä¼˜(0)\n     * æœåŠ¡æä¾›æ–¹æœ€å¤§å¯æ¥å—è¿æ¥æ•°\n     * accepts \n     */\n    private Integer accepts;\n\n    /**\n     * æ€§èƒ½è°ƒä¼˜(dubbo)\n     * åè®®ç¼–ç æ–¹å¼\n     * codec\n     */\n    private String codec;\n\n    /**\n     * æ€§èƒ½è°ƒä¼˜(dubboåè®®ç¼ºçœä¸ºhessian2ï¼Œrmiåè®®ç¼ºçœä¸ºjavaï¼Œhttpåè®® ç¼ºçœä¸ºjson)\n     * åè®®åºåˆ—åŒ–æ–¹å¼ï¼Œå½“åè®®æ”¯æŒå¤šç§åºåˆ—åŒ–æ–¹å¼æ—¶ä½¿ç”¨ï¼Œæ¯”å¦‚ï¼šdubboåè®®çš„dubbo,hessian2,java,compactedjavaï¼Œä»¥åŠhttpåè®®çš„jsonç­‰\n     * serialization\n     */\n    private String serialization;\n\n    /**\n     * åºåˆ—åŒ–ç¼–ç (UTF-8)\n     * charset\n     */\n    private String charset;\n\n    /**\n     * æ€§èƒ½è°ƒä¼˜(88388608(=8M))\n     * è¯·æ±‚åŠå“åº”æ•°æ®åŒ…å¤§å°é™åˆ¶ï¼Œå•ä½ï¼šå­—èŠ‚\n     * payload\n     */\n    private Integer payload;\n\n    /**\n     * æ€§èƒ½è°ƒä¼˜(8192)\n     * ç½‘ç»œè¯»å†™ç¼“å†²åŒºå¤§å°\n     * buffer\n     */\n    private Integer buffer;\n\n    /**\n     * æ€§èƒ½è°ƒä¼˜ï¼ˆ0ï¼‰\n     * å¿ƒè·³é—´éš”ï¼Œå¯¹äºé•¿è¿æ¥ï¼Œå½“ç‰©ç†å±‚æ–­å¼€æ—¶ï¼Œæ¯”å¦‚æ‹”ç½‘çº¿ï¼ŒTCPçš„FINæ¶ˆæ¯æ¥ä¸åŠå‘é€ï¼Œ\n     * å¯¹æ–¹æ”¶ä¸åˆ°æ–­å¼€äº‹ä»¶ï¼Œæ­¤æ—¶éœ€è¦å¿ƒè·³æ¥å¸®åŠ©æ£€æŸ¥è¿æ¥æ˜¯å¦å·²æ–­å¼€\n     * heartbeat\n     */\n    private Integer heartbeat;\n\n    /**\n     * æœåŠ¡æ²»ç†\n     * è®¾ä¸ºtrueï¼Œå°†å‘loggerä¸­è¾“å‡ºè®¿é—®æ—¥å¿—ï¼Œä¹Ÿå¯å¡«å†™è®¿é—®æ—¥å¿—æ–‡ä»¶è·¯å¾„ï¼Œç›´æ¥æŠŠè®¿é—®æ—¥å¿—è¾“å‡ºåˆ°æŒ‡å®šæ–‡ä»¶\n     * accesslog\n     */\n    private String accesslog;\n\t\n    /**\n     * æ€§èƒ½è°ƒä¼˜(dubboåè®®ç¼ºçœä¸ºnetty)\n     * åè®®çš„æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å®ç°ç±»å‹ï¼Œæ¯”å¦‚ï¼šdubboåè®®çš„mina,nettyç­‰ï¼Œå¯ä»¥åˆ†æ‹†ä¸ºserverå’Œclienté…ç½®\n     * transporter\n     */\n    private String transporter;\n\n    private String exchanger;\n\n    /**\n     * æ€§èƒ½(dubboåè®®ç¼ºçœä¸ºall)\n     * åè®®çš„æ¶ˆæ¯æ´¾å‘æ–¹å¼ï¼Œç”¨äºæŒ‡å®šçº¿ç¨‹æ¨¡å‹ï¼Œæ¯”å¦‚ï¼šdubboåè®®çš„all,direct,message,execution,connectionç­‰\n     * dispatcher\n     */\n    private String dispatcher;\n\n    /**\n     * networker\n     */\n    private String networker;\n\n    /**\n     * æ€§èƒ½è°ƒä¼˜(dubboåè®®ç¼ºçœä¸ºnettyï¼Œhttpåè®®ç¼ºçœä¸ºservlet)\n     * åè®®çš„æœåŠ¡å™¨ç«¯å®ç°ç±»å‹ï¼Œæ¯”å¦‚ï¼šdubboåè®®çš„mina,nettyç­‰ï¼Œhttpåè®®çš„jetty,servletç­‰\n     * server\n     */\n    private String server;\n\n    /**\n     * æ€§èƒ½è°ƒä¼˜(åè®®ç¼ºçœä¸ºnetty)\n     * å®¢æˆ·ç«¯å®ç°\n     * client\n     */\n    private String client;\n\n    /**\n     * æœåŠ¡æ²»ç†\n     * æ”¯æŒçš„telnetå‘½ä»¤ï¼Œé€—å·åˆ†éš”\n     * telnet\n     */\n    private String telnet;\n\n    /**\n     * å‘½ä»¤è¡Œæç¤º\n     */\n    private String prompt;\n\n    /**\n     * çŠ¶æ€æ£€æµ‹\n     */\n    private String status;\n\n    /**\n     * æœåŠ¡æ²»ç†ï¼ˆtrueï¼‰\n     * è¯¥åè®®çš„æœåŠ¡æ˜¯å¦æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒ\n     */\n    private Boolean register;\n\n    /**\n     * æ˜¯å¦é•¿è¿æ¥\n     * TODO add this to provider config\n     */\n    private Boolean keepAlive;\n\n    /**\n     * TODO add this to provider config\n     */\n    private String optimizer;\n\n    private String extension;\n\n    private Map<String, String> parameters;\n\n    private Boolean isDefault;\n  \n    /**\n     * æ˜¯å¦å·²ç»é”€æ¯\n     */\n    private static final AtomicBoolean destroyed = new AtomicBoolean(false);\n\n    public ProtocolConfig() {\n    }\n\n    public ProtocolConfig(String name) {\n        setName(name);\n    }\n\n    public ProtocolConfig(String name, int port) {\n        setName(name);\n        setPort(port);\n    }\n\n    @Parameter(excluded = true)\n    public String getName() {\n        return name;\n    }\n\n    public void setName(String name) {\n        checkName(\"name\", name);\n        this.name = name;\n        if (id == null || id.length() == 0) {\n            id = name;\n        }\n    }\n\n    @Parameter(excluded = true)\n    public String getHost() {\n        return host;\n    }\n\n    @Parameter(excluded = true)\n    public Integer getPort() {\n        return port;\n    }\n\n    @Parameter(excluded = true)\n    public String getContextpath() {\n        return contextpath;\n    }\n\n    public void setContextpath(String contextpath) {\n        checkPathName(\"contextpath\", contextpath);\n        this.contextpath = contextpath;\n    }\n\n    public void setThreadpool(String threadpool) {\n        checkExtension(ThreadPool.class, \"threadpool\", threadpool);\n        this.threadpool = threadpool;\n    }\n\n    public void setCodec(String codec) {\n        if (\"dubbo\".equals(name)) {\n            checkMultiExtension(Codec.class, \"codec\", codec);\n        }\n        this.codec = codec;\n    }\n\n    public void setSerialization(String serialization) {\n        if (\"dubbo\".equals(name)) {\n            checkMultiExtension(Serialization.class, \"serialization\", serialization);\n        }\n        this.serialization = serialization;\n    }\n\n    public void setServer(String server) {\n        if (\"dubbo\".equals(name)) {\n            checkMultiExtension(Transporter.class, \"server\", server);\n        }\n        this.server = server;\n    }\n\n    public void setClient(String client) {\n        if (\"dubbo\".equals(name)) {\n            checkMultiExtension(Transporter.class, \"client\", client);\n        }\n        this.client = client;\n    }\n\n    public void setTelnet(String telnet) {\n        checkMultiExtension(TelnetHandler.class, \"telnet\", telnet);\n        this.telnet = telnet;\n    }\n\n    @Parameter(escaped = true)\n    public String getPrompt() {\n        return prompt;\n    }\n\n    public void setStatus(String status) {\n        checkMultiExtension(StatusChecker.class, \"status\", status);\n        this.status = status;\n    }\n\n    public void setTransporter(String transporter) {\n        checkExtension(Transporter.class, \"transporter\", transporter);\n        this.transporter = transporter;\n    }\n\n    public void setExchanger(String exchanger) {\n        checkExtension(Exchanger.class, \"exchanger\", exchanger);\n        this.exchanger = exchanger;\n    }\n\n    public void setDispatcher(String dispatcher) {\n        checkExtension(Dispatcher.class, \"dispacther\", dispatcher);\n        this.dispatcher = dispatcher;\n    }\n\n    public void destory() {\n        if (name != null) {\n\t    //è·å–Protocolæ‰©å±•å®ä¾‹ï¼Œç„¶åè°ƒç”¨destroyæ–¹æ³•\n            ExtensionLoader.getExtensionLoader(Protocol.class)\n                    .getExtension(name)\n                    .destroy();\n        }\n    }\n}\n```\n##### ServiceConfig\n```java\npublic class ServiceConfig<T> extends AbstractServiceConfig {\n\n    /**\n     * æœåŠ¡å‘ç°\n     * æœåŠ¡æ¥å£åç§°\n     */\n    private String interfaceName;\n   \n    /**\n     * æœåŠ¡æ¥å£ç±»\n     */\n    private Class<?> interfaceClass;\n   \n    /**\n     * æœåŠ¡å‘ç°(å¿…å¡«)\n     * æœåŠ¡å¯¹è±¡å®ç°å¼•ç”¨\n     */\n    private T ref;\n    \n    /**\n     * æœåŠ¡å‘ç°(ç¼ºçœä¸ºæ¥å£å)\n     * æœåŠ¡è·¯å¾„(æ³¨æ„ï¼š1.0ä¸æ”¯æŒè‡ªå®šä¹‰è·¯å¾„ï¼Œæ€»æ˜¯ä½¿ç”¨æ¥å£åï¼Œå¦‚æœæœ‰1.0è°ƒ 2.0ï¼Œé…ç½®æœåŠ¡è·¯å¾„å¯èƒ½ä¸å…¼å®¹\n     * <path>\n     */\n    private String path;\n    \n    /**\n     * æœåŠ¡æ–¹æ³•é…ç½®\n     */\n    private List<MethodConfig> methods;\n   \n    /**\n     * æä¾›è€…\n     */\n    private ProviderConfig provider;\n\n\n    /**\n     * æ³›åŒ–æ¥å£\n     */\n    private volatile String generic;\n}\n\n```\n##### ReferenceConfig\n```java\npublic class ReferenceConfig<T> extends AbstractReferenceConfig {\n\n    /**\n     * å¼•ç”¨çš„æ¥å£åç§°\n     */\n    private String interfaceName;\n\n    /**\n     * å¼•ç”¨çš„æ¥å£ç±»\n     */\n    private Class<?> interfaceClass;\n    \n    /**\n     * å®¢æˆ·ç«¯ç±»å‹\n     */\n    private String client;\n    \n    /**\n     * ç‚¹å¯¹ç‚¹è°ƒç”¨url\n     */\n    private String url;\n    \n    /**\n     * å¼•ç”¨æ¥å£æ–¹æ³•é…ç½®\n     */\n    private List<MethodConfig> methods;\n    \n    /**\n     * é»˜è®¤é…ç½®\n     */\n    private ConsumerConfig consumer;\n    \n    /**\n     * åè®®\n     */\n    private String protocol;\n\n    /**\n     * æ¥å£ä»£ç†å¼•ç”¨\n     * interface proxy reference\n     */\n    private transient volatile T ref;\n\n    private transient volatile Invoker<?> invoker;\n\n    /**\n     * æ˜¯å¦å·²åˆå§‹åŒ–\n     */\n    private transient volatile boolean initialized;\n\n    /**\n     * æ˜¯å¦å·²é”€æ¯\n     */\n    private transient volatile boolean destroyed;\n}\n```\n\n### è¦†ç›–å’Œä¼˜å…ˆçº§\nä»¥timeoutä¸ºä¾‹ï¼Œè¿™é‡ŒæŒ‰ç…§ä¼˜å…ˆçº§ä»é«˜åˆ°ä½æ’åˆ—(retries,loadbalance, activesä¹Ÿåº”ç”¨ç›¸åŒçš„è§„åˆ™)ï¼š\n* æ–¹æ³•çº§åˆ«ï¼Œæ¥å£çº§åˆ«ï¼Œé»˜è®¤/å…¨å±€çº§åˆ«\n* ç›¸åŒçš„çº§åˆ«ä¸‹ï¼Œæ¶ˆè´¹è€…æ¯”æä¾›è€…æœ‰æ›´é«˜çš„ä¼˜å…ˆçº§\n![](img/level.jpg)\n\nè¿™ä¸€å°èŠ‚æˆ‘ä»¬å°±å…ˆä»‹ç»åˆ°è¿™é‡Œï¼Œä¸‹ä¸€å°èŠ‚å¼€å§‹ä»‹ç»å…·ä½“çš„è§£æé€»è¾‘ã€‚\n\n","tags":["dubbo"]},{"title":"Dubboæºç é˜…è¯»ä¹‹Loggeræ¨¡å—","url":"/blog/2018/07/31/Dubboæºç é˜…è¯»ä¹‹Loggeræ¨¡å—/","content":">æœ¬æ–‡ä¸»è¦åˆ†æDubboæ˜¯å¦‚ä½•å°è£…å¸¸ç”¨çš„æ—¥å¿—æ¡†æ¶çš„ï¼Œä»¥åŠåœ¨Dubboä¸­å¦‚ä½•ä½¿ç”¨æ—¥å¿—ã€‚\n\nåœ¨com.alibaba.dubbo.common.loggeråŒ…ä¸­å®šä¹‰äº†å¦‚ä¸‹å‡ ä¸ªå’Œæ—¥å¿—ç›¸å…³çš„ç±»å’Œæ¥å£ï¼š\n\n* Levelæšä¸¾ç±»\n* Loggeræ¥å£\n* LoggerAdapteræ¥å£\n* LoggerFactoryç±»\n\n### Levelæšä¸¾ç±»\nè¯¥æšä¸¾ç±»ä»ä½åˆ°é«˜å®šä¹‰äº†å¦‚ä¸‹å‡ ä¸ªæ—¥å¿—çº§åˆ«ï¼š\n```java\nALL,TRACE,DEBUG,INFO,WARN,ERROR,OFF\n```\n### Loggeræ¥å£\nè¯¥æ¥å£å®šä¹‰äº†ä¸€äº›è¾“å‡ºç›¸åº”çº§åˆ«æ—¥å¿—çš„æ–¹æ³•ï¼Œå¦‚ï¼š\n```JAVA\npublic interface Logger {\n\t//è¾“å‡ºdebugçº§åˆ«æ—¥å¿—\n\tpublic void debug(Throwable e);\n\tpublic void debug(String msg, Throwable e);\n\tpublic boolean isDebugEnabled();\n\n\t//çœç•¥å…¶ä»–ç±»ä¼¼æ–¹æ³•\n\t...\n}\n```\n### LoggerAdapteræ¥å£\nè¯¥æ¥å£ä¸ºLoggeræä¾›è€…ï¼Œå®šä¹‰äº†è·å–Loggerã€è®¾ç½®levelçº§åˆ«ã€è®¾ç½®loggeræ–‡ä»¶ç­‰æ–¹æ³•,SPIæ³¨è§£æˆ‘ä»¬åé¢çš„ç« èŠ‚ä¼šè¯¦ç»†ä»‹ç»:\n```JAVA\n@SPI\npublic interface LoggerAdapter{\n    //è·å–Logger\n    Logger getLogger(Class<?> key);\n    //è·å–Logger\n    Logger getLogger(String key);\n    //è·å–å½“å‰loggeræ—¥å¿—çº§åˆ«\n    Level getLevel();\n    //è®¾ç½®å½“å‰loggerçº§åˆ«\n    void setLevel(Level level);\n    //è·å–å½“å‰loggeræ–‡ä»¶\n    File getFile();\n    //è®¾ç½®å½“å‰loggeræ–‡ä»¶\n    void setFile(File file);\n}\n```\n### JdkLogger/JdkLoggerAdapterä¾‹å­\nå¦‚æœéœ€è¦å°†æ—¥å¿—æ¡†æ¶é›†æˆåˆ°Dubboä¸­ï¼Œéœ€è¦å®ç°ä¸Šé¢å®šä¹‰çš„Loggeræ¥å£å’ŒLoggerAdapteræ¥å£ã€‚\nDubboé»˜è®¤å·²ç»é›†æˆäº†commons-loggingã€java.util.logging.Loggerã€org.apache.log4j.Loggerã€org.slf4j.Loggerã€‚\nä½œä¸ºä¾‹å­ï¼Œæˆ‘ä»¬çœ‹ä¸‹jdkLoggerï¼Œå…¶ä»–çš„éƒ½ç±»ä¼¼ã€‚\n```JAVA\n//JdkLoggerå®ç°äº†Dubboæ¡†æ¶å®šä¹‰çš„Loggeræ¥å£\npublic class JdkLogger implements Logger {\n\n    //æŒæœ‰java.util.logging.Loggerå®ä¾‹\t\n    private final java.util.logging.Logger logger;\n\n    public JdkLogger(java.util.logging.Logger logger) {\n\t//æ„é€ æ–¹æ³•ï¼Œè®¾ç½®loggerå®ä¾‹\n        this.logger = logger;\n    }\n\n    //å®ç°äº†Loggeræ¥å£ä¸­å®šä¹‰çš„æ–¹æ³•\n    //éƒ½æ˜¯å§”æ‰˜ç»™äº†java.util.logging.Loggerå®ä¾‹æ¥æ‰“å°ç›¸åº”çº§åˆ«çš„æ—¥å¿—\n    @Override\n    public void info(String msg, Throwable e) {\n        logger.log(Level.INFO, msg, e);\n    }\n    \n    @Override\n    public boolean isInfoEnabled() {\n        return logger.isLoggable(Level.INFO);\n    } \n     \n    //çœç•¥å…¶ä»–ç±»ä¼¼æ–¹æ³•\n    ...\n}\n\n//JdkLoggerAdapterå®ç°äº†Dubboæ¡†æ¶å®šä¹‰çš„LoggerAdapteræ¥å£\npublic class JdkLoggerAdapter implements LoggerAdapter {\n\t\n\t//å…¨å±€æ—¥å¿—åç§°\n\tprivate static final String GLOBAL_LOGGER_NAME = \"global\";\n\t\n\t//å­˜æ”¾æ—¥å¿—çš„æ–‡ä»¶\n\tprivate File file;\n\t\t\n\t//è¯¥æ„é€ æ–¹æ³•è¯»å–jdkæ—¥å¿—é…ç½®æ–‡ä»¶logging.propertiesï¼Œè®¾ç½®æ—¥å¿—æ–‡ä»¶file\n\tpublic JdkLoggerAdapter() {\n\t\ttry {\n\t\t    //è·å–jdkæ—¥å¿—é…ç½®æ–‡ä»¶logging.properties\n\t\t    InputStream in = Thread.currentThread()\n\t\t\t    .getContextClassLoader()\n\t\t\t    .getResourceAsStream(\"logging.properties\");\n\t\t    if (in != null) {\n\t\t\t//è¯»å–é…ç½®\n\t\t\tLogManager.getLogManager().readConfiguration(in);\n\t\t    } else {\n\t\t\t//åœ¨classpathä¸­æ²¡æ‰¾åˆ°jdkæ—¥å¿—é…ç½®æ–‡ä»¶logging.properties\n\t\t\tSystem.err.println(\"No such logging.properties in classpath for jdk logging config!\");\n\t\t    }\n\t\t} catch (Throwable t) {\n\t\t    System.err.println(\"Failed to load logging.properties in classpath for jdk logging config, cause: \" + t.getMessage());\n\t\t}\n\t\ttry {\n\t\t    //è·å–ä¸æ­¤Loggerå…³è”çš„Handlers\n\t\t    Handler[] handlers =\n\t\t\t    java.util.logging.Logger.getLogger(GLOBAL_LOGGER_NAME)\n\t\t\t\t    .getHandlers();\n\t\t    for (Handler handler : handlers) {\n\t\t\tif (handler instanceof FileHandler) {\n\t\t\t    FileHandler fileHandler = (FileHandler) handler;\n\t\t\t    //é€šè¿‡åå°„æ‰¾åˆ°fileså­—æ®µ\n\t\t\t    Field field = fileHandler.getClass().getField(\"files\");\n\t\t\t    //è·å–fileHandlerå¯¹è±¡çš„fieldå­—æ®µçš„å€¼\n\t\t\t    File[] files = (File[]) field.get(fileHandler);\n\t\t\t    if (files != null && files.length > 0) {\n\t\t\t\t//è®¾ç½®fileï¼Œå³æ—¥å¿—æ–‡ä»¶\n\t\t\t\tfile = files[0];\n\t\t\t    }\n\t\t\t}\n\t\t    }\n\t\t} catch (Throwable t) {\n\t\t}\n\t }\n\t\t\n\t //getLoggeræ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ªJdkLoggerå¯¹è±¡ï¼Œæ„é€ JdkLoggerå¯¹è±¡æ—¶ä¼ å…¥äº†java.util.logging.Loggerçš„Logger\n\t @Override\n\t public Logger getLogger(Class<?> key) {\n\t        //å°†æœ€ç»ˆä½¿ç”¨çš„æ—¥å¿—æ¡†æ¶åŒ…è£…æˆäº†Dubboçš„Loggerå¯¹è±¡\n\t\treturn new JdkLogger(java.util.logging.Logger.getLogger(key == null ? \"\" : key.getName()));\n\t }\n\n\t //è¿”å›æ—¥å¿—æ–‡ä»¶\n\t @Override\n\t public File getFile() {\n\t\treturn file;\n\t }\n\n\t //è·å–æ—¥å¿—çº§åˆ«\n\t @Override\n\t public Level getLevel() {\n\t        //è¿™é‡Œé€šè¿‡fromJdkLevelæ–¹æ³•å°†jdkçš„loggerçº§åˆ«è½¬æ¢æˆäº†dubboå®šä¹‰çš„levelçº§åˆ«\n\t\treturn fromJdkLevel(java.util.logging.Logger.getLogger(GLOBAL_LOGGER_NAME).getLevel());\n\t }\n\n         //è®¾ç½®æ—¥å¿—çº§åˆ«\n         @Override\n\t public void setLevel(Level level) {\n\t         //è¿™é‡Œé€šè¿‡toJdkLevelæ–¹æ³•å°†dubboå®šä¹‰çš„levelçº§åˆ«è½¬æ¢æˆäº†jdkçš„loggerçº§åˆ«\n\t\tjava.util.logging.Logger.getLogger(GLOBAL_LOGGER_NAME).setLevel(toJdkLevel(level));\n\t }\n\n\t //fromJdkLevelå’ŒtoJdkLevelæ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œå°±ä¸åˆ—å‡ºæ¥äº†\n}\n```\n\n### LoggerFactoryç±»\nè¯¥ç±»æ˜¯Loggerå·¥å‚ï¼Œå®šä¹‰äº†è·å–Loggerçš„é™æ€æ–¹æ³•ï¼Œéœ€è¦ä½¿ç”¨æ—¥å¿—æ—¶éƒ½æ˜¯ç›´æ¥æ“ä½œè¯¥ç±»æ‹¿åˆ°Loggerã€‚\nLOGGERSå’ŒLOGGER_ADAPTERé™æ€å˜é‡åé¢ä¼šä»‹ç»ã€‚\n```\npublic class LoggerFactory {\n\n    //ç¼“å­˜å·²åˆ›å»ºLoggerçš„ç±»<ç±»åç§°ï¼Œè¯¥ç±»å¯¹åº”çš„Logger>\n    private static final ConcurrentMap<String, FailsafeLogger> LOGGERS =\n            new ConcurrentHashMap<String, FailsafeLogger>();\n    \n    //å½“å‰ä½¿ç”¨çš„æ—¥å¿—æ¡†æ¶\n    private static volatile LoggerAdapter LOGGER_ADAPTER;\n}\n```\nä¾‹å¦‚åœ¨ScriptRouterç±»ä¸­ï¼Œå¯ä»¥è¿™æ ·ä½¿ç”¨:\n```\npublic class ScriptRouter{\n\tprivate static final Logger logger = LoggerFactory.getLogger(ScriptRouter.class);\n\tpublic void error(){\n\t\tlogger.debug(\"route error , rule has been ignored\");\n\t}\n}\n```\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹ä¸‹LoggerFactoryä¸­çš„getLoggeræ–¹æ³•å®šä¹‰ï¼š\n```java\npublic static Logger getLogger(Class<?> key) {\n        //æ ¹æ®nameä»LOGGERSç¼“å­˜ä¸­è·å–FailsafeLogger\n        FailsafeLogger logger = LOGGERS.get(key.getName());\n        if (logger == null) {\n            //å¦‚æœloggerä¸ºç©ºï¼Œåˆ™ä¸ºç±»keyåˆ›å»ºä¸€ä¸ªFailsafeLoggerï¼Œå¹¶æ”¾å…¥ç¼“å­˜LOGGERS\n            LOGGERS.putIfAbsent(key.getName(), new FailsafeLogger(LOGGER_ADAPTER.getLogger(key)));\n            logger = LOGGERS.get(key.getName());\n        }\n        return logger;\n}\n```\nè·å–Loggeræ—¶ï¼Œæˆ‘ä»¬æ˜¯ä»LOGGERSå˜é‡ä¸­è·å–çš„ï¼Œå¯è§LOGGERSæ˜¯ç”¨æ¥ç¼“å­˜æˆ‘ä»¬å·²åˆ›å»ºçš„Loggerå¯¹è±¡çš„ã€‚\nè€Œåˆ›å»ºFailsafeLoggerå¯¹è±¡æ—¶ï¼Œæˆ‘ä»¬æ˜¯æ ¹æ®keyä»LOGGER_ADAPTERå˜é‡ä¸­è·å–çš„Loggerã€‚\nç”±æ­¤å¯çŸ¥ï¼Œæˆ‘ä»¬æ˜¯é€šè¿‡LOGGER_ADAPTERå˜é‡(å³LoggerAdapteræ¥å£)çš„getLogger(key)æ–¹æ³•è·å–åˆ°äº†æœ€ç»ˆä½¿ç”¨çš„æ—¥å¿—æ¡†æ¶ï¼Œç„¶ååŒ…è£…æˆäº†FailsafeLoggerå˜é‡ç¼“å­˜èµ·æ¥ã€‚\næˆ‘ä»¬å…ˆæ¥å¤§æ¦‚çœ‹ä¸‹FailsafeLoggerç±»çš„å®šä¹‰ï¼Œç„¶ååœ¨çœ‹ä¸‹LOGGER_ADAPTERå˜é‡æ˜¯åœ¨ä½•æ—¶è¢«èµ‹å€¼çš„ã€‚\n```java\npublic class FailsafeLogger implements Logger{\n\t\n     //åŒ…å«äº†æœ€ç»ˆæ—¥å¿—æ¡†æ¶çš„logger\n     private Logger logger;\n\n     public FailsafeLogger(Logger logger) {\n        this.logger = logger;\n     }\n     \n     //åœ¨æ—¥å¿—ä¿¡æ¯ä¸Šé™„åŠ dubboä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¦‚ï¼šdubboç‰ˆæœ¬ã€ä¸»æœºåœ°å€\n     private String appendContextMessage(String msg) {\n        return \" [DUBBO] \" + msg + \", dubbo version: \" + Version.getVersion() + \", current host: \" + NetUtils.getLocalHost();\n     }\n\n     @Override\n     public void info(String msg) {\n        try {\n\t    //è¾“å‡ºé™„åŠ äº†ä¸Šä¸‹æ–‡ä¿¡æ¯çš„æ—¥å¿—\n            logger.info(appendContextMessage(msg));\n        } catch (Throwable t) {\n        }\n     }\n\n     @Override\n     public boolean isInfoEnabled() {\n        try {\n            return logger.isInfoEnabled();\n        } catch (Throwable t) {\n            return false;\n        }\n     }\n     \n     //çœç•¥å…¶ä»–ç±»ä¼¼æ–¹æ³•\n     ...\n}\n```\næˆ‘ä»¬åœ¨æ¥çœ‹ä¸‹LOGGER_ADAPTERå˜é‡æ˜¯å¦‚ä½•è¢«èµ‹å€¼çš„ï¼Œå®é™…ä¸Šï¼Œåœ¨LoggerFactoryç±»åˆå§‹åŒ–æ—¶ï¼Œä¾¿ä¼šè¯•ç€è®¾ç½®å½“å‰ä½¿ç”¨çš„æ—¥å¿—æ¡†æ¶ï¼š\n```java\nstatic {\n        //ä»JVMç³»ç»Ÿå±æ€§ä¸­è·å–é…ç½®çš„æ—¥å¿—æ¡†æ¶ï¼Œå³é€šè¿‡ï¼šjava -Ddubbo.application.logger=slf4jé…ç½®\n        String logger = System.getProperty(\"dubbo.application.logger\");\n        if (\"slf4j\".equals(logger)) {\n            //å¦‚æœæ˜¯slf4jï¼Œåˆ™è®¾ç½®å½“å‰ä½¿ç”¨çš„æ—¥å¿—æ¡†æ¶ä¸ºSlf4jLoggerAdapter\n            setLoggerAdapter(new Slf4jLoggerAdapter());\n        } else if (\"jcl\".equals(logger)) {\n            setLoggerAdapter(new JclLoggerAdapter());\n        } else if (\"log4j\".equals(logger)) {\n            setLoggerAdapter(new Log4jLoggerAdapter());\n        } else if (\"jdk\".equals(logger)) {\n            setLoggerAdapter(new JdkLoggerAdapter());\n        } else {\n            //å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°ï¼Œåˆ™æŒ¨ä¸ªå°è¯•å¯ç”¨çš„æ—¥å¿—æ¡†æ¶\n            try {\n                setLoggerAdapter(new Log4jLoggerAdapter());\n            } catch (Throwable e1) {\n                try {\n                    setLoggerAdapter(new Slf4jLoggerAdapter());\n                } catch (Throwable e2) {\n                    try {\n                        setLoggerAdapter(new JclLoggerAdapter());\n                    } catch (Throwable e3) {\n                        setLoggerAdapter(new JdkLoggerAdapter());\n                    }\n                }\n            }\n        }\n}\n\n//è®¾ç½®å¹¶ä¿®æ”¹å½“å‰ä½¿ç”¨çš„LoggerAdapter\npublic static void setLoggerAdapter(LoggerAdapter loggerAdapter) {\n        if (loggerAdapter != null) {\n            //é¦–å…ˆè·å–LoggerFactoryç±»çš„Logger\n            Logger logger = loggerAdapter.getLogger(LoggerFactory.class.getName());\n            //ç„¶åè¾“å‡ºå³å°†ä½¿ç”¨çš„loggerï¼šloggerAdapter\n            logger.info(\"using logger: \" + loggerAdapter.getClass().getName());\n            //è®¾ç½®LOGGER_ADAPTERå˜é‡ä¸ºloggerAdapter\n            LoggerFactory.LOGGER_ADAPTER = loggerAdapter;\n            //éå†å·²åˆ›å»ºloggerçš„ç±»åˆ—è¡¨ï¼Œç„¶åä¿®æ”¹loggerä¸ºæ–°è®¾ç½®çš„loggerAdapter\n            for (Map.Entry<String, FailsafeLogger> entry : LOGGERS.entrySet()) {\n                //è®¾ç½®FailsafeLoggerçš„loggerä¸ºloggerAdapteråˆ›å»ºçš„logger\n                entry.getValue().setLogger(LOGGER_ADAPTER.getLogger(entry.getKey()));\n            }\n        }\n}\n\n//è·å–å½“å‰æ—¥å¿—çº§åˆ«\npublic static Level getLevel() {\n       //è¿”å›LOGGER_ADAPTERçš„æ—¥å¿—çº§åˆ«\n       return LOGGER_ADAPTER.getLevel();\n}\n\n//è®¾ç½®å½“å‰æ—¥å¿—çº§åˆ«\npublic static void setLevel(Level level) {\n       LOGGER_ADAPTER.setLevel(level);\n}\n\n//è·å–å½“å‰æ—¥å¿—æ–‡ä»¶\npublic static File getFile() {\n        return LOGGER_ADAPTER.getFile();\n}\n```\n\nåˆ°æ­¤ï¼Œæˆ‘ä»¬å°±ä»‹ç»å®ŒDubbo-Loggerç›¸å…³çš„å†…å®¹äº†ï¼ŒDubboä½œä¸ºå¸¸ç”¨çš„ä¸­é—´ä»¶ï¼Œé›†æˆäº†å¯é€‰çš„æ—¥å¿—æ¡†æ¶ï¼Œæ˜¯éå¸¸å€¼å¾—æˆ‘ä»¬å­¦ä¹ ï¼Œæœ€åï¼Œç»™ä¸€ä¸ªç±»å›¾åŠ æ·±ä¸‹ç†è§£ã€‚\n\n![](img/log.png)\n\n\n","tags":["dubbo"]},{"title":"Dubboæºç é˜…è¯»ä¹‹SPIæ‰©å±•æœºåˆ¶","url":"/blog/2018/07/31/Dubboæºç é˜…è¯»ä¹‹SPIæ‰©å±•æœºåˆ¶/","content":">æœ¬æ–‡ä¸»è¦åˆ†æDubboçš„SPIæ‰©å±•æœºåˆ¶ã€‚\n\n* [Javaçš„SPIæœºåˆ¶](https://docs.oracle.com/javase/1.5.0/docs/guide/jar/jar.html#Service%20Provider)\n* Dubboçš„SPIæœºåˆ¶\n\n### Javaçš„SPIæœºåˆ¶\nSPIå…¨ç§°ä¸º(Service Provider Interface)ï¼Œæ˜¯JDKå†…ç½®çš„ä¸€ç§æœåŠ¡æä¾›å‘ç°æœºåˆ¶ã€‚é€šè¿‡SPIæœåŠ¡åŠ è½½æœºåˆ¶è¿›è¡ŒæœåŠ¡çš„æ³¨å†Œå’Œå‘ç°ï¼Œå¯ä»¥å®ç°åŸºäºæ¥å£çš„ç¼–ç¨‹ï¼Œé¿å…åœ¨Javaä»£ç ä¸­å†™æ­»æœåŠ¡çš„æä¾›è€…ï¼Œå®ç°å¤šä¸ªæ¨¡å—çš„è§£è€¦ã€‚\næ ¹æ®Javaçš„SPIè§„èŒƒï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªæœåŠ¡æ¥å£ï¼Œå…·ä½“çš„å®ç°ç”±å¯¹åº”çš„å®ç°è€…ï¼ˆService ProvideræœåŠ¡æä¾›è€…ï¼‰æä¾›ï¼Œç„¶ååœ¨ä½¿ç”¨çš„æ—¶å€™åªè¦æ ¹æ®SPIçš„è§„èŒƒå»è·å–å¯¹åº”çš„æœåŠ¡æä¾›è€…çš„æœåŠ¡å®ç°å³å¯ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š\n```java\npackage java.spi;\npublic interface Developer {\n    public String getPrograme();\n}\n\npackage java.spi;\npublic class JavaDeveloper implements Developer {\n    @Override\n    public String getPrograme() {\n        return \"Java\";\n    }\n}\n\npackage java.spi;\npublic class PerlDeveloper implements Developer {\n    @Override\n    public String getPrograme() {\n        return \"Perl\";\n    }\n}\n```\nç„¶ååœ¨META-INF\\servicesç›®å½•ä¸‹åˆ›å»ºåä¸ºjava.spi.Developerçš„æ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹æ˜¯æ¥å£å®ç°ç±»çš„å…¨é™å®šåï¼š\n```java\njava.spi.JavaDeveloper\njava.spi.PerlDeveloper\n```\nå°†æ–‡ä»¶å¯¼å‡ºä¸ºjaråŒ…ï¼Œæ–°å»ºä¸€ä¸ªé¡¹ç›®ï¼Œåœ¨é¡¹ç›®ä¸­å¯¼å…¥è¯¥jar,ç„¶åæ–°å»ºä¸€ä¸ªæµ‹è¯•ç±»ï¼š\n```java\nimport java.util.ServiceLoader;\nimport cn.edu.knowledge.spi.Developer;\npublic class Test {\n    public static void main(String[] arg) {\n         ServiceLoader<Developer> serviceLoader = ServiceLoader.load(Developer.class);\n\t for (Developer developer : Developer) {\n\t        //å°†ä¼šè¾“å‡º: I use Java; I use Perl;\n\t\tSystem.out.println(\"I use \"+developer.getPrograme());\n\t }\n    }\n}\n```\n\n### Dubboçš„SPIæœºåˆ¶\nDubboçš„æ‰©å±•ç‚¹åŠ è½½æ˜¯å¯¹JDKå†…ç½®çš„SPIæœºåˆ¶çš„ä¸€ç§åŠ å¼ºã€‚ç»§ç»­ä½¿ç”¨ä¸Šé¢çš„ä¾‹å­ä»‹ç»ï¼Œ\nMETA-INF\\services\\java.spi.Developeræ–‡ä»¶ä¸­çš„å†…å®¹å°†ä¼šå˜ä¸ºkey=valueå½¢å¼ï¼š\n```java\njava=java.spi.JavaDeveloper\nperl=java.spi.PerlDeveloper\n```\nå…¶ä¸­ï¼Œkeyä¸ºæ‰©å±•åç§°ï¼Œvalueä¸ºæ‰©å±•å®ä¾‹ã€‚æ‰©å±•é…ç½®æ–‡ä»¶ä¿®æ”¹ä¸ºè¿™æ ·å­æ˜¯å› ä¸ºï¼Œå¦‚æœæ‰©å±•å®ç°ä¸­çš„æ–¹æ³•æˆ–è€…é™æ€å­—æ®µå¼•ç”¨äº†ç¬¬ä¸‰æ–¹åº“ï¼Œè€Œç¬¬ä¸‰æ–¹åº“ä¸å­˜åœ¨æ—¶ï¼Œé‚£ä¹ˆè¿™ä¸ªç±»å°†ä¼šåˆå§‹åŒ–å¤±è´¥ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœä½¿ç”¨ä»¥å‰çš„æ ¼å¼ï¼ŒDubboä¸å¯ä»¥å¼„æ¸…æ¥šæ‰©å±•çš„idï¼Œå› æ­¤ä¸å¯ä»¥æ˜ å°„è¿™ä¸ªæ‰©å±•çš„å¼‚å¸¸ä¿¡æ¯ã€‚\nä¾‹å¦‚ï¼š\næ— æ³•åŠ è½½æ‰©å±•(\"mina\"),å½“ç”¨æˆ·é…ç½®ä½¿ç”¨minaï¼ŒDubboå°†ä¼šæŠ±æ€¨æ— æ³•åŠ è½½æ‰©å±•ï¼Œè€Œä¸æ˜¯æŠ¥å‘Šæå–å“ªä¸€ä¸ªæ‰©å±•å®ç°å¤±è´¥åŠåŸå› ã€‚\n\nä¸Javaæ ‡å‡†SPIç›¸æ¯”ï¼ŒDubbo SPIåˆå¢åŠ äº†å¦‚ä¸‹åŠŸèƒ½ï¼š\n* Dubboå¯ä»¥é€šè¿‡getExtensionï¼ˆString keyï¼‰åªåŠ è½½æŸä¸€ä¸ªæƒ³è¦çš„æ‰©å±•ï¼ŒJavaçš„SPIæœºåˆ¶åˆ™éœ€è¦åŠ è½½å…¨éƒ¨çš„å®ç°ç±»ã€‚\n* å¯¹äºæ‰©å±•å®ç°IOCä¾èµ–æ³¨å…¥åŠŸèƒ½ï¼Œå¦‚æœæ‰©å±•å®ç°Aå«æœ‰setB()æ–¹æ³•ï¼Œè€Œæ¥å£Bæœ‰B1å’ŒB2ä¸¤ä¸ªå…·ä½“çš„å®ç°ï¼Œæ­¤æ—¶Dubboå¹¶ä¸ä¼šå…·ä½“æ³¨å…¥B1æˆ–è€…B2ï¼Œè€Œæ˜¯ä¼šæ³¨å…¥ä¸€ä¸ªè‡ªåŠ¨ç”Ÿæˆçš„æ¥å£Bå®ç°ï¼šB$Adpativeï¼Œè¯¥å®ç°è€…èƒ½å¤Ÿæ ¹æ®å‚æ•°çš„ä¸åŒï¼Œè‡ªåŠ¨å¼•ç”¨B1æˆ–è€…B2æ¥å®Œæˆç›¸åº”çš„åŠŸèƒ½ã€‚\n* å¯¹æ‰©å±•é‡‡ç”¨è£…é¥°å™¨æ¨¡å¼è¿›è¡ŒåŠŸèƒ½å¢å¼ºã€‚\n\n### Dubbo SPIç›¸å…³æ¥å£\n#### SPIæ¥å£\n```java\n@Documented\n@Retention(RetentionPolicy.RUNTIME)\n@Target({ElementType.TYPE})\npublic @interface SPI {\n    //é»˜è®¤æ‰©å±•åç§°\n    String value() default \"\";\n}\n```\nå½“æ¥å£ä¸Šè¡¨æ˜äº†@SPIæ³¨è§£æ—¶ï¼ŒDubboå°†ä¼šä¾æ¬¡ä»å¦‚ä¸‹ç›®å½•ä¸­è¯»å–ç›¸åº”çš„æ‰©å±•ç‚¹ï¼š\nMETA-INF/dubbo/internal/\nMETA-INF/dubbo/\nMETA-INF/services/\n\n#### Adaptiveæ¥å£\n```java\n@Documented\n@Retention(RetentionPolicy.RUNTIME)\n@Target({ElementType.TYPE, ElementType.METHOD})\npublic @interface Adaptive {\n    String[] value() default {};\n}\n```\nExtensionLoaderæ³¨å…¥ä¾èµ–æ‰©å±•å®ä¾‹æ—¶ï¼Œè¯¥æ¥å£ä¸ºå…¶æä¾›äº†æœ‰ç”¨çš„ä¿¡æ¯ã€‚\nvalueæ–¹æ³•å†³å®šè¦æ³¨å…¥å“ªä¸ªç›®æ ‡æ‰©å±•ã€‚ç›®æ ‡æ‰©å±•ç”±URLä¸­ä¼ é€’çš„å‚æ•°å†³å®šï¼Œvalueæ–¹æ³•æä¾›äº†urlä¸Šçš„å‚æ•°åç§°ã€‚å¦‚æœåœ¨URLä¸­æ²¡æœ‰æ‰¾åˆ°æŒ‡å®šçš„å‚æ•°åç§°ï¼Œåˆ™å°†ä½¿ç”¨é»˜è®¤çš„æ‰©å±•ï¼ˆåœ¨å…¶æ¥å£ä¸Šçš„@SPIæ³¨è§£ä¸­è¿›è¡ŒæŒ‡å®šï¼‰ã€‚\nä¾‹å¦‚,ç»™å®šå­—ç¬¦ä¸²ï¼švalue={\"key1\", \"key2\"}ï¼Œå¦‚æœåœ¨URLä¸­å‘ç°å‚æ•°key1ï¼Œåˆ™ä½¿ç”¨å‚æ•°key1çš„å€¼ä½œä¸ºæ‰©å±•åç§°ï¼Œå¦‚æœåœ¨URLä¸­æ²¡æœ‰å‘ç°å‚æ•°key1æˆ–è€…å‚æ•°key1çš„å€¼ä¸ºç©ºï¼Œåˆ™å°è¯•ä½¿ç”¨å‚æ•°key2çš„å€¼ä½œä¸ºæ‰©å±•åç§°ï¼Œå¦‚æœkey2ä¹Ÿä¸å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨é»˜è®¤çš„æ‰©å±•ï¼Œå¦åˆ™æŠ›å¼‚å¸¸ã€‚\nå¦‚æœé»˜è®¤çš„æ‰©å±•åç§°åœ¨@SPIæ³¨è§£ä¸­æ²¡æœ‰æä¾›ï¼Œåˆ™ä½¿ç”¨è§„åˆ™ç”Ÿæˆä¸€ä¸ªnameï¼Œè¿™ä¸ªnameå°†ç”¨ä½œURLä¸­çš„æœç´¢å‚æ•°ã€‚è§„åˆ™ä¸ºï¼šå°†æ¥å£ç±»åä»å¤§å†™å­—ç¬¦å¼€å§‹åˆ†æˆå‡ ä¸ªéƒ¨åˆ†, å¹¶å°†å„éƒ¨åˆ†ç”¨ç‚¹ \".\" åˆ†å¼€ã€‚\nä¾‹å¦‚ï¼šcom.alibaba.dubbo.xxx.YyyInvokerWrapperï¼Œåˆ™ç”Ÿæˆçš„nameä¸ºyyy.invoker.wrapperï¼Œå°†ä¼šä½¿ç”¨è¯¥nameä»urlä¸­è¿›è¡Œæœç´¢ã€‚\n\n#### Activateæ¥å£\n```java\n@Documented\n@Retention(RetentionPolicy.RUNTIME)\n@Target({ElementType.TYPE, ElementType.METHOD})\npublic @interface Activate {\n    /**\n     * å½“groupæ•°ç»„ä¸­æœ‰ä¸€ä¸ªgroupåŒ¹é…æ—¶ï¼Œå°±æ¿€æ´»å½“å‰æ‰©å±•ã€‚\n     * å°†ä½¿ç”¨ä¼ é€’ç»™ExtensionLoader#getActivateExtension(URL, String, String)æ–¹æ³•çš„group(ç¬¬ä¸‰ä¸ªå‚æ•°)æ¥å’Œè¯¥æ³¨è§£çš„groupè¿›è¡ŒåŒ¹é…\n     */\n    String[] group() default {};\n\n    /**\n     * å½“æŒ‡å®šçš„keyå‡ºç°åœ¨URLçš„å‚æ•°ä¸­æ—¶ï¼Œåˆ™æ¿€æ´»å½“å‰æ‰©å±• \n     * ä¾‹å¦‚ï¼šç»™å®š@Activate(\"cache, validation\")æ—¶ï¼Œåªæœ‰urlä¸­å‡ºç°cacheæˆ–è€…validationå‚æ•°æ—¶ï¼Œæ‰ä¼šæ¿€æ´»å½“å‰æ‰©å±•\n     */\n    String[] value() default {};\n    \n    //ç›¸å¯¹é¡ºåº æ‰©å±•åˆ—è¡¨ä¸­çš„å“ªäº›æ‰©å±•å°†è¦æ”¾åˆ°å½“å‰æ‰©å±•å‰é¢\n    String[] before() default {};\n\n    //ç›¸å¯¹é¡ºåº æ‰©å±•åˆ—è¡¨ä¸­çš„å“ªäº›æ‰©å±•å°†è¦æ”¾åˆ°å½“å‰æ‰©å±•åé¢\n    String[] after() default {};\n    \n    //ç»å¯¹é¡ºåº\n    int order() default 0;\n}\n```\nç”¨äºæ¿€æ´»æ‰©å±•ã€‚æ­¤æ³¨è§£å¯¹äºä½¿ç”¨ç»™å®šæ¡ä»¶è‡ªåŠ¨æ¿€æ´»æŸäº›æ‰©å±•æ˜¯éå¸¸æœ‰ç”¨çš„ï¼Œæ¯”å¦‚ï¼šå¦‚æœæœ‰å¤šä¸ªFilterå®ç°ï¼Œ@Activateå¯ä»¥ç”¨æ¥åŠ è½½æŸäº›Filterã€‚\nSPIæä¾›è€…å¯ä»¥è°ƒç”¨ExtensionLoader#getActivateExtension(URL, String, String)æ–¹æ³•æ‰¾åˆ°æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„activatedæ‰©å±•ã€‚\n\n#### ExtensionFactoryæ¥å£\n```\n@SPI\npublic interface ExtensionFactory {\n    /**\n     * è·å–æ‰©å±•å®ç°ç±»å®ä¾‹\n     * Get extension.\n     * @param type object type. æ‰©å±•æ¥å£ç±»å‹\n     * @param name object name. æ‰©å±•åç§°\n     * @return object instance. è¿”å›æ‰©å±•å®ä¾‹\n     */\n    <T> T getExtension(Class<T> type, String name);\n}\n```\nè¯¥æ¥å£æ ¹æ®æ‰©å±•ç±»å‹å’Œæ‰©å±•åç§°è·å–æ‰©å±•å®ä¾‹ã€‚å¯ä»¥çœ‹åˆ°è¯¥æ¥å£å£°æ˜ä¸Šä¹ŸåŠ ä¸Šäº†@SPIæ³¨è§£ï¼Œè¯´æ˜å­˜åœ¨å¤šç§å®ç°ï¼ŒDubboæä¾›äº†ä¸‰ç§å®ç°ï¼Œåˆ†åˆ«ä¸ºAdaptiveExtensionFactoryã€SpiExtensionFactoryã€SpringExtensionFactoryï¼Œåé¢ä¼šè¯¦ç»†ä»‹ç»å…·ä½“å®ç°ã€‚\n\n\n### ExtensionLoaderç±»\nExtensionLoaderç±»ç”¨æ¥å¤„ç†Dubboæ‰©å±•,é‡Œé¢å®šä¹‰äº†å¤§é‡çš„å®ç”¨æ–¹æ³•ï¼Œè¯¥ç±»æ”¯æŒä»¥ä¸‹ä¸»è¦åŠŸèƒ½ï¼š\n\n* è‡ªåŠ¨æ³¨å…¥ä¾èµ–æ‰©å±•\n* åœ¨wrapperä¸­ï¼Œè‡ªåŠ¨åŒ…è£…æ‰©å±•\n* é»˜è®¤æ‰©å±•æ˜¯ä¸€ä¸ªadaptiveå®ä¾‹\n\nExtensionLoaderç±»ä»£ç é‡æ¯”è¾ƒå¤šï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ExtensionLoaderç±»çš„getExtensionLoaderæ–¹æ³•ï¼Œé€šè¿‡è¯¥æ–¹æ³•å¯ä»¥å¾—åˆ°æŒ‡å®šæ‰©å±•ç±»å‹æ¥å£çš„æ‰©å±•åŠ è½½å™¨ï¼Œ\nä¾‹å¦‚æˆ‘ä»¬æƒ³è¦å¾—åˆ°ProxyFactoryç±»å‹çš„ExtensionLoaderï¼Œå¯ä»¥è¿™æ ·åšï¼š\n```java\nExtensionLoader<ProxyFactory> loader = ExtensionLoader.getExtensionLoader(ProxyFactory.class);\n```\n#### getExtensionLoaderæ–¹æ³•\næˆ‘ä»¬æ¥çœ‹getExtensionLoaderæ–¹æ³•:\n```java\n/**\n * è·å–æ‰©å±•ç±»å‹æ¥å£çš„æ‰©å±•åŠ è½½å™¨\n * 1ã€æ ¡éªŒæ‰©å±•ç±»å‹\n * 2ã€ä»ç¼“å­˜ä¸­è·å–æ‰©å±•ç±»å‹å¯¹åº”çš„æ‰©å±•åŠ è½½å™¨\n * 3ã€ç¼“å­˜ä¸­ä¸å­˜åœ¨ï¼Œåˆ™æ–°å»ºä¸€ä¸ªå¹¶æ”¾å…¥ç¼“å­˜\n */\npublic static <T> ExtensionLoader<T> getExtensionLoader(Class<T> type) {\n        //æ‰©å±•ç±»å‹ä¸å¯ä»¥ä¸ºç©º\n        if (type == null) {\n            throw new IllegalArgumentException(\"Extension type == null\");\n        }\n\t//æ‰©å±•ç±»å‹å¿…é¡»ä¸ºæ¥å£\n        if (!type.isInterface()) {\n            throw new IllegalArgumentException(\"Extension type(\" + type + \") is not interface!\");\n        }\n\t//æ£€æµ‹æ‰©å±•ç±»å‹æ¥å£æ˜¯å¦æ˜¯ä¸€ä¸ªæ‰©å±•ç‚¹ï¼Œåˆ¤æ–­ä¾æ®æ˜¯ï¼šæ¥å£å¿…é¡»æœ‰@SPIæ³¨è§£\n        if (!withExtensionAnnotation(type)) {\n            throw new IllegalArgumentException(\"Extension type(\" + type +\n                    \") is not extension, because WITHOUT @\" + SPI.class.getSimpleName() + \" Annotation!\");\n        }\n        //é¦–å…ˆä»ç¼“å­˜ä¸­è·å–è¯¥æ‰©å±•ç±»å‹çš„ExtensionLoader\n        ExtensionLoader<T> loader = (ExtensionLoader<T>) EXTENSION_LOADERS.get(type);\n        if (loader == null) {\n            //ç¼“å­˜ä¸­ä¸å­˜åœ¨ï¼Œåˆ™ä¸ºæ‰©å±•ç±»å‹typeæ–°å»ºä¸€ä¸ªExtensionLoaderï¼Œå¹¶æ”¾å…¥ç¼“å­˜\n            EXTENSION_LOADERS.putIfAbsent(type, new ExtensionLoader<T>(type));\n            loader = (ExtensionLoader<T>) EXTENSION_LOADERS.get(type);\n        }\n\t//è¿”å›æ‰©å±•ç±»å‹çš„ExtensionLoader\n        return loader;\n}\n\n/**\n * ç§æœ‰æ„é€ æ–¹æ³•\n */\nprivate ExtensionLoader(Class<?> type) {\n        //ä¿å­˜æ‰©å±•ç±»å‹æ¥å£\n        this.type = type;\n        //ExtensionFactoryæ¥å£çš„æ‰©å±•å®ç°ç±»ä¸éœ€è¦è¿›è¡Œæ³¨å…¥ä¾èµ–ï¼Œå› æ­¤è¿™é‡Œå°†objectFactoryè®¾ç½®æˆnull\n\t//å…¶ä»–æ‰©å±•æ¥å£å¯èƒ½ä¾èµ–å…¶ä»–æ‰©å±•æ¥å£ï¼Œå› æ­¤éœ€è¦è¿›è¡Œä¾èµ–æ³¨å…¥ï¼Œé€šè¿‡objectFactoryå¯ä»¥è·å–åˆ°æŸä¸ªæ‰©å±•ç±»å‹çš„æ‰©å±•å®ä¾‹\n        objectFactory = (type == ExtensionFactory.class ? null :\n                    ExtensionLoader.getExtensionLoader(ExtensionFactory.class).getAdaptiveExtension()\n        );\n}\n```\nå…¶ä¸­typeå’ŒobjectFactoryæ˜¯ExtensionLoaderç±»ä¸­å®šä¹‰çš„å®ä¾‹å˜é‡,EXTENSION_LOADERSç¼“å­˜æ˜¯é™æ€å¸¸é‡ï¼š\n```java\n/**\n * æ‰©å±•æ¥å£çš„ç±»å‹\n */\nprivate final Class<?> type;\n\n/**\n * æ‰©å±•å·¥å‚ï¼Œé€šè¿‡æ‰©å±•å·¥å‚å¯ä»¥è·å–åˆ°æŸä¸ªæ‰©å±•ç±»å‹çš„æ‰©å±•å®ä¾‹\n */\nprivate final ExtensionFactory objectFactory;\n\n/**\n * æ¯ä¸ªæ‰©å±•ç±»å‹æ¥å£(å³å¸¦æœ‰@SPIæ³¨è§£çš„æ¥å£)ï¼Œéƒ½æœ‰ä¸€ä¸ªç›¸å¯¹åº”çš„ExtensionLoaderå®ä¾‹\n * <æ‰©å±•ç±»å‹æ¥å£ï¼ŒExtensionLoaderå®ä¾‹>\n */\nprivate static final ConcurrentMap<Class<?>, ExtensionLoader<?>> EXTENSION_LOADERS =\n\t\tnew ConcurrentHashMap<Class<?>, ExtensionLoader<?>>();\n```\n#### getExtensionæ–¹æ³•\næœ‰äº†ExtensionLoaderå®ä¾‹åï¼Œå°±å¯ä»¥é€šè¿‡è¯¥å®ä¾‹çš„getExtension(String name)æ–¹æ³•åŠ è½½æ‰©å±•ç±»å‹çš„æŒ‡å®šå®ä¾‹ï¼š\n```java\n/**\n * é€šè¿‡æ‰©å±•åç§°nameè·å–æ‰©å±•å®ä¾‹\n */\npublic T getExtension(String name) {\n\t//æ‰©å±•åç§°ä¸å¯ä»¥ä¸ºç©º\n        if (name == null || name.length() == 0) {\n            throw new IllegalArgumentException(\"Extension name == null\");\n        }\n        if (\"true\".equals(name)) {\n            //name = true è¿”å›é»˜è®¤æ‰©å±•å®ä¾‹ï¼ˆåé¢ä¼šåˆ†æè¯¥æ–¹æ³•ï¼‰\n            return getDefaultExtension();\n        }\n\t//æ ¹æ®æ‰©å±•åç§°ä»cachedInstanceså®ä¾‹å˜é‡ä¸­è·å–æ‰©å±•å®ä¾‹\n\t//æ‰©å±•å®ä¾‹è¢«æ”¾å…¥åˆ°Holderå¯¹è±¡ä¸­ï¼ŒHolderç±»æ˜¯ä¸€ä¸ªæŒæœ‰å€¼çš„åŠ©æ‰‹ç±»ï¼Œæä¾›äº†get/setæ–¹æ³•\n        Holder<Object> holder = cachedInstances.get(name);\n        if (holder == null) {\n            //ç¼“å­˜ä¸­ä¸å­˜åœ¨çš„è¯ï¼Œåˆ™ä¸ºæ‰©å±•åç§°nameæ–°å»ºä¸€ä¸ªHolderå®ä¾‹ã€‚\n            cachedInstances.putIfAbsent(name, new Holder<Object>());\n            holder = cachedInstances.get(name);\n        }\n\t//ä»holderå¯¹è±¡ä¸­è·å–åˆ°æ‰©å±•åç§°nameå¯¹åº”çš„æ‰©å±•å®ä¾‹\n        Object instance = holder.get();\n        if (instance == null) {\n\t    //æ‰©å±•å®ä¾‹ä¸ºç©ºï¼Œåˆ™ä¸ºæ‰©å±•åç§°nameæ–°å»ºä¸€ä¸ªæ‰©å±•å®ä¾‹å¹¶æ”¾å…¥Holderå¯¹è±¡ä¸­ã€‚\n\t    //è¿™é‡Œå¯èƒ½ä¼šå­˜åœ¨å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ï¼Œå› æ­¤éœ€è¦åŒæ­¥åˆ›å»ºæ‰©å±•å®ä¾‹\n            synchronized (holder) {\n\t        //å†æ¬¡åˆ¤æ–­holderå¯¹è±¡ä¸­çš„æ‰©å±•å®ä¾‹æ˜¯å¦ä¸ºç©º\n                instance = holder.get();\n                if (instance == null) {\n                    //æ ¹æ®æ‰©å±•åç§°nameåˆ›å»ºæ‰©å±•å®ä¾‹ï¼ˆåé¢ä¼šåˆ†æè¯¥æ–¹æ³•ï¼‰\n                    instance = createExtension(name);\n\t\t    //æ”¾å…¥ç¼“å­˜\n                    holder.set(instance);\n                }\n            }\n        }\n\t//è¿”å›æ‰©å±•å®ä¾‹\n        return (T) instance;\n}\n```\nåœ¨çœ‹getDefaultExtensionæ–¹æ³•å’ŒcreateExtensionæ–¹æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸‹ä¸Šé¢getExtensionæ–¹æ³•ä¸­å‡ºç°çš„å˜é‡å®šä¹‰ï¼š\n```java\n/**\n * ç¼“å­˜ <æ‰©å±•åç§°ï¼Œæ‰©å±•å®ä¾‹>\n */\nprivate final ConcurrentMap<String, Holder<Object>> cachedInstances =\n    new ConcurrentHashMap<String, Holder<Object>>();\n\n/**\n * æŒæœ‰ä¸€ä¸ªå€¼çš„åŠ©æ‰‹ç±»\n */\npublic class Holder<T> {\n\n    private volatile T value;\n\n    public void set(T value) {\n        this.value = value;\n    }\n    public T get() {\n        return value;\n    }\n}\n```\n#### getDefaultExtensionæ–¹æ³•\næ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹getDefaultExtensionæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ç”¨æ¥è·å–é»˜è®¤æ‰©å±•å®ä¾‹ã€‚åœ¨è¯¥æ–¹æ³•å†…éƒ¨åˆè°ƒç”¨äº†å¤šä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬ä¸€æ­¥æ­¥æ¥åˆ†æï¼Œåˆ†æå®Œæ•´ä¸ªæµç¨‹åï¼Œæˆ‘ä»¬åœ¨çœ‹createExtensionæ–¹æ³•.\n```java\n/**\n * è¿”å›é»˜è®¤æ‰©å±•å®ä¾‹ï¼Œå¦‚æœæ²¡æœ‰é…ç½®é»˜è®¤æ‰©å±•åç§°(@SPIæ³¨è§£ä¸Šé…ç½®çš„)ï¼Œåˆ™è¿”å›null\n */\npublic T getDefaultExtension() {\n        //è·å–æ‰©å±•æ¥å£typeå¯¹åº”çš„æ‰©å±•å®ç°ç±»é›†åˆ(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\tgetExtensionClasses();\n\t//åˆ¤æ–­cachedDefaultNameå˜é‡æ˜¯å¦ä¸ºç©º\n\t//cachedDefaultNameå˜é‡æ˜¯åœ¨getExtensionClasses()æ–¹æ³•ä¸­è¿›è¡Œèµ‹å€¼çš„ï¼Œæˆ‘ä»¬ç¨åå»çœ‹\n\tif (null == cachedDefaultName || cachedDefaultName.length() == 0 || \"true\".equals(cachedDefaultName)) {\n\t\treturn null;\n\t}\n\t//è·å–é»˜è®¤æ‰©å±•åç§°å¯¹åº”çš„æ‰©å±•å®ä¾‹\n\treturn getExtension(cachedDefaultName);\n}\n```\n#### getExtensionClassesæ–¹æ³•(åŠ è½½æ‰©å±•å®ç°ç±»)\n```java\n/**\n * è·å–æ‰©å±•æ¥å£typeå¯¹åº”çš„æ‰©å±•å®ç°ç±»é›†åˆï¼Œå…ˆä»ç¼“å­˜è·å–ï¼Œç¼“å­˜æ²¡æœ‰çš„è¯ï¼Œå†å»é‡æ–°åŠ è½½\n * @return\n */\nprivate Map<String, Class<?>> getExtensionClasses() {\n\t//å…ˆä»cachedClassesç¼“å­˜ä¸­è·å–\n\tMap<String, Class<?>> classes = cachedClasses.get();\n\tif (classes == null) {\n\t\t//ç¼“å­˜ä¸­ä¸ºç©ºï¼ŒåŒæ­¥åŠ è½½\n\t\tsynchronized (cachedClasses) {\n\t\t\t//å†æ¬¡åˆ¤æ–­\n\t\t\tclasses = cachedClasses.get();\n\t\t\tif (classes == null) {\n\t\t\t\t//é‡æ–°åŠ è½½æ‰©å±•å®ç°ç±»ï¼ˆåé¢ä¼šåˆ†æè¯¥æ–¹æ³•ï¼‰\n\t\t\t\tclasses = loadExtensionClasses();\n\t\t\t\t//æ”¾å…¥ç¼“å­˜\n\t\t\t\tcachedClasses.set(classes);\n\t\t\t}\n\t\t}\n\t}\n\treturn classes;\n}\n\n/**\n * é»˜è®¤æ‰©å±•åç§°,@SPIæ³¨è§£ä¸Šé…ç½®çš„å€¼\n */\nprivate String cachedDefaultName;\n\n/**\n * ç”¨æ¥ç¼“å­˜æ‰©å±•æ¥å£typeå¯¹åº”çš„æ‰€æœ‰æ‰©å±•å®ç°ç±»\n * <æ‰©å±•åç§°ï¼Œæ‰©å±•å®ç°ç±»>\n */\nprivate final Holder<Map<String, Class<?>>> cachedClasses = new Holder<Map<String, Class<?>>>();\n\n\n/**\n * åŠ è½½æ‰©å±•æ¥å£typeå¯¹åº”çš„æ‰€æœ‰æ‰©å±•å®ç°ç±»\n * åœ¨getExtensionClassesä¸­ä¼šè¿›è¡ŒåŒæ­¥\n * synchronized in getExtensionClasses\n * @return\n */\nprivate Map<String, Class<?>> loadExtensionClasses() {\n\t//è·å–æ‰©å±•æ¥å£typeä¸Šçš„@SPIæ³¨è§£\n\tfinal SPI defaultAnnotation = type.getAnnotation(SPI.class);\n\tif (defaultAnnotation != null) {\n\t\t//å­˜åœ¨@SPIæ³¨è§£ï¼Œåˆ™è·å–æ³¨è§£å€¼(å³é»˜è®¤æ‰©å±•åç§°)\n\t\tString value = defaultAnnotation.value();\n\t\tif ((value = value.trim()).length() > 0) {\n\t\t\t//ä½¿ç”¨é€—å·åˆ†éš”æ‰©å±•åç§°\n\t\t\tString[] names = NAME_SEPARATOR.split(value);\n\t\t\tif (names.length > 1) {\n\t\t\t    //å­˜åœ¨å¤šä¸ªé»˜è®¤æ‰©å±•åç§°ï¼Œåˆ™æŠ›å¼‚å¸¸\n\t\t\t    throw new IllegalStateException(\"more than 1 default extension name on extension \" + type.getName()\n\t\t\t\t    + \": \" + Arrays.toString(names));\n\t\t\t}\n\t\t\tif (names.length == 1) {\n\t\t\t    //ä¿å­˜é»˜è®¤æ‰©å±•åç§°åˆ°cachedDefaultName\n\t\t\t    cachedDefaultName = names[0];\n\t\t\t}\n\t\t}\n\t}\n\t//å¼€å§‹åŠ è½½æ‰©å±•ç±»ï¼Œä¾æ¬¡ä»3ä¸ªç›®å½•è¿›è¡ŒåŠ è½½,ä¿å­˜åˆ°extensionClassesä¸­\n\tMap<String, Class<?>> extensionClasses = new HashMap<String, Class<?>>();\n\t//ç›®å½•çœ‹ä¸‹é¢çš„å¸¸é‡å®šä¹‰(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\tloadDirectory(extensionClasses, DUBBO_INTERNAL_DIRECTORY);\n\tloadDirectory(extensionClasses, DUBBO_DIRECTORY);\n\tloadDirectory(extensionClasses, SERVICES_DIRECTORY);\n\treturn extensionClasses;\n}\n\n/**\n * æ‰©å±•æ‰€åœ¨ç›®å½•\n */\nprivate static final String SERVICES_DIRECTORY = \"META-INF/services/\";\n\nprivate static final String DUBBO_DIRECTORY = \"META-INF/dubbo/\";\n\nprivate static final String DUBBO_INTERNAL_DIRECTORY = DUBBO_DIRECTORY + \"internal/\";\n\n/**\n * è·å–ExtensionLoaderçš„ç±»åŠ è½½å™¨\n * @return\n */\nprivate static ClassLoader findClassLoader() {\n\treturn ExtensionLoader.class.getClassLoader();\n}\n\n/**\n * æ‰«æç›¸åº”ç›®å½•ï¼ŒåŠ è½½æ‰©å±•å¹¶ä¿å­˜åˆ°extensionClassesé›†åˆ\n * @param extensionClasses ä¿å­˜æ‰©å±•ç±»çš„Mapé›†åˆ\n * @param dir  æ‰«æç›®å½•\n */\nprivate void loadDirectory(Map<String, Class<?>> extensionClasses, String dir) {\n\t//å¾…åŠ è½½çš„æ–‡ä»¶åï¼Œå¦‚ï¼šfileName = META-INF/dubbo/internal/com.alibaba.dubbo.rpc.ProxyFactory\n\tString fileName = dir + type.getName();\n\ttry {\n\t    Enumeration<java.net.URL> urls;\n\t    //è·å–ExtensionLoaderç±»åŠ è½½å™¨(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\t    ClassLoader classLoader = findClassLoader();\n\t    if (classLoader != null) {\n\t\t//å½“å‰ç±»åŠ è½½å™¨ä¸ä¸ºç©ºï¼ŒåŠ è½½è¯¥æ–‡ä»¶\n\t\turls = classLoader.getResources(fileName);\n\t    } else {\n\t\t//å½“å‰ç±»åŠ è½½å™¨ä¸ºç©ºï¼Œåˆ™ä»ç”¨æ¥åŠ è½½ç±»çš„æœç´¢è·¯å¾„ä¸­æŸ¥æ‰¾æ”¹æ–‡ä»¶\n\t\turls = ClassLoader.getSystemResources(fileName);\n\t    }\n\t    if (urls != null) {\n\t\twhile (urls.hasMoreElements()) {\n\t\t    //è·å–åˆ°èµ„æºå®šä½ç¬¦\n\t\t    java.net.URL resourceURL = urls.nextElement();\n\t\t    //åŠ è½½èµ„æº,å³è¯»å–å¹¶è§£æé…ç½®æ–‡ä»¶ï¼Œç„¶ååŠ è½½ç±»(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\t\t    loadResource(extensionClasses, classLoader, resourceURL);\n\t\t}\n\t    }\n\t} catch (Throwable t) {\n\t    logger.error(\"Exception when load extension class(interface: \" +\n\t\t    type + \", description file: \" + fileName + \").\", t);\n\t}\n}\n\n/**\n * è§£æé…ç½®æ–‡ä»¶ï¼Œç„¶ååŠ è½½æ‰©å±•ç±»\n * @param extensionClasses ä¿å­˜æ‰©å±•ç±»çš„é›†åˆ\n * @param classLoader  ç±»åŠ è½½å™¨\n * @param resourceURL  èµ„æºå®šä½ç¬¦\n */\nprivate void loadResource(Map<String, Class<?>> extensionClasses, ClassLoader classLoader, java.net.URL resourceURL) {\n\ttry {\n\t    BufferedReader reader = new BufferedReader(new InputStreamReader(resourceURL.openStream(), \"utf-8\"));\n\t    try {\n\t\tString line;\n\t\t//è¯»å–é…ç½®æ–‡ä»¶æ¯ä¸€è¡Œ\n\t\twhile ((line = reader.readLine()) != null) {\n\t\t    //åˆ¤æ–­å½“å‰è¡Œæ˜¯å¦åŒ…å«#å·ï¼Œ#å·åé¢çš„å†…å®¹éƒ½æ˜¯æ³¨é‡Šï¼Œéœ€è¦å»æ‰\n\t\t    final int ci = line.indexOf('#');\n\t\t    if (ci >= 0) {\n\t\t\t//æˆªå–#å·ä¹‹å‰çš„å†…å®¹ï¼Œå¹¶é‡æ–°è®¾ç½®line\n\t\t\tline = line.substring(0, ci);\n\t\t    }\n\t\t    line = line.trim();\n\t\t    if (line.length() > 0) {\n\t\t\ttry {\n\t\t\t    String name = null;\n\t\t\t    //å½“å‰è¡Œæ˜¯å¦åŒ…å«=å·\n\t\t\t    int i = line.indexOf('=');\n\t\t\t    if (i > 0) {\n\t\t\t\t//å½“å‰è¡Œå­˜åœ¨=å·ï¼Œåˆ™ä½¿ç”¨=å·åˆ†éš”lineï¼Œè·å–åˆ°key-value(line)\n\t\t\t\t//nameå°±æ˜¯keyï¼Œå³å®šä¹‰çš„æ‰©å±•åç§°\n\t\t\t\t//lineå°±æ˜¯valueï¼Œå³å®šä¹‰çš„æ‰©å±•å®ç°ç±»å…¨é™å®šå\n\t\t\t\tname = line.substring(0, i).trim();\n\t\t\t\tline = line.substring(i + 1).trim();\n\t\t\t    }\n\t\t\t    //å¦‚æœlineä¸ç­‰äºç©ºï¼Œåˆ™éœ€è¦åŠ è½½è¯¥æ‰©å±•å®ç°ç±»\n\t\t\t    if (line.length() > 0) {\n\t\t\t\t//åŠ è½½æ‰©å±•å®ç°ç±»(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\t\t\t\tloadClass(\n\t\t\t\t\textensionClasses,\n\t\t\t\t\tresourceURL,\n\t\t\t\t\t//åŠ è½½æ‰©å±•å®ç°ç±»\n\t\t\t\t\tClass.forName(line, true, classLoader),\n\t\t\t\t\tname\n\t\t\t\t);\n\t\t\t    }\n\t\t\t} catch (Throwable t) {\n\t\t\t    IllegalStateException e = new IllegalStateException(\"Failed to load extension class(interface: \" + type + \", class line: \" + line + \") in \" + resourceURL + \", cause: \" + t.getMessage(), t);\n\t\t\t    //è§£æè¡Œå‡ºé”™ï¼Œè®°å½•é”™è¯¯è¡Œåˆ°exceptionså®ä¾‹å˜é‡ä¸­\n\t\t\t    exceptions.put(line, e);\n\t\t\t}\n\t\t    }\n\t\t}\n\t    } finally {\n\t\treader.close();\n\t    }\n\t} catch (Throwable t) {\n\t    logger.error(\"Exception when load extension class(interface: \" +\n\t\t    type + \", class file: \" + resourceURL + \") in \" + resourceURL, t);\n\t}\n}\n\n/**\n * ä¿å­˜è§£æé…ç½®æ–‡ä»¶å‘ç”Ÿçš„å¼‚å¸¸ä¿¡æ¯\n * <å½“å‰key-valueè¡Œï¼Œå¼‚å¸¸ä¿¡æ¯>\n */\nprivate Map<String, IllegalStateException> exceptions = new ConcurrentHashMap<String, IllegalStateException>();\n\n/**\n * å½“å‰æ‰©å±•ç±»å‹æ¥å£typeå¯¹åº”çš„æ‰©å±•è‡ªé€‚åº”ç±»\n * å³å­˜åœ¨@Adaptiveæ³¨è§£çš„æ‰©å±•å®ç°ç±»\n * æ¯ä¸ªæ‰©å±•ç±»å‹æ¥å£typeåªèƒ½æœ‰ä¸€ä¸ªå®ç°ç±»æœ‰@Adaptiveæ³¨è§£ï¼Œå¦‚æœå¤šä¸ªæ‰©å±•å®ç°ç±»éƒ½æœ‰@Adaptiveï¼Œåˆ™ä¼šæŠ›å¼‚å¸¸\n */\nprivate volatile Class<?> cachedAdaptiveClass = null;\n\n/**\n * å¦‚æœæ‰©å±•å®ç°ç±»æ˜¯ä¸€ä¸ªåŒ…è£…ç±»ï¼Œ\n * åˆ™ä¼šå°†è¯¥è¯¥å®ç°ç±»æ·»åŠ åˆ°cachedWrapperClassesé›†åˆä¸­\n */\nprivate Set<Class<?>> cachedWrapperClasses;\n\n/**\n * æ‰©å±•åç§°æ­£åˆ™è¡¨è¾¾å¼ï¼Œå°†ä¼šä½¿ç”¨è¯¥æ­£åˆ™è¡¨è¾¾å¼åˆ‡å‰²æ‰©å±•åç§°nameï¼Œå³ä½¿ç”¨é€—å·åˆ†éš”\n */\nprivate static final Pattern NAME_SEPARATOR = Pattern.compile(\"\\\\s*[,]+\\\\s*\");\n\n/**\n * ç¼“å­˜<æ‰©å±•åç§°ï¼ŒActivateæ³¨è§£>\n * å¦‚æœæ˜¯é€—å·åˆ†éš”çš„å¤šä¸ªnameï¼Œåˆ™å–ç¬¬1ä¸ªæ‰©å±•åç§°name\n * Activateä¸ºå½“å‰æ‰©å±•å®ç°ç±»ä¸Šçš„@Activateæ³¨è§£\n */\nprivate final Map<String, Activate> cachedActivates = new ConcurrentHashMap<String, Activate>();\n\n/**\n * ç¼“å­˜<æ‰©å±•å®ç°ç±»ï¼Œæ‰©å±•åç§°>\n */\nprivate final ConcurrentMap<Class<?>, String> cachedNames = new ConcurrentHashMap<Class<?>, String>();\n\n\n/**\n * åŠ è½½æ‰©å±•å®ç°ç±»\n * @param extensionClasses ä¿å­˜æ‰©å±•å®ç°ç±»çš„map\n * @param resourceURL èµ„æºæ–‡ä»¶å®šä½ç¬¦\n * @param clazz æ‰©å±•å®ç°ç±»ï¼Œå³å®ç°äº†typeæ¥å£çš„ç±»\n * @param name  æ‰©å±•åç§°ï¼Œå³é…ç½®æ–‡ä»¶ä¸­çš„key\n * @throws NoSuchMethodException\n */\nprivate void loadClass(Map<String, Class<?>> extensionClasses,\n\t\t   java.net.URL resourceURL,\n\t\t   Class<?> clazz,\n\t\t   String name) throws NoSuchMethodException {\n\t//æ£€æµ‹å®ç°ç±»clazzæ˜¯å¦æ˜¯typeçš„å­ç±»å‹ï¼Œå³clazzæ˜¯å¦å®ç°äº†æ¥å£type\n\tif (!type.isAssignableFrom(clazz)) {\n\t    throw new IllegalStateException(\"Error when load extension class(interface: \" +\n\t\t    type + \", class line: \" + clazz.getName() + \"), class \"\n\t\t    + clazz.getName() + \"is not subtype of interface.\");\n\t}\n\t//æ£€æµ‹å®ç°ç±»clazzæ˜¯å¦æœ‰@Adaptiveæ³¨è§£\n\tif (clazz.isAnnotationPresent(Adaptive.class)) {\n\t    if (cachedAdaptiveClass == null) {\n\t        //cachedAdaptiveClasså˜é‡ä¸ºç©ºï¼Œåˆ™å°†cachedAdaptiveClassèµ‹å€¼ä¸ºclazz\n\t\tcachedAdaptiveClass = clazz;\n\t    } else if (!cachedAdaptiveClass.equals(clazz)) {\n\t        //cachedAdaptiveClasså˜é‡ä¸ä¸ºç©ºï¼Œåˆ™åˆ¤æ–­cachedAdaptiveClassæ˜¯å¦å’Œå½“å‰å®ç°ç±»classæ˜¯å¦æ˜¯åŒä¸€ä¸ª\n\t\t//å¦‚æœä¸æ˜¯åŒä¸€ä¸ªï¼Œåˆ™æŠ›å¼‚å¸¸ï¼šæ¯ä¸ªæ‰©å±•ç±»å‹typeä¸å¯ä»¥å­˜åœ¨å¤šä¸ªè‡ªé€‚åº”æ‰©å±•ç±»\n\t\tthrow new IllegalStateException(\"More than 1 adaptive class found: \"\n\t\t\t+ cachedAdaptiveClass.getClass().getName()\n\t\t\t+ \", \" + clazz.getClass().getName());\n\t    }\n\t} else if (isWrapperClass(clazz)) {\n\t    //å®ç°ç±»clazzæ˜¯åŒ…è£…ç±»(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\t    Set<Class<?>> wrappers = cachedWrapperClasses;\n\t    if (wrappers == null) {\n\t\tcachedWrapperClasses = new ConcurrentHashSet<Class<?>>();\n\t\twrappers = cachedWrapperClasses;\n\t    }\n\t    //å°†è¯¥æ‰©å±•å®ç°ç±»æ·»åŠ åˆ°åŒ…è£…ç±»é›†åˆä¸­\n\t    wrappers.add(clazz);\n\t} else {\n\t    //æ£€æµ‹è¯¥å®ç°ç±»æ˜¯å¦æœ‰é»˜è®¤æ„é€ æ–¹æ³•\n\t    clazz.getConstructor();\n\t    if (name == null || name.length() == 0) {\n\t\t//æ‰©å±•åç§°nameä¸ºç©ºæ—¶ï¼Œåˆ™æ ¹æ®è§„åˆ™é‡æ–°è®¾ç½®name(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\t\tname = findAnnotationName(clazz);\n\t\tif (name == null || name.length() == 0) {\n\t\t    //nameä»ç„¶ä¸ºç©º\n\t\t    if (clazz.getSimpleName().length() > type.getSimpleName().length()\n\t\t\t    && clazz.getSimpleName().endsWith(type.getSimpleName())) {\n\t\t\t//å¦‚æœå½“å‰æ‰©å±•å®ç°ç±»çš„ç±»åä»¥æ‰©å±•æ¥å£typeçš„åç§°ç»“å°¾ï¼Œåˆ™æˆªå–æ¥å£ç±»åç§°ä¹‹å‰çš„éƒ¨åˆ†ä½œä¸ºnameï¼Œå¹¶è½¬æ¢æˆå°å†™\n\t\t\t//ä¾‹å¦‚ï¼šå½“clazz = JavassistProxyFactoryï¼Œtype = ProxyFactoryæ—¶ï¼Œåˆ™name = javassist\n\t\t\tname = clazz.getSimpleName().substring(0, clazz.getSimpleName().length() - type.getSimpleName().length()).toLowerCase();\n\t\t    } else {\n\t\t\t//æ‰©å±•å®ç°ç±»classæ²¡æœ‰å¯¹åº”çš„æ‰©å±•åç§°ï¼ŒæŠ›å¼‚å¸¸\n\t\t\tthrow new IllegalStateException(\"No such extension name for the class \" + clazz.getName() + \" in the config \" + resourceURL);\n\t\t    }\n\t\t}\n\t    }\n\t    //ä½¿ç”¨é€—å·åˆ†éš”æ‰©å±•åç§°name\n\t    String[] names = NAME_SEPARATOR.split(name);\n\t    if (names != null && names.length > 0) {\n\t        //è·å–æ‰©å±•å®ç°ç±»ä¸Šçš„@Activateæ³¨è§£\n\t\tActivate activate = clazz.getAnnotation(Activate.class);\n\t\tif (activate != null) {\n\t\t    //å­˜åœ¨@Activateæ³¨è§£\n\t\t    //åˆ™å°†ç¬¬1ä¸ªæ‰©å±•åç§°å’Œ@Activateæ³¨è§£ç¼“å­˜èµ·æ¥\n\t\t    cachedActivates.put(names[0], activate);\n\t\t}\n\t\t//éå†æ‰©å±•åç§°\n\t\tfor (String n : names) {\n\t\t    if (!cachedNames.containsKey(clazz)) {\n\t\t\t//å¦‚æœ<æ‰©å±•å®ç°ç±»,name>ç¼“å­˜ä¸­ä¸åŒ…å«è¯¥æ‰©å±•å®ç°ç±»,åˆ™ä¿å­˜åˆ°ç¼“å­˜\n\t\t\tcachedNames.put(clazz, n);\n\t\t    }\n\t\t    //é€šè¿‡æ‰©å±•åç§°nä»æ‰©å±•å®ç°ç±»é›†åˆä¸­è·å–æ‰©å±•å®ç°ç±»c\n\t\t    Class<?> c = extensionClasses.get(n);\n\t\t    if (c == null) {\n\t\t\t//æ‰©å±•å®ç°ç±»cä¸å­˜åœ¨ï¼Œåˆ™ä¿å­˜<æ‰©å±•åç§°nï¼Œæ‰©å±•å®ç°ç±»clazz>åˆ°ç¼“å­˜\n\t\t\textensionClasses.put(n, clazz);\n\t\t    } else if (c != clazz) {\n\t\t\t//ä¸€ä¸ªæ‰©å±•åç§°å¯¹åº”å¤šä¸ªæ‰©å±•å®ç°ç±»ï¼Œåˆ™æŠ›å¼‚å¸¸\n\t\t\tthrow new IllegalStateException(\"Duplicate extension \" + type.getName() + \" name \" + n + \" on \" + c.getName() + \" and \" + clazz.getName());\n\t\t    }\n\t\t}\n\t    }\n\t}\n}\n\n/**\n * æ£€æµ‹æ‰©å±•å®ä¾‹ç±»clazzæ˜¯å¦æ˜¯åŒ…è£…ç±»ã€‚\n * åˆ¤æ–­ä¾æ®æ˜¯ï¼šæ‰©å±•å®ç°ç±»clazzä¸­æœ‰ä¸€ä¸ªæ¥æ”¶æ‰©å±•æ¥å£(typeæ¥å£)ä½œä¸ºå‚æ•°çš„æ„é€ æ–¹æ³•\n * @param clazz æ‰©å±•å®ç°ç±»\n * @return\n */\nprivate boolean isWrapperClass(Class<?> clazz) {\n\ttry {\n\t    clazz.getConstructor(type);\n\t    return true;\n\t} catch (NoSuchMethodException e) {\n\t    return false;\n\t}\n}\n```\nåŠ è½½æ‰©å±•ç±»å‹æ¥å£typeå¯¹åº”çš„æ‰©å±•å®ç°ç±»æµç¨‹åˆ°æ­¤å°±å…¨éƒ¨ç»“æŸäº†(å³ä¸Šæ–‡ä¸­ä»‹ç»çš„getExtensionClasses()æ–¹æ³•æµç¨‹)ã€‚\n\n#### createExtensionæ–¹æ³•(åˆ›å»ºæ‰©å±•å®ç°ç±»å®ä¾‹)\næˆ‘ä»¬å›åˆ°ä¸Šæ–‡ä¸­é—ç•™çš„createExtension(name)æ–¹æ³•ï¼Œçœ‹çœ‹æ˜¯å¦‚ä½•æ ¹æ®æ‰©å±•åç§°nameåˆ›å»ºæ‰©å±•å®ç°ç±»å®ä¾‹çš„ã€‚\n```java\n/**\n * æ ¹æ®æ‰©å±•åç§°nameåˆ›å»ºæ‰©å±•å®ç°ç±»å®ä¾‹\n * @param name æ‰©å±•åç§°\n * @return æ‰©å±•å®ç°ç±»å®ä¾‹\n */\n@SuppressWarnings(\"unchecked\")\nprivate T createExtension(String name) {\n\t//æ ¹æ®æ‰©å±•åç§°nameè·å–æ‰©å±•å®ç°ç±»clazz\n\t//getExtensionClasses()æ–¹æ³•æˆ‘ä»¬ä¸Šæ–‡å·²ç»ä»‹ç»è¿‡äº†ï¼Œæ‹¿åˆ°æ‰©å±•ç±»å‹æ¥å£typeå¯¹åº”çš„æ‰€æœ‰æ‰©å±•å®ç°ç±»\n\tClass<?> clazz = getExtensionClasses().get(name);\n\tif (clazz == null) {\n\t    //æ ¹æ®æ‰©å±•åç§°æ²¡æœ‰è·å–åˆ°æ‰©å±•å®ç°ç±»ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸\n\t    throw findException(name);\n\t}\n\ttry {\n\t    //å…ˆä»ç¼“å­˜ä¸­è·å–æ‰©å±•å®ç°ç±»çš„å®ä¾‹\n\t    T instance = (T) EXTENSION_INSTANCES.get(clazz);\n\t    if (instance == null) {\n\t        //å¦‚æœæ²¡æœ‰è·å–åˆ°å®ä¾‹ï¼Œåˆ™æ–°å»ºä¸€ä¸ªå®ç°ç±»clazzçš„å®ä¾‹å¹¶æ”¾å…¥ç¼“å­˜ã€‚\n\t\tEXTENSION_INSTANCES.putIfAbsent(clazz, clazz.newInstance());\n\t\tinstance = (T) EXTENSION_INSTANCES.get(clazz);\n\t    }\n\t    //å¤„ç†å®ç°ç±»å®ä¾‹çš„ä¾èµ–æ³¨å…¥(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\t    injectExtension(instance);\n\t    //å¤„ç†åŒ…è£…ç±»\n\t    Set<Class<?>> wrapperClasses = cachedWrapperClasses;\n\t    if (wrapperClasses != null && !wrapperClasses.isEmpty()) {\n\t        //å½“å‰æ‰©å±•æ¥å£typeå­˜åœ¨åŒ…è£…ç±»æ‰©å±•å®ç°ç±»\n\t\t//éå†åŒ…è£…ç±»åˆ—è¡¨\n\t\tfor (Class<?> wrapperClass : wrapperClasses) {\n\t\t    //é€šè¿‡å‚æ•°ä¸ºtypeæ¥å£çš„æ„é€ æ–¹æ³•åˆ›å»ºåŒ…è£…ç±»å®ä¾‹(å°†å½“å‰å®ä¾‹instanceä¼ é€’è¿›å»)ï¼Œç„¶åå¤„ç†åŒ…è£…ç±»çš„ä¾èµ–æ³¨å…¥\n\t\t    //è¿™é‡Œå¯èƒ½ä¼šæœ‰å¤šä¸ªåŒ…è£…ç±»ï¼Œä¾æ¬¡è¿›è¡ŒåŒ…è£…\n\t\t    instance = injectExtension((T) wrapperClass.getConstructor(type).newInstance(instance));\n\t\t}\n\t    }\n\t    //è¿”å›æ‰©å±•å®ä¾‹\n\t    return instance;\n\t} catch (Throwable t) {\n\t    throw new IllegalStateException(\"Extension instance(name: \" + name + \", class: \" +\n\t\t    type + \")  could not be instantiated: \" + t.getMessage(), t);\n\t}\n}\n\n/**\n * å¤„ç†æ‰©å±•å®ç°ç±»å®ä¾‹instanceçš„ä¾èµ–é¡¹ï¼Œè¿›è¡Œä¾èµ–æ³¨å…¥\n * é€šè¿‡setæ–¹æ³•æ³¨å…¥ä¾èµ–é¡¹\n * @param instance æ‰©å±•å®ç°ç±»çš„å®ä¾‹\n * @return\n */\nprivate T injectExtension(T instance) {\n\ttry {\n\t    //åˆ¤æ–­åŠ è½½å™¨æ˜¯å¦ä¸ºç©º\n\t    if (objectFactory != null) {\n\t        //éå†å®ç°ç±»ä¸­çš„æ–¹æ³•\n\t\tfor (Method method : instance.getClass().getMethods()) {\n\t\t    //æ‰¾åˆ°å‚æ•°é•¿åº¦ä¸º1ã€publicä¿®é¥°ç¬¦çš„setæ–¹æ³•\n\t\t    if (method.getName().startsWith(\"set\")\n\t\t\t    && method.getParameterTypes().length == 1\n\t\t\t    && Modifier.isPublic(method.getModifiers())) {\n\t\t\t//è·å–setæ–¹æ³•çš„å‚æ•°ç±»å‹\n\t\t\tClass<?> pt = method.getParameterTypes()[0];\n\t\t\ttry {\n\t\t\t    //æˆªå–setæ–¹æ³•çš„æ–¹æ³•åï¼Œå»æ‰\"set\"å­—ç¬¦ï¼Œå¹¶å°†ä½™ä¸‹çš„å­—ç¬¦è½¬æ¢æˆå°å†™å­—æ¯ï¼Œä½œä¸ºå±æ€§\n\t\t\t    String property = method.getName().length() > 3 ? method.getName().substring(3, 4).toLowerCase() + method.getName().substring(4) : \"\";\n\t\t\t    //ä»æ‰©å±•å·¥å‚ä¸­æ‰¾åˆ°è¯¥ä¾èµ–é¡¹å®ä¾‹(ptä¸ºä¾èµ–é¡¹çš„ç±»å‹ï¼Œpropertyä¸ºä¾èµ–é¡¹çš„åç§°)\n\t\t\t    Object object = objectFactory.getExtension(pt, property);\n\t\t\t    if (object != null) {\n\t\t\t\t//ä¾èµ–é¡¹å®ä¾‹å­˜åœ¨çš„è¯ï¼Œé€šè¿‡è¯¥setæ–¹æ³•åˆ™å°†è¯¥ä¾èµ–é¡¹å®ä¾‹æ³¨å…¥åˆ°æ‰©å±•å®ç°ç±»å®ä¾‹instanceä¸­\n\t\t\t\tmethod.invoke(instance, object);\n\t\t\t    }\n\t\t\t} catch (Exception e) {\n\t\t\t    logger.error(\"fail to inject via method \" + method.getName()\n\t\t\t\t    + \" of interface \" + type.getName() + \": \" + e.getMessage(), e);\n\t\t\t}\n\t\t    }\n\t\t}\n\t    }\n\t} catch (Exception e) {\n\t    logger.error(e.getMessage(), e);\n\t}\n\t//è¿”å›æ‰©å±•å®ç°ç±»çš„å®ä¾‹\n\treturn instance;\n}\n```\nä»¥ä¸Šä¾¿æ˜¯è·å–æ‰©å±•å®ä¾‹çš„è¿‡ç¨‹ï¼Œæœ€ç»ˆä¼šå°†æ‰©å±•å®ä¾‹æ”¾å…¥åˆ°ç¼“å­˜å˜é‡cachedInstancesä¸­,å³<æ‰©å±•åç§°ï¼Œæ‰©å±•å®ä¾‹>ã€‚\n\n#### getActivateExtensionæ–¹æ³•\næ¥ä¸‹æ¥æˆ‘ä»¬åœ¨çœ‹ä¸‹ExtensionLoaderç±»ä¸­çš„getActivateExtensionæ–¹æ³•ï¼Œé€šè¿‡è¯¥æ–¹æ³•å¯ä»¥å¾—åˆ°å·²å¯ç”¨çš„æ‰©å±•åˆ—è¡¨\n```java\n/**\n * keyä¸ºurlä¸­æ ‡è¯†æ‰©å±•åç§°çš„å‚æ•°\n */\npublic List<T> getActivateExtension(URL url, String key) {\n\t//è°ƒç”¨äº†ä¸‹é¢çš„é‡è½½æ–¹æ³•\n\treturn getActivateExtension(url, key, null);\n}\n\npublic List<T> getActivateExtension(URL url, String key, String group) {\n\t//ä»urlä¸­è·å–å‚æ•°keyå¯¹åº”çš„å€¼(å³è·å–æ‰©å±•åç§°)\n\tString value = url.getParameter(key);\n\t//è°ƒç”¨äº†ä¸‹é¢çš„é‡è½½æ–¹æ³•\n\treturn getActivateExtension(\n\t\turl, \n\t\tvalue == null || value.length() == 0 ? null : Constants.COMMA_SPLIT_PATTERN.split(value), \n\t\tgroup\n\t);\n}\n\n/**\n * è·å–å·²å¯ç”¨çš„æ‰©å±•åˆ—è¡¨\n * url \n * valuesä¸ºæ‰©å±•åç§°åˆ—è¡¨\n * groupä¸ºé…ç½®çš„ç»„\n */\npublic List<T> getActivateExtension(URL url, String[] values, String group) {\n\tList<T> exts = new ArrayList<T>();\n\t//æ‰©å±•åç§°æ•°ç»„\n\tList<String> names = values == null ? new ArrayList<String>(0) : Arrays.asList(values);\n\t//namesæ˜¯å¦åŒ…å«-default\n\tif (!names.contains(Constants.REMOVE_VALUE_PREFIX + Constants.DEFAULT_KEY)) {\n\t    //å…ˆè·å–ä¸‹æ‰©å±•æ¥å£typeçš„æ‰©å±•å®ç°ç±»é›†åˆ(ä¸Šæ–‡ä»‹ç»è¿‡è¯¥æ–¹æ³•)\n\t    //æ‰§è¡ŒgetExtensionClassesæ–¹æ³•æ—¶ï¼Œä¼šå°†å­˜åœ¨@Activateæ³¨è§£çš„å®ç°ç±»ç¼“å­˜èµ·æ¥ï¼š<æ‰©å±•åç§°ï¼ŒActivateæ³¨è§£>\n\t    getExtensionClasses();\n\t    //éå†cachedActivatesé›†åˆ\n\t    for (Map.Entry<String, Activate> entry : cachedActivates.entrySet()) {\n\t\t//æ‰©å±•åç§°\n\t\tString name = entry.getKey();\n\t\t//@Activateæ³¨è§£\n\t\tActivate activate = entry.getValue();\n\t\t//groupæ˜¯å¦åŒ¹é…(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\t\tif (isMatchGroup(group, activate.group())) {\n\t\t    //æ ¹æ®æ‰©å±•åç§°nameè·å–æ‰©å±•å®ä¾‹\n\t\t    T ext = getExtension(name);\n\t\t    if (!names.contains(name)\n\t\t\t    && !names.contains(Constants.REMOVE_VALUE_PREFIX + name)\n\t\t\t    && isActive(activate, url)) {\n\t\t\t//å½“æ‰©å±•åç§°æ•°ç»„ä¸åŒ…å«è¯¥æ‰©å±•ånameï¼Œå¹¶ä¸”ä¸åŒ…å«-nameï¼Œå¹¶ä¸”å·²æ¿€æ´»æ—¶ï¼Œ\n\t\t\t//å°†å½“å‰æ‰©å±•å®ä¾‹æ·»åŠ åˆ°è¿”å›ç»“æœé›†ä¸­\n\t\t\texts.add(ext);\n\t\t    }\n\t\t}\n\t    }\n\t    //æŒ‰ç…§é…ç½®çš„before()å’Œafter()/order()è¿›è¡Œæ’åº\n\t    Collections.sort(exts, ActivateComparator.COMPARATOR);\n\t}\n\tList<T> usrs = new ArrayList<T>();\n\tfor (int i = 0; i < names.size(); i++) {\n\t    //å½“å‰æ‰©å±•åç§°name\n\t    String name = names.get(i);\n\t    if (!name.startsWith(Constants.REMOVE_VALUE_PREFIX)\n\t\t    //å½“å‰æ‰©å±•åç§°nameä¸æ˜¯ä»¥-å¼€å¤´ï¼Œå¹¶ä¸”æ‰©å±•åç§°æ•°ç»„namesä¸åŒ…å«-nameæ—¶ï¼Œ\n\t\t    && !names.contains(Constants.REMOVE_VALUE_PREFIX + name)) {\n\t\tif (Constants.DEFAULT_KEY.equals(name)) {\n\t\t    //å½“å‰æ‰©å±•åç§°name=default\n\t\t    if (!usrs.isEmpty()) {\n\t\t        //usrsä¸ä¸ºç©ºï¼Œå°†usrsé›†åˆæ·»åŠ åˆ°extså¤´éƒ¨\n\t\t\texts.addAll(0, usrs);\n\t\t\t//æ¸…ç©ºusrs\n\t\t\tusrs.clear();\n\t\t    }\n\t\t} else {\n\t\t    //å½“å‰æ‰©å±•åç§°name != defaultæ—¶ï¼Œè·å–è¯¥nameçš„æ‰©å±•å®ä¾‹ï¼Œå¹¶å­˜èµ·æ¥\n\t\t    T ext = getExtension(name);\n\t\t    usrs.add(ext);\n\t\t}\n\t    }\n\t}\n\tif (!usrs.isEmpty()) {\n\t    exts.addAll(usrs);\n\t}\n\treturn exts;\n}\n\n/**\n * groupæ˜¯å¦åŒ¹é…\n * 1ã€groupä¸ºç©ºï¼Œåˆ™åŒ¹é…\n * 2ã€groupåœ¨groupsä¸­å­˜åœ¨ï¼Œåˆ™åŒ¹é…\n * @param group\n * @param groups @Activateä¸­é…ç½®çš„groupæ•°ç»„\n * @return\n */\nprivate boolean isMatchGroup(String group, String[] groups) {\n\tif (group == null || group.length() == 0) {\n\t    return true;\n\t}\n\tif (groups != null && groups.length > 0) {\n\t    for (String g : groups) {\n\t\tif (group.equals(g)) {\n\t\t    return true;\n\t\t}\n\t    }\n\t}\n\treturn false;\n}\n/**\n * æ˜¯å¦å·²æ¿€æ´»\n * 1ã€@activateæ²¡æœ‰é…ç½®value()\n * 2ã€@Activateä¸­é…ç½®çš„value()åœ¨urlçš„å‚æ•°åˆ—è¡¨ä¸­å­˜åœ¨,ä¸”urlå‚æ•°å¯¹åº”çš„valueä¸ä¸ºç©º\n * @param activate\n * @param url\n * @return\n */\nprivate boolean isActive(Activate activate, URL url) {\n        //è·å–@Activateæ³¨è§£ä¸­é…ç½®çš„keys\n\tString[] keys = activate.value();\n\tif (keys.length == 0) {\n\t    return true;\n\t}\n\tfor (String key : keys) {\n\t    for (Map.Entry<String, String> entry : url.getParameters().entrySet()) {\n\t\tString k = entry.getKey();\n\t\tString v = entry.getValue();\n\t\tif ((k.equals(key) || k.endsWith(\".\" + key))\n\t\t\t&& ConfigUtils.isNotEmpty(v)) {\n\t\t    return true;\n\t\t}\n\t    }\n\t}\n\treturn false;\n}\n```\n\n#### getAdaptiveExtensionæ–¹æ³•\næ¥ä¸‹æ¥çœ‹ä¸‹getAdaptiveExtensionæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ç”¨æ¥è·å–æ‰©å±•æ¥å£typeå¯¹åº”çš„è‡ªé€‚åº”æ‰©å±•å®ä¾‹ã€‚\n```java\n\n/**\n * ç¼“å­˜çš„è‡ªé€‚åº”å®ä¾‹\n */\nprivate final Holder<Object> cachedAdaptiveInstance = new Holder<Object>();\n\n/**\n * è®°å½•åˆ›å»ºè‡ªé€‚åº”æ‰©å±•å®ä¾‹æ—¶å‘ç”Ÿçš„å¼‚å¸¸\n */\nprivate volatile Throwable createAdaptiveInstanceError;\n\n\n/**\n * è·å–æ‰©å±•æ¥å£typeçš„è‡ªé€‚åº”æ‰©å±•å®ä¾‹\n */\npublic T getAdaptiveExtension() {\n\t//å…ˆä»ç¼“å­˜ä¸­è·å–\n\tObject instance = cachedAdaptiveInstance.get();\n\tif (instance == null) {\n\t    //ç¼“å­˜ä¸­ä¸å­˜åœ¨\n\t    //åˆ¤æ–­createAdaptiveInstanceErrorå˜é‡æ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©ºè¯´æ˜ä¹‹å‰åˆ›å»ºè‡ªé€‚åº”å®ä¾‹æ—¶å‘ç”Ÿäº†å¼‚å¸¸\n\t    if (createAdaptiveInstanceError == null) {\n\t        //æ²¡æœ‰å‘ç”Ÿå¼‚å¸¸ï¼ŒåŒæ­¥åˆ›å»ºè‡ªé€‚åº”æ‰©å±•å®ä¾‹\n\t\tsynchronized (cachedAdaptiveInstance) {\n\t\t    //å†æ¬¡éªŒè¯ç¼“å­˜ä¸­æ˜¯å¦å­˜åœ¨è¯¥å®ä¾‹\n\t\t    instance = cachedAdaptiveInstance.get();\n\t\t    if (instance == null) {\n\t\t\ttry {\n\t\t\t    //åˆ›å»ºè‡ªé€‚åº”æ‰©å±•å®ä¾‹(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\t\t\t    instance = createAdaptiveExtension();\n\t\t\t    //å°†åˆ›å»ºå¥½çš„å®ä¾‹ä¿å­˜è¿›ç¼“å­˜\n\t\t\t    cachedAdaptiveInstance.set(instance);\n\t\t\t} catch (Throwable t) {\n\t\t\t    //åˆ›å»ºå®ä¾‹æ—¶å‘ç”Ÿå¼‚å¸¸ï¼Œè®°å½•å¼‚å¸¸\n\t\t\t    createAdaptiveInstanceError = t;\n\t\t\t    throw new IllegalStateException(\"fail to create adaptive instance: \" + t.toString(), t);\n\t\t\t}\n\t\t    }\n\t\t}\n\t    } else {\n\t\tthrow new IllegalStateException(\"fail to create adaptive instance: \" + createAdaptiveInstanceError.toString(), createAdaptiveInstanceError);\n\t    }\n\t}\n\treturn (T) instance;\n}\n\n/**\n * ä¸ºæ‰©å±•æ¥å£typeåˆ›å»ºè‡ªé€‚åº”æ‰©å±•å®ä¾‹ï¼Œå¹¶å¤„ç†ä¾èµ–æ³¨å…¥\n * @return\n */\nprivate T createAdaptiveExtension() {\n\ttry {\n\t    //åœ¨è¿™é‡Œè°ƒç”¨äº†getAdaptiveExtensionClassæ–¹æ³•è·å–åˆ°è‡ªé€‚åº”æ‰©å±•ç±»ï¼Œç„¶åç”Ÿæˆå®ä¾‹\n\t    return injectExtension((T) getAdaptiveExtensionClass().newInstance());\n\t} catch (Exception e) {\n\t    throw new IllegalStateException(\"Can not create adaptive extension \" + type + \", cause: \" + e.getMessage(), e);\n\t}\n}\n\n/**\n * è·å–æ‰©å±•æ¥å£typeçš„è‡ªé€‚åº”æ‰©å±•ç±»\n * @return\n */\nprivate Class<?> getAdaptiveExtensionClass() {\n        //åŠ è½½æ‰©å±•æ¥å£typeå¯¹åº”çš„æ‰€æœ‰æ‰©å±•å®ç°ç±»(ä¸Šæ–‡ä»‹ç»è¿‡è¯¥æ–¹æ³•)\n\tgetExtensionClasses();\n\t//æŸ¥çœ‹ç¼“å­˜ä¸­æ˜¯å¦å·²ç»å­˜åœ¨æ‰©å±•æ¥å£typeå¯¹åº”çš„è‡ªé€‚åº”æ‰©å±•ç±»ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›(è°ƒç”¨getExtensionClassesæ–¹æ³•æ—¶ï¼Œä¼šå»è®¾ç½®cachedAdaptiveClasså€¼)\n\tif (cachedAdaptiveClass != null) {\n\t    return cachedAdaptiveClass;\n\t}\n\t//ä¸å­˜åœ¨çš„è¯ï¼Œä¸ºè¯¥æ‰©å±•æ¥å£typeåˆ›å»ºä¸€ä¸ªè‡ªé€‚åº”æ‰©å±•ç±»(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\treturn cachedAdaptiveClass = createAdaptiveExtensionClass();\n}\n\n/**\n * æ‰©å±•æ¥å£typeä¸å­˜åœ¨è‡ªé€‚åº”æ‰©å±•ç±»çš„æ—¶å€™ï¼Œdubboé»˜è®¤ä¼šä¸ºå…¶åˆ›å»º\n * åˆ›å»ºæ¡ä»¶ï¼štypeæ¥å£çš„æ–¹æ³•ä¸­å¿…é¡»æœ‰ä¸€ä¸ªå¸¦@Adaptiveæ³¨è§£çš„æ–¹æ³•dubboæ‰ä¼šåˆ›å»ºè‡ªé€‚åº”æ‰©å±•ç±»\n * @return\n */\nprivate Class<?> createAdaptiveExtensionClass() {\n\t//ç”Ÿæˆè‡ªé€‚åº”æ‰©å±•å®ç°ç±»çš„ä»£ç (åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\tString code = createAdaptiveExtensionClassCode();\n\t//è·å–ç±»åŠ è½½å™¨\n\tClassLoader classLoader = findClassLoader();\n\t//è·å–Compilerè‡ªé€‚åº”æ‰©å±•å®ä¾‹\n\tcom.alibaba.dubbo.common.compiler.Compiler compiler =\n\t\tExtensionLoader.getExtensionLoader(com.alibaba.dubbo.common.compiler.Compiler.class)\n\t\t\t.getAdaptiveExtension();\n\t//ç¼–è¯‘code(åé¢ä¼šåˆ†æè¯¥æ–¹æ³•)\n\treturn compiler.compile(code, classLoader);\n}\n```\n\næ¥ä¸‹æ¥çš„createAdaptiveExtensionClassCodeæ–¹æ³•æ¯”è¾ƒé•¿ï¼Œåœ¨åˆ†æä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ProxyFactoryæ¥å£ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨è¯¥æ¥å£ä½œä¸ºä¾‹å­(å³å‡è®¾å½“å‰æ‰©å±•æ¥å£typeä¸ºProxyFactory),é…åˆç€è¯¥æ–¹æ³•ä¸€èµ·çœ‹ï¼š\n```java\n@SPI(\"javassist\")\npublic interface ProxyFactory {\n    \n    //@Adaptive({\"proxy\"})\n    @Adaptive({Constants.PROXY_KEY})\n    <T> T getProxy(Invoker<T> invoker) throws RpcException;\n   \n    @Adaptive({Constants.PROXY_KEY})\n    <T> Invoker<T> getInvoker(T proxy, Class<T> type, URL url) throws RpcException;\n```\nå¯ä»¥çœ‹åˆ°è¯¥æ¥å£ä¸Šæ·»åŠ äº†@SPI(\"javassist\")æ³¨è§£ã€æ¥å£æ–¹æ³•ä¸Šæ·»åŠ äº†@Adaptive({Constants.PROXY_KEY})\n\n```java\n/**\n* ä¸ºæ‰©å±•æ¥å£typeç”Ÿæˆè‡ªé€‚åº”æ‰©å±•ç±»çš„ç±»ä»£ç \n* å‡è®¾ type = com.alibaba.dubbo.rpc.ProxyFactory\n* @return\n*/\nprivate String createAdaptiveExtensionClassCode() {\n\tStringBuilder codeBuilder = new StringBuilder();\n\t//è·å–æ‰©å±•æ¥å£typeçš„æ–¹æ³•åˆ—è¡¨ï¼ŒæŸ¥çœ‹æ–¹æ³•ä¸Šæ˜¯å¦å­˜åœ¨@Adaptiveæ³¨è§£ï¼Œ\n\t//å¦‚æœä¸å­˜åœ¨@Adaptiveæ³¨è§£ï¼Œåˆ™ä¸ç”¨ç”Ÿæˆè‡ªé€‚åº”æ‰©å±•ç±»\n\tMethod[] methods = type.getMethods();\n\tboolean hasAdaptiveAnnotation = false;\n\tfor (Method m : methods) {\n\t    if (m.isAnnotationPresent(Adaptive.class)) {\n\t\thasAdaptiveAnnotation = true;\n\t\tbreak;\n\t    }\n\t}\n\t// ä¸å­˜åœ¨å¸¦æœ‰@Adaptiveæ³¨è§£çš„æ–¹æ³•ï¼Œå› æ­¤ä¸éœ€è¦ç”Ÿæˆè‡ªé€‚åº”æ‰©å±•ç±»\n\tif (!hasAdaptiveAnnotation) {\n\t    throw new IllegalStateException(\"No adaptive method on extension \" + type.getName() + \", refuse to create the adaptive class!\");\n\t}\n\t//æ·»åŠ åŒ…å£°æ˜ï¼štypeæ‰©å±•æ¥å£æ‰€åœ¨åŒ…åŒ…å\n\t//package com.alibaba.dubbo.rpc;\n\tcodeBuilder.append(\"package \").append(type.getPackage().getName()).append(\";\");\n\n\t//import com.alibaba.dubbo.common.extension.ExtensionLoader;\n\tcodeBuilder.append(\"\\nimport \").append(ExtensionLoader.class.getName()).append(\";\");\n\t\n\t//å¯ä»¥çœ‹åˆ°ç”Ÿæˆçš„å®ç°ç±»åç§°ä¸ºProxyFactory$Adaptiveï¼Œå®ç°äº†ProxyFactoryæ¥å£\n\t//public class com.alibaba.dubbo.rpc.ProxyFactory$Adaptive implements com.alibaba.dubbo.rpc.ProxyFactory{\n\tcodeBuilder.append(\"\\npublic class \")\n\t\t.append(type.getSimpleName())\n\t\t.append(\"$Adaptive\")\n\t\t.append(\" implements \")\n\t\t.append(type.getCanonicalName()).append(\" {\");\n\n\t//éå†typeæ¥å£çš„æ–¹æ³•\n\tfor (Method method : methods) {\n\t    //æ¥å£æ–¹æ³•è¿”å›ç±»å‹\n\t    Class<?> rt = method.getReturnType();\n\t    //æ¥å£æ–¹æ³•å‚æ•°ç±»å‹æ•°ç»„\n\t    Class<?>[] pts = method.getParameterTypes();\n\t    //æ¥å£æ–¹æ³•å¼‚å¸¸ç±»å‹æ•°ç»„\n\t    Class<?>[] ets = method.getExceptionTypes();\n\t   \n\t    //åˆ¤æ–­å½“å‰æ–¹æ³•ä¸Šæ˜¯å¦å­˜åœ¨@Adaptiveæ³¨è§£\n\t    Adaptive adaptiveAnnotation = method.getAnnotation(Adaptive.class);\n            //æ–¹æ³•å†…å®¹\n\t    StringBuilder code = new StringBuilder(512);\n\t    if (adaptiveAnnotation == null) {\n\t\t//æ·»åŠ å¼‚å¸¸ï¼štypeæ¥å£çš„å½“å‰æ–¹æ³•ä¸æ˜¯ä¸€ä¸ªadaptiveæ–¹æ³•\n\t\tcode.append(\"throw new UnsupportedOperationException(\\\"method \")\n\t\t\t.append(method.toString()).append(\" of interface \")\n\t\t\t.append(type.getName()).append(\" is not adaptive method!\\\");\");\n\t    } else {\n\t\t//è·å–åˆ°çš„å½“å‰æ–¹æ³•çš„\"URLç±»å‹å‚æ•°/è¿”å›URLç±»å‹çš„getæ–¹æ³•çš„å‚æ•°\"çš„ä¸‹æ ‡ï¼ˆåœ¨å½“å‰æ–¹æ³•å‚æ•°ä¸­çš„ä¸‹æ ‡ï¼‰\n\t\tint urlTypeIndex = -1;\n\t\t//éå†å½“å‰æ–¹æ³•å‚æ•°\n\t\tfor (int i = 0; i < pts.length; ++i) {\n\t\t    if (pts[i].equals(URL.class)) {\n\t\t        //ç¬¬iä¸ªä¸‹æ ‡æ˜¯URLç±»å‹çš„å‚æ•°\n\t\t\turlTypeIndex = i;\n\t\t\tbreak;\n\t\t    }\n\t\t}\n\t\tif (urlTypeIndex != -1) {\n\t\t    //ä»å½“å‰æ–¹æ³•å‚æ•°ä¸­æ‰¾åˆ°äº†URLç±»å‹çš„å‚æ•°\n\t\t    //æ·»åŠ \"æ ¡éªŒUrlç±»å‹å‚æ•°æ˜¯å¦ä¸ºç©º\"çš„code\n\t\t    String s = String.format(\"\\nif (arg%d == null) throw new IllegalArgumentException(\\\"url == null\\\");\",\n\t\t\t    urlTypeIndex);\n\t\t    code.append(s);\n\t\t    \n\t\t    //æ·»åŠ \"å£°æ˜urlç±»å‹çš„å˜é‡\"çš„code\n\t\t    //URL url = arg{$urlTypeIndex}\n\t\t    s = String.format(\"\\n%s url = arg%d;\", URL.class.getName(), urlTypeIndex);\n\t\t    code.append(s);\n\t\t}else {\n\t\t    //ä»å½“å‰æ–¹æ³•å‚æ•°ä¸­æ²¡æœ‰æ‰¾åˆ°URLç±»å‹çš„å‚æ•°\n\t\t    //è¿”å›URLç±»å‹çš„getæ–¹æ³•çš„åç§°\n\t\t    String attribMethod = null;\n\n\t\t    //éå†å‚æ•°åˆ—è¡¨ï¼ŒæŸ¥è¯¢æ¯ä¸ªå‚æ•°çš„æ–¹æ³•åˆ—è¡¨ï¼ŒæŸ¥æ‰¾è¿”å›URLç±»å‹çš„getæ–¹æ³•\n\t\t    LBL_PTS:\n\t\t    //éå†å½“å‰æ–¹æ³•å‚æ•°\n\t\t    for (int i = 0; i < pts.length; ++i) {\n\t\t\t//éå†æ–¹æ³•ç¬¬iä¸ªå‚æ•°çš„æ‰€æœ‰æ–¹æ³•\n\t\t\tMethod[] ms = pts[i].getMethods();\n\t\t\tfor (Method m : ms) {\n\t\t\t    //å½“å‰æ–¹æ³•å\n\t\t\t    String name = m.getName();\n\t\t\t    //å½“å‰æ–¹æ³•æ²¡æœ‰å‚æ•°ï¼Œä¸”è¿”å›å€¼æ˜¯URLç±»å‹ï¼Œä»¥getå¼€å¤´æˆ–è€…é•¿åº¦>3,ä¸”æ˜¯publicä¿®é¥°ï¼Œæ²¡æœ‰staticä¿®é¥°\n\t\t\t    if ((name.startsWith(\"get\") || name.length() > 3)\n\t\t\t\t    && Modifier.isPublic(m.getModifiers())\n\t\t\t\t    && !Modifier.isStatic(m.getModifiers())\n\t\t\t\t    && m.getParameterTypes().length == 0\n\t\t\t\t    && m.getReturnType() == URL.class) {\n\t\t\t\t//æ–¹æ³•çš„ç¬¬iä¸ªå‚æ•°æ˜¯\"è¿”å›URLç±»å‹çš„getæ–¹æ³•\"\n\t\t\t\turlTypeIndex = i;\n\t\t\t\t//â€œè¿”å›URLç±»å‹çš„getæ–¹æ³•çš„åç§°â€\n\t\t\t\tattribMethod = name;\n\t\t\t\t//è·³è½¬åˆ°LBL_PTS\n\t\t\t\tbreak LBL_PTS;\n\t\t\t    }\n\t\t\t}\n\t\t    }\n\t\t    if (attribMethod == null) {\n\t\t\t//æ²¡æœ‰æ‰¾åˆ°è¿”å›URLç±»å‹çš„æ–¹æ³•ï¼ŒæŠ›å¼‚å¸¸\n\t\t\tthrow new IllegalStateException(\"fail to create adaptive class for interface \" + type.getName()\n\t\t\t\t+ \": not found url parameter or url attribute in parameters of method \" + method.getName());\n\t\t    }\n\t\t\t\n\t\t    //æ·»åŠ â€œæ–¹æ³•ç¬¬urlTypeIndexä¸ªå‚æ•°ä¸ºç©ºçš„åˆ¤æ–­â€\n\t\t    String s = String.format(\"\\nif (arg%d == null) throw new IllegalArgumentException(\\\"%s argument == null\\\");\",\n\t\t\t    urlTypeIndex, pts[urlTypeIndex].getName());\n\t\t    code.append(s);\n\t\t\t\n\t\t    //æ·»åŠ â€œæ–¹æ³•ç¬¬urlTypeIndexä¸ªå‚æ•°çš„attribMethodæ–¹æ³•çš„è¿”å›å€¼ä¸ºç©ºçš„åˆ¤æ–­â€\n\t\t    s = String.format(\"\\nif (arg%d.%s() == null) throw new IllegalArgumentException(\\\"%s argument %s() == null\\\");\",\n\t\t\t    urlTypeIndex, attribMethod, pts[urlTypeIndex].getName(), attribMethod);\n\t\t    code.append(s);\n\n\t\t    //æ·»åŠ ï¼šcom.alibaba.dubbo.common.URL url = arg{$urlTypeIndex}.attribMethod();\n\t\t    s = String.format(\"%s url = arg%d.%s();\", URL.class.getName(), urlTypeIndex, attribMethod);\n\t\t    code.append(s);\n\t\t}\n\t\t//@Adaptiveæ³¨è§£çš„valueå€¼\n\t\tString[] value = adaptiveAnnotation.value();\n\t\tif (value.length == 0) {\n\t\t    //æ²¡æœ‰è®¾ç½®valueï¼Œåˆ™æ ¹æ®æ‰©å±•æ¥å£åç§°æŒ‰ç…§ä¸€å®šè§„åˆ™ç”Ÿæˆvalue\n\t\t    //å¦‚ï¼šProxyFactory å°†ç”Ÿæˆvalueï¼šproxy.factory\n\t\t    //åˆ™charArray = [P,r,o,x,y,F,a,c,t,o,r,y]\n\t\t    char[] charArray = type.getSimpleName().toCharArray();\n\t\t    StringBuilder sb = new StringBuilder(128);\n\t\t    for (int i = 0; i < charArray.length; i++) {\n\t\t\tif (Character.isUpperCase(charArray[i])) {\n\t\t\t    //å½“å‰å­—ç¬¦æ˜¯å¤§å†™çš„\n\t\t\t    if (i != 0) {\n\t\t\t        //å½“å‰å­—ç¬¦ä¸æ˜¯ç¬¬1ä¸ªå­—ç¬¦ï¼Œåˆ™æ·»åŠ â€œ.â€åˆ°sbä¸­\n\t\t\t\tsb.append(\".\");\n\t\t\t    }\n\t\t\t    //å°†å½“å‰å­—ç¬¦è½¬ä¸ºå°å†™ï¼Œå¹¶æ·»åŠ åˆ°sbä¸­\n\t\t\t    sb.append(Character.toLowerCase(charArray[i]));\n\t\t\t} else {\n\t\t\t    //å½“å‰å­—ç¬¦æ˜¯å°å†™çš„ï¼Œç›´æ¥æ·»åŠ åˆ°sbä¸­\n\t\t\t    sb.append(charArray[i]);\n\t\t\t}\n\t\t    }\n\t\t    //ç”Ÿæˆçš„value = [{\"proxy.factory\"}]\n\t\t    value = new String[]{sb.toString()};\n\t\t}\n\t\t//å½“å‰æ–¹æ³•ä¸­æ˜¯å¦å­˜åœ¨Invocationç±»å‹çš„å‚æ•°\n\t\tboolean hasInvocation = false;\n\t\tfor (int i = 0; i < pts.length; ++i) {\n\t\t    //å½“å‰æ–¹æ³•çš„ç¬¬iä¸ªå‚æ•°åç§°æ˜¯å¦ä¸ºâ€œcom.alibaba.dubbo.rpc.Invocationâ€\n\t\t    if (pts[i].getName().equals(\"com.alibaba.dubbo.rpc.Invocation\")) {\n\t\t\t//æ·»åŠ \"æ ¡éªŒå‚æ•°Invocationæ˜¯å¦ä¸ºç©º\"çš„code\n\t\t\tString s = String.format(\"\\nif (arg%d == null) throw new IllegalArgumentException(\\\"invocation == null\\\");\", i);\n\t\t\tcode.append(s);\n\t\t\t//æ·»åŠ \"è·å–æ–¹æ³•å\"çš„code\n\t\t\ts = String.format(\"\\nString methodName = arg%d.getMethodName();\", i);\n\t\t\tcode.append(s);\n\t\t\t//æ ‡è¯† å­˜åœ¨Invocationç±»å‹çš„å‚æ•°\n\t\t\thasInvocation = true;\n\t\t\tbreak;\n\t\t    }\n\t\t}\n\t\t//@SPIæ³¨è§£ä¸Šé…ç½®çš„å€¼ï¼Œé»˜è®¤æ‰©å±•åç§°\n\t\tString defaultExtName = cachedDefaultName;\n\t\tString getNameCode = null;\n\t\t//éå†@Adaptiveæ³¨è§£çš„valueæ•°ç»„\n\t\tfor (int i = value.length - 1; i >= 0; --i) {\n\t\t    if (i == value.length - 1) {\n\t\t        //å½“å‰iä¸ºvalueçš„æœ€å1ä¸ªå…ƒç´ \n\t\t\tif (null != defaultExtName) {\n\t\t\t    //é»˜è®¤æ‰©å±•åç§°ä¸ä¸ºç©ºï¼Œå¦‚æœæ²¡æœ‰è·å–åˆ°å€¼ï¼Œåˆ™ä¼šä½¿ç”¨é»˜è®¤å€¼\n\t\t\t    //ç¬¬iä¸ªå…ƒç´ æ˜¯å¦ç­‰äºprotocol\n\t\t\t    if (!\"protocol\".equals(value[i])) {\n\t\t\t\tif (hasInvocation) {\n\t\t\t\t    //å­˜åœ¨Invocationç±»å‹çš„å‚æ•°\n\t\t\t\t    //è°ƒç”¨urlçš„getMethodParameteræ–¹æ³•ï¼Œè·å–value[i]å¯¹åº”çš„æ‰©å±•åï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™å–é»˜è®¤æ‰©å±•ådefaultExtName\n\t\t\t\t    getNameCode = String.format(\"url.getMethodParameter(methodName, \\\"%s\\\", \\\"%s\\\")\", value[i], defaultExtName);\n\t\t\t\t} else {\n\t\t\t\t    //ä¸å­˜åœ¨Invocationç±»å‹çš„å‚æ•°\n\t\t\t\t    //ä»urlçš„value[i]å‚æ•°ä¸­(å½“å‰ä¾‹å­ä¸ºproxy)è·å–æ‰©å±•åï¼Œå¦‚æœæ²¡æœ‰è·å–åˆ°ï¼Œåˆ™ä½¿ç”¨é»˜è®¤æ‰©å±•åjavassist\n\t\t\t\t    //url.getParameter(\"proxy\",\"javassist\")\n\t\t\t\t    getNameCode = String.format(\"url.getParameter(\\\"%s\\\", \\\"%s\\\")\", value[i], defaultExtName);\n\t\t\t\t}\n\t\t\t    } else {\n\t\t\t        //ç¬¬iä¸ªå…ƒç´ ç­‰äºprotocol\n\t\t\t\t//ä»urlä¸­è·å–protocolå±æ€§å€¼ï¼Œå¦‚æœæ²¡æœ‰è·å–åˆ°ï¼Œåˆ™ä½¿ç”¨é»˜è®¤æ‰©å±•ådefaultExtName\n\t\t\t\tgetNameCode = String.format(\"( url.getProtocol() == null ? \\\"%s\\\" : url.getProtocol() )\", defaultExtName);\n\t\t\t    }\n\t\t\t} else {\n\t\t\t    //é»˜è®¤æ‰©å±•åç§°ä¸ºç©ºï¼Œå¦‚æœæ²¡æœ‰è·å–åˆ°å€¼ï¼Œåˆ™ä¸ä¼šä½¿ç”¨é»˜è®¤å€¼\n\t\t\t    if (!\"protocol\".equals(value[i])) {\n\t\t\t\tif (hasInvocation) {\n\t\t\t\t    getNameCode = String.format(\"url.getMethodParameter(methodName, \\\"%s\\\", \\\"%s\\\")\", value[i], defaultExtName);\n\t\t\t\t} else {\n\t\t\t\t    //ä»urlä¸­è·å–å‚æ•°value[i]å¯¹åº”çš„å€¼\n\t\t\t\t    getNameCode = String.format(\"url.getParameter(\\\"%s\\\")\", value[i]);\n\t\t\t\t}\n\t\t\t    } else {\n\t\t\t        //ä»urlä¸­è·å–protocolå±æ€§å€¼\n\t\t\t\tgetNameCode = \"url.getProtocol()\";\n\t\t\t    }\n\t\t\t}\n\t\t    } else {\n\t\t        //å½“å‰ç¬¬iä¸ªå…ƒç´ ä¸æ˜¯valueæœ€åä¸€ä¸ªå…ƒç´ \n\t\t\tif (!\"protocol\".equals(value[i])) {\n\t\t\t    if (hasInvocation) {\n\t\t\t\tgetNameCode = String.format(\"url.getMethodParameter(methodName, \\\"%s\\\", \\\"%s\\\")\", value[i], defaultExtName);\n\t\t\t    } else {\n\t\t\t\tgetNameCode = String.format(\"url.getParameter(\\\"%s\\\", %s)\", value[i], getNameCode);\n\t\t\t    }\n\t\t\t} else {\n\t\t\t    getNameCode = String.format(\"url.getProtocol() == null ? (%s) : url.getProtocol()\", getNameCode);\n\t\t\t}\n\t\t    }\n\t\t}\n\t\t\n\t\t//æ·»åŠ ï¼šString extName = url.getParameter(\"proxy\", \"javassist\");\n\t\t//è·å–æ‰©å±•å\n\t\tcode.append(\"\\nString extName = \").append(getNameCode).append(\";\");\n\t\t\n\t\t//æ·»åŠ â€œæ ¡éªŒæ‰©å±•åä¸ä¸ºç©ºâ€çš„code\n\t\tString s = String.format(\"\\nif(extName == null) \" +\n\t\t\t\t\"throw new IllegalStateException(\\\"Fail to get extension(%s) name from url(\\\" + url.toString() + \\\") use keys(%s)\\\");\",\n\t\t\ttype.getName(), Arrays.toString(value));\n\t\tcode.append(s);\n\n\t\t//æ·»åŠ \"æ ¹æ®æ‰©å±•åè·å–æ‰©å±•å®ä¾‹\"çš„code\n\t\t//com.alibaba.dubbo.rpc.ProxyFactory extension = (com.alibaba.dubbo.rpc.ProxyFactory)ExtensionLoader.getExtensionLoader(com.alibaba.dubbo.rpc.ProxyFactory.class).getExtension(extName) ;\n\t\ts = String.format(\"\\n%s extension = (%<s)%s.getExtensionLoader(%s.class).getExtension(extName);\",\n\t\t\ttype.getName(), ExtensionLoader.class.getSimpleName(), type.getName());\n\t\tcode.append(s);\n\n\t\t//å¤„ç†è¿”å›å€¼\n\t\tif (!rt.equals(void.class)) {\n\t\t    //è¿”å›å€¼ä¸æ˜¯voidç±»å‹\n\t\t    code.append(\"\\nreturn \");\n\t\t}\n\n\t\t//ä¾‹å¦‚ï¼šreturn extension.getInvoker(arg0);\n\t\t//è¿™é‡Œçš„é€»è¾‘å°±æ˜¯ï¼šæ ¹æ®æ‰©å±•åç§°çš„ä¸åŒè·å–ç›¸åº”çš„æ‰©å±•å®ç°ï¼Œç„¶åè°ƒç”¨æ–¹æ³•ï¼Œå¹¶è¿”å›\n\t\ts = String.format(\"extension.%s(\", method.getName());\n\t\t//å…ˆå¡«å†™è°ƒç”¨ä¿¡æ¯\n\t\tcode.append(s);\n\t\t\n\t\t//éå†å½“å‰æ–¹æ³•å‚æ•°ï¼Œæ·»åŠ æ–¹æ³•å‚æ•°\n\t\tfor (int i = 0; i < pts.length; i++) {\n\t\t    if (i != 0) {\n\t\t\tcode.append(\", \");\n\t\t    }\n\t\t    code.append(\"arg\").append(i);\n\t\t}\n\t\tcode.append(\");\");\n\t    }\n\n\t    //ç”Ÿæˆæ–¹æ³•ç­¾åcode\n\t    //å¦‚ï¼špublic java.lang.Object getProxy(com.alibaba.dubbo.rpc.Invoker arg0) throws com.alibaba.dubbo.rpc.RpcException\n\t    codeBuilder.append(\"\\npublic \")\n\t\t    .append(rt.getCanonicalName())\n\t\t    .append(\" \")\n\t\t    .append(method.getName())\n\t\t    .append(\"(\");\n\n            //æ·»åŠ å‚æ•°\n\t    for (int i = 0; i < pts.length; i++) {\n\t\tif (i > 0) {\n\t\t    codeBuilder.append(\", \");\n\t\t}\n\t\tcodeBuilder.append(pts[i].getCanonicalName());\n\t\tcodeBuilder.append(\" \");\n\t\tcodeBuilder.append(\"arg\").append(i);\n\t    }\n\t    codeBuilder.append(\")\");\n\n\t    //æ·»åŠ å¼‚å¸¸\n\t    if (ets.length > 0) {\n\t\tcodeBuilder.append(\" throws \");\n\t\tfor (int i = 0; i < ets.length; i++) {\n\t\t    if (i > 0) {\n\t\t\tcodeBuilder.append(\", \");\n\t\t    }\n\t\t    codeBuilder.append(ets[i].getCanonicalName());\n\t\t}\n\t    }\n\t   \n\t    codeBuilder.append(\" {\");\n\t     //å°†æ–¹æ³•codeæ·»åŠ åˆ°æ–¹æ³•ä»£ç å—ä¸­\n\t    codeBuilder.append(code.toString());\n\t    codeBuilder.append(\"\\n}\");\n\t}\n\tcodeBuilder.append(\"\\n}\");\n\tif (logger.isDebugEnabled()) {\n\t    logger.debug(codeBuilder.toString());\n\t}\n\t//è¿”å›ç”Ÿäº§çš„code\n\treturn codeBuilder.toString();\n}\n```\nä»¥type = com.alibaba.dubbo.rpc.ProxyFactoryä¸ºä¾‹å­ï¼Œç”Ÿæˆçš„ä»£ç å¤§æ¦‚å¦‚ä¸‹æ‰€ç¤º:\n```java\npackage com.alibaba.dubbo.rpc;\nimport com.alibaba.dubbo.common.extension.ExtensionLoader;\n\npublic class ProxyFactory$Adaptive implements com.alibaba.dubbo.rpc.ProxyFactory {\n\n    public java.lang.Object getProxy(com.alibaba.dubbo.rpc.Invoker arg0) throws com.alibaba.dubbo.rpc.RpcException {\n\t if (arg0 == null){\n\t    throw new IllegalArgumentException(\"com.alibaba.dubbo.rpc.Invoker argument == null\");\n\t }\n\t if (arg0.getUrl() == null) {\n\t    throw new IllegalArgumentException(\"com.alibaba.dubbo.rpc.Invoker argument getUrl() == null\");\n\t }\n\t com.alibaba.dubbo.common.URL url = arg0.getUrl();\n\t String extName = url.getParameter(\"proxy\", \"javassist\");\n\t if(extName == null) {\n\t    throw new IllegalStateException(\"Fail to get extension(com.alibaba.dubbo.rpc.ProxyFactory) name from url(\" + url.toString() + \") use keys([proxy])\");\n\t }\n\t com.alibaba.dubbo.rpc.ProxyFactory extension = (com.alibaba.dubbo.rpc.ProxyFactory)ExtensionLoader.getExtensionLoader(com.alibaba.dubbo.rpc.ProxyFactory.class).getExtension(extName);\n\t return extension.getProxy(arg0);\n    }\n\n    public com.alibaba.dubbo.rpc.Invoker getInvoker(java.lang.Object arg0, java.lang.Class arg1, com.alibaba.dubbo.common.URL arg2) throws com.alibaba.dubbo.rpc.RpcException {\n\tif (arg2 == null) {\n\t    throw new IllegalArgumentException(\"url == null\");\n\t}\n\tcom.alibaba.dubbo.common.URL url = arg2;\n\tString extName = url.getParameter(\"proxy\", \"javassist\");\n\tif(extName == null){\n\t    throw new IllegalStateException(\"Fail to get extension(com.alibaba.dubbo.rpc.ProxyFactory) name from url(\" + url.toString() + \") use keys([proxy])\");\n\t}\n\tcom.alibaba.dubbo.rpc.ProxyFactory extension = (com.alibaba.dubbo.rpc.ProxyFactory)ExtensionLoader.getExtensionLoader(com.alibaba.dubbo.rpc.ProxyFactory.class).getExtension(extName);\n\treturn extension.getInvoker(arg0, arg1, arg2);\n    }\n}\n```\nä»¥ä¸Šå°±æ˜¯ç”Ÿæˆè‡ªé€‚åº”å®ç°ç±»çš„å…¨éƒ¨å†…å®¹ï¼Œç”Ÿæˆå¥½ä»£ç åï¼Œä¼šäº¤ç”±Compileræ‰©å±•è¿›è¡Œç¼–è¯‘å¾—åˆ°Classå¯¹è±¡ï¼Œç„¶ååœ¨æœ¬å°èŠ‚å¼€å¤´ä»‹ç»çš„createAdaptiveExtension()æ–¹æ³•ä¸­è¿›è¡Œå®ä¾‹åŒ–ï¼Œå¹¶è¿›è¡Œä¾èµ–æ³¨å…¥ã€‚\næœ¬æ–‡å†…å®¹è¿‡å¤šï¼ŒCompilerç¼–è¯‘çš„éƒ¨åˆ†å°±æ”¾åˆ°åé¢çš„åšæ–‡ä¸­åœ¨ä»‹ç»äº†ã€‚å¦å¤–ExtensionLoaderç±»ä¸­ä¹Ÿæä¾›äº†å¾ˆå¤šè¾…åŠ©æ–¹æ³•ï¼Œå†…å®¹æ¯”è¾ƒç®€å•ï¼Œåœ¨è¿™é‡Œå°±ä¸è¯¦ç»†ä»‹ç»äº†ã€‚\n\n### ExtensionFactoryå·¥å‚å®ç°\n```\n@SPI\npublic interface ExtensionFactory {\n    /**\n     * è·å–æ‰©å±•å®ç°ç±»å®ä¾‹\n     * Get extension.\n     * @param type object type. æ‰©å±•æ¥å£ç±»å‹\n     * @param name object name. æ‰©å±•åç§°\n     * @return object instance. è¿”å›æ‰©å±•å®ä¾‹\n     */\n    <T> T getExtension(Class<T> type, String name);\n}\n```\nè¯¥æ¥å£æ ¹æ®æ‰©å±•ç±»å‹å’Œæ‰©å±•åç§°è·å–æ‰©å±•å®ä¾‹ã€‚å¯ä»¥çœ‹åˆ°è¯¥æ¥å£å£°æ˜ä¸Šä¹ŸåŠ ä¸Šäº†@SPIæ³¨è§£ï¼Œè¯´æ˜å­˜åœ¨å¤šç§å®ç°ï¼ŒDubboæä¾›äº†ä¸‰ç§å®ç°ï¼Œåˆ†åˆ«ä¸ºAdaptiveExtensionFactoryã€SpiExtensionFactoryã€SpringExtensionFactory.\n\n#### SpringExtensionFactory\n```java\npublic class SpringExtensionFactory implements ExtensionFactory {\n\n    /**\n     * ä¿å­˜æ‰€æœ‰çš„ApplicationContextä¸Šä¸‹æ–‡å¯¹è±¡\n     */\n    private static final Set<ApplicationContext> contexts = new ConcurrentHashSet<ApplicationContext>();\n\n    /**\n     * æ·»åŠ ApplicationContext\n     */\n    public static void addApplicationContext(ApplicationContext context) {\n        contexts.add(context);\n    }\n\n    /**\n     * ç§»é™¤ApplicationContext\n     */\n    public static void removeApplicationContext(ApplicationContext context) {\n        contexts.remove(context);\n    }\n\n    @Override\n    public <T> T getExtension(Class<T> type, String name) {\n        //éå†æ‰€æœ‰çš„context\n        for (ApplicationContext context : contexts) {\n            //åˆ¤æ–­è¯¥contextä¸Šä¸‹æ–‡æ˜¯å¦åŒ…å«æ­¤bean\n            if (context.containsBean(name)) {\n                //æ ¹æ®åç§°è·å–contextä¸­çš„bean\n                Object bean = context.getBean(name);\n                //åˆ¤æ–­è¯¥beanæ˜¯å¦æ˜¯typeç±»å‹çš„å®ä¾‹ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œåˆ™è¿”å›è¯¥bean\n                if (type.isInstance(bean)) {\n                    return (T) bean;\n                }\n            }\n        }\n        return null;\n    }\n}\n```\n\n#### SpiExtensionFactory\n\n```java\npublic class SpiExtensionFactory implements ExtensionFactory {\n\n    @Override\n    public <T> T getExtension(Class<T> type, String name) {\n        //åˆ¤æ–­ç±»å‹typeæ˜¯å¦æ˜¯æ¥å£ï¼Œå¹¶ä¸”å­˜åœ¨@SPIæ³¨è§£\n        if (type.isInterface() && type.isAnnotationPresent(SPI.class)) {\n            //è·å–æ‰©å±•æ¥å£typeçš„æ‰©å±•åŠ è½½å™¨\n            ExtensionLoader<T> loader = ExtensionLoader.getExtensionLoader(type);\n\t    //é€šè¿‡æ‰©å±•åŠ è½½å™¨è·å–æ¥å£typeæ”¯æŒçš„æ‰€æœ‰æ‰©å±•çš„åç§°åˆ—è¡¨\n            if (!loader.getSupportedExtensions().isEmpty()) {\n                //è¿”å›è‡ªé€‚åº”æ‰©å±•å®ä¾‹\n                return loader.getAdaptiveExtension();\n            }\n        }\n        return null;\n    }\n}\n```\n\n#### AdaptiveExtensionFactory\nè¯¥ExtensionFactoryå®ç°å­˜åœ¨@Adaptiveæ³¨è§£ï¼Œå› æ­¤å®ƒæ˜¯è‡ªé€‚åº”å®ç°ã€‚\n\n```java\n@Adaptive\npublic class AdaptiveExtensionFactory implements ExtensionFactory {\n\n    /**\n     * ExtensionFactoryæ‰©å±•å®ç°ç±»å®ä¾‹é›†åˆ\n     */\n    private final List<ExtensionFactory> factories;\n\n    public AdaptiveExtensionFactory() {\n        //è·å–ExtensionFactory.classå¯¹åº”çš„æ‰©å±•åŠ è½½å™¨\n        ExtensionLoader<ExtensionFactory> loader = ExtensionLoader.getExtensionLoader(ExtensionFactory.class);\n        \n        List<ExtensionFactory> list = new ArrayList<ExtensionFactory>();\n        \n        //éå†æ‰©å±•æ¥å£ExtensionFactoryæ”¯æŒçš„æ‰©å±•åç§°åˆ—è¡¨(spiã€spring)\n        for (String name : loader.getSupportedExtensions()) {\n            //æ ¹æ®æ‰©å±•åç§°nameåŠ è½½æ‰©å±•å®ç°ç±»å®ä¾‹\n            list.add(loader.getExtension(name));\n        }\n        factories = Collections.unmodifiableList(list);\n    }\n\n    /**\n     * è‡ªé€‚åº”çš„æ‰©å±•å·¥å‚ï¼ŒæŒ¨ä¸ªéå†springå’Œspiï¼Œä»ä¸­æŸ¥è¯¢æŒ‡å®šç±»å‹çš„å®ä¾‹\n     * @param type object type. æ‰©å±•æ¥å£ç±»å‹\n     * @param name object name. æ‰©å±•åç§°\n     * @param <T>\n     * @return\n     */\n    @Override\n    public <T> T getExtension(Class<T> type, String name) {\n        //éå†ExtensionFactoryå®ç°ç±»é›†åˆï¼Œä»ä¸­æŒ¨ä¸ªæŸ¥æ‰¾æŒ‡å®šç±»å‹çš„æ‰©å±•\n        for (ExtensionFactory factory : factories) {\n            //è·å–typeç±»å‹çš„æ‰©å±•å®ä¾‹\n            T extension = factory.getExtension(type, name);\n            if (extension != null) {\n               //å®ä¾‹ä¸ä¸ºç©ºï¼Œè¿”å›å®ä¾‹ \n               return extension;\n            }\n        }\n        return null;\n    }\n}\n```\n\nåˆ°æ­¤ï¼Œå…³äºSPIçš„å®ç°å°±å…¨éƒ¨ä»‹ç»å®Œäº†ï¼Œä¸‹ä¸€å°èŠ‚å°†ä¼šä»‹ç»å’ŒSpingé›†æˆç›¸å…³çš„å†…å®¹ã€‚\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","tags":["dubbo"]},{"title":"Springæ³¨è§£ä¹‹@Importæ³¨è§£","url":"/blog/2018/07/30/Springæ³¨è§£ä¹‹-Importæ³¨è§£/","content":">æœ¬å°èŠ‚ä»‹ç»Springæä¾›çš„@Importæ³¨è§£\n\n* @Importæ³¨è§£çš„ä½œç”¨\n* @Importæ³¨è§£çš„å®šä¹‰\n* @Importæ³¨è§£çš„ä½¿ç”¨\n\n### @Importæ³¨è§£çš„ä½œç”¨\nè¡¨ç¤ºè¦å¯¼å…¥1ä¸ªæˆ–å¤šä¸ª@Configurationé…ç½®ç±»ã€‚æä¾›äº†ä¸Spring XMLä¸­çš„<import/>å…ƒç´ ç­‰æ•ˆçš„ä½œç”¨.\n@Importæ³¨è§£å…è®¸æˆ‘ä»¬ä½¿ç”¨å¯¼å…¥çš„æ–¹å¼å°†å®ä¾‹æ·»åŠ åˆ°Spring BeanFactoryä¸­.å…è®¸æˆ‘ä»¬å¯¼å…¥@Configurationç±»ã€ImportSelectoræ¥å£å’ŒImportBeanDefinitionRegistraræ¥å£çš„å®ç°ç±»,ç±»ä¼¼äºAnnotationConfigApplicationContextç±»çš„registeræ–¹æ³•ã€‚\n\n### @Importæ³¨è§£çš„å®šä¹‰\nå¯ä»¥çœ‹åˆ°è¯¥æ³¨è§£åªå¯ä»¥ä½¿ç”¨åœ¨ç±»ä¸Š.\n```java\n@Target(ElementType.TYPE)\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\npublic @interface Import {\n\t/**\n\t * {@link Configuration}, {@link ImportSelector}, {@link ImportBeanDefinitionRegistrar}\n\t * or regular component classes to import.\n\t */\n\tClass<?>[] value();\n}\n```\n### @Importæ³¨è§£çš„ä½¿ç”¨\n\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ†åˆ«ä»‹ç»è¿™ä¸‰ç§ä½¿ç”¨æ–¹å¼,æˆ‘ä»¬å…ˆåˆ›å»ºä¸€äº›æµ‹è¯•ç±»å’Œæµ‹è¯•æ–¹æ³•:\n```java\npackage org.dubbo.import;\npublic class A{}\n\npublic class B{}\n\npublic class C{}\n\npublic class D{}\n\n//æµ‹è¯•æ–¹æ³•\npublic static void main(String args[]){\n   //åˆ›å»ºé…ç½®ä¸Šä¸‹æ–‡\n   AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext();\n   //æ³¨å†Œå½“å‰é…ç½® Bean\n   context.register(DubboConfiguration.class);\n   context.refresh();\n   \n   //è·å–æ‰€æœ‰å·²æ³¨å†Œçš„beanNames\n   String[] beanNames = context.getBeanDefinitionNames();\n   for(String beanName : beanNames){\n       //è¾“å‡ºbeanNames\n       System.out.println(\"beanName -> \"+ beanName);\n   }\n}\n```\n\n#### Configurationæ–¹å¼\n```java\n@Import({A.class,B.class})\n@Configuration\npublic class DubboConfig{} \n```\næ‰§è¡Œæµ‹è¯•æ–¹æ³•ï¼Œå°†ä¼šè¾“å‡ºï¼š\n```java\nbeanName -> DubboConfig\nbeanName -> org.dubbo.import.A\nbeanName -> org.dubbo.import.B\n```\n\n#### å®ç°ImportSelectoræ¥å£æ–¹å¼\n```java\n/**\n * ImportSelectorå®ç°ç±»\n */\npublic class DubboImportSelector implements ImportSelector{\n    public String[] selectImports(AnnotationMetadata metadata) {\n        return new String[]{\"org.dubbo.import.C\"};\n    }\n}\n\n/**\n * ä¿®æ”¹é…ç½®\n */\n@Import({A.class,B.class,DubboImportSelector.class})\n@Configuration\npublic class DubboConfig{}\n```\n\næ‰§è¡Œæµ‹è¯•æ–¹æ³•ï¼Œå°†ä¼šè¾“å‡ºï¼š\n```java\nbeanName -> DubboConfig\nbeanName -> org.dubbo.import.A\nbeanName -> org.dubbo.import.B\nbeanName -> org.dubbo.import.C\n```\n\n#### å®ç°ImportBeanDefinitionRegistraræ¥å£æ–¹å¼\n\n```java\n/**\n *\n * ImportBeanDefinitionRegistrarå®ç°ç±»\n */\npublic class DubboImportBeanDefinitionRegistrar implements ImportBeanDefinitionRegistrar{\n    \n    @Override\n    public void registerBeanDefinitions(AnnotationMetadata metadata,BeanDefinitionRegistry registry) {\n        //åˆ›å»ºä¸€ä¸ªDç±»çš„rootBeanDefinitionå¯¹è±¡\n        RootBeanDefinition rootBeanDefinition = new RootBeanDefinition(D.class);\n        //æ³¨å†ŒbeanName=dçš„bean\n        registry.registerBeanDefinition(\"d\", rootBeanDefinition);\n    }\n}\n\n/**\n * ä¿®æ”¹é…ç½®\n */\n@Import({A.class,B.class,DubboImportSelector.class,DubboImportBeanDefinitionRegistrar.class})\n@Configuration\npublic class DubboConfig{}\n```\n\nç„¶åæ‰§è¡Œæµ‹è¯•æ–¹æ³•ï¼Œå°†ä¼šè¾“å‡ºï¼š\n```java\nbeanName -> DubboConfig\nbeanName -> org.dubbo.import.A\nbeanName -> org.dubbo.import.B\nbeanName -> org.dubbo.import.C\nbeanName -> org.dubbo.import.D\n```\n\nå¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬æˆåŠŸå°†A/B/C/Dæ·»åŠ åˆ°äº†BeanFactoryä¸­.\n","tags":["spring"]},{"title":"è‡ªå·±åŠ¨æ‰‹å®ç°Ideaæ’ä»¶","url":"/blog/2018/07/29/è‡ªå·±åŠ¨æ‰‹å®ç°Ideaæ’ä»¶/","content":">åœ¨é˜…è¯»å¼€æºé¡¹ç›®æºä»£ç çš„æ—¶å€™ï¼Œä¼šæ—¶å¸¸ä¸€èµ·è¯»ä½œè€…å†™çš„æ³¨é‡Šæ¥ç†è§£ä»£ç çš„æ„å›¾ï¼Œå¯¹äºè‹±æ–‡ä¸å¥½çš„ç å†œæ¥è¯´å®åœ¨æ˜¯æ¯”è¾ƒåƒåŠ›ï¼Œæˆ–è€…å½“æˆ‘ä»¬åœ¨å†™ä»£ç çš„æ—¶å€™ï¼Œä¸ºäº†ä¸€ä¸ªå˜é‡åç§°çº ç»“åŠå¤©æ—¶ï¼Œéƒ½ä¼šéœ€è¦ä¸€ä¸ªå¼ºå¤§çš„è¯å…¸æ¥æ”¯æŒæˆ‘ä»¬çš„å·¥ä½œï¼Œç”¨æœ‰é“è¯å…¸çš„è¯ï¼Œå¯åŠ¨è¿‡æ…¢ã€ç”µè„‘å¤ªå¡ã€æ¥å›åˆ‡æ¢å±å¹•ä¼šæ„Ÿè§‰å¾ˆä¸çˆ½è¿˜å¥½Ideaæä¾›äº†å¼ºå¤§çš„æ’ä»¶æ‰©å±•èƒ½åŠ›ï¼Œèƒ½è®©æˆ‘ä»¬åœ¨é›†æˆå¼€å‘ç¯å¢ƒä¸­åµŒå…¥ç¿»è¯‘å¼•æ“ï¼Œå½“ç„¶åªè¦æœ‰è¶³å¤Ÿçš„æƒ³è±¡åŠ›ï¼Œå¯ä»¥åœ¨Ideaé›†æˆç¯å¢ƒä¸­å¼€å‘å„ç§æ’ä»¶ï¼Œè‡ªå®šä¹‰è‡ªå·±çš„å¼€å‘ç¯å¢ƒï¼Œæ¯”å¦‚ä¸‹é¢çš„ç‚«é…·æ’ä»¶\n![](img/1.gif)\næœ¬æ–‡å°±å‘å¤§å®¶ä»‹ç»ä¸€ä¸‹å¦‚ä½•å¼€å‘ä¸€ä¸ªIdeaç¿»è¯‘æ’ä»¶ã€‚\né¦–å…ˆï¼Œæ‰“å¼€Ideaé›†æˆå¼€å‘ç¯å¢ƒï¼Œç„¶åæ–°å»ºä¸€ä¸ªIdea pluginé¡¹ç›®ï¼š\n![](img/2.jpg)\nç„¶åè¾“å…¥é¡¹ç›®åç§°ï¼Œä»¥åŠé¡¹ç›®ä½ç½®ï¼Œå¹¶ç‚¹å‡»FinishæŒ‰é’®å®Œæˆåˆ›å»ºï¼š\n![](img/3.jpg)\nåˆ›å»ºå¥½é¡¹ç›®ä»¥åï¼Œç»“æ„å¦‚ä¸‹å›¾ï¼š\n![](img/4.jpg)\nç„¶åæˆ‘ä»¬åœ¨srcç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªeasy.formçš„åŒ…ï¼Œå¹¶åœ¨è¯¥åŒ…è·¯å¾„ä¸‹åˆ›å»ºä¸€ä¸ªåç§°ä¸ºTranslationFormçš„ GUI Formï¼š\n![](img/5.jpg)\n![](img/6.jpg)\næ­¤æ—¶ï¼ŒIdeaä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬ç”Ÿæˆä¸€ä¸ªTranslationForm.formæ–‡ä»¶å’Œä¸€ä¸ªTranslationFormç±»ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨TranslationForm.formæ–‡ä»¶ä¸­æ‹–æ‹½ç»„ä»¶è¿…é€Ÿæ„å»ºä¸€ä¸ªé…ç½®é¢æ¿ï¼ˆç©è¿‡Visual Studioçš„ç«¥é‹ä¸€å®šå¯¹è¿™ä¸ªåŠŸèƒ½å¾ˆç†Ÿæ‚‰äº†ï¼‰ï¼Œä¸æ­¤åŒæ—¶ï¼ŒIdeaä¼šè‡ªåŠ¨åœ¨TranslationFormç±»ä¸­ç”Ÿæˆç›¸åº”çš„ç»„ä»¶å…ƒç´ ï¼š\n![](img/7.jpg)\nåœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æ–°åˆ›å»ºäº†ä¸€ä¸ªä¸»é¢æ¿JPanelï¼Œç„¶ååœ¨è¯¥é¢æ¿ä¸‹åˆ›å»ºäº†6ä¸ªå­å…ƒç´ JRadioButtonå•é€‰æŒ‰é’®ï¼Œä»¥åŠä¸€ä¸ªæ ‡ç­¾JLabelã€‚ç°åœ¨æŒ‘ä¸€ä¸ªå•é€‰æŒ‰é’®è®²è§£ä¸‹ï¼Œå…¶ä»–çš„éƒ½ç±»ä¼¼ï¼š\n![](img/8.jpg)\nButton Groupé€‰é¡¹æ˜¯å®šä¹‰ä¸€ä¸ªæŒ‰é’®ç»„ï¼Œæˆ‘ä»¬è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªengineGroupçš„æŒ‰é’®ç»„ï¼Œç”¨æ¥å¯¹æŒ‰é’®è¿›è¡Œå½’ç»„ã€‚field nameé€‰é¡¹å°±æ˜¯å°†è¦åœ¨TranslationFormç±»ä¸­åŠ¨æ€åˆ›å»ºçš„å˜é‡åç§°ï¼Œtextå°±æ˜¯æ˜¾ç¤ºçš„æ–‡æœ¬ï¼Œselectedæ ‡è¯†æ˜¯å¦é»˜è®¤é€‰ä¸­ï¼Œenabledæ ‡è¯†æ˜¯å¦å¯ç”¨ï¼Œè¿™é‡Œåªç®€å•è®¾ç½®äº†è¿™å‡ ä¸ªé€‰é¡¹ï¼Œè¿˜æœ‰å…¶ä»–ä¸°å¯Œçš„é€‰é¡¹ï¼Œæœ‰å…´è¶£çš„ç«¥é‹å¯ä»¥è‡ªè¡Œç ”ç©¶å°è¯•ã€‚\næ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸‹æˆ‘ä»¬çš„TranslationFormç±»ï¼š\n![](img/9.jpg)\nå¯ä»¥çœ‹åˆ°Ideaä¸ºæˆ‘ä»¬çš„å„ä¸ªç»„ä»¶å…ƒç´ éƒ½è‡ªåŠ¨ç”Ÿæˆç›¸å¯¹åº”çš„å˜é‡ï¼ŒåŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿè‡ªå®šä¹‰äº†ä¸€ä¸ªselectValueå˜é‡ï¼ˆç”¨æ¥ä¿å­˜å½“å‰å€¼ï¼‰å’ŒcurrentSelectButtonå˜é‡ï¼ˆç”¨æ¥ä¿å­˜å½“å‰é€‰ä¸­çš„æŒ‰é’®ï¼‰ï¼Œå†æ¥çœ‹ä¸‹è¯¥ç±»ä¸­çš„æ–¹æ³•ï¼š\n![](img/10.jpg)\nåœ¨æ„é€ å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªç›‘å¬å™¨ç”¨æ¥ç›‘å¬å½“å‰ç”¨æˆ·é€‰æ‹©çš„é€‰é¡¹ï¼Œå¹¶ä¿å­˜èµ·æ¥ï¼Œåæ–‡ä¼šç”¨åˆ°ã€‚\nç»„ä»¶å¼€å‘å®Œæ¯•,æˆ‘ä»¬å†æ¥çœ‹ä¸‹é…ç½®ã€‚\nå¦‚ä½•è®©Ideaèƒ½å¤Ÿä¿å­˜èµ·æ¥æˆ‘ä»¬çš„é…ç½®ï¼Œä»¥ä¾¿ä¸‹æ¬¡å¯åŠ¨æ—¶èƒ½å¤Ÿè‡ªåŠ¨åŠ è½½ç”¨æˆ·ç›¸åº”çš„é…ç½®ï¼Œå…¶å®ï¼Œåˆšåˆ›å»ºå®Œé¡¹ç›®åï¼Œåœ¨resources/META-INF/ç›®å½•ä¸‹ä¼šç”Ÿæˆä¸€ä¸ªplugin.xmlæ–‡ä»¶ï¼š\n![](img/11.jpg)\n![](img/12.jpg)\n![](img/13.jpg)\nåœ¨extensionsæ ‡ç­¾ä¸‹ï¼Œæˆ‘ä»¬æŒ‡å®šäº†å®ä¾‹easy.config.TranslationConfigç±»ä»¥åŠå®ç°å®ç°ç±»easy.config.TranslationSettingï¼Œè¯¥å®ç°ç±»å°±æ˜¯ç”¨æ¥ç®¡ç†æˆ‘ä»¬çš„é…ç½®ä¿¡æ¯çš„ã€‚åœ¨application-componentsæ ‡ç­¾ä¸‹ï¼Œæˆ‘ä»¬å®šä¹‰äº†easy.idea.MyPluginRegistrationå®ç°ç±»ï¼ŒIdeaç»„ä»¶æ˜¯æ’ä»¶æ•´åˆçš„åŸºç¡€æ¦‚å¿µï¼Œæœ‰ä¸‰ç§ç»„ä»¶ç±»å‹ï¼šapplication-levelã€project-levelå’Œmodule-levelã€‚ Application-levelç»„ä»¶åœ¨IDEAå¯åŠ¨æ—¶å°±è¢«åˆ›å»ºå¹¶åˆå§‹åŒ–ã€‚åœ¨actionæ ‡ç­¾ä¸‹çš„add-to-groupä¸­çš„group-idå¾ˆé‡è¦ï¼Œå®ƒæŒ‡å®šäº†ä½ çš„æ’ä»¶åœ¨æ•´ä¸ªideaç•Œé¢ä¸Šçš„å…¥å£ï¼Œè¿™ä¸ªå€¼å¯ä»¥æŒ‡å®šçš„å¾ˆå¤šï¼ˆæ¯”å¦‚ä»£ç åŒºåŸŸçš„å³é”®èœå•ã€ç¼–è¾‘å™¨é¡¶éƒ¨çš„èœå•ï¼‰ã€‚actionèŠ‚ç‚¹ä¸­é‡è¦çš„æ˜¯classå’Œtextï¼Œclassæ˜¯æŒ‡å®šæ’ä»¶çš„å…¥å£actionï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸€ä¸ªæ’ä»¶å®šä¹‰ä¸€ä¸ªå°±è¡Œäº†ï¼Œç›¸å½“äºmainå‡½æ•°å§ï¼Œè€Œtextæ˜¯æŒ‡å®šæ’ä»¶çš„å…·ä½“çš„åç§°ï¼Œå°±æ˜¯ç‚¹å‡»è¿™ä¸ªtextç„¶åæ‰§è¡ŒclassæŒ‡å®šçš„ç±»ã€‚\næˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹MyPluginRegistrationç±»ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬ç®€å•çš„æ³¨å†Œäº†æˆ‘ä»¬çš„ToChineseActionç±»ï¼š\n![](img/14.jpg)\næˆ‘ä»¬å†æ¥çœ‹ä¸‹TranslationSettingç±»ï¼Œè¯¥ç±»å®ç°äº†PersistentStateComponentæ¥å£ï¼Œè¿™æ ·ç»„ä»¶çš„çŠ¶æ€å°†ä¼šè‡ªåŠ¨ä¿å­˜å’ŒåŠ è½½ï¼š\n![](img/15.jpg)\næˆ‘ä»¬æŒ‡å®šäº†@Stateå’Œ@Storageæ³¨è§£ï¼Œè¿™æ ·ç»„ä»¶çš„çŠ¶æ€å°†ä¼šä¿å­˜åˆ°ä¸€ä¸ªXMLæ–‡ä»¶ä¸­ã€‚åœ¨è¯¥ç±»æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªengineçš„å˜é‡ï¼Œç”¨æ¥ä¿å­˜å½“å‰ç”¨æˆ·é€‰æ‹©çš„ç¿»è¯‘å¼•æ“ï¼ˆè°·æ­Œã€æ¬§ç±³ç­‰ï¼‰ï¼ŒåŒæ—¶æä¾›äº†getStateæ–¹æ³•ã€loadStateæ–¹æ³•æ¥è®¾ç½®è·å–é…ç½®ã€‚å…¶ä¸­Constant.ELEMENT_NAMEå°±æ˜¯\"TranslationSetting\"ï¼ŒConstant.ELEMENT_ATTR_NAMEå°±æ˜¯\"engine\"ï¼Œæ˜¯æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„å˜é‡ã€‚\n\næˆ‘ä»¬å†æ¥çœ‹ä¸‹TranslationConfigç±»ï¼š\n![](img/16.jpg)\nåœ¨è¯¥ç±»ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†TranslationFormç±»å’ŒTranslationSettingç±»çš„å˜é‡ã€‚isModifiedæ–¹æ³•æ˜¯ç”¨æ¥åˆ¤æ–­é€‰é¡¹æ˜¯å¦è¢«ä¿®æ”¹è¿‡ï¼ˆå¦‚ï¼šæˆ‘ä»¬æ˜¯å¦æ›´æ¢äº†ç¿»è¯‘å¼•æ“ï¼‰ã€‚getDisplayNameæ˜¯åœ¨é…ç½®é¢æ¿ä¸Šæ˜¾ç¤ºçš„åç§°ï¼Œå¦‚ï¼š\n![](img/17.jpg)\napplyæ–¹æ³•æ˜¯ç”¨æ¥å°†è®¾ç½®ç”¨æˆ·é€‰æ‹©çš„ç¿»è¯‘å¼•æ“ï¼Œresetæ–¹æ³•æ˜¯é‡ç½®ç”¨æˆ·é€‰æ‹©é¡¹ï¼š\n![](img/18.jpg)\ncreateComponentæ–¹æ³•æ˜¯ç”¨æ¥åˆ›å»ºç»„ä»¶ï¼š\n![](img/19.jpg)\nç°åœ¨æˆ‘ä»¬æ¥çœ‹ä¸‹ToChineseActionç±»ï¼š\n![](img/20.jpg)\nåœ¨è¯¥ç±»ä¸­æŒæœ‰ä¸€ä¸ªTranslationSettingç±»çš„å¼•ç”¨ï¼Œç”¨æ¥è·å–å½“å‰ç”¨æˆ·é€‰æ‹©çš„ç¿»è¯‘å¼•æ“ã€‚æˆ‘ä»¬é¦–å…ˆè·å–ä»£ç ç¼–è¾‘åŒºå¯¹è±¡ï¼Œç„¶ååˆ¤æ–­ç”¨æˆ·æ˜¯å¦é€‰ä¸­äº†ä¸€äº›æ–‡æœ¬ï¼Œå¦‚æœé€‰ä¸­äº†æ–‡æœ¬ï¼Œåˆ™è·å–åˆ°é€‰ä¸­çš„å†…å®¹ï¼Œç„¶åè°ƒç”¨formatTextæ–¹æ³•å°†æ²¡ç”¨çš„å¹²æ‰°æ–‡æœ¬å»æ‰ï¼Œæœ€åè·å–ç¿»è¯‘å¼•æ“ï¼Œæ‰§è¡Œç¿»è¯‘ï¼Œå¹¶å°†ç¿»è¯‘ç»“æœä»¥æ°”æ³¡çš„æ–¹å¼å±•ç¤ºå‡ºæ¥ã€‚\n![](img/21.jpg)\næ•ˆæœå¦‚ä¸‹ï¼š\n![](img/22.jpg)\næˆ‘ä»¬å†æ¥çœ‹ä¸‹ToEnglishActionç±»ï¼Œè¯¥ç±»å’ŒToChineseActionç±»ä¼¼ï¼Œå”¯ä¸€çš„ä¸åŒå°±æ˜¯æç¤ºé¢æ¿ä¸ä¸€æ ·ï¼šè¯¥ç±»æ˜¯å…ˆå¼¹å‡ºæ¥ä¸€ä¸ªæ¡†æç¤ºç”¨æˆ·è¾“å…¥ä¸­æ–‡ï¼Œç„¶åå°†ä¸­æ–‡ç¿»è¯‘æˆç›¸åº”çš„è‹±æ–‡ï¼š\n![](img/23.jpg)\næ•ˆæœå¦‚ä¸‹ï¼š\n![](img/24.jpg)\n![](img/25.jpg)\nå…³äºIdeaæ’ä»¶å¼€å‘çš„éƒ¨åˆ†å°±ä»‹ç»å®Œæ¯•äº†ï¼Œå…·ä½“æ€ä¹ˆæ‰§è¡Œç¿»è¯‘çš„å‘¢ï¼Ÿæœ‰å…´è¶£çš„å¯ä»¥å»çœ‹ä¸‹æºç (https://github.com/limengyu1990/easy-translation)ï¼Œè¿™é‡Œå°±ä¸å¤šä»‹ç»äº†ï¼ŒåŒæ—¶å¯ä»¥å»Ideaå®˜æ–¹æ’ä»¶åº“ä¸­ä¸‹è½½è¯¥æ’ä»¶è¯•ç”¨ï¼š\n![](img/26.jpg)\n","tags":["plugin"]},{"title":"ScalaSTMå®˜ç½‘ç¿»è¯‘","url":"/blog/2018/07/29/ScalaSTMå®˜ç½‘ç¿»è¯‘/","content":"\n### æ¬¢è¿\næ¬¢è¿æ¥è‡ª Scala STM çš„åˆ›é€ è€…ã€‚æˆ‘ä»¬å·²ç»ä¸º scala æ„å»ºäº†ä¸€ä¸ªè½»é‡çº§çš„è½¯ä»¶äº‹åŠ¡æ€§å†…å­˜, çµæ„Ÿæ¥è‡ªäºHaskell STMså’ŒClojure, åŒæ—¶åˆ©ç”¨äº†Scala çš„åŠ›é‡å’Œæ€§èƒ½ã€‚\nScalaSTM æ˜¯ä¸€ä¸ªæ²¡æœ‰ä¾èµ–å…³ç³»çš„å•ä¸€ JAR, åŒ…æ‹¬\n* æ”¯æŒå¤šä¸ª STM å®ç°çš„ API\n* åŸºäº CCSTM çš„å‚è€ƒå®ç°\n* å¯æ‰©å±•çš„å¹¶å‘setså’Œmaps(å…·æœ‰å¿«é€Ÿå¿«ç…§), å¯ä»¥åœ¨äº‹åŠ¡å†…éƒ¨æˆ–å¤–éƒ¨ä½¿ç”¨\n\nScalaSTM æä¾›ä¸€ä¸ªå¯å˜å•å…ƒç§°ä¸ºä¸€ä¸ªRefï¼Œå¦‚æœä½¿ç”¨ä¸å¯å˜å¯¹è±¡å’Œ Ref-sæ„å»ºå…±äº«æ•°æ®ç»“æ„, åˆ™å¯ä»¥ä»å¤šä¸ªthreadsæˆ–actorsè®¿é—®è¯¥ç»“æ„ã€‚æ²¡æœ‰åŒæ­¥ã€æ²¡æœ‰æ­»é”æˆ–äº‰ç”¨æ¡ä»¶ä»¥åŠè‰¯å¥½çš„å¯ä¼¸ç¼©æ€§ã€‚åŒ…æ‹¬å¹¶å‘setså’Œmaps, æˆ‘ä»¬ä¹Ÿæœ‰ä¸€ä¸ªæ›´å®¹æ˜“å’Œæ›´å®‰å…¨çš„æ›¿ä»£waitå’ŒnotifyAllã€‚\n\n### ä»‹ç»\n#### STMæ˜¯ä»€ä¹ˆï¼Ÿ\nSTMï¼ˆè½¯ä»¶äº‹åŠ¡æ€§å†…å­˜ï¼‰æ˜¯ä»‹äºä»£ç çš„å…³é”®éƒ¨åˆ† (atomicåŸå­å—) å’Œç¨‹åºå †ä¹‹é—´çš„ä¸­ä»‹ã€‚STM åœ¨atomicåŸå­å—ä¸­è¯»å–å’Œå†™å…¥è¿‡ç¨‹ä¸­è¿›è¡Œå¹²é¢„, å…è®¸å®ƒæ£€æŸ¥and/oré¿å…å¹²æ‰°å…¶ä»–çº¿ç¨‹ã€‚å¦‚æœå¤šä¸ªçº¿ç¨‹çš„è´Ÿè½½å’Œå­˜å‚¨å˜å¾—äº¤é”™, åˆ™å°†å›æ»šè¯¥atomicåŸå­å—çš„æ‰€æœ‰å†™å…¥, ç„¶åé‡è¯•æ•´ä¸ªå—ã€‚å¦‚æœå…³é”®éƒ¨åˆ†çš„è®¿é—®ä¸æ˜¯äº¤é”™çš„, åˆ™å®ƒå°±åƒæ˜¯ä»¥åŸå­çš„æ ·å­å®Œæˆçš„, å¹¶ä¸”å¯ä»¥æäº¤åŸå­å—ã€‚å…¶ä»–threadsæˆ–actorsåªèƒ½çœ‹åˆ°å·²æäº¤çš„æ›´æ”¹ã€‚\nSTMs ä½¿ç”¨ä¹è§‚å¹¶å‘æ§åˆ¶ã€‚ä»–ä»¬ä¹è§‚åœ°è®¤ä¸º, atomicåŸå­å—å°†èƒ½å¤Ÿå¹¶è¡Œè¿è¡Œ, ç„¶åå¤‡ä»½å’Œé‡è¯•, å¦‚æœæ¨æµ‹æ˜¯ä¸æ­£ç¡®çš„ã€‚ä¿ç•™æ—§ç‰ˆæœ¬çš„æ•°æ®ä»¥ä¾¿å¤‡ä»½å¯èƒ½ä¼šå¸¦æ¥ä¸€äº›å¼€é”€, ä½†ä¹è§‚å¹¶å‘é€šå¸¸æ¯”å…¶ä»–æ–¹æ³•å…·æœ‰æ›´å¥½çš„å¯ä¼¸ç¼©æ€§ã€‚\n\n#### ScalaSTM - æ²¡æœ‰é­”åŠ›\næœ‰å‡ ä¸ªé›„å¿ƒå‹ƒå‹ƒçš„å°è¯•æ¥åˆ›å»º STMs, å¯ä»¥å¹¶è¡Œè¿è¡Œç°æœ‰çš„é¡ºåºå‘½ä»¤ä»£ç ã€‚è¿™æ˜¯ä¸€é¡¹éš¾åº¦å¾ˆå¤§çš„ä»»åŠ¡, éœ€è¦å¤§é‡çš„é­”åŠ›, å› ä¸ºå¯¹ STM çš„è°ƒç”¨éœ€è¦æ’å…¥åˆ°ä¸€ä¸ªatomicåŸå­å—å†…çš„éfinalå­—æ®µæˆ–æ•°ç»„å…ƒç´ çš„æ¯ä¸ªè´Ÿè½½å’Œå­˜å‚¨ä¸­ã€‚è‰¯å¥½çš„æ€§èƒ½ä¹Ÿå¾ˆéš¾, å› ä¸ºå¤§é‡çš„è¯»å†™ã€‚\nScalaSTM API é€šè¿‡åªç®¡ç† Ref-s, é¿å…äº†å¯¹é­”åŠ›çš„éœ€è¦ã€‚è¿™æ„å‘³ç€è¦ç®¡ç†çš„å†…å­˜ä½ç½®è¾ƒå°‘, å› æ­¤ä¸éœ€è¦å­—èŠ‚ç æ£€æµ‹æˆ–ç¼–è¯‘å™¨ä¿®æ”¹ã€‚å°±åƒåœ¨Haskellå’ŒClojureä¸­ ä¸€æ ·, Ref çš„æ•ˆç”¨é€šè¿‡è¯­è¨€å¯¹ä¸å¯å˜æ•°æ®ç»“æ„çš„è‰¯å¥½æ”¯æŒè¢«æ”¾å¤§ã€‚ScalaSTM è¿˜åŒ…æ‹¬å¯åœ¨äº‹åŠ¡ä¸­ä½¿ç”¨çš„å¹¶å‘setså’Œmapsã€‚\n\n#### ScalaSTMæ˜¯ç»™è°çš„å‘¢ï¼Ÿ\nScalaSTM æ˜¯ç¨‹åºå‘˜ç”¨æ¥åè°ƒthreadsæˆ–actorså¯¹å…±äº«æ•°æ®çš„è®¿é—®ã€‚åœ¨æœåŠ¡å™¨ä¸­, è¿™å¯èƒ½æ˜¯æ´»åŠ¨è¿æ¥æˆ–ç¼“å­˜çš„åˆ—è¡¨ã€‚åœ¨å®¢æˆ·ç«¯ä¸­, è¿™å¯èƒ½æ˜¯éƒ¨åˆ†ç»“æœæˆ–å·¥ä½œçº¿ç¨‹çŠ¶æ€ã€‚\n\nä¼˜ç‚¹ï¼š\n* è¯´å‡ºä½ çš„æ„æ€ã€‚ä½ ç¼–å†™atomicåŸå­, ScalaSTM åŸå­æ‰§è¡Œå®ƒæ²¡æœ‰deadlocks æˆ–è€… racesã€‚ä¸éœ€è¦å°†é”æ˜ å°„åˆ°æ•°æ®ã€‚åµŒå¥—çš„åŸå­å—åšäº†æ­£ç¡®çš„äº‹æƒ…, æ‰€ä»¥ä½ å¯ä»¥ä»ç®€å•çš„å¼€å§‹æ„é€ å¤æ‚çš„çº¿ç¨‹å®‰å…¨çš„æ“ä½œã€‚\n* è¯»å–è§„æ¨¡ã€‚ç³»ç»Ÿä¸­çš„æ‰€æœ‰çº¿ç¨‹éƒ½å¯ä»¥åœ¨ä¸ç›¸äº’å¹²æ‰°çš„æƒ…å†µä¸‹è¯»å–æ•°æ®ã€‚ä¹è§‚ç®—æ³•æ¯”æ‚²è§‚æ–¹æ³•æ›´å¥½åœ°åˆ©ç”¨äº†ç°ä»£æ¶æ„ä¸Šçš„ç¼“å­˜ã€‚\n* å¼‚å¸¸è‡ªåŠ¨è§¦å‘æ¸…ç†ã€‚å¦‚æœatomicåŸå­å—å¼•å‘å¼‚å¸¸, åˆ™æ‰€æœ‰ Ref-s éƒ½å°†é‡ç½®ä¸ºå…¶åŸå§‹çŠ¶æ€ã€‚(å¦‚æœæ„¿æ„, å¯ä»¥æ›´æ”¹æ­¤é»˜è®¤å€¼ï¼‰\n* ç­‰å¾…å¤æ‚çš„æ¡ä»¶æ˜¯å®¹æ˜“çš„ã€‚å¦‚æœä¸€ä¸ªatomicåŸå­å—æ‰¾ä¸åˆ°å®ƒè¦æŸ¥æ‰¾çš„çŠ¶æ€, å®ƒå¯ä»¥è°ƒç”¨é‡è¯•å¤‡ä»½å¹¶ç­‰å¾…å…¶ä»»ä½•è¾“å…¥æ›´æ”¹ã€‚å¦‚æœæœ‰å¤šç§æ–¹å¼æ ‡è¯†æˆåŠŸ, ä½ å¯ä»¥å°†å®ƒä»¬é“¾æ¥èµ·æ¥ï¼ŒScalaSTM å°†å°è¯•ä»–ä»¬æ‰€æœ‰ã€‚\n* ç®€å•ã€‚ScalaSTM åªæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„åº“, æ‰€ä»¥å®ƒä¸ä¼šå½±å“åº”ç”¨ç¨‹åºä¸­ä¸ä½¿ç”¨å®ƒçš„éƒ¨åˆ†ã€‚è¿™æ„å‘³ç€å¯ä»¥å°†å…¶åŒ…å«åœ¨æ¡†æ¶æˆ–éšè—ç»„ä»¶ä¸­ã€‚\nç¼ºç‚¹ï¼š\n* æ¯æ¬¡è¯»æˆ–å†™ä¸¤ä¸ªé¢å¤–å­—ç¬¦ã€‚å¦‚æœ x æ˜¯ Ref, åˆ™ x () è¯»å–å…¶å€¼, x () = v å†™å…¥å®ƒçš„å€¼ã€‚\n* å•çº¿ç¨‹å¼€é”€ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹, å½“ç¨‹åºå®é™…ä¸Šæ²¡æœ‰å¹¶è¡Œè¿è¡Œæ—¶, STMs çš„é€Ÿåº¦ä¼šå‡æ…¢ã€‚æˆ‘ä»¬å·²ç»å¾—åˆ°äº†å®é™…æˆæœ¬ç›¸å½“ä½, æ‰€ä»¥å¯¹äºå¤§å¤šæ•°ä½¿ç”¨è€…æ¥è¯´è¿™ä¸ä¼šæ˜¯ä¸€ä¸ªé—®é¢˜ã€‚å³ä½¿åœ¨å•çº¿ç¨‹ç¨‹åºä¸­ï¼Œå›æ»šä¹Ÿéå¸¸æœ‰ç”¨ï¼Œä»¥ä¾¿åœ¨å¼‚å¸¸æƒ…å†µä¸‹è‡ªåŠ¨æ¸…é™¤ã€‚\n* å›æ»šä¸I/Oæ··åˆçš„ä¸æ˜¯å¾ˆå¥½ã€‚åªä¼šè‡ªåŠ¨æ’¤æ¶ˆå¯¹ Ref-s çš„æ›´æ”¹ã€‚ScalaSTM API æä¾›äº†hooks , å› æ­¤æ‚¨å¯ä»¥æ‰§è¡Œæ‰‹åŠ¨è¡¥å¿æˆ–æ•°æ®åº“é›†æˆ, ä½†æ— æ³•æ’¤å›æ•°æ®åŒ…æˆ–åƒç´ ã€‚å½“ç„¶, å½“ä½ æŒæœ‰ä¸€ä¸ªé”çš„æ—¶å€™ä½ å¯èƒ½ä¸åº”è¯¥åšI/Oã€‚\n\n### å¿«é€Ÿå¼€å§‹\nä½œä¸ºä¸€ä¸ªç®€å•çš„ä¾‹å­,æˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªå¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹æˆ–actorå®‰å…¨ä½¿ç”¨çš„åŒå‘é“¾è¡¨ã€‚æˆ‘ä»¬å°†ä¼šæ•™æˆ‘ä»¬çš„åˆ—è¡¨å¦‚ä½•æˆä¸ºä¸€ä¸ªé˜»å¡é˜Ÿåˆ—,ç„¶åæˆ‘ä»¬å°†æ·»åŠ ä»å¤šä¸ªé˜Ÿåˆ—ä¸­é€‰æ‹©ä¸‹ä¸€ä¸ªå¯ç”¨å…ƒç´ çš„èƒ½åŠ›ã€‚\n\n#### å®‰è£…\nå¦‚æœä½ ä½¿ç”¨`sbt`ï¼ŒæŠŠä¸‹é¢çš„ä¾èµ–æ·»åŠ åˆ°ä½ çš„å·¥ç¨‹ä¸­build.sbtæ–‡ä»¶ä¸­ï¼Œ\nç„¶åè¿è¡Œ`sbt update`\nMaven2çš„é…ç½®å¯ä»¥ä»å¦‚ä¸‹é“¾æ¥è·å–ï¼šhttps://nbronson.github.io/scala-stm/releases.html\n\n#### å¯¹å…±äº«å˜é‡ä½¿ç”¨Ref\nåœ¨æˆ‘ä»¬çš„å¯å˜é“¾è¡¨ä¸­ï¼Œ æˆ‘ä»¬éœ€è¦æ¯ä¸ªèŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªå’Œä¸Šä¸€ä¸ªæŒ‡é’ˆæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚é€šå¸¸ï¼Œ å¦‚æœä¸€ä¸ªçº¿ç¨‹å¯èƒ½åœ¨å¦ä¸€ä¸ªçº¿ç¨‹è®¿é—®å®ƒ (è¯»å–æˆ–å†™å…¥) çš„åŒæ—¶å†™ä¸€ä¸ªå˜é‡ï¼Œé‚£ä¹ˆSTMéœ€è¦é€šè¿‡Refæ¥å‚ä¸ã€‚\nRefæ˜¯å•ä¸ªçš„å¯å˜å•å…ƒï¼Œè¿˜æœ‰äº‹åŠ¡æ€§é›†åˆ(å¦‚TMapå’ŒTset)ï¼Œå®ƒä»¬æ˜¯scala.collection.mutable.é›†åˆçš„æ›¿ä»£å“.\n![](img/1.jpg)\nä¸ºäº†è®©ä»£ç æ›´ç®€å•ï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªé¢å¤–çš„headerèŠ‚ç‚¹ä½¿åˆ—è¡¨å¾ªç¯ï¼Œåœ¨åˆ›å»ºæ—¶ï¼Œè¿™ä¸ªheaderèŠ‚ç‚¹çš„nextèŠ‚ç‚¹å’ŒprevèŠ‚ç‚¹æŒ‡å‘è‡ªèº«ï¼ŒnextèŠ‚ç‚¹å’ŒprevèŠ‚ç‚¹æ€»æ˜¯éç©ºçš„ã€‚\n\n#### ç”¨atomicåŒ…è£…ä½ çš„ä»£ç \nå¦‚æœ x æ˜¯ Ref, åˆ™ x () è·å–å­˜å‚¨åœ¨ x ä¸­çš„å€¼, x () = v å°†å…¶è®¾ç½®ä¸ºå€¼ vã€‚\nåªèƒ½åœ¨atomicä»£ç å—å†…è¯»å–å’Œå†™å…¥Ref-sã€‚è¿™åœ¨ç¼–è¯‘æ—¶é€šè¿‡è¦æ±‚å¯ç”¨çš„éšå¼InTxn å€¼æ¥è¿›è¡Œæ£€æŸ¥ï¼ŒAtomicä»£ç å—æ˜¯ä¸€ä¸ªéœ€è¦ä¸€ä¸ªlnTxnå‚æ•°çš„å‡½æ•°ï¼Œå› æ­¤å¯ä»¥é€šè¿‡å°†å‚æ•°æ ‡è®°ä¸ºéšå¼çš„æ¥æ»¡è¶³æ­¤è¦æ±‚ã€‚\n![](img/2.jpg)\n\n#### ç»„åˆatomicæ“ä½œ\nAtomicä»£ç å—åµŒå¥—ï¼Œå› æ­¤ä½ å¯ä»¥é€šè¿‡ä¸€ä¸ªç®€å•çš„å¼€å§‹æ„å»ºå¤åˆæ“ä½œ.\n![](img/3.jpg)\n\n#### ä¼˜åŒ–å•ä¸€æ“ä½œäº‹åŠ¡\nRef.singleè¿”å›ä¸€ä¸ªRef.Viewç±»å‹çš„å®ä¾‹ï¼Œè¿™ä¸ªè¡Œä¸ºå°±åƒåŸå§‹çš„Refåªæ˜¯å®ƒä¹Ÿå¯ä»¥åœ¨ä¸€ä¸ªatomicä»£ç å—ä¹‹å¤–è®¿é—®ã€‚Ref.Viewä¸Šçš„æ¯ä¸€ä¸ªæ–¹æ³•éƒ½ç±»ä¼¼äºå•æ“ä½œäº‹åŠ¡ï¼Œå› æ­¤name.Ref.Viewæä¾›äº†å¤šç§æ‰§è¡Œè¯»å†™çš„æ–¹æ³•ï¼Œä¾‹å¦‚swapï¼ŒcompareAndSetå’Œtransformã€‚å¦‚æœä¸€ä¸ªatomicå—åªè®¿é—®ä¸€ä¸ªRefï¼Œé‚£ä¹ˆä½¿ç”¨Ref.Viewå¯èƒ½ä¼šæ›´ç®€æ´ã€æ›´é«˜æ•ˆã€‚\n![](img/4.jpg)\n\n#### ç­‰å¾…æ¡ä»¶å˜åŒ–\nå½“ä¸€ä¸ªatomicä»£ç å—æ— æ³•åœ¨å½“å‰è¾“å…¥çŠ¶æ€ä¸‹å®Œæˆæ—¶ä½¿ç”¨retryå…³é”®å­—ã€‚åœ¨atomicä»£ç å—å†…è°ƒç”¨retryå°†å¯¼è‡´å®ƒå›æ»šï¼Œç­‰å¾…å®ƒçš„ä¸€ä¸ªè¾“å…¥æ›´æ”¹ï¼Œç„¶åé‡è¯•æ‰§è¡Œã€‚è¿™å¤§è‡´ç±»ä¼¼äºè°ƒç”¨waitç­‰å¾…ScalaSTM è‡ªåŠ¨ç”Ÿæˆç›¸åŒ¹é… notifyAll çš„è°ƒç”¨ã€‚ä½œä¸ºå…¶å®ç°ä¹è§‚å¹¶å‘çš„ä¸€éƒ¨åˆ†ï¼ŒSTMè·Ÿè¸ªäº†ä¸€ä¸ªatomicä»£ç å—çš„readé›†åˆï¼ŒRef-sçš„é›†åˆå·²åœ¨äº‹åŠ¡æœŸé—´è¯»å–ï¼ˆå³åœ¨äº‹åŠ¡è¿‡ç¨‹ä¸­è¯»å–çš„ Ref-s é›†åˆï¼‰ï¼Œè¿™æ„å‘³ç€STMå¯ä»¥æœ‰æ•ˆçš„é˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°å¦ä¸€ä¸ªçº¿ç¨‹å·²ç»å†™å…¥å…¶readé›†åˆä¸­çš„ä¸€ä¸ªå…ƒç´ ï¼Œåœ¨è¿™æ®µæ—¶é—´å†…ï¼Œå¯ä»¥é‡è¯•è¯¥atomicä»£ç å—ï¼Œè¿™ä½¿å¾—ç­‰å¾…å¤æ‚çš„æ¡ä»¶å˜å¾—å¾®ä¸è¶³é“ï¼Œå¹¶å¯é¿å…ä¸¢å¤±å”¤é†’ã€‚\nä¸ºäº†æ¼”ç¤ºï¼Œæˆ‘ä»¬å°†ä¼šæ·»åŠ ä¸€ä¸ªå‡½æ•°åˆ°æˆ‘ä»¬çš„åˆ—è¡¨ï¼Œç­‰å¾…ç›´åˆ°è¿™ä¸ªåˆ—è¡¨æ˜¯éç©ºçš„ï¼Œç„¶åç§»é™¤å¹¶è¿”å›ç¬¬ä¸€ä¸ªå…ƒç´ ï¼š\n![](img/5.jpg)\n\n#### ç­‰å¾…å¤šä¸ªäº‹ä»¶\nåœ¨atomicä»£ç å—ç»“æŸåé‡è¯•çš„å¦ä¸€ç§æ–¹æ³•æ˜¯æä¾›å¦ä¸€ç§é€‰æ‹©ã€‚ä½ å¯ä»¥ç”¨ orAtomicå»é“¾æ¥atomicä»£ç å—;å¦‚æœä¸Šå±‚çš„è°ƒç”¨retry, åˆ™ä¼šå°è¯•è¾ƒä½çš„æ›¿ä»£æ–¹æ¡ˆã€‚è¿™å°±å…è®¸ä½ ç»„åˆåŠŸèƒ½å¦‚ä½¿ç”¨retryé˜»å¡æˆ–è€…ä»ä¸€ä¸ªé˜»å¡è¡Œä¸ºä¸­è¿›è¡Œè½¬æ¢ã€‚\nä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æä¾›ä¸€ä¸ªå¯é€‰æ–¹æ¡ˆå¹¶ä½¿ç”¨é˜»å¡ç‰ˆæœ¬çš„removeFirst æ¥æ„é€ ä¸€ä¸ªè¿”å›Optionçš„æ–¹æ³•ï¼š\n![](img/6.jpg)\nè¿™æ ·ä¹Ÿå¾ˆå®¹æ˜“ä»ä¸€ä¸ªè¿”å›æ•…éšœä»£ç çš„å‡½æ•°åˆ‡æ¢åˆ°è¿”å›ä¸€ä¸ªå—çš„å‡½æ•°ï¼Œä¸‹é¢çš„selectæ–¹æ³•é˜»å¡ç›´åˆ°ä»–çš„è¾“å…¥æ˜¯éç©ºçš„ï¼Œç„¶åä»åˆ—è¡¨ä¸­ç§»é™¤å¹¶è¿”å›ç¬¬ä¸€ä¸ªå…ƒç´ ï¼š\n![](img/7.jpg)\n\n#### å½“å¿ƒå›æ»š\nåœ¨ä¹è§‚å¹¶å‘èƒ½å¤ŸæˆåŠŸä¹‹å‰, ScalaSTM å¯èƒ½éœ€è¦å¤šæ¬¡å°è¯•ä¸€ä¸ªatomicä»£ç å—ï¼Œä»»ä½•å¯¹ STM çš„è°ƒç”¨éƒ½å¯èƒ½ä¼šå‘ç°æ•…éšœå¹¶è§¦å‘å›æ»šå’Œé‡è¯•ã€‚å¦‚æœæœ¬åœ°é Ref å˜é‡çš„ç”Ÿå­˜æœŸé•¿äºatomicä»£ç å—ï¼Œ åˆ™ä¸ä¼šå›æ»š, å› æ­¤åº”è¯¥é¿å…å®ƒä»¬ã€‚ä¸è¿‡, åªåœ¨atomicä»£ç å—çš„å†…éƒ¨æˆ–ä»…åœ¨å¤–éƒ¨ä½¿ç”¨çš„å±€éƒ¨å˜é‡æ˜¯å¾ˆå¥½çš„ã€‚\n\nä¸‹é¢ï¼ŒbadToString æ˜¯ä¸æ­£ç¡®çš„ï¼Œ å› ä¸ºå®ƒåœ¨atomicä»£ç å—çš„å¤–éƒ¨å’Œå†…éƒ¨ä½¿ç”¨å¯å˜ StringBuilderã€‚è¿”å›å€¼å°†ä¼šæ˜ç¡®æåˆ°åˆ—è¡¨ä¸­çš„æ‰€æœ‰å…ƒç´ , ä½†å®ƒå…¶ä¸­çš„ä¸€äº›å†…å®¹å¯èƒ½ä¼šå‡ºç°ä¸¤æ¬¡æˆ–æ›´å¤šæ¬¡ã€‚\ntoStringæ˜¯æ­£ç¡®çš„, å› ä¸ºå¯¹äºæ¯æ¬¡atomicå°è¯•å®ƒéƒ½ä½¿ç”¨ä¸€ä¸ªæ–°çš„ StringBuilderã€‚\n![](img/8.jpg)\n\n#### æŸ¥çœ‹æºä»£ç \næ­¤åˆ—è¡¨ç¤ºä¾‹æ˜¯ GitHub ä¸Šæºä»£ç çš„ä¸€éƒ¨åˆ†: ConcurrentIntList.scala\næ–‡ç« æ¥æºï¼šhttps://nbronson.github.io/scala-stm/quick_start.html\nç¤ºä¾‹æºä»£ç ï¼šhttps://github.com/nbronson/scala-stm/blob/master/src/test/scala/scala/concurrent/stm/examples/ConcurrentIntList.scala\n\n### çœŸäººç§€å“²å­¦å®¶Demo\n\nDijkstra åˆ›å»ºäº†é¤å…å“²å­¦å®¶çš„é—®é¢˜, ä½œä¸ºå¹¶å‘ç³»ç»Ÿä¸­çš„æ­»é”çš„ä¾‹å­ (ç»´åŸºç™¾ç§‘ä¸Šçš„ç”¨é¤å“²å­¦å®¶)ã€‚æ¯ä¸ªå“²å­¦å®¶å¿…é¡»æ‹¿èµ·ä¸¤ä¸ªå‰å­åƒä»–çš„é¥­, ä½†æ²¡æœ‰è¶³å¤Ÿçš„å‰å­, ä»–ä»¬éƒ½åƒä¸€æ¬¡ã€‚å“²å­¦å®¶å¿…é¡»æœ‰æŸç§ç­–ç•¥, ä»¥ç¡®ä¿ä»–ä»¬ä¸éƒ½æ‹¿èµ·ä¸€åˆ†å‰, ç„¶åæ°¸è¿œç­‰å¾…ä¸€ç§’é’Ÿã€‚\nè®¸å¤šè§£å†³æ–¹æ¡ˆéƒ½å¯èƒ½é¿å…æ­»é”, ä½† STM æä¾›äº†ä¸€ä¸ªç‰¹åˆ«ç®€å•çš„æ–¹æ³•ã€‚ScalaSTM çš„atomicåŸå­å—æä¾›äº†ä¸€ç§æ–¹æ³•, è®©å“²å­¦å®¶åŒæ—¶æ‹¿èµ·ä¸¤ä¸ªå‰å­, è¿™æ˜¯å¤§å¤šæ•°å®ç°è€…ä¸å¯ç”¨çš„èƒ½åŠ›ã€‚\n![](img/9.jpg)\nè¿™è¡¨æ˜å½“ç»“åˆé‡è¯•æ—¶ï¼ŒRef [Boolean] è¡¨ç°çš„å¯ä»¥åƒé”ä¸€æ ·ã€‚\n\n#### æ·»åŠ ä¸€ä¸ªæ‘„åƒå¤´\nåœ¨è¿™ä¸ªæ—¶ä»£, é£Ÿå®¢ä»¬æ›´æœ‰å¯èƒ½ä¸å¾—ä¸åœ¨çœŸäººç§€èŠ‚ç›®ä¸Šæ¯”åœ¨é—­é—¨çš„æƒ…å†µä¸‹ä¸ºå‰å­è€Œæˆ˜ã€‚ä¸åŸºäºä¿¡å·é‡æˆ–ä»£ç†çš„è§£å†³æ–¹æ¡ˆä¸åŒ, STM è§£å†³æ–¹æ¡ˆå¯ä»¥å¾ˆå®¹æ˜“åœ°æ·»åŠ æ‘„åƒå¤´çš„å¤–éƒ¨é€è§†å›¾ã€‚åœ¨å®é™…ç³»ç»Ÿä¸­, å¤–éƒ¨è§†å›¾å¯èƒ½æ¥è‡ªç®¡ç†æ§åˆ¶å° (è¯»å–å’Œå†™å…¥)ã€æ£€æŸ¥ç‚¹çº¿ç¨‹æˆ– GUI ç»„ä»¶ã€‚\n\n#### è®°å½•æ‰€æœ‰æƒ\né¦–å…ˆ, æˆ‘ä»¬å°†æ›´æ”¹å‰å­, ä»¥ä¾¿ä»–ä»¬ä½¿ç”¨ä¸€ä¸ªé€‰é¡¹æ¥è®°å½•æ‰€æœ‰è€…çš„å­˜åœ¨å’Œæ‰€æœ‰è€…çš„åç§°ã€‚è¯·æ³¨æ„, å½“ä½¿ç”¨Refå·¥å‚æ–¹æ³•åˆ›å»º Ref[Option[String]] æ—¶, æˆ‘ä»¬éœ€è¦å¼ºåˆ¶ ç±»å‹ä¸º\"None\" ã€‚å¦‚æœæˆ‘ä»¬æ²¡æœ‰è¿™æ ·åš, é‚£ä¹ˆæ‰€æœ‰è€…å°†æœ€ç»ˆä½œä¸ºä¸€ä¸ª Ref [None], è¿™ä¸æ˜¯å¾ˆæœ‰ç”¨ã€‚\næˆ‘ä»¬è¿˜å°†ç»™æ¯ä¸ªå“²å­¦å®¶ä¸€ä¸ªåç§°å’Œä¸€ä¸ª Ref[Int] æ¥è®°å½•ä»–ä»¬çš„è¿›å±•ã€‚ä¸ºæ–¹ä¾¿èµ·è§, Refå’ŒRef.Viewä¸ºå…·æœ‰å…³è”Numeric[A] çš„ç±»å‹ A æä¾›å°±åœ°ç®—æœ¯è¿ç®— (å¦‚+=)ã€‚\n![](img/10.jpg)\n\n#### æ•è·å¿«ç…§\næ•æ‰ç³»ç»ŸçŠ¶æ€çš„å›¾åƒç°åœ¨å°±åƒéå†åŸå­å—ä¸­çš„å‰å­å’Œå“²å­¦å®¶ä¸€æ ·å®¹æ˜“ã€‚äº‹åŠ¡ä¸èƒ½è®¿é—®åœ¨åŸå­å—å¤–å£°æ˜çš„å¯å˜å¯¹è±¡ (æˆ– var), è¿™ä¸€ç‚¹å¾ˆé‡è¦ã€‚ä¸‹é¢çš„å¯å˜ StringBuilder æ˜¯åœ¨åŸå­å—å†…åˆ›å»ºçš„, æ‰€ä»¥å®ƒæ˜¯å®‰å…¨çš„ã€‚\n![](img/11.jpg)\n\n#### Demoå…¨éƒ¨æºç \næ­¤ç¤ºä¾‹çš„å®Œæ•´æºå¯ç”¨ä½œ github çš„ ScalaSTM æºçš„ä¸€éƒ¨åˆ†: RealityShowPhilosophers.scala.å®ƒåŒ…æ‹¬ä¸€ä¸ªæ‘„åƒå¤´çº¿ç¨‹, å®ƒå¯ä»¥ä¸€ç§’é’Ÿæ‰“å°å›¾åƒ60æ¬¡, ä»¥åŠå¤„ç†çº¿ç¨‹åœæ­¢ã€‚\nä¸‹é¢æ˜¯è¿è¡Œ RealityShowPhilosophers çš„æ‘˜å½•ã€‚æ³¨æ„, å› ä¸ºå‰å­è¢«æ‹¾èµ·å¹¶ä¸”ç«‹åˆ»è¢«æ”¾ä¸‹, æ‘„åƒå¤´ä»æœªè§‚å¯Ÿä¸€ä¸ªå“²å­¦å®¶åªæ‹¿ç€ä¸€ä¸ªå‰å­ã€‚\n![](img/12.jpg)\n\n#### å¼‚å¸¸\nå½“åŸå­å—å¼•å‘å¼‚å¸¸æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µï¼ŸSTM ç¤¾åŒºä¸­å­˜åœ¨å…³äºæ˜¯å¦åº”å›æ»šæˆ–æäº¤äº‹åŠ¡çš„è¾©è®ºã€‚ScalaSTM ä½¿ç”¨ä¸€ç§æ··åˆçš„æ–¹æ³•æ¥å°è¯•åšæ­£ç¡®çš„äº‹æƒ…ã€‚\n\n#### å¼‚å¸¸ -> å›æ»š + é‡æ–°æŠ›å‡º\nå¦‚æœatomicåŸå­å—å¼•å‘å¼‚å¸¸, ScalaSTM å°†å…¶å›æ»š, ç„¶åé‡æ–°æŠ›å‡ºè¯¥å¼‚å¸¸ã€‚å½“å¼‚å¸¸è¢«å†æ¬¡å¼•å‘æ—¶, atomicåŸå­å—å°†è¢«å·¦å›æ»šã€‚å¯¹äºè¡¨ç¤ºå®é™…é”™è¯¯çš„å¼‚å¸¸, è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é»˜è®¤è¡Œä¸º, å› ä¸ºå®ƒé˜²æ­¢äº†ä»»ä½•å…±äº«æ•°æ®ç»“æ„çš„æŸåã€‚\n\n\n#### æ§åˆ¶æµå¼‚å¸¸ â€“> æäº¤ + é‡æ–°æŠ›å‡º\næœ‰æ—¶, å¼‚å¸¸è¡¨ç¤ºéæœ¬åœ°æ§åˆ¶è½¬ç§», è€Œä¸æ˜¯ä¸€ä¸ªæ„å¤–çš„é”™è¯¯ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹, åº”è¯¥æäº¤äº‹åŠ¡ã€‚ScalaSTM æµ‹è¯•æ¯ä¸ªå¼‚å¸¸è½¬ä¹‰ä¸€ä¸ªatomicåŸå­å—ä»¥ç¡®å®šå“ªä¸ªè¡Œä¸ºæ˜¯åˆé€‚çš„ (æŸ¥çœ‹scaladocæ–‡æ¡£TxnExecutor.isControlFlowäº†è§£æ›´å¤š)ã€‚é»˜è®¤æƒ…å†µä¸‹, æ‰©å±• scala.util.control.ControlThrowable çš„æ‰€æœ‰å¼‚å¸¸éƒ½è¢«è§†ä¸ºæ§åˆ¶æµã€‚\n\n#### å¼‚å¸¸å’ŒåµŒå¥—\nä»¥å‰æœ‰å…³å¼‚å¸¸å¤„ç†çš„è§„åˆ™é€‚ç”¨äºåµŒå¥—äº‹åŠ¡ã€‚è¿™æ„å‘³ç€åœ¨æäº¤å¤–éƒ¨äº‹åŠ¡æ—¶å¯èƒ½ä¼šå›æ»šåµŒå¥—äº‹åŠ¡ã€‚ä¾‹å¦‚, åœ¨ä¸‹é¢çš„ä»£ç è¿è¡Œå, æœ€åå°†ä¿å­˜å€¼ \"outer\"ï¼š\n![](img/13.jpg)\nä¸ºäº†ä½¿åµŒå¥—æ›´å»‰ä»·, ScalaSTM å°è¯•å°†æ‰€æœ‰åµŒå¥—çº§åˆ«æ‹¼åˆæˆä¸€ä¸ªé¡¶çº§äº‹åŠ¡ã€‚å¦‚æœå†…éƒ¨äº‹åŠ¡å¼•å‘å¼‚å¸¸, åˆ™æ²¡æœ‰è¶³å¤Ÿçš„ä¿¡æ¯æ¥æ‰§è¡Œéƒ¨åˆ†å›æ»š, å› æ­¤ ScalaSTM å°†ä»¥ç²¾ç¡®åµŒå¥—çš„æ¨¡å¼é‡æ–°å¯åŠ¨æ•´ä¸ªäº‹åŠ¡ã€‚æ­¤ä¼˜åŒ–ç§°ä¸ºåŒ…å®¹ã€‚\n\n#### è¯­æ³•é€ŸæŸ¥è¡¨ \nRef, Ref.View and atomic\n![](img/14.jpg)\n\n\n\n\n\n\n","tags":["STM"]},{"title":"FSMçŠ¶æ€æœº","url":"/blog/2018/07/29/FSMçŠ¶æ€æœº/","content":"> æœ¬æ–‡ä¸»è¦è®²è§£å¦‚ä½•ä½¿ç”¨çŠ¶æ€æ¨¡å¼æ¥æ¶ˆé™¤å¤§é‡çš„if-elseæ¡ä»¶åˆ¤æ–­ä»£ç \n\nåœ¨æˆ‘ä»¬çš„Appä¸­ï¼Œè®¢å•æ¨¡å—ä¼šæœ‰å¾ˆå¤šçš„çŠ¶æ€ï¼Œä¾‹å¦‚å¾…ä»˜æ¬¾ã€ä»˜æ¬¾ä¸­ã€å·²é¢„çº¦ã€å·²å–æ¶ˆã€å·²è¯„ä»·ç­‰ã€‚æˆ‘ä»¬æŠ½ä¸€ä¸ªå–æ¶ˆçš„æµç¨‹æ¥çœ‹ä¸‹ï¼Œå–æ¶ˆæ—¶éœ€è¦åˆ¤æ–­å½“å‰çŠ¶æ€æ˜¯å¦å…è®¸å–æ¶ˆï¼Œä¼ªä»£ç å¦‚ä¸‹ï¼š\n![](img/1.jpg)\n\nå¦‚æœçŠ¶æ€ç±»å‹å¾ˆå°‘çš„è¯ï¼Œè¿™æ ·å­åˆ¤æ–­è¿˜å¯ä»¥ï¼Œä¸€æ—¦æˆ‘ä»¬çš„çŠ¶æ€ç±»å‹å¤šèµ·æ¥çš„è¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿™é‡Œå°±ä¼šæ˜¯ä¸€å¤§å †çš„if-elseæ¡ä»¶åˆ¤æ–­ï¼Œä¸ä»…éš¾ä»¥é˜…è¯»ï¼Œè€Œä¸”ç»´æŠ¤èµ·æ¥å®¹æ˜“å‡ºé”™ã€‚\næˆ‘ä»¬æœ‰ä¸‰ç§æ–¹å¼æ¥é‡æ„è¿™æ ·çš„ä»£ç ï¼š\n* è®¾è®¡æ¨¡å¼ä¹‹çŠ¶æ€æ¨¡å¼\n* é¢†åŸŸé©±åŠ¨è®¾è®¡ä¹‹çŠ¶æ€å»ºæ¨¡\n* çŠ¶æ€æœº\n\n### è®¾è®¡æ¨¡å¼ä¹‹çŠ¶æ€æ¨¡å¼\n![](img/2.jpg)\nå…¶ä¸­Stateæ˜¯çŠ¶æ€æ¥å£ï¼ŒConcreteStateæ˜¯å„ä¸ªå…·ä½“çš„çŠ¶æ€å®ç°ã€‚æˆ‘ä»¬åœ¨è¿™é‡Œå®šä¹‰ä¸ªè®¢å•çŠ¶æ€æ¥å£OrderStateï¼š\n![](img/3.jpg)\n![](img/4.jpg)\n![](img/5.jpg)\n\nå¯ä»¥çœ‹åˆ°ä¸æ˜¯æ¯ä¸ªçŠ¶æ€éƒ½èƒ½å¤Ÿæ”¯æŒæ‰€æœ‰æ“ä½œçš„ï¼Œä¾‹å¦‚ï¼šæ”¯ä»˜ä¸­çš„çŠ¶æ€ä¸å¯ä»¥è¿›è¡Œæ”¯ä»˜æ“ä½œï¼›æœªæ”¯ä»˜çš„çŠ¶æ€ä¸å¯ä»¥è¿›è¡Œé€€æ¬¾æ“ä½œç­‰ã€‚å½“ç„¶æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªæŠ½è±¡ç±»AbstractOrderStateï¼ŒæŠŠæ“ä½œçš„é»˜è®¤å®ç°éƒ½æ”¾è¿›å»ï¼Œå…·ä½“çš„çŠ¶æ€å®ç°åªè¦†ç›–è‡ªå·±èƒ½è¿›è¡Œçš„æ“ä½œã€‚\nç„¶åæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªContextï¼Œå³è®¢å•å®ä½“ç±»Orderï¼Œå®ƒæŒæœ‰ä¸€ä¸ªStateå­—æ®µï¼Œé€šè¿‡Stateå®ç°æ‰€æœ‰çš„çŠ¶æ€è½¬æ¢é€»è¾‘ï¼š\n![](img/6.jpg)\né€šè¿‡çŠ¶æ€æ¨¡å¼ï¼Œå¯ä»¥çœç•¥ä¸€å¤§å †æ¡ä»¶åˆ¤æ–­ï¼Œé€»è¾‘å®ç°èµ·æ¥æ›´æ¸…æ™°ã€‚\n\n\n### é¢†åŸŸé©±åŠ¨è®¾è®¡ä¹‹çŠ¶æ€å»ºæ¨¡\nåœ¨é¢†åŸŸé©±åŠ¨è®¾è®¡ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€äº›æ“ä½œæ¥å£ï¼Œç„¶åå°†æ¯ç§çŠ¶æ€çš„è®¢å•éƒ½å®šä¹‰ä¸ºä¸€ä¸ªå®ä½“ç±»ï¼Œè®©è¿™äº›å®ä½“ç±»å®ç°éœ€è¦çš„æ“ä½œæ¥å£ï¼š\n![](img/7.jpg)\n\n### çŠ¶æ€æœº\nä¸ç®¡æ˜¯çŠ¶æ€æ¨¡å¼è¿˜æ˜¯çŠ¶æ€å®ä½“ï¼Œå¤šä¸ªçŠ¶æ€ä¹‹é—´çš„è½¬æ¢ï¼Œè¿˜æ˜¯åˆ†æ•£åœ¨å„ä¸ªçŠ¶æ€çš„å®ç°é‡Œçš„ã€‚å…¶å®æ‰€æœ‰çš„çŠ¶æ€è½¬æ¢éƒ½å¯ä»¥æ¦‚æ‹¬ä¸ºï¼š\n```scala\nState(S) x Event(E) -> Actions (A), State(S')\n```\nå³å¦‚æœå½“å‰çŠ¶æ€ä¸ºSï¼Œæ¥æ”¶åˆ°ä¸€ä¸ªäº‹ä»¶Eï¼Œåˆ™æ‰§è¡ŒåŠ¨ä½œAï¼ŒåŒæ—¶çŠ¶æ€è½¬æ¢ä¸ºSâ€˜ã€‚\nAkka æ¡†æ¶å®ç°äº†ä¸€ä¸ªæœ‰é™çŠ¶æ€æœºFSMï¼Œå®ƒå®šä¹‰äº†å¼ºæœ‰åŠ›çš„DSLè¯­æ³•ï¼Œå¯ä»¥æŠŠçŠ¶æ€è½¬æ¢å’Œä¸šåŠ¡å¤„ç†é€»è¾‘åˆ†ç¦»å¼€æ¥ã€‚æˆ‘ä»¬è¿™èŠ‚ä¸»è¦è®²è§£ä¸‹Akka FSMçš„ä½¿ç”¨ã€‚æˆ‘ä»¬å…ˆå‡è®¾æˆ‘ä»¬çš„è®¢å•æµç¨‹å¦‚ä¸‹é¢æµç¨‹å›¾æ‰€ç¤ºï¼š\n![](img/8.jpg)\nç„¶åæˆ‘ä»¬å®šä¹‰ä¸€äº›çŠ¶æ€ï¼ŒOrderStateç»§æ‰¿è‡ªFSMStateï¼š\n![](img/11.jpg)\n![](img/12.jpg)\n![](img/13.jpg)\nç„¶åæˆ‘ä»¬å®šä¹‰ä¸€äº›Commandå’ŒDomainEventã€‚DomainEventå°†ä¼šè¢«å†™å…¥æ—¥å¿—ï¼Œå®ƒä¸Commandçš„å…³ç³»æ˜¯ï¼šæˆ‘ä»¬å¯ä»¥ç»™FSMå‘é€Commandï¼ŒFSMæ‰§è¡ŒCommandæ—¶ä¼šäº§ç”ŸDomainEventï¼Œç„¶åè¿™äº›äº§ç”Ÿçš„DomainEventä¼šè¢«å†™å…¥æ—¥å¿—ï¼š\n![](img/14.jpg)\n![](img/15.jpg)\nç„¶åæˆ‘ä»¬å®šä¹‰æˆ‘ä»¬çš„çŠ¶æ€æ•°æ®ï¼š\n![](img/16.jpg)\nç„¶åæˆ‘ä»¬åˆ›å»ºæˆ‘ä»¬çš„çŠ¶æ€æœºMedicalOrderFSMï¼š\n![](img/17.jpg)\nå¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„çŠ¶æ€æœºç»§æ‰¿è‡ªPersistentFSM traitï¼Œæˆ‘ä»¬çœ‹ä¸‹PersistentFSM traitï¼š\n![](img/18.jpg)\nPersistentFSMç»§æ‰¿äº†PersistentActorï¼Œè¯´æ˜å®ƒå…·å¤‡äº†äº‹ä»¶æŒä¹…åŒ–å’Œæ—¥å¿—æ¢å¤èƒ½åŠ›ã€‚ç»§æ‰¿çš„å¦ä¸€ä¸ªç±»å‹PersistentFSMBaseæ˜¯FSM traitçš„é‡æ–°å®šä¹‰ï¼Œé’ˆå¯¹çŠ¶æ€æœºçš„æŒä¹…åŒ–ç‰¹æ€§è®¾è®¡äº†ä¸€å¥—æŒä¹…åŒ–çŠ¶æ€è½¬æ¢çš„DSLã€‚ä¸‰ä¸ªç±»å‚æ•°S,D,Eåˆ†åˆ«ä»£è¡¨çŠ¶æ€ç±»å‹ï¼ˆStateï¼‰ã€çŠ¶æ€æ•°æ®ï¼ˆDataï¼‰ã€é¢†åŸŸäº‹ä»¶ï¼ˆEventï¼‰ï¼Œä¸FSMæ¯”è¾ƒï¼šPersistentFSMé™¤å¢åŠ äº†eventå‚æ•°å¤–ï¼ŒStateç±»å‹æ˜¯ä»¥FSMStateç±»å‹ä¸ºåŸºç¡€çš„ï¼Œæ–¹ä¾¿å¯¹Stateè¿›è¡Œåºåˆ—åŒ–ï¼ˆserializationï¼‰.\n![](img/19.jpg)\nç„¶åæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨DSLæ¥å®šä¹‰æˆ‘ä»¬çš„çŠ¶æ€æœºå¤„ç†æµç¨‹ï¼š\n```scala\nstartWith(initState,initData)  //å®šä¹‰çŠ¶æ€æœºèµ·å§‹çŠ¶æ€\nwhen(stateA) {...}   //å¤„ç†å„ç§çŠ¶æ€\nwhen(stateB) {...}\nwhenUnhandled {...}   //å¤„ç†å…±æ€§çŠ¶æ€\nonTransition {...}  //çŠ¶æ€è½¬å˜è·Ÿè¸ª\n```\nçŠ¶æ€è½¬æ¢æ˜¯é€šè¿‡stay(ä¿æŒå½“å‰çŠ¶æ€)ã€goto(åˆ°ä¸‹ä¸€ä¸ªçŠ¶æ€)ã€stop(åœæ­¢)å®ç°çš„ï¼š\n![](img/20.jpg)\nå¯ä»¥çœ‹åˆ°stayæ˜¯é€šè¿‡gotoæ¥å®ç°çš„ï¼š\n![](img/21.jpg)\næˆ‘ä»¬æŒ‘ä¸€ä¸ªçœ‹ä¸‹ï¼š\n![](img/22.jpg)\nçŠ¶æ€æœºé»˜è®¤çŠ¶æ€ä¸ºInitStateï¼Œä»–å¯ä»¥å¤„ç†CreateOrderCommandï¼Œç„¶åè·³è½¬åˆ°WaitingPayStateçŠ¶æ€(å¾…æ”¯ä»˜)ï¼Œç„¶ååº”ç”¨CreateOrderEventäº‹ä»¶ã€‚\nåªæœ‰çŠ¶æ€è½¬æ¢ï¼ˆå³InitStateè½¬æ¢æˆWaitingPayStateï¼‰å’Œæ•°æ®è½¬æ¢éƒ½æˆåŠŸï¼ˆå³CreateOrderEventæ‰§è¡ŒæˆåŠŸï¼‰ï¼ŒçŠ¶æ€æœºçš„æœ¬æ¬¡çŠ¶æ€æµç¨‹æ‰ä¼šæœ€ç»ˆå®Œæˆï¼Œä»»ä½•ä¸€ä¸ªæ‰§è¡Œå¤±è´¥ï¼Œéƒ½ä¼šæ‰§è¡Œå›æ»šã€‚è¿™é‡Œæ‰§è¡ŒæˆåŠŸåï¼Œæˆ‘ä»¬è°ƒç”¨saveStateSnapshotä¿å­˜å½“å‰å¿«ç…§ï¼Œç”¨æ¥é‡å¯åçŠ¶æ€æ¢å¤ã€‚\nç„¶åæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªTracker Actorç”¨æ¥å¤„ç†äº‹ä»¶æµï¼š\n![](img/23.jpg)\nç„¶åæˆ‘ä»¬å¯ä»¥æµ‹è¯•ä¸‹æˆ‘ä»¬çš„çŠ¶æ€æœºï¼Œå› ä¸ºactoræ˜¯è½»é‡çº§çš„ï¼Œå› æ­¤æˆ‘ä»¬çš„ä¸€ä¸ªè®¢å•äº¤ç”±ä¸€ä¸ªactoræ¥å¤„ç†ï¼Œæ¯ä¸ªactorå¤§æ¦‚æœ‰30å­—èŠ‚ï¼Œ1Gçš„å†…å­˜å¯ä»¥æœ‰ä¸Šç™¾ä¸‡çš„actorï¼š\n![](img/24.jpg)\n![](img/25.jpg)\n\nå¯ä»¥çœ‹åˆ°æˆ‘ä»¬åˆ›å»ºäº†ä¸¤ä¸ªè®¢å•ï¼ŒçŠ¶æ€ç”±â€œåˆå§‹çŠ¶æ€0â€œå˜æˆäº†â€œå¾…æ”¯ä»˜3â€œã€‚\n![](img/26.jpg)\nç„¶åå¯¹è®¢å•æ”¯ä»˜ï¼Œå¯ä»¥çœ‹åˆ°æ”¯ä»˜æˆåï¼ŒçŠ¶æ€ç”±â€œå¾…æ”¯ä»˜3â€œå˜æˆäº†â€œå·²æ”¯ä»˜4â€ã€‚\næˆ‘ä»¬çš„çŠ¶æ€æœºçŠ¶æ€æ•°æ®ä¼šå¼‚æ­¥çš„å†™åˆ°å¤–éƒ¨å­˜å‚¨ä¸­ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯mysql-asyncç»„ä»¶ï¼š\n![](img/27.jpg)\nä»Šå¤©å°±å…ˆç®€å•ä»‹ç»åˆ°è¿™é‡Œï¼Œåé¢æœ‰æ—¶é—´ä¼šåˆ†äº«ä¸‹Akka FSMçš„æºç ã€‚\n\n\n","tags":["akka"]},{"title":"Metasploitæ¸—é€æµ‹è¯•","url":"/blog/2018/07/28/Metasploitæ¸—é€æµ‹è¯•/","content":">Metasploitæ¸—é€æµ‹è¯•ç³»åˆ—æ•™ç¨‹\n\n","tags":["æ¸—é€æµ‹è¯•"]}]